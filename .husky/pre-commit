#!/bin/sh

# ============================================
# Pre-commit Hook - Verify Before Every Commit
# ============================================
# This hook runs automatically before each commit to ensure code quality.
# If any check fails, the commit will be blocked.

echo "üîç Running pre-commit checks..."
echo ""

# Step 1: Run ESLint
echo "üìù Step 1/3: Checking code quality with ESLint..."
npm run lint --silent 2>/dev/null
LINT_EXIT=$?
if [ $LINT_EXIT -ne 0 ]; then
  echo "‚ö†Ô∏è  ESLint found issues (warnings are OK, errors will block)"
  # Re-run to show output
  npm run lint 2>&1 | grep -E "error|Error" | head -10
  # Check if there are actual errors (not just warnings)
  ERROR_COUNT=$(npm run lint 2>&1 | grep -c " error ")
  if [ $ERROR_COUNT -gt 0 ]; then
    echo ""
    echo "‚ùå ESLint found $ERROR_COUNT error(s). Please fix them before committing."
    echo "   Run 'npm run lint:fix' to auto-fix some issues."
    exit 1
  fi
fi
echo "‚úÖ ESLint passed"
echo ""

# Step 2: Run tests
echo "üß™ Step 2/3: Running tests..."
npm run test 2>&1
TEST_EXIT=$?
if [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "‚ùå Tests failed. Please fix failing tests before committing."
  exit 1
fi
echo "‚úÖ Tests passed"
echo ""

# Step 3: Verify build works
echo "üèóÔ∏è  Step 3/3: Verifying build..."
npm run build > /dev/null 2>&1
BUILD_EXIT=$?
if [ $BUILD_EXIT -ne 0 ]; then
  echo "‚ùå Build failed. Running build again to show errors:"
  npm run build
  exit 1
fi
echo "‚úÖ Build successful"
echo ""

echo "‚ú® All pre-commit checks passed! Proceeding with commit..."
