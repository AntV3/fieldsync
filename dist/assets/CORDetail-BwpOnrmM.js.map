{"version":3,"mappings":"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","names":["ExportStatus","ExportType","generateIdempotencyKey","corId","corVersion","customKey","minuteTimestamp","generateForcedExportKey","createSnapshot","cor","tickets","options","snapshotTime","photoManifest","totalPhotos","ticket","ticketPhotos","photoUrl","laborTotal","sum","item","materialsTotal","equipmentTotal","subcontractorsTotal","totalLaborHours","totalOTHours","worker","dataString","hash","i","char","checksum","w","t","requestExport","forceNew","idempotencyKey","exportType","includeBackup","corError","supabase","key","data","error","job","observe","err","updateJobStatus","jobId","status","details","saveSnapshot","snapshot","executeExport","project","company","branding","db","__vitePreload","n","savedSnapshot","generatePDFFromSnapshot","corPdfGenerator$1","pdfResult","formatTime","timeStr","hours","minutes","h","ampm","formatTimePeriod","context","doc","jsPDF","pageWidth","pageHeight","margin","yPos","primaryColor","hexToRgb","logoData","loadImageAsBase64","formatDateRange","scopeLines","autoTable","formatCurrency","summaryData","formatPercent","feesData","summaryCol1","summaryCol2","summaryY","verifiedColor","genDate","hasVerification","headerHeight","ticketStatusColor","formatDate","notesLines","xPos","photoWidth","photoHeight","photoGap","photosPerRow","photoImages","loadImagesAsBase64","imgData","verifyBlockHeight","verifyBlockWidth","sealX","sealY","signerName","signerTitle","signerCompany","signedDate","infoX","totalPages","footerY","fileName","generateTicketPDFFromData","ticketData","metaItems","label","value","totalReg","s","totalOT","titleCompany","corPdfGenerator","CORDetail","areas","onClose","onEdit","onShowToast","onStatusChange","loading","setLoading","useState","corData","setCORData","showSignature","setShowSignature","showSignatureLink","setShowSignatureLink","expandedTickets","setExpandedTickets","selectedPhoto","setSelectedPhoto","editingNumber","setEditingNumber","newCorNumber","setNewCorNumber","fetchFullCOR","useCallback","fullCOR","photoGroups","allPhotos","signed","offset","len","resolved","useEffect","subscription","totals","useMemo","calculateCORTotals","statusInfo","getStatusInfo","canApprove","canEdit","getAreaName","areaId","a","handleApprove","handleReject","reason","handleMarkBilled","handleSaveSignature","signatureData","canSign","handleUpdateCorNumber","startEditingNumber","toggleTicketExpanded","ticketId","prev","next","associatedTickets","assoc","getTicketHours","workers","regular","overtime","handleExportPDF","result","pipelineError","fallbackError","jsx","e","jsxs","Check","X","Pencil","Clock","FileText","DollarSign","Users","idx","centsToDollars","Package","Truck","Briefcase","Percent","Shield","Building2","isExpanded","workerCount","itemCount","photoCount","ChevronDown","ChevronRight","Calendar","Image","PenTool","Stamp","XCircle","Edit3","Fragment","CheckCircle","Link","exportCORDetail","Download","SignatureCanvas","SignatureLinkGenerator"],"ignoreList":[],"sources":["../../src/lib/corExportPipeline.js","../../src/lib/corPdfGenerator.js","../../src/components/cor/CORDetail.jsx"],"sourcesContent":["// ============================================\n// COR Export Pipeline\n// ============================================\n// Industrial-grade, idempotent, snapshot-based export system\n//\n// Core Principles (from specification):\n// 1. Idempotency - Repeat requests return same result\n// 2. Deterministic - Same COR state = same export output\n// 3. Async by default - Heavy operations don't block UI\n// 4. Fail loudly - All failures are detectable and recoverable\n// 5. Separation of concerns - Creation, aggregation, export decoupled\n//\n// This module orchestrates the export pipeline:\n// 1. Request export (idempotent, returns job)\n// 2. Create snapshot (frozen state)\n// 3. Generate PDF (from snapshot only)\n// 4. Return result (stable, immutable)\n// ============================================\n\nimport { supabase } from './supabase'\nimport { observe } from './observability'\n\n// ============================================\n// CONSTANTS\n// ============================================\n\nexport const ExportStatus = {\n  PENDING: 'pending',\n  GENERATING: 'generating',\n  COMPLETED: 'completed',\n  FAILED: 'failed'\n}\n\nexport const ExportType = {\n  PDF: 'pdf',\n  EMAIL: 'email',\n  DOWNLOAD: 'download'\n}\n\n// ============================================\n// IDEMPOTENCY KEY GENERATION\n// ============================================\n\n/**\n * Generate a deterministic idempotency key for an export request\n * Key format: cor_{corId}_v{version}_{timestamp_minute}\n *\n * Same COR at same version within same minute = same key\n * This prevents duplicate exports while allowing re-exports after changes\n */\nexport function generateIdempotencyKey(corId, corVersion, customKey = null) {\n  if (customKey) {\n    return `custom_${customKey}`\n  }\n\n  // Round timestamp to minute for deduplication window\n  const minuteTimestamp = Math.floor(Date.now() / 60000)\n  return `cor_${corId}_v${corVersion || 1}_${minuteTimestamp}`\n}\n\n/**\n * Generate a forced-new idempotency key (for explicit re-exports)\n * Includes millisecond timestamp to guarantee uniqueness\n */\nexport function generateForcedExportKey(corId) {\n  return `cor_${corId}_force_${Date.now()}`\n}\n\n// ============================================\n// SNAPSHOT CREATION\n// ============================================\n\n/**\n * Create a frozen snapshot of COR data for export\n * Snapshots are immutable - once created, never change\n *\n * @param {Object} cor - Full COR data with line items\n * @param {Object[]} tickets - Associated T&M tickets with workers/items/photos\n * @param {Object} options - Snapshot options\n * @returns {Object} Frozen snapshot ready for PDF generation\n */\nexport function createSnapshot(cor, tickets, options = {}) {\n  const snapshotTime = new Date().toISOString()\n\n  // Calculate photo manifest\n  const photoManifest = []\n  let totalPhotos = 0\n\n  for (const ticket of (tickets || [])) {\n    const ticketPhotos = ticket.photos || []\n    totalPhotos += ticketPhotos.length\n\n    for (const photoUrl of ticketPhotos) {\n      photoManifest.push({\n        ticketId: ticket.id,\n        workDate: ticket.work_date,\n        url: photoUrl,\n        verified: false, // Will be verified during PDF generation\n        includedInExport: true\n      })\n    }\n  }\n\n  // Calculate totals from line items\n  const laborTotal = (cor.change_order_labor || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const materialsTotal = (cor.change_order_materials || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const equipmentTotal = (cor.change_order_equipment || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const subcontractorsTotal = (cor.change_order_subcontractors || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n\n  // Calculate labor hours from tickets\n  let totalLaborHours = 0\n  let totalOTHours = 0\n  for (const ticket of (tickets || [])) {\n    for (const worker of (ticket.t_and_m_workers || [])) {\n      totalLaborHours += parseFloat(worker.hours) || 0\n      totalOTHours += parseFloat(worker.overtime_hours) || 0\n    }\n  }\n\n  // Create deterministic checksum\n  const dataString = JSON.stringify({\n    corId: cor.id,\n    version: cor.version,\n    totals: { laborTotal, materialsTotal, equipmentTotal, subcontractorsTotal },\n    ticketCount: tickets?.length || 0,\n    photoCount: totalPhotos\n  })\n\n  let hash = 0\n  for (let i = 0; i < dataString.length; i++) {\n    const char = dataString.charCodeAt(i)\n    hash = ((hash << 5) - hash) + char\n    hash = hash & hash\n  }\n  const checksum = Math.abs(hash).toString(16).padStart(16, '0')\n\n  return {\n    // Metadata\n    snapshotId: crypto.randomUUID(),\n    corId: cor.id,\n    corVersion: cor.version || 1,\n    createdAt: snapshotTime,\n    checksum,\n\n    // Frozen COR data\n    corData: {\n      id: cor.id,\n      cor_number: cor.cor_number,\n      title: cor.title,\n      description: cor.description,\n      scope_of_work: cor.scope_of_work,\n      status: cor.status,\n      period_start: cor.period_start,\n      period_end: cor.period_end,\n\n      // Line items (frozen)\n      change_order_labor: cor.change_order_labor || [],\n      change_order_materials: cor.change_order_materials || [],\n      change_order_equipment: cor.change_order_equipment || [],\n      change_order_subcontractors: cor.change_order_subcontractors || [],\n\n      // Percentages\n      labor_markup_percent: cor.labor_markup_percent,\n      materials_markup_percent: cor.materials_markup_percent,\n      equipment_markup_percent: cor.equipment_markup_percent,\n      subcontractors_markup_percent: cor.subcontractors_markup_percent,\n      liability_insurance_percent: cor.liability_insurance_percent,\n      bond_percent: cor.bond_percent,\n      license_fee_percent: cor.license_fee_percent,\n\n      // Calculated amounts (frozen)\n      labor_subtotal: cor.labor_subtotal,\n      materials_subtotal: cor.materials_subtotal,\n      equipment_subtotal: cor.equipment_subtotal,\n      subcontractors_subtotal: cor.subcontractors_subtotal,\n      labor_markup_amount: cor.labor_markup_amount,\n      materials_markup_amount: cor.materials_markup_amount,\n      equipment_markup_amount: cor.equipment_markup_amount,\n      subcontractors_markup_amount: cor.subcontractors_markup_amount,\n      liability_insurance_amount: cor.liability_insurance_amount,\n      bond_amount: cor.bond_amount,\n      license_fee_amount: cor.license_fee_amount,\n      cor_subtotal: cor.cor_subtotal,\n      additional_fees_total: cor.additional_fees_total,\n      cor_total: cor.cor_total,\n\n      // Signature data\n      gc_signature_data: cor.gc_signature_data,\n      gc_signature_name: cor.gc_signature_name,\n      gc_signature_date: cor.gc_signature_date,\n\n      // Audit\n      created_at: cor.created_at,\n      submitted_at: cor.submitted_at,\n      approved_at: cor.approved_at\n    },\n\n    // Frozen tickets data\n    ticketsData: (tickets || []).map(ticket => ({\n      id: ticket.id,\n      work_date: ticket.work_date,\n      ticket_date: ticket.ticket_date,\n      ce_pco_number: ticket.ce_pco_number,\n      notes: ticket.notes,\n      status: ticket.status,\n      created_at: ticket.created_at,\n\n      // Workers (frozen)\n      t_and_m_workers: (ticket.t_and_m_workers || []).map(w => ({\n        id: w.id,\n        name: w.name,\n        role: w.role,\n        labor_class: w.labor_class,\n        hours: w.hours,\n        overtime_hours: w.overtime_hours,\n        time_started: w.time_started,\n        time_ended: w.time_ended\n      })),\n\n      // Items (frozen)\n      t_and_m_items: (ticket.t_and_m_items || []).map(item => ({\n        id: item.id,\n        description: item.description,\n        quantity: item.quantity,\n        unit: item.unit,\n        materials_equipment: item.materials_equipment\n      })),\n\n      // Photos (frozen URLs)\n      photos: ticket.photos || [],\n\n      // Client verification (frozen)\n      client_signature_data: ticket.client_signature_data,\n      client_signature_name: ticket.client_signature_name,\n      client_signature_title: ticket.client_signature_title,\n      client_signature_company: ticket.client_signature_company,\n      client_signature_date: ticket.client_signature_date\n    })),\n\n    // Photo manifest for verification\n    photoManifest,\n\n    // Pre-calculated totals\n    totals: {\n      laborTotal,\n      materialsTotal,\n      equipmentTotal,\n      subcontractorsTotal,\n      totalLaborHours,\n      totalOTHours,\n      ticketCount: tickets?.length || 0,\n      photoCount: totalPhotos,\n      verifiedTicketCount: (tickets || []).filter(t => t.client_signature_data).length\n    }\n  }\n}\n\n// ============================================\n// EXPORT JOB MANAGEMENT\n// ============================================\n\n/**\n * Request a COR export (idempotent)\n * Returns existing job if same idempotency key, otherwise creates new job\n *\n * @param {string} corId - COR ID to export\n * @param {Object} options - Export options\n * @returns {Promise<Object>} Export job with status\n */\nexport async function requestExport(corId, options = {}) {\n  const {\n    forceNew = false,\n    idempotencyKey = null,\n    exportType = ExportType.PDF,\n    includeBackup = true\n  } = options\n\n  try {\n    // Get COR version for idempotency key\n    const { data: cor, error: corError } = await supabase\n      .from('change_orders')\n      .select('id, version, cor_number')\n      .eq('id', corId)\n      .single()\n\n    if (corError || !cor) {\n      throw new Error(`COR not found: ${corId}`)\n    }\n\n    // Generate idempotency key\n    const key = forceNew\n      ? generateForcedExportKey(corId)\n      : (idempotencyKey || generateIdempotencyKey(corId, cor.version))\n\n    // Request export via RPC (handles idempotency in database)\n    const { data, error } = await supabase.rpc('request_cor_export', {\n      p_cor_id: corId,\n      p_idempotency_key: key,\n      p_options: { exportType, includeBackup },\n      p_requested_by: (await supabase.auth.getUser())?.data?.user?.id\n    })\n\n    if (error) {\n      throw error\n    }\n\n    const job = data?.[0]\n    if (!job) {\n      throw new Error('Failed to create export job')\n    }\n\n    observe.activity('cor_export_requested', {\n      cor_id: corId,\n      job_id: job.job_id,\n      is_new: job.is_new,\n      status: job.status\n    })\n\n    return {\n      jobId: job.job_id,\n      status: job.status,\n      isNew: job.is_new,\n      snapshotId: job.snapshot_id,\n      pdfUrl: job.pdf_url,\n      idempotencyKey: key\n    }\n  } catch (err) {\n    observe.error('cor_export_request_failed', {\n      cor_id: corId,\n      error: err.message\n    })\n    throw err\n  }\n}\n\n/**\n * Get export job status\n * @param {string} jobId - Export job ID\n * @returns {Promise<Object>} Job status with all details\n */\nexport async function getExportJobStatus(jobId) {\n  const { data, error } = await supabase\n    .from('cor_export_jobs')\n    .select('*')\n    .eq('id', jobId)\n    .single()\n\n  if (error) {\n    throw error\n  }\n\n  return data\n}\n\n/**\n * Get export history for a COR\n * @param {string} corId - COR ID\n * @param {number} limit - Max results\n * @returns {Promise<Object[]>} Export jobs ordered by date\n */\nexport async function getExportHistory(corId, limit = 10) {\n  const { data, error } = await supabase\n    .from('cor_export_jobs')\n    .select('*')\n    .eq('cor_id', corId)\n    .order('created_at', { ascending: false })\n    .limit(limit)\n\n  if (error) {\n    throw error\n  }\n\n  return data || []\n}\n\n/**\n * Update export job status (internal use)\n * @param {string} jobId - Job ID\n * @param {string} status - New status\n * @param {Object} details - Additional details\n */\nexport async function updateJobStatus(jobId, status, details = {}) {\n  const { data, error } = await supabase.rpc('update_export_job_status', {\n    p_job_id: jobId,\n    p_status: status,\n    p_snapshot_id: details.snapshotId || null,\n    p_pdf_url: details.pdfUrl || null,\n    p_error: details.error || null,\n    p_error_details: details.errorDetails || null,\n    p_metrics: details.metrics || null\n  })\n\n  if (error) {\n    observe.error('cor_export_job_update_failed', {\n      job_id: jobId,\n      status,\n      error: error.message\n    })\n    throw error\n  }\n\n  return data\n}\n\n// ============================================\n// SNAPSHOT STORAGE\n// ============================================\n\n/**\n * Save snapshot to database\n * @param {Object} snapshot - Frozen snapshot data\n * @param {string} jobId - Associated job ID\n * @returns {Promise<Object>} Saved snapshot record\n */\nexport async function saveSnapshot(snapshot, jobId) {\n  // Mark previous snapshots as not current\n  await supabase\n    .from('cor_export_snapshots')\n    .update({ is_current: false })\n    .eq('cor_id', snapshot.corId)\n\n  const { data, error } = await supabase\n    .from('cor_export_snapshots')\n    .insert({\n      id: snapshot.snapshotId,\n      cor_id: snapshot.corId,\n      job_id: jobId,\n      cor_version: snapshot.corVersion,\n      cor_data: snapshot.corData,\n      tickets_data: snapshot.ticketsData,\n      photos_manifest: snapshot.photoManifest,\n      totals_snapshot: snapshot.totals,\n      checksum: snapshot.checksum,\n      is_current: true,\n      exported_by: (await supabase.auth.getUser())?.data?.user?.id\n    })\n    .select()\n    .single()\n\n  if (error) {\n    throw error\n  }\n\n  // Update COR's last snapshot version\n  await supabase\n    .from('change_orders')\n    .update({ last_snapshot_version: snapshot.corVersion })\n    .eq('id', snapshot.corId)\n\n  return data\n}\n\n/**\n * Get current snapshot for a COR (if exists and still valid)\n * @param {string} corId - COR ID\n * @returns {Promise<Object|null>} Current snapshot or null\n */\nexport async function getCurrentSnapshot(corId) {\n  // Get COR's current version\n  const { data: cor } = await supabase\n    .from('change_orders')\n    .select('version, last_snapshot_version')\n    .eq('id', corId)\n    .single()\n\n  // If version has changed since last snapshot, snapshot is stale\n  if (cor?.version !== cor?.last_snapshot_version) {\n    return null\n  }\n\n  // Get current snapshot\n  const { data: snapshot } = await supabase\n    .from('cor_export_snapshots')\n    .select('*')\n    .eq('cor_id', corId)\n    .eq('is_current', true)\n    .single()\n\n  return snapshot || null\n}\n\n// ============================================\n// FULL EXPORT ORCHESTRATION\n// ============================================\n\n/**\n * Execute full export pipeline\n * This is the main entry point for COR exports\n *\n * Pipeline:\n * 1. Request export (idempotent)\n * 2. If new job, create snapshot\n * 3. Generate PDF from snapshot\n * 4. Update job with result\n *\n * @param {string} corId - COR to export\n * @param {Object} cor - Full COR data (optional, will fetch if not provided)\n * @param {Object[]} tickets - Associated tickets (optional, will fetch if not provided)\n * @param {Object} project - Project data\n * @param {Object} company - Company data\n * @param {Object} branding - Company branding\n * @param {Object} options - Export options\n * @returns {Promise<Object>} Export result\n */\nexport async function executeExport(corId, { cor, tickets, project, company, branding, options = {} } = {}) {\n  let job = null\n\n  try {\n    // Step 1: Request export (idempotent)\n    job = await requestExport(corId, options)\n\n    // If job already completed, return existing result\n    if (job.status === ExportStatus.COMPLETED && job.pdfUrl) {\n      observe.activity('cor_export_cache_hit', {\n        cor_id: corId,\n        job_id: job.jobId\n      })\n      return {\n        success: true,\n        jobId: job.jobId,\n        cached: true,\n        pdfUrl: job.pdfUrl\n      }\n    }\n\n    // If job is already generating, return job for polling\n    if (job.status === ExportStatus.GENERATING) {\n      return {\n        success: true,\n        jobId: job.jobId,\n        status: ExportStatus.GENERATING,\n        message: 'Export already in progress'\n      }\n    }\n\n    // Step 2: Mark job as generating\n    await updateJobStatus(job.jobId, ExportStatus.GENERATING)\n\n    // Step 3: Fetch data if not provided\n    if (!cor) {\n      const { db } = await import('./supabase')\n      cor = await db.getCORById(corId)\n    }\n\n    if (!tickets && options.includeBackup !== false) {\n      const { db } = await import('./supabase')\n      tickets = await db.getCORTickets(corId)\n    }\n\n    // Step 4: Create snapshot\n    const snapshot = createSnapshot(cor, tickets, options)\n    const savedSnapshot = await saveSnapshot(snapshot, job.jobId)\n\n    // Step 5: Generate PDF from snapshot\n    // Import the PDF generator dynamically to avoid circular deps\n    const { generatePDFFromSnapshot } = await import('./corPdfGenerator')\n    const pdfResult = await generatePDFFromSnapshot(\n      snapshot,\n      { project, company, branding }\n    )\n\n    // Step 6: Update job as completed\n    await updateJobStatus(job.jobId, ExportStatus.COMPLETED, {\n      snapshotId: savedSnapshot.id,\n      pdfUrl: pdfResult.fileName,\n      metrics: {\n        photo_count: snapshot.totals.photoCount,\n        ticket_count: snapshot.totals.ticketCount,\n        page_count: pdfResult.pageCount || 1,\n        pdf_size_bytes: pdfResult.sizeBytes || 0\n      }\n    })\n\n    observe.activity('cor_export_completed', {\n      cor_id: corId,\n      job_id: job.jobId,\n      photo_count: snapshot.totals.photoCount,\n      ticket_count: snapshot.totals.ticketCount\n    })\n\n    return {\n      success: true,\n      jobId: job.jobId,\n      snapshotId: savedSnapshot.id,\n      fileName: pdfResult.fileName,\n      snapshot: snapshot.totals\n    }\n\n  } catch (err) {\n    // Update job as failed\n    if (job?.jobId) {\n      await updateJobStatus(job.jobId, ExportStatus.FAILED, {\n        error: err.message,\n        errorDetails: { stack: err.stack }\n      }).catch(() => {}) // Don't throw on status update failure\n    }\n\n    observe.error('cor_export_failed', {\n      cor_id: corId,\n      job_id: job?.jobId,\n      error: err.message\n    })\n\n    throw err\n  }\n}\n\n// ============================================\n// EXPORTS\n// ============================================\n\nexport default {\n  // Constants\n  ExportStatus,\n  ExportType,\n\n  // Key generation\n  generateIdempotencyKey,\n  generateForcedExportKey,\n\n  // Snapshot\n  createSnapshot,\n  saveSnapshot,\n  getCurrentSnapshot,\n\n  // Job management\n  requestExport,\n  getExportJobStatus,\n  getExportHistory,\n  updateJobStatus,\n\n  // Full pipeline\n  executeExport\n}\n","// ============================================\n// COR PDF Generator (Snapshot-Based)\n// ============================================\n// Generates PDF documents from frozen COR snapshots\n//\n// Key Principle: This module NEVER queries live data\n// It only works with the snapshot provided to it\n// This ensures deterministic, reproducible exports\n// ============================================\n\nimport jsPDF from 'jspdf'\nimport autoTable from 'jspdf-autotable'\nimport {\n  formatCurrency,\n  formatPercent,\n  formatDate,\n  formatDateRange\n} from './corCalculations'\nimport { hexToRgb, loadImageAsBase64, loadImagesAsBase64 } from './imageUtils'\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nconst formatTime = (timeStr) => {\n  if (!timeStr) return ''\n  const [hours, minutes] = timeStr.split(':')\n  const h = parseInt(hours)\n  const ampm = h >= 12 ? 'pm' : 'am'\n  const h12 = h % 12 || 12\n  return `${h12}:${minutes}${ampm}`\n}\n\nconst formatTimePeriod = (worker) => {\n  if (worker.time_started && worker.time_ended) {\n    return `${formatTime(worker.time_started)} - ${formatTime(worker.time_ended)}`\n  }\n  return '-'\n}\n\n// ============================================\n// MAIN PDF GENERATOR\n// ============================================\n\n/**\n * Generate PDF from a frozen COR snapshot\n * This function ONLY uses data from the snapshot - never queries live data\n *\n * @param {Object} snapshot - Frozen snapshot from createSnapshot()\n * @param {Object} context - Additional context (project, company, branding)\n * @returns {Promise<Object>} PDF generation result\n */\nexport async function generatePDFFromSnapshot(snapshot, context = {}) {\n  const { project, company, branding = {} } = context\n  const cor = snapshot.corData\n  const tickets = snapshot.ticketsData || []\n\n  const doc = new jsPDF()\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  let yPos = margin\n\n  const primaryColor = branding.primaryColor\n    ? hexToRgb(branding.primaryColor)\n    : [30, 58, 95]\n\n  // ============================================\n  // HEADER\n  // ============================================\n\n  // Company logo or name\n  if (branding.logoUrl) {\n    try {\n      const logoData = await loadImageAsBase64(branding.logoUrl)\n      if (logoData) {\n        doc.addImage(logoData, 'PNG', margin, yPos, 40, 15)\n      }\n    } catch (e) {\n      if (company?.name) {\n        doc.setFontSize(14)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(...primaryColor)\n        doc.text(company.name, margin, yPos + 8)\n      }\n    }\n  } else if (company?.name) {\n    doc.setFontSize(14)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(...primaryColor)\n    doc.text(company.name, margin, yPos + 8)\n  }\n\n  // Document title\n  doc.setFontSize(18)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(30, 41, 59)\n  doc.text('CHANGE ORDER REQUEST', pageWidth - margin, yPos + 5, { align: 'right' })\n\n  // COR number\n  doc.setFontSize(12)\n  doc.setTextColor(...primaryColor)\n  doc.text(cor.cor_number || 'COR', pageWidth - margin, yPos + 12, { align: 'right' })\n\n  yPos += 25\n\n  // Decorative line\n  doc.setDrawColor(...primaryColor)\n  doc.setLineWidth(0.5)\n  doc.line(margin, yPos, pageWidth - margin, yPos)\n  yPos += 10\n\n  // ============================================\n  // COR DETAILS\n  // ============================================\n\n  doc.setFontSize(14)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(30, 41, 59)\n  doc.text(cor.title || 'Untitled Change Order', margin, yPos)\n  yPos += 8\n\n  // Project info\n  doc.setFontSize(10)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(71, 85, 105)\n\n  if (project?.name) {\n    doc.text(`Project: ${project.name}`, margin, yPos)\n    yPos += 5\n  }\n  if (project?.job_number) {\n    doc.text(`Job #: ${project.job_number}`, margin, yPos)\n    yPos += 5\n  }\n  if (cor.period_start || cor.period_end) {\n    doc.text(`Period: ${formatDateRange(cor.period_start, cor.period_end)}`, margin, yPos)\n    yPos += 5\n  }\n\n  yPos += 5\n\n  // Scope of work\n  if (cor.scope_of_work) {\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(71, 85, 105)\n    doc.text('Scope of Work:', margin, yPos)\n    yPos += 5\n\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(51, 65, 85)\n    const scopeLines = doc.splitTextToSize(cor.scope_of_work, pageWidth - (margin * 2))\n    doc.text(scopeLines, margin, yPos)\n    yPos += (scopeLines.length * 4) + 8\n  }\n\n  // ============================================\n  // LABOR TABLE\n  // ============================================\n\n  if (cor.change_order_labor?.length > 0) {\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('Labor', margin, yPos)\n    yPos += 5\n\n    autoTable(doc, {\n      startY: yPos,\n      head: [['Class', 'Wage Type', 'Reg Hrs', 'Reg Rate', 'OT Hrs', 'OT Rate', 'Total']],\n      body: cor.change_order_labor.map(item => [\n        item.labor_class,\n        item.wage_type || 'Standard',\n        item.regular_hours?.toString() || '0',\n        formatCurrency(item.regular_rate),\n        item.overtime_hours?.toString() || '0',\n        formatCurrency(item.overtime_rate),\n        formatCurrency(item.total)\n      ]),\n      foot: [[\n        { content: 'Labor Subtotal', colSpan: 6, styles: { halign: 'right', fontStyle: 'bold' } },\n        { content: formatCurrency(cor.labor_subtotal), styles: { fontStyle: 'bold' } }\n      ]],\n      margin: { left: margin, right: margin },\n      headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8 },\n      bodyStyles: { fontSize: 8 },\n      footStyles: { fillColor: [248, 250, 252], textColor: [30, 41, 59], fontSize: 8 },\n      theme: 'grid'\n    })\n\n    yPos = doc.lastAutoTable.finalY + 10\n  }\n\n  // ============================================\n  // MATERIALS TABLE\n  // ============================================\n\n  if (cor.change_order_materials?.length > 0) {\n    if (yPos > pageHeight - 60) {\n      doc.addPage()\n      yPos = margin\n    }\n\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('Materials', margin, yPos)\n    yPos += 5\n\n    autoTable(doc, {\n      startY: yPos,\n      head: [['Description', 'Source', 'Qty', 'Unit', 'Unit Cost', 'Total']],\n      body: cor.change_order_materials.map(item => [\n        item.description,\n        item.source_reference || item.source_type || '-',\n        item.quantity?.toString() || '1',\n        item.unit || 'ea',\n        formatCurrency(item.unit_cost),\n        formatCurrency(item.total)\n      ]),\n      foot: [[\n        { content: 'Materials Subtotal', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },\n        { content: formatCurrency(cor.materials_subtotal), styles: { fontStyle: 'bold' } }\n      ]],\n      margin: { left: margin, right: margin },\n      headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8 },\n      bodyStyles: { fontSize: 8 },\n      footStyles: { fillColor: [248, 250, 252], textColor: [30, 41, 59], fontSize: 8 },\n      theme: 'grid'\n    })\n\n    yPos = doc.lastAutoTable.finalY + 10\n  }\n\n  // ============================================\n  // EQUIPMENT TABLE\n  // ============================================\n\n  if (cor.change_order_equipment?.length > 0) {\n    if (yPos > pageHeight - 60) {\n      doc.addPage()\n      yPos = margin\n    }\n\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('Equipment', margin, yPos)\n    yPos += 5\n\n    autoTable(doc, {\n      startY: yPos,\n      head: [['Description', 'Source', 'Qty', 'Unit', 'Unit Cost', 'Total']],\n      body: cor.change_order_equipment.map(item => [\n        item.description,\n        item.source_reference || item.source_type || '-',\n        item.quantity?.toString() || '1',\n        item.unit || 'day',\n        formatCurrency(item.unit_cost),\n        formatCurrency(item.total)\n      ]),\n      foot: [[\n        { content: 'Equipment Subtotal', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },\n        { content: formatCurrency(cor.equipment_subtotal), styles: { fontStyle: 'bold' } }\n      ]],\n      margin: { left: margin, right: margin },\n      headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8 },\n      bodyStyles: { fontSize: 8 },\n      footStyles: { fillColor: [248, 250, 252], textColor: [30, 41, 59], fontSize: 8 },\n      theme: 'grid'\n    })\n\n    yPos = doc.lastAutoTable.finalY + 10\n  }\n\n  // ============================================\n  // SUBCONTRACTORS TABLE\n  // ============================================\n\n  if (cor.change_order_subcontractors?.length > 0) {\n    if (yPos > pageHeight - 60) {\n      doc.addPage()\n      yPos = margin\n    }\n\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('Subcontractors', margin, yPos)\n    yPos += 5\n\n    autoTable(doc, {\n      startY: yPos,\n      head: [['Company Name', 'Description', 'Source', 'Qty', 'Unit', 'Unit Cost', 'Total']],\n      body: cor.change_order_subcontractors.map(item => [\n        item.company_name || '-',\n        item.description,\n        item.source_reference || item.source_type || '-',\n        item.quantity?.toString() || '1',\n        item.unit || 'lump sum',\n        formatCurrency(item.unit_cost),\n        formatCurrency(item.total)\n      ]),\n      foot: [[\n        { content: 'Subcontractors Subtotal', colSpan: 6, styles: { halign: 'right', fontStyle: 'bold' } },\n        { content: formatCurrency(cor.subcontractors_subtotal), styles: { fontStyle: 'bold' } }\n      ]],\n      margin: { left: margin, right: margin },\n      headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8 },\n      bodyStyles: { fontSize: 8 },\n      footStyles: { fillColor: [248, 250, 252], textColor: [30, 41, 59], fontSize: 8 },\n      theme: 'grid'\n    })\n\n    yPos = doc.lastAutoTable.finalY + 10\n  }\n\n  // ============================================\n  // TOTALS SUMMARY\n  // ============================================\n\n  if (yPos > pageHeight - 100) {\n    doc.addPage()\n    yPos = margin\n  }\n\n  doc.setFontSize(11)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(30, 41, 59)\n  doc.text('Cost Summary', margin, yPos)\n  yPos += 5\n\n  const summaryData = [\n    ['Labor Subtotal', formatCurrency(cor.labor_subtotal)],\n    [`  Markup (${formatPercent(cor.labor_markup_percent)})`, formatCurrency(cor.labor_markup_amount)],\n    ['Materials Subtotal', formatCurrency(cor.materials_subtotal)],\n    [`  Markup (${formatPercent(cor.materials_markup_percent)})`, formatCurrency(cor.materials_markup_amount)],\n    ['Equipment Subtotal', formatCurrency(cor.equipment_subtotal)],\n    [`  Markup (${formatPercent(cor.equipment_markup_percent)})`, formatCurrency(cor.equipment_markup_amount)],\n    ['Subcontractors Subtotal', formatCurrency(cor.subcontractors_subtotal)],\n    [`  Markup (${formatPercent(cor.subcontractors_markup_percent)})`, formatCurrency(cor.subcontractors_markup_amount)],\n  ]\n\n  autoTable(doc, {\n    startY: yPos,\n    body: summaryData,\n    margin: { left: margin, right: margin },\n    columnStyles: {\n      0: { cellWidth: 120 },\n      1: { cellWidth: 50, halign: 'right' }\n    },\n    bodyStyles: { fontSize: 9 },\n    theme: 'plain'\n  })\n\n  yPos = doc.lastAutoTable.finalY + 5\n\n  // COR Subtotal\n  doc.setFillColor(248, 250, 252)\n  doc.rect(margin, yPos, pageWidth - (margin * 2), 8, 'F')\n  doc.setFont('helvetica', 'bold')\n  doc.setFontSize(10)\n  doc.setTextColor(30, 41, 59)\n  doc.text('COR Subtotal:', margin + 5, yPos + 5.5)\n  doc.text(formatCurrency(cor.cor_subtotal), pageWidth - margin - 5, yPos + 5.5, { align: 'right' })\n  yPos += 12\n\n  // Additional fees\n  const feesData = [\n    [`Liability Insurance (${formatPercent(cor.liability_insurance_percent)})`, formatCurrency(cor.liability_insurance_amount)],\n    [`Bond (${formatPercent(cor.bond_percent)})`, formatCurrency(cor.bond_amount)],\n    [`License Fee (${formatPercent(cor.license_fee_percent)})`, formatCurrency(cor.license_fee_amount)],\n  ]\n\n  autoTable(doc, {\n    startY: yPos,\n    body: feesData,\n    margin: { left: margin, right: margin },\n    columnStyles: {\n      0: { cellWidth: 120 },\n      1: { cellWidth: 50, halign: 'right' }\n    },\n    bodyStyles: { fontSize: 9 },\n    theme: 'plain'\n  })\n\n  yPos = doc.lastAutoTable.finalY + 5\n\n  // COR Total\n  doc.setFillColor(...primaryColor)\n  doc.rect(margin, yPos, pageWidth - (margin * 2), 10, 'F')\n  doc.setFont('helvetica', 'bold')\n  doc.setFontSize(12)\n  doc.setTextColor(255, 255, 255)\n  doc.text('COR TOTAL:', margin + 5, yPos + 7)\n  doc.text(formatCurrency(cor.cor_total), pageWidth - margin - 5, yPos + 7, { align: 'right' })\n  yPos += 20\n\n  // ============================================\n  // T&M BACKUP DOCUMENTATION\n  // ============================================\n\n  if (tickets.length > 0) {\n    // Add backup cover page\n    doc.addPage()\n    yPos = margin\n\n    // Cover page header\n    if (company?.name) {\n      doc.setFontSize(14)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(...primaryColor)\n      doc.text(company.name, margin, yPos)\n      yPos += 15\n    }\n\n    // Decorative lines\n    doc.setDrawColor(...primaryColor)\n    doc.setLineWidth(0.8)\n    doc.line(margin, yPos, pageWidth - margin, yPos)\n    yPos += 3\n    doc.setLineWidth(0.3)\n    doc.line(margin, yPos, pageWidth - margin, yPos)\n    yPos += 15\n\n    // Title\n    doc.setFontSize(20)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('SUPPORTING DOCUMENTATION', pageWidth / 2, yPos, { align: 'center' })\n    yPos += 8\n\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(71, 85, 105)\n    doc.text('Change Order Request Backup', pageWidth / 2, yPos, { align: 'center' })\n    yPos += 20\n\n    // COR reference\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text(`COR Reference: ${cor.cor_number}`, margin, yPos)\n    yPos += 6\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(71, 85, 105)\n    if (project?.name) {\n      doc.text(`Project: ${project.name}`, margin, yPos)\n      yPos += 5\n    }\n    if (project?.job_number) {\n      doc.text(`Job #: ${project.job_number}`, margin, yPos)\n      yPos += 5\n    }\n    yPos += 15\n\n    // Summary box\n    doc.setFillColor(248, 250, 252)\n    doc.setDrawColor(226, 232, 240)\n    doc.roundedRect(margin, yPos, pageWidth - (margin * 2), 55, 3, 3, 'FD')\n\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('DOCUMENTATION SUMMARY', margin + 10, yPos + 12)\n\n    doc.setDrawColor(226, 232, 240)\n    doc.line(margin + 10, yPos + 16, pageWidth - margin - 10, yPos + 16)\n\n    const summaryCol1 = margin + 15\n    const summaryCol2 = margin + 80\n    let summaryY = yPos + 25\n\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(71, 85, 105)\n\n    doc.text('T&M Tickets:', summaryCol1, summaryY)\n    doc.setFont('helvetica', 'bold')\n    doc.text(String(tickets.length), summaryCol2, summaryY)\n    doc.setFont('helvetica', 'normal')\n    summaryY += 7\n\n    doc.text('Total Labor:', summaryCol1, summaryY)\n    doc.setFont('helvetica', 'bold')\n    doc.text(`${snapshot.totals.totalLaborHours.toFixed(1)} hrs`, summaryCol2, summaryY)\n    doc.setFont('helvetica', 'normal')\n    summaryY += 7\n\n    if (snapshot.totals.totalOTHours > 0) {\n      doc.text('Total OT:', summaryCol1, summaryY)\n      doc.setFont('helvetica', 'bold')\n      doc.text(`${snapshot.totals.totalOTHours.toFixed(1)} hrs`, summaryCol2, summaryY)\n      doc.setFont('helvetica', 'normal')\n      summaryY += 7\n    }\n\n    doc.text('Photo Evidence:', summaryCol1, summaryY)\n    doc.setFont('helvetica', 'bold')\n    doc.text(`${snapshot.totals.photoCount} photos`, summaryCol2, summaryY)\n    doc.setFont('helvetica', 'normal')\n    summaryY += 7\n\n    doc.text('Client Verified:', summaryCol1, summaryY)\n    doc.setFont('helvetica', 'bold')\n    const verifiedColor = snapshot.totals.verifiedTicketCount > 0 ? [16, 185, 129] : [71, 85, 105]\n    doc.setTextColor(...verifiedColor)\n    doc.text(`${snapshot.totals.verifiedTicketCount} of ${tickets.length} tickets`, summaryCol2, summaryY)\n\n    yPos += 70\n\n    // Document ID and timestamp\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(100, 116, 139)\n    const genDate = new Date(snapshot.createdAt)\n    doc.text(`Generated: ${genDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} at ${genDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`, margin, yPos)\n    yPos += 6\n    doc.text(`Document ID: ${snapshot.checksum.substring(0, 16).toUpperCase()}`, margin, yPos)\n\n    // ============================================\n    // INDIVIDUAL TICKET PAGES\n    // ============================================\n\n    for (const ticket of tickets) {\n      doc.addPage()\n      yPos = margin\n\n      const hasVerification = !!ticket.client_signature_data\n\n      // Ticket header with colored left border\n      const headerHeight = 22\n      const ticketStatusColor = hasVerification ? [16, 185, 129] : [245, 158, 11]\n\n      doc.setFillColor(...ticketStatusColor)\n      doc.rect(margin, yPos, 4, headerHeight, 'F')\n\n      doc.setFillColor(248, 250, 252)\n      doc.rect(margin + 4, yPos, pageWidth - (margin * 2) - 4, headerHeight, 'F')\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(30, 41, 59)\n      doc.text(`T&M TICKET  ${formatDate(ticket.work_date || ticket.ticket_date)}`, margin + 10, yPos + 8)\n\n      if (ticket.ce_pco_number) {\n        doc.setFontSize(9)\n        doc.setFont('helvetica', 'normal')\n        doc.setTextColor(59, 130, 246)\n        doc.text(`CE/PCO: ${ticket.ce_pco_number}`, margin + 10, yPos + 16)\n      }\n\n      if (hasVerification) {\n        doc.setFontSize(8)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(16, 185, 129)\n        doc.text(' CLIENT VERIFIED', pageWidth - margin - 35, yPos + 12)\n      }\n\n      yPos += headerHeight + 8\n\n      // Description\n      if (ticket.notes) {\n        doc.setFontSize(10)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(71, 85, 105)\n        doc.text('DESCRIPTION', margin, yPos)\n        yPos += 6\n\n        doc.setFontSize(9)\n        doc.setFont('helvetica', 'normal')\n        doc.setTextColor(51, 65, 85)\n        const notesLines = doc.splitTextToSize(ticket.notes, pageWidth - (margin * 2))\n        doc.text(notesLines, margin, yPos)\n        yPos += (notesLines.length * 4) + 10\n      }\n\n      // Workers table\n      if (ticket.t_and_m_workers?.length > 0) {\n        doc.setFontSize(10)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(71, 85, 105)\n        doc.text('LABOR', margin, yPos)\n        yPos += 6\n\n        autoTable(doc, {\n          startY: yPos,\n          head: [['Worker', 'Time Period', 'Class', 'Reg Hrs', 'OT Hrs']],\n          body: ticket.t_and_m_workers.map(w => [\n            w.name,\n            formatTimePeriod(w),\n            w.role || w.labor_class || 'Laborer',\n            w.hours?.toString() || '0',\n            w.overtime_hours?.toString() || '-'\n          ]),\n          margin: { left: margin, right: margin },\n          headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8, cellPadding: 3, fontStyle: 'bold' },\n          bodyStyles: { fontSize: 8, cellPadding: 3 },\n          alternateRowStyles: { fillColor: [248, 250, 252] },\n          theme: 'grid'\n        })\n\n        yPos = doc.lastAutoTable.finalY + 10\n      }\n\n      // Materials/Equipment\n      if (ticket.t_and_m_items?.length > 0) {\n        if (yPos > pageHeight - 60) {\n          doc.addPage()\n          yPos = margin\n        }\n\n        doc.setFontSize(10)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(71, 85, 105)\n        doc.text('MATERIALS / EQUIPMENT', margin, yPos)\n\n        doc.setFontSize(7)\n        doc.setFont('helvetica', 'normal')\n        doc.setTextColor(100, 116, 139)\n        doc.text('Source: T&M Ticket', margin + 55, yPos)\n        yPos += 6\n\n        autoTable(doc, {\n          startY: yPos,\n          head: [['Item', 'Qty', 'Unit']],\n          body: ticket.t_and_m_items.map(item => [\n            item.custom_name || item.materials_equipment?.name || item.description || 'Unnamed Item',\n            item.quantity?.toString() || '1',\n            item.materials_equipment?.unit || item.unit || 'ea'\n          ]),\n          margin: { left: margin, right: margin },\n          headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8, cellPadding: 3, fontStyle: 'bold' },\n          bodyStyles: { fontSize: 8, cellPadding: 3 },\n          alternateRowStyles: { fillColor: [248, 250, 252] },\n          theme: 'grid'\n        })\n\n        yPos = doc.lastAutoTable.finalY + 10\n      }\n\n      // Photos\n      if (ticket.photos?.length > 0) {\n        if (yPos > pageHeight - 80) {\n          doc.addPage()\n          yPos = margin\n        }\n\n        doc.setFontSize(10)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(71, 85, 105)\n        doc.text('PHOTO DOCUMENTATION', margin, yPos)\n\n        doc.setFontSize(8)\n        doc.setFont('helvetica', 'normal')\n        doc.setTextColor(59, 130, 246)\n        doc.text(`${ticket.photos.length} photo${ticket.photos.length !== 1 ? 's' : ''}`, margin + 50, yPos)\n        yPos += 8\n\n        let xPos = margin\n        const photoWidth = 55\n        const photoHeight = 45\n        const photoGap = 6\n        const photosPerRow = 3\n\n        // Load all photos in parallel for faster PDF generation\n        const photoImages = await loadImagesAsBase64(ticket.photos)\n\n        for (let i = 0; i < ticket.photos.length; i++) {\n          if (i > 0 && i % photosPerRow === 0) {\n            xPos = margin\n            yPos += photoHeight + photoGap + 4\n          }\n\n          if (yPos + photoHeight > pageHeight - 20) {\n            doc.addPage()\n            yPos = margin\n            xPos = margin\n          }\n\n          const imgData = photoImages[i]\n          if (imgData) {\n            doc.setDrawColor(200, 200, 200)\n            doc.setLineWidth(1)\n            doc.rect(xPos - 1, yPos - 1, photoWidth + 2, photoHeight + 2, 'S')\n            doc.setFillColor(230, 230, 230)\n            doc.rect(xPos + 2, yPos + 2, photoWidth, photoHeight, 'F')\n            doc.addImage(imgData, 'JPEG', xPos, yPos, photoWidth, photoHeight)\n          } else {\n            doc.setFillColor(245, 245, 245)\n            doc.rect(xPos, yPos, photoWidth, photoHeight, 'F')\n            doc.setDrawColor(200, 200, 200)\n            doc.rect(xPos, yPos, photoWidth, photoHeight, 'S')\n            doc.setFontSize(7)\n            doc.setTextColor(150, 150, 150)\n            doc.text('Photo unavailable', xPos + 8, yPos + photoHeight / 2)\n          }\n\n          xPos += photoWidth + photoGap\n        }\n\n        yPos += photoHeight + 12\n      }\n\n      // Client verification block\n      if (ticket.client_signature_data) {\n        if (yPos > pageHeight - 50) {\n          doc.addPage()\n          yPos = margin\n        }\n\n        const verifyBlockHeight = 32\n        const verifyBlockWidth = pageWidth - (margin * 2)\n\n        doc.setFillColor(240, 253, 244)\n        doc.roundedRect(margin, yPos, verifyBlockWidth, verifyBlockHeight, 3, 3, 'F')\n\n        doc.setFillColor(16, 185, 129)\n        doc.rect(margin, yPos, 4, verifyBlockHeight, 'F')\n\n        doc.setDrawColor(187, 247, 208)\n        doc.setLineWidth(0.5)\n        doc.line(margin + 4, yPos, margin + verifyBlockWidth, yPos)\n\n        const sealX = margin + 14\n        const sealY = yPos + verifyBlockHeight / 2\n        doc.setFillColor(16, 185, 129)\n        doc.circle(sealX, sealY, 6, 'F')\n        doc.setFontSize(9)\n        doc.setTextColor(255, 255, 255)\n        doc.text('', sealX - 2.5, sealY + 3)\n\n        doc.setFontSize(9)\n        doc.setFont('helvetica', 'bold')\n        doc.setTextColor(16, 185, 129)\n        doc.text('CLIENT VERIFIED', margin + 26, yPos + 10)\n\n        try {\n          const sigWidth = 50\n          const sigHeight = 16\n          doc.addImage(ticket.client_signature_data, 'PNG', margin + 26, yPos + 13, sigWidth, sigHeight)\n\n          const signerName = ticket.client_signature_name || 'Client'\n          const signerTitle = ticket.client_signature_title || ''\n          const signerCompany = ticket.client_signature_company || ''\n          const signedDate = ticket.client_signature_date\n            ? formatDate(ticket.client_signature_date)\n            : ''\n\n          const infoX = margin + 85\n\n          doc.setFont('helvetica', 'bold')\n          doc.setFontSize(9)\n          doc.setTextColor(30, 41, 59)\n          doc.text(signerName, infoX, yPos + 12)\n\n          doc.setFont('helvetica', 'normal')\n          doc.setFontSize(8)\n          doc.setTextColor(71, 85, 105)\n          if (signerTitle || signerCompany) {\n            doc.text(`${signerTitle}${signerTitle && signerCompany ? ', ' : ''}${signerCompany}`, infoX, yPos + 18)\n          }\n          if (signedDate) {\n            doc.setTextColor(100, 116, 139)\n            doc.text(`Verified: ${signedDate}`, infoX, yPos + 24)\n          }\n        } catch (e) {\n          const signerName = ticket.client_signature_name || 'Client'\n          doc.setFont('helvetica', 'normal')\n          doc.setFontSize(9)\n          doc.setTextColor(30, 41, 59)\n          doc.text(`Signed by: ${signerName}`, margin + 26, yPos + 20)\n        }\n      }\n    }\n  }\n\n  // ============================================\n  // FOOTER (on all pages)\n  // ============================================\n\n  const totalPages = doc.internal.getNumberOfPages()\n  for (let i = 1; i <= totalPages; i++) {\n    doc.setPage(i)\n    const footerY = pageHeight - 10\n    doc.setFontSize(8)\n    doc.setTextColor(150, 150, 150)\n    doc.text(`Generated on ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`, margin, footerY)\n    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, footerY, { align: 'right' })\n  }\n\n  // ============================================\n  // SAVE PDF\n  // ============================================\n\n  const fileName = `${cor.cor_number || 'COR'}_${project?.job_number || 'export'}${tickets.length ? '_with_backup' : ''}.pdf`\n  doc.save(fileName)\n\n  return {\n    success: true,\n    fileName,\n    pageCount: totalPages,\n    sizeBytes: doc.output().length\n  }\n}\n\n// ============================================\n// SINGLE TICKET PDF GENERATOR\n// ============================================\n\n/**\n * Generate PDF for a single T&M ticket from snapshot data\n * @param {Object} ticketData - Ticket data (can be from snapshot or live)\n * @param {Object} context - Project, company, branding\n * @returns {Promise<Object>} PDF generation result\n */\nexport async function generateTicketPDFFromData(ticketData, context = {}) {\n  const { project, company, branding = {} } = context\n  const ticket = ticketData\n\n  const doc = new jsPDF('p', 'mm', 'letter')\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  let yPos = margin\n\n  const primaryColor = branding.primaryColor\n    ? hexToRgb(branding.primaryColor)\n    : [30, 58, 95]\n\n  // Header\n  if (company?.name) {\n    doc.setFontSize(14)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(...primaryColor)\n    doc.text(company.name, margin, yPos + 8)\n  }\n\n  doc.setFontSize(16)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(30, 41, 59)\n  doc.text('T&M TICKET', pageWidth - margin, yPos + 8, { align: 'right' })\n\n  yPos += 25\n\n  doc.setDrawColor(...primaryColor)\n  doc.setLineWidth(0.5)\n  doc.line(margin, yPos, pageWidth - margin, yPos)\n  yPos += 10\n\n  // Status badge\n  const hasVerification = !!ticket.client_signature_data\n\n  if (hasVerification) {\n    doc.setFillColor(240, 253, 244)\n    doc.roundedRect(pageWidth - margin - 48, yPos - 5, 48, 12, 2, 2, 'F')\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(16, 185, 129)\n    doc.text(' CLIENT VERIFIED', pageWidth - margin - 45, yPos + 3)\n  } else {\n    doc.setFillColor(255, 251, 235)\n    doc.roundedRect(pageWidth - margin - 30, yPos - 5, 30, 12, 2, 2, 'F')\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(217, 119, 6)\n    doc.text('PENDING', pageWidth - margin - 27, yPos + 3)\n  }\n\n  // Metadata\n  const metaItems = [\n    ['Project:', project?.name || 'N/A'],\n    ['Job #:', project?.job_number || 'N/A'],\n    ['Work Date:', formatDate(ticket.work_date || ticket.ticket_date)],\n  ]\n  if (ticket.ce_pco_number) metaItems.push(['CE/PCO:', ticket.ce_pco_number])\n\n  metaItems.forEach(([label, value]) => {\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(71, 85, 105)\n    doc.text(label, margin, yPos)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(30, 41, 59)\n    doc.text(value, margin + 28, yPos)\n    yPos += 6\n  })\n\n  yPos += 6\n\n  // ============================================\n  // DESCRIPTION\n  // ============================================\n\n  if (ticket.notes) {\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(71, 85, 105)\n    doc.text('DESCRIPTION', margin, yPos)\n    yPos += 5\n\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(51, 65, 85)\n    const notesLines = doc.splitTextToSize(ticket.notes, pageWidth - margin * 2)\n    doc.text(notesLines, margin, yPos)\n    yPos += notesLines.length * 4 + 10\n  }\n\n  // ============================================\n  // LABOR TABLE\n  // ============================================\n\n  if (ticket.t_and_m_workers?.length > 0) {\n    if (yPos > pageHeight - 60) { doc.addPage(); yPos = margin }\n\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(71, 85, 105)\n    doc.text('LABOR', margin, yPos)\n    yPos += 5\n\n    const totalReg = ticket.t_and_m_workers.reduce((s, w) => s + (parseFloat(w.hours) || 0), 0)\n    const totalOT = ticket.t_and_m_workers.reduce((s, w) => s + (parseFloat(w.overtime_hours) || 0), 0)\n\n    autoTable(doc, {\n      startY: yPos,\n      head: [['Worker', 'Time Period', 'Class', 'Reg Hrs', 'OT Hrs']],\n      body: ticket.t_and_m_workers.map(w => [\n        w.name,\n        formatTimePeriod(w),\n        w.role || w.labor_class || 'Laborer',\n        w.hours?.toString() || '0',\n        w.overtime_hours?.toString() || '-'\n      ]),\n      foot: [[\n        { content: 'TOTAL HOURS', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } },\n        { content: totalReg.toFixed(1), styles: { fontStyle: 'bold' } },\n        { content: totalOT > 0 ? totalOT.toFixed(1) : '-', styles: { fontStyle: 'bold' } }\n      ]],\n      margin: { left: margin, right: margin },\n      headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8, cellPadding: 3, fontStyle: 'bold' },\n      bodyStyles: { fontSize: 8, cellPadding: 3 },\n      footStyles: { fillColor: [248, 250, 252], textColor: [30, 41, 59], fontSize: 8, fontStyle: 'bold' },\n      alternateRowStyles: { fillColor: [248, 250, 252] },\n      theme: 'grid'\n    })\n\n    yPos = doc.lastAutoTable.finalY + 10\n  }\n\n  // ============================================\n  // MATERIALS / EQUIPMENT TABLE\n  // ============================================\n\n  if (ticket.t_and_m_items?.length > 0) {\n    if (yPos > pageHeight - 60) { doc.addPage(); yPos = margin }\n\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(71, 85, 105)\n    doc.text('MATERIALS / EQUIPMENT', margin, yPos)\n    yPos += 5\n\n    autoTable(doc, {\n      startY: yPos,\n      head: [['Item', 'Category', 'Qty', 'Unit']],\n      body: ticket.t_and_m_items.map(item => [\n        item.custom_name || item.materials_equipment?.name || item.description || 'Unnamed Item',\n        item.custom_category || item.materials_equipment?.category || '-',\n        item.quantity?.toString() || '1',\n        item.materials_equipment?.unit || item.unit || 'ea'\n      ]),\n      margin: { left: margin, right: margin },\n      headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontSize: 8, cellPadding: 3, fontStyle: 'bold' },\n      bodyStyles: { fontSize: 8, cellPadding: 3 },\n      alternateRowStyles: { fillColor: [248, 250, 252] },\n      theme: 'grid'\n    })\n\n    yPos = doc.lastAutoTable.finalY + 10\n  }\n\n  // ============================================\n  // PHOTO DOCUMENTATION\n  // ============================================\n\n  if (ticket.photos?.length > 0) {\n    if (yPos > pageHeight - 80) { doc.addPage(); yPos = margin }\n\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(71, 85, 105)\n    doc.text('PHOTO DOCUMENTATION', margin, yPos)\n    doc.setFontSize(8)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(59, 130, 246)\n    doc.text(`${ticket.photos.length} photo${ticket.photos.length !== 1 ? 's' : ''}`, margin + 55, yPos)\n    yPos += 8\n\n    const photoImages = await loadImagesAsBase64(ticket.photos)\n    const photoWidth = 55\n    const photoHeight = 45\n    const photoGap = 6\n    const photosPerRow = 3\n    let xPos = margin\n\n    for (let i = 0; i < ticket.photos.length; i++) {\n      if (i > 0 && i % photosPerRow === 0) {\n        xPos = margin\n        yPos += photoHeight + photoGap + 4\n      }\n      if (yPos + photoHeight > pageHeight - 20) {\n        doc.addPage()\n        yPos = margin\n        xPos = margin\n      }\n      const imgData = photoImages[i]\n      if (imgData) {\n        doc.setDrawColor(200, 200, 200)\n        doc.setLineWidth(0.5)\n        doc.rect(xPos - 1, yPos - 1, photoWidth + 2, photoHeight + 2, 'S')\n        doc.addImage(imgData, 'JPEG', xPos, yPos, photoWidth, photoHeight)\n      } else {\n        doc.setFillColor(245, 245, 245)\n        doc.rect(xPos, yPos, photoWidth, photoHeight, 'F')\n        doc.setDrawColor(200, 200, 200)\n        doc.rect(xPos, yPos, photoWidth, photoHeight, 'S')\n        doc.setFontSize(7)\n        doc.setTextColor(150, 150, 150)\n        doc.text('Photo unavailable', xPos + 8, yPos + photoHeight / 2)\n      }\n      xPos += photoWidth + photoGap\n    }\n\n    yPos += photoHeight + 12\n  }\n\n  // ============================================\n  // CLIENT VERIFICATION BLOCK\n  // ============================================\n\n  if (ticket.client_signature_data) {\n    if (yPos > pageHeight - 50) { doc.addPage(); yPos = margin }\n\n    const verifyBlockHeight = 34\n    const verifyBlockWidth = pageWidth - margin * 2\n\n    doc.setFillColor(240, 253, 244)\n    doc.roundedRect(margin, yPos, verifyBlockWidth, verifyBlockHeight, 3, 3, 'F')\n    doc.setFillColor(16, 185, 129)\n    doc.rect(margin, yPos, 4, verifyBlockHeight, 'F')\n    doc.setDrawColor(187, 247, 208)\n    doc.setLineWidth(0.5)\n    doc.line(margin + 4, yPos, margin + verifyBlockWidth, yPos)\n\n    const sealX = margin + 14\n    const sealY = yPos + verifyBlockHeight / 2\n    doc.setFillColor(16, 185, 129)\n    doc.circle(sealX, sealY, 6, 'F')\n    doc.setFontSize(9)\n    doc.setTextColor(255, 255, 255)\n    doc.text('', sealX - 2.5, sealY + 3)\n\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(16, 185, 129)\n    doc.text('CLIENT VERIFIED', margin + 26, yPos + 10)\n\n    try {\n      doc.addImage(ticket.client_signature_data, 'PNG', margin + 26, yPos + 13, 50, 16)\n      const infoX = margin + 85\n      doc.setFont('helvetica', 'bold')\n      doc.setFontSize(9)\n      doc.setTextColor(30, 41, 59)\n      doc.text(ticket.client_signature_name || 'Client', infoX, yPos + 12)\n      doc.setFont('helvetica', 'normal')\n      doc.setFontSize(8)\n      doc.setTextColor(71, 85, 105)\n      const titleCompany = [ticket.client_signature_title, ticket.client_signature_company].filter(Boolean).join(', ')\n      if (titleCompany) doc.text(titleCompany, infoX, yPos + 18)\n      if (ticket.client_signature_date) {\n        doc.setTextColor(100, 116, 139)\n        doc.text(`Verified: ${formatDate(ticket.client_signature_date)}`, infoX, yPos + 25)\n      }\n    } catch (e) {\n      doc.setFont('helvetica', 'normal')\n      doc.setFontSize(9)\n      doc.setTextColor(30, 41, 59)\n      doc.text(`Signed by: ${ticket.client_signature_name || 'Client'}`, margin + 26, yPos + 20)\n    }\n  }\n\n  // ============================================\n  // FOOTER (all pages)\n  // ============================================\n\n  const totalPages = doc.internal.getNumberOfPages()\n  for (let i = 1; i <= totalPages; i++) {\n    doc.setPage(i)\n    const footerY = pageHeight - 10\n    doc.setFontSize(8)\n    doc.setTextColor(150, 150, 150)\n    doc.text(`Generated on ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`, margin, footerY)\n    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, footerY, { align: 'right' })\n  }\n\n  const ticketDate = formatDate(ticket.work_date || ticket.ticket_date).replace(/\\//g, '-')\n  const fileName = `TM_Ticket_${ticketDate}${ticket.ce_pco_number ? '_' + ticket.ce_pco_number : ''}.pdf`\n  doc.save(fileName)\n\n  return { success: true, fileName, pageCount: totalPages }\n}\n\n// ============================================\n// EXPORTS\n// ============================================\n\nexport default {\n  generatePDFFromSnapshot,\n  generateTicketPDFFromData\n}\n","import { useState, useEffect, useMemo, useCallback } from 'react'\nimport { X, Edit3, Download, CheckCircle, XCircle, Clock, FileText, Users, Package, Truck, Briefcase, DollarSign, Percent, Shield, Building2, Stamp, PenTool, Link, Image, ChevronDown, ChevronRight, Calendar, Pencil, Check } from 'lucide-react'\nimport { db } from '../../lib/supabase'\nimport {\n  formatCurrency,\n  formatPercent,\n  centsToDollars,\n  calculateCORTotals,\n  getStatusInfo,\n  formatDate,\n  formatDateRange\n} from '../../lib/corCalculations'\nimport { executeExport, createSnapshot } from '../../lib/corExportPipeline'\nimport { generatePDFFromSnapshot } from '../../lib/corPdfGenerator'\nimport { exportCORDetail } from '../../lib/financialExport'\nimport SignatureCanvas from '../ui/SignatureCanvas'\nimport SignatureLinkGenerator from '../SignatureLinkGenerator'\n\nexport default function CORDetail({ cor, project, company, areas, onClose, onEdit, onShowToast, onStatusChange }) {\n  const [loading, setLoading] = useState(true)\n  const [corData, setCORData] = useState(cor)\n  const [showSignature, setShowSignature] = useState(false)\n  const [showSignatureLink, setShowSignatureLink] = useState(false)\n  const [expandedTickets, setExpandedTickets] = useState(new Set())\n  const [selectedPhoto, setSelectedPhoto] = useState(null)\n  const [editingNumber, setEditingNumber] = useState(false)\n  const [newCorNumber, setNewCorNumber] = useState('')\n\n  // Fetch full COR data with line items\n  const fetchFullCOR = useCallback(async () => {\n    try {\n      const fullCOR = await db.getCORById(cor.id)\n      if (fullCOR) {\n        // Resolve all ticket photos to signed URLs in one batch (bucket is private)\n        if (fullCOR.tickets?.length) {\n          const photoGroups = fullCOR.tickets.map(t => t.photos || [])\n          const allPhotos = photoGroups.flat()\n          if (allPhotos.length) {\n            const signed = await db.resolvePhotoUrls(allPhotos)\n            let offset = 0\n            fullCOR.tickets = fullCOR.tickets.map((t, i) => {\n              const len = photoGroups[i].length\n              const resolved = signed.slice(offset, offset + len)\n              offset += len\n              return { ...t, photos: resolved }\n            })\n          }\n        }\n        setCORData(fullCOR)\n      }\n    } catch (error) {\n      console.error('Error fetching COR details:', error)\n      onShowToast?.('Error loading COR details', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }, [cor.id]) // onShowToast is stable (memoized in App.jsx)\n\n  // Fetch on mount\n  useEffect(() => {\n    fetchFullCOR()\n  }, [fetchFullCOR])\n\n  // Subscribe to T&M ticket associations for real-time updates\n  // When tickets are added/removed from this COR, refresh the data\n  useEffect(() => {\n    const subscription = db.subscribeToCorTickets?.(cor.id, () => {\n      // Refetch COR data when ticket associations change\n      fetchFullCOR()\n    })\n\n    return () => {\n      if (subscription) {\n        db.unsubscribe?.(subscription)\n      }\n    }\n  }, [cor.id, fetchFullCOR])\n\n  // Calculate totals\n  const totals = useMemo(() => calculateCORTotals(corData), [corData])\n\n  const statusInfo = getStatusInfo(corData.status)\n  const canApprove = corData.status === 'pending_approval'\n  // Allow editing before billed (draft, pending_approval, approved)\n  const canEdit = ['draft', 'pending_approval', 'approved'].includes(corData.status)\n\n  const getAreaName = (areaId) => {\n    const area = areas?.find(a => a.id === areaId)\n    return area?.name || null\n  }\n\n  const handleApprove = async () => {\n    if (!confirm('Approve this change order request?')) return\n    setLoading(true)\n    try {\n      await db.approveCOR(corData.id)\n      setCORData({ ...corData, status: 'approved', approved_at: new Date().toISOString() })\n      onShowToast?.('COR approved', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error approving COR:', error)\n      onShowToast?.('Error approving COR', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleReject = async () => {\n    const reason = prompt('Enter rejection reason (optional):')\n    if (reason === null) return // User cancelled\n\n    setLoading(true)\n    try {\n      await db.rejectCOR(corData.id, reason)\n      setCORData({ ...corData, status: 'rejected', rejection_reason: reason })\n      onShowToast?.('COR rejected', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error rejecting COR:', error)\n      onShowToast?.('Error rejecting COR', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleMarkBilled = async () => {\n    if (!confirm('Mark this COR as billed?')) return\n    setLoading(true)\n    try {\n      await db.markCORAsBilled(corData.id)\n      setCORData({ ...corData, status: 'billed' })\n      onShowToast?.('COR marked as billed', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error marking COR as billed:', error)\n      onShowToast?.('Error updating status', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSaveSignature = async (signatureData) => {\n    setLoading(true)\n    try {\n      await db.saveCORSignature?.(corData.id, {\n        gc_signature: signatureData.signature,\n        gc_signer_name: signatureData.signerName,\n        signed_at: signatureData.signedAt\n      })\n      setCORData({\n        ...corData,\n        gc_signature: signatureData.signature,\n        gc_signer_name: signatureData.signerName,\n        signed_at: signatureData.signedAt\n      })\n      setShowSignature(false)\n      onShowToast?.('Signature saved', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error saving signature:', error)\n      onShowToast?.('Error saving signature', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const canSign = corData.status === 'approved' && !corData.gc_signature\n\n  const handleUpdateCorNumber = async () => {\n    if (!newCorNumber.trim()) {\n      setEditingNumber(false)\n      return\n    }\n    setLoading(true)\n    try {\n      await db.updateCOR(corData.id, { cor_number: newCorNumber.trim() })\n      setCORData({ ...corData, cor_number: newCorNumber.trim() })\n      setEditingNumber(false)\n      onShowToast?.('COR number updated', 'success')\n    } catch (error) {\n      console.error('Error updating COR number:', error)\n      onShowToast?.('Error updating COR number', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const startEditingNumber = () => {\n    setNewCorNumber(corData.cor_number || '')\n    setEditingNumber(true)\n  }\n\n  // Toggle ticket expansion in backup section\n  const toggleTicketExpanded = (ticketId) => {\n    setExpandedTickets(prev => {\n      const next = new Set(prev)\n      if (next.has(ticketId)) {\n        next.delete(ticketId)\n      } else {\n        next.add(ticketId)\n      }\n      return next\n    })\n  }\n\n  // Get associated tickets from the COR data\n  const associatedTickets = useMemo(() => {\n    return corData.change_order_ticket_associations?.map(assoc => assoc.t_and_m_tickets).filter(Boolean) || []\n  }, [corData.change_order_ticket_associations])\n\n  // Calculate total hours for a ticket\n  const getTicketHours = (ticket) => {\n    const workers = ticket.t_and_m_workers || []\n    const regular = workers.reduce((sum, w) => sum + (parseFloat(w.hours) || 0), 0)\n    const overtime = workers.reduce((sum, w) => sum + (parseFloat(w.overtime_hours) || 0), 0)\n    return { regular, overtime, total: regular + overtime }\n  }\n\n  const handleExportPDF = async () => {\n    const branding = {\n      logoUrl: company?.logo_url,\n      primaryColor: company?.branding_color\n    }\n\n    try {\n      onShowToast?.('Generating PDF...', 'info')\n\n      // Attempt the full idempotent pipeline first\n      const result = await executeExport(corData.id, {\n        cor: corData,\n        tickets: associatedTickets,\n        project,\n        company,\n        branding,\n        options: { includeBackup: true }\n      })\n\n      onShowToast?.(result.cached ? 'PDF downloaded (cached)' : 'PDF downloaded', 'success')\n    } catch (pipelineError) {\n      // Pipeline relies on database RPCs that may not be available in all environments.\n      // Fall back to direct client-side generation from a local snapshot.\n      console.warn('Export pipeline unavailable, using direct generation:', pipelineError?.message)\n      try {\n        const snapshot = createSnapshot(corData, associatedTickets)\n        await generatePDFFromSnapshot(snapshot, { project, company, branding })\n        onShowToast?.('PDF downloaded', 'success')\n      } catch (fallbackError) {\n        console.error('Error generating PDF:', fallbackError)\n        onShowToast?.('Error generating PDF', 'error')\n      }\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"modal-overlay\" onClick={onClose}>\n        <div className=\"modal-content cor-detail-modal\" onClick={e => e.stopPropagation()}>\n          <div className=\"cor-detail-loading\">Loading COR details...</div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"modal-overlay\" onClick={onClose} role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"cor-detail-title\">\n      <div className=\"modal-content cor-detail-modal\" onClick={e => e.stopPropagation()}>\n        <div className=\"modal-header cor-detail-header\">\n          <div className=\"cor-detail-title-row\">\n            <div>\n              <div className=\"cor-detail-number\">\n                {editingNumber ? (\n                  <div className=\"cor-number-edit\">\n                    <input\n                      type=\"text\"\n                      value={newCorNumber}\n                      onChange={(e) => setNewCorNumber(e.target.value)}\n                      onKeyDown={(e) => {\n                        if (e.key === 'Enter') handleUpdateCorNumber()\n                        if (e.key === 'Escape') setEditingNumber(false)\n                      }}\n                      autoFocus\n                      className=\"cor-number-input\"\n                    />\n                    <button className=\"btn-icon-sm\" onClick={handleUpdateCorNumber} title=\"Save\">\n                      <Check size={14} />\n                    </button>\n                    <button className=\"btn-icon-sm\" onClick={() => setEditingNumber(false)} title=\"Cancel\">\n                      <X size={14} />\n                    </button>\n                  </div>\n                ) : (\n                  <div className=\"cor-number-display\">\n                    <span>{corData.cor_number}</span>\n                    {canEdit && (\n                      <button className=\"btn-icon-sm\" onClick={startEditingNumber} title=\"Edit COR number\">\n                        <Pencil size={12} />\n                      </button>\n                    )}\n                  </div>\n                )}\n              </div>\n              <h2 id=\"cor-detail-title\">{corData.title || 'Untitled COR'}</h2>\n            </div>\n            <button className=\"close-btn\" onClick={onClose} aria-label=\"Close COR details\"><X size={20} aria-hidden=\"true\" /></button>\n          </div>\n\n          <div className=\"cor-detail-meta\">\n            <span\n              className=\"cor-detail-status\"\n              style={{ backgroundColor: statusInfo.bgColor, color: statusInfo.color }}\n            >\n              {statusInfo.label}\n            </span>\n            {corData.group_name && (\n              <span className=\"cor-detail-group\">{corData.group_name}</span>\n            )}\n            {getAreaName(corData.area_id) && (\n              <span className=\"cor-detail-area\">{getAreaName(corData.area_id)}</span>\n            )}\n            <span className=\"cor-detail-period\">\n              <Clock size={14} /> {formatDateRange(corData.period_start, corData.period_end)}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"modal-body cor-detail-body\">\n          {/* Scope of Work */}\n          <div className=\"cor-detail-section\">\n            <h3><FileText size={18} /> Scope of Work</h3>\n            <p className=\"cor-scope-text\">{corData.scope_of_work || 'No scope of work provided.'}</p>\n          </div>\n\n          {/* Pricing Breakdown */}\n          <div className=\"cor-detail-section pricing-breakdown\">\n            <h3><DollarSign size={18} /> Pricing Breakdown</h3>\n\n            {/* Labor Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Users size={16} />\n                  <span>Labor</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.labor_subtotal)}</span>\n              </div>\n\n              {corData.change_order_labor?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Class</th>\n                        <th>Type</th>\n                        <th>Reg Hrs</th>\n                        <th>Reg Rate</th>\n                        <th>OT Hrs</th>\n                        <th>OT Rate</th>\n                        <th className=\"text-right\">Total</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_labor.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.labor_class}</td>\n                          <td>{item.wage_type}</td>\n                          <td>{item.regular_hours}</td>\n                          <td>${centsToDollars(item.regular_rate)}/hr</td>\n                          <td>{item.overtime_hours || '-'}</td>\n                          <td>{item.overtime_hours ? `$${centsToDollars(item.overtime_rate)}/hr` : '-'}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No labor items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.labor_markup_percent || 1500)})</span>\n                <span>+{formatCurrency(totals.labor_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* Materials Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Package size={16} />\n                  <span>Materials</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.materials_subtotal)}</span>\n              </div>\n\n              {corData.change_order_materials?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Description</th>\n                        <th>Source</th>\n                        <th>Qty</th>\n                        <th>Unit</th>\n                        <th>Unit Cost</th>\n                        <th className=\"text-right\">Total</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_materials.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.description}</td>\n                          <td>{item.source_reference || item.source_type}</td>\n                          <td>{item.quantity}</td>\n                          <td>{item.unit}</td>\n                          <td>${centsToDollars(item.unit_cost)}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No material items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.materials_markup_percent || 1500)})</span>\n                <span>+{formatCurrency(totals.materials_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* Equipment Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Truck size={16} />\n                  <span>Equipment</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.equipment_subtotal)}</span>\n              </div>\n\n              {corData.change_order_equipment?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Description</th>\n                        <th>Source</th>\n                        <th>Qty</th>\n                        <th>Unit</th>\n                        <th>Unit Cost</th>\n                        <th className=\"text-right\">Total</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_equipment.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.description}</td>\n                          <td>{item.source_reference || item.source_type}</td>\n                          <td>{item.quantity}</td>\n                          <td>{item.unit}</td>\n                          <td>${centsToDollars(item.unit_cost)}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No equipment items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.equipment_markup_percent || 1500)})</span>\n                <span>+{formatCurrency(totals.equipment_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* Subcontractors Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Briefcase size={16} />\n                  <span>Subcontractors</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.subcontractors_subtotal)}</span>\n              </div>\n\n              {corData.change_order_subcontractors?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Company</th>\n                        <th>Description</th>\n                        <th>Source</th>\n                        <th className=\"text-right\">Amount</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_subcontractors.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.company_name}</td>\n                          <td>{item.description}</td>\n                          <td>{item.source_reference || item.source_type}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No subcontractor items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.subcontractors_markup_percent || 500)})</span>\n                <span>+{formatCurrency(totals.subcontractors_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* COR Subtotal */}\n            <div className=\"cor-subtotal-row\">\n              <span>COR Subtotal</span>\n              <span>{formatCurrency(totals.cor_subtotal)}</span>\n            </div>\n\n            {/* Additional Fees */}\n            <div className=\"pricing-category fees-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Percent size={16} />\n                  <span>Additional Fees</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.additional_fees_total)}</span>\n              </div>\n\n              <div className=\"fees-list\">\n                <div className=\"fee-row\">\n                  <div className=\"fee-label\">\n                    <Shield size={14} />\n                    <span>Liability Insurance ({formatPercent(corData.liability_insurance_percent || 144)})</span>\n                  </div>\n                  <span className=\"fee-amount\">{formatCurrency(totals.liability_insurance_amount)}</span>\n                </div>\n\n                <div className=\"fee-row\">\n                  <div className=\"fee-label\">\n                    <FileText size={14} />\n                    <span>Bond ({formatPercent(corData.bond_percent || 100)})</span>\n                  </div>\n                  <span className=\"fee-amount\">{formatCurrency(totals.bond_amount)}</span>\n                </div>\n\n                <div className=\"fee-row\">\n                  <div className=\"fee-label\">\n                    <Building2 size={14} />\n                    <span>City License Fee ({formatPercent(corData.license_fee_percent || 10)})</span>\n                  </div>\n                  <span className=\"fee-amount\">{formatCurrency(totals.license_fee_amount)}</span>\n                </div>\n              </div>\n            </div>\n\n            {/* COR Total */}\n            <div className=\"cor-total-row\">\n              <span>COR TOTAL</span>\n              <span>{formatCurrency(totals.cor_total)}</span>\n            </div>\n          </div>\n\n          {/* Backup Documentation Section */}\n          {associatedTickets.length > 0 && (\n            <div className=\"cor-detail-section backup-section\">\n              <h3><FileText size={18} /> Backup Documentation</h3>\n              <p className=\"backup-summary\">\n                {associatedTickets.length} T&M ticket{associatedTickets.length !== 1 ? 's' : ''} associated with this COR\n              </p>\n\n              <div className=\"backup-tickets-list\">\n                {associatedTickets.map(ticket => {\n                  const isExpanded = expandedTickets.has(ticket.id)\n                  const hours = getTicketHours(ticket)\n                  const workerCount = ticket.t_and_m_workers?.length || 0\n                  const itemCount = ticket.t_and_m_items?.length || 0\n                  const photoCount = ticket.photos?.length || 0\n\n                  return (\n                    <div key={ticket.id} className=\"backup-ticket-card\">\n                      <div\n                        className=\"backup-ticket-header\"\n                        onClick={() => toggleTicketExpanded(ticket.id)}\n                      >\n                        <div className=\"backup-ticket-toggle\">\n                          {isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}\n                        </div>\n                        <div className=\"backup-ticket-info\">\n                          <div className=\"backup-ticket-date\">\n                            <Calendar size={14} />\n                            <span>{formatDate(ticket.work_date)}</span>\n                          </div>\n                          {ticket.ce_pco_number && (\n                            <span className=\"backup-ticket-pco\">CE/PCO: {ticket.ce_pco_number}</span>\n                          )}\n                        </div>\n                        <div className=\"backup-ticket-stats\">\n                          <span className=\"backup-stat\">\n                            <Users size={14} /> {workerCount}\n                          </span>\n                          <span className=\"backup-stat\">\n                            {hours.total.toFixed(1)} hrs\n                          </span>\n                          {photoCount > 0 && (\n                            <span className=\"backup-stat\">\n                              <Image size={14} /> {photoCount}\n                            </span>\n                          )}\n                          {ticket.client_signature_data && (\n                            <span className=\"backup-stat verified\" title={`Verified by ${ticket.client_signature_name}`}>\n                              <PenTool size={14} /> Verified\n                            </span>\n                          )}\n                        </div>\n                        <span className={`backup-ticket-status status-${ticket.status}`}>\n                          {ticket.status}\n                        </span>\n                      </div>\n\n                      {isExpanded && (\n                        <div className=\"backup-ticket-details\">\n                          {/* Notes */}\n                          {ticket.notes && (\n                            <div className=\"backup-ticket-notes\">\n                              <strong>Notes:</strong> {ticket.notes}\n                            </div>\n                          )}\n\n                          {/* Workers Table */}\n                          {ticket.t_and_m_workers?.length > 0 && (\n                            <div className=\"backup-workers\">\n                              <h4>Labor ({workerCount} workers)</h4>\n                              <table className=\"backup-table\">\n                                <thead>\n                                  <tr>\n                                    <th>Name</th>\n                                    <th>Role</th>\n                                    <th>Time</th>\n                                    <th>Reg Hrs</th>\n                                    <th>OT Hrs</th>\n                                  </tr>\n                                </thead>\n                                <tbody>\n                                  {ticket.t_and_m_workers.map((worker, idx) => (\n                                    <tr key={idx}>\n                                      <td>{worker.name}</td>\n                                      <td>{worker.role || '-'}</td>\n                                      <td className=\"backup-time-range\">\n                                        {worker.time_started && worker.time_ended\n                                          ? `${worker.time_started} - ${worker.time_ended}`\n                                          : '-'}\n                                      </td>\n                                      <td>{worker.hours || 0}</td>\n                                      <td>{worker.overtime_hours || '-'}</td>\n                                    </tr>\n                                  ))}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n\n                          {/* Materials/Equipment Table */}\n                          {ticket.t_and_m_items?.length > 0 && (\n                            <div className=\"backup-items\">\n                              <h4>Materials & Equipment ({itemCount} items)</h4>\n                              <table className=\"backup-table\">\n                                <thead>\n                                  <tr>\n                                    <th>Item</th>\n                                    <th>Category</th>\n                                    <th>Qty</th>\n                                  </tr>\n                                </thead>\n                                <tbody>\n                                  {ticket.t_and_m_items.map((item, idx) => (\n                                    <tr key={idx}>\n                                      <td>{item.custom_name || item.materials_equipment?.name || 'Unnamed Item'}</td>\n                                      <td>{item.custom_category || item.materials_equipment?.category || '-'}</td>\n                                      <td>{item.quantity}</td>\n                                    </tr>\n                                  ))}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n\n                          {/* Photos Gallery */}\n                          {ticket.photos?.length > 0 && (\n                            <div className=\"backup-photos\">\n                              <h4>Photos ({photoCount})</h4>\n                              <div className=\"backup-photos-grid\">\n                                {ticket.photos.map((photoUrl, idx) => (\n                                  <div\n                                    key={idx}\n                                    className=\"backup-photo-thumb\"\n                                    onClick={() => setSelectedPhoto(photoUrl)}\n                                  >\n                                    <img src={photoUrl} alt={`Photo ${idx + 1}`} />\n                                  </div>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Client Verification Signature */}\n                          {ticket.client_signature_data && (\n                            <div className=\"backup-verification\">\n                              <h4><PenTool size={14} /> Client Verification</h4>\n                              <div className=\"backup-signature-display\">\n                                <img\n                                  src={ticket.client_signature_data}\n                                  alt=\"Client Signature\"\n                                  className=\"backup-signature-image\"\n                                />\n                                <div className=\"backup-signature-info\">\n                                  <span className=\"backup-signer-name\">{ticket.client_signature_name}</span>\n                                  {ticket.client_signature_title && (\n                                    <span className=\"backup-signer-title\">{ticket.client_signature_title}</span>\n                                  )}\n                                  {ticket.client_signature_company && (\n                                    <span className=\"backup-signer-company\">{ticket.client_signature_company}</span>\n                                  )}\n                                  <span className=\"backup-signed-date\">\n                                    Verified: {formatDate(ticket.client_signature_date)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                  )\n                })}\n              </div>\n            </div>\n          )}\n\n          {/* Signature Section */}\n          {(corData.gc_signature_data || corData.gc_signature || corData.client_signature_data) && (\n            <div className=\"cor-detail-section signature-section\">\n              <h3><Stamp size={18} /> Signatures</h3>\n              <div className=\"dual-signatures\">\n                {/* GC Signature */}\n                {(corData.gc_signature_data || corData.gc_signature) && (\n                  <div className=\"signature-block\">\n                    <span className=\"signature-label\">GC Authorization</span>\n                    <div className=\"signature-display\">\n                      <img\n                        src={corData.gc_signature_data || corData.gc_signature}\n                        alt=\"GC Signature\"\n                        className=\"signature-image\"\n                      />\n                      <div className=\"signature-info\">\n                        <span className=\"signer-name\">{corData.gc_signature_name || corData.gc_signer_name}</span>\n                        {(corData.gc_signature_title || corData.gc_signature_company) && (\n                          <span className=\"signer-org\">\n                            {corData.gc_signature_title}\n                            {corData.gc_signature_title && corData.gc_signature_company && ' - '}\n                            {corData.gc_signature_company}\n                          </span>\n                        )}\n                        <span className=\"signed-date\">\n                          Signed: {formatDate(corData.gc_signature_date || corData.signed_at)}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Client Signature */}\n                {corData.client_signature_data && (\n                  <div className=\"signature-block\">\n                    <span className=\"signature-label\">Client Authorization</span>\n                    <div className=\"signature-display\">\n                      <img\n                        src={corData.client_signature_data}\n                        alt=\"Client Signature\"\n                        className=\"signature-image\"\n                      />\n                      <div className=\"signature-info\">\n                        <span className=\"signer-name\">{corData.client_signature_name}</span>\n                        {(corData.client_signature_title || corData.client_signature_company) && (\n                          <span className=\"signer-org\">\n                            {corData.client_signature_title}\n                            {corData.client_signature_title && corData.client_signature_company && ' - '}\n                            {corData.client_signature_company}\n                          </span>\n                        )}\n                        <span className=\"signed-date\">\n                          Signed: {formatDate(corData.client_signature_date)}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Rejection Reason (if rejected) */}\n          {corData.status === 'rejected' && corData.rejection_reason && (\n            <div className=\"cor-detail-section rejection-section\">\n              <h3><XCircle size={18} /> Rejection Reason</h3>\n              <p className=\"rejection-text\">{corData.rejection_reason}</p>\n            </div>\n          )}\n        </div>\n\n        {/* Footer Actions */}\n        <div className=\"modal-footer cor-detail-footer\">\n          <div className=\"footer-info\">\n            <span>Created: {formatDate(corData.created_at)}</span>\n            {corData.approved_at && <span>Approved: {formatDate(corData.approved_at)}</span>}\n          </div>\n\n          <div className=\"footer-actions\" role=\"group\" aria-label=\"COR actions\">\n            {canEdit && (\n              <button className=\"btn btn-secondary\" onClick={() => onEdit?.(corData)} disabled={loading} aria-label=\"Edit this COR\">\n                <Edit3 size={16} aria-hidden=\"true\" /> Edit\n              </button>\n            )}\n\n            {canApprove && (\n              <>\n                <button className=\"btn btn-danger\" onClick={handleReject} disabled={loading} aria-label=\"Reject this COR\">\n                  <XCircle size={16} aria-hidden=\"true\" /> Reject\n                </button>\n                <button className=\"btn btn-success\" onClick={handleApprove} disabled={loading} aria-label=\"Approve this COR\">\n                  <CheckCircle size={16} aria-hidden=\"true\" /> Approve\n                </button>\n              </>\n            )}\n\n            {canSign && (\n              <button className=\"btn btn-success\" onClick={() => setShowSignature(true)} disabled={loading} aria-label=\"Get GC signature for this COR\">\n                <PenTool size={16} aria-hidden=\"true\" /> Get GC Signature\n              </button>\n            )}\n\n            {/* Show signature link button for approved/pending CORs */}\n            {(corData.status === 'approved' || corData.status === 'pending_approval') && (\n              <button\n                className=\"btn btn-secondary\"\n                onClick={() => setShowSignatureLink(true)}\n                disabled={loading}\n                aria-label=\"Get shareable signature link\"\n              >\n                <Link size={16} aria-hidden=\"true\" /> Get Signature Link\n              </button>\n            )}\n\n            {corData.status === 'approved' && (\n              <button className=\"btn btn-primary\" onClick={handleMarkBilled} disabled={loading} aria-label=\"Mark this COR as billed\">\n                <DollarSign size={16} aria-hidden=\"true\" /> Mark Billed\n              </button>\n            )}\n\n            <button className=\"btn btn-ghost btn-small\" onClick={() => exportCORDetail(corData, project)} aria-label=\"Export COR to CSV\">\n              <Download size={16} aria-hidden=\"true\" /> Export CSV\n            </button>\n            <button className=\"btn btn-secondary\" onClick={handleExportPDF} aria-label=\"Export COR to PDF\">\n              <Download size={16} aria-hidden=\"true\" /> Export PDF\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Signature Capture Modal */}\n      {showSignature && (\n        <SignatureCanvas\n          onSave={handleSaveSignature}\n          onClose={() => setShowSignature(false)}\n          signerName=\"\"\n        />\n      )}\n\n      {/* Signature Link Generator Modal */}\n      {showSignatureLink && (\n        <SignatureLinkGenerator\n          documentType=\"cor\"\n          documentId={corData.id}\n          companyId={company?.id}\n          projectId={project?.id}\n          project={project}\n          documentTitle={`COR ${corData.cor_number}: ${corData.title || 'Untitled'}`}\n          onClose={() => setShowSignatureLink(false)}\n          onShowToast={onShowToast}\n        />\n      )}\n\n      {/* Photo Lightbox Modal */}\n      {selectedPhoto && (\n        <div className=\"photo-lightbox\" onClick={() => setSelectedPhoto(null)}>\n          <button className=\"lightbox-close\" onClick={() => setSelectedPhoto(null)}>\n            <X size={24} />\n          </button>\n          <img src={selectedPhoto} alt=\"Full size photo\" onClick={e => e.stopPropagation()} />\n        </div>\n      )}\n    </div>\n  )\n}\n"],"file":"CORDetail-BwpOnrmM.js"}