import{aW as z,aK as h,as as s}from"./index-CYFHKlyp.js";import{r as l,k as v,q as K,aS as T,aU as X,e as Y,at as D,X as B,aA as G,aw as J,P as Q,ak as V}from"./icons-BcDcd3_y.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";const N=[{value:"high",label:"High",color:"#ef4444"},{value:"medium",label:"Medium",color:"#f59e0b"},{value:"low",label:"Low",color:"#6b7280"}],b=[{value:"open",label:"Open",icon:X,color:"#ef4444"},{value:"in_progress",label:"In Progress",icon:Y,color:"#f59e0b"},{value:"complete",label:"Complete",icon:v,color:"#10b981"}];function ne({projectId:o,areas:m=[],companyId:k,onShowToast:d}){const[c,y]=l.useState([]),[I,C]=l.useState(!0),[O,_]=l.useState(!1),[g,S]=l.useState(null),[x,q]=l.useState("all"),[f,F]=l.useState("all"),[P,w]=l.useState(!1),[a,u]=l.useState({description:"",area_id:"",assigned_to:"",priority:"medium",notes:"",photo_url:""}),p=l.useCallback(async()=>{if(!o||!z){C(!1);return}try{const{data:e,error:t}=await h.from("punch_list_items").select("*").eq("project_id",o).order("created_at",{ascending:!1});if(t)throw t;y(e||[])}catch(e){console.error("Error loading punch list:",e),y([])}finally{C(!1)}},[o]);l.useEffect(()=>{p()},[p]),l.useEffect(()=>{if(!o||!z)return;const e=h.channel(`punch_list:${o}`).on("postgres_changes",{event:"*",schema:"public",table:"punch_list_items",filter:`project_id=eq.${o}`},()=>p()).subscribe();return()=>{h.removeChannel(e)}},[o,p]);const E=l.useMemo(()=>c.filter(e=>!(x!=="all"&&e.status!==x||f!=="all"&&e.area_id!==f)),[c,x,f]),r=l.useMemo(()=>{const e=c.filter(i=>i.status==="open").length,t=c.filter(i=>i.status==="in_progress").length,n=c.filter(i=>i.status==="complete").length;return{open:e,inProgress:t,complete:n,total:c.length}},[c]),j=()=>{u({description:"",area_id:"",assigned_to:"",priority:"medium",notes:"",photo_url:""}),S(null),_(!1)},L=async e=>{if(e.preventDefault(),!a.description.trim()){d?.("Please enter a description","error");return}w(!0);try{if(g){const{error:t}=await h.from("punch_list_items").update({description:a.description.trim(),area_id:a.area_id||null,assigned_to:a.assigned_to.trim()||null,priority:a.priority,notes:a.notes.trim()||null,photo_url:a.photo_url||null,updated_at:new Date().toISOString()}).eq("id",g.id);if(t)throw t;d?.("Punch item updated","success")}else{const{error:t}=await h.from("punch_list_items").insert({project_id:o,company_id:k,description:a.description.trim(),area_id:a.area_id||null,assigned_to:a.assigned_to.trim()||null,priority:a.priority,notes:a.notes.trim()||null,photo_url:a.photo_url||null,status:"open"});if(t)throw t;d?.("Punch item added","success")}j(),p()}catch(t){console.error("Error saving punch item:",t),d?.(t.message||"Error saving item","error")}finally{w(!1)}},$=async(e,t)=>{try{const n={status:t,updated_at:new Date().toISOString()};t==="complete"?n.completed_at=new Date().toISOString():n.completed_at=null;const{error:i}=await h.from("punch_list_items").update(n).eq("id",e);if(i)throw i;p()}catch(n){console.error("Error updating status:",n),d?.("Error updating status","error")}},M=async e=>{if(confirm("Delete this punch item?"))try{const{error:t}=await h.from("punch_list_items").delete().eq("id",e);if(t)throw t;d?.("Item deleted","success"),p()}catch(t){console.error("Error deleting item:",t),d?.("Error deleting item","error")}},U=e=>{u({description:e.description,area_id:e.area_id||"",assigned_to:e.assigned_to||"",priority:e.priority||"medium",notes:e.notes||"",photo_url:e.photo_url||""}),S(e),_(!0)},A=e=>e&&m.find(n=>n.id===e)?.name||null,R=e=>N.find(t=>t.value===e)||N[1],W=e=>b.find(t=>t.value===e)||b[0];return s.jsxs("div",{className:"punch-list-card",children:[s.jsxs("div",{className:"punch-list-header",children:[s.jsxs("div",{className:"punch-list-title",children:[s.jsx(v,{size:18}),s.jsx("h3",{children:"Punch List"}),r.total>0&&s.jsxs("span",{className:"punch-stats-inline",children:[s.jsxs("span",{className:"punch-stat-open",children:[r.open," open"]}),r.inProgress>0&&s.jsxs("span",{className:"punch-stat-progress",children:[r.inProgress," in progress"]}),s.jsxs("span",{className:"punch-stat-complete",children:[r.complete,"/",r.total," complete"]})]})]}),s.jsxs("button",{className:"punch-add-btn",onClick:()=>{j(),_(!0)},children:[s.jsx(K,{size:16}),"Add Item"]})]}),r.total>0&&s.jsxs("div",{className:"punch-progress-bar",children:[s.jsx("div",{className:"punch-progress-fill",style:{width:`${r.complete/r.total*100}%`}}),s.jsxs("span",{className:"punch-progress-label",children:[Math.round(r.complete/r.total*100),"% complete"]})]}),r.total>0&&s.jsxs("div",{className:"punch-filters",children:[s.jsxs("div",{className:"punch-filter-group",children:[s.jsx(T,{size:14}),s.jsxs("select",{value:x,onChange:e=>q(e.target.value),className:"punch-filter-select",children:[s.jsx("option",{value:"all",children:"All Status"}),b.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))]})]}),m.length>0&&s.jsxs("div",{className:"punch-filter-group",children:[s.jsx(D,{size:14}),s.jsxs("select",{value:f,onChange:e=>F(e.target.value),className:"punch-filter-select",children:[s.jsx("option",{value:"all",children:"All Areas"}),m.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]})]}),O&&s.jsxs("form",{className:"punch-form",onSubmit:L,children:[s.jsxs("div",{className:"punch-form-header",children:[s.jsx("h4",{children:g?"Edit Item":"New Punch Item"}),s.jsx("button",{type:"button",className:"punch-form-close",onClick:j,children:s.jsx(B,{size:16})})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Description *"}),s.jsx("textarea",{value:a.description,onChange:e=>u(t=>({...t,description:e.target.value})),placeholder:"What needs to be fixed or completed?",rows:2,required:!0})]}),s.jsxs("div",{className:"punch-form-row",children:[s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Area"}),s.jsxs("select",{value:a.area_id,onChange:e=>u(t=>({...t,area_id:e.target.value})),children:[s.jsx("option",{value:"",children:"No area"}),m.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Assigned To"}),s.jsx("input",{type:"text",value:a.assigned_to,onChange:e=>u(t=>({...t,assigned_to:e.target.value})),placeholder:"Name or company"})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Priority"}),s.jsx("select",{value:a.priority,onChange:e=>u(t=>({...t,priority:e.target.value})),children:N.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Notes"}),s.jsx("textarea",{value:a.notes,onChange:e=>u(t=>({...t,notes:e.target.value})),placeholder:"Additional details...",rows:2})]}),s.jsxs("div",{className:"punch-form-actions",children:[s.jsx("button",{type:"button",className:"punch-btn-cancel",onClick:j,children:"Cancel"}),s.jsxs("button",{type:"submit",className:"punch-btn-save",disabled:P,children:[s.jsx(G,{size:14}),P?"Saving...":g?"Update":"Add Item"]})]})]}),I?s.jsx("div",{className:"punch-loading",children:"Loading punch list..."}):E.length===0?s.jsxs("div",{className:"punch-empty",children:[s.jsx(v,{size:32,style:{opacity:.3}}),s.jsx("p",{children:c.length===0?"No punch items yet":"No items match filters"}),c.length===0&&s.jsx("span",{children:"Add items that need attention before project closeout"})]}):s.jsx("div",{className:"punch-items-list",children:E.map(e=>{const t=W(e.status),n=R(e.priority),i=t.icon;return s.jsxs("div",{className:`punch-item punch-item-${e.status}`,children:[s.jsx("button",{className:"punch-item-status-btn",onClick:()=>{const H=e.status==="open"?"in_progress":e.status==="in_progress"?"complete":"open";$(e.id,H)},title:`Click to change status (current: ${t.label})`,children:s.jsx(i,{size:18,style:{color:t.color}})}),s.jsxs("div",{className:"punch-item-content",children:[s.jsxs("div",{className:"punch-item-top",children:[s.jsx("span",{className:`punch-item-desc ${e.status==="complete"?"completed":""}`,children:e.description}),s.jsx("div",{className:"punch-item-badges",children:s.jsx("span",{className:"punch-priority-badge",style:{color:n.color,borderColor:`${n.color}40`},children:n.label})})]}),s.jsxs("div",{className:"punch-item-meta",children:[A(e.area_id)&&s.jsxs("span",{className:"punch-meta-tag",children:[s.jsx(D,{size:11}),A(e.area_id)]}),e.assigned_to&&s.jsxs("span",{className:"punch-meta-tag",children:[s.jsx(J,{size:11}),e.assigned_to]}),e.completed_at&&s.jsxs("span",{className:"punch-meta-tag completed",children:[s.jsx(v,{size:11}),"Done ",new Date(e.completed_at).toLocaleDateString()]})]}),e.notes&&s.jsx("div",{className:"punch-item-notes",children:e.notes})]}),s.jsxs("div",{className:"punch-item-actions",children:[s.jsx("button",{className:"punch-action-btn",onClick:()=>U(e),title:"Edit",children:s.jsx(Q,{size:14})}),s.jsx("button",{className:"punch-action-btn delete",onClick:()=>M(e.id),title:"Delete",children:s.jsx(V,{size:14})})]})]},e.id)})})]})}export{ne as default};
//# sourceMappingURL=PunchList-2eabhQYn.js.map
