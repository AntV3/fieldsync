import{_ as se}from"./pdf-ChZ1zkDw.js";import{j as e,d as k,u as tt,k as Pe,l as st}from"./index-C5BCm2vy.js";import{r as d,q as we,L as We,d as at,X as ve,P as Ge,w as ce,R as lt,F as Ee,c as $e,j as ye,v as Ve,s as Ue,al as nt,i as ot,am as rt,D as ct,ad as it,aj as dt,an as ut,n as Oe,ao as mt,y as ht,x as Ie}from"./icons-_xHNNQgF.js";import{f as v,g as gt,a as pt,b as xt}from"./corCalculations-D9qkkIbo.js";import{an as bt,aj as Ct}from"./Dashboard-CgnlZ40x.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const jt=[{value:"draft",label:"Draft"},{value:"pending_approval",label:"Pending Approval"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"billed",label:"Billed"},{value:"closed",label:"Closed"}];function vt({entry:a,isEditing:r,isSaving:S,onEdit:f,onSave:C,onCancel:$,statusDisplay:W}){const[z,N]=d.useState({dateSentToClient:a.dateSentToClient||"",ceNumber:a.ceNumber||"",comments:a.comments||"",status:a.changeOrder?.status||"draft"}),L=d.useRef(null);d.useEffect(()=>{r&&L.current&&L.current.focus()},[r]),d.useEffect(()=>{N({dateSentToClient:a.dateSentToClient||"",ceNumber:a.ceNumber||"",comments:a.comments||"",status:a.changeOrder?.status||"draft"})},[a]);const y=m=>{m.key==="Enter"&&!m.shiftKey?(m.preventDefault(),V()):m.key==="Escape"&&F()},V=()=>{C(z)},F=()=>{N({dateSentToClient:a.dateSentToClient||"",ceNumber:a.ceNumber||"",comments:a.comments||"",status:a.changeOrder?.status||"draft"}),$()},u=W[a.changeOrder.status]||{label:a.changeOrder.status,className:""},G=m=>{if(!m)return"-";try{return new Date(m).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch{return m}},U=m=>{if(!m)return"";try{return new Date(m).toISOString().split("T")[0]}catch{return m}};return r?e.jsxs("tr",{className:"cor-log-row editing",children:[e.jsx("td",{className:"col-log-num",children:a.logNumber}),e.jsx("td",{className:"col-date-sent",children:e.jsx("input",{ref:L,type:"date",value:U(z.dateSentToClient),onChange:m=>N(l=>({...l,dateSentToClient:m.target.value})),onKeyDown:y,disabled:S,className:"cor-log-input"})}),e.jsx("td",{className:"col-ce-num",children:e.jsx("input",{type:"text",value:z.ceNumber,onChange:m=>N(l=>({...l,ceNumber:m.target.value})),onKeyDown:y,disabled:S,placeholder:"CE-XXX",className:"cor-log-input",maxLength:50})}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:a.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:a.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:v(a.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status",children:e.jsxs("div",{className:"cor-log-status-select",children:[e.jsx("select",{value:z.status,onChange:m=>N(l=>({...l,status:m.target.value})),disabled:S,className:"cor-log-select",children:jt.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))}),e.jsx(we,{size:14,className:"select-icon"})]})}),e.jsx("td",{className:"col-comments",children:e.jsx("textarea",{value:z.comments,onChange:m=>N(l=>({...l,comments:m.target.value})),onKeyDown:y,disabled:S,placeholder:"Add comments...",className:"cor-log-textarea",rows:2})}),e.jsx("td",{className:"col-actions",children:S?e.jsx(We,{size:16,className:"spin"}):e.jsxs("div",{className:"cor-log-edit-actions",children:[e.jsx("button",{className:"btn btn-icon btn-success",onClick:V,title:"Save",children:e.jsx(at,{size:14})}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:F,title:"Cancel",children:e.jsx(ve,{size:14})})]})})]}):e.jsxs("tr",{className:"cor-log-row",children:[e.jsx("td",{className:"col-log-num",children:a.logNumber}),e.jsx("td",{className:"col-date-sent editable",onClick:f,children:G(a.dateSentToClient)}),e.jsx("td",{className:"col-ce-num editable",onClick:f,children:a.ceNumber||"-"}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:a.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:a.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:v(a.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status editable",onClick:f,children:e.jsx("span",{className:`cor-log-status ${u.className}`,children:u.label})}),e.jsx("td",{className:"col-comments editable",onClick:f,children:a.comments||e.jsx("span",{className:"placeholder",children:"Click to add..."})}),e.jsx("td",{className:"col-actions",children:e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:f,title:"Edit",children:e.jsx(Ge,{size:14})})})]})}const De={draft:{label:"Draft",className:"draft"},pending_approval:{label:"Pending",className:"pending"},approved:{label:"Approved",className:"approved"},rejected:{label:"Rejected",className:"rejected"},billed:{label:"Billed",className:"billed"},closed:{label:"Closed",className:"closed"}},Re={pending:["draft","pending_approval"],approved:["approved","billed"],void:["rejected","closed"]};function ft({project:a,company:r,onShowToast:S}){const[f,C]=d.useState([]),[$,W]=d.useState(!0),[z,N]=d.useState(null),[L,y]=d.useState(null),[V,F]=d.useState(!1);d.useEffect(()=>{u();const h=k.subscribeToCORLog?.(a.id,()=>{u()});return()=>{h&&k.unsubscribe?.(h)}},[a.id]);const u=async()=>{try{const h=await k.getCORLog(a.id);C(h||[])}catch(h){console.error("Error loading COR log:",h),S?.("Error loading COR log","error")}finally{W(!1),F(!1)}},G=()=>{F(!0),u()},U=async(h,_,n)=>{y(h);try{await k.updateCORLogEntry(h,_),_.status&&await k.updateChangeOrderStatus(n,_.status),C(g=>g.map(j=>j.id===h?{...j,dateSentToClient:_.dateSentToClient,ceNumber:_.ceNumber,comments:_.comments,changeOrder:{...j.changeOrder,status:_.status||j.changeOrder.status}}:j)),N(null),S?.("Log entry updated","success")}catch(g){console.error("Error updating log entry:",g),S?.("Error updating log entry","error")}finally{y(null)}},m=d.useMemo(()=>{const h=f.filter(g=>Re.pending.includes(g.changeOrder.status)),_=f.filter(g=>Re.approved.includes(g.changeOrder.status)),n=f.filter(g=>Re.void.includes(g.changeOrder.status));return{pending:h,approved:_,voided:n}},[f]),l=d.useMemo(()=>{const{pending:h,approved:_,voided:n}=m;return{totalCORs:f.length,approvedCount:_.length,pendingCount:h.length,voidCount:n.length,approvedTotal:_.reduce((g,j)=>g+(j.changeOrder.corTotal||0),0),pendingTotal:h.reduce((g,j)=>g+(j.changeOrder.corTotal||0),0),voidTotal:n.reduce((g,j)=>g+(j.changeOrder.corTotal||0),0),grandTotal:f.reduce((g,j)=>g+(j.changeOrder.corTotal||0),0)}},[f,m]),ie=async()=>{try{const{default:h}=await se(async()=>{const{default:p}=await import("./pdf-ChZ1zkDw.js").then(w=>w.j);return{default:p}},[]),{default:_}=await se(async()=>{const{default:p}=await import("./pdf-ChZ1zkDw.js").then(w=>w.c);return{default:p}},[]),n=new h("landscape"),g=n.internal.pageSize.width;n.setFontSize(18),n.setFont(void 0,"bold"),n.text("CHANGE ORDER LOG",g/2,20,{align:"center"}),n.setFontSize(12),n.setFont(void 0,"normal"),n.text(`Project: ${a.name}`,g/2,28,{align:"center"}),a.job_number&&n.text(`Job #${a.job_number}`,g/2,35,{align:"center"}),n.setFontSize(10),n.text(`Generated: ${new Date().toLocaleDateString()}`,g/2,42,{align:"center"}),r?.name&&(n.setFontSize(11),n.setFont(void 0,"bold"),n.text(r.name,14,20),n.setFont(void 0,"normal"),r.phone&&(n.setFontSize(9),n.text(r.phone,14,25)));const j=f.map(p=>[p.logNumber,p.changeOrder.corNumber||"-",p.dateSentToClient?new Date(p.dateSentToClient).toLocaleDateString():"-",p.ceNumber||"-",p.changeOrder.title||"Untitled",v(p.changeOrder.corTotal||0),De[p.changeOrder.status]?.label||p.changeOrder.status,p.comments||"-"]);_(n,{startY:50,head:[["Log #","COR #","Date Sent","CE #","Description","Amount","Status","Comments"]],body:j,styles:{fontSize:8,cellPadding:3,overflow:"linebreak",valign:"top"},headStyles:{fillColor:[51,51,51],textColor:255,fontStyle:"bold",fontSize:8},columnStyles:{0:{cellWidth:12,halign:"center"},1:{cellWidth:18},2:{cellWidth:22},3:{cellWidth:18},4:{cellWidth:55},5:{cellWidth:22,halign:"right"},6:{cellWidth:18,halign:"center"},7:{cellWidth:"auto",minCellWidth:50}},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:p=>{if(p.column.index===6&&p.section==="body"){const w=p.cell.raw?.toLowerCase();w==="approved"||w==="billed"?p.cell.styles.textColor=[5,150,105]:w==="pending"||w==="pending approval"?p.cell.styles.textColor=[217,119,6]:(w==="rejected"||w==="void")&&(p.cell.styles.textColor=[220,38,38])}}});const A=(n.lastAutoTable?.finalY||100)+10;n.setFontSize(10),n.setFont(void 0,"bold"),n.text("SUMMARY",14,A),n.setFont(void 0,"normal"),n.setFontSize(9);const P=14,b=100;n.text(`Total CORs: ${l.totalCORs}`,P,A+7),n.text(`Approved: ${l.approvedCount} (${v(l.approvedTotal)})`,P,A+14),n.text(`Pending: ${l.pendingCount} (${v(l.pendingTotal)})`,b,A+7),n.text(`Void: ${l.voidCount} (${v(l.voidTotal)})`,b,A+14),n.setFont(void 0,"bold"),n.setFontSize(10),n.text(`Total Value: ${v(l.grandTotal)}`,P,A+24);const K=`COR_Log_${a.job_number||a.name.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`;n.save(K),S?.("PDF exported successfully","success")}catch(h){console.error("Error exporting PDF:",h),S?.("Error exporting PDF","error")}},H=async()=>{try{const h=await se(()=>import("./xlsx-BvJTHLik.js"),[]),_=f.map(b=>({"Log #":b.logNumber,"COR Number":b.changeOrder.corNumber,"Date Sent to Client":b.dateSentToClient||"","CE Number":b.ceNumber||"",Description:b.changeOrder.title||"Untitled",Amount:b.changeOrder.corTotal||0,Status:De[b.changeOrder.status]?.label||b.changeOrder.status,"Created Date":b.changeOrder.createdAt?new Date(b.changeOrder.createdAt).toLocaleDateString():"","Approved Date":b.changeOrder.approvedAt?new Date(b.changeOrder.approvedAt).toLocaleDateString():"","Approved By":b.changeOrder.approvedBy||"",Comments:b.comments||""}));_.push({}),_.push({"Log #":"SUMMARY",Description:`Total CORs: ${l.totalCORs}`,Amount:l.grandTotal,Status:`Approved: ${l.approvedCount}, Pending: ${l.pendingCount}`});const n=h.utils.json_to_sheet(_),g=h.utils.book_new();h.utils.book_append_sheet(g,n,"COR Log");const j=5,A=h.utils.decode_range(n["!ref"]);for(let b=A.s.r+1;b<=A.e.r;b++){const K=h.utils.encode_cell({r:b,c:j});n[K]&&typeof n[K].v=="number"&&(n[K].z="$#,##0.00")}n["!cols"]=[{wch:8},{wch:12},{wch:15},{wch:12},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:20},{wch:30}];const P=`COR_Log_${a.job_number||a.name}_${new Date().toISOString().split("T")[0]}.xlsx`;h.writeFile(g,P),S?.("Excel exported successfully","success")}catch(h){console.error("Error exporting Excel:",h),S?.("Error exporting Excel","error")}};if($)return e.jsxs("div",{className:"cor-log cor-log-loading",children:[e.jsx(We,{size:24,className:"spin"}),e.jsx("span",{children:"Loading COR Log..."})]});const de=(h,_=!0)=>e.jsxs("table",{className:"cor-log-table",children:[_&&e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-log-num",children:"Log #"}),e.jsx("th",{className:"col-date-sent",children:"Date Sent"}),e.jsx("th",{className:"col-ce-num",children:"CE #"}),e.jsx("th",{className:"col-description",children:"Description"}),e.jsx("th",{className:"col-amount",children:"Amount"}),e.jsx("th",{className:"col-status",children:"Status"}),e.jsx("th",{className:"col-comments",children:"Comments"}),e.jsx("th",{className:"col-actions",children:"Actions"})]})}),e.jsx("tbody",{children:h.map(n=>e.jsx(vt,{entry:n,isEditing:z===n.id,isSaving:L===n.id,onEdit:()=>N(n.id),onSave:g=>U(n.id,g,n.changeOrder.id),onCancel:()=>N(null),statusDisplay:De},n.id))})]});return e.jsxs("div",{className:"cor-log cor-log-expanded",children:[e.jsxs("div",{className:"cor-log-header",children:[e.jsxs("div",{className:"cor-log-title",children:[e.jsx(ce,{size:20}),e.jsx("h3",{children:"Change Order Log"}),e.jsxs("span",{className:"cor-log-count",children:[f.length," entries"]})]}),e.jsxs("div",{className:"cor-log-actions",children:[e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:G,disabled:V,title:"Refresh",children:e.jsx(lt,{size:16,className:V?"spin":""})}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:H,children:[e.jsx(ce,{size:14})," Excel"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:ie,children:[e.jsx(Ee,{size:14})," PDF"]})]})]}),e.jsxs("div",{className:"cor-log-summary-cards",children:[e.jsxs("div",{className:"summary-card pending",children:[e.jsx($e,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Pending"}),e.jsxs("span",{className:"summary-card-count",children:[l.pendingCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:v(l.pendingTotal)})]})]}),e.jsxs("div",{className:"summary-card approved",children:[e.jsx(ye,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Approved"}),e.jsxs("span",{className:"summary-card-count",children:[l.approvedCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:v(l.approvedTotal)})]})]}),e.jsxs("div",{className:"summary-card void",children:[e.jsx(Ve,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Void"}),e.jsxs("span",{className:"summary-card-count",children:[l.voidCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:v(l.voidTotal)})]})]}),e.jsxs("div",{className:"summary-card total",children:[e.jsx(ce,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Total"}),e.jsxs("span",{className:"summary-card-count",children:[l.totalCORs," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:v(l.grandTotal)})]})]})]}),f.length===0?e.jsxs("div",{className:"cor-log-empty",children:[e.jsx(ce,{size:32}),e.jsx("p",{children:"No change orders in log"}),e.jsx("span",{children:"CORs will appear here as they are created"})]}):e.jsxs("div",{className:"cor-log-sections",children:[m.pending.length>0&&e.jsxs("div",{className:"cor-log-section pending",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx($e,{size:16}),e.jsx("h4",{children:"Pending Change Orders"}),e.jsx("span",{className:"section-count",children:m.pending.length}),e.jsx("span",{className:"section-total",children:v(l.pendingTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:de(m.pending)})]}),m.approved.length>0&&e.jsxs("div",{className:"cor-log-section approved",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(ye,{size:16}),e.jsx("h4",{children:"Approved Change Orders"}),e.jsx("span",{className:"section-count",children:m.approved.length}),e.jsx("span",{className:"section-total",children:v(l.approvedTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:de(m.approved)})]}),m.voided.length>0&&e.jsxs("div",{className:"cor-log-section void",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(Ve,{size:16}),e.jsx("h4",{children:"Void Change Orders"}),e.jsx("span",{className:"section-count",children:m.voided.length}),e.jsx("span",{className:"section-total",children:v(l.voidTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:de(m.voided)})]})]})]})}const Nt=d.memo(function({cor:r,isSelected:S,selectMode:f,areas:C,onToggleSelect:$,onView:W,onEdit:z,onDelete:N,onSubmitForApproval:L}){const y=gt(r.status),V=["draft","pending_approval","approved"].includes(r.status),F=["draft","pending_approval","rejected"].includes(r.status),u=r.status==="draft",G=l=>C?.find(H=>H.id===l)?.name||"No Area",U=()=>{f?$(r.id):W?.(r)},m=l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),U())};return e.jsxs("div",{className:`cor-card hover-lift animate-fade-in-up ${r.status} ${S?"selected":""}`,onClick:U,onKeyDown:m,tabIndex:0,role:"button","aria-label":`${f?S?"Deselect":"Select":"View"} COR ${r.cor_number}: ${r.title||"Untitled"}, ${y.label}, ${v(r.cor_total||0)}`,children:[e.jsxs("div",{className:"cor-card-header",children:[e.jsxs("div",{className:"cor-card-left",children:[f&&e.jsx("button",{className:"cor-select-checkbox",onClick:l=>{l.stopPropagation(),$(r.id,l)},"aria-label":S?"Deselect":"Select",children:S?e.jsx(Ue,{size:18}):e.jsx(nt,{size:18})}),e.jsx("span",{className:"cor-number",children:r.cor_number}),e.jsx("span",{className:"cor-status-badge",style:{backgroundColor:y.bgColor,color:y.color},children:y.label}),(r.gc_signature_data||r.client_signature_data)&&e.jsxs("span",{className:"cor-signed-badge",title:`Signed by ${r.gc_signature_name||r.client_signature_name||"Client"}`,children:[e.jsx(ye,{size:12})," Signed"]})]}),e.jsx("div",{className:"cor-card-right",children:e.jsx("span",{className:"cor-total",children:v(r.cor_total||0)})})]}),e.jsxs("div",{className:"cor-card-body",children:[e.jsx("h4",{className:"cor-title",children:r.title||"Untitled COR"}),e.jsxs("div",{className:"cor-meta",children:[r.group_name&&e.jsx("span",{className:"cor-group-badge",children:r.group_name}),r.area_id&&e.jsx("span",{className:"cor-area",children:G(r.area_id)}),e.jsx("span",{className:"cor-period",children:pt(r.period_start,r.period_end)})]})]}),e.jsxs("div",{className:"cor-card-footer",children:[e.jsx("span",{className:"cor-created",children:xt(r.created_at)}),e.jsxs("div",{className:"cor-actions",onClick:l=>l.stopPropagation(),children:[u&&e.jsx("button",{className:"cor-action-btn submit",onClick:l=>L(r.id,l),title:"Submit for Approval","aria-label":`Submit COR ${r.cor_number} for approval`,children:e.jsx(ot,{size:14,"aria-hidden":"true"})}),V&&e.jsx("button",{className:"cor-action-btn edit",onClick:l=>{l.stopPropagation(),z?.(r)},title:"Edit","aria-label":`Edit COR ${r.cor_number}`,children:e.jsx(Ge,{size:14,"aria-hidden":"true"})}),e.jsx("button",{className:"cor-action-btn view",onClick:l=>{l.stopPropagation(),W?.(r)},title:"View Details","aria-label":`View COR ${r.cor_number} details`,children:e.jsx(rt,{size:14,"aria-hidden":"true"})}),F&&e.jsx("button",{className:"cor-action-btn delete",onClick:l=>N(r.id,l),title:"Delete","aria-label":`Delete COR ${r.cor_number}`,children:e.jsx(ct,{size:14,"aria-hidden":"true"})})]})]})]})}),re={draft:{label:"Draft",color:[107,114,128],bgColor:[243,244,246]},pending_approval:{label:"Pending Approval",color:[217,119,6],bgColor:[254,243,199]},approved:{label:"Approved",color:[5,150,105],bgColor:[209,250,229]},rejected:{label:"Rejected",color:[220,38,38],bgColor:[254,226,226]},billed:{label:"Billed",color:[37,99,235],bgColor:[219,234,254]},closed:{label:"Closed",color:[75,85,99],bgColor:[229,231,235]}};function yt({project:a,company:r,areas:S,refreshKey:f,onShowToast:C,onCreateCOR:$,onViewCOR:W,onEditCOR:z,previewMode:N=!1,previewLimit:L=5,onViewAll:y,onDisplayModeChange:V}){const{branding:F}=tt(),[u,G]=d.useState([]),[U,m]=d.useState(!0),[l,ie]=d.useState("all"),[H,de]=d.useState("all"),[h,_]=d.useState("all"),[n,g]=d.useState(null),[j,A]=d.useState(new Set),[P,b]=d.useState(!1),[K,p]=d.useState(!1),[w,fe]=d.useState(""),[ue,me]=d.useState(!1),Ne=d.useRef(null);d.useEffect(()=>{const t=o=>{Ne.current&&!Ne.current.contains(o.target)&&me(!1)};return ue&&document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[ue]);const[ae,Me]=d.useState("list"),he=t=>{Me(t),V?.(t)},[M,Ae]=d.useState(N?"all":"recent"),[_e,Fe]=d.useState(new Set),[I,ge]=d.useState({start:"",end:""}),[Te,Be]=d.useState(null),Z=d.useCallback(async()=>{try{const t=await k.getCORs(a.id);G(t||[])}catch(t){console.error("Error loading CORs:",t),C?.("Error loading change order requests","error")}finally{m(!1)}},[a.id]),q=d.useCallback(async()=>{try{const t=await k.getCORStats?.(a.id);Be(t)}catch(t){console.error("Error loading COR stats:",t)}},[a.id]);d.useEffect(()=>{Z(),q();const t=k.subscribeToCORs?.(a.id,()=>{Z(),q()});return()=>{t&&k.unsubscribe?.(t)}},[a.id,f,Z,q]);const Xe=async()=>{if(u.length===0){C?.("No CORs to export","error");return}C?.("Generating Excel report...","info");try{const t=await se(()=>import("./xlsx-BvJTHLik.js"),[]),o=u.filter(i=>i.status==="approved"),s=u.filter(i=>["draft","pending_approval"].includes(i.status)),x=u.filter(i=>i.status==="rejected"),te=u.filter(i=>i.status==="billed"),O=u.reduce((i,D)=>i+(D.cor_total||0),0)/100,T=o.reduce((i,D)=>i+(D.cor_total||0),0)/100,ne=s.reduce((i,D)=>i+(D.cor_total||0),0)/100,B=t.utils.book_new(),E=[["CHANGE ORDER REQUEST SUMMARY"],[],["Company:",r?.name||""],["Project:",a.name],["Job Number:",a.job_number||"N/A"],["Report Date:",new Date().toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})],[],["FINANCIAL OVERVIEW"],[],["Category","Count","Value"],["Total CORs",u.length,O],["Approved",o.length,T],["Pending Approval",s.length,ne],["Rejected",x.length,x.reduce((i,D)=>i+(D.cor_total||0),0)/100],["Billed",te.length,te.reduce((i,D)=>i+(D.cor_total||0),0)/100],[],["CONTRACT IMPACT"],[],["Original Contract Value:",a.contract_value||0],["Total Approved CORs:",T],["Revised Contract Value:",(a.contract_value||0)+T],["Pending COR Value:",ne],["Potential Total:",(a.contract_value||0)+T+ne]],oe=t.utils.aoa_to_sheet(E);oe["!cols"]=[{wch:25},{wch:15},{wch:18}],t.utils.book_append_sheet(B,oe,"Summary");const be=["COR #","Title","Description","Amount","Status","Created Date","Submitted Date","Approved Date","Approved By","Work Period Start","Work Period End","Area"],Ce=u.map(i=>[i.cor_number||"",i.title||"Untitled",i.scope_of_work||"",(i.cor_total||0)/100,re[i.status]?.label||i.status,i.created_at?new Date(i.created_at).toLocaleDateString():"",i.submitted_at?new Date(i.submitted_at).toLocaleDateString():"",i.approved_at?new Date(i.approved_at).toLocaleDateString():"",i.approved_by_name||"",i.period_start?new Date(i.period_start).toLocaleDateString():"",i.period_end?new Date(i.period_end).toLocaleDateString():"",i.area?.name||""]),X=t.utils.aoa_to_sheet([be,...Ce]);X["!cols"]=[{wch:10},{wch:30},{wch:40},{wch:14},{wch:16},{wch:12},{wch:12},{wch:12},{wch:18},{wch:12},{wch:12},{wch:15}];for(let i=1;i<=Ce.length;i++){const D=t.utils.encode_cell({r:i,c:3});X[D]&&(X[D].z="$#,##0.00")}t.utils.book_append_sheet(B,X,"COR Details"),[{name:"Approved CORs",data:o,status:"approved"},{name:"Pending CORs",data:s,status:"pending"}].forEach(({name:i,data:D})=>{if(D.length>0){const Q=[["COR #","Title","Amount","Date"],...D.map(c=>[c.cor_number||"",c.title||"Untitled",(c.cor_total||0)/100,c.created_at?new Date(c.created_at).toLocaleDateString():""]),[],["TOTAL","",D.reduce((c,R)=>c+(R.cor_total||0),0)/100,""]],je=t.utils.aoa_to_sheet(Q);je["!cols"]=[{wch:12},{wch:40},{wch:14},{wch:12}],t.utils.book_append_sheet(B,je,i)}});const J=`COR_Report_${a.job_number||a.name}_${new Date().toISOString().split("T")[0]}.xlsx`;t.writeFile(B,J),C?.("Excel report exported successfully","success")}catch(t){console.error("Export error:",t),C?.("Export failed","error")}},Ye=async()=>{if(u.length===0){C?.("No CORs to export","error");return}C?.("Generating PDF report...","info");try{const{default:t}=await se(async()=>{const{default:c}=await import("./pdf-ChZ1zkDw.js").then(R=>R.j);return{default:c}},[]),{default:o}=await se(async()=>{const{default:c}=await import("./pdf-ChZ1zkDw.js").then(R=>R.c);return{default:c}},[]),s=new t("landscape"),x=s.internal.pageSize.width,te=s.internal.pageSize.height,O=15,T=Pe(F?.primary_color||"#3B82F6"),ne=Pe(F?.secondary_color||"#1E40AF");s.setFillColor(...T),s.rect(0,0,x,40,"F"),s.setFillColor(...ne),s.rect(0,38,x,3,"F");let B=O;if(F?.logo_url)try{const c=await st(F.logo_url);c&&(s.addImage(c,"PNG",O,6,28,28),B=O+35)}catch(c){console.error("Logo load error:",c)}s.setTextColor(255,255,255),s.setFontSize(20),s.setFont("helvetica","bold"),s.text(r?.name||"Company",B,18),s.setFontSize(11),s.setFont("helvetica","normal"),s.text("CHANGE ORDER REQUEST REPORT",B,28),s.setFontSize(9),s.text(new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}),x-O,15,{align:"right"}),a.job_number&&s.text(`Job #: ${a.job_number}`,x-O,23,{align:"right"}),s.text(`${u.length} Change Orders`,x-O,31,{align:"right"});let E=50;s.setFillColor(248,250,252),s.setDrawColor(...T),s.setLineWidth(.5),s.roundedRect(O,E,x-O*2,25,3,3,"FD"),s.setTextColor(...T),s.setFontSize(14),s.setFont("helvetica","bold"),s.text(a.name,O+8,E+10),s.setTextColor(100,116,139),s.setFontSize(9),s.setFont("helvetica","normal"),a.address&&s.text(a.address,O+8,E+18),E+=35;const oe=u.filter(c=>c.status==="approved"),be=u.filter(c=>["draft","pending_approval"].includes(c.status)),Ce=u.reduce((c,R)=>c+(R.cor_total||0),0),X=oe.reduce((c,R)=>c+(R.cor_total||0),0),Le=be.reduce((c,R)=>c+(R.cor_total||0),0),J=(x-O*2-30)/4;[{label:"Total CORs",value:u.length.toString(),subValue:v(Ce)},{label:"Approved",value:oe.length.toString(),subValue:v(X),color:[5,150,105]},{label:"Pending",value:be.length.toString(),subValue:v(Le),color:[217,119,6]},{label:"Revised Contract",value:v((a.contract_value||0)*100+X),subValue:`+${v(X)} from original`,color:T}].forEach((c,R)=>{const Y=O+R*(J+10),Se=c.color||T,Ze=Se.map(et=>Math.min(255,et+200));s.setFillColor(...Ze),s.setDrawColor(...Se),s.roundedRect(Y,E,J,32,2,2,"FD"),s.setTextColor(...Se),s.setFontSize(18),s.setFont("helvetica","bold"),s.text(c.value,Y+J/2,E+14,{align:"center"}),s.setTextColor(100,116,139),s.setFontSize(8),s.setFont("helvetica","normal"),s.text(c.label,Y+J/2,E+22,{align:"center"}),c.subValue&&(s.setFontSize(7),s.text(c.subValue,Y+J/2,E+28,{align:"center"}))}),E+=42,s.setTextColor(...T),s.setFontSize(11),s.setFont("helvetica","bold"),s.text("CHANGE ORDER DETAILS",O,E),E+=5;const D=u.map((c,R)=>{const Y=re[c.status]||{label:c.status,color:[107,114,128]};return[(R+1).toString(),c.cor_number||"-",c.title||"Untitled",v(c.cor_total||0),Y.label,c.created_at?new Date(c.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"2-digit"}):"-"]});o(s,{startY:E,head:[["#","COR #","Description","Amount","Status","Date"]],body:D,theme:"grid",styles:{fontSize:9,cellPadding:4,lineColor:[226,232,240],lineWidth:.1},headStyles:{fillColor:T,textColor:[255,255,255],fontStyle:"bold",halign:"center"},columnStyles:{0:{cellWidth:12,halign:"center"},1:{cellWidth:25,halign:"center"},2:{cellWidth:"auto"},3:{cellWidth:30,halign:"right",fontStyle:"bold"},4:{cellWidth:28,halign:"center"},5:{cellWidth:28,halign:"center"}},alternateRowStyles:{fillColor:[248,250,252]},didParseCell:c=>{if(c.column.index===4&&c.section==="body"){const R=Object.keys(re).find(Y=>re[Y].label===c.cell.raw);R&&(c.cell.styles.textColor=re[R].color,c.cell.styles.fontStyle="bold")}}});const Q=te-12;s.setDrawColor(226,232,240),s.setLineWidth(.5),s.line(O,Q-5,x-O,Q-5),s.setTextColor(148,163,184),s.setFontSize(8),s.setFont("helvetica","normal"),s.text(`Generated on ${new Date().toLocaleString()}`,O,Q),s.text(`${r?.name||"FieldSync"} â€¢ Confidential`,x/2,Q,{align:"center"}),s.text("Page 1 of 1",x-O,Q,{align:"right"});const je=`COR_Report_${a.job_number||a.name}_${new Date().toISOString().split("T")[0]}.pdf`;s.save(je),C?.("PDF report exported successfully","success")}catch(t){console.error("Export error:",t),C?.("Export failed","error")}},He=d.useCallback(async(t,o)=>{if(o?.stopPropagation(),!!confirm("Are you sure you want to delete this COR? This action cannot be undone."))try{await k.deleteCOR(t),G(s=>s.filter(x=>x.id!==t)),C?.("COR deleted","success"),q()}catch(s){console.error("Error deleting COR:",s),C?.("Error deleting COR","error")}},[q]),Ke=d.useCallback(async(t,o)=>{o?.stopPropagation();try{await k.submitCORForApproval(t),await Z(),C?.("COR submitted for approval","success"),q()}catch(s){console.error("Error submitting COR:",s?.message||s),C?.(s?.message||"Error submitting COR","error")}},[Z,q]),qe=d.useCallback((t,o)=>{o?.stopPropagation(),A(s=>{const x=new Set(s);return x.has(t)?x.delete(t):x.add(t),x})},[]),Je=()=>{b(!1),A(new Set)},ke=async()=>{if(!w.trim()){C?.("Please enter a group name","error");return}try{await k.bulkUpdateCORGroup([...j],w.trim()),C?.(`${j.size} CORs grouped as "${w.trim()}"`,"success"),p(!1),fe(""),A(new Set),b(!1),Z()}catch(t){console.error("Error grouping CORs:",t),C?.("Error grouping CORs","error")}},pe=d.useMemo(()=>{const t=u.map(o=>o.group_name).filter(Boolean);return[...new Set(t)].sort()},[u]),xe=d.useMemo(()=>{let t=[...u];if(l!=="all"&&(t=t.filter(o=>o.status===l)),H!=="all"&&(t=t.filter(o=>o.area_id===H)),h!=="all"&&(t=t.filter(o=>o.group_name===h)),I.start){const o=new Date(I.start);o.setHours(0,0,0,0),t=t.filter(s=>new Date(s.created_at)>=o)}if(I.end){const o=new Date(I.end);o.setHours(23,59,59,999),t=t.filter(s=>new Date(s.created_at)<=o)}if(M==="recent"&&!N){const o=new Date;o.setDate(o.getDate()-7),o.setHours(0,0,0,0),t=t.filter(s=>new Date(s.created_at)>=o)}return t.sort((o,s)=>new Date(s.created_at)-new Date(o.created_at)),N&&(t=t.slice(0,L)),t},[u,l,H,h,M,I,N,L]),ee=d.useMemo(()=>{if(M!=="all")return null;const t={};return xe.forEach(o=>{const s=new Date(o.created_at),x=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,te=s.toLocaleDateString("en-US",{month:"long",year:"numeric"});t[x]||(t[x]={label:te,cors:[],totalAmount:0}),t[x].cors.push(o),t[x].totalAmount+=o.cor_total||0}),Object.entries(t).sort((o,s)=>s[0].localeCompare(o[0]))},[xe,M]);d.useEffect(()=>{if(ee&&ee.length>0){const t=ee[0][0];Fe(new Set([t]))}},[ee]);const Qe=t=>{const o=new Set(_e);o.has(t)?o.delete(t):o.add(t),Fe(o)},le=d.useMemo(()=>({all:u.length,draft:u.filter(t=>t.status==="draft").length,pending_approval:u.filter(t=>t.status==="pending_approval").length,approved:u.filter(t=>t.status==="approved").length,rejected:u.filter(t=>t.status==="rejected").length,billed:u.filter(t=>t.status==="billed").length,closed:u.filter(t=>t.status==="closed").length}),[u]);l==="all"?u.length:u.filter(t=>t.status===l).length;const ze=t=>e.jsx(Nt,{cor:t,isSelected:j.has(t.id),selectMode:P,areas:S,onToggleSelect:qe,onView:W,onEdit:z,onDelete:He,onSubmitForApproval:Ke},t.id);return U?e.jsx("div",{className:"cor-list",children:e.jsx("div",{className:"cor-loading-skeletons",children:[1,2,3].map(t=>e.jsx(bt,{},t))})}):e.jsxs("div",{className:`cor-list ${N?"cor-list-preview":""}`,children:[e.jsxs("div",{className:"cor-list-header",children:[e.jsxs("div",{className:"cor-list-info",children:[e.jsx("h3",{children:"Change Orders"}),e.jsxs("div",{className:"cor-stats-inline",children:[e.jsxs("span",{className:"cor-stat-item",children:[le.all," total"]}),le.pending_approval>0&&e.jsxs("span",{className:"cor-stat-item pending",children:[le.pending_approval," pending"]}),Te?.totalApproved>0&&e.jsx("span",{className:"cor-stat-item approved",children:v(Te.totalApproved)})]})]}),e.jsxs("div",{className:"cor-header-actions",children:[e.jsxs("div",{className:"cor-export-dropdown",ref:Ne,children:[e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:()=>me(!ue),disabled:u.length===0,children:[e.jsx(it,{size:14})," Export ",e.jsx(we,{size:12})]}),ue&&e.jsxs("div",{className:"cor-export-menu",children:[e.jsxs("button",{onClick:()=>{Ye(),me(!1)},children:[e.jsx(Ee,{size:14})," Export as PDF"]}),e.jsxs("button",{onClick:()=>{Xe(),me(!1)},children:[e.jsx(ce,{size:14})," Export as Excel"]})]})]}),e.jsxs("div",{className:"cor-display-toggle",children:[e.jsxs("button",{className:`cor-display-btn ${ae==="list"?"active":""}`,onClick:()=>he("list"),title:"List View",children:[e.jsx(dt,{size:14}),e.jsx("span",{children:"List"})]}),e.jsxs("button",{className:`cor-display-btn log-btn ${ae==="log"?"active":""}`,onClick:()=>he("log"),title:"COR Log - Edit & Export for Clients",children:[e.jsx(ut,{size:14}),e.jsx("span",{children:"COR Log"})]})]}),N?e.jsx(e.Fragment,{children:e.jsxs("button",{className:"btn btn-primary btn-small",onClick:$,children:[e.jsx(Oe,{size:14})," New COR"]})}):e.jsxs(e.Fragment,{children:[ae==="list"&&e.jsx("button",{className:`btn btn-secondary btn-small ${P?"active":""}`,onClick:()=>P?Je():b(!0),children:P?e.jsxs(e.Fragment,{children:[e.jsx(ve,{size:14})," Cancel"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{size:14})," Select"]})}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:$,children:[e.jsx(Oe,{size:14})," New COR"]})]})]})]}),ae==="log"&&e.jsx("div",{className:"cor-log-modal-overlay",onClick:()=>he("list"),children:e.jsxs("div",{className:"cor-log-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"cor-log-modal-header",children:[e.jsx("h2",{children:"Change Order Log"}),e.jsx("button",{className:"cor-log-modal-close",onClick:()=>he("list"),title:"Close",children:e.jsx(ve,{size:24})})]}),e.jsx("div",{className:"cor-log-modal-content",children:e.jsx(ft,{project:a,company:r,onShowToast:C})})]})}),ae==="list"&&e.jsxs(e.Fragment,{children:[P&&j.size>0&&e.jsxs("div",{className:"cor-selection-bar",children:[e.jsxs("span",{className:"selection-count",children:[j.size," selected"]}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:()=>p(!0),children:[e.jsx(mt,{size:14})," Group Selected"]})]}),!N&&e.jsxs("div",{className:"cor-controls",children:[e.jsx("div",{className:"cor-filter-pills",role:"tablist",children:[{id:"all",label:"All"},{id:"draft",label:"Draft"},{id:"pending_approval",label:"Pending"},{id:"approved",label:"Approved"}].map(t=>e.jsxs("button",{role:"tab","aria-selected":l===t.id,className:`cor-pill ${l===t.id?"active":""}`,onClick:()=>ie(t.id),children:[t.label,le[t.id]>0&&e.jsx("span",{className:"cor-pill-count",children:le[t.id]})]},t.id))}),pe.length>0&&e.jsxs("select",{className:"cor-group-filter",value:h,onChange:t=>_(t.target.value),children:[e.jsx("option",{value:"all",children:"All Groups"}),pe.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("div",{className:"cor-view-toggle",children:[e.jsx("button",{className:`cor-toggle-btn ${M==="recent"?"active":""}`,onClick:()=>{Ae("recent"),ge({start:"",end:""})},children:"Recent"}),e.jsx("button",{className:`cor-toggle-btn ${M==="all"?"active":""}`,onClick:()=>Ae("all"),children:"All"})]})]}),M==="all"&&!N&&e.jsxs("div",{className:"cor-date-filter",children:[e.jsx(ht,{size:14}),e.jsx("input",{type:"date",value:I.start,onChange:t=>ge(o=>({...o,start:t.target.value}))}),e.jsx("span",{className:"cor-date-sep",children:"to"}),e.jsx("input",{type:"date",value:I.end,onChange:t=>ge(o=>({...o,end:t.target.value}))}),(I.start||I.end)&&e.jsx("button",{className:"cor-clear-btn",onClick:()=>ge({start:"",end:""}),children:"Clear"})]}),xe.length===0?e.jsxs("div",{className:"cor-empty",children:[e.jsx(Ee,{size:24,className:"cor-empty-icon"}),e.jsxs("p",{children:["No change orders ",l!=="all"?`(${l.replace("_"," ")})`:""]}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:$,children:[e.jsx(Oe,{size:14})," Create COR"]})]}):e.jsx("div",{className:"cor-cards stagger-children",children:M==="all"&&ee?ee.map(([t,o])=>e.jsxs("div",{className:"cor-month-group animate-fade-in",children:[e.jsxs("button",{className:"cor-month-header",onClick:()=>Qe(t),children:[e.jsxs("div",{className:"cor-month-left",children:[_e.has(t)?e.jsx(we,{size:16}):e.jsx(Ie,{size:16}),e.jsx("span",{children:o.label}),e.jsx(Ct,{count:o.cors.length,size:"small"})]}),e.jsx("span",{className:"cor-month-total",children:v(o.totalAmount)})]}),_e.has(t)&&e.jsx("div",{className:"cor-month-items stagger-children",children:o.cors.map(s=>ze(s))})]},t)):xe.map(t=>ze(t))}),N&&u.length>L&&e.jsxs("button",{className:"cor-see-all-btn",onClick:y,children:["See all ",u.length," change orders",e.jsx(Ie,{size:16})]})]}),K&&e.jsx("div",{className:"modal-overlay",onClick:()=>p(!1),children:e.jsxs("div",{className:"modal-content cor-group-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h3",{children:["Group ",j.size," CORs"]}),e.jsx("button",{className:"close-btn",onClick:()=>p(!1),children:e.jsx(ve,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Group Name"}),e.jsx("input",{type:"text",value:w,onChange:t=>fe(t.target.value),placeholder:"e.g., Phase 1, Building A, Week 1",autoFocus:!0,onKeyDown:t=>{t.key==="Enter"&&ke(),t.key==="Escape"&&p(!1)}})]}),pe.length>0&&e.jsxs("div",{className:"existing-groups",children:[e.jsx("label",{children:"Or select existing group:"}),e.jsx("div",{className:"group-chips",children:pe.map(t=>e.jsx("button",{className:"group-chip",onClick:()=>fe(t),children:t},t))})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>p(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:ke,children:"Group CORs"})]})]})})]})}export{yt as default};
//# sourceMappingURL=CORList-DqtHUhFQ.js.map
