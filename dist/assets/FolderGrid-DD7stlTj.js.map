{"version":3,"file":"FolderGrid-DD7stlTj.js","sources":["../../src/components/documents/FolderGrid.jsx"],"sourcesContent":["import { useState, useEffect, useRef, useCallback } from 'react'\nimport { Folder, FileText, Map, Shield, FileSignature, Camera, ClipboardList, AlertTriangle, HelpCircle, Send, Download, ArrowLeft, Loader2, File, Image, FileSpreadsheet, ChevronRight } from 'lucide-react'\nimport { db } from '../../lib/supabase'\n\n// Icon mapping\nconst FOLDER_ICONS = {\n  folder: Folder,\n  plans: Map,\n  specs: FileText,\n  permits: Shield,\n  contracts: FileSignature,\n  submittals: Send,\n  rfis: HelpCircle,\n  photos: Camera,\n  reports: ClipboardList,\n  safety: AlertTriangle\n}\n\n// Color mapping\nconst FOLDER_COLORS = {\n  blue: '#3b82f6',\n  green: '#10b981',\n  yellow: '#f59e0b',\n  red: '#ef4444',\n  purple: '#8b5cf6',\n  pink: '#ec4899',\n  gray: '#6b7280',\n  orange: '#f97316'\n}\n\n// Get file icon\nconst getFileIcon = (mimeType) => {\n  if (mimeType?.startsWith('image/')) return Image\n  if (mimeType?.includes('spreadsheet') || mimeType?.includes('excel')) return FileSpreadsheet\n  if (mimeType?.includes('pdf')) return FileText\n  return File\n}\n\n// Format file size\nconst formatFileSize = (bytes) => {\n  if (!bytes) return '0 B'\n  const units = ['B', 'KB', 'MB', 'GB']\n  let size = bytes\n  let unitIndex = 0\n  while (size >= 1024 && unitIndex < units.length - 1) {\n    size /= 1024\n    unitIndex++\n  }\n  return `${size.toFixed(size < 10 ? 1 : 0)} ${units[unitIndex]}`\n}\n\nexport default function FolderGrid({ projectId, onShowToast }) {\n  const [folders, setFolders] = useState([])\n  const [loading, setLoading] = useState(true)\n  const [selectedFolder, setSelectedFolder] = useState(null)\n  const [documents, setDocuments] = useState([])\n  const [loadingDocs, setLoadingDocs] = useState(false)\n\n  // Use ref to track selected folder for real-time updates\n  const selectedFolderRef = useRef(null)\n\n  const loadFolders = useCallback(async () => {\n    setLoading(true)\n    try {\n      const folderList = await db.getProjectFolders(projectId)\n      setFolders(folderList)\n    } catch (error) {\n      console.error('Error loading folders:', error)\n      onShowToast?.('Failed to load folders', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }, [projectId, onShowToast])\n\n  const loadDocuments = useCallback(async (folderId) => {\n    if (!folderId) return\n    setLoadingDocs(true)\n    try {\n      const result = await db.getFolderDocuments(folderId)\n      setDocuments(result.documents)\n    } catch (error) {\n      console.error('Error loading documents:', error)\n      onShowToast?.('Failed to load documents', 'error')\n    } finally {\n      setLoadingDocs(false)\n    }\n  }, [onShowToast])\n\n  useEffect(() => {\n    loadFolders()\n\n    // Subscribe to real-time document and folder changes\n    const folderSub = db.subscribeToDocumentFolders?.(projectId, () => {\n      loadFolders()\n    })\n    const docSub = db.subscribeToDocuments?.(projectId, () => {\n      // Refresh folder counts when documents change\n      loadFolders()\n      // If a folder is open, refresh its documents\n      if (selectedFolderRef.current) {\n        loadDocuments(selectedFolderRef.current.id)\n      }\n    })\n\n    return () => {\n      folderSub?.unsubscribe?.()\n      docSub?.unsubscribe?.()\n    }\n  }, [projectId, loadFolders, loadDocuments])\n\n  const openFolder = async (folder) => {\n    setSelectedFolder(folder)\n    selectedFolderRef.current = folder\n    await loadDocuments(folder.id)\n  }\n\n  const handleDownload = async (doc) => {\n    try {\n      await db.logDocumentAccess(doc.id, 'downloaded')\n      const url = doc.url || `${import.meta.env.VITE_SUPABASE_URL}/storage/v1/object/public/project-documents/${doc.storage_path}`\n      window.open(url, '_blank')\n    } catch (error) {\n      console.error('Download error:', error)\n    }\n  }\n\n  const goBack = () => {\n    setSelectedFolder(null)\n    selectedFolderRef.current = null\n    setDocuments([])\n  }\n\n  // Loading\n  if (loading) {\n    return (\n      <div className=\"field-docs\">\n        <div className=\"field-docs-loading\">\n          <Loader2 size={24} className=\"spinner\" />\n          <span>Loading...</span>\n        </div>\n      </div>\n    )\n  }\n\n  // Document list view\n  if (selectedFolder) {\n    const FolderIcon = FOLDER_ICONS[selectedFolder.icon] || Folder\n    const folderColor = FOLDER_COLORS[selectedFolder.color] || FOLDER_COLORS.blue\n\n    return (\n      <div className=\"field-docs\">\n        {/* Header */}\n        <div className=\"field-docs-header\">\n          <button className=\"field-docs-back\" onClick={goBack}>\n            <ArrowLeft size={20} />\n          </button>\n          <div className=\"field-docs-title\">\n            <div className=\"field-docs-title-icon\" style={{ backgroundColor: `${folderColor}15` }}>\n              <FolderIcon size={20} style={{ color: folderColor }} />\n            </div>\n            <div className=\"field-docs-title-text\">\n              <h2>{selectedFolder.name}</h2>\n              <span>{documents.length} files</span>\n            </div>\n          </div>\n        </div>\n\n        {/* Documents */}\n        <div className=\"field-docs-list\">\n          {loadingDocs ? (\n            <div className=\"field-docs-loading\">\n              <Loader2 size={24} className=\"spinner\" />\n              <span>Loading...</span>\n            </div>\n          ) : documents.length === 0 ? (\n            <div className=\"field-docs-empty\">\n              <Folder size={48} style={{ color: folderColor, opacity: 0.3 }} />\n              <p>No documents yet</p>\n            </div>\n          ) : (\n            documents.map(doc => {\n              const FileIcon = getFileIcon(doc.mime_type)\n              return (\n                <button key={doc.id} className=\"field-doc-item\" onClick={() => handleDownload(doc)}>\n                  <div className=\"field-doc-icon\">\n                    <FileIcon size={22} />\n                  </div>\n                  <div className=\"field-doc-info\">\n                    <span className=\"field-doc-name\">{doc.name}</span>\n                    <span className=\"field-doc-size\">{formatFileSize(doc.file_size_bytes)}</span>\n                  </div>\n                  <Download size={20} className=\"field-doc-download\" />\n                </button>\n              )\n            })\n          )}\n        </div>\n      </div>\n    )\n  }\n\n  // Folder grid\n  return (\n    <div className=\"field-docs\">\n      <div className=\"field-docs-grid\">\n        {folders.length === 0 ? (\n          <div className=\"field-docs-empty\">\n            <Folder size={56} />\n            <h3>No documents</h3>\n            <p>Documents will appear here when added</p>\n          </div>\n        ) : (\n          folders.map(folder => {\n            const Icon = FOLDER_ICONS[folder.icon] || Folder\n            const color = FOLDER_COLORS[folder.color] || FOLDER_COLORS.blue\n            const count = folder.document_count || 0\n            return (\n              <button key={folder.id} className=\"field-folder-card\" onClick={() => openFolder(folder)}>\n                <div className=\"field-folder-icon\" style={{ backgroundColor: `${color}12` }}>\n                  <Icon size={28} style={{ color }} />\n                </div>\n                <div className=\"field-folder-info\">\n                  <span className=\"field-folder-name\">{folder.name}</span>\n                  <span className=\"field-folder-count\">{count} {count === 1 ? 'file' : 'files'}</span>\n                </div>\n                <ChevronRight size={20} className=\"field-folder-arrow\" />\n              </button>\n            )\n          })\n        )}\n      </div>\n    </div>\n  )\n}\n"],"names":["FOLDER_ICONS","Folder","Map","FileText","Shield","FileSignature","Send","HelpCircle","Camera","ClipboardList","AlertTriangle","FOLDER_COLORS","getFileIcon","mimeType","Image","FileSpreadsheet","File","formatFileSize","bytes","units","size","unitIndex","FolderGrid","projectId","onShowToast","folders","setFolders","useState","loading","setLoading","selectedFolder","setSelectedFolder","documents","setDocuments","loadingDocs","setLoadingDocs","selectedFolderRef","useRef","loadFolders","useCallback","folderList","db","error","loadDocuments","folderId","result","useEffect","folderSub","docSub","openFolder","folder","handleDownload","doc","url","goBack","jsxs","Loader2","jsx","FolderIcon","folderColor","ArrowLeft","FileIcon","Download","Icon","color","count","ChevronRight"],"mappings":"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"}