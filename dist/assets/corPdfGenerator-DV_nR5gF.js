import{E as H,a as C}from"./pdf-ChZ1zkDw.js";import{a as w,f as r,m as x,b as U}from"./corCalculations-AGZ2MGBO.js";import{h as j,l as Y}from"./imageUtils-D9jzIDAo.js";import"./index-DTVereQa.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const A=c=>{if(!c)return"";const[z,g]=c.split(":"),f=parseInt(z),F=f>=12?"pm":"am";return`${f%12||12}:${g}${F}`},G=c=>c.time_started&&c.time_ended?`${A(c.time_started)} - ${A(c.time_ended)}`:"-";async function Z(c,z={}){const{project:g,company:f,branding:F={}}=z,n=c.corData,p=c.ticketsData||[],t=new H,s=t.internal.pageSize.getWidth(),S=t.internal.pageSize.getHeight(),o=20;let e=o;const u=F.primaryColor?j(F.primaryColor):[30,58,95];if(F.logoUrl)try{const l=await Y(F.logoUrl);l&&t.addImage(l,"PNG",o,e,40,15)}catch{f?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...u),t.text(f.name,o,e+8))}else f?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...u),t.text(f.name,o,e+8));if(t.setFontSize(18),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("CHANGE ORDER REQUEST",s-o,e+5,{align:"right"}),t.setFontSize(12),t.setTextColor(...u),t.text(n.cor_number||"COR",s-o,e+12,{align:"right"}),e+=25,t.setDrawColor(...u),t.setLineWidth(.5),t.line(o,e,s-o,e),e+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(n.title||"Untitled Change Order",o,e),e+=8,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),g?.name&&(t.text(`Project: ${g.name}`,o,e),e+=5),g?.job_number&&(t.text(`Job #: ${g.job_number}`,o,e),e+=5),(n.period_start||n.period_end)&&(t.text(`Period: ${w(n.period_start,n.period_end)}`,o,e),e+=5),e+=5,n.scope_of_work){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("Scope of Work:",o,e),e+=5,t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const l=t.splitTextToSize(n.scope_of_work,s-o*2);t.text(l,o,e),e+=l.length*4+8}n.change_order_labor?.length>0&&(t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Labor",o,e),e+=5,C(t,{startY:e,head:[["Class","Wage Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:n.change_order_labor.map(l=>[l.labor_class,l.wage_type||"Standard",l.regular_hours?.toString()||"0",r(l.regular_rate),l.overtime_hours?.toString()||"0",r(l.overtime_rate),r(l.total)]),foot:[[{content:"Labor Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.labor_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:u,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),n.change_order_materials?.length>0&&(e>S-60&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Materials",o,e),e+=5,C(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:n.change_order_materials.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"ea",r(l.unit_cost),r(l.total)]),foot:[[{content:"Materials Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.materials_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:u,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),n.change_order_equipment?.length>0&&(e>S-60&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Equipment",o,e),e+=5,C(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:n.change_order_equipment.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"day",r(l.unit_cost),r(l.total)]),foot:[[{content:"Equipment Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.equipment_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:u,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),n.change_order_subcontractors?.length>0&&(e>S-60&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Subcontractors",o,e),e+=5,C(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:n.change_order_subcontractors.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"lump sum",r(l.unit_cost),r(l.total)]),foot:[[{content:"Subcontractors Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.subcontractors_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:u,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),e>S-100&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Cost Summary",o,e),e+=5;const N=[["Labor Subtotal",r(n.labor_subtotal)],[`  Markup (${x(n.labor_markup_percent)})`,r(n.labor_markup_amount)],["Materials Subtotal",r(n.materials_subtotal)],[`  Markup (${x(n.materials_markup_percent)})`,r(n.materials_markup_amount)],["Equipment Subtotal",r(n.equipment_subtotal)],[`  Markup (${x(n.equipment_markup_percent)})`,r(n.equipment_markup_amount)],["Subcontractors Subtotal",r(n.subcontractors_subtotal)],[`  Markup (${x(n.subcontractors_markup_percent)})`,r(n.subcontractors_markup_amount)]];C(t,{startY:e,body:N,margin:{left:o,right:o},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),e=t.lastAutoTable.finalY+5,t.setFillColor(248,250,252),t.rect(o,e,s-o*2,8,"F"),t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(30,41,59),t.text("COR Subtotal:",o+5,e+5.5),t.text(r(n.cor_subtotal),s-o-5,e+5.5,{align:"right"}),e+=12;const W=[[`Liability Insurance (${x(n.liability_insurance_percent)})`,r(n.liability_insurance_amount)],[`Bond (${x(n.bond_percent)})`,r(n.bond_amount)],[`License Fee (${x(n.license_fee_percent)})`,r(n.license_fee_amount)]];if(C(t,{startY:e,body:W,margin:{left:o,right:o},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),e=t.lastAutoTable.finalY+5,t.setFillColor(...u),t.rect(o,e,s-o*2,10,"F"),t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(255,255,255),t.text("COR TOTAL:",o+5,e+7),t.text(r(n.cor_total),s-o-5,e+7,{align:"right"}),e+=20,p.length>0){t.addPage(),e=o,f?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...u),t.text(f.name,o,e),e+=15),t.setDrawColor(...u),t.setLineWidth(.8),t.line(o,e,s-o,e),e+=3,t.setLineWidth(.3),t.line(o,e,s-o,e),e+=15,t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",s/2,e,{align:"center"}),e+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("Change Order Request Backup",s/2,e,{align:"center"}),e+=20,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`COR Reference: ${n.cor_number}`,o,e),e+=6,t.setFont("helvetica","normal"),t.setTextColor(71,85,105),g?.name&&(t.text(`Project: ${g.name}`,o,e),e+=5),g?.job_number&&(t.text(`Job #: ${g.job_number}`,o,e),e+=5),e+=15,t.setFillColor(248,250,252),t.setDrawColor(226,232,240),t.roundedRect(o,e,s-o*2,55,3,3,"FD"),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",o+10,e+12),t.setDrawColor(226,232,240),t.line(o+10,e+16,s-o-10,e+16);const l=o+15,b=o+80;let h=e+25;t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("T&M Tickets:",l,h),t.setFont("helvetica","bold"),t.text(String(p.length),b,h),t.setFont("helvetica","normal"),h+=7,t.text("Total Labor:",l,h),t.setFont("helvetica","bold"),t.text(`${c.totals.totalLaborHours.toFixed(1)} hrs`,b,h),t.setFont("helvetica","normal"),h+=7,c.totals.totalOTHours>0&&(t.text("Total OT:",l,h),t.setFont("helvetica","bold"),t.text(`${c.totals.totalOTHours.toFixed(1)} hrs`,b,h),t.setFont("helvetica","normal"),h+=7),t.text("Photo Evidence:",l,h),t.setFont("helvetica","bold"),t.text(`${c.totals.photoCount} photos`,b,h),t.setFont("helvetica","normal"),h+=7,t.text("Client Verified:",l,h),t.setFont("helvetica","bold");const M=c.totals.verifiedTicketCount>0?[16,185,129]:[71,85,105];t.setTextColor(...M),t.text(`${c.totals.verifiedTicketCount} of ${p.length} tickets`,b,h),e+=70,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const E=new Date(c.createdAt);t.text(`Generated: ${E.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${E.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,o,e),e+=6,t.text(`Document ID: ${c.checksum.substring(0,16).toUpperCase()}`,o,e);for(const i of p){t.addPage(),e=o;const I=!!i.client_signature_data,$=22,q=I?[16,185,129]:[245,158,11];if(t.setFillColor(...q),t.rect(o,e,4,$,"F"),t.setFillColor(248,250,252),t.rect(o+4,e,s-o*2-4,$,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`T&M TICKET — ${U(i.work_date||i.ticket_date)}`,o+10,e+8),i.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${i.ce_pco_number}`,o+10,e+16)),I&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",s-o-35,e+12)),e+=$+8,i.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",o,e),e+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const a=t.splitTextToSize(i.notes,s-o*2);t.text(a,o,e),e+=a.length*4+10}if(i.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",o,e),e+=6,C(t,{startY:e,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:i.t_and_m_workers.map(a=>[a.name,G(a),a.role||a.labor_class||"Laborer",a.hours?.toString()||"0",a.overtime_hours?.toString()||"-"]),margin:{left:o,right:o},headStyles:{fillColor:u,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),e=t.lastAutoTable.finalY+10),i.t_and_m_items?.length>0&&(e>S-60&&(t.addPage(),e=o),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",o,e),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: T&M Ticket",o+55,e),e+=6,C(t,{startY:e,head:[["Item","Qty","Unit"]],body:i.t_and_m_items.map(a=>[a.custom_name||a.materials_equipment?.name||a.description||"Unnamed Item",a.quantity?.toString()||"1",a.materials_equipment?.unit||a.unit||"ea"]),margin:{left:o,right:o},headStyles:{fillColor:u,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),e=t.lastAutoTable.finalY+10),i.photos?.length>0){e>S-80&&(t.addPage(),e=o),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",o,e),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${i.photos.length} photo${i.photos.length!==1?"s":""}`,o+50,e),e+=8;let a=o;const m=55,d=45,T=6,P=3;for(let _=0;_<i.photos.length;_++){_>0&&_%P===0&&(a=o,e+=d+T+4),e+d>S-20&&(t.addPage(),e=o,a=o);try{const y=await Y(i.photos[_]);y?(t.setDrawColor(200,200,200),t.setLineWidth(1),t.rect(a-1,e-1,m+2,d+2,"S"),t.setFillColor(230,230,230),t.rect(a+2,e+2,m,d,"F"),t.addImage(y,"JPEG",a,e,m,d)):(t.setFillColor(245,245,245),t.rect(a,e,m,d,"F"),t.setDrawColor(200,200,200),t.rect(a,e,m,d,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",a+8,e+d/2))}catch{t.setFillColor(245,245,245),t.rect(a,e,m,d,"F"),t.setDrawColor(200,200,200),t.rect(a,e,m,d,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",a+8,e+d/2)}a+=m+T}e+=d+12}if(i.client_signature_data){e>S-50&&(t.addPage(),e=o);const a=32,m=s-o*2;t.setFillColor(240,253,244),t.roundedRect(o,e,m,a,3,3,"F"),t.setFillColor(16,185,129),t.rect(o,e,4,a,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(o+4,e,o+m,e);const d=o+14,T=e+a/2;t.setFillColor(16,185,129),t.circle(d,T,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",d-2.5,T+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",o+26,e+10);try{t.addImage(i.client_signature_data,"PNG",o+26,e+13,50,16);const y=i.client_signature_name||"Client",D=i.client_signature_title||"",k=i.client_signature_company||"",L=i.client_signature_date?U(i.client_signature_date):"",R=o+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(y,R,e+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(D||k)&&t.text(`${D}${D&&k?", ":""}${k}`,R,e+18),L&&(t.setTextColor(100,116,139),t.text(`Verified: ${L}`,R,e+24))}catch{const _=i.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${_}`,o+26,e+20)}}}}const v=t.internal.getNumberOfPages();for(let l=1;l<=v;l++){t.setPage(l);const b=S-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,o,b),t.text(`Page ${l} of ${v}`,s-o,b,{align:"right"})}const O=`${n.cor_number||"COR"}_${g?.job_number||"export"}${p.length?"_with_backup":""}.pdf`;return t.save(O),{success:!0,fileName:O,pageCount:v,sizeBytes:t.output().length}}export{Z as generatePDFFromSnapshot};
