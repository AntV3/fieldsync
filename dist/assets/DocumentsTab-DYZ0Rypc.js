import{j as e,d as v,F as ke}from"./index-CscNh3uR.js";import{r as l,X as Q,E as ve,aD as Se,a as de,L,k as le,A as ge,D as J,aE as Ne,c as _e,j as ye,Q as ee,F as te,x as G,Y as we,am as Ee,au as ne,aq as Pe,w as Ie,v as Re,u as Ae,i as Me,t as Le,f as Ue,s as $e,T as Oe,n as ie,aF as Be,_ as Ve,$ as Ge,e as me,aG as Te,N as We,I as qe,z as Qe}from"./icons-esROBZsd.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";const Ce=[{id:"plans",label:"Plans & Drawings",icon:"Map"},{id:"specs",label:"Specifications",icon:"FileText"},{id:"permits",label:"Permits & Approvals",icon:"Shield"},{id:"contracts",label:"Contracts",icon:"FileSignature"},{id:"submittals",label:"Submittals",icon:"Send"},{id:"rfis",label:"RFIs",icon:"HelpCircle"},{id:"photos",label:"Site Photos",icon:"Camera"},{id:"reports",label:"Reports",icon:"ClipboardList"},{id:"safety",label:"Safety Documents",icon:"AlertTriangle"},{id:"general",label:"General",icon:"Folder"}],ue={"application/pdf":{ext:"pdf",maxSize:25*1024*1024,label:"PDF"},"application/msword":{ext:"doc",maxSize:15*1024*1024,label:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{ext:"docx",maxSize:15*1024*1024,label:"Word"},"application/vnd.ms-excel":{ext:"xls",maxSize:15*1024*1024,label:"Excel"},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{ext:"xlsx",maxSize:15*1024*1024,label:"Excel"},"image/jpeg":{ext:"jpg",maxSize:10*1024*1024,label:"Image"},"image/png":{ext:"png",maxSize:10*1024*1024,label:"Image"}},ze={all:{label:"Everyone",description:"Visible to all team members including field users"},office_only:{label:"Office Only",description:"Only visible to office staff and admins"},admin_only:{label:"Admins Only",description:"Only visible to company administrators"}},He=["contracts"],Ye=25,he=o=>{if(!o)return"0 B";const h=["B","KB","MB","GB"];let r=o,c=0;for(;r>=1024&&c<h.length-1;)r/=1024,c++;return`${r.toFixed(r<10?1:0)} ${h[c]}`};function pe({projectId:o,companyId:h,folderId:r,folderName:c,onClose:S,onUploadComplete:n,onShowToast:V}){const[p,d]=l.useState(null),[R,_]=l.useState(!1),[N,D]=l.useState(!1),[k,y]=l.useState(""),[C,x]=l.useState(null),[g,w]=l.useState(""),[E,z]=l.useState(""),[f,j]=l.useState("general"),[b,U]=l.useState("all"),A=l.useRef(null),$=s=>{if(!s)return"Please select a file";const P=ue[s.type];return P?s.size>P.maxSize?`File too large. Maximum size for ${P.label}: ${he(P.maxSize)}`:null:"File type not supported. Allowed: PDF, Word, Excel, Images"},t=l.useCallback(s=>{const P=$(s);if(P){x(P);return}if(x(null),d(s),!g){const H=s.name.replace(/\.[^/.]+$/,"");w(H)}},[g]),O=s=>{s.preventDefault(),s.stopPropagation(),s.type==="dragenter"||s.type==="dragover"?_(!0):s.type==="dragleave"&&_(!1)},a=s=>{s.preventDefault(),s.stopPropagation(),_(!1),s.dataTransfer.files&&s.dataTransfer.files[0]&&t(s.dataTransfer.files[0])},F=s=>{s.target.files&&s.target.files[0]&&t(s.target.files[0])},M=async()=>{if(!p){x("Please select a file");return}if(!g.trim()){x("Please enter a document name");return}D(!0),x(null),y("Uploading document...");try{const s=await v.uploadDocument(h,o,p,{name:g.trim(),description:E.trim()||null,category:f,visibility:b,folderId:r||null});y("Upload complete!"),n(s)}catch(s){console.error("Upload error:",s),x(s.message||"Failed to upload document"),D(!1)}},I=He.includes(f);return e.jsx("div",{className:"modal-overlay",onClick:S,children:e.jsxs("div",{className:"document-upload-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Upload Document"}),c&&e.jsxs("span",{className:"modal-subtitle",children:["to ",c]})]}),e.jsx("button",{className:"modal-close",onClick:S,children:e.jsx(Q,{size:20})})]}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:`document-dropzone ${R?"drag-active":""} ${p?"has-file":""}`,onDragEnter:O,onDragLeave:O,onDragOver:O,onDrop:a,onClick:()=>!p&&A.current?.click(),children:[e.jsx("input",{ref:A,type:"file",accept:Object.keys(ue).join(","),onChange:F,style:{display:"none"}}),p?e.jsxs("div",{className:"dropzone-file",children:[e.jsx(ve,{size:32}),e.jsxs("div",{className:"dropzone-file-info",children:[e.jsx("span",{className:"dropzone-file-name",children:p.name}),e.jsx("span",{className:"dropzone-file-size",children:he(p.size)})]}),e.jsx("button",{className:"dropzone-file-remove",onClick:s=>{s.stopPropagation(),d(null),x(null)},children:e.jsx(Q,{size:16})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Se,{size:48}),e.jsxs("p",{className:"dropzone-text",children:["Drag & drop files here",e.jsx("br",{}),"or click to browse"]}),e.jsx("p",{className:"dropzone-hint",children:"PDF, Word, Excel, Images • Max 25MB"})]})]}),C&&e.jsxs("div",{className:"document-upload-error",children:[e.jsx(de,{size:16}),C]}),e.jsxs("div",{className:"document-upload-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-name",children:"Document Name *"}),e.jsx("input",{id:"doc-name",type:"text",value:g,onChange:s=>w(s.target.value),placeholder:"Enter document name",disabled:N})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-category",children:"Category"}),e.jsx("select",{id:"doc-category",value:f,onChange:s=>j(s.target.value),disabled:N,children:Ce.map(s=>e.jsx("option",{value:s.id,children:s.label},s.id))}),I&&e.jsxs("p",{className:"form-hint warning",children:[e.jsx(de,{size:14}),"Documents in this category require admin approval before becoming visible."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-description",children:"Description"}),e.jsx("textarea",{id:"doc-description",value:E,onChange:s=>z(s.target.value),placeholder:"Optional description...",rows:3,disabled:N})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Visibility"}),e.jsx("div",{className:"visibility-options",children:Object.entries(ze).map(([s,{label:P,description:H}])=>e.jsxs("label",{className:`visibility-option ${b===s?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"visibility",value:s,checked:b===s,onChange:B=>U(B.target.value),disabled:N}),e.jsxs("div",{className:"visibility-content",children:[e.jsx("span",{className:"visibility-label",children:P}),e.jsx("span",{className:"visibility-desc",children:H})]})]},s))})]})]})]}),e.jsx("div",{className:"modal-footer",children:N?e.jsxs("div",{className:"upload-progress",children:[e.jsx(L,{size:20,className:"spinner"}),e.jsx("span",{children:k})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:S,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:M,disabled:!p||!g.trim(),children:[e.jsx(le,{size:18}),"Upload Document"]})]})})]})})}const Ke=o=>{if(!o)return"0 B";const h=["B","KB","MB","GB"];let r=o,c=0;for(;r>=1024&&c<h.length-1;)r/=1024,c++;return`${r.toFixed(r<10?1:0)} ${h[c]}`},xe=o=>o?new Date(o).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"";function Xe({document:o,onBack:h,onUpdate:r,onShowToast:c,isOfficeOrAdmin:S}){const[n,V]=l.useState(o),[p,d]=l.useState([]),[R,_]=l.useState(!0),[N,D]=l.useState(!1),[k,y]=l.useState(""),[C,x]=l.useState(!1),g=Ce.find(t=>t.id===n.category),w=ze[n.visibility],E=n.approval_status==="pending",z=n.approval_status==="rejected",f=S;l.useEffect(()=>{j()},[n.id]);const j=async()=>{_(!0);try{const t=await v.getDocumentVersions(n.id);d(t)}catch(t){console.error("Error loading versions:",t)}finally{_(!1)}},b=async()=>{await v.logDocumentAccess(n.id,"downloaded");const t=`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${n.storage_path}`;window.open(t,"_blank")},U=async()=>{x(!0);try{await v.approveDocument(n.id),V(t=>({...t,approval_status:"approved"})),c?.("Document approved","success"),r?.()}catch(t){console.error("Error approving document:",t),c?.("Failed to approve document","error")}finally{x(!1)}},A=async()=>{if(!k.trim()){c?.("Please provide a reason for rejection","error");return}x(!0);try{await v.rejectDocument(n.id,k.trim()),V(t=>({...t,approval_status:"rejected",rejection_reason:k.trim()})),D(!1),y(""),c?.("Document rejected","success"),r?.()}catch(t){console.error("Error rejecting document:",t),c?.("Failed to reject document","error")}finally{x(!1)}},$=async()=>{if(confirm("Are you sure you want to archive this document?")){x(!0);try{await v.archiveDocument(n.id),c?.("Document archived","success"),h(),r?.()}catch(t){console.error("Error archiving document:",t),c?.("Failed to archive document","error")}finally{x(!1)}}};return e.jsxs("div",{className:"document-detail",children:[e.jsxs("div",{className:"document-detail-header",children:[e.jsxs("button",{className:"back-btn",onClick:h,children:[e.jsx(ge,{size:20}),"Back"]}),e.jsxs("div",{className:"document-detail-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:b,children:[e.jsx(J,{size:18}),"Download"]}),S&&e.jsxs("button",{className:"btn btn-secondary btn-danger",onClick:$,disabled:C,children:[e.jsx(Ne,{size:18}),"Archive"]})]})]}),e.jsxs("div",{className:"document-detail-content",children:[e.jsxs("div",{className:"document-detail-main",children:[e.jsxs("div",{className:"document-detail-title",children:[e.jsx("h2",{children:n.name}),n.version>1&&e.jsxs("span",{className:"version-badge",children:["v",n.version]})]}),(E||z)&&e.jsxs("div",{className:"document-detail-status",children:[E&&e.jsxs("div",{className:"status-banner pending",children:[e.jsx(_e,{size:18}),e.jsx("span",{children:"Pending Approval"}),f&&e.jsxs("div",{className:"status-actions",children:[e.jsxs("button",{className:"btn btn-sm btn-success",onClick:U,disabled:C,children:[e.jsx(ye,{size:16}),"Approve"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:()=>D(!0),disabled:C,children:[e.jsx(ee,{size:16}),"Reject"]})]})]}),z&&e.jsxs("div",{className:"status-banner rejected",children:[e.jsx(ee,{size:18}),e.jsxs("div",{className:"rejected-info",children:[e.jsx("span",{children:"Rejected"}),n.rejection_reason&&e.jsx("p",{className:"rejection-reason",children:n.rejection_reason})]})]})]}),e.jsxs("div",{className:"document-detail-meta",children:[e.jsxs("div",{className:"meta-item",children:[e.jsx(te,{size:16}),e.jsx("span",{children:n.file_name})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(G,{size:16}),e.jsx("span",{children:g?.label||n.category})]}),e.jsx("div",{className:"meta-item",children:e.jsx("span",{className:"meta-size",children:Ke(n.file_size_bytes)})}),e.jsxs("div",{className:"meta-item",children:[e.jsx(we,{size:16}),e.jsx("span",{children:xe(n.uploaded_at)})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(Ee,{size:16}),e.jsx("span",{children:n.uploaded_by_user?.email||"Unknown"})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(ne,{size:16}),e.jsx("span",{children:w?.label||n.visibility})]})]}),n.description&&e.jsxs("div",{className:"document-detail-description",children:[e.jsx("h3",{children:"Description"}),e.jsx("p",{children:n.description})]}),n.resource_type&&n.resource_id&&e.jsxs("div",{className:"document-detail-linked",children:[e.jsxs("h3",{children:[e.jsx(Pe,{size:16}),"Linked To"]}),e.jsxs("p",{children:[n.resource_type==="cor"&&"Change Order Request",n.resource_type==="tm_ticket"&&"T&M Ticket",n.resource_type==="daily_report"&&"Daily Report"]})]})]}),e.jsxs("div",{className:"document-detail-sidebar",children:[e.jsx("h3",{children:"Version History"}),R?e.jsxs("div",{className:"versions-loading",children:[e.jsx(L,{size:20,className:"spinner"}),"Loading versions..."]}):p.length===0?e.jsx("p",{className:"versions-empty",children:"No version history"}):e.jsx("div",{className:"versions-list",children:p.map(t=>e.jsxs("div",{className:`version-item ${t.id===n.id?"current":""}`,children:[e.jsxs("div",{className:"version-info",children:[e.jsxs("span",{className:"version-number",children:["v",t.version,t.is_current&&e.jsx("span",{className:"current-badge",children:"Current"})]}),e.jsx("span",{className:"version-date",children:xe(t.uploaded_at)}),e.jsx("span",{className:"version-user",children:t.uploaded_by_user?.email})]}),e.jsx("button",{className:"version-download",onClick:async()=>{await v.logDocumentAccess(t.id,"downloaded"),window.open(`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${t.storage_path}`,"_blank")},title:"Download this version",children:e.jsx(J,{size:16})})]},t.id))}),S&&e.jsx("div",{className:"upload-version",children:e.jsx("p",{className:"upload-version-hint",children:'To upload a new version, use the main upload button and select "Replace existing document"'})})]})]}),N&&e.jsx("div",{className:"modal-overlay",onClick:()=>D(!1),children:e.jsxs("div",{className:"reject-modal",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:"Reject Document"}),e.jsx("p",{children:"Please provide a reason for rejection:"}),e.jsx("textarea",{value:k,onChange:t=>y(t.target.value),placeholder:"Enter reason...",rows:4}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-danger",onClick:A,disabled:!k.trim()||C,children:[C?e.jsx(L,{size:16,className:"spinner"}):e.jsx(ee,{size:16}),"Reject Document"]})]})]})})]})}const se=[{id:"folder",label:"Folder",icon:G},{id:"plans",label:"Plans",icon:Ie},{id:"specs",label:"Specs",icon:te},{id:"permits",label:"Permits",icon:Re},{id:"contracts",label:"Contracts",icon:Ae},{id:"submittals",label:"Submittals",icon:Me},{id:"rfis",label:"RFIs",icon:Le},{id:"photos",label:"Photos",icon:Ue},{id:"reports",label:"Reports",icon:$e},{id:"safety",label:"Safety",icon:Oe}],ae=[{id:"blue",label:"Blue",hex:"#3b82f6"},{id:"green",label:"Green",hex:"#10b981"},{id:"yellow",label:"Yellow",hex:"#f59e0b"},{id:"red",label:"Red",hex:"#ef4444"},{id:"purple",label:"Purple",hex:"#8b5cf6"},{id:"pink",label:"Pink",hex:"#ec4899"},{id:"orange",label:"Orange",hex:"#f97316"},{id:"gray",label:"Gray",hex:"#6b7280"}];function Je({projectId:o,companyId:h,folders:r,onFoldersChange:c,onClose:S,onShowToast:n}){const[V,p]=l.useState(!1),[d,R]=l.useState(null),[_,N]=l.useState(null),[D,k]=l.useState(!1),[y,C]=l.useState(""),[x,g]=l.useState("folder"),[w,E]=l.useState("blue"),[z,f]=l.useState(""),j=()=>{C(""),g("folder"),E("blue"),f(""),R(null)},b=()=>{j(),p(!0)},U=a=>{C(a.name),g(a.icon||"folder"),E(a.color||"blue"),f(a.description||""),R(a),p(!0)},A=async a=>{if(a.preventDefault(),!y.trim()){n?.("Please enter a folder name","error");return}k(!0);try{if(d)await v.updateFolder(d.id,{name:y.trim(),icon:x,color:w,description:z.trim()||null}),n?.("Folder updated","success");else{const F=Math.max(0,...r.map(M=>M.sort_order||0));await v.createFolder(h,o,{name:y.trim(),icon:x,color:w,description:z.trim()||null,sort_order:F+1}),n?.("Folder created","success")}p(!1),j(),c?.()}catch(F){console.error("Error saving folder:",F),F.message?.includes("duplicate key")||F.code==="23505"?n?.("A folder with this name already exists","error"):n?.("Failed to save folder","error")}finally{k(!1)}},$=async a=>{if(confirm(`Delete "${a.name}"? Documents in this folder will be moved to Unfiled.`)){N(a.id);try{await v.deleteFolder(a.id),n?.("Folder deleted","success"),c?.()}catch(F){console.error("Error deleting folder:",F),n?.("Failed to delete folder","error")}finally{N(null)}}},t=se.find(a=>a.id===x),O=ae.find(a=>a.id===w);return e.jsxs("div",{className:"folder-manager",children:[e.jsxs("div",{className:"folder-manager-header",children:[e.jsx("h3",{children:"Manage Folders"}),e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:b,children:[e.jsx(ie,{size:16}),"New Folder"]})]}),e.jsx("div",{className:"folder-manager-list",children:r.length===0?e.jsxs("div",{className:"folder-manager-empty",children:[e.jsx(G,{size:40}),e.jsx("p",{children:"No folders created yet"}),e.jsx("button",{className:"btn btn-secondary",onClick:b,children:"Create First Folder"})]}):r.map(a=>{const F=se.find(I=>I.id===a.icon)?.icon||G,M=ae.find(I=>I.id===a.color)?.hex||"#3b82f6";return e.jsxs("div",{className:"folder-manager-item",children:[e.jsx("div",{className:"folder-manager-item-drag",children:e.jsx(Be,{size:16})}),e.jsx("div",{className:"folder-manager-item-icon",style:{backgroundColor:`${M}15`},children:e.jsx(F,{size:20,style:{color:M}})}),e.jsxs("div",{className:"folder-manager-item-info",children:[e.jsx("span",{className:"folder-manager-item-name",children:a.name}),e.jsxs("span",{className:"folder-manager-item-count",children:[a.document_count||0," documents"]})]}),e.jsxs("div",{className:"folder-manager-item-actions",children:[e.jsx("button",{className:"folder-action-btn",onClick:()=>U(a),title:"Edit folder",children:e.jsx(Ve,{size:16})}),e.jsx("button",{className:"folder-action-btn danger",onClick:()=>$(a),disabled:_===a.id,title:"Delete folder",children:_===a.id?e.jsx(L,{size:16,className:"spinner"}):e.jsx(Ge,{size:16})})]})]},a.id)})}),V&&e.jsx("div",{className:"modal-overlay",onClick:()=>p(!1),children:e.jsxs("div",{className:"folder-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"folder-modal-header",children:[e.jsx("h3",{children:d?"Edit Folder":"Create Folder"}),e.jsx("button",{className:"modal-close",onClick:()=>p(!1),children:e.jsx(Q,{size:20})})]}),e.jsxs("form",{onSubmit:A,children:[e.jsxs("div",{className:"folder-modal-content",children:[e.jsxs("div",{className:"folder-preview",children:[e.jsx("div",{className:"folder-preview-icon",style:{backgroundColor:`${O?.hex}15`},children:t&&e.jsx(t.icon,{size:40,style:{color:O?.hex}})}),e.jsx("span",{className:"folder-preview-name",children:y||"Folder Name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-name",children:"Folder Name *"}),e.jsx("input",{id:"folder-name",type:"text",value:y,onChange:a=>C(a.target.value),placeholder:"e.g., Site Plans, Safety Documents",autoFocus:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Icon"}),e.jsx("div",{className:"folder-icon-grid",children:se.map(a=>e.jsx("button",{type:"button",className:`folder-icon-option ${x===a.id?"selected":""}`,onClick:()=>g(a.id),title:a.label,children:e.jsx(a.icon,{size:20})},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Color"}),e.jsx("div",{className:"folder-color-grid",children:ae.map(a=>e.jsx("button",{type:"button",className:`folder-color-option ${w===a.id?"selected":""}`,onClick:()=>E(a.id),style:{backgroundColor:a.hex},title:a.label},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-desc",children:"Description (optional)"}),e.jsx("input",{id:"folder-desc",type:"text",value:z,onChange:a=>f(a.target.value),placeholder:"Brief description of folder contents"})]})]}),e.jsxs("div",{className:"folder-modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>p(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!y.trim()||D,children:D?e.jsxs(e.Fragment,{children:[e.jsx(L,{size:16,className:"spinner"}),"Saving..."]}):d?"Save Changes":"Create Folder"})]})]})]})})]})}const je=o=>o?.startsWith("image/")?qe:o?.includes("spreadsheet")||o?.includes("excel")?Qe:o?.includes("pdf")?te:ve,fe=o=>{if(!o)return"0 B";const h=["B","KB","MB","GB"];let r=o,c=0;for(;r>=1024&&c<h.length-1;)r/=1024,c++;return`${r.toFixed(r<10?1:0)} ${h[c]}`},be=o=>o?new Date(o).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",X={blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b",red:"#ef4444",purple:"#8b5cf6",pink:"#ec4899",gray:"#6b7280",orange:"#f97316"};function ns({project:o,companyId:h,onShowToast:r,userRole:c}){const[S,n]=l.useState([]),[V,p]=l.useState(!0),[d,R]=l.useState(null),[_,N]=l.useState([]),[D,k]=l.useState(!1),[y,C]=l.useState(!1),[x,g]=l.useState(0),[w,E]=l.useState(0),[z,f]=l.useState(""),[j,b]=l.useState(null),[U,A]=l.useState(!1),[$,t]=l.useState(!1),[O,a]=l.useState(!1),[F,M]=l.useState(null),[I,s]=l.useState(null),P=c==="office"||c==="administrator",H=c==="foreman",B=l.useCallback(async()=>{p(!0);try{const i=await v.getProjectFolders(o.id);n(i)}catch(i){console.error("Error loading folders:",i),r?.("Failed to load folders","error")}finally{p(!1)}},[o.id,r]);l.useEffect(()=>{B()},[B]);const T=async(i,u=!1)=>{u&&(g(0),k(!0));try{const m=u?0:x,q=await v.getFolderDocuments(i.id,{page:m,limit:Ye});N(u?q.documents:K=>[...K,...q.documents]),E(q.totalCount),C(q.hasMore)}catch(m){console.error("Error loading documents:",m),r?.("Failed to load documents","error")}finally{k(!1)}},Fe=i=>{R(i),f(""),b(null),T(i,!0)},De=()=>{R(null),N([]),b(null),f("")},re=l.useCallback(async i=>{if(!i.trim()){b(null);return}A(!0);try{const u=await v.searchDocuments(o.id,i.trim());b(u)}catch(u){console.error("Error searching documents:",u)}finally{A(!1)}},[o.id]),Y=l.useRef(null),oe=l.useCallback(i=>{f(i),Y.current&&clearTimeout(Y.current),Y.current=setTimeout(()=>{re(i)},300)},[re]);l.useEffect(()=>()=>{Y.current&&clearTimeout(Y.current)},[]);const ce=()=>{t(!1),s(null),B(),d&&T(d,!0),r?.("Document uploaded successfully","success")},W=async(i,u)=>{try{switch(i){case"view":M(u);break;case"download":await v.logDocumentAccess(u.id,"downloaded"),window.open(u.url||`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${u.storage_path}`,"_blank");break;case"archive":await v.archiveDocument(u.id),d&&T(d,!0),B(),r?.("Document archived","success");break;case"approve":await v.approveDocument(u.id),d&&T(d,!0),r?.("Document approved","success");break;default:break}}catch(m){console.error("Error performing action:",m),r?.("Action failed","error")}},Z=i=>{s(i),t(!0)};if(H)return e.jsx(ke,{projectId:o.id,onShowToast:r});if(F)return e.jsx(Xe,{document:F,onBack:()=>M(null),onUpdate:()=>{d&&T(d,!0),B()},onShowToast:r,isOfficeOrAdmin:P});if(V)return e.jsx("div",{className:"docs-container",children:e.jsxs("div",{className:"docs-loading",children:[e.jsx(L,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading documents..."})]})});if(d){const i=X[d.color]||X.blue,u=j!==null?j:_;return e.jsxs("div",{className:"docs-container",children:[e.jsxs("div",{className:"docs-folder-header",children:[e.jsxs("button",{className:"docs-back-btn",onClick:De,children:[e.jsx(ge,{size:18}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"docs-folder-info",children:[e.jsx("div",{className:"docs-folder-icon",style:{backgroundColor:`${i}15`},children:e.jsx(G,{size:20,style:{color:i}})}),e.jsxs("div",{children:[e.jsx("h2",{className:"docs-folder-name",children:d.name}),e.jsxs("span",{className:"docs-folder-count",children:[w," files"]})]})]}),e.jsxs("button",{className:"docs-upload-btn",onClick:()=>Z(d),children:[e.jsx(le,{size:18}),e.jsx("span",{children:"Upload"})]})]}),e.jsx("div",{className:"docs-search-wrapper",children:e.jsxs("div",{className:"docs-search",children:[e.jsx(me,{size:16}),e.jsx("input",{type:"text",placeholder:"Search in folder...",value:z,onChange:m=>oe(m.target.value)}),z&&e.jsx("button",{onClick:()=>{f(""),b(null)},children:e.jsx(Q,{size:16})}),U&&e.jsx(L,{size:16,className:"spinner"})]})}),j!==null&&e.jsxs("div",{className:"docs-search-info",children:[e.jsxs("span",{children:[j.length," result",j.length!==1?"s":"",' for "',z,'"']}),e.jsx("button",{onClick:()=>{f(""),b(null)},children:"Clear"})]}),e.jsx("div",{className:"docs-list",children:D?e.jsxs("div",{className:"docs-loading",children:[e.jsx(L,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading..."})]}):u.length===0?e.jsxs("div",{className:"docs-empty",children:[e.jsx(G,{size:48,style:{color:i,opacity:.3}}),e.jsx("h3",{children:j!==null?"No results":"Empty folder"}),e.jsx("p",{children:j!==null?"Try a different search term.":"Upload your first document."}),j===null&&e.jsxs("button",{className:"docs-empty-btn",onClick:()=>Z(d),children:[e.jsx(le,{size:16}),"Upload Document"]})]}):e.jsxs(e.Fragment,{children:[u.map(m=>{const q=je(m.mime_type),K=m.approval_status==="pending";return e.jsxs("div",{className:`docs-item ${K?"pending":""}`,children:[e.jsx("div",{className:"docs-item-icon",children:e.jsx(q,{size:20})}),e.jsxs("div",{className:"docs-item-info",children:[e.jsxs("span",{className:"docs-item-name",children:[m.name,m.version>1&&e.jsxs("span",{className:"docs-item-version",children:["v",m.version]})]}),e.jsxs("span",{className:"docs-item-meta",children:[fe(m.file_size_bytes)," · ",be(m.uploaded_at)]})]}),K&&e.jsx("span",{className:"docs-badge pending",children:"Pending"}),e.jsxs("div",{className:"docs-item-actions",children:[e.jsx("button",{onClick:()=>W("view",m),title:"View",children:e.jsx(ne,{size:16})}),e.jsx("button",{onClick:()=>W("download",m),title:"Download",children:e.jsx(J,{size:16})}),K&&e.jsx("button",{className:"approve",onClick:()=>W("approve",m),title:"Approve",children:e.jsx(ye,{size:16})}),e.jsx("button",{className:"danger",onClick:()=>W("archive",m),title:"Archive",children:e.jsx(Ne,{size:16})})]})]},m.id)}),y&&j===null&&e.jsxs("button",{className:"docs-load-more",onClick:()=>{g(m=>m+1),T(d,!1)},disabled:D,children:["Load More (",_.length," of ",w,")"]})]})}),$&&e.jsx(pe,{projectId:o.id,companyId:h,folderId:I?.id,folderName:I?.name,onClose:()=>{t(!1),s(null)},onUploadComplete:ce,onShowToast:r})]})}return e.jsxs("div",{className:"docs-container",children:[e.jsxs("div",{className:"docs-header",children:[e.jsxs("div",{className:"docs-search",children:[e.jsx(me,{size:16}),e.jsx("input",{type:"text",placeholder:"Search documents...",value:z,onChange:i=>oe(i.target.value)}),z&&e.jsx("button",{onClick:()=>{f(""),b(null)},children:e.jsx(Q,{size:16})}),U&&e.jsx(L,{size:16,className:"spinner"})]}),e.jsxs("button",{className:"docs-manage-btn",onClick:()=>a(!0),children:[e.jsx(Te,{size:18}),e.jsx("span",{children:"Manage"})]})]}),j!==null?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"docs-search-info",children:[e.jsxs("span",{children:[j.length," result",j.length!==1?"s":""]}),e.jsx("button",{onClick:()=>{f(""),b(null)},children:"Clear"})]}),e.jsx("div",{className:"docs-list",children:j.map(i=>{const u=je(i.mime_type);return e.jsxs("div",{className:"docs-item",children:[e.jsx("div",{className:"docs-item-icon",children:e.jsx(u,{size:20})}),e.jsxs("div",{className:"docs-item-info",children:[e.jsx("span",{className:"docs-item-name",children:i.name}),e.jsxs("span",{className:"docs-item-meta",children:[fe(i.file_size_bytes)," · ",be(i.uploaded_at)]})]}),e.jsxs("div",{className:"docs-item-actions",children:[e.jsx("button",{onClick:()=>W("view",i),children:e.jsx(ne,{size:16})}),e.jsx("button",{onClick:()=>W("download",i),children:e.jsx(J,{size:16})})]})]},i.id)})})]}):e.jsx("div",{className:"docs-grid",children:S.length===0?e.jsxs("div",{className:"docs-empty-state",children:[e.jsx(We,{size:56}),e.jsx("h3",{children:"No folders yet"}),e.jsx("p",{children:"Create folders to organize your documents"}),e.jsxs("button",{onClick:()=>a(!0),children:[e.jsx(ie,{size:18}),"Create Folder"]})]}):S.map(i=>{const u=X[i.color]||X.blue;return e.jsxs("div",{className:"docs-folder-card",onClick:()=>Fe(i),children:[e.jsx("div",{className:"docs-folder-card-icon",style:{backgroundColor:`${u}12`},children:e.jsx(G,{size:28,style:{color:u}})}),e.jsxs("div",{className:"docs-folder-card-content",children:[e.jsx("span",{className:"docs-folder-card-name",children:i.name}),e.jsxs("span",{className:"docs-folder-card-count",children:[i.document_count||0," ",i.document_count===1?"file":"files"]})]}),e.jsx("button",{className:"docs-folder-card-upload",onClick:m=>{m.stopPropagation(),Z(i)},title:"Upload",children:e.jsx(ie,{size:18})})]},i.id)})}),O&&e.jsx("div",{className:"modal-overlay",onClick:()=>a(!1),children:e.jsxs("div",{className:"docs-manager-modal",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"docs-manager-header",children:[e.jsx("h2",{children:"Manage Folders"}),e.jsx("button",{onClick:()=>a(!1),children:e.jsx(Q,{size:20})})]}),e.jsx(Je,{projectId:o.id,companyId:h,folders:S,onFoldersChange:B,onClose:()=>a(!1),onShowToast:r})]})}),$&&e.jsx(pe,{projectId:o.id,companyId:h,folderId:I?.id,folderName:I?.name,onClose:()=>{t(!1),s(null)},onUploadComplete:ce,onShowToast:r})]})}export{ns as default};
//# sourceMappingURL=DocumentsTab-DYZ0Rypc.js.map
