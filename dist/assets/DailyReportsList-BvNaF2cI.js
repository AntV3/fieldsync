import{_ as ie}from"./pdf-aQqpMATS.js";import{aJ as oe,ar as k,as as t,aM as I,aN as ce}from"./index-Ci6tZHcR.js";import{r as c,O as de,s as B,q as he,y as me}from"./icons-B-oSmWeD.js";import{E as ue,b as U}from"./Dashboard-BDci2LbV.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";import"./corCalculations-D9qkkIbo.js";const pe=()=>ie(()=>import("./pdf-aQqpMATS.js").then(m=>m.j),[]);function ye({project:m,company:H,onShowToast:v}){const{branding:b}=oe(),[g,G]=c.useState([]),[J,V]=c.useState(!0),[T,$]=c.useState(null),[w,Y]=c.useState(null),[h,f]=c.useState(new Set),[j,W]=c.useState(!1),[u,y]=c.useState("recent"),[S,z]=c.useState(new Set),[p,_]=c.useState({start:"",end:""});c.useEffect(()=>{C();const e=k.subscribeToDailyReports?.(m.id,()=>{C()});return()=>{e&&k.unsubscribe?.(e)}},[m.id]);const C=c.useCallback(async()=>{try{$(null);const e=await k.getDailyReports(m.id,365);G(e||[])}catch(e){console.error("Error loading daily reports:",e),$(e),v?.("Error loading daily reports","error")}finally{V(!1)}},[m.id]),d=c.useMemo(()=>{let e=[...g];if(p.start){const a=new Date(p.start);a.setHours(0,0,0,0),e=e.filter(l=>new Date(l.report_date||l.created_at)>=a)}if(p.end){const a=new Date(p.end);a.setHours(23,59,59,999),e=e.filter(l=>new Date(l.report_date||l.created_at)<=a)}if(u==="recent"){const a=new Date;a.setDate(a.getDate()-7),a.setHours(0,0,0,0),e=e.filter(l=>new Date(l.report_date||l.created_at)>=a)}return e},[g,u,p]),N=c.useMemo(()=>{if(u!=="all")return null;const e={};return d.forEach(a=>{const l=new Date(a.report_date||a.created_at),s=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`,o=l.toLocaleDateString("en-US",{month:"long",year:"numeric"});e[s]||(e[s]={label:o,reports:[]}),e[s].reports.push(a)}),Object.entries(e).sort((a,l)=>l[0].localeCompare(a[0]))},[d,u]);c.useEffect(()=>{if(N&&N.length>0){const e=N[0][0];z(new Set([e]))}},[N]);const q=()=>{W(!j),j&&f(new Set)},Q=e=>{const a=new Set(h);a.has(e)?a.delete(e):a.add(e),f(a)},X=()=>{h.size===d.length?f(new Set):f(new Set(d.map(e=>e.id)))},Z=e=>{const a=new Set(S);a.has(e)?a.delete(e):a.add(e),z(a)},K=()=>h.size>0?d.filter(e=>h.has(e.id)):d,P=e=>new Date(e).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),ee=e=>new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),te=e=>{switch(e){case"submitted":return"✓";case"reviewed":return"✓✓";case"draft":return"○";default:return"○"}},E=e=>{switch(e){case"submitted":return"Submitted";case"reviewed":return"Reviewed";case"draft":return"Draft";default:return e}},se=async()=>{const e=K();if(e.length===0){v?.("No reports to export","error");return}v?.("Generating PDF...","info");const l=(await pe()).default,s=new l,o=s.internal.pageSize.getWidth(),n=20;let r=n;const F=I(b?.primary_color||"#3B82F6"),ne=I(b?.secondary_color||"#1E40AF");s.setFillColor(...F),s.rect(0,0,o,45,"F"),s.setFillColor(...ne),s.rect(0,42,o,3,"F");let R=n;if(b?.logo_url)try{const i=await ce(b.logo_url);i&&(s.addImage(i,"PNG",n,7,30,30),R=n+40)}catch(i){console.error("Error adding logo:",i)}s.setTextColor(255,255,255),s.setFontSize(22),s.setFont("helvetica","bold"),s.text(H?.name||"Company Name",R,20),s.setFontSize(10),s.setFont("helvetica","normal"),s.text("DAILY REPORTS SUMMARY",R,30),s.setFontSize(9),s.text(`Generated: ${new Date().toLocaleDateString()}`,o-n,20,{align:"right"}),m.job_number&&s.text(`Job #: ${m.job_number}`,o-n,28,{align:"right"}),r=55,s.setFillColor(248,250,252),s.rect(n,r-5,o-n*2,20,"F"),s.setTextColor(...F),s.setFontSize(14),s.setFont("helvetica","bold"),s.text(`Project: ${m.name}`,n+5,r+7),s.setFontSize(10),s.setTextColor(100,100,100),s.text(`${e.length} Report${e.length!==1?"s":""}`,o-n-5,r+7,{align:"right"}),r+=25,e.forEach((i,xe)=>{r>250&&(s.addPage(),r=n),s.setFillColor(...F),s.setTextColor(255,255,255),s.rect(n,r,o-n*2,10,"F"),s.setFontSize(11),s.setFont("helvetica","bold"),s.text(P(i.report_date||i.created_at),n+5,r+7),s.text(E(i.status),o-n-5,r+7,{align:"right"}),r+=15,s.setTextColor(50,50,50),s.setFontSize(10),s.setFont("helvetica","normal");const re=`Crew: ${i.crew_count||0}  |  Tasks: ${i.tasks_completed||0}  |  T&M: ${i.tm_tickets_count||0}  |  Photos: ${i.photos_count||0}`;if(s.text(re,n+5,r),r+=8,i.crew_list?.length>0){s.setFont("helvetica","bold"),s.text("Crew:",n+5,r),s.setFont("helvetica","normal");const x=i.crew_list.map(O=>`${O.name} (${O.role})`).join(", "),A=s.splitTextToSize(x,o-n*2-30);s.text(A,n+25,r),r+=A.length*5+3}if(i.field_notes){s.setFont("helvetica","bold"),s.text("Notes:",n+5,r),s.setFont("helvetica","normal");const x=s.splitTextToSize(i.field_notes,o-n*2-30);s.text(x,n+25,r),r+=x.length*5+3}if(i.issues){s.setTextColor(180,50,50),s.setFont("helvetica","bold"),s.text("Issues:",n+5,r),s.setFont("helvetica","normal");const x=s.splitTextToSize(i.issues,o-n*2-30);s.text(x,n+25,r),s.setTextColor(50,50,50),r+=x.length*5+3}r+=10});const L=s.internal.getNumberOfPages();for(let i=1;i<=L;i++)s.setPage(i),s.setFontSize(8),s.setTextColor(150,150,150),s.text(`Page ${i} of ${L}`,o/2,s.internal.pageSize.getHeight()-10,{align:"center"});const le=`${m.name}_Daily_Reports_${new Date().toISOString().split("T")[0]}.pdf`;s.save(le),v?.("PDF exported!","success")},M=e=>t.jsxs("div",{className:`daily-report-card ${e.status} ${h.has(e.id)?"selected":""}`,children:[t.jsxs("div",{className:"daily-report-header-row",onClick:()=>Y(w===e.id?null:e.id),children:[j&&t.jsx("input",{type:"checkbox",className:"report-checkbox",checked:h.has(e.id),onChange:a=>{a.stopPropagation(),Q(e.id)},onClick:a=>a.stopPropagation()}),t.jsxs("div",{className:"daily-report-info",children:[t.jsx("span",{className:"report-date",children:P(e.report_date||e.created_at)}),t.jsxs("span",{className:`report-status ${e.status}`,children:[te(e.status)," ",E(e.status)]})]}),t.jsxs("div",{className:"daily-report-summary",children:[t.jsxs("span",{className:"report-crew",children:[e.crew_count||0," crew"]}),t.jsxs("span",{className:"report-tasks",children:[e.tasks_completed||0," tasks"]}),t.jsx("span",{className:"report-expand",children:w===e.id?"▼":"▶"})]})]}),w===e.id&&t.jsxs("div",{className:"daily-report-details",children:[t.jsxs("div",{className:"report-stats-grid",children:[t.jsxs("div",{className:"report-stat",children:[t.jsx("span",{className:"stat-value",children:e.crew_count||0}),t.jsx("span",{className:"stat-label",children:"Crew on Site"})]}),t.jsxs("div",{className:"report-stat",children:[t.jsx("span",{className:"stat-value",children:e.tasks_completed||0}),t.jsx("span",{className:"stat-label",children:"Tasks Done"})]}),t.jsxs("div",{className:"report-stat",children:[t.jsx("span",{className:"stat-value",children:e.tm_tickets_count||0}),t.jsx("span",{className:"stat-label",children:"T&M Tickets"})]}),t.jsxs("div",{className:"report-stat",children:[t.jsx("span",{className:"stat-value",children:e.photos_count||0}),t.jsx("span",{className:"stat-label",children:"Photos"})]})]}),e.crew_list?.length>0&&t.jsxs("div",{className:"report-section",children:[t.jsx("h4",{children:"Crew"}),t.jsx("div",{className:"report-crew-list",children:e.crew_list.map((a,l)=>t.jsxs("div",{className:"crew-member",children:[t.jsx("span",{className:"crew-name",children:a.name}),t.jsx("span",{className:"crew-role",children:a.role})]},l))})]}),e.completed_tasks?.length>0&&t.jsxs("div",{className:"report-section",children:[t.jsx("h4",{children:"Completed Today"}),t.jsx("ul",{className:"report-tasks-list",children:e.completed_tasks.map((a,l)=>t.jsxs("li",{children:[a.name,a.group&&t.jsx("span",{className:"task-group",children:a.group})]},l))})]}),e.field_notes&&t.jsxs("div",{className:"report-section",children:[t.jsx("h4",{children:"Field Notes"}),t.jsx("p",{className:"report-notes",children:e.field_notes})]}),e.issues&&t.jsxs("div",{className:"report-section issues",children:[t.jsx("h4",{children:"Issues / Concerns"}),t.jsx("p",{className:"report-issues",children:e.issues})]}),e.submitted_at&&t.jsx("div",{className:"report-meta",children:t.jsxs("span",{children:["Submitted by ",e.submitted_by||"Field"," at ",ee(e.submitted_at)]})})]})]},e.id);if(J)return t.jsx("div",{className:"loading",children:"Loading daily reports..."});if(T)return t.jsx("div",{className:"daily-reports-list card",children:t.jsx(ue,{title:"Unable to load reports",message:"There was a problem loading daily reports. Please try again.",error:T,onRetry:C})});const D=g.length,ae=d.length;return t.jsxs("div",{className:"daily-reports-list card",children:[t.jsxs("div",{className:"daily-reports-header",children:[t.jsx("h3",{children:"Daily Reports"}),t.jsx("div",{className:"daily-reports-actions",children:g.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:`btn btn-small ${j?"btn-primary":"btn-secondary"}`,onClick:q,children:j?"Cancel":"Select"}),t.jsxs("button",{className:"btn btn-secondary btn-small",onClick:se,children:["PDF",h.size>0?` (${h.size})`:""]})]})})]}),g.length>0&&t.jsxs("div",{className:"view-mode-bar",children:[t.jsxs("div",{className:"view-mode-tabs",children:[t.jsx("button",{className:`view-mode-tab ${u==="recent"?"active":""}`,onClick:()=>y("recent"),children:"Recent (7 days)"}),t.jsxs("button",{className:`view-mode-tab ${u==="all"?"active":""}`,onClick:()=>y("all"),children:["All (",D,")"]})]}),u==="all"&&t.jsxs("div",{className:"date-filter",children:[t.jsx(de,{size:14,className:"date-filter-icon"}),t.jsx("input",{type:"date",value:p.start,onChange:e=>_(a=>({...a,start:e.target.value})),className:"date-input"}),t.jsx("span",{className:"date-separator",children:"to"}),t.jsx("input",{type:"date",value:p.end,onChange:e=>_(a=>({...a,end:e.target.value})),className:"date-input"}),(p.start||p.end)&&t.jsx("button",{className:"date-clear",onClick:()=>_({start:"",end:""}),children:"Clear"})]})]}),j&&d.length>0&&t.jsxs("div",{className:"select-all-bar",children:[t.jsxs("label",{className:"select-all-label",children:[t.jsx("input",{type:"checkbox",checked:h.size===d.length&&d.length>0,onChange:X}),"Select All (",d.length,")"]}),h.size>0&&t.jsxs("span",{className:"selected-count",children:[h.size," selected"]})]}),g.length===0?t.jsx(U,{icon:B,title:"No daily reports yet",message:"Reports from the field will appear here"}):d.length===0?t.jsx(U,{icon:B,title:"No reports in this time period",message:u==="recent"?"No reports in the last 7 days":"Try adjusting your date filter"}):u==="recent"?t.jsxs("div",{className:"daily-reports",children:[d.map(e=>M(e)),D>ae&&t.jsx("div",{className:"view-all-prompt",children:t.jsxs("button",{className:"btn btn-secondary",onClick:()=>y("all"),children:["View All ",D," Reports"]})})]}):t.jsx("div",{className:"daily-reports grouped",children:N?.map(([e,{label:a,reports:l}])=>t.jsxs("div",{className:"month-group",children:[t.jsxs("div",{className:"month-header",onClick:()=>Z(e),children:[S.has(e)?t.jsx(he,{size:18,className:"month-chevron"}):t.jsx(me,{size:18,className:"month-chevron"}),t.jsx("span",{className:"month-label",children:a}),t.jsxs("span",{className:"month-count",children:[l.length," report",l.length!==1?"s":""]})]}),S.has(e)&&t.jsx("div",{className:"month-reports",children:l.map(s=>M(s))})]},e))})]})}export{ye as default};
//# sourceMappingURL=DailyReportsList-BvNaF2cI.js.map
