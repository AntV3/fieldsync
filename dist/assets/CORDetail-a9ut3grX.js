const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-TYWTBWOW.js","assets/icons-CwUiT5nc.js","assets/react-DXGY7bZi.js","assets/pdf-aQqpMATS.js","assets/supabase-VuevzHjS.js","assets/index-DgNh7iNg.css"])))=>i.map(i=>d[i]);
import{aq as Q,aK as H,aG as fe,aH as ye,aU as Ce,ar as q,as as e}from"./index-TYWTBWOW.js";import{r as z,b as ve,X as ae,aA as Ne,e as Se,F as re,$ as le,Y as ce,aq as ke,p as Fe,B as Te,aH as ze,d as Ee,a as Re,v as Oe,C as Pe,_ as we,K as De,aI as ne,aJ as Ie,af as de,P as $e,n as qe,k as Ae,D as ue}from"./icons-CwUiT5nc.js";import{a as _e,f as c,d as T,b as B,c as Le,k as Ue,e as te}from"./corCalculations-vdJc_BOT.js";import{_ as oe,E as Me,a as G}from"./pdf-aQqpMATS.js";import{e as Ge}from"./Dashboard-BXp_YwOl.js";import{S as Be}from"./SignatureCanvas-h6YK1ET9.js";import He from"./SignatureLinkGenerator-DQk3GSqf.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const V={PENDING:"pending",GENERATING:"generating",COMPLETED:"completed",FAILED:"failed"},Ye={PDF:"pdf"};function We(n,x,u=null){if(u)return`custom_${u}`;const j=Math.floor(Date.now()/6e4);return`cor_${n}_v${x||1}_${j}`}function Ve(n){return`cor_${n}_force_${Date.now()}`}function me(n,x,u={}){const j=new Date().toISOString(),y=[];let i=0;for(const d of x||[]){const _=d.photos||[];i+=_.length;for(const o of _)y.push({ticketId:d.id,workDate:d.work_date,url:o,verified:!1,includedInExport:!0})}const h=(n.change_order_labor||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0),t=(n.change_order_materials||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0),l=(n.change_order_equipment||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0),p=(n.change_order_subcontractors||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0);let s=0,a=0;for(const d of x||[])for(const _ of d.t_and_m_workers||[])s+=parseFloat(_.hours)||0,a+=parseFloat(_.overtime_hours)||0;const f=JSON.stringify({corId:n.id,version:n.version,totals:{laborTotal:h,materialsTotal:t,equipmentTotal:l,subcontractorsTotal:p},ticketCount:x?.length||0,photoCount:i});let S=0;for(let d=0;d<f.length;d++){const _=f.charCodeAt(d);S=(S<<5)-S+_,S=S&S}const O=Math.abs(S).toString(16).padStart(16,"0");return{snapshotId:crypto.randomUUID(),corId:n.id,corVersion:n.version||1,createdAt:j,checksum:O,corData:{id:n.id,cor_number:n.cor_number,title:n.title,description:n.description,scope_of_work:n.scope_of_work,status:n.status,period_start:n.period_start,period_end:n.period_end,change_order_labor:n.change_order_labor||[],change_order_materials:n.change_order_materials||[],change_order_equipment:n.change_order_equipment||[],change_order_subcontractors:n.change_order_subcontractors||[],labor_markup_percent:n.labor_markup_percent,materials_markup_percent:n.materials_markup_percent,equipment_markup_percent:n.equipment_markup_percent,subcontractors_markup_percent:n.subcontractors_markup_percent,liability_insurance_percent:n.liability_insurance_percent,bond_percent:n.bond_percent,license_fee_percent:n.license_fee_percent,labor_subtotal:n.labor_subtotal,materials_subtotal:n.materials_subtotal,equipment_subtotal:n.equipment_subtotal,subcontractors_subtotal:n.subcontractors_subtotal,labor_markup_amount:n.labor_markup_amount,materials_markup_amount:n.materials_markup_amount,equipment_markup_amount:n.equipment_markup_amount,subcontractors_markup_amount:n.subcontractors_markup_amount,liability_insurance_amount:n.liability_insurance_amount,bond_amount:n.bond_amount,license_fee_amount:n.license_fee_amount,cor_subtotal:n.cor_subtotal,additional_fees_total:n.additional_fees_total,cor_total:n.cor_total,gc_signature_data:n.gc_signature_data,gc_signature_name:n.gc_signature_name,gc_signature_date:n.gc_signature_date,created_at:n.created_at,submitted_at:n.submitted_at,approved_at:n.approved_at},ticketsData:(x||[]).map(d=>({id:d.id,work_date:d.work_date,ticket_date:d.ticket_date,ce_pco_number:d.ce_pco_number,notes:d.notes,status:d.status,created_at:d.created_at,t_and_m_workers:(d.t_and_m_workers||[]).map(_=>({id:_.id,name:_.name,role:_.role,labor_class:_.labor_class,hours:_.hours,overtime_hours:_.overtime_hours,time_started:_.time_started,time_ended:_.time_ended})),t_and_m_items:(d.t_and_m_items||[]).map(_=>({id:_.id,description:_.description,quantity:_.quantity,unit:_.unit,materials_equipment:_.materials_equipment})),photos:d.photos||[],client_signature_data:d.client_signature_data,client_signature_name:d.client_signature_name,client_signature_title:d.client_signature_title,client_signature_company:d.client_signature_company,client_signature_date:d.client_signature_date})),photoManifest:y,totals:{laborTotal:h,materialsTotal:t,equipmentTotal:l,subcontractorsTotal:p,totalLaborHours:s,totalOTHours:a,ticketCount:x?.length||0,photoCount:i,verifiedTicketCount:(x||[]).filter(d=>d.client_signature_data).length}}}async function Qe(n,x={}){const{forceNew:u=!1,idempotencyKey:j=null,exportType:y=Ye.PDF,includeBackup:i=!0}=x;try{const{data:h,error:t}=await H.from("change_orders").select("id, version, cor_number").eq("id",n).single();if(t||!h)throw new Error(`COR not found: ${n}`);const l=u?Ve(n):j||We(n,h.version),{data:p,error:s}=await H.rpc("request_cor_export",{p_cor_id:n,p_idempotency_key:l,p_options:{exportType:y,includeBackup:i},p_requested_by:(await H.auth.getUser())?.data?.user?.id});if(s)throw s;const a=p?.[0];if(!a)throw new Error("Failed to create export job");return Q.activity("cor_export_requested",{cor_id:n,job_id:a.job_id,is_new:a.is_new,status:a.status}),{jobId:a.job_id,status:a.status,isNew:a.is_new,snapshotId:a.snapshot_id,pdfUrl:a.pdf_url,idempotencyKey:l}}catch(h){throw Q.error("cor_export_request_failed",{cor_id:n,error:h.message}),h}}async function ie(n,x,u={}){const{data:j,error:y}=await H.rpc("update_export_job_status",{p_job_id:n,p_status:x,p_snapshot_id:u.snapshotId||null,p_pdf_url:u.pdfUrl||null,p_error:u.error||null,p_error_details:u.errorDetails||null,p_metrics:u.metrics||null});if(y)throw Q.error("cor_export_job_update_failed",{job_id:n,status:x,error:y.message}),y;return j}async function Ke(n,x){await H.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",n.corId);const{data:u,error:j}=await H.from("cor_export_snapshots").insert({id:n.snapshotId,cor_id:n.corId,job_id:x,cor_version:n.corVersion,cor_data:n.corData,tickets_data:n.ticketsData,photos_manifest:n.photoManifest,totals_snapshot:n.totals,checksum:n.checksum,is_current:!0,exported_by:(await H.auth.getUser())?.data?.user?.id}).select().single();if(j)throw j;return await H.from("change_orders").update({last_snapshot_version:n.corVersion}).eq("id",n.corId),u}async function Je(n,{cor:x,tickets:u,project:j,company:y,branding:i,options:h={}}={}){let t=null;try{if(t=await Qe(n,h),t.status===V.COMPLETED&&t.pdfUrl)return Q.activity("cor_export_cache_hit",{cor_id:n,job_id:t.jobId}),{success:!0,jobId:t.jobId,cached:!0,pdfUrl:t.pdfUrl};if(t.status===V.GENERATING)return{success:!0,jobId:t.jobId,status:V.GENERATING,message:"Export already in progress"};if(await ie(t.jobId,V.GENERATING),!x){const{db:f}=await oe(async()=>{const{db:S}=await import("./index-TYWTBWOW.js").then(O=>O.aY);return{db:S}},__vite__mapDeps([0,1,2,3,4,5]));x=await f.getCORById(n)}if(!u&&h.includeBackup!==!1){const{db:f}=await oe(async()=>{const{db:S}=await import("./index-TYWTBWOW.js").then(O=>O.aY);return{db:S}},__vite__mapDeps([0,1,2,3,4,5]));u=await f.getCORTickets(n)}const l=me(x,u,h),p=await Ke(l,t.jobId),{generatePDFFromSnapshot:s}=await oe(async()=>{const{generatePDFFromSnapshot:f}=await Promise.resolve().then(()=>Ze);return{generatePDFFromSnapshot:f}},void 0),a=await s(l,{project:j,company:y,branding:i});return await ie(t.jobId,V.COMPLETED,{snapshotId:p.id,pdfUrl:a.fileName,metrics:{photo_count:l.totals.photoCount,ticket_count:l.totals.ticketCount,page_count:a.pageCount||1,pdf_size_bytes:a.sizeBytes||0}}),Q.activity("cor_export_completed",{cor_id:n,job_id:t.jobId,photo_count:l.totals.photoCount,ticket_count:l.totals.ticketCount}),{success:!0,jobId:t.jobId,snapshotId:p.id,fileName:a.fileName,snapshot:l.totals}}catch(l){throw t?.jobId&&await ie(t.jobId,V.FAILED,{error:l.message,errorDetails:{stack:l.stack}}).catch(()=>{}),Q.error("cor_export_failed",{cor_id:n,job_id:t?.jobId,error:l.message}),l}}const he=n=>{if(!n)return"";const[x,u]=n.split(":"),j=parseInt(x),y=j>=12?"pm":"am";return`${j%12||12}:${u}${y}`},Xe=n=>n.time_started&&n.time_ended?`${he(n.time_started)} - ${he(n.time_ended)}`:"-";async function pe(n,x={}){const{project:u,company:j,branding:y={}}=x,i=n.corData,h=n.ticketsData||[],t=new Me,l=t.internal.pageSize.getWidth(),p=t.internal.pageSize.getHeight(),s=20;let a=s;const f=y.primaryColor?fe(y.primaryColor):[30,58,95];if(y.logoUrl)try{const o=await ye(y.logoUrl);o&&t.addImage(o,"PNG",s,a,40,15)}catch{j?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...f),t.text(j.name,s,a+8))}else j?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...f),t.text(j.name,s,a+8));if(t.setFontSize(18),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("CHANGE ORDER REQUEST",l-s,a+5,{align:"right"}),t.setFontSize(12),t.setTextColor(...f),t.text(i.cor_number||"COR",l-s,a+12,{align:"right"}),a+=25,t.setDrawColor(...f),t.setLineWidth(.5),t.line(s,a,l-s,a),a+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(i.title||"Untitled Change Order",s,a),a+=8,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),u?.name&&(t.text(`Project: ${u.name}`,s,a),a+=5),u?.job_number&&(t.text(`Job #: ${u.job_number}`,s,a),a+=5),(i.period_start||i.period_end)&&(t.text(`Period: ${_e(i.period_start,i.period_end)}`,s,a),a+=5),a+=5,i.scope_of_work){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("Scope of Work:",s,a),a+=5,t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const o=t.splitTextToSize(i.scope_of_work,l-s*2);t.text(o,s,a),a+=o.length*4+8}i.change_order_labor?.length>0&&(t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Labor",s,a),a+=5,G(t,{startY:a,head:[["Class","Wage Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:i.change_order_labor.map(o=>[o.labor_class,o.wage_type||"Standard",o.regular_hours?.toString()||"0",c(o.regular_rate),o.overtime_hours?.toString()||"0",c(o.overtime_rate),c(o.total)]),foot:[[{content:"Labor Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.labor_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:f,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),i.change_order_materials?.length>0&&(a>p-60&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Materials",s,a),a+=5,G(t,{startY:a,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_materials.map(o=>[o.description,o.source_reference||o.source_type||"-",o.quantity?.toString()||"1",o.unit||"ea",c(o.unit_cost),c(o.total)]),foot:[[{content:"Materials Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.materials_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:f,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),i.change_order_equipment?.length>0&&(a>p-60&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Equipment",s,a),a+=5,G(t,{startY:a,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_equipment.map(o=>[o.description,o.source_reference||o.source_type||"-",o.quantity?.toString()||"1",o.unit||"day",c(o.unit_cost),c(o.total)]),foot:[[{content:"Equipment Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.equipment_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:f,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),i.change_order_subcontractors?.length>0&&(a>p-60&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Subcontractors",s,a),a+=5,G(t,{startY:a,head:[["Company Name","Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_subcontractors.map(o=>[o.company_name||"-",o.description,o.source_reference||o.source_type||"-",o.quantity?.toString()||"1",o.unit||"lump sum",c(o.unit_cost),c(o.total)]),foot:[[{content:"Subcontractors Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.subcontractors_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:f,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),a>p-100&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Cost Summary",s,a),a+=5;const S=[["Labor Subtotal",c(i.labor_subtotal)],[`  Markup (${T(i.labor_markup_percent)})`,c(i.labor_markup_amount)],["Materials Subtotal",c(i.materials_subtotal)],[`  Markup (${T(i.materials_markup_percent)})`,c(i.materials_markup_amount)],["Equipment Subtotal",c(i.equipment_subtotal)],[`  Markup (${T(i.equipment_markup_percent)})`,c(i.equipment_markup_amount)],["Subcontractors Subtotal",c(i.subcontractors_subtotal)],[`  Markup (${T(i.subcontractors_markup_percent)})`,c(i.subcontractors_markup_amount)]];G(t,{startY:a,body:S,margin:{left:s,right:s},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),a=t.lastAutoTable.finalY+5,t.setFillColor(248,250,252),t.rect(s,a,l-s*2,8,"F"),t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(30,41,59),t.text("COR Subtotal:",s+5,a+5.5),t.text(c(i.cor_subtotal),l-s-5,a+5.5,{align:"right"}),a+=12;const O=[[`Liability Insurance (${T(i.liability_insurance_percent)})`,c(i.liability_insurance_amount)],[`Bond (${T(i.bond_percent)})`,c(i.bond_amount)],[`License Fee (${T(i.license_fee_percent)})`,c(i.license_fee_amount)]];if(G(t,{startY:a,body:O,margin:{left:s,right:s},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),a=t.lastAutoTable.finalY+5,t.setFillColor(...f),t.rect(s,a,l-s*2,10,"F"),t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(255,255,255),t.text("COR TOTAL:",s+5,a+7),t.text(c(i.cor_total),l-s-5,a+7,{align:"right"}),a+=20,h.length>0){t.addPage(),a=s,j?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...f),t.text(j.name,s,a),a+=15),t.setDrawColor(...f),t.setLineWidth(.8),t.line(s,a,l-s,a),a+=3,t.setLineWidth(.3),t.line(s,a,l-s,a),a+=15,t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",l/2,a,{align:"center"}),a+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("Change Order Request Backup",l/2,a,{align:"center"}),a+=20,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`COR Reference: ${i.cor_number}`,s,a),a+=6,t.setFont("helvetica","normal"),t.setTextColor(71,85,105),u?.name&&(t.text(`Project: ${u.name}`,s,a),a+=5),u?.job_number&&(t.text(`Job #: ${u.job_number}`,s,a),a+=5),a+=15,t.setFillColor(248,250,252),t.setDrawColor(226,232,240),t.roundedRect(s,a,l-s*2,55,3,3,"FD"),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",s+10,a+12),t.setDrawColor(226,232,240),t.line(s+10,a+16,l-s-10,a+16);const o=s+15,E=s+80;let v=a+25;t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("T&M Tickets:",o,v),t.setFont("helvetica","bold"),t.text(String(h.length),E,v),t.setFont("helvetica","normal"),v+=7,t.text("Total Labor:",o,v),t.setFont("helvetica","bold"),t.text(`${n.totals.totalLaborHours.toFixed(1)} hrs`,E,v),t.setFont("helvetica","normal"),v+=7,n.totals.totalOTHours>0&&(t.text("Total OT:",o,v),t.setFont("helvetica","bold"),t.text(`${n.totals.totalOTHours.toFixed(1)} hrs`,E,v),t.setFont("helvetica","normal"),v+=7),t.text("Photo Evidence:",o,v),t.setFont("helvetica","bold"),t.text(`${n.totals.photoCount} photos`,E,v),t.setFont("helvetica","normal"),v+=7,t.text("Client Verified:",o,v),t.setFont("helvetica","bold");const se=n.totals.verifiedTicketCount>0?[16,185,129]:[71,85,105];t.setTextColor(...se),t.text(`${n.totals.verifiedTicketCount} of ${h.length} tickets`,E,v),a+=70,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const A=new Date(n.createdAt);t.text(`Generated: ${A.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${A.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,s,a),a+=6,t.text(`Document ID: ${n.checksum.substring(0,16).toUpperCase()}`,s,a);for(const g of h){t.addPage(),a=s;const K=!!g.client_signature_data,L=22,k=K?[16,185,129]:[245,158,11];if(t.setFillColor(...k),t.rect(s,a,4,L,"F"),t.setFillColor(248,250,252),t.rect(s+4,a,l-s*2-4,L,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`T&M TICKET — ${B(g.work_date||g.ticket_date)}`,s+10,a+8),g.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${g.ce_pco_number}`,s+10,a+16)),K&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",l-s-35,a+12)),a+=L+8,g.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",s,a),a+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const m=t.splitTextToSize(g.notes,l-s*2);t.text(m,s,a),a+=m.length*4+10}if(g.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",s,a),a+=6,G(t,{startY:a,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:g.t_and_m_workers.map(m=>[m.name,Xe(m),m.role||m.labor_class||"Laborer",m.hours?.toString()||"0",m.overtime_hours?.toString()||"-"]),margin:{left:s,right:s},headStyles:{fillColor:f,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),a=t.lastAutoTable.finalY+10),g.t_and_m_items?.length>0&&(a>p-60&&(t.addPage(),a=s),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",s,a),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: T&M Ticket",s+55,a),a+=6,G(t,{startY:a,head:[["Item","Qty","Unit"]],body:g.t_and_m_items.map(m=>[m.custom_name||m.materials_equipment?.name||m.description||"Unnamed Item",m.quantity?.toString()||"1",m.materials_equipment?.unit||m.unit||"ea"]),margin:{left:s,right:s},headStyles:{fillColor:f,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),a=t.lastAutoTable.finalY+10),g.photos?.length>0){a>p-80&&(t.addPage(),a=s),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",s,a),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${g.photos.length} photo${g.photos.length!==1?"s":""}`,s+50,a),a+=8;let m=s;const R=55,F=45,U=6,J=3,Y=await Ce(g.photos);for(let P=0;P<g.photos.length;P++){P>0&&P%J===0&&(m=s,a+=F+U+4),a+F>p-20&&(t.addPage(),a=s,m=s);const M=Y[P];M?(t.setDrawColor(200,200,200),t.setLineWidth(1),t.rect(m-1,a-1,R+2,F+2,"S"),t.setFillColor(230,230,230),t.rect(m+2,a+2,R,F,"F"),t.addImage(M,"JPEG",m,a,R,F)):(t.setFillColor(245,245,245),t.rect(m,a,R,F,"F"),t.setDrawColor(200,200,200),t.rect(m,a,R,F,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",m+8,a+F/2)),m+=R+U}a+=F+12}if(g.client_signature_data){a>p-50&&(t.addPage(),a=s);const m=32,R=l-s*2;t.setFillColor(240,253,244),t.roundedRect(s,a,R,m,3,3,"F"),t.setFillColor(16,185,129),t.rect(s,a,4,m,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(s+4,a,s+R,a);const F=s+14,U=a+m/2;t.setFillColor(16,185,129),t.circle(F,U,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",F-2.5,U+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",s+26,a+10);try{t.addImage(g.client_signature_data,"PNG",s+26,a+13,50,16);const P=g.client_signature_name||"Client",M=g.client_signature_title||"",X=g.client_signature_company||"",Z=g.client_signature_date?B(g.client_signature_date):"",ee=s+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(P,ee,a+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(M||X)&&t.text(`${M}${M&&X?", ":""}${X}`,ee,a+18),Z&&(t.setTextColor(100,116,139),t.text(`Verified: ${Z}`,ee,a+24))}catch{const Y=g.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${Y}`,s+26,a+20)}}}}const d=t.internal.getNumberOfPages();for(let o=1;o<=d;o++){t.setPage(o);const E=p-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,s,E),t.text(`Page ${o} of ${d}`,l-s,E,{align:"right"})}const _=`${i.cor_number||"COR"}_${u?.job_number||"export"}${h.length?"_with_backup":""}.pdf`;return t.save(_),{success:!0,fileName:_,pageCount:d,sizeBytes:t.output().length}}const Ze=Object.freeze(Object.defineProperty({__proto__:null,generatePDFFromSnapshot:pe},Symbol.toStringTag,{value:"Module"}));function ct({cor:n,project:x,company:u,areas:j,onClose:y,onEdit:i,onShowToast:h,onStatusChange:t}){const[l,p]=z.useState(!0),[s,a]=z.useState(n),[f,S]=z.useState(!1),[O,d]=z.useState(!1),[_,o]=z.useState(new Set),[E,v]=z.useState(null),[se,A]=z.useState(!1),[g,K]=z.useState(""),L=z.useCallback(async()=>{try{const r=await q.getCORById(n.id);if(r){if(r.tickets?.length){const b=r.tickets.map(w=>w.photos||[]),N=b.flat();if(N.length){const w=await q.resolvePhotoUrls(N);let D=0;r.tickets=r.tickets.map((I,C)=>{const $=b[C].length,je=w.slice(D,D+$);return D+=$,{...I,photos:je}})}}a(r)}}catch(r){console.error("Error fetching COR details:",r),h?.("Error loading COR details","error")}finally{p(!1)}},[n.id]);z.useEffect(()=>{L()},[L]),z.useEffect(()=>{const r=q.subscribeToCorTickets?.(n.id,()=>{L()});return()=>{r&&q.unsubscribe?.(r)}},[n.id,L]);const k=z.useMemo(()=>Le(s),[s]),m=Ue(s.status),R=s.status==="pending_approval",F=["draft","pending_approval","approved"].includes(s.status),U=r=>j?.find(N=>N.id===r)?.name||null,J=async()=>{if(confirm("Approve this change order request?")){p(!0);try{await q.approveCOR(s.id),a({...s,status:"approved",approved_at:new Date().toISOString()}),h?.("COR approved","success"),t?.()}catch(r){console.error("Error approving COR:",r),h?.("Error approving COR","error")}finally{p(!1)}}},Y=async()=>{const r=prompt("Enter rejection reason (optional):");if(r!==null){p(!0);try{await q.rejectCOR(s.id,r),a({...s,status:"rejected",rejection_reason:r}),h?.("COR rejected","success"),t?.()}catch(b){console.error("Error rejecting COR:",b),h?.("Error rejecting COR","error")}finally{p(!1)}}},P=async()=>{if(confirm("Mark this COR as billed?")){p(!0);try{await q.markCORAsBilled(s.id),a({...s,status:"billed"}),h?.("COR marked as billed","success"),t?.()}catch(r){console.error("Error marking COR as billed:",r),h?.("Error updating status","error")}finally{p(!1)}}},M=async r=>{p(!0);try{await q.saveCORSignature?.(s.id,{gc_signature:r.signature,gc_signer_name:r.signerName,signed_at:r.signedAt}),a({...s,gc_signature:r.signature,gc_signer_name:r.signerName,signed_at:r.signedAt}),S(!1),h?.("Signature saved","success"),t?.()}catch(b){console.error("Error saving signature:",b),h?.("Error saving signature","error")}finally{p(!1)}},X=s.status==="approved"&&!s.gc_signature,Z=async()=>{if(!g.trim()){A(!1);return}p(!0);try{await q.updateCOR(s.id,{cor_number:g.trim()}),a({...s,cor_number:g.trim()}),A(!1),h?.("COR number updated","success")}catch(r){console.error("Error updating COR number:",r),h?.("Error updating COR number","error")}finally{p(!1)}},ee=()=>{K(s.cor_number||""),A(!0)},ge=r=>{o(b=>{const N=new Set(b);return N.has(r)?N.delete(r):N.add(r),N})},W=z.useMemo(()=>s.change_order_ticket_associations?.map(r=>r.t_and_m_tickets).filter(Boolean)||[],[s.change_order_ticket_associations]),xe=r=>{const b=r.t_and_m_workers||[],N=b.reduce((D,I)=>D+(parseFloat(I.hours)||0),0),w=b.reduce((D,I)=>D+(parseFloat(I.overtime_hours)||0),0);return{regular:N,overtime:w,total:N+w}},be=async()=>{const r={logoUrl:u?.logo_url,primaryColor:u?.branding_color};try{h?.("Generating PDF...","info");const b=await Je(s.id,{cor:s,tickets:W,project:x,company:u,branding:r,options:{includeBackup:!0}});h?.(b.cached?"PDF downloaded (cached)":"PDF downloaded","success")}catch(b){console.warn("Export pipeline unavailable, using direct generation:",b?.message);try{const N=me(s,W);await pe(N,{project:x,company:u,branding:r}),h?.("PDF downloaded","success")}catch(N){console.error("Error generating PDF:",N),h?.("Error generating PDF","error")}}};return l?e.jsx("div",{className:"modal-overlay",onClick:y,children:e.jsx("div",{className:"modal-content cor-detail-modal",onClick:r=>r.stopPropagation(),children:e.jsx("div",{className:"cor-detail-loading",children:"Loading COR details..."})})}):e.jsxs("div",{className:"modal-overlay",onClick:y,role:"dialog","aria-modal":"true","aria-labelledby":"cor-detail-title",children:[e.jsxs("div",{className:"modal-content cor-detail-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"modal-header cor-detail-header",children:[e.jsxs("div",{className:"cor-detail-title-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"cor-detail-number",children:se?e.jsxs("div",{className:"cor-number-edit",children:[e.jsx("input",{type:"text",value:g,onChange:r=>K(r.target.value),onKeyDown:r=>{r.key==="Enter"&&Z(),r.key==="Escape"&&A(!1)},autoFocus:!0,className:"cor-number-input"}),e.jsx("button",{className:"btn-icon-sm",onClick:Z,title:"Save",children:e.jsx(ve,{size:14})}),e.jsx("button",{className:"btn-icon-sm",onClick:()=>A(!1),title:"Cancel",children:e.jsx(ae,{size:14})})]}):e.jsxs("div",{className:"cor-number-display",children:[e.jsx("span",{children:s.cor_number}),F&&e.jsx("button",{className:"btn-icon-sm",onClick:ee,title:"Edit COR number",children:e.jsx(Ne,{size:12})})]})}),e.jsx("h2",{id:"cor-detail-title",children:s.title||"Untitled COR"})]}),e.jsx("button",{className:"close-btn",onClick:y,"aria-label":"Close COR details",children:e.jsx(ae,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"cor-detail-meta",children:[e.jsx("span",{className:"cor-detail-status",style:{backgroundColor:m.bgColor,color:m.color},children:m.label}),s.group_name&&e.jsx("span",{className:"cor-detail-group",children:s.group_name}),U(s.area_id)&&e.jsx("span",{className:"cor-detail-area",children:U(s.area_id)}),e.jsxs("span",{className:"cor-detail-period",children:[e.jsx(Se,{size:14})," ",_e(s.period_start,s.period_end)]})]})]}),e.jsxs("div",{className:"modal-body cor-detail-body",children:[e.jsxs("div",{className:"cor-detail-section",children:[e.jsxs("h3",{children:[e.jsx(re,{size:18})," Scope of Work"]}),e.jsx("p",{className:"cor-scope-text",children:s.scope_of_work||"No scope of work provided."})]}),e.jsxs("div",{className:"cor-detail-section pricing-breakdown",children:[e.jsxs("h3",{children:[e.jsx(le,{size:18})," Pricing Breakdown"]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ce,{size:16}),e.jsx("span",{children:"Labor"})]}),e.jsx("span",{className:"category-subtotal",children:c(k.labor_subtotal)})]}),s.change_order_labor?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"Reg Rate"}),e.jsx("th",{children:"OT Hrs"}),e.jsx("th",{children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:s.change_order_labor.map((r,b)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.labor_class}),e.jsx("td",{children:r.wage_type}),e.jsx("td",{children:r.regular_hours}),e.jsxs("td",{children:["$",te(r.regular_rate),"/hr"]}),e.jsx("td",{children:r.overtime_hours||"-"}),e.jsx("td",{children:r.overtime_hours?`$${te(r.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:c(r.total)})]},b))})]})}):e.jsx("div",{className:"category-empty",children:"No labor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",T(s.labor_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",c(k.labor_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ke,{size:16}),e.jsx("span",{children:"Materials"})]}),e.jsx("span",{className:"category-subtotal",children:c(k.materials_subtotal)})]}),s.change_order_materials?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:s.change_order_materials.map((r,b)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{children:r.quantity}),e.jsx("td",{children:r.unit}),e.jsxs("td",{children:["$",te(r.unit_cost)]}),e.jsx("td",{className:"text-right",children:c(r.total)})]},b))})]})}):e.jsx("div",{className:"category-empty",children:"No material items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",T(s.materials_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",c(k.materials_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Fe,{size:16}),e.jsx("span",{children:"Equipment"})]}),e.jsx("span",{className:"category-subtotal",children:c(k.equipment_subtotal)})]}),s.change_order_equipment?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:s.change_order_equipment.map((r,b)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{children:r.quantity}),e.jsx("td",{children:r.unit}),e.jsxs("td",{children:["$",te(r.unit_cost)]}),e.jsx("td",{className:"text-right",children:c(r.total)})]},b))})]})}):e.jsx("div",{className:"category-empty",children:"No equipment items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",T(s.equipment_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",c(k.equipment_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Te,{size:16}),e.jsx("span",{children:"Subcontractors"})]}),e.jsx("span",{className:"category-subtotal",children:c(k.subcontractors_subtotal)})]}),s.change_order_subcontractors?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:s.change_order_subcontractors.map((r,b)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.company_name}),e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{className:"text-right",children:c(r.total)})]},b))})]})}):e.jsx("div",{className:"category-empty",children:"No subcontractor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",T(s.subcontractors_markup_percent||500),")"]}),e.jsxs("span",{children:["+",c(k.subcontractors_markup_amount)]})]})]}),e.jsxs("div",{className:"cor-subtotal-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:c(k.cor_subtotal)})]}),e.jsxs("div",{className:"pricing-category fees-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ze,{size:16}),e.jsx("span",{children:"Additional Fees"})]}),e.jsx("span",{className:"category-subtotal",children:c(k.additional_fees_total)})]}),e.jsxs("div",{className:"fees-list",children:[e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(Ee,{size:14}),e.jsxs("span",{children:["Liability Insurance (",T(s.liability_insurance_percent||144),")"]})]}),e.jsx("span",{className:"fee-amount",children:c(k.liability_insurance_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(re,{size:14}),e.jsxs("span",{children:["Bond (",T(s.bond_percent||100),")"]})]}),e.jsx("span",{className:"fee-amount",children:c(k.bond_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(Re,{size:14}),e.jsxs("span",{children:["City License Fee (",T(s.license_fee_percent||10),")"]})]}),e.jsx("span",{className:"fee-amount",children:c(k.license_fee_amount)})]})]})]}),e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:c(k.cor_total)})]})]}),W.length>0&&e.jsxs("div",{className:"cor-detail-section backup-section",children:[e.jsxs("h3",{children:[e.jsx(re,{size:18})," Backup Documentation"]}),e.jsxs("p",{className:"backup-summary",children:[W.length," T&M ticket",W.length!==1?"s":""," associated with this COR"]}),e.jsx("div",{className:"backup-tickets-list",children:W.map(r=>{const b=_.has(r.id),N=xe(r),w=r.t_and_m_workers?.length||0,D=r.t_and_m_items?.length||0,I=r.photos?.length||0;return e.jsxs("div",{className:"backup-ticket-card",children:[e.jsxs("div",{className:"backup-ticket-header",onClick:()=>ge(r.id),children:[e.jsx("div",{className:"backup-ticket-toggle",children:b?e.jsx(Oe,{size:18}):e.jsx(Pe,{size:18})}),e.jsxs("div",{className:"backup-ticket-info",children:[e.jsxs("div",{className:"backup-ticket-date",children:[e.jsx(we,{size:14}),e.jsx("span",{children:B(r.work_date)})]}),r.ce_pco_number&&e.jsxs("span",{className:"backup-ticket-pco",children:["CE/PCO: ",r.ce_pco_number]})]}),e.jsxs("div",{className:"backup-ticket-stats",children:[e.jsxs("span",{className:"backup-stat",children:[e.jsx(ce,{size:14})," ",w]}),e.jsxs("span",{className:"backup-stat",children:[N.total.toFixed(1)," hrs"]}),I>0&&e.jsxs("span",{className:"backup-stat",children:[e.jsx(De,{size:14})," ",I]}),r.client_signature_data&&e.jsxs("span",{className:"backup-stat verified",title:`Verified by ${r.client_signature_name}`,children:[e.jsx(ne,{size:14})," Verified"]})]}),e.jsx("span",{className:`backup-ticket-status status-${r.status}`,children:r.status})]}),b&&e.jsxs("div",{className:"backup-ticket-details",children:[r.notes&&e.jsxs("div",{className:"backup-ticket-notes",children:[e.jsx("strong",{children:"Notes:"})," ",r.notes]}),r.t_and_m_workers?.length>0&&e.jsxs("div",{className:"backup-workers",children:[e.jsxs("h4",{children:["Labor (",w," workers)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT Hrs"})]})}),e.jsx("tbody",{children:r.t_and_m_workers.map((C,$)=>e.jsxs("tr",{children:[e.jsx("td",{children:C.name}),e.jsx("td",{children:C.role||"-"}),e.jsx("td",{className:"backup-time-range",children:C.time_started&&C.time_ended?`${C.time_started} - ${C.time_ended}`:"-"}),e.jsx("td",{children:C.hours||0}),e.jsx("td",{children:C.overtime_hours||"-"})]},$))})]})]}),r.t_and_m_items?.length>0&&e.jsxs("div",{className:"backup-items",children:[e.jsxs("h4",{children:["Materials & Equipment (",D," items)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Qty"})]})}),e.jsx("tbody",{children:r.t_and_m_items.map((C,$)=>e.jsxs("tr",{children:[e.jsx("td",{children:C.custom_name||C.materials_equipment?.name||"Unnamed Item"}),e.jsx("td",{children:C.custom_category||C.materials_equipment?.category||"-"}),e.jsx("td",{children:C.quantity})]},$))})]})]}),r.photos?.length>0&&e.jsxs("div",{className:"backup-photos",children:[e.jsxs("h4",{children:["Photos (",I,")"]}),e.jsx("div",{className:"backup-photos-grid",children:r.photos.map((C,$)=>e.jsx("div",{className:"backup-photo-thumb",onClick:()=>v(C),children:e.jsx("img",{src:C,alt:`Photo ${$+1}`})},$))})]}),r.client_signature_data&&e.jsxs("div",{className:"backup-verification",children:[e.jsxs("h4",{children:[e.jsx(ne,{size:14})," Client Verification"]}),e.jsxs("div",{className:"backup-signature-display",children:[e.jsx("img",{src:r.client_signature_data,alt:"Client Signature",className:"backup-signature-image"}),e.jsxs("div",{className:"backup-signature-info",children:[e.jsx("span",{className:"backup-signer-name",children:r.client_signature_name}),r.client_signature_title&&e.jsx("span",{className:"backup-signer-title",children:r.client_signature_title}),r.client_signature_company&&e.jsx("span",{className:"backup-signer-company",children:r.client_signature_company}),e.jsxs("span",{className:"backup-signed-date",children:["Verified: ",B(r.client_signature_date)]})]})]})]})]})]},r.id)})})]}),(s.gc_signature_data||s.gc_signature||s.client_signature_data)&&e.jsxs("div",{className:"cor-detail-section signature-section",children:[e.jsxs("h3",{children:[e.jsx(Ie,{size:18})," Signatures"]}),e.jsxs("div",{className:"dual-signatures",children:[(s.gc_signature_data||s.gc_signature)&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"GC Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:s.gc_signature_data||s.gc_signature,alt:"GC Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:s.gc_signature_name||s.gc_signer_name}),(s.gc_signature_title||s.gc_signature_company)&&e.jsxs("span",{className:"signer-org",children:[s.gc_signature_title,s.gc_signature_title&&s.gc_signature_company&&" - ",s.gc_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",B(s.gc_signature_date||s.signed_at)]})]})]})]}),s.client_signature_data&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"Client Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:s.client_signature_data,alt:"Client Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:s.client_signature_name}),(s.client_signature_title||s.client_signature_company)&&e.jsxs("span",{className:"signer-org",children:[s.client_signature_title,s.client_signature_title&&s.client_signature_company&&" - ",s.client_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",B(s.client_signature_date)]})]})]})]})]})]}),s.status==="rejected"&&s.rejection_reason&&e.jsxs("div",{className:"cor-detail-section rejection-section",children:[e.jsxs("h3",{children:[e.jsx(de,{size:18})," Rejection Reason"]}),e.jsx("p",{className:"rejection-text",children:s.rejection_reason})]})]}),e.jsxs("div",{className:"modal-footer cor-detail-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{children:["Created: ",B(s.created_at)]}),s.approved_at&&e.jsxs("span",{children:["Approved: ",B(s.approved_at)]})]}),e.jsxs("div",{className:"footer-actions",role:"group","aria-label":"COR actions",children:[F&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>i?.(s),disabled:l,"aria-label":"Edit this COR",children:[e.jsx($e,{size:16,"aria-hidden":"true"})," Edit"]}),R&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:Y,disabled:l,"aria-label":"Reject this COR",children:[e.jsx(de,{size:16,"aria-hidden":"true"})," Reject"]}),e.jsxs("button",{className:"btn btn-success",onClick:J,disabled:l,"aria-label":"Approve this COR",children:[e.jsx(qe,{size:16,"aria-hidden":"true"})," Approve"]})]}),X&&e.jsxs("button",{className:"btn btn-success",onClick:()=>S(!0),disabled:l,"aria-label":"Get GC signature for this COR",children:[e.jsx(ne,{size:16,"aria-hidden":"true"})," Get GC Signature"]}),(s.status==="approved"||s.status==="pending_approval")&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>d(!0),disabled:l,"aria-label":"Get shareable signature link",children:[e.jsx(Ae,{size:16,"aria-hidden":"true"})," Get Signature Link"]}),s.status==="approved"&&e.jsxs("button",{className:"btn btn-primary",onClick:P,disabled:l,"aria-label":"Mark this COR as billed",children:[e.jsx(le,{size:16,"aria-hidden":"true"})," Mark Billed"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Ge(s),"aria-label":"Export COR to CSV",children:[e.jsx(ue,{size:16,"aria-hidden":"true"})," Export CSV"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:be,"aria-label":"Export COR to PDF",children:[e.jsx(ue,{size:16,"aria-hidden":"true"})," Export PDF"]})]})]})]}),f&&e.jsx(Be,{onSave:M,onClose:()=>S(!1),signerName:""}),O&&e.jsx(He,{documentType:"cor",documentId:s.id,companyId:u?.id,projectId:x?.id,project:x,documentTitle:`COR ${s.cor_number}: ${s.title||"Untitled"}`,onClose:()=>d(!1),onShowToast:h}),E&&e.jsxs("div",{className:"photo-lightbox",onClick:()=>v(null),children:[e.jsx("button",{className:"lightbox-close",onClick:()=>v(null),children:e.jsx(ae,{size:24})}),e.jsx("img",{src:E,alt:"Full size photo",onClick:r=>r.stopPropagation()})]})]})}export{ct as default};
//# sourceMappingURL=CORDetail-a9ut3grX.js.map
