const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SignatureLinkGenerator-CmyCQfb9.js","assets/react-BSqwb0tX.js","assets/icons-B4eeUMwP.js","assets/pdf-DgmPe6PY.js","assets/supabase-CJTGJ4KY.js","assets/recharts-CI1uxbzf.js","assets/TMClientSignature-DfSsjNK_.js","assets/Dashboard-BNKOiQvY.js","assets/corCalculations-vdJc_BOT.js","assets/Setup-Dl_F6HnT.js","assets/BrandingSettings-Dvt1RgCd.js","assets/PricingManager-CjUu-DHD.js","assets/PublicView-BZfZeKDn.js","assets/SignaturePage-UzUrubot.js","assets/SignatureCanvas-ClNi7ES9.js","assets/MembershipManager-B7BCoaXP.js"])))=>i.map(i=>d[i]);
import{r as m,j as e,d as Cs,e as Es}from"./react-BSqwb0tX.js";import{_ as Je}from"./pdf-DgmPe6PY.js";import{c as ts}from"./supabase-CJTGJ4KY.js";import{H as ot,B as qs,A as Se,C as jt,U as rs,a as Ds,b as rt,E as Rs,c as Ps,S as ss,M as as,T as Gt,D as ns,X as wr,d as os,L as pt,F as ct,e as it,f as xr,g as Ts,h as As,i as pr,j as Os,k as Ve,R as Rr,P as wt,l as Ls,W as Ms,Z as Fs,G as $s,m as Is,n as zs,o as Bt,p as Pr,q as $t,r as Us,s as is,t as Wt,u as cs,v as Hs,w as Bs,x as Ws,y as Vs,z as yt,I as Gs,J as Ks,K as Ys,N as ls,O as ds,Q as Js,V as Qs,Y as Xs,_ as Zs,$ as ea,a0 as us,a1 as ta,a2 as ra,a3 as sa,a4 as aa,a5 as na,a6 as Tr,a7 as oa,a8 as ia,a9 as ca,aa as la}from"./icons-B4eeUMwP.js";import{R as sr,P as da,a as ua,C as ma,T as ar,B as pa,b as Ar,X as Or,Y as Lr,c as ha,L as fa,d as ga}from"./recharts-CI1uxbzf.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();function _a(t,r,s=[]){if(!t||!r)return{hasConflict:!1,conflicts:[]};const a=new Date(t._offlineModifiedAt||t.updated_at||0),n=new Date(r.updated_at||0),o=new Date(t._cachedAt||0);if(n<=o)return{hasConflict:!1,conflicts:[]};const i=[],c=s.length>0?s:Object.keys(t).filter(l=>!l.startsWith("_")&&l!=="id"&&l!=="created_at");for(const l of c){const h=t[l],_=r[l];if(h!==void 0&&_!==void 0&&!It(h,_)){const p=t._cachedValues?.[l],x=p!==void 0?!It(h,p):!0,F=p!==void 0?!It(_,p):!0;x&&F&&i.push({field:l,localValue:h,serverValue:_,cachedValue:p})}}return{hasConflict:i.length>0,conflicts:i,localModifiedAt:a,serverUpdatedAt:n}}function It(t,r){if(t===r)return!0;if(t==null||r==null)return t===r;if(typeof t!=typeof r)return!1;if(typeof t!="object")return t===r;if(Array.isArray(t)!==Array.isArray(r))return!1;const s=Object.keys(t),a=Object.keys(r);return s.length!==a.length?!1:s.every(n=>It(t[n],r[n]))}const ya={KEEP_LOCAL:"keep_local",KEEP_SERVER:"keep_server",MERGE:"merge"};function ba(t,r=[]){const s={...t,_cachedAt:new Date().toISOString()};if(r.length>0){s._cachedValues={};for(const a of r)t[a]!==void 0&&(s._cachedValues[a]=JSON.parse(JSON.stringify(t[a])))}return s}function ja(t,r="record"){if(!t.hasConflict)return null;if(t.deletedOnServer)return{title:`${Mr(r)} was deleted`,description:`This ${r} was deleted by another user while you were offline.`,severity:"warning",conflictCount:1};const s=t.conflicts.map(a=>a.field).join(", ");return{title:`${Mr(r)} was modified`,description:`The following fields were changed by another user: ${s}`,severity:t.conflicts.length>2?"warning":"info",conflictCount:t.conflicts.length,fields:t.conflicts}}function Mr(t){return t.charAt(0).toUpperCase()+t.slice(1)}const wa="fieldsync-offline",xa=2,pe={PROJECTS:"projects",AREAS:"areas",CREW_CHECKINS:"crew_checkins",TM_TICKETS:"tm_tickets",DAILY_REPORTS:"daily_reports",MESSAGES:"messages",PENDING_ACTIONS:"pending_actions",CACHED_DATA:"cached_data"};let nt=null;const Qe=()=>new Promise((t,r)=>{if(nt){t(nt);return}const s=indexedDB.open(wa,xa);s.onerror=()=>{console.error("Failed to open offline database"),r(s.error)},s.onsuccess=()=>{nt=s.result,t(nt)},s.onupgradeneeded=a=>{const n=a.target.result;if(n.objectStoreNames.contains(pe.PROJECTS)||n.createObjectStore(pe.PROJECTS,{keyPath:"id"}).createIndex("company_id","company_id",{unique:!1}),n.objectStoreNames.contains(pe.AREAS)||n.createObjectStore(pe.AREAS,{keyPath:"id"}).createIndex("project_id","project_id",{unique:!1}),n.objectStoreNames.contains(pe.CREW_CHECKINS)||n.createObjectStore(pe.CREW_CHECKINS,{keyPath:"id"}).createIndex("project_id","project_id",{unique:!1}),n.objectStoreNames.contains(pe.TM_TICKETS)||n.createObjectStore(pe.TM_TICKETS,{keyPath:"id"}).createIndex("project_id","project_id",{unique:!1}),n.objectStoreNames.contains(pe.DAILY_REPORTS)||n.createObjectStore(pe.DAILY_REPORTS,{keyPath:"id"}).createIndex("project_id","project_id",{unique:!1}),n.objectStoreNames.contains(pe.MESSAGES)||n.createObjectStore(pe.MESSAGES,{keyPath:"id"}).createIndex("project_id","project_id",{unique:!1}),!n.objectStoreNames.contains(pe.PENDING_ACTIONS)){const o=n.createObjectStore(pe.PENDING_ACTIONS,{keyPath:"id",autoIncrement:!0});o.createIndex("type","type",{unique:!1}),o.createIndex("created_at","created_at",{unique:!1})}n.objectStoreNames.contains(pe.CACHED_DATA)||n.createObjectStore(pe.CACHED_DATA,{keyPath:"key"})}}),lt=(t,r="readonly")=>{if(!nt)throw new Error("Database not initialized");return nt.transaction(t,r).objectStore(t)},xt=async(t,r)=>(await Qe(),new Promise((s,a)=>{const o=lt(t,"readwrite").put(r);o.onsuccess=()=>s(o.result),o.onerror=()=>a(o.error)})),ms=async(t,r)=>(await Qe(),new Promise((s,a)=>{const n=nt.transaction(t,"readwrite"),o=n.objectStore(t);r.forEach(i=>o.put(i)),n.oncomplete=()=>s(),n.onerror=()=>a(n.error)})),ps=async(t,r)=>(await Qe(),new Promise((s,a)=>{const o=lt(t).get(r);o.onsuccess=()=>s(o.result),o.onerror=()=>a(o.error)})),hs=async t=>(await Qe(),new Promise((r,s)=>{const n=lt(t).getAll();n.onsuccess=()=>r(n.result||[]),n.onerror=()=>s(n.error)})),vr=async(t,r,s)=>(await Qe(),new Promise((a,n)=>{const c=lt(t).index(r).getAll(s);c.onsuccess=()=>a(c.result||[]),c.onerror=()=>n(c.error)})),va=async(t,r)=>(await Qe(),new Promise((s,a)=>{const o=lt(t,"readwrite").delete(r);o.onsuccess=()=>s(),o.onerror=()=>a(o.error)})),ve={UPDATE_AREA_STATUS:"UPDATE_AREA_STATUS",CREATE_TM_TICKET:"CREATE_TM_TICKET",SAVE_CREW_CHECKIN:"SAVE_CREW_CHECKIN",SUBMIT_DAILY_REPORT:"SUBMIT_DAILY_REPORT",SEND_MESSAGE:"SEND_MESSAGE",CREATE_MATERIAL_REQUEST:"CREATE_MATERIAL_REQUEST"},ze=async(t,r,s={})=>{await Qe();const a={type:t,payload:r,metadata:s,created_at:new Date().toISOString(),attempts:0,last_error:null};return new Promise((n,o)=>{const c=lt(pe.PENDING_ACTIONS,"readwrite").add(a);c.onsuccess=()=>{n(c.result)},c.onerror=()=>o(c.error)})},fs=async()=>hs(pe.PENDING_ACTIONS),zt=async()=>(await fs()).length,Fr=async t=>va(pe.PENDING_ACTIONS,t),Na=async(t,r)=>(await Qe(),new Promise((s,a)=>{const n=lt(pe.PENDING_ACTIONS,"readwrite"),o=n.get(t);o.onsuccess=()=>{const i=o.result;if(i){const c={...i,...r},l=n.put(c);l.onsuccess=()=>s(c),l.onerror=()=>a(l.error)}else a(new Error("Action not found"))},o.onerror=()=>a(o.error)})),ka=async t=>ms(pe.PROJECTS,t),$r=async t=>t?vr(pe.PROJECTS,"company_id",t):hs(pe.PROJECTS),Sa=async t=>{const r=t.map(s=>ba(s,["status","weight","name"]));return ms(pe.AREAS,r)},Ir=async t=>vr(pe.AREAS,"project_id",t),nr=async(t,r)=>{const s=await ps(pe.AREAS,t);return s&&(s.status=r,s.updated_at=new Date().toISOString(),s._offlineModifiedAt=new Date().toISOString(),await xt(pe.AREAS,s)),s},Tt=async t=>xt(pe.CREW_CHECKINS,t),zr=async t=>xt(pe.TM_TICKETS,t),Oe=()=>{const t=new Uint8Array(6);crypto.getRandomValues(t);const r=Array.from(t,s=>s.toString(36)).join("");return`temp_${Date.now()}_${r}`},ut=async t=>xt(pe.DAILY_REPORTS,t),Ca=async(t,r)=>(await vr(pe.DAILY_REPORTS,"project_id",t)).find(a=>a.report_date===r)||null,Ur=async t=>xt(pe.MESSAGES,t);let Nr=typeof navigator<"u"?navigator.onLine:!0;const hr=new Set,kr=t=>(hr.add(t),()=>hr.delete(t)),We=()=>Nr,Hr=t=>{Nr=t,hr.forEach(r=>r(t))};typeof window<"u"&&(window.addEventListener("online",()=>{Hr(!0)}),window.addEventListener("offline",()=>{Hr(!1)}));let or=!1;const gs=async(t,r={})=>{if(or||!Nr)return{synced:0,failed:0,conflicts:[]};const{onConflict:s}=r;or=!0;const a={synced:0,failed:0,conflicts:[]};try{const n=await fs();for(const o of n)try{if(o.payload?.id&&o.type===ve.UPDATE_AREA_STATUS){const i=await Ea(t,o.type,o.payload);if(i){const c=await ps(pe.AREAS,o.payload.areaId||o.payload.id);if(c){const l=_a(c,i,["status"]);if(l.hasConflict){const h=ja(l,"area");if(a.conflicts.push({action:o,conflict:l,summary:h}),s&&await s({action:o,conflict:l,summary:h})===ya.KEEP_SERVER){await Fr(o.id);continue}}}}}await qa(o,t),await Fr(o.id),a.synced++}catch(i){a.failed++,await Na(o.id,{attempts:(o.attempts||0)+1,last_error:i.message,last_attempt:new Date().toISOString()})}}finally{or=!1}return a},Ea=async(t,r,s)=>{try{switch(r){case ve.UPDATE_AREA_STATUS:return t.getArea?await t.getArea(s.areaId):null;default:return null}}catch{return null}},qa=async(t,r)=>{const{type:s,payload:a}=t;switch(s){case ve.UPDATE_AREA_STATUS:return r.updateAreaStatus(a.areaId,a.status);case ve.CREATE_TM_TICKET:{const n=await r.createTMTicket(a.ticket);return a.workers?.length>0&&await r.addTMWorkers(n.id,a.workers),a.items?.length>0&&await r.addTMItems(n.id,a.items),n}case ve.SAVE_CREW_CHECKIN:return r.saveCrewCheckin(a.projectId,a.workers,a.checkInDate);case ve.SUBMIT_DAILY_REPORT:return await r.saveDailyReport(a.projectId,a.reportData),r.submitDailyReport(a.projectId,a.submittedBy);case ve.SEND_MESSAGE:return r.sendMessage(a.projectId,a.senderType,a.senderName,a.content);case ve.CREATE_MATERIAL_REQUEST:return r.createMaterialRequest(a.projectId,a.items,a.requestedBy,a.neededBy,a.priority,a.notes);default:throw new Error(`Unknown action type: ${s}`)}},Sr="",_s="",u=!!Sr,d=u?ts(Sr,_s):null,At={slowQueryThreshold:200,enableSupabase:u},ne={query(t,r){const s={type:"query",operation:t,duration_ms:r.duration,rows_returned:r.rows,company_id:r.company_id||null,project_id:r.project_id||null,user_id:r.user_id||null,timestamp:new Date().toISOString()};At.enableSupabase&&r.duration>=At.slowQueryThreshold&&ir("query",s)},error(t,r){const s={type:"error",category:t,severity:r.severity||"error",error_code:r.code||null,message:r.message,company_id:r.company_id||null,user_id:r.user_id||null,project_id:r.project_id||null,operation:r.operation||null,context:r.extra||{},timestamp:new Date().toISOString()};At.enableSupabase&&ir("error",s)},storage(t,r){const s={type:"storage",operation:t,company_id:r.company_id||null,project_id:r.project_id||null,file_size_bytes:r.size||0,duration_ms:r.duration||0,success:r.success!==!1,error_message:r.error||null,timestamp:new Date().toISOString()};At.enableSupabase&&(!s.success||s.duration_ms>5e3)&&ir("storage",s)},activity(t,r){}};async function ir(t,r){if(d)try{t==="error"?await d.rpc("log_error",{p_severity:r.severity,p_category:r.category,p_message:r.message,p_company_id:r.company_id,p_user_id:r.user_id,p_project_id:r.project_id,p_operation:r.operation,p_error_code:r.error_code,p_context:r.context||{}}):t==="query"&&await d.rpc("log_query_metric",{p_operation:r.operation,p_duration_ms:r.duration_ms,p_rows_returned:r.rows_returned,p_company_id:r.company_id,p_project_id:r.project_id,p_user_id:r.user_id,p_context:{}})}catch{}}ne.wrapQuery=function(t,r){return async function(...s){const a=performance.now();try{const n=await r.apply(this,s),i={duration:Math.round(performance.now()-a),rows:Array.isArray(n)?n.length:void 0};return ne.query(t,i),n}catch(n){const o=Math.round(performance.now()-a);throw ne.error("database",{message:n.message,operation:t,severity:"error",extra:{duration:o}}),n}}};ne.time=async function(t,r){const s=performance.now();try{const a=await r(),n=Math.round(performance.now()-s);return ne.query(t,{duration:n}),a}catch(a){throw ne.error("general",{message:a.message,operation:t}),a}};const fr="fieldsync_field_session";let bt=null;const vt=()=>{if(bt)return bt;try{const t=sessionStorage.getItem(fr);if(t)return bt=JSON.parse(t),bt}catch{}return null},gr=t=>{bt=t,t?sessionStorage.setItem(fr,JSON.stringify(t)):sessionStorage.removeItem(fr)},_r=async()=>{const t=vt();if(t?.token&&u)try{await d.rpc("invalidate_field_session",{p_session_token:t.token})}catch{}gr(null)};let ft=null;const Cr=()=>{const t=vt();return!t?.token||!u?d:((!ft||ft._sessionToken!==t.token)&&(ft=ts(Sr,_s,{global:{headers:{"x-field-session":t.token}}}),ft._sessionToken=t.token),ft)},yr=()=>vt()?.token?Cr():d,U=()=>u?vt()?.token?Cr():d:null,br=()=>{const t=vt();return!!(t?.token&&t?.projectId)},jr="fieldsync_data",Vt="fieldsync_user",Br={projects:[],areas:[],users:[],assignments:[]},V=()=>{try{const t=localStorage.getItem(jr);return t?JSON.parse(t):Br}catch{return localStorage.removeItem(jr),Br}},ie=t=>{localStorage.setItem(jr,JSON.stringify(t))},Ot=()=>{try{const t=localStorage.getItem(Vt);return t?JSON.parse(t):null}catch{return localStorage.removeItem(Vt),null}},Lt=t=>{t?localStorage.setItem(Vt,JSON.stringify(t)):localStorage.removeItem(Vt)},Da={async createCOR(t,r=0){if(u){let s=t.cor_number;r>0&&(s=await this.getNextCORNumber(t.project_id));const{data:a,error:n}=await d.from("change_orders").insert({company_id:t.company_id,project_id:t.project_id,area_id:t.area_id||null,cor_number:s,title:t.title,description:t.description||"",scope_of_work:t.scope_of_work,period_start:t.period_start,period_end:t.period_end,status:"draft",labor_markup_percent:t.labor_markup_percent??1500,materials_markup_percent:t.materials_markup_percent??1500,equipment_markup_percent:t.equipment_markup_percent??1500,subcontractors_markup_percent:t.subcontractors_markup_percent??500,liability_insurance_percent:t.liability_insurance_percent??144,bond_percent:t.bond_percent??100,license_fee_percent:t.license_fee_percent??10,created_by:t.created_by||null}).select().single();if((n?.code==="23505"||n?.code==="PGRST116"||n?.status===409||n?.message?.includes("duplicate")||n?.message?.includes("unique_cor_number"))&&r<3)return console.warn(`COR number conflict, retrying with fresh number (attempt ${r+1})`),this.createCOR(t,r+1);if(n)throw n;return a}return null},async updateCOR(t,r){if(u){const{data:s,error:a}=await d.from("change_orders").update({...r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw a;return s}return null},async deleteCOR(t){if(u){const{error:r}=await d.from("change_orders").delete().eq("id",t);if(r)throw r}},async bulkUpdateCORGroup(t,r){if(u){const{error:s}=await d.from("change_orders").update({group_name:r,updated_at:new Date().toISOString()}).in("id",t);if(s)throw s.message?.includes("group_name")||s.code==="PGRST204"?new Error("COR grouping requires a database migration. Please run database/migration_cor_enhancements.sql in Supabase SQL Editor."):s}},async getCORs(t,r={}){if(u){let s=d.from("change_orders").select(`
          *,
          areas (id, name),
          labor_count:change_order_labor(count),
          materials_count:change_order_materials(count),
          equipment_count:change_order_equipment(count),
          subcontractors_count:change_order_subcontractors(count),
          tickets_count:change_order_ticket_associations(count)
        `).eq("project_id",t);r.status&&(s=s.eq("status",r.status)),r.area_id&&(s=s.eq("area_id",r.area_id)),r.date_start&&(s=s.gte("period_start",r.date_start)),r.date_end&&(s=s.lte("period_end",r.date_end)),s=s.order("created_at",{ascending:!1});const{data:a,error:n}=await s;if(n)throw n;return a}return[]},async getCORById(t){if(u){const{data:r,error:s}=await d.from("change_orders").select(`
          *,
          areas (id, name),
          change_order_labor (*),
          change_order_materials (*),
          change_order_equipment (*),
          change_order_subcontractors (*),
          change_order_ticket_associations (
            *,
            t_and_m_tickets (
              *,
              t_and_m_workers (*),
              t_and_m_items (
                *,
                materials_equipment (name, unit, cost_per_unit, category)
              )
            )
          )
        `).eq("id",t).single();if(s)throw s;return r}return null},async getCORsByArea(t,r){if(u){const{data:s,error:a}=await d.from("change_orders").select("*").eq("project_id",t).eq("area_id",r).order("created_at",{ascending:!1});if(a)throw a;return s}return[]},async getAssignableCORs(t){if(u){const r=U();if(!r)return[];const{data:s,error:a}=await r.from("change_orders").select("id, cor_number, title, status, cor_total").eq("project_id",t).in("status",["draft","pending_approval","approved"]).order("cor_number",{ascending:!0});if(a)throw a;return s||[]}return[]},async getNextCORNumber(t){if(u){const{data:r,error:s}=await d.from("change_orders").select("cor_number").eq("project_id",t);if(s)throw s;if(r&&r.length>0){let a=0;for(const n of r){const o=n.cor_number?.match(/COR #(\d+)/);if(o){const i=parseInt(o[1]);i>a&&(a=i)}}return`COR #${a+1}`}return"COR #1"}return"COR #1"},async addCORLaborItem(t,r){if(u){const s=Math.round(r.regular_hours*r.regular_rate),a=Math.round(r.overtime_hours*r.overtime_rate),n=s+a,{data:o,error:i}=await d.from("change_order_labor").insert({change_order_id:t,labor_class:r.labor_class,wage_type:r.wage_type||"standard",regular_hours:r.regular_hours||0,overtime_hours:r.overtime_hours||0,regular_rate:r.regular_rate||0,overtime_rate:r.overtime_rate||0,regular_total:s,overtime_total:a,total:n,sort_order:r.sort_order||0,source_ticket_id:r.source_ticket_id||null}).select().single();if(i)throw i;return o}return null},async updateCORLaborItem(t,r){if(u){let s={...r};if(r.regular_hours!==void 0||r.regular_rate!==void 0||r.overtime_hours!==void 0||r.overtime_rate!==void 0){const{data:o}=await d.from("change_order_labor").select("regular_hours, overtime_hours, regular_rate, overtime_rate").eq("id",t).single(),i=r.regular_hours??o?.regular_hours??0,c=r.overtime_hours??o?.overtime_hours??0,l=r.regular_rate??o?.regular_rate??0,h=r.overtime_rate??o?.overtime_rate??0;s.regular_total=Math.round(i*l),s.overtime_total=Math.round(c*h),s.total=s.regular_total+s.overtime_total}const{data:a,error:n}=await d.from("change_order_labor").update(s).eq("id",t).select().single();if(n)throw n;return a}return null},async deleteCORLaborItem(t){if(u){const{error:r}=await d.from("change_order_labor").delete().eq("id",t);if(r)throw r}},async addCORMaterialItem(t,r){if(u){const a=["backup_sheet","invoice","mobilization","custom","field_ticket","rental"].includes(r.source_type)?r.source_type:"custom",n=Math.round(Number(r.unit_cost)||0),o=Number(r.quantity)||1,i=Math.round(o*n),{data:c,error:l}=await d.from("change_order_materials").insert({change_order_id:t,description:r.description||"",quantity:o,unit:r.unit||"each",unit_cost:n,total:i,source_type:a,source_reference:r.source_reference||null,source_ticket_id:r.source_ticket_id||null,sort_order:r.sort_order||0}).select().single();if(l)throw l;return c}return null},async updateCORMaterialItem(t,r){if(u){let s={...r};if(r.quantity!==void 0||r.unit_cost!==void 0){const{data:o}=await d.from("change_order_materials").select("quantity, unit_cost").eq("id",t).single(),i=r.quantity??o?.quantity??1,c=r.unit_cost??o?.unit_cost??0;s.total=Math.round(i*c)}const{data:a,error:n}=await d.from("change_order_materials").update(s).eq("id",t).select().single();if(n)throw n;return a}return null},async deleteCORMaterialItem(t){if(u){const{error:r}=await d.from("change_order_materials").delete().eq("id",t);if(r)throw r}},async addCOREquipmentItem(t,r){if(u){const a=["backup_sheet","invoice","custom","field_ticket","rental"].includes(r.source_type)?r.source_type:"custom",n=Math.round(Number(r.unit_cost)||0),o=Number(r.quantity)||1,i=Math.round(o*n),{data:c,error:l}=await d.from("change_order_equipment").insert({change_order_id:t,description:r.description||"",quantity:o,unit:r.unit||"day",unit_cost:n,total:i,source_type:a,source_reference:r.source_reference||null,source_ticket_id:r.source_ticket_id||null,sort_order:r.sort_order||0}).select().single();if(l)throw l;return c}return null},async updateCOREquipmentItem(t,r){if(u){let s={...r};if(r.quantity!==void 0||r.unit_cost!==void 0){const{data:o}=await d.from("change_order_equipment").select("quantity, unit_cost").eq("id",t).single(),i=r.quantity??o?.quantity??1,c=r.unit_cost??o?.unit_cost??0;s.total=Math.round(i*c)}const{data:a,error:n}=await d.from("change_order_equipment").update(s).eq("id",t).select().single();if(n)throw n;return a}return null},async deleteCOREquipmentItem(t){if(u){const{error:r}=await d.from("change_order_equipment").delete().eq("id",t);if(r)throw r}},async addCORSubcontractorItem(t,r){if(u){const s=Math.round(r.quantity*r.unit_cost),{data:a,error:n}=await d.from("change_order_subcontractors").insert({change_order_id:t,description:r.description,quantity:r.quantity||1,unit:r.unit||"lump sum",unit_cost:r.unit_cost||0,total:s,source_type:r.source_type||"custom",source_reference:r.source_reference||null,sort_order:r.sort_order||0}).select().single();if(n)throw n;return a}return null},async updateCORSubcontractorItem(t,r){if(u){let s={...r};if(r.quantity!==void 0||r.unit_cost!==void 0){const{data:o}=await d.from("change_order_subcontractors").select("quantity, unit_cost").eq("id",t).single(),i=r.quantity??o?.quantity??1,c=r.unit_cost??o?.unit_cost??0;s.total=Math.round(i*c)}const{data:a,error:n}=await d.from("change_order_subcontractors").update(s).eq("id",t).select().single();if(n)throw n;return a}return null},async deleteCORSubcontractorItem(t){if(u){const{error:r}=await d.from("change_order_subcontractors").delete().eq("id",t);if(r)throw r}},async addBulkLaborItems(t,r){if(u&&r.length>0){const s=U();if(!s)throw new Error("Database client not available");const a=r.map((i,c)=>{const l=Math.round(i.regular_hours*i.regular_rate),h=Math.round(i.overtime_hours*i.overtime_rate);return{change_order_id:t,labor_class:i.labor_class,wage_type:i.wage_type||"standard",regular_hours:i.regular_hours||0,overtime_hours:i.overtime_hours||0,regular_rate:i.regular_rate||0,overtime_rate:i.overtime_rate||0,regular_total:l,overtime_total:h,total:l+h,sort_order:i.sort_order??c,source_ticket_id:i.source_ticket_id||null}}),{data:n,error:o}=await s.from("change_order_labor").insert(a).select();if(o)throw o;return n}return[]},async addBulkMaterialItems(t,r){if(u&&r.length>0){const s=U();if(!s)throw new Error("Database client not available");const a=["backup_sheet","invoice","mobilization","custom","field_ticket","rental"],n=r.map((c,l)=>{const h=a.includes(c.source_type)?c.source_type:"custom",_=Math.round(Number(c.unit_cost)||0),p=Number(c.quantity)||1;return{change_order_id:t,description:c.description||"",quantity:p,unit:c.unit||"each",unit_cost:_,total:Math.round(p*_),source_type:h,source_reference:c.source_reference||null,source_ticket_id:c.source_ticket_id||null,sort_order:c.sort_order??l}}),{data:o,error:i}=await s.from("change_order_materials").insert(n).select();if(i)throw i;return o}return[]},async addBulkEquipmentItems(t,r){if(u&&r.length>0){const s=U();if(!s)throw new Error("Database client not available");const a=["backup_sheet","invoice","custom","field_ticket","rental"],n=r.map((c,l)=>{const h=a.includes(c.source_type)?c.source_type:"custom",_=Math.round(Number(c.unit_cost)||0),p=Number(c.quantity)||1;return{change_order_id:t,description:c.description||"",quantity:p,unit:c.unit||"day",unit_cost:_,total:Math.round(p*_),source_type:h,source_reference:c.source_reference||null,source_ticket_id:c.source_ticket_id||null,sort_order:c.sort_order??l}}),{data:o,error:i}=await s.from("change_order_equipment").insert(n).select();if(i)throw i;return o}return[]},async addBulkSubcontractorItems(t,r){if(u&&r.length>0){const s=U();if(!s)throw new Error("Database client not available");const a=r.map((i,c)=>({change_order_id:t,company_name:i.company_name||"",description:i.description||"",quantity:i.quantity||1,unit:i.unit||"lump sum",unit_cost:i.unit_cost||i.total||i.amount||0,total:i.total||i.amount||0,source_type:i.source_type||"invoice",source_reference:i.source_reference||null,sort_order:i.sort_order??c})),{data:n,error:o}=await s.from("change_order_subcontractors").insert(a).select();if(o)throw o;return n}return[]},async clearCORLineItems(t){if(!u)return;const r=U();if(!r)throw new Error("Database client not available");try{const s=await Promise.all([r.from("change_order_labor").delete().eq("change_order_id",t),r.from("change_order_materials").delete().eq("change_order_id",t),r.from("change_order_equipment").delete().eq("change_order_id",t),r.from("change_order_subcontractors").delete().eq("change_order_id",t)]);for(const a of s)if(a.error)throw a.error}catch(s){throw console.error("Error clearing COR line items:",s),s}},async saveCORLineItems(t,{laborItems:r,materialItems:s,equipmentItems:a,subcontractorItems:n}){if(u){await this.clearCORLineItems(t);const o=await Promise.all([r?.length>0?this.addBulkLaborItems(t,r):[],s?.length>0?this.addBulkMaterialItems(t,s):[],a?.length>0?this.addBulkEquipmentItems(t,a):[],n?.length>0?this.addBulkSubcontractorItems(t,n):[]]);return{labor:o[0],materials:o[1],equipment:o[2],subcontractors:o[3]}}return null},async assignTicketToCOR(t,r){if(u){const{error:s}=await d.rpc("assign_ticket_to_cor",{p_ticket_id:t,p_cor_id:r});if(s)throw ne.error("database",{message:s.message,operation:"assignTicketToCOR",extra:{ticketId:t,corId:r}}),s;return{ticket_id:t,change_order_id:r}}return null},async unassignTicketFromCOR(t,r){if(u){const{error:s}=await d.rpc("unassign_ticket_from_cor",{p_ticket_id:t,p_cor_id:r});if(s)throw ne.error("database",{message:s.message,operation:"unassignTicketFromCOR",extra:{ticketId:t,corId:r}}),s}},async checkTicketCORIntegrity(){if(u){const{data:t,error:r}=await d.rpc("check_ticket_cor_integrity");if(r)throw r;return t||[]}return[]},async fixTicketCORIntegrity(){if(u){const{data:t,error:r}=await d.rpc("fix_ticket_cor_integrity");if(r)throw r;return t}return 0},async getTicketsForCOR(t){if(u){const{data:r,error:s}=await d.from("change_order_ticket_associations").select(`
          *,
          t_and_m_tickets (
            *,
            t_and_m_workers (*),
            t_and_m_items (
              *,
              materials_equipment (name, unit, cost_per_unit, category)
            )
          )
        `).eq("change_order_id",t);if(s)throw s;return r}return[]},async getUnassignedTickets(t){if(u){const{data:r,error:s}=await d.from("t_and_m_tickets").select(`
          *,
          t_and_m_workers (*),
          t_and_m_items (
            *,
            materials_equipment (name, unit, cost_per_unit, category)
          )
        `).eq("project_id",t).is("assigned_cor_id",null).order("work_date",{ascending:!1});if(s)throw s;return r}return[]},async importTicketDataToCOR(t,r,s,a,n){if(u){const o=U();if(!o)throw new Error("Database client not available");const{data:i,error:c}=await o.from("t_and_m_tickets").select(`
          *,
          t_and_m_workers (*),
          t_and_m_items (
            *,
            materials_equipment (name, unit, cost_per_unit, category)
          )
        `).eq("id",t).single();if(c)throw c;const{data:l,error:h}=await o.from("labor_rates").select("*").eq("company_id",s).eq("work_type",a||"demolition").eq("job_type",n||"standard");if(h)throw h;const _={};l?.forEach(v=>{_[v.role.toLowerCase()]=v});const p={};i.t_and_m_workers?.forEach(v=>{const M=(v.role||"laborer").toLowerCase();p[M]||(p[M]={regular_hours:0,overtime_hours:0}),p[M].regular_hours+=parseFloat(v.hours)||0,p[M].overtime_hours+=parseFloat(v.overtime_hours)||0});const x=Object.entries(p).map(([v,M])=>{const j=_[v]||{regular_rate:0,overtime_rate:0},E=Math.round((parseFloat(j.regular_rate)||0)*100),w=Math.round((parseFloat(j.overtime_rate)||0)*100);return{labor_class:v.charAt(0).toUpperCase()+v.slice(1),wage_type:n||"standard",regular_hours:M.regular_hours,overtime_hours:M.overtime_hours,regular_rate:E,overtime_rate:w,source_ticket_id:t}});x.length>0&&await this.addBulkLaborItems(r,x);const F=[],b=[];i.t_and_m_items?.forEach(v=>{const M=v.custom_name||v.materials_equipment?.name||"Unknown Item",j=v.custom_category||v.materials_equipment?.category||"Other",E=v.materials_equipment?.unit||"each",w=Math.round((parseFloat(v.materials_equipment?.cost_per_unit)||0)*100),T={description:M,quantity:v.quantity||1,unit:E,unit_cost:w,source_type:"backup_sheet",source_ticket_id:t};j==="Equipment"?b.push(T):F.push(T)}),F.length>0&&await this.addBulkMaterialItems(r,F),b.length>0&&await this.addBulkEquipmentItems(r,b);const{error:P}=await o.from("change_order_ticket_associations").update({data_imported:!0,imported_at:new Date().toISOString(),import_status:"completed",import_failed_at:null,import_error:null}).eq("change_order_id",r).eq("ticket_id",t);if(P)throw P;return ne.activity("cor_import_success",{ticket_id:t,cor_id:r,labor_count:x.length,material_count:F.length,equipment_count:b.length}),{laborItems:x,materialItems:F,equipmentItems:b}}return null},async reimportTicketDataToCOR(t,r,s,a,n){if(u){const o=U();if(!o)throw new Error("Database client not available");return await o.from("change_order_labor").delete().eq("change_order_id",r).eq("source_ticket_id",t),await o.from("change_order_materials").delete().eq("change_order_id",r).eq("source_ticket_id",t),await o.from("change_order_equipment").delete().eq("change_order_id",r).eq("source_ticket_id",t),this.importTicketDataToCOR(t,r,s,a,n)}return null},async markImportFailed(t,r,s="Import failed"){if(u){const a=U();if(!a)throw new Error("Database client not available");const{error:n}=await a.from("change_order_ticket_associations").update({import_status:"failed",import_failed_at:new Date().toISOString(),import_error:s}).eq("change_order_id",r).eq("ticket_id",t);if(n)throw ne.error("database",{message:n.message,operation:"markImportFailed",extra:{ticketId:t,corId:r}}),n;ne.error("cor_import_failed",{ticket_id:t,cor_id:r,error:s})}},async getTicketsNeedingImport(t){if(u){const{data:r,error:s}=await d.from("t_and_m_tickets").select(`
          id,
          work_date,
          ce_pco_number,
          assigned_cor_id,
          change_order_ticket_associations!inner (
            change_order_id,
            import_status,
            import_failed_at,
            import_error
          )
        `).eq("project_id",t).eq("change_order_ticket_associations.import_status","failed");if(s)throw s;return r||[]}return[]},async getTicketImportStatus(t,r){if(u){const{data:s,error:a}=await d.from("change_order_ticket_associations").select("import_status, import_failed_at, import_error, data_imported").eq("ticket_id",t).eq("change_order_id",r).single();if(a&&a.code!=="PGRST116")throw a;return s}return null},async recalculateCOR(t){if(u){const{error:r}=await d.rpc("recalculate_cor_totals",{cor_id:t});if(r)throw r;return this.getCORById(t)}return null},async updateCORMarkupPercentages(t,r){if(u){const s={};r.labor!==void 0&&(s.labor_markup_percent=r.labor),r.materials!==void 0&&(s.materials_markup_percent=r.materials),r.equipment!==void 0&&(s.equipment_markup_percent=r.equipment),r.subcontractors!==void 0&&(s.subcontractors_markup_percent=r.subcontractors);const{data:a,error:n}=await d.from("change_orders").update(s).eq("id",t).select().single();if(n)throw n;return a}return null},async updateCORFeePercentages(t,r){if(u){const s={};r.liabilityInsurance!==void 0&&(s.liability_insurance_percent=r.liabilityInsurance),r.bond!==void 0&&(s.bond_percent=r.bond),r.licenseFee!==void 0&&(s.license_fee_percent=r.licenseFee);const{data:a,error:n}=await d.from("change_orders").update(s).eq("id",t).select().single();if(n)throw n;return a}return null},async submitCORForApproval(t){if(u){const{data:r,error:s}=await d.from("change_orders").update({status:"pending_approval",submitted_at:new Date().toISOString()}).eq("id",t).select().single();if(s)throw s;return r}return null},async approveCOR(t,r){if(u){const{data:s,error:a}=await d.from("change_orders").update({status:"approved",approved_by:r,approved_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw a;return s}return null},async rejectCOR(t,r=null){if(u){const{data:s,error:a}=await d.from("change_orders").update({status:"rejected",rejection_reason:r}).eq("id",t).select().single();if(a)throw a;return s}return null},async markCORAsBilled(t){if(u){const{data:r,error:s}=await d.from("change_orders").update({status:"billed"}).eq("id",t).select().single();if(s)throw s;return r}return null},async closeCOR(t){if(u){const{data:r,error:s}=await d.from("change_orders").update({status:"closed"}).eq("id",t).select().single();if(s)throw s;return r}return null},async saveCORSignature(t,r,s){if(u){const{data:a,error:n}=await d.from("change_orders").update({gc_signature_data:r,gc_signature_name:s,gc_signature_date:new Date().toISOString(),status:"approved"}).eq("id",t).select().single();if(n)throw n;return a}return null},async getCORStats(t){if(u){const{data:r,error:s}=await d.from("change_orders").select("status, cor_total").eq("project_id",t);if(s)throw s;const a={total_cors:r.length,draft_count:0,pending_count:0,approved_count:0,rejected_count:0,billed_count:0,total_approved_value:0,total_pending_value:0,total_billed_value:0};return r.forEach(n=>{switch(n.status){case"draft":a.draft_count++;break;case"pending_approval":a.pending_count++,a.total_pending_value+=n.cor_total||0;break;case"approved":a.approved_count++,a.total_approved_value+=n.cor_total||0;break;case"rejected":a.rejected_count++;break;case"billed":case"closed":a.billed_count++,a.total_billed_value+=n.cor_total||0;break}}),a}return{total_cors:0,draft_count:0,pending_count:0,approved_count:0,rejected_count:0,billed_count:0,total_approved_value:0,total_pending_value:0,total_billed_value:0}},subscribeToCORs(t,r){return u?d.channel(`change_orders:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"change_orders",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToCorTickets(t,r){return u?d.channel(`cor-tickets:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"change_order_ticket_associations",filter:`change_order_id=eq.${t}`},r).subscribe():null},async getCORLog(t){if(u){const{data:r,error:s}=await d.from("cor_log_entries").select(`
          id,
          log_number,
          date_sent_to_client,
          ce_number,
          comments,
          created_at,
          updated_at,
          change_order:change_orders (
            id,
            cor_number,
            title,
            cor_total,
            status,
            created_at,
            approved_at,
            approved_by
          )
        `).eq("project_id",t).order("log_number",{ascending:!0});if(s)throw console.error("Error fetching COR log:",s),s;return(r||[]).map(a=>({id:a.id,logNumber:a.log_number,dateSentToClient:a.date_sent_to_client,ceNumber:a.ce_number,comments:a.comments,createdAt:a.created_at,updatedAt:a.updated_at,changeOrder:{id:a.change_order?.id,corNumber:a.change_order?.cor_number,title:a.change_order?.title,corTotal:a.change_order?.cor_total,status:a.change_order?.status,createdAt:a.change_order?.created_at,approvedAt:a.change_order?.approved_at,approvedBy:a.change_order?.approved_by}}))}return[]},async updateCORLogEntry(t,r){if(u){const s={updated_at:new Date().toISOString()};r.dateSentToClient!==void 0&&(s.date_sent_to_client=r.dateSentToClient||null),r.ceNumber!==void 0&&(s.ce_number=r.ceNumber||null),r.comments!==void 0&&(s.comments=r.comments||null);const{data:a,error:n}=await d.from("cor_log_entries").update(s).eq("id",t).select().single();if(n)throw console.error("Error updating COR log entry:",n),n;return a}return null},async updateChangeOrderStatus(t,r){if(u){const{data:s,error:a}=await d.from("change_orders").update({status:r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(a)throw console.error("Error updating change order status:",a),a;return s}return null},subscribeToCORLog(t,r){return u?d.channel(`cor-log:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"cor_log_entries",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToDocuments(t,r){return u?d.channel(`documents:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"documents",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToDocumentFolders(t,r){return u?d.channel(`document_folders:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"document_folders",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToMaterialsEquipment(t,r){return u?d.channel(`materials_equipment:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"materials_equipment",filter:`company_id=eq.${t}`},r).subscribe():null},subscribeToLaborRates(t,r){return u?d.channel(`labor_rates:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"labor_rates",filter:`company_id=eq.${t}`},r).subscribe():null},subscribeToProject(t,r){return u?d.channel(`project:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"projects",filter:`id=eq.${t}`},r).subscribe():null},async createSignatureRequest(t,r,s,a,n=null,o=null){if(u){const i=U();if(!i)throw new Error("Database client not available");const{data:c,error:l}=await i.rpc("generate_signature_token");if(l)throw l;const{data:h,error:_}=await i.from("signature_requests").insert({document_type:t,document_id:r,company_id:s,project_id:a,signature_token:c,expires_at:o,created_by:n}).select().single();if(_)throw _;return h}return null},async getSignatureRequestByToken(t){if(u){const r=U();if(!r)throw new Error("Database client not available");await r.rpc("increment_signature_view_count",{token:t});const{data:s,error:a}=await r.from("signature_requests").select(`
          *,
          signatures (*)
        `).eq("signature_token",t).single();if(a)throw a;return s}return null},async getSignatureRequestsForDocument(t,r){if(u){const s=U();if(!s)throw new Error("Database client not available");const{data:a,error:n}=await s.from("signature_requests").select(`
          *,
          signatures (*)
        `).eq("document_type",t).eq("document_id",r).order("created_at",{ascending:!1});if(n)throw n;return a||[]}return[]},async addSignature(t,r,s){if(u){const a=U();if(!a)throw new Error("Database client not available");const{data:n,error:o}=await a.from("signatures").insert({signature_request_id:t,signature_slot:r,signature_image:s.signature,signer_name:s.signerName,signer_title:s.signerTitle||null,signer_company:s.signerCompany||null,signed_at:s.signedAt||new Date().toISOString(),ip_address:s.ipAddress||null,user_agent:s.userAgent||null}).select().single();if(o)throw o;return n}return null},async syncSignatureToDocument(t,r){if(!u)return null;const s=U();if(!s)throw new Error("Database client not available");const{document_type:a,document_id:n}=r,o=t.signature_slot,i={};o===1?(i.gc_signature_data=t.signature_image,i.gc_signature_name=t.signer_name,i.gc_signature_title=t.signer_title,i.gc_signature_company=t.signer_company,i.gc_signature_date=t.signed_at,i.gc_signature_ip=t.ip_address):o===2&&(i.client_signature_data=t.signature_image,i.client_signature_name=t.signer_name,i.client_signature_title=t.signer_title,i.client_signature_company=t.signer_company,i.client_signature_date=t.signed_at,i.client_signature_ip=t.ip_address);const c=a==="cor"?"change_orders":"t_and_m_tickets",{data:l,error:h}=await s.from(c).update(i).eq("id",n).select().single();if(h)throw h;return l},async revokeSignatureRequest(t){if(u){const r=U();if(!r)throw new Error("Database client not available");const{data:s,error:a}=await r.from("signature_requests").update({status:"revoked"}).eq("id",t).select().single();if(a)throw a;return s}return null},async getDocumentForSigning(t,r){if(!u)return null;const s=U();if(!s)throw new Error("Database client not available");if(t==="cor"){const{data:a,error:n}=await s.from("change_orders").select(`
          *,
          projects (
            id,
            name,
            job_number,
            companies (
              id,
              name,
              logo_url
            )
          ),
          change_order_labor (*),
          change_order_materials (*),
          change_order_equipment (*),
          change_order_subcontractors (*)
        `).eq("id",r).single();if(n)throw n;return a}else if(t==="tm_ticket"){const{data:a,error:n}=await s.from("t_and_m_tickets").select(`
          *,
          projects (
            id,
            name,
            job_number,
            companies (
              id,
              name,
              logo_url
            )
          ),
          t_and_m_workers (*),
          t_and_m_items (
            *,
            materials_equipment (
              id,
              name,
              unit,
              cost_per_unit,
              category
            )
          )
        `).eq("id",r).single();if(n)throw n;return a}return null},async getProjectCosts(t){if(u){const{data:s,error:a}=await d.from("project_costs").select("*").eq("project_id",t).order("cost_date",{ascending:!1});return a?(console.error("Error fetching project costs:",a),[]):s||[]}return(V().projectCosts||[]).filter(s=>s.project_id===t).sort((s,a)=>new Date(a.cost_date)-new Date(s.cost_date))},async addProjectCost(t,r,s){const a={project_id:t,company_id:r,category:s.category,description:s.description,amount:parseFloat(s.amount),cost_date:s.cost_date||new Date().toISOString().split("T")[0],notes:s.notes||null,created_by:s.created_by||null};if(u){const{data:i,error:c}=await d.from("project_costs").insert(a).select().single();if(c)throw console.error("Error adding project cost:",c),c;return i}const n=V();n.projectCosts||(n.projectCosts=[]);const o={...a,id:crypto.randomUUID(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return n.projectCosts.push(o),ie(n),o},async updateProjectCost(t,r){const s={category:r.category,description:r.description,amount:parseFloat(r.amount),cost_date:r.cost_date,notes:r.notes||null,updated_at:new Date().toISOString()};if(u){const{data:o,error:i}=await d.from("project_costs").update(s).eq("id",t).select().single();if(i)throw console.error("Error updating project cost:",i),i;return o}const a=V();if(!a.projectCosts)return null;const n=a.projectCosts.findIndex(o=>o.id===t);return n===-1?null:(a.projectCosts[n]={...a.projectCosts[n],...s},ie(a),a.projectCosts[n])},async deleteProjectCost(t){if(u){const{error:s}=await d.from("project_costs").delete().eq("id",t);if(s)throw console.error("Error deleting project cost:",s),s;return!0}const r=V();return r.projectCosts&&(r.projectCosts=r.projectCosts.filter(s=>s.id!==t),ie(r)),!0},async getProjectCostsSummary(t){const r=await this.getProjectCosts(t),s={};let a=0;return r.forEach(n=>{const o=parseFloat(n.amount)||0;a+=o,s[n.category]||(s[n.category]={category:n.category,total:0,count:0,items:[]}),s[n.category].total+=o,s[n.category].count++,s[n.category].items.push(n)}),Object.values(s).forEach(n=>{n.percentage=a>0?n.total/a*100:0}),{totalCost:a,byCategory:s,itemCount:r.length}},async getNextInvoiceNumber(t){if(u){const{data:r,error:s}=await d.rpc("get_next_invoice_number",{p_company_id:t});return s?(console.error("Error getting next invoice number:",s),this._generateLocalInvoiceNumber(t)):r}return this._generateLocalInvoiceNumber(t)},async _generateLocalInvoiceNumber(t){const s=(await this.getCompanyInvoices(t)).reduce((a,n)=>{const o=n.invoice_number?.match(/^INV-(\d+)$/);if(o){const i=parseInt(o[1],10);return i>a?i:a}return a},0);return`INV-${String(s+1).padStart(4,"0")}`},async getBillableItems(t){if(u){const{data:r,error:s}=await d.from("change_orders").select("id, cor_number, title, cor_total, status, approved_at").eq("project_id",t).eq("status","approved").order("cor_number",{ascending:!0});s&&console.error("Error fetching billable CORs:",s);const{data:a,error:n}=await d.from("t_and_m_tickets").select("id, work_date, ce_pco_number, change_order_value, status, client_signature_date").eq("project_id",t).eq("status","approved").not("client_signature_data","is",null).order("work_date",{ascending:!0});return n&&console.error("Error fetching billable T&M tickets:",n),{cors:r||[],tickets:a||[]}}return{cors:[],tickets:[]}},async getProjectInvoices(t){if(u){const{data:s,error:a}=await d.from("invoices").select(`
          *,
          invoice_items (*)
        `).eq("project_id",t).order("invoice_date",{ascending:!1});if(a)throw console.error("Error fetching project invoices:",a),a;return s||[]}return(V().invoices||[]).filter(s=>s.project_id===t)},async getCompanyInvoices(t){if(u){const{data:s,error:a}=await d.from("invoices").select("*").eq("company_id",t).order("invoice_date",{ascending:!1});if(a)throw console.error("Error fetching company invoices:",a),a;return s||[]}return(V().invoices||[]).filter(s=>s.company_id===t)},async createInvoice(t,r){if(u){const{data:n,error:o}=await d.from("invoices").insert({project_id:t.project_id,company_id:t.company_id,invoice_number:t.invoice_number,invoice_date:t.invoice_date,due_date:t.due_date,status:t.status||"draft",retention_percent:t.retention_percent||0,bill_to_name:t.bill_to_name,bill_to_address:t.bill_to_address,bill_to_contact:t.bill_to_contact,notes:t.notes,terms:t.terms||"Net 30",created_by:t.created_by}).select().single();if(o)throw console.error("Error creating invoice:",o),o;if(r&&r.length>0){const i=r.map((l,h)=>({invoice_id:n.id,item_type:l.item_type,reference_id:l.reference_id,reference_number:l.reference_number,description:l.description,amount:l.amount,sort_order:h})),{error:c}=await d.from("invoice_items").insert(i);if(c)throw console.error("Error creating invoice items:",c),await d.from("invoices").delete().eq("id",n.id),c}return this.getInvoice(n.id)}const s=V();s.invoices||(s.invoices=[]);const a={...t,id:Oe(),created_at:new Date().toISOString(),invoice_items:r||[]};return s.invoices.push(a),ie(s),a},async getInvoice(t){if(u){const{data:s,error:a}=await d.from("invoices").select(`
          *,
          invoice_items (*)
        `).eq("id",t).single();if(a)throw console.error("Error fetching invoice:",a),a;return s}return(V().invoices||[]).find(s=>s.id===t)},async updateInvoice(t,r){if(u){const{data:n,error:o}=await d.from("invoices").update(r).eq("id",t).select().single();if(o)throw console.error("Error updating invoice:",o),o;return n}const s=V(),a=(s.invoices||[]).findIndex(n=>n.id===t);return a>=0?(s.invoices[a]={...s.invoices[a],...r},ie(s),s.invoices[a]):null},async markInvoiceSent(t){return this.updateInvoice(t,{status:"sent",sent_at:new Date().toISOString()})},async recordInvoicePayment(t,r){const s=await this.getInvoice(t);if(!s)throw new Error("Invoice not found");const a=(s.amount_paid||0)+r,n=a>=s.total;return this.updateInvoice(t,{amount_paid:a,status:n?"paid":"partial",paid_at:n?new Date().toISOString():null})},async deleteInvoice(t){if(u){const{error:s}=await d.from("invoices").delete().eq("id",t).eq("status","draft");if(s)throw console.error("Error deleting invoice:",s),s;return!0}const r=V();return r.invoices=(r.invoices||[]).filter(s=>s.id!==t),ie(r),!0},async markItemsBilled(t=[],r=[]){if(u){if(t.length>0){const{error:s}=await d.from("change_orders").update({status:"billed"}).in("id",t);s&&console.error("Error marking CORs as billed:",s)}if(r.length>0){const{error:s}=await d.from("t_and_m_tickets").update({status:"billed"}).in("id",r);s&&console.error("Error marking T&M tickets as billed:",s)}}}},Ra={async getCompanyEquipment(t,r=!0){if(!u)return console.warn("Supabase not configured"),[];let s=d.from("equipment").select("*").eq("company_id",t).order("name");r&&(s=s.eq("is_active",!0));const{data:a,error:n}=await s;return n?(console.error("Error fetching company equipment:",n),[]):a||[]},async createEquipment(t){if(!u)return console.warn("Supabase not configured"),null;const{data:r,error:s}=await d.from("equipment").insert(t).select().single();if(s)throw console.error("Error creating equipment:",s),s;return r},async updateEquipment(t,r){if(!u)return console.warn("Supabase not configured"),null;const{data:s,error:a}=await d.from("equipment").update(r).eq("id",t).select().single();if(a)throw console.error("Error updating equipment:",a),a;return s},async deactivateEquipment(t){return this.updateEquipment(t,{is_active:!1})},async getProjectEquipment(t){if(!u)return console.warn("Supabase not configured"),[];const{data:r,error:s}=await d.from("project_equipment").select(`
        *,
        equipment:equipment_id (
          id,
          name,
          description,
          is_owned
        )
      `).eq("project_id",t).order("start_date",{ascending:!1});return s?(console.error("Error fetching project equipment:",s),[]):r||[]},async getActiveProjectEquipment(t){if(!u)return console.warn("Supabase not configured"),[];const{data:r,error:s}=await d.from("project_equipment").select(`
        *,
        equipment:equipment_id (
          id,
          name,
          description,
          is_owned
        )
      `).eq("project_id",t).is("end_date",null).order("start_date",{ascending:!1});return s?(console.error("Error fetching active project equipment:",s),[]):r||[]},async addEquipmentToProject(t){if(!u)return console.warn("Supabase not configured"),null;const{data:r,error:s}=await d.from("project_equipment").insert(t).select(`
        *,
        equipment:equipment_id (
          id,
          name,
          description,
          is_owned
        )
      `).single();if(s)throw console.error("Error adding equipment to project:",s),s;return r},async updateProjectEquipment(t,r){if(!u)return console.warn("Supabase not configured"),null;const{data:s,error:a}=await d.from("project_equipment").update(r).eq("id",t).select(`
        *,
        equipment:equipment_id (
          id,
          name,
          description,
          is_owned
        )
      `).single();if(a)throw console.error("Error updating project equipment:",a),a;return s},async markEquipmentReturned(t,r=null){return this.updateProjectEquipment(t,{end_date:r||new Date().toISOString().split("T")[0]})},async removeEquipmentFromProject(t){if(!u)return console.warn("Supabase not configured"),!1;const{error:r}=await d.from("project_equipment").delete().eq("id",t);if(r)throw console.error("Error removing project equipment:",r),r;return!0},calculateProjectEquipmentCost(t){const r=new Date;return r.setHours(0,0,0,0),t.reduce((s,a)=>{const n=new Date(a.start_date);n.setHours(0,0,0,0);let o;a.end_date?(o=new Date(a.end_date),o.setHours(0,0,0,0)):o=r;const i=Math.max(1,Math.floor((o-n)/(1e3*60*60*24))+1);return s+a.daily_rate*i},0)},calculateDaysOnSite(t,r=null){const s=new Date(t);s.setHours(0,0,0,0);let a;return r?a=new Date(r):a=new Date,a.setHours(0,0,0,0),Math.max(1,Math.floor((a-s)/(1e3*60*60*24))+1)}},Pa={async getNextDrawNumber(t){if(!u)return console.warn("Supabase not configured"),1;const{data:r,error:s}=await d.from("draw_requests").select("draw_number").eq("project_id",t).order("draw_number",{ascending:!1}).limit(1).single();return s&&s.code!=="PGRST116"&&console.error("Error getting next draw number:",s),(r?.draw_number||0)+1},async getPreviousBillingTotals(t){if(!u)return console.warn("Supabase not configured"),{totalBilled:0,totalRetention:0};const{data:r,error:s}=await d.from("draw_requests").select("current_billing, retention_held").eq("project_id",t).in("status",["submitted","approved","paid"]);if(s)return console.error("Error getting previous billing totals:",s),{totalBilled:0,totalRetention:0};const a=(r||[]).reduce((o,i)=>o+(i.current_billing||0),0),n=r?.length>0?Math.max(...r.map(o=>o.retention_held||0)):0;return{totalBilled:a,totalRetention:n}},async getProjectDrawRequests(t){if(!u)return console.warn("Supabase not configured"),[];const{data:r,error:s}=await d.from("draw_requests").select("*").eq("project_id",t).order("draw_number",{ascending:!1});return s?(console.error("Error fetching draw requests:",s),[]):r||[]},async getDrawRequest(t){if(!u)return console.warn("Supabase not configured"),null;const{data:r,error:s}=await d.from("draw_requests").select(`
        *,
        draw_request_items (
          *
        )
      `).eq("id",t).single();return s?(console.error("Error fetching draw request:",s),null):r},async createDrawRequest(t,r){if(!u)return console.warn("Supabase not configured"),null;const{data:s,error:a}=await d.from("draw_requests").insert(t).select().single();if(a)throw console.error("Error creating draw request:",a),a;if(r&&r.length>0){const n=r.map((i,c)=>({...i,draw_request_id:s.id,sort_order:c})),{error:o}=await d.from("draw_request_items").insert(n);o&&console.error("Error creating draw request items:",o)}return this.getDrawRequest(s.id)},async updateDrawRequest(t,r){if(!u)return console.warn("Supabase not configured"),null;const{data:s,error:a}=await d.from("draw_requests").update(r).eq("id",t).select().single();if(a)throw console.error("Error updating draw request:",a),a;return s},async updateDrawRequestStatus(t,r){const s={status:r};return r==="submitted"?s.submitted_at=new Date().toISOString():r==="approved"?s.approved_at=new Date().toISOString():r==="paid"&&(s.paid_at=new Date().toISOString()),this.updateDrawRequest(t,s)},async updateDrawRequestItems(t,r){if(!u)return console.warn("Supabase not configured"),!1;const{error:s}=await d.from("draw_request_items").delete().eq("draw_request_id",t);if(s)throw console.error("Error deleting old draw request items:",s),s;if(r&&r.length>0){const a=r.map((o,i)=>({...o,draw_request_id:t,sort_order:i})),{error:n}=await d.from("draw_request_items").insert(a);if(n)throw console.error("Error inserting draw request items:",n),n}return!0},async deleteDrawRequest(t){if(!u)return console.warn("Supabase not configured"),!1;const{error:r}=await d.from("draw_requests").delete().eq("id",t);if(r)throw console.error("Error deleting draw request:",r),r;return!0},async getScheduleOfValues(t){if(!u)return console.warn("Supabase not configured"),[];const{data:r,error:s}=await d.from("areas").select("id, name, square_footage, price_per_sqft").eq("project_id",t).order("created_at");return s?(console.error("Error fetching schedule of values:",s),[]):(r||[]).map((a,n)=>({area_id:a.id,item_number:String(n+1),description:a.name,scheduled_value:Math.round((a.square_footage||0)*(a.price_per_sqft||0)*100)}))},async getPreviousDrawItems(t){if(!u)return console.warn("Supabase not configured"),{};const{data:r,error:s}=await d.from("draw_requests").select("id").eq("project_id",t).in("status",["submitted","approved","paid"]).order("draw_number",{ascending:!1}).limit(1).single();if(s&&s.code!=="PGRST116")return console.error("Error fetching latest draw:",s),{};if(!r)return{};const{data:a,error:n}=await d.from("draw_request_items").select("area_id, total_percent, total_amount").eq("draw_request_id",r.id);return n?(console.error("Error fetching previous draw items:",n),{}):(a||[]).reduce((o,i)=>(i.area_id&&(o[i.area_id]={previous_percent:i.total_percent||0,previous_amount:i.total_amount||0}),o),{})},calculatePercentFromAmount(t,r){return!r||r===0?0:Math.round(t/r*1e4)},calculateAmountFromPercent(t,r){return Math.round(t/1e4*r)}};typeof window<"u"&&Qe().catch(t=>console.error("Failed to init offline DB:",t));const Ta=()=>{const t="fieldsync_device_id";let r=localStorage.getItem(t);return r||(r=crypto.randomUUID(),localStorage.setItem(t,r)),r},Ut={async signUp(t,r,s,a){if(u){const{data:n,error:o}=await d.auth.signUp({email:t,password:r,options:{data:{name:s,role:a}}});if(o)throw o;return n}else{const n=V(),o={id:crypto.randomUUID(),email:t,name:s,role:a,created_at:new Date().toISOString()};return n.users.push(o),ie(n),Lt(o),{user:o}}},async signIn(t,r){if(u){const{data:s,error:a}=await d.auth.signInWithPassword({email:t,password:r});if(a)throw a;return s}else{const a=V().users.find(n=>n.email===t);if(!a)throw new Error("User not found");return Lt(a),{user:a}}},async signOut(){if(u){const{error:t}=await d.auth.signOut();if(t)throw t}else Lt(null)},async getUser(){if(u){const{data:{user:t}}=await d.auth.getUser();return t}else return Ot()},async getProfile(){if(u){const{data:{user:t}}=await d.auth.getUser();if(!t)return null;const{data:r,error:s}=await d.from("users").select("*").eq("id",t.id).single();return s?{id:t.id,email:t.email,name:t.user_metadata?.name||"",role:t.user_metadata?.role||"foreman"}:r}else return Ot()},async updateRole(t,r){if(u){const{data:s,error:a}=await d.from("users").update({role:r}).eq("id",t).select().single();if(a)throw a;return s}else{const s=V(),a=s.users.find(n=>n.id===t);return a&&(a.role=r,ie(s),Ot()?.id===t&&Lt(a)),a}},onAuthStateChange(t){if(u)return d.auth.onAuthStateChange(t);{const r=Ot();return t(r?"SIGNED_IN":"SIGNED_OUT",{user:r}),{data:{subscription:{unsubscribe:()=>{}}}}}}},I={async getProjects(t=null,r=!1){if(u){if(!We()){const a=await $r(t);return r?a:a.filter(n=>n.status!=="archived")}const s=performance.now();try{let a=d.from("projects").select("*").order("created_at",{ascending:!1});t&&(a=a.eq("company_id",t)),r||(a=a.eq("status","active"));const{data:n,error:o}=await a,i=Math.round(performance.now()-s);if(ne.query("getProjects",{duration:i,rows:n?.length,company_id:t}),o){ne.error("database",{message:o.message,operation:"getProjects",company_id:t});const c=await $r(t);if(c.length>0)return c;throw o}return n?.length>0&&ka(n).catch(c=>console.error("Failed to cache projects:",c)),n}catch(a){throw ne.error("database",{message:a.message,operation:"getProjects",company_id:t}),a}}else{const s=V().projects;return r?s:s.filter(a=>a.status!=="archived")}},async getProjectsPaginated(t,{page:r=0,limit:s=25,status:a="active"}={}){if(u){const i=performance.now();try{let c=d.from("projects").select("*",{count:"exact"}).eq("company_id",t).order("created_at",{ascending:!1}).range(r*s,(r+1)*s-1);a!=="all"&&(c=c.eq("status",a));const{data:l,error:h,count:_}=await c,p=Math.round(performance.now()-i);if(ne.query("getProjectsPaginated",{duration:p,rows:l?.length,page:r,company_id:t}),h)throw h;return{projects:l||[],totalCount:_||0,hasMore:(r+1)*s<(_||0),page:r,limit:s}}catch(c){throw ne.error("database",{message:c.message,operation:"getProjectsPaginated",company_id:t}),c}}const n=V().projects.filter(i=>i.company_id===t&&(a==="all"||i.status===a)),o=r*s;return{projects:n.slice(o,o+s),totalCount:n.length,hasMore:o+s<n.length,page:r,limit:s}},async getProjectsWithSummary(t){if(u){const r=performance.now();try{const{data:s,error:a}=await d.from("projects").select(`
            *,
            areas:areas(count),
            tickets:t_and_m_tickets(count),
            pending_tickets:t_and_m_tickets(count),
            daily_reports:daily_reports(count)
          `).eq("company_id",t).eq("status","active").eq("pending_tickets.status","pending").order("created_at",{ascending:!1}),n=Math.round(performance.now()-r);if(ne.query("getProjectsWithSummary",{duration:n,rows:s?.length,company_id:t}),a)throw a;return(s||[]).map(o=>({...o,areaCount:o.areas?.[0]?.count||0,ticketCount:o.tickets?.[0]?.count||0,pendingTicketCount:o.pending_tickets?.[0]?.count||0,reportCount:o.daily_reports?.[0]?.count||0,areas:void 0,tickets:void 0,pending_tickets:void 0,daily_reports:void 0}))}catch(s){return ne.error("database",{message:s.message,operation:"getProjectsWithSummary",company_id:t}),this.getProjects(t)}}return V().projects.filter(r=>r.company_id===t&&r.status==="active")},async getProjectDashboardSummary(t){if(u){const r=performance.now();try{const{data:s,error:a}=await d.rpc("get_project_dashboard_summary",{p_company_id:t}),n=Math.round(performance.now()-r);if(ne.query("getProjectDashboardSummary",{duration:n,rows:s?.length,company_id:t}),a){if(a.message?.includes("function")||a.code==="42883")return this.getProjectsWithSummary(t);throw a}return(s||[]).map(o=>({id:o.project_id,name:o.project_name,status:o.project_status,job_number:o.project_number,address:o.project_address,pin:o.project_pin,created_at:o.created_at,start_date:o.start_date,end_date:o.end_date,contract_value:Number(o.contract_value)||0,work_type:o.work_type||"demolition",job_type:o.job_type||"standard",general_contractor:o.general_contractor||"",areaCount:Number(o.total_areas)||0,completedAreas:Number(o.completed_areas)||0,inProgressAreas:Number(o.in_progress_areas)||0,pendingAreas:Number(o.pending_areas)||0,ticketCount:Number(o.total_tickets)||0,pendingTicketCount:Number(o.pending_tickets)||0,submittedTicketCount:Number(o.submitted_tickets)||0,approvedTicketCount:Number(o.approved_tickets)||0,totalLaborHours:Number(o.total_labor_hours)||0,todayLaborHours:Number(o.today_labor_hours)||0,todayWorkerCount:Number(o.today_worker_count)||0,lastActivityAt:o.last_activity_at,dailyReportsThisWeek:Number(o.daily_reports_this_week)||0,corCount:Number(o.cor_count)||0,pendingCorCount:Number(o.pending_cor_count)||0,disposalLoadsToday:Number(o.disposal_loads_today)||0}))}catch(s){return ne.error("database",{message:s.message,operation:"getProjectDashboardSummary",company_id:t}),this.getProjectsWithSummary(t)}}return V().projects.filter(r=>r.company_id===t&&r.status==="active")},async getArchivedProjects(t){if(u){const{data:r,error:s}=await d.from("projects").select("*").eq("company_id",t).eq("status","archived").order("archived_at",{ascending:!1});if(s)throw s;return r}else return V().projects.filter(r=>r.status==="archived")},async getProjectCount(t){if(u){const{count:r,error:s}=await d.from("projects").select("*",{count:"exact",head:!0}).eq("company_id",t).in("status",["active","archived"]);if(s)throw s;return r||0}else return V().projects.filter(s=>s.company_id===t&&s.status!=="deleted").length},async universalSearch(t,r,s=10){if(!u||!r?.trim())return{projects:[],tickets:[],cors:[],workers:[]};const a=r.trim().toLowerCase(),n={projects:[],tickets:[],cors:[],workers:[]};try{const{data:o}=await d.from("projects").select("id, name, job_number, address, status").eq("company_id",t).eq("status","active").or(`name.ilike.%${a}%,job_number.ilike.%${a}%,address.ilike.%${a}%`).limit(s);n.projects=o||[];const{data:i}=await d.from("t_and_m_tickets").select(`
          id, description, work_date, status, project_id,
          projects!inner(id, name, company_id)
        `).eq("projects.company_id",t).ilike("description",`%${a}%`).order("work_date",{ascending:!1}).limit(s);n.tickets=(i||[]).map(_=>({..._,projectName:_.projects?.name||"Unknown Project"}));const{data:c}=await d.from("change_orders").select(`
          id, cor_number, title, status, project_id,
          projects!inner(id, name, company_id)
        `).eq("projects.company_id",t).or(`title.ilike.%${a}%,cor_number.ilike.%${a}%`).order("created_at",{ascending:!1}).limit(s);n.cors=(c||[]).map(_=>({..._,projectName:_.projects?.name||"Unknown Project"}));const{data:l}=await d.from("crew_checkins").select(`
          workers,
          project_id,
          projects!inner(id, name, company_id)
        `).eq("projects.company_id",t).order("check_in_date",{ascending:!1}).limit(50),h=new Map;return(l||[]).forEach(_=>{(_.workers||[]).forEach(p=>{if(p.name.toLowerCase().includes(a)){const x=p.name.toLowerCase();h.has(x)||h.set(x,{name:p.name,role:p.role,projectName:_.projects?.name,lastProject:_.projects})}})}),n.workers=Array.from(h.values()).slice(0,s),n}catch(o){return console.error("Universal search error:",o),n}},async archiveProject(t){if(u){const{data:r,error:s}=await d.from("projects").update({status:"archived",archived_at:new Date().toISOString()}).eq("id",t).select().single();if(s)throw s;return r}else{const r=V(),s=r.projects.find(a=>a.id===t);return s&&(s.status="archived",s.archived_at=new Date().toISOString(),ie(r)),s}},async getProjectStorageStats(t){if(!u)return{photoCount:0,estimatedMB:0};const{data:r,error:s}=await d.from("t_and_m_tickets").select("photos").eq("project_id",t);if(s)throw s;let a=0;const n=[];r?.forEach(i=>{i.photos&&Array.isArray(i.photos)&&(a+=i.photos.length,n.push(...i.photos))});const o=a*1.5;return{photoCount:a,estimatedMB:o,photoUrls:n}},async archiveProjectDeep(t,r){if(!u)return null;const{photoUrls:s}=await this.getProjectStorageStats(t);if(s.length>0){const o=s.map(i=>{if(!i)return null;if(i.startsWith("http"))try{const l=new URL(i).pathname.match(/\/tm-photos\/(.+)$/);return l?l[1]:null}catch{return null}return i}).filter(Boolean);if(o.length>0)for(let i=0;i<o.length;i+=100){const c=o.slice(i,i+100);await d.storage.from("tm-photos").remove(c)}}await d.from("t_and_m_tickets").update({photos:[]}).eq("project_id",t);const{data:a,error:n}=await d.from("projects").update({status:"archived",archived_at:new Date().toISOString(),photos:[],storage_cleaned:!0}).eq("id",t).select().single();if(n)throw n;return{...a,photosDeleted:s.length}},async restoreProject(t){if(u){const{data:r,error:s}=await d.from("projects").update({status:"active",archived_at:null}).eq("id",t).select().single();if(s)throw s;return r}else{const r=V(),s=r.projects.find(a=>a.id===t);return s&&(s.status="active",s.archived_at=null,ie(r)),s}},async getProject(t){if(u){const{data:r,error:s}=await d.from("projects").select("*").eq("id",t).single();if(s)throw s;return r}else return V().projects.find(r=>r.id===t)},async createProject(t){if(u){const{data:r,error:s}=await d.from("projects").insert({...t,status:"active"}).select().single();if(s)throw console.error("Supabase createProject error:",s.message,s.details,s.hint),s;return r}else{const r=V(),s={...t,id:crypto.randomUUID(),status:"active",created_at:new Date().toISOString()};return r.projects.push(s),ie(r),s}},async getProjectByPin(t){if(u){const{data:r,error:s}=await d.from("projects").select("*").eq("pin",t).eq("status","active").single();return s?null:r}else return V().projects.find(s=>s.pin===t&&s.status==="active")||null},async getProjectByPinAndCompany(t,r){if(u){const{data:s,error:a}=await d.from("projects").select("*").eq("pin",t).eq("company_id",r).eq("status","active").single();return a?null:s}else return V().projects.find(a=>a.pin===t&&a.company_id===r&&a.status==="active")||null},async getProjectByPinSecure(t,r){if(u){const s=`pin_attempts_${r}`,a=`pin_lockout_${r}`,n=5,o=300*1e3,i=localStorage.getItem(a);if(i&&Date.now()<parseInt(i)){const P=parseInt(i)-Date.now(),v=Math.ceil(P/6e4);return{success:!1,rateLimited:!0,project:null,error:`Too many attempts. Please try again in ${v} minute${v>1?"s":""}.`}}let c=parseInt(localStorage.getItem(s)||"0");if(c++,localStorage.setItem(s,c.toString()),c>n)return localStorage.setItem(a,(Date.now()+o).toString()),{success:!1,rateLimited:!0,project:null,error:"Too many failed attempts. Please try again in 5 minutes."};const l=Ta(),{data:h,error:_}=await d.rpc("validate_pin_and_create_session",{p_pin:t,p_company_code:r,p_device_id:l,p_ip_address:null});if(_)return console.error("[PIN Auth] RPC error"),{success:!1,rateLimited:!1,project:null,error:_.message};if(!h||h.length===0)return{success:!1,rateLimited:!1,project:null};const p=h[0];if(p.error_code==="RATE_LIMITED")return{success:!1,rateLimited:!0,project:null};if(p.error_code==="INVALID_COMPANY"||p.error_code==="INVALID_PIN")return{success:!1,rateLimited:!1,project:null};if(!p.success||!p.project_id)return{success:!1,rateLimited:!1,project:null};localStorage.removeItem(`pin_attempts_${r}`),localStorage.removeItem(`pin_lockout_${r}`),gr({token:p.session_token,projectId:p.project_id,companyId:p.company_id,projectName:p.project_name,companyName:p.company_name,createdAt:new Date().toISOString()});const x=Cr(),{data:F,error:b}=await x.from("projects").select("*").eq("id",p.project_id).single();return{success:!0,rateLimited:!1,sessionToken:p.session_token,project:F||{id:p.project_id,name:p.project_name,company_id:p.company_id,status:"active"}}}else{const s=V(),n=(s.companies||[]).find(i=>i.code===r);if(!n)return{success:!1,rateLimited:!1,project:null};const o=s.projects.find(i=>i.pin===t&&i.company_id===n.id&&i.status==="active");if(o){const i=`demo_${Date.now()}_${Math.random().toString(36).slice(2)}`;gr({token:i,projectId:o.id,companyId:n.id,projectName:o.name,companyName:n.name,createdAt:new Date().toISOString()})}return{success:!!o,rateLimited:!1,project:o||null}}},async isPinAvailable(t,r=null){if(u){let s=d.from("projects").select("id").eq("pin",t);r&&(s=s.neq("id",r));const{data:a,error:n}=await s;if(n)throw n;return a.length===0}else return!V().projects.some(a=>a.pin===t&&a.id!==r)},async updateProjectPin(t,r){if(u){const{data:s,error:a}=await d.from("projects").update({pin:r}).eq("id",t).select().single();if(a)throw a;return s}else{const s=V(),a=s.projects.find(n=>n.id===t);return a&&(a.pin=r,ie(s)),a}},async updateProject(t,r,s=null){if(u){if(!s)throw console.error("[Security] updateProject called without companyId - this is a security risk"),new Error("Company ID is required for security verification");const{data:a,error:n}=await d.from("projects").update(r).eq("id",t).eq("company_id",s).select().single();if(n)throw console.error("Error updating project"),n;return a}else{const a=V(),n=a.projects.find(o=>o.id===t);return n&&(Object.assign(n,r),ie(a)),n}},async deleteProject(t,r=null){if(u){let s=d.from("projects").delete().eq("id",t);r&&(s=s.eq("company_id",r));const{error:a}=await s;if(a)throw a}else{const s=V();s.projects=s.projects.filter(a=>a.id!==t),s.areas=s.areas.filter(a=>a.project_id!==t),ie(s)}},async getAreas(t){if(u){if(!We())return Ir(t);const r=U(),{data:s,error:a}=await r.from("areas").select("*").eq("project_id",t).order("sort_order",{ascending:!0});if(a){const n=await Ir(t);if(n.length>0)return n;throw a}return s?.length>0&&Sa(s).catch(n=>console.error("Failed to cache areas:",n)),s}else return V().areas.filter(r=>r.project_id===t)},async createArea(t){if(u){const r=U(),{data:s,error:a}=await r.from("areas").insert(t).select().single();if(a)throw a;return s}else{const r=V(),s={...t,id:crypto.randomUUID(),created_at:new Date().toISOString()};return r.areas.push(s),ie(r),s}},async updateAreaStatus(t,r,s=null){if(u){if(!We()){const c=await nr(t,r);return await ze(ve.UPDATE_AREA_STATUS,{areaId:t,status:r}),c}let n=U().from("areas").update({status:r}).eq("id",t);s&&(n=n.eq("project_id",s));const{data:o,error:i}=await n.select().single();if(i){if(i.message?.includes("fetch")||i.message?.includes("network")){const c=await nr(t,r);return await ze(ve.UPDATE_AREA_STATUS,{areaId:t,status:r}),c}throw i}return o&&nr(t,r).catch(c=>console.error("Failed to update cached area status:",c)),o}else{const a=V(),n=a.areas.find(o=>o.id===t);return n&&(n.status=r,n.updated_at=new Date().toISOString()),ie(a),n}},async updateArea(t,r,s=null){if(u){let a=d.from("areas").update(r).eq("id",t);s&&(a=a.eq("project_id",s));const{data:n,error:o}=await a.select().single();if(o)throw o;return n}else{const a=V(),n=a.areas.find(o=>o.id===t);return n&&(Object.assign(n,r),n.updated_at=new Date().toISOString()),ie(a),n}},async deleteArea(t,r=null){if(u){let s=d.from("areas").delete().eq("id",t);r&&(s=s.eq("project_id",r));const{error:a}=await s;if(a)throw a}else{const s=V();s.areas=s.areas.filter(a=>a.id!==t),ie(s)}},subscribeToAreas(t,r){return u?d.channel(`areas:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"areas",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToMessages(t,r){return u?d.channel(`messages:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToMaterialRequests(t,r){return u?d.channel(`material_requests:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"material_requests",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToDailyReports(t,r){return u?d.channel(`daily_reports:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"daily_reports",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToCrewCheckins(t,r){return u?d.channel(`crew_checkins:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"crew_checkins",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToInjuryReports(t,r){return u?d.channel(`injury_reports:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"injury_reports",filter:`company_id=eq.${t}`},r).subscribe():null},subscribeToTMTickets(t,r){return u?d.channel(`tm_tickets:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"t_and_m_tickets",filter:`project_id=eq.${t}`},r).subscribe():null},subscribeToCompanyActivity(t,r,s){if(!u||!r||r.length===0)return null;const a=d.channel(`company_activity:${t}`);return r.forEach(n=>{a.on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`project_id=eq.${n}`},o=>s.onMessage?.(o)),a.on("postgres_changes",{event:"*",schema:"public",table:"material_requests",filter:`project_id=eq.${n}`},o=>s.onMaterialRequest?.(o)),a.on("postgres_changes",{event:"*",schema:"public",table:"t_and_m_tickets",filter:`project_id=eq.${n}`},o=>s.onTMTicket?.(o)),a.on("postgres_changes",{event:"*",schema:"public",table:"crew_checkins",filter:`project_id=eq.${n}`},o=>s.onCrewCheckin?.(o)),a.on("postgres_changes",{event:"*",schema:"public",table:"areas",filter:`project_id=eq.${n}`},o=>s.onAreaUpdate?.(o)),a.on("postgres_changes",{event:"*",schema:"public",table:"change_orders",filter:`project_id=eq.${n}`},o=>s.onCORChange?.(o)),a.on("postgres_changes",{event:"*",schema:"public",table:"projects",filter:`id=eq.${n}`},o=>s.onProjectChange?.(o))}),a.on("postgres_changes",{event:"*",schema:"public",table:"injury_reports",filter:`company_id=eq.${t}`},n=>s.onInjuryReport?.(n)),a.on("postgres_changes",{event:"*",schema:"public",table:"materials_equipment",filter:`company_id=eq.${t}`},n=>s.onMaterialsEquipmentChange?.(n)),a.on("postgres_changes",{event:"*",schema:"public",table:"labor_rates",filter:`company_id=eq.${t}`},n=>s.onLaborRateChange?.(n)),a.subscribe()},unsubscribe(t){t&&u&&d.removeChannel(t)},async getAssignedProjects(t){if(u){const{data:r,error:s}=await d.from("project_assignments").select(`
          project_id,
          projects (*)
        `).eq("user_id",t);if(s)throw s;return r.map(a=>a.projects)}else{const r=V();return(r.assignments?.filter(a=>a.user_id===t)||[]).map(a=>r.projects.find(n=>n.id===a.project_id)).filter(Boolean)}},async assignUserToProject(t,r,s){if(u){const{data:a,error:n}=await d.from("project_assignments").insert({project_id:t,user_id:r,assigned_by:s}).select().single();if(n)throw n;return a}else{const a=V();a.assignments||(a.assignments=[]);const n={id:crypto.randomUUID(),project_id:t,user_id:r,assigned_by:s,assigned_at:new Date().toISOString()};return a.assignments.push(n),ie(a),n}},async removeUserFromProject(t,r){if(u){const{error:s}=await d.from("project_assignments").delete().eq("project_id",t).eq("user_id",r);if(s)throw s}else{const s=V();s.assignments=s.assignments?.filter(a=>!(a.project_id===t&&a.user_id===r))||[],ie(s)}},async getProjectAssignments(t){if(u){const{data:r,error:s}=await d.from("project_assignments").select(`
          user_id,
          users (id, email, name, role)
        `).eq("project_id",t);if(s)throw s;return r.map(a=>a.users)}else{const r=V();return(r.assignments?.filter(a=>a.project_id===t)||[]).map(a=>r.users.find(n=>n.id===a.user_id)).filter(Boolean)}},async getAllUsers(){if(u){const{data:t,error:r}=await d.from("users").select("*").order("name");if(r)throw r;return t}else return V().users||[]},async getForemen(){if(u){const{data:t,error:r}=await d.from("users").select("*").eq("role","foreman").order("name");if(r)throw r;return t}else return(V().users||[]).filter(t=>t.role==="foreman")},async logActivity(t,r,s,a,n,o){if(u){const{error:i}=await d.from("activity_log").insert({user_id:t,project_id:r,area_id:s,action:a,old_value:n,new_value:o});i&&console.error("Error logging activity:",i)}},async getProjectActivity(t,r=50){if(u){const{data:s,error:a}=await d.from("activity_log").select(`
          *,
          users (name, email),
          areas (name)
        `).eq("project_id",t).order("created_at",{ascending:!1}).limit(r);if(a)throw a;return s}return[]},async getMaterialsEquipment(t){if(u){const{data:r,error:s}=await d.from("materials_equipment").select("*").eq("company_id",t).eq("active",!0).order("category").order("name");if(s)throw s;return r}return[]},async getMaterialsEquipmentByCategory(t,r){if(u){const s=U();if(!s)return[];const{data:a,error:n}=await s.from("materials_equipment").select("*").eq("company_id",t).eq("category",r).eq("active",!0).order("name");if(n)throw n;return a}return[]},async getAllMaterialsEquipment(t){if(u){const r=U();if(!r)return[];const{data:s,error:a}=await r.from("materials_equipment").select("*").eq("company_id",t).order("category").order("name");if(a)throw a;return s}return[]},async createMaterialEquipment(t){if(u){const{data:r,error:s}=await d.from("materials_equipment").insert(t).select().single();if(s)throw s;return r}return null},async updateMaterialEquipment(t,r){if(u){const{data:s,error:a}=await d.from("materials_equipment").update(r).eq("id",t).select().single();if(a)throw a;return s}return null},async deleteMaterialEquipment(t){if(u){const{error:r}=await d.from("materials_equipment").update({active:!1}).eq("id",t);if(r)throw r}},async getLaborCategories(t){if(u){const{data:r,error:s}=await d.from("labor_categories").select("*").eq("company_id",t).eq("active",!0).order("sort_order").order("name");if(s)throw s;return r||[]}return[]},async createLaborCategory(t,r,s=0){if(u){const{data:a,error:n}=await d.from("labor_categories").insert({company_id:t,name:r,sort_order:s}).select().single();if(n)throw n;return a}return null},async updateLaborCategory(t,r){if(u){const{data:s,error:a}=await d.from("labor_categories").update(r).eq("id",t).select().single();if(a)throw a;return s}return null},async deleteLaborCategory(t){if(u){const{error:r}=await d.from("labor_categories").update({active:!1}).eq("id",t);if(r)throw r}},async getLaborClasses(t){if(u){const{data:r,error:s}=await d.from("labor_classes").select(`
          *,
          labor_categories (id, name)
        `).eq("company_id",t).eq("active",!0).order("sort_order").order("name");if(s)throw s;return r||[]}return[]},async getLaborClassesWithCategories(t){if(u){const[r,s]=await Promise.all([d.from("labor_categories").select("*").eq("company_id",t).eq("active",!0).order("sort_order").order("name"),d.from("labor_classes").select("*").eq("company_id",t).eq("active",!0).order("sort_order").order("name")]);if(r.error)throw r.error;if(s.error)throw s.error;return{categories:r.data||[],classes:s.data||[]}}return{categories:[],classes:[]}},async getLaborClassesForField(t){if(u){const r=U();if(!r)return{categories:[],classes:[]};const{data:s,error:a}=await r.rpc("get_labor_classes_for_field",{p_company_id:t});if(a){console.error("Error loading field labor classes:",a);const[i,c]=await Promise.all([r.from("labor_categories").select("id, name").eq("company_id",t).eq("active",!0).order("name"),r.from("labor_classes").select("id, name, category_id").eq("company_id",t).eq("active",!0).order("name")]);return{categories:i.data||[],classes:c.data||[]}}const n=new Map,o=[];for(const i of s||[])i.category_id&&i.category_name&&!n.has(i.category_id)&&n.set(i.category_id,{id:i.category_id,name:i.category_name}),o.push({id:i.id,name:i.name,category_id:i.category_id});return{categories:Array.from(n.values()),classes:o}}return{categories:[],classes:[]}},async createLaborClass(t,r,s,a=0){if(u){const{data:n,error:o}=await d.from("labor_classes").insert({company_id:t,category_id:r,name:s,sort_order:a}).select().single();if(o)throw o;return n}return null},async updateLaborClass(t,r){if(u){const{data:s,error:a}=await d.from("labor_classes").update(r).eq("id",t).select().single();if(a)throw a;return s}return null},async deleteLaborClass(t){if(u){const{error:r}=await d.from("labor_classes").update({active:!1}).eq("id",t);if(r)throw r}},async getLaborClassRates(t){if(u){const{data:r,error:s}=await d.from("labor_class_rates").select("*").eq("labor_class_id",t);if(s)throw s;return r||[]}return[]},async getAllLaborClassRates(t){if(u){const{data:r,error:s}=await d.from("labor_classes").select(`
          id,
          name,
          labor_class_rates (*)
        `).eq("company_id",t).eq("active",!0);if(s)throw s;return r||[]}return[]},async saveLaborClassRates(t,r){if(u){const s=r.map(n=>({...n,labor_class_id:t})),{error:a}=await d.from("labor_class_rates").upsert(s,{onConflict:"labor_class_id,work_type,job_type"});if(a)throw a}},async getLaborClassRate(t,r,s){if(u){const{data:a,error:n}=await d.from("labor_class_rates").select("regular_rate, overtime_rate").eq("labor_class_id",t).eq("work_type",r).eq("job_type",s).single();if(n&&n.code!=="PGRST116")throw n;return a||null}return null},async getTMTickets(t){if(u){const r=performance.now(),s=U(),n=br()?"materials_equipment (name, unit, category)":"materials_equipment (name, unit, cost_per_unit, category)";try{const{data:o,error:i}=await s.from("t_and_m_tickets").select(`
            *,
            t_and_m_workers (*),
            t_and_m_items (
              *,
              ${n}
            )
          `).eq("project_id",t).order("created_at",{ascending:!1}),c=Math.round(performance.now()-r);if(ne.query("getTMTickets",{duration:c,rows:o?.length,project_id:t}),i)throw i;return o}catch(o){throw ne.error("database",{message:o.message,operation:"getTMTickets",project_id:t}),o}}return[]},async getTMTicketsPaginated(t,{page:r=0,limit:s=25,status:a=null}={}){if(u){const n=performance.now(),o=U(),c=br()?"materials_equipment (name, unit, category)":"materials_equipment (name, unit, cost_per_unit, category)";try{let l=o.from("t_and_m_tickets").select(`
            *,
            t_and_m_workers (*),
            t_and_m_items (
              *,
              ${c}
            )
          `,{count:"exact"}).eq("project_id",t).order("created_at",{ascending:!1}).range(r*s,(r+1)*s-1);a&&(l=l.eq("status",a));const{data:h,error:_,count:p}=await l,x=Math.round(performance.now()-n);if(ne.query("getTMTicketsPaginated",{duration:x,rows:h?.length,page:r,project_id:t}),_)throw _;return{tickets:h||[],totalCount:p||0,hasMore:(r+1)*s<(p||0),page:r,limit:s}}catch(l){throw ne.error("database",{message:l.message,operation:"getTMTicketsPaginated",project_id:t}),l}}return{tickets:[],totalCount:0,hasMore:!1,page:0,limit:25}},async getChangeOrderTotals(t){if(u){const{data:r,error:s}=await d.from("t_and_m_tickets").select("ce_pco_number, change_order_value, status").eq("project_id",t).not("ce_pco_number","is",null).neq("ce_pco_number","");if(s)throw s;const a={};let n=0,o=0;return r?.forEach(i=>{const c=i.ce_pco_number;if(a[c]||(a[c]={approved:0,pending:0,count:0}),a[c].count++,i.status==="approved"||i.status==="billed"){const l=parseFloat(i.change_order_value)||0;a[c].approved+=l,n+=l}else i.status==="pending"&&o++}),{changeOrders:a,totalApprovedValue:n,pendingCount:o}}return{changeOrders:{},totalApprovedValue:0,pendingCount:0}},async getTMTicketsByStatus(t,r){if(u){const s=U();if(!s)return[];const{data:a,error:n}=await s.from("t_and_m_tickets").select(`
          *,
          t_and_m_workers (*),
          t_and_m_items (
            *,
            materials_equipment (name, unit, cost_per_unit, category)
          )
        `).eq("project_id",t).eq("status",r).order("created_at",{ascending:!1});if(n)throw n;return a}return[]},async getCORTickets(t){if(u){const r=U();if(!r)return[];const{data:s,error:a}=await r.from("t_and_m_tickets").select(`
          *,
          t_and_m_workers (*),
          t_and_m_items (
            *,
            materials_equipment (name, unit, cost_per_unit, category)
          )
        `).eq("assigned_cor_id",t).order("work_date",{ascending:!0});if(a)throw a;return s||[]}return[]},async createTMTicket(t){if(u){if(!We()){const n={id:Oe(),project_id:t.project_id,work_date:t.work_date,ce_pco_number:t.ce_pco_number||null,assigned_cor_id:t.assigned_cor_id||null,notes:t.notes,photos:t.photos||[],status:"pending_sync",created_by_name:t.created_by_name||"Field User",created_at:new Date().toISOString(),_offline:!0};return await zr(n),await ze(ve.CREATE_TM_TICKET,{ticket:n,workers:t._workers||[],items:t._items||[]}),n}const r=U();if(!r)throw new Error("Database client not available");const{data:s,error:a}=await r.from("t_and_m_tickets").insert({project_id:t.project_id,work_date:t.work_date,ce_pco_number:t.ce_pco_number||null,assigned_cor_id:t.assigned_cor_id||null,notes:t.notes,photos:t.photos||[],status:"pending",created_by_name:t.created_by_name||"Field User"}).select().single();if(a){if(a.message?.includes("fetch")||a.message?.includes("network")){const n={id:Oe(),...t,status:"pending_sync",_offline:!0};return await zr(n),await ze(ve.CREATE_TM_TICKET,{ticket:n,workers:t._workers||[],items:t._items||[]}),n}throw a}return s}return null},async addTMWorkers(t,r){if(u){const s=r.map(o=>({ticket_id:t,name:o.name,hours:o.hours,overtime_hours:o.overtime_hours||0,time_started:o.time_started||null,time_ended:o.time_ended||null,role:o.role||"Laborer"})),a=U();if(!a)throw new Error("Database client not available");const{error:n}=await a.from("t_and_m_workers").insert(s);if(n)throw n}},async addTMItems(t,r){if(u){const s=r.map(o=>({ticket_id:t,material_equipment_id:o.material_equipment_id||null,custom_name:o.custom_name||null,custom_category:o.custom_category||null,quantity:o.quantity})),a=U();if(!a)throw new Error("Database client not available");const{error:n}=await a.from("t_and_m_items").insert(s);if(n)throw n}},async getPreviousTicketCrew(t,r){if(!u)return null;const s=U();if(!s)return null;const{data:a,error:n}=await s.from("t_and_m_tickets").select(`
        id,
        work_date,
        t_and_m_workers (*)
      `).eq("project_id",t).lt("work_date",r).order("work_date",{ascending:!1}).limit(1).maybeSingle();if(n||!a)return null;const o=a.t_and_m_workers||[],i=o.some(p=>p.labor_class_id),c={};i&&o.forEach(p=>{p.labor_class_id&&(c[p.labor_class_id]||(c[p.labor_class_id]=[]),c[p.labor_class_id].push({name:p.name,hours:p.hours?.toString()||"",overtimeHours:p.overtime_hours?.toString()||"",timeStarted:p.time_started||"",timeEnded:p.time_ended||""}))});const l=o.filter(p=>["Foreman","General Foreman","Superintendent"].includes(p.role)).map(p=>({name:p.name,hours:p.hours?.toString()||"",overtimeHours:p.overtime_hours?.toString()||"",timeStarted:p.time_started||"",timeEnded:p.time_ended||"",role:p.role})),h=o.filter(p=>p.role==="Operator").map(p=>({name:p.name,hours:p.hours?.toString()||"",overtimeHours:p.overtime_hours?.toString()||"",timeStarted:p.time_started||"",timeEnded:p.time_ended||""})),_=o.filter(p=>p.role==="Laborer").map(p=>({name:p.name,hours:p.hours?.toString()||"",overtimeHours:p.overtime_hours?.toString()||"",timeStarted:p.time_started||"",timeEnded:p.time_ended||""}));return{workDate:a.work_date,supervision:l.length>0?l:null,operators:h.length>0?h:null,laborers:_.length>0?_:null,dynamicWorkers:Object.keys(c).length>0?c:null,totalWorkers:o.length}},async updateTMTicketStatus(t,r){if(u){const s=U();if(!s)throw new Error("Database client not available");const{data:a,error:n}=await s.from("t_and_m_tickets").update({status:r}).eq("id",t).select().single();if(n)throw n;return a}return null},async approveTMTicket(t,r,s,a=null){if(u){const n={status:"approved",approved_by_user_id:r,approved_by_name:s,approved_at:new Date().toISOString(),rejected_by_user_id:null,rejected_by_name:null,rejected_at:null,rejection_reason:null};a!==null&&(n.change_order_value=parseFloat(a)||0);const o=U();if(!o)throw new Error("Database client not available");const{data:i,error:c}=await o.from("t_and_m_tickets").update(n).eq("id",t).select().single();if(c)throw c;return i}return null},async rejectTMTicket(t,r,s,a=""){if(u){const n=U();if(!n)throw new Error("Database client not available");const{data:o,error:i}=await n.from("t_and_m_tickets").update({status:"rejected",rejected_by_user_id:r,rejected_by_name:s,rejected_at:new Date().toISOString(),rejection_reason:a,approved_by_user_id:null,approved_by_name:null,approved_at:null}).eq("id",t).select().single();if(i)throw i;return o}return null},canApproveTickets(t){return["owner","admin","manager"].includes(t)},async updateTMTicketPhotos(t,r){if(u){const s=U();if(!s)throw new Error("Database client not available");const{data:a,error:n}=await s.from("t_and_m_tickets").update({photos:r}).eq("id",t).select().single();if(n)throw n;return a}return null},async saveTMClientSignature(t,r){if(u){const s=U();if(!s)throw new Error("Database client not available");const{data:a,error:n}=await s.from("t_and_m_tickets").update({client_signature_data:r.signature,client_signature_name:r.signerName,client_signature_title:r.signerTitle,client_signature_company:r.signerCompany,client_signature_date:r.signedAt,client_signature_ip:null,status:"client_signed"}).eq("id",t).select().single();if(n)throw n;return a}return null},async deleteTMTicket(t){if(u){const r=U();if(!r)throw new Error("Database client not available");const{error:s}=await r.from("t_and_m_tickets").delete().eq("id",t);if(s)throw s}},async isTicketEditable(t){if(!t?.assigned_cor_id)return{editable:!0};if(u)try{const{data:r,error:s}=await d.from("change_orders").select("id, status, cor_number").eq("id",t.assigned_cor_id).single();if(s||!r)return{editable:!0};const n=["draft","pending_approval"].includes(r.status);return{editable:n,lockedBy:n?null:r,reason:n?null:`This ticket is linked to ${r.cor_number} which has been ${r.status==="approved"?"approved":r.status}`}}catch(r){return console.error("Error checking ticket editability:",r),{editable:!0}}return{editable:!0}},async getCompanyByCode(t){if(u){const{data:r,error:s}=await d.from("companies").select("*").eq("code",t).single();return s?null:r}return null},async getCompany(t){if(u){const{data:r,error:s}=await d.from("companies").select("*").eq("id",t).single();if(s)throw s;return r}return null},async getUserCompanies(t){if(u){const{data:r,error:s}=await d.from("user_companies").select(`
          id,
          access_level,
          company_id,
          status,
          companies (
            id,
            name,
            code
          )
        `).eq("user_id",t).eq("status","active").order("created_at",{ascending:!0});return s?(console.error("Error fetching user companies:",s),[]):r.map(a=>({id:a.companies.id,name:a.companies.name,code:a.companies.code,access_level:a.access_level}))}return[]},async getUserPendingMemberships(t){if(u){const{count:r,error:s}=await d.from("user_companies").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("status","pending");return s?(console.error("Error fetching pending memberships:",s),0):r||0}return 0},async getCompanyMemberships(t){if(u){const{data:r,error:s}=await d.from("user_companies").select(`
          id,
          access_level,
          company_role,
          status,
          created_at,
          approved_at,
          approved_by,
          removed_at,
          removed_by,
          users!user_companies_user_id_fkey (
            id,
            name,
            email
          )
        `).eq("company_id",t).order("created_at",{ascending:!1});return s?(console.error("Error fetching company memberships:",s),[]):r||[]}return[]},async approveMembership(t,r){if(u){const{error:s}=await d.from("user_companies").update({status:"active",approved_at:new Date().toISOString(),approved_by:r}).eq("id",t);if(s)throw s}},async approveMembershipWithRole(t,r,s="member"){if(u){const{error:a}=await d.rpc("approve_membership_with_role",{membership_id:t,approved_by_user:r,new_access_level:s});if(a)throw a}},async rejectMembership(t){if(u){const{error:r}=await d.from("user_companies").delete().eq("id",t);if(r)throw r}},async removeMember(t,r){if(u){const{error:s}=await d.from("user_companies").update({status:"removed",removed_at:new Date().toISOString(),removed_by:r}).eq("id",t);if(s)throw s}},async getProjectTeam(t){if(u){const{data:r,error:s}=await d.from("project_users").select(`
          id,
          project_role,
          assigned_at,
          notes,
          users!project_users_user_id_fkey (
            id,
            name,
            email
          )
        `).eq("project_id",t).order("assigned_at",{ascending:!0});return s?(console.error("Error fetching project team:",s),[]):r||[]}return[]},async getCompanyMembers(t){if(u){const{data:r,error:s}=await d.from("user_companies").select(`
          id,
          access_level,
          users!user_companies_user_id_fkey (
            id,
            name,
            email
          )
        `).eq("company_id",t).eq("status","active").order("created_at",{ascending:!0});return s?(console.error("Error fetching company members:",s),[]):r||[]}return[]},async addProjectMember(t,r,s,a){if(u){const{data:n,error:o}=await d.from("project_users").insert({project_id:t,user_id:r,project_role:s,assigned_by:a}).select().single();if(o)throw o;return n}return null},async updateProjectMemberRole(t,r,s){if(u){const{error:a}=await d.from("project_users").update({project_role:s}).eq("project_id",t).eq("user_id",r);if(a)throw a}},async removeProjectMember(t,r){if(u){const{error:s}=await d.from("project_users").delete().eq("project_id",t).eq("user_id",r);if(s)throw s}},async updateMemberAccessLevel(t,r){if(u){const{error:s}=await d.from("user_companies").update({access_level:r}).eq("id",t);if(s)throw s}},async updateMemberCompanyRole(t,r){if(u){const{error:s}=await d.from("user_companies").update({company_role:r}).eq("id",t);if(s)throw s}},async repairLegacyUser(t,r,s="member"){if(!u||!t||!r)return!1;try{const{data:a,error:n}=await d.rpc("repair_legacy_user",{p_user_id:t,p_company_id:r,p_role:s});return n?(console.error("RPC repair_legacy_user failed:",n),!1):a===!0}catch(a){return console.error("Error repairing legacy user:",a),!1}},async isLegacyUser(t){if(!u)return!1;try{const{data:r}=await d.from("users").select("company_id, role").eq("id",t).single();if(!r?.company_id)return!1;const{count:s}=await d.from("user_companies").select("*",{count:"exact",head:!0}).eq("user_id",t);return s===0}catch(r){return console.error("Error checking legacy user:",r),!1}},DISPOSAL_LOAD_TYPES:[{value:"concrete",label:"Concrete"},{value:"trash",label:"Trash"},{value:"metals",label:"Metals"},{value:"hazardous_waste",label:"Hazardous Waste"}],async getDisposalLoads(t,r){if(!u)return[];const s=U();if(!s)return[];const a=performance.now();try{const{data:n,error:o}=await s.from("disposal_loads").select("*").eq("project_id",t).eq("work_date",r).order("created_at",{ascending:!1}),i=Math.round(performance.now()-a);if(ne.query("getDisposalLoads",{duration:i,rows:n?.length,project_id:t}),o)throw o;return n||[]}catch(n){throw ne.error("database",{message:n.message,operation:"getDisposalLoads",project_id:t}),n}},async getDisposalLoadsHistory(t,r=14){if(!u)return[];const s=U();if(!s)return[];const a=performance.now();try{const n=new Date,o=new Date;o.setDate(o.getDate()-r);const{data:i,error:c}=await s.from("disposal_loads").select("*").eq("project_id",t).gte("work_date",o.toISOString().split("T")[0]).lte("work_date",n.toISOString().split("T")[0]).order("work_date",{ascending:!1}),l=Math.round(performance.now()-a);if(ne.query("getDisposalLoadsHistory",{duration:l,rows:i?.length,project_id:t}),c)throw c;return(i||[]).map(h=>({...h,load_date:h.work_date}))}catch(n){throw ne.error("database",{message:n.message,operation:"getDisposalLoadsHistory",project_id:t}),n}},async addDisposalLoad(t,r,s,a,n,o=null){if(!u)return null;const i=U();if(!i)throw new Error("Database client not available");const{data:c,error:l}=await i.from("disposal_loads").insert({project_id:t,user_id:r,work_date:s,load_type:a,load_count:n,notes:o}).select().single();if(l)throw ne.error("database",{message:l.message,operation:"addDisposalLoad",project_id:t}),l;return c},async updateDisposalLoad(t,r,s,a=null){if(!u)return null;const n=U();if(!n)throw new Error("Database client not available");const{data:o,error:i}=await n.from("disposal_loads").update({load_type:r,load_count:s,notes:a}).eq("id",t).select().single();if(i)throw ne.error("database",{message:i.message,operation:"updateDisposalLoad"}),i;return o},async deleteDisposalLoad(t){if(!u)return!1;const r=U();if(!r)throw new Error("Database client not available");const{error:s}=await r.from("disposal_loads").delete().eq("id",t);if(s)throw ne.error("database",{message:s.message,operation:"deleteDisposalLoad"}),s;return!0},async getDisposalSummary(t,r=null,s=null){if(!u)return[];const a=U();if(!a)return[];const n=performance.now();try{const{data:o,error:i}=await a.rpc("get_disposal_summary",{p_project_id:t,p_start_date:r,p_end_date:s}),c=Math.round(performance.now()-n);if(ne.query("getDisposalSummary",{duration:c,rows:o?.length,project_id:t}),i)throw i;return o||[]}catch(o){return ne.error("database",{message:o.message,operation:"getDisposalSummary",project_id:t}),this.getDisposalSummaryFallback(t,r,s)}},async getDisposalSummaryFallback(t,r,s){let n=(U()||d).from("disposal_loads").select("load_type, load_count, work_date").eq("project_id",t);r&&(n=n.gte("work_date",r)),s&&(n=n.lte("work_date",s));const{data:o,error:i}=await n;if(i)throw i;const c={};return o?.forEach(l=>{c[l.load_type]||(c[l.load_type]={load_type:l.load_type,total_loads:0,days:new Set}),c[l.load_type].total_loads+=l.load_count,c[l.load_type].days.add(l.work_date)}),Object.values(c).map(l=>({load_type:l.load_type,total_loads:l.total_loads,days_with_activity:l.days.size}))},async getWeeklyDisposalSummary(t,r=4){if(!u)return[];const s=U();if(!s)return[];const a=new Date,n=new Date;n.setDate(n.getDate()-r*7);const{data:o,error:i}=await s.from("disposal_loads").select("load_type, load_count, work_date").eq("project_id",t).gte("work_date",n.toISOString().split("T")[0]).lte("work_date",a.toISOString().split("T")[0]).order("work_date",{ascending:!0});if(i)throw i;const c={};return o?.forEach(l=>{const h=new Date(l.work_date),_=new Date(h);_.setDate(h.getDate()-h.getDay());const p=_.toISOString().split("T")[0];c[p]||(c[p]={week:p,concrete:0,trash:0,metals:0,hazardous_waste:0}),c[p][l.load_type]+=l.load_count}),Object.values(c).sort((l,h)=>l.week.localeCompare(h.week))},async uploadPhoto(t,r,s,a){if(!u)return null;const n=U();if(!n)throw new Error("Database client not available");const o=performance.now(),i=a.size||0,c=Date.now(),l=new Uint8Array(6);crypto.getRandomValues(l);const h=Array.from(l,F=>F.toString(36)).join(""),_=a.name?.split(".").pop()||"jpg",p=`${c}-${h}.${_}`,x=`${t}/${r}/${s}/${p}`;try{const{data:F,error:b}=await n.storage.from("tm-photos").upload(x,a,{cacheControl:"3600",upsert:!1}),P=Math.round(performance.now()-o);if(ne.storage("upload",{company_id:t,project_id:r,size:i,duration:P,success:!b}),b)throw b;return x}catch(F){throw ne.error("storage",{message:F.message,operation:"uploadPhoto",company_id:t,project_id:r}),F}},async uploadPhotoBase64(t,r,s,a,n="photo.jpg"){if(!u)return null;const o=U();if(!o)throw new Error("Database client not available");const c=await(await fetch(a)).blob(),l=Date.now(),h=new Uint8Array(6);crypto.getRandomValues(h);const _=Array.from(h,v=>v.toString(36)).join(""),p=n.split(".").pop()||"jpg",x=`${l}-${_}.${p}`,F=`${t}/${r}/${s}/${x}`,{data:b,error:P}=await o.storage.from("tm-photos").upload(F,c,{cacheControl:"3600",upsert:!1,contentType:c.type});if(P)throw P;return F},async resolvePhotoUrl(t){if(!t||!u)return t;let r;if(t.startsWith("http"))try{const a=new URL(t).pathname.match(/\/(?:public\/)?tm-photos\/(.+)$/);if(!a)return t;r=decodeURIComponent(a[1])}catch{return t}else r=t;try{const s=yr(),{data:a,error:n}=await s.storage.from("tm-photos").createSignedUrl(r,3600);return n||!a?.signedUrl?t:a.signedUrl}catch{return t}},async resolvePhotoUrls(t){if(!u||!t?.length)return t||[];const r=[],s=[];for(let a=0;a<t.length;a++){const n=t[a];if(!n)continue;let o;if(n.startsWith("http"))try{const c=new URL(n).pathname.match(/\/(?:public\/)?tm-photos\/(.+)$/);c&&(o=decodeURIComponent(c[1]))}catch{}else o=n;o&&(r.push(o),s.push(a))}if(!r.length)return t;try{const a=yr(),{data:n,error:o}=await a.storage.from("tm-photos").createSignedUrls(r,3600);if(o||!n)return t;const i=[...t];return n.forEach((c,l)=>{c.signedUrl&&(i[s[l]]=c.signedUrl)}),i}catch{return t}},async deletePhoto(t){if(!u||!t)return;let r;if(t.startsWith("http"))try{const n=new URL(t).pathname.match(/\/tm-photos\/(.+)$/);if(!n)return;r=n[1]}catch{return}else r=t;const{error:s}=await d.storage.from("tm-photos").remove([r]);if(s)throw s},async verifyPhotoAccessible(t){if(!u||!t)return{accessible:!1,error:"Invalid input"};let r;if(t.startsWith("http"))try{const a=new URL(t).pathname.match(/\/(?:public\/)?tm-photos\/(.+)$/);if(!a)return{accessible:!1,error:"Not a tm-photos URL"};r=decodeURIComponent(a[1])}catch{return{accessible:!1,error:"Invalid URL"}}else r=t;try{const{data:s,error:a}=await d.storage.from("tm-photos").createSignedUrl(r,60);return a?{accessible:!1,error:a.message}:{accessible:!!s?.signedUrl,status:200}}catch(s){return{accessible:!1,error:s.message||"Verification failed"}}},async verifyTicketPhotos(t){if(!u)return{verified:!1,issues:[]};try{const{data:r,error:s}=await d.from("t_and_m_tickets").select("photos").eq("id",t).single();if(s)throw s;if(!r?.photos||r.photos.length===0)return await d.from("t_and_m_tickets").update({photos_verified_at:new Date().toISOString(),photos_verification_status:"empty",photos_issue_count:0}).eq("id",t),{verified:!0,status:"empty",issues:[]};const a=[];for(const o of r.photos){const i=await this.verifyPhotoAccessible(o);i.accessible||a.push({url:o,error:i.error})}const n=a.length===0?"verified":"issues";return await d.from("t_and_m_tickets").update({photos_verified_at:new Date().toISOString(),photos_verification_status:n,photos_issue_count:a.length}).eq("id",t),{verified:a.length===0,status:n,totalPhotos:r.photos.length,issues:a}}catch(r){return console.error("Error verifying ticket photos:",r),{verified:!1,error:r.message,issues:[]}}},async queuePhotoUpload(t,r,s,a){if(!u)return null;const{data:n,error:o}=await d.from("photo_upload_queue").insert({ticket_id:t,temp_id:r,file_name:s,file_size_bytes:a,status:"pending"}).select().single();return o?(console.error("Error queueing photo upload:",o),null):n},async confirmQueuedUpload(t,r,s){if(!u)return!1;const{data:a,error:n}=await d.rpc("confirm_photo_upload",{p_queue_id:t,p_uploaded_url:r,p_storage_path:s});return n?(console.error("Error confirming photo upload:",n),!1):a===!0},async markQueuedUploadFailed(t,r){if(!u)return!1;const{data:s,error:a}=await d.rpc("mark_photo_upload_failed",{p_queue_id:t,p_error:r});return a?(console.error("Error marking photo upload failed:",a),!1):s===!0},async getPendingPhotoUploads(t){if(!u)return[];const{data:r,error:s}=await d.rpc("get_pending_photo_uploads",{p_ticket_id:t});return s?(console.error("Error getting pending photo uploads:",s),[]):r||[]},async logPhotoOperation(t,r,s={}){if(u)try{await d.from("photo_audit_log").insert({ticket_id:t,cor_id:s.corId||null,operation:r,photo_url:s.photoUrl||null,storage_path:s.storagePath||null,details:s.metadata?s.metadata:null,error_message:s.error||null,triggered_by:s.triggeredBy||"system"})}catch(a){console.error("Error logging photo operation:",a)}},async saveExportSnapshot(t,r,s={}){if(!u)return null;const{exportType:a="pdf",exportReason:n=null,clientEmail:o=null,clientName:i=null}=s;try{const{data:c,error:l}=await d.from("cor_export_snapshots").insert({cor_id:t,export_type:a,export_reason:n,cor_data:r.cor_data,tickets_data:r.tickets_data,photos_manifest:r.photos_manifest,totals_snapshot:r.totals_snapshot,checksum:r.checksum,client_email:o,client_name:i}).select().single();if(l)throw l;return c}catch(c){return console.error("Error saving export snapshot:",c),null}},async getExportSnapshots(t){if(!u)return[];const{data:r,error:s}=await d.from("cor_export_snapshots").select("id, exported_at, export_type, export_reason, client_name, client_email, checksum").eq("cor_id",t).order("exported_at",{ascending:!1});return s?(console.error("Error fetching export snapshots:",s),[]):r||[]},async getExportSnapshot(t){if(!u)return null;const{data:r,error:s}=await d.from("cor_export_snapshots").select("*").eq("id",t).single();return s?(console.error("Error fetching export snapshot:",s),null):r},async requestCORExport(t,r,s={}){if(!u)return null;try{const a=await d.auth.getUser(),{data:n,error:o}=await d.rpc("request_cor_export",{p_cor_id:t,p_idempotency_key:r,p_options:s,p_requested_by:a?.data?.user?.id||null});if(o)throw o;return n?.[0]||null}catch(a){throw ne.error("database",{message:a.message,operation:"requestCORExport",extra:{corId:t}}),a}},async getExportJob(t){if(!u)return null;const{data:r,error:s}=await d.from("cor_export_jobs").select("*").eq("id",t).single();return s?(console.error("Error fetching export job:",s),null):r},async getExportJobs(t,r=10){if(!u)return[];const{data:s,error:a}=await d.from("cor_export_jobs").select("*").eq("cor_id",t).order("created_at",{ascending:!1}).limit(r);return a?(console.error("Error fetching export jobs:",a),[]):s||[]},async updateExportJobStatus(t,r,s={}){if(!u)return null;try{const{data:a,error:n}=await d.rpc("update_export_job_status",{p_job_id:t,p_status:r,p_snapshot_id:s.snapshotId||null,p_pdf_url:s.pdfUrl||null,p_error:s.error||null,p_error_details:s.errorDetails||null,p_metrics:s.metrics||null});if(n)throw n;return a}catch(a){throw ne.error("database",{message:a.message,operation:"updateExportJobStatus",extra:{jobId:t,status:r}}),a}},async getCurrentCORSnapshot(t){if(!u)return null;const{data:r}=await d.from("change_orders").select("version, last_snapshot_version").eq("id",t).single();if(!r||r.version!==r.last_snapshot_version)return null;const{data:s}=await d.from("cor_export_snapshots").select("*").eq("cor_id",t).eq("is_current",!0).single();return s||null},async saveCORSnapshot(t,r){if(!u)return null;try{await d.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",t.corId);const s=await d.auth.getUser(),{data:a,error:n}=await d.from("cor_export_snapshots").insert({id:t.snapshotId,cor_id:t.corId,job_id:r,cor_version:t.corVersion,cor_data:t.corData,tickets_data:t.ticketsData,photos_manifest:t.photoManifest,totals_snapshot:t.totals,checksum:t.checksum,is_current:!0,exported_by:s?.data?.user?.id||null}).select().single();if(n)throw n;return await d.from("change_orders").update({last_snapshot_version:t.corVersion}).eq("id",t.corId),a}catch(s){throw ne.error("database",{message:s.message,operation:"saveCORSnapshot",extra:{corId:t.corId}}),s}},async updateCORAggregatedStats(t){if(u)try{await d.rpc("update_cor_aggregated_stats",{p_cor_id:t})}catch(r){console.error("Error updating COR aggregated stats:",r)}},async getCrewCheckin(t,r=null){if(!u)return null;const s=r||new Date().toISOString().split("T")[0],a=U(),{data:n,error:o}=await a.from("crew_checkins").select("*").eq("project_id",t).eq("check_in_date",s).maybeSingle();return o&&console.error("Error fetching crew checkin:",o),n},async saveCrewCheckin(t,r,s=null,a=null){if(!u)return null;const n=a||new Date().toISOString().split("T")[0];if(!We()){const l={id:Oe(),project_id:t,check_in_date:n,workers:r,created_by:s,updated_at:new Date().toISOString(),_offline:!0};return await Tt(l),await ze(ve.SAVE_CREW_CHECKIN,{projectId:t,workers:r,checkInDate:n}),l}const o=U();if(!o){const l={id:Oe(),project_id:t,check_in_date:n,workers:r,created_by:s,updated_at:new Date().toISOString(),_offline:!0};return await Tt(l),await ze(ve.SAVE_CREW_CHECKIN,{projectId:t,workers:r,checkInDate:n}),l}const{data:i,error:c}=await o.from("crew_checkins").upsert({project_id:t,check_in_date:n,workers:r,created_by:s,updated_at:new Date().toISOString()},{onConflict:"project_id,check_in_date"}).select().single();if(c){if(c.message?.includes("fetch")||c.message?.includes("network")){const l={id:Oe(),project_id:t,check_in_date:n,workers:r,_offline:!0};return await Tt(l),await ze(ve.SAVE_CREW_CHECKIN,{projectId:t,workers:r,checkInDate:n}),l}throw console.error("Error saving crew checkin:",c),c}return i&&Tt(i).catch(l=>console.error("Failed to cache checkin:",l)),i},async addCrewMember(t,r,s=null){if(!u)return null;const a=await this.getCrewCheckin(t),n=a?.workers||[];return n.find(o=>o.name.toLowerCase()===r.name.toLowerCase())?a:(n.push(r),await this.saveCrewCheckin(t,n,s))},async removeCrewMember(t,r){if(!u)return null;const s=await this.getCrewCheckin(t);if(!s)return null;const a=s.workers.filter(n=>n.name.toLowerCase()!==r.toLowerCase());return await this.saveCrewCheckin(t,a,s.created_by)},async getCrewCheckinHistory(t,r=30){if(!u)return[];const{data:s,error:a}=await d.from("crew_checkins").select("*").eq("project_id",t).order("check_in_date",{ascending:!1}).limit(r);return a?(console.error("Error fetching crew history:",a),[]):s||[]},async getRecentWorkers(t,r=30){if(!u)return[];const s=await this.getCrewCheckinHistory(t,r),a=new Map;return s.forEach(n=>{(n.workers||[]).forEach(o=>{const i=o.name.toLowerCase();a.has(i)||a.set(i,{name:o.name,role:o.role,labor_class_id:o.labor_class_id||null,lastSeen:n.check_in_date})})}),Array.from(a.values()).sort((n,o)=>n.name.localeCompare(o.name))},async getLaborRates(t,r=null,s=null){if(!u)return[];let a=d.from("labor_rates").select("*").eq("company_id",t);r&&(a=a.eq("work_type",r)),s&&(a=a.eq("job_type",s));const{data:n,error:o}=await a;return o?(console.error("Error fetching labor rates:",o),[]):n||[]},async calculateManDayCosts(t,r,s,a){if(!u)return{totalCost:0,totalManDays:0,breakdown:[]};const n=await this.getCrewCheckinHistory(t,365),o=await this.getLaborRates(r,s,a),i={};o.forEach(p=>{i[p.role.toLowerCase()]=parseFloat(p.regular_rate)||0});let c=0,l=0;const h={},_=[];return n.forEach(p=>{const x=p.workers||[];let F=0;const b={};x.forEach(P=>{const v=(P.role||"laborer").toLowerCase(),M=i[v]||0;b[v]||(b[v]={count:0,cost:0}),b[v].count++,b[v].cost+=M,F+=M,h[v]||(h[v]={count:0,cost:0,rate:M}),h[v].count++,h[v].cost+=M}),c+=F,l+=x.length,_.push({date:p.check_in_date,workers:x.length,cost:F,breakdown:b})}),{totalCost:c,totalManDays:l,byRole:h,byDate:_,daysWorked:n.length}},async getDailyReport(t,r=null){if(!u)return null;const s=r||new Date().toISOString().split("T")[0],a=U(),{data:n,error:o}=await a.from("daily_reports").select("*").eq("project_id",t).eq("report_date",s).maybeSingle();return o&&console.error("Error fetching daily report:",o),n},async compileDailyReport(t,r=null){if(!u)return null;const s=r||new Date().toISOString().split("T")[0],a=U(),[n,o,i]=await Promise.all([this.getCrewCheckin(t,s),a.from("areas").select("*").eq("project_id",t),a.from("t_and_m_tickets").select("*").eq("project_id",t).eq("work_date",s)]),c=o?.data||[],l=i?.data||[],h=c.filter(p=>p.status==="done"&&p.completed_at?.startsWith(s)),_=l.reduce((p,x)=>p+(x.photos?.length||0),0);return{crew_count:n?.workers?.length||0,crew_list:n?.workers||[],tasks_completed:h.length,tasks_total:c.length,completed_tasks:h.map(p=>({name:p.name,group:p.group_name})),tm_tickets_count:l.length,photos_count:_}},async saveDailyReport(t,r,s=null){if(!u)return null;const a=s||new Date().toISOString().split("T")[0];if(!We()){const c={id:Oe(),project_id:t,report_date:a,...r,updated_at:new Date().toISOString(),_offline:!0};return await ut(c),c}const n=U(),{data:o,error:i}=await n.from("daily_reports").upsert({project_id:t,report_date:a,...r,updated_at:new Date().toISOString()},{onConflict:"project_id,report_date"}).select().single();if(i){if(i.message?.includes("fetch")||i.message?.includes("network")){const c={id:Oe(),project_id:t,report_date:a,...r,_offline:!0};return await ut(c),c}throw console.error("Error saving daily report:",i),i}return o&&ut(o).catch(c=>console.error("Failed to cache report:",c)),o},async submitDailyReport(t,r,s=null){if(!u)return null;const a=s||new Date().toISOString().split("T")[0];if(!We()){const l=await Ca(t,a),h={id:Oe(),project_id:t,report_date:a,...l||{},status:"pending_sync",submitted_by:r,submitted_at:new Date().toISOString(),_offline:!0};return await ut(h),await ze(ve.SUBMIT_DAILY_REPORT,{projectId:t,reportData:l||{},submittedBy:r}),h}const n=await this.compileDailyReport(t,a),o=U();if(!o)throw new Error("Database client not available");const{data:i,error:c}=await o.from("daily_reports").upsert({project_id:t,report_date:a,...n,status:"submitted",submitted_at:new Date().toISOString(),submitted_by:r,updated_at:new Date().toISOString()},{onConflict:"project_id,report_date"}).select().single();if(c){if(c.message?.includes("fetch")||c.message?.includes("network")){const l={id:Oe(),project_id:t,report_date:a,...n,status:"pending_sync",submitted_by:r,_offline:!0};return await ut(l),await ze(ve.SUBMIT_DAILY_REPORT,{projectId:t,reportData:n,submittedBy:r}),l}throw console.error("Error submitting daily report:",c),c}return i&&ut(i).catch(l=>console.error("Failed to cache report:",l)),i},async getDailyReports(t,r=30){if(!u)return[];const{data:s,error:a}=await d.from("daily_reports").select("*").eq("project_id",t).order("report_date",{ascending:!1}).limit(r);return a?(console.error("Error fetching daily reports:",a),[]):s||[]},async sendMessage(t,r,s,a,n=null,o=null,i="general",c=null){if(!u)return null;if(!We()){const _={id:Oe(),project_id:t,sender_type:s,sender_name:a,sender_user_id:n,message:r,photo_url:o,message_type:i,parent_message_id:c,created_at:new Date().toISOString(),_offline:!0};return await Ur(_),await ze(ve.SEND_MESSAGE,{projectId:t,senderType:s,senderName:a,content:r}),_}const{data:l,error:h}=await d.from("messages").insert({project_id:t,sender_type:s,sender_name:a,sender_user_id:n,message:r,photo_url:o,message_type:i,parent_message_id:c}).select().single();if(h){if(h.message?.includes("fetch")||h.message?.includes("network")){const _={id:Oe(),project_id:t,sender_type:s,sender_name:a,message:r,created_at:new Date().toISOString(),_offline:!0};return await Ur(_),await ze(ve.SEND_MESSAGE,{projectId:t,senderType:s,senderName:a,content:r}),_}throw console.error("Error sending message:",h),h}return l},async getMessages(t,r=50){if(!u)return[];const s=U(),{data:a,error:n}=await s.from("messages").select("*").eq("project_id",t).order("created_at",{ascending:!1}).limit(r);return n?[]:a||[]},async getUnreadCount(t,r){if(!u)return 0;const s=U(),a=r==="field"?"office":"field",{count:n,error:o}=await s.from("messages").select("*",{count:"exact",head:!0}).eq("project_id",t).eq("sender_type",a).eq("is_read",!1);return o?0:n||0},async markMessagesRead(t,r){if(!u)return;const s=U(),a=r==="field"?"office":"field";await s.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("project_id",t).eq("sender_type",a).eq("is_read",!1)},async createMaterialRequest(t,r,s,a=null,n="normal",o=null){if(!u)return null;if(!We()){const l={id:Oe(),project_id:t,items:r,requested_by:s,needed_by:a,priority:n,notes:o,status:"pending_sync",created_at:new Date().toISOString(),_offline:!0};return await ze(ve.CREATE_MATERIAL_REQUEST,{projectId:t,items:r,requestedBy:s,neededBy:a,priority:n,notes:o}),l}const{data:i,error:c}=await d.from("material_requests").insert({project_id:t,items:r,requested_by:s,needed_by:a,priority:n,notes:o}).select().single();if(c){if(c.message?.includes("fetch")||c.message?.includes("network")){const l={id:Oe(),project_id:t,items:r,requested_by:s,status:"pending_sync",_offline:!0};return await ze(ve.CREATE_MATERIAL_REQUEST,{projectId:t,items:r,requestedBy:s,neededBy:a,priority:n,notes:o}),l}throw console.error("Error creating material request:",c),c}return i},async getMaterialRequests(t,r=null){if(!u)return[];let s=d.from("material_requests").select("*").eq("project_id",t).order("created_at",{ascending:!1});r&&(s=s.eq("status",r));const{data:a,error:n}=await s;return n?(console.error("Error fetching material requests:",n),[]):a||[]},async getPendingRequestsCount(t){if(!u)return 0;const{count:r,error:s}=await d.from("material_requests").select("*",{count:"exact",head:!0}).eq("project_id",t).eq("status","pending");return s?0:r||0},async updateMaterialRequest(t,r,s,a=null,n=null){if(!u)return null;const o={status:r,responded_by:s,responded_at:new Date().toISOString(),response_notes:a,updated_at:new Date().toISOString()};n&&(o.expected_delivery=n),r==="delivered"&&(o.delivered_at=new Date().toISOString());const{data:i,error:c}=await d.from("material_requests").update(o).eq("id",t).select().single();if(c)throw console.error("Error updating material request:",c),c;return i},generateShareToken(){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r=new Uint8Array(12);return crypto.getRandomValues(r),Array.from(r,s=>t[s%t.length]).join("")},async createProjectShare(t,r,s,a=null){if(!u){const l=V();l.projectShares||(l.projectShares=[]);const h={id:crypto.randomUUID(),project_id:t,share_token:this.generateShareToken(),created_by:r,expires_at:a,is_active:!0,permissions:s,view_count:0,last_viewed_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return l.projectShares.push(h),ie(l),h}const{data:n,error:o}=await d.rpc("generate_share_token");if(o)throw console.error("Error generating share token:",o),o;const{data:i,error:c}=await d.from("project_shares").insert({project_id:t,share_token:n,created_by:r,expires_at:a,permissions:s}).select().single();if(c)throw console.error("Error creating project share:",c),c;return i},async getShareByToken(t){if(!u){const a=V();if(!a.projectShares)return null;const n=a.projectShares.find(o=>o.share_token===t&&o.is_active&&(!o.expires_at||new Date(o.expires_at)>new Date));return n&&(n.view_count++,n.last_viewed_at=new Date().toISOString(),ie(a)),n}const{data:r,error:s}=await d.from("project_shares").select("*, projects(*)").eq("share_token",t).eq("is_active",!0).single();return s?(console.error("Error fetching share by token:",s),null):r.expires_at&&new Date(r.expires_at)<new Date?null:(await d.rpc("increment_share_view_count",{token:t}),r)},async getProjectShares(t){if(!u){const a=V();return a.projectShares?a.projectShares.filter(n=>n.project_id===t):[]}const{data:r,error:s}=await d.from("project_shares").select("*, users(name, email)").eq("project_id",t).order("created_at",{ascending:!1});return s?(console.error("Error fetching project shares:",s),[]):r||[]},async updateProjectShare(t,r){if(!u){const n=V();if(!n.projectShares)return null;const o=n.projectShares.findIndex(i=>i.id===t);return o===-1?null:(n.projectShares[o]={...n.projectShares[o],...r,updated_at:new Date().toISOString()},ie(n),n.projectShares[o])}const{data:s,error:a}=await d.from("project_shares").update(r).eq("id",t).select().single();if(a)throw console.error("Error updating project share:",a),a;return s},async revokeProjectShare(t){return this.updateProjectShare(t,{is_active:!1})},async deleteProjectShare(t){if(!u){const s=V();if(!s.projectShares)return;s.projectShares=s.projectShares.filter(a=>a.id!==t),ie(s);return}const{error:r}=await d.from("project_shares").delete().eq("id",t);if(r)throw console.error("Error deleting project share:",r),r},async getPublicProjectData(t){const r=await this.getShareByToken(t);if(!r)return null;const s=r.project_id||r.projects?.id;if(!u){const o=V(),i=o.projects.find(p=>p.id===s);if(!i)return null;const c=o.areas.filter(p=>p.project_id===s),l=c.reduce((p,x)=>p+parseFloat(x.weight||0),0),h=c.filter(p=>p.status==="done").reduce((p,x)=>p+parseFloat(x.weight||0),0),_=l>0?Math.round(h/l*100):0;return{share:r,project:i,progress:_,areas:r.permissions.progress?c:[],photos:[],dailyReports:[],tmTickets:[]}}const a=r.projects||await this.getProject(s);if(!a)return null;const n={share:r,project:a,areas:[],photos:[],dailyReports:[],tmTickets:[]};if(r.permissions.progress){n.areas=await this.getAreas(s);const o=n.areas.reduce((c,l)=>c+parseFloat(l.weight||0),0),i=n.areas.filter(c=>c.status==="done").reduce((c,l)=>c+parseFloat(l.weight||0),0);n.progress=o>0?Math.round(i/o*100):0}if(r.permissions.photos){const{data:o}=await d.from("t_and_m_tickets").select("photos, work_date").eq("project_id",s).not("photos","is",null).order("work_date",{ascending:!1}).limit(20);n.photos=o?.flatMap(i=>(i.photos||[]).map(c=>({url:c,date:i.work_date})))||[]}if(r.permissions.daily_reports){const{data:o}=await d.from("daily_reports").select("*").eq("project_id",s).order("report_date",{ascending:!1}).limit(10);n.dailyReports=o||[]}return r.permissions.tm_tickets&&(n.tmTickets=await this.getTMTickets(s)),n},async createInjuryReport(t){if(!u){const a=V();a.injuryReports||(a.injuryReports=[]);const n={id:crypto.randomUUID(),...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return a.injuryReports.push(n),ie(a),n}const{data:r,error:s}=await d.from("injury_reports").insert(t).select().single();if(s)throw console.error("Error creating injury report:",s),s;return r},async getInjuryReports(t){if(!u){const a=V();return a.injuryReports?a.injuryReports.filter(n=>n.project_id===t).sort((n,o)=>new Date(o.incident_date)-new Date(n.incident_date)):[]}const{data:r,error:s}=await d.from("injury_reports").select("*").eq("project_id",t).order("incident_date",{ascending:!1});return s?(console.error("Error fetching injury reports:",s),[]):r||[]},async getCompanyInjuryReports(t,r=null){if(!u){const o=V();if(!o.injuryReports)return[];let i=o.injuryReports.filter(c=>c.company_id===t);return r&&(i=i.filter(c=>c.status===r)),i.sort((c,l)=>new Date(l.incident_date)-new Date(c.incident_date))}let s=d.from("injury_reports").select("*, projects(name)").eq("company_id",t).order("incident_date",{ascending:!1});r&&(s=s.eq("status",r));const{data:a,error:n}=await s;return n?(console.error("Error fetching company injury reports:",n),[]):a||[]},async getInjuryReport(t){if(!u){const a=V();return a.injuryReports?a.injuryReports.find(n=>n.id===t):null}const{data:r,error:s}=await d.from("injury_reports").select("*, projects(name, pin), users(name, email)").eq("id",t).single();return s?(console.error("Error fetching injury report:",s),null):r},async updateInjuryReport(t,r){if(!u){const n=V();if(!n.injuryReports)return null;const o=n.injuryReports.findIndex(i=>i.id===t);return o===-1?null:(n.injuryReports[o]={...n.injuryReports[o],...r,updated_at:new Date().toISOString()},ie(n),n.injuryReports[o])}const{data:s,error:a}=await d.from("injury_reports").update(r).eq("id",t).select().single();if(a)throw console.error("Error updating injury report:",a),a;return s},async closeInjuryReport(t,r){return this.updateInjuryReport(t,{status:"closed",closed_at:new Date().toISOString(),closed_by:r})},async deleteInjuryReport(t){if(!u){const s=V();if(!s.injuryReports)return;s.injuryReports=s.injuryReports.filter(a=>a.id!==t),ie(s);return}const{error:r}=await d.from("injury_reports").delete().eq("id",t);if(r)throw console.error("Error deleting injury report:",r),r},async getInjuryStatistics(t,r=null,s=null){if(!u){const o=V();if(!o.injuryReports)return{total_incidents:0,minor_injuries:0,serious_injuries:0,critical_injuries:0,near_misses:0,osha_recordable:0,total_days_away:0,total_restricted_days:0};let i=o.injuryReports.filter(c=>c.company_id===t);return r&&(i=i.filter(c=>new Date(c.incident_date)>=new Date(r))),s&&(i=i.filter(c=>new Date(c.incident_date)<=new Date(s))),{total_incidents:i.length,minor_injuries:i.filter(c=>c.injury_type==="minor").length,serious_injuries:i.filter(c=>c.injury_type==="serious").length,critical_injuries:i.filter(c=>c.injury_type==="critical").length,near_misses:i.filter(c=>c.injury_type==="near_miss").length,osha_recordable:i.filter(c=>c.osha_recordable).length,total_days_away:i.reduce((c,l)=>c+(l.days_away_from_work||0),0),total_restricted_days:i.reduce((c,l)=>c+(l.restricted_work_days||0),0)}}const{data:a,error:n}=await d.rpc("get_injury_statistics",{comp_id:t,start_date:r,end_date:s});return n?(console.error("Error fetching injury statistics:",n),null):a[0]||null},async addWitness(t,r){if(!u){const n=V();if(!n.injuryReports)return null;const o=n.injuryReports.findIndex(l=>l.id===t);if(o===-1)return null;const i=n.injuryReports[o],c=i.witnesses||[];return c.push(r),n.injuryReports[o]={...i,witnesses:c,updated_at:new Date().toISOString()},ie(n),n.injuryReports[o]}const s=await this.getInjuryReport(t);if(!s)return null;const a=s.witnesses||[];return a.push(r),this.updateInjuryReport(t,{witnesses:a})},async removeWitness(t,r){if(!u){const n=V();if(!n.injuryReports)return null;const o=n.injuryReports.findIndex(l=>l.id===t);if(o===-1)return null;const i=n.injuryReports[o],c=i.witnesses||[];return c.splice(r,1),n.injuryReports[o]={...i,witnesses:c,updated_at:new Date().toISOString()},ie(n),n.injuryReports[o]}const s=await this.getInjuryReport(t);if(!s)return null;const a=s.witnesses||[];return a.splice(r,1),this.updateInjuryReport(t,{witnesses:a})},async getCompanyUsers(t){if(u){const{data:r,error:s}=await d.from("user_companies").select(`
          user_id,
          role,
          users (
            id,
            name,
            email
          )
        `).eq("company_id",t);return s?(console.error("Error fetching company users:",s),[]):r?.map(a=>({id:a.user_id,name:a.users?.name||a.users?.email,email:a.users?.email,role:a.role}))||[]}return[]},async getProjectNotificationPreferences(t){if(u){const{data:s,error:a}=await d.from("notification_preferences").select(`
          *,
          users (
            id,
            name,
            email
          )
        `).eq("project_id",t);return a?(console.error("Error fetching notification preferences:",a),[]):s||[]}const r=V();return r.notificationPreferences?r.notificationPreferences.filter(s=>s.project_id===t):[]},async getUserNotificationPreferences(t){if(u){const{data:s,error:a}=await d.from("notification_preferences").select(`
          *,
          projects (
            id,
            name
          )
        `).eq("user_id",t);return a?(console.error("Error fetching user notification preferences:",a),[]):s||[]}const r=V();return r.notificationPreferences?r.notificationPreferences.filter(s=>s.user_id===t):[]},async setNotificationPreference(t,r,s){if(u){const{data:i,error:c}=await d.from("notification_preferences").upsert({project_id:t,user_id:r,notification_types:s,updated_at:new Date().toISOString()},{onConflict:"project_id,user_id"}).select().single();if(c)throw console.error("Error setting notification preference:",c),c;return i}const a=V();a.notificationPreferences||(a.notificationPreferences=[]);const n=a.notificationPreferences.findIndex(i=>i.project_id===t&&i.user_id===r),o={id:n>=0?a.notificationPreferences[n].id:crypto.randomUUID(),project_id:t,user_id:r,notification_types:s,created_at:n>=0?a.notificationPreferences[n].created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return n>=0?a.notificationPreferences[n]=o:a.notificationPreferences.push(o),ie(a),o},async removeNotificationPreference(t,r){if(u){const{error:a}=await d.from("notification_preferences").delete().eq("project_id",t).eq("user_id",r);if(a)throw console.error("Error removing notification preference:",a),a;return!0}const s=V();return s.notificationPreferences&&(s.notificationPreferences=s.notificationPreferences.filter(a=>!(a.project_id===t&&a.user_id===r)),ie(s)),!0},async setProjectNotificationPreferences(t,r){const s=[];for(const a of r)if(a.notificationTypes&&a.notificationTypes.length>0){const n=await this.setNotificationPreference(t,a.userId,a.notificationTypes);s.push(n)}else await this.removeNotificationPreference(t,a.userId);return s},async getNotificationPresets(t){if(u){const{data:s,error:a}=await d.from("notification_presets").select("*").eq("company_id",t).order("name");return a?(console.error("Error fetching notification presets:",a),[]):s||[]}const r=V();return r.notificationPresets?r.notificationPresets.filter(s=>s.company_id===t):[{id:"preset-1",name:"Project Manager",notification_types:["message","material_request","injury_report","tm_ticket"],company_id:t},{id:"preset-2",name:"Safety Officer",notification_types:["injury_report"],company_id:t},{id:"preset-3",name:"Purchasing",notification_types:["material_request"],company_id:t},{id:"preset-4",name:"Accounting",notification_types:["tm_ticket"],company_id:t}]},async createNotificationPreset(t,r,s){if(u){const{data:o,error:i}=await d.from("notification_presets").insert({company_id:t,name:r,notification_types:s}).select().single();if(i)throw console.error("Error creating notification preset:",i),i;return o}const a=V();a.notificationPresets||(a.notificationPresets=[]);const n={id:crypto.randomUUID(),company_id:t,name:r,notification_types:s,created_at:new Date().toISOString()};return a.notificationPresets.push(n),ie(a),n},async updateNotificationPreset(t,r,s){if(u){const{data:o,error:i}=await d.from("notification_presets").update({name:r,notification_types:s,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(i)throw console.error("Error updating notification preset:",i),i;return o}const a=V();if(!a.notificationPresets)return null;const n=a.notificationPresets.findIndex(o=>o.id===t);return n===-1?null:(a.notificationPresets[n]={...a.notificationPresets[n],name:r,notification_types:s,updated_at:new Date().toISOString()},ie(a),a.notificationPresets[n])},async deleteNotificationPreset(t){if(u){const{error:s}=await d.from("notification_presets").delete().eq("id",t);if(s)throw console.error("Error deleting notification preset:",s),s;return!0}const r=V();return r.notificationPresets&&(r.notificationPresets=r.notificationPresets.filter(s=>s.id!==t),ie(r)),!0},async getDumpSites(t){if(u){const{data:s,error:a}=await d.from("dump_sites").select(`
          *,
          dump_site_rates (*)
        `).eq("company_id",t).eq("active",!0).order("name");return a?(console.error("Error fetching dump sites:",a),[]):s||[]}return(V().dumpSites||[]).filter(s=>s.company_id===t&&s.active)},async createDumpSite(t,r,s="",a=""){if(u){const{data:i,error:c}=await d.from("dump_sites").insert({company_id:t,name:r,address:s,notes:a,active:!0}).select().single();if(c)throw console.error("Error creating dump site:",c),c;return i}const n=V();n.dumpSites||(n.dumpSites=[]);const o={id:crypto.randomUUID(),company_id:t,name:r,address:s,notes:a,active:!0,created_at:new Date().toISOString(),dump_site_rates:[]};return n.dumpSites.push(o),ie(n),o},async updateDumpSite(t,r){if(u){const{data:n,error:o}=await d.from("dump_sites").update({...r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(o)throw console.error("Error updating dump site:",o),o;return n}const s=V();if(!s.dumpSites)return null;const a=s.dumpSites.findIndex(n=>n.id===t);return a===-1?null:(s.dumpSites[a]={...s.dumpSites[a],...r},ie(s),s.dumpSites[a])},async deleteDumpSite(t){return this.updateDumpSite(t,{active:!1})},async setDumpSiteRate(t,r,s,a="load"){if(u){const{data:c}=await d.from("dump_site_rates").select("id").eq("dump_site_id",t).eq("waste_type",r).maybeSingle();if(c){const{data:l,error:h}=await d.from("dump_site_rates").update({estimated_cost_per_load:s,unit:a}).eq("id",c.id).select().single();if(h)throw console.error("Error updating dump site rate:",h),h;return l}else{const{data:l,error:h}=await d.from("dump_site_rates").insert({dump_site_id:t,waste_type:r,estimated_cost_per_load:s,unit:a}).select().single();if(h)throw console.error("Error inserting dump site rate:",h),h;return l}}const n=V();n.dumpSiteRates||(n.dumpSiteRates=[]);const o=n.dumpSiteRates.findIndex(c=>c.dump_site_id===t&&c.waste_type===r),i={id:o>=0?n.dumpSiteRates[o].id:crypto.randomUUID(),dump_site_id:t,waste_type:r,estimated_cost_per_load:s,unit:a,created_at:new Date().toISOString()};return o>=0?n.dumpSiteRates[o]=i:n.dumpSiteRates.push(i),ie(n),i},async getDumpSiteRates(t){if(u){const{data:s,error:a}=await d.from("dump_site_rates").select("*").eq("dump_site_id",t);return a?(console.error("Error fetching dump site rates:",a),[]):s||[]}return(V().dumpSiteRates||[]).filter(s=>s.dump_site_id===t)},async getHaulOffs(t){if(u){const{data:s,error:a}=await d.from("haul_offs").select(`
          *,
          dump_sites (name)
        `).eq("project_id",t).order("work_date",{ascending:!1});return a?(console.error("Error fetching haul-offs:",a),[]):s||[]}return(V().haulOffs||[]).filter(s=>s.project_id===t).sort((s,a)=>new Date(a.work_date)-new Date(s.work_date))},async createHaulOff(t,r){const s={project_id:t,dump_site_id:r.dumpSiteId,waste_type:r.wasteType,loads:r.loads,hauling_company:r.haulingCompany||"",work_date:r.workDate,notes:r.notes||"",estimated_cost:r.estimatedCost||0,created_by:r.createdBy||""};if(u){const{data:o,error:i}=await d.from("haul_offs").insert(s).select().single();if(i)throw console.error("Error creating haul-off:",i),i;return o}const a=V();a.haulOffs||(a.haulOffs=[]);const n={...s,id:crypto.randomUUID(),created_at:new Date().toISOString()};return a.haulOffs.push(n),ie(a),n},async calculateHaulOffCosts(t){const r=await this.getHaulOffs(t);let s=0,a=0;const n={},o=[],i={};r.forEach(l=>{const h=parseFloat(l.estimated_cost)||0,_=parseInt(l.loads)||0;s+=h,a+=_,n[l.waste_type]||(n[l.waste_type]={loads:0,cost:0}),n[l.waste_type].loads+=_,n[l.waste_type].cost+=h,i[l.work_date]||(i[l.work_date]={date:l.work_date,loads:0,cost:0}),i[l.work_date].loads+=_,i[l.work_date].cost+=h}),Object.values(i).sort((l,h)=>new Date(h.date)-new Date(l.date)).forEach(l=>o.push(l));const c=o.length;return{totalCost:s,totalLoads:a,byWasteType:n,byDate:o,daysWithHaulOff:c,avgDailyHaulOffCost:c>0?s/c:0}},subscribeToHaulOffs(t,r){return u?d.channel(`haul_offs:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"haul_offs",filter:`project_id=eq.${t}`},r).subscribe():null},...Da,async createFolder(t,r,s){const a=U(),{data:n,error:o}=await a.from("document_folders").insert({company_id:t,project_id:r,name:s.name,description:s.description||null,icon:s.icon||"folder",color:s.color||"blue",sort_order:s.sort_order||0,created_by:(await a.auth.getUser()).data.user?.id}).select().single();if(o)throw o;return n},async getProjectFolders(t){const r=U(),{data:s,error:a}=await r.from("document_folders").select("*").eq("project_id",t).order("sort_order",{ascending:!0}).order("name",{ascending:!0});if(a)throw a;const n=s.map(o=>o.id);if(n.length>0){const{data:o,error:i}=await r.from("documents").select("folder_id").in("folder_id",n).is("archived_at",null).eq("is_current",!0);if(!i&&o){const c={};o.forEach(l=>{c[l.folder_id]=(c[l.folder_id]||0)+1}),s.forEach(l=>{l.document_count=c[l.id]||0})}}return s},async updateFolder(t,r){const s=U(),{data:a,error:n}=await s.from("document_folders").update({...r,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(n)throw n;return a},async deleteFolder(t){const r=U();await r.from("documents").update({folder_id:null}).eq("folder_id",t);const{error:s}=await r.from("document_folders").delete().eq("id",t);if(s)throw s;return!0},async reorderFolders(t,r){const s=U(),a=r.map(({id:n,sort_order:o})=>s.from("document_folders").update({sort_order:o,updated_at:new Date().toISOString()}).eq("id",n).eq("project_id",t));return await Promise.all(a),!0},async getFolderDocuments(t,r={}){const s=U(),{page:a=0,limit:n=25}=r;let o=s.from("documents").select("*",{count:"exact"}).eq("folder_id",t).is("archived_at",null).eq("is_current",!0).order("uploaded_at",{ascending:!1}).range(a*n,(a+1)*n-1);const{data:i,error:c,count:l}=await o;if(c)throw c;return{documents:i||[],totalCount:l||0,hasMore:(l||0)>(a+1)*n}},async moveDocumentToFolder(t,r){const s=U(),{data:a,error:n}=await s.from("documents").update({folder_id:r}).eq("id",t).select().single();if(n)throw n;return a},async getUnfiledDocuments(t,r={}){const s=U(),{page:a=0,limit:n=25}=r,{data:o,error:i,count:c}=await s.from("documents").select("*",{count:"exact"}).eq("project_id",t).is("folder_id",null).is("archived_at",null).eq("is_current",!0).order("uploaded_at",{ascending:!1}).range(a*n,(a+1)*n-1);if(i)throw i;return{documents:o||[],totalCount:c||0,hasMore:(c||0)>(a+1)*n}},async uploadDocument(t,r,s,a={}){const n=U(),o=Date.now(),i=250*1024*1024,{data:c}=await n.from("documents").select("file_size_bytes").eq("project_id",r).is("archived_at",null),l=c?.reduce((P,v)=>P+(v.file_size_bytes||0),0)||0;if(l+s.size>i){const P=Math.round(l/1024/1024),v=Math.round(i/1024/1024);throw new Error(`Project storage limit reached (${P}/${v} MB). Contact support to upgrade.`)}const h=Date.now(),_=new Uint8Array(6);crypto.getRandomValues(_);const p=Array.from(_,P=>P.toString(36)).join(""),x=s.name.split(".").pop()?.toLowerCase()||"bin",F=`${h}-${p}.${x}`,b=`${t}/${r}/documents/${F}`;try{const{data:P,error:v}=await n.storage.from("project-documents").upload(b,s,{cacheControl:"3600",upsert:!1});if(v)throw v;const{data:M}=n.storage.from("project-documents").getPublicUrl(b),j=M.publicUrl,E=a.category==="contracts"?"pending":"approved",{data:w,error:T}=await n.from("documents").insert({company_id:t,project_id:r,name:a.name||s.name.replace(/\.[^/.]+$/,""),description:a.description||null,file_name:s.name,file_size_bytes:s.size,mime_type:s.type,storage_path:b,folder_id:a.folderId||null,category:a.category||"general",tags:a.tags||[],visibility:a.visibility||"all",approval_status:E,resource_type:a.resourceType||null,resource_id:a.resourceId||null,uploaded_by:(await n.auth.getUser()).data?.user?.id}).select().single();if(T)throw T;const L=Date.now()-o;return ne.storage("document_upload",{company_id:t,project_id:r,file_size:s.size,mime_type:s.type,duration:L,success:!0}),{...w,url:j}}catch(P){throw ne.error("storage",{message:P.message,operation:"uploadDocument",company_id:t,project_id:r}),P}},async getProjectDocuments(t,{category:r=null,page:s=0,limit:a=25,includeArchived:n=!1}={}){let i=U().from("documents").select("*",{count:"exact"}).eq("project_id",t).eq("is_current",!0).order("uploaded_at",{ascending:!1}).range(s*a,(s+1)*a-1);n||(i=i.is("archived_at",null)),r&&r!=="all"&&(i=i.eq("category",r));const{data:c,error:l,count:h}=await i;if(l)throw l;return{documents:c||[],totalCount:h||0,hasMore:(s+1)*a<(h||0),page:s,limit:a}},async getDocument(t){const r=U(),{data:s,error:a}=await r.from("documents").select("*").eq("id",t).single();if(a)throw a;return s},async getDocumentVersions(t){const r=U(),{data:s,error:a}=await r.from("documents").select("id, parent_document_id").eq("id",t).single();if(a)throw a;const n=s.parent_document_id||t,{data:o,error:i}=await r.from("documents").select("*").or(`id.eq.${n},parent_document_id.eq.${n}`).order("version",{ascending:!1});if(i)throw i;return o||[]},async uploadDocumentVersion(t,r,s,a,n={}){const o=U(),{data:i,error:c}=await o.from("documents").select("*").eq("id",t).single();if(c)throw c;const{data:l}=await o.from("documents").select("version").or(`id.eq.${t},parent_document_id.eq.${t}`).order("version",{ascending:!1}).limit(1),h=(l?.[0]?.version||1)+1;await o.from("documents").update({is_current:!1}).or(`id.eq.${t},parent_document_id.eq.${t}`);const _=await this.uploadDocument(r,s,a,{name:n.name||i.name,description:n.description||i.description,category:i.category,visibility:i.visibility,tags:i.tags,resourceType:i.resource_type,resourceId:i.resource_id}),{data:p,error:x}=await o.from("documents").update({version:h,is_current:!0,parent_document_id:t}).eq("id",_.id).select().single();if(x)throw x;return await o.from("document_audit_log").insert({document_id:_.id,project_id:s,company_id:r,operation:"version_created",details:{version:h,parent_id:t},triggered_by:"user",user_id:(await o.auth.getUser()).data?.user?.id}),{..._,...p}},async updateDocument(t,r){const s=U(),{data:a,error:n}=await s.from("documents").update({name:r.name,description:r.description,category:r.category,visibility:r.visibility,tags:r.tags}).eq("id",t).select().single();if(n)throw n;return a},async archiveDocument(t){const r=U(),s=(await r.auth.getUser()).data?.user?.id,{data:a,error:n}=await r.from("documents").update({archived_at:new Date().toISOString(),archived_by:s}).eq("id",t).select().single();if(n)throw n;return await r.from("document_audit_log").insert({document_id:t,project_id:a.project_id,company_id:a.company_id,operation:"deleted",triggered_by:"user",user_id:s}),a},async restoreDocument(t){const r=U(),s=(await r.auth.getUser()).data?.user?.id,{data:a,error:n}=await r.from("documents").update({archived_at:null,archived_by:null}).eq("id",t).select().single();if(n)throw n;return await r.from("document_audit_log").insert({document_id:t,project_id:a.project_id,company_id:a.company_id,operation:"restored",triggered_by:"user",user_id:s}),a},async deleteDocumentPermanently(t){const r=U(),{data:s,error:a}=await r.from("documents").select("storage_path, company_id, project_id").eq("id",t).single();if(a)throw a;s.storage_path&&await r.storage.from("project-documents").remove([s.storage_path]);const{error:n}=await r.from("documents").delete().eq("id",t);if(n)throw n;return!0},async linkDocumentToResource(t,r,s){const a=U(),{data:n,error:o}=await a.from("documents").update({resource_type:r,resource_id:s}).eq("id",t).select().single();if(o)throw o;return await a.from("document_audit_log").insert({document_id:t,project_id:n.project_id,company_id:n.company_id,operation:"linked",details:{resource_type:r,resource_id:s},triggered_by:"user",user_id:(await a.auth.getUser()).data?.user?.id}),n},async unlinkDocumentFromResource(t){const r=U(),{data:s}=await r.from("documents").select("resource_type, resource_id, project_id, company_id").eq("id",t).single(),{data:a,error:n}=await r.from("documents").update({resource_type:null,resource_id:null}).eq("id",t).select().single();if(n)throw n;return await r.from("document_audit_log").insert({document_id:t,project_id:s.project_id,company_id:s.company_id,operation:"unlinked",details:{resource_type:s.resource_type,resource_id:s.resource_id},triggered_by:"user",user_id:(await r.auth.getUser()).data?.user?.id}),a},async getResourceDocuments(t,r){const s=U(),{data:a,error:n}=await s.from("documents").select("*").eq("resource_type",t).eq("resource_id",r).is("archived_at",null).order("uploaded_at",{ascending:!1});if(n)throw n;return a||[]},async approveDocument(t){const r=U(),{data:s,error:a}=await r.rpc("approve_document",{p_document_id:t});if(a)throw a;return s},async rejectDocument(t,r){const s=U(),{data:a,error:n}=await s.rpc("reject_document",{p_document_id:t,p_reason:r});if(n)throw n;return a},async getPendingDocuments(t){const r=U(),{data:s,error:a}=await r.from("documents").select("*, project:projects(name)").eq("company_id",t).eq("approval_status","pending").is("archived_at",null).order("uploaded_at",{ascending:!1});if(a)throw a;return s||[]},async searchDocuments(t,r){const s=U(),{data:a,error:n}=await s.from("documents").select("*").eq("project_id",t).eq("is_current",!0).is("archived_at",null).or(`name.ilike.%${r}%,description.ilike.%${r}%`).order("uploaded_at",{ascending:!1}).limit(20);if(n)throw n;return a||[]},async logDocumentAccess(t,r="downloaded"){const s=U(),{data:a}=await s.from("documents").select("project_id, company_id").eq("id",t).single();a&&await s.from("document_audit_log").insert({document_id:t,project_id:a.project_id,company_id:a.company_id,operation:r,triggered_by:"user",user_id:(await s.auth.getUser()).data?.user?.id})}};kr(async t=>{if(t&&u)try{await gs(I)}catch(r){console.error("Error syncing pending actions:",r)}});const qn=Object.freeze(Object.defineProperty({__proto__:null,auth:Ut,clearFieldSession:_r,db:I,drawRequestOps:Pa,equipmentOps:Ra,getConnectionStatus:We,getPendingActionCount:zt,getSupabaseClient:yr,isFieldMode:br,isSupabaseConfigured:u,onConnectionChange:kr,supabase:d,syncPendingActions:gs},Symbol.toStringTag,{value:"Module"})),ys=m.createContext(),Ue={logo_url:null,favicon_url:null,login_background_url:null,primary_color:"#3B82F6",secondary_color:"#1E40AF",custom_app_name:"FieldSync",hide_fieldsync_branding:!1,email_from_name:"FieldSync",email_from_address:null,custom_domain:null,domain_verified:!1};function Ze({children:t,companyId:r}){const[s,a]=m.useState(Ue),[n,o]=m.useState(!0);m.useEffect(()=>{r?i(r):c()},[r]),m.useEffect(()=>{_(s)},[s]);const i=async b=>{try{if(o(!0),!u){a(Ue),o(!1);return}const{data:P,error:v}=await d.from("company_branding").select("*").eq("company_id",b).single();v?(v.code==="PGRST116"?await l(b):console.error("Error loading branding:",v),a(Ue)):a({...Ue,...P})}catch(P){console.error("Error in loadBranding:",P),a(Ue)}finally{o(!1)}},c=async()=>{try{o(!0);const b=window.location.hostname;if(b==="localhost"||b==="127.0.0.1"){a(Ue),o(!1);return}if(!u){a(Ue),o(!1);return}const{data:P,error:v}=await d.rpc("get_branding_by_domain",{domain_name:b});v||!P||P.length===0?a(Ue):a({...Ue,...P[0]})}catch(b){console.error("Error loading branding by domain:",b),a(Ue)}finally{o(!1)}},l=async b=>{try{const{data:P,error:v}=await d.from("company_branding").insert({company_id:b,...Ue}).select().single();v&&console.error("Error creating default branding:",v)}catch(P){console.error("Error in createDefaultBranding:",P)}},h=m.useCallback(async b=>{try{if(!u)return a(T=>({...T,...b})),{success:!0};if(!r)return{success:!1,error:"No company ID"};const P={},v=["logo_url","favicon_url","login_background_url","primary_color","secondary_color","custom_app_name","hide_fieldsync_branding","email_from_name","email_from_address","custom_domain","domain_verified"];for(const T of v)b[T]!==void 0&&(P[T]=b[T]);const{data:M,error:j}=await d.from("company_branding").select("id").eq("company_id",r).single();if(j&&j.code==="PGRST116"){const{data:T,error:L}=await d.from("company_branding").insert({company_id:r,...P}).select().single();return L?(console.error("Error creating branding:",L),{success:!1,error:L.message}):(a({...Ue,...T}),{success:!0,data:T})}const{data:E,error:w}=await d.from("company_branding").update(P).eq("company_id",r).select().single();return w?(console.error("Error updating branding:",w),{success:!1,error:w.message}):(a({...Ue,...E}),{success:!0,data:E})}catch(P){return console.error("Error in updateBranding:",P),{success:!1,error:P.message}}},[r]),_=b=>{const P=document.documentElement;if(P.style.setProperty("--primary-color",b.primary_color),P.style.setProperty("--secondary-color",b.secondary_color),b.favicon_url){let v=document.querySelector("link[rel*='icon']");v||(v=document.createElement("link"),v.rel="icon",document.head.appendChild(v)),v.href=b.favicon_url}document.title=b.custom_app_name||"FieldSync"},p=m.useCallback(async(b,P)=>{try{if(!u)return{success:!0,url:URL.createObjectURL(b)};const v=b.name.split(".").pop(),j=`branding/${`${r}/${P}-${Date.now()}.${v}`}`,{data:E,error:w}=await d.storage.from("public").upload(j,b,{cacheControl:"3600",upsert:!0});if(w)return console.error("Error uploading image:",w),{success:!1,error:w.message};const{data:{publicUrl:T}}=d.storage.from("public").getPublicUrl(j);return{success:!0,url:T}}catch(v){return console.error("Error in uploadBrandingImage:",v),{success:!1,error:v.message}}},[r]),x=m.useCallback(()=>{r?i(r):c()},[r]),F=m.useMemo(()=>({branding:s,loading:n,updateBranding:h,uploadBrandingImage:p,refreshBranding:x}),[s,n,h,p,x]);return e.jsx(ys.Provider,{value:F,children:t})}function Aa(){const t=m.useContext(ys);if(!t)throw new Error("useBranding must be used within a BrandingProvider");return t}const bs=m.createContext();function et({children:t}){const[r,s]=m.useState(()=>{const o=localStorage.getItem("fieldsync-theme");return o==="light"||o==="dark"?o:window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"});m.useEffect(()=>{document.documentElement.setAttribute("data-theme",r),localStorage.setItem("fieldsync-theme",r)},[r]),m.useEffect(()=>{const o=window.matchMedia("(prefers-color-scheme: light)"),i=c=>{localStorage.getItem("fieldsync-theme")||s(c.matches?"light":"dark")};return o.addEventListener("change",i),()=>o.removeEventListener("change",i)},[]);const a=m.useCallback(()=>{s(o=>o==="dark"?"light":"dark")},[]),n=m.useMemo(()=>({theme:r,setTheme:s,toggleTheme:a}),[r,a]);return e.jsx(bs.Provider,{value:n,children:t})}function Oa(){const t=m.useContext(bs);if(!t)throw new Error("useTheme must be used within a ThemeProvider");return t}const La=m.createContext(null);function Ma({children:t}){const[r,s]=m.useState(null),[a,n]=m.useState([]),o=m.useCallback(()=>{s(null)},[]),i=m.useCallback((b,P="info",v=3e3)=>{if(r){n(M=>[...M,{message:b,type:P,duration:v}]);return}s({message:b,type:P,duration:v}),v>0&&setTimeout(()=>{s(null)},v)},[r]),c=m.useCallback(()=>{if(a.length>0){const[b,...P]=a;n(P),setTimeout(()=>{i(b.message,b.type,b.duration)},300)}},[a,i]),l=m.useCallback(()=>{o(),c()},[o,c]),h=m.useCallback((b,P)=>{i(b,"success",P)},[i]),_=m.useCallback((b,P)=>{i(b,"error",P)},[i]),p=m.useCallback((b,P)=>{i(b,"warning",P)},[i]),x=m.useCallback((b,P)=>{i(b,"info",P)},[i]),F=m.useMemo(()=>({toast:r,showToast:i,hideToast:l,success:h,error:_,warning:p,info:x}),[r,i,l,h,_,p,x]);return e.jsxs(La.Provider,{value:F,children:[t,r&&e.jsx("div",{className:"toast-container",children:e.jsx("div",{className:`toast ${r.type}`,onClick:l,children:r.message})})]})}function Te({className:t="",showPoweredBy:r=!1}){const{branding:s}=Aa();return e.jsxs("div",{className:`app-logo ${t}`,children:[s.logo_url?e.jsx("img",{src:s.logo_url,alt:s.custom_app_name||"Logo",className:"custom-logo"}):e.jsxs("div",{className:"logo",children:[s.custom_app_name||"Field",e.jsx("span",{children:"Sync"})]}),r&&!s.hide_fieldsync_branding&&e.jsx("div",{className:"powered-by",children:"Powered by FieldSync"})]})}function Fa(t){if(!t)return{score:0,label:"",color:""};let r=0;return t.length>=6&&r++,t.length>=8&&r++,/[A-Z]/.test(t)&&/[a-z]/.test(t)&&r++,/\d/.test(t)&&r++,/[^A-Za-z0-9]/.test(t)&&r++,r<=1?{score:1,label:"Weak",color:"var(--accent-red)"}:r<=2?{score:2,label:"Fair",color:"var(--accent-orange)"}:r<=3?{score:3,label:"Good",color:"var(--accent-amber)"}:r<=4?{score:4,label:"Strong",color:"var(--accent-green)"}:{score:5,label:"Very strong",color:"var(--accent-green)"}}function Wr(t=6){const r="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",s=new Uint32Array(t);return crypto.getRandomValues(s),Array.from(s,a=>r[a%r.length]).join("")}function mt(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}function gt({steps:t,currentStep:r}){return e.jsx("div",{className:"onboarding-step-indicator",children:t.map((s,a)=>{const n=a+1,o=n===r,i=n<r;return e.jsxs("div",{className:"onboarding-step-wrapper",children:[a>0&&e.jsx("div",{className:`onboarding-step-line ${i?"completed":""}`}),e.jsx("div",{className:`onboarding-step-circle ${o?"active":""} ${i?"completed":""}`,children:i?e.jsx(rt,{size:14}):n}),e.jsx("span",{className:`onboarding-step-label ${o?"active":""} ${i?"completed":""}`,children:s})]},a)})})}function Vr({value:t,onChange:r,placeholder:s,onKeyDown:a,autoFocus:n,showStrength:o}){const[i,c]=m.useState(!1),l=Fa(t);return e.jsxs("div",{className:"password-field",children:[e.jsxs("div",{className:"password-input-wrapper",children:[e.jsx("input",{type:i?"text":"password",value:t,onChange:r,placeholder:s||"Password",onKeyDown:a,autoFocus:n}),e.jsx("button",{type:"button",className:"password-toggle",onClick:()=>c(!i),tabIndex:-1,"aria-label":i?"Hide password":"Show password",children:i?e.jsx(Rs,{size:18}):e.jsx(Ps,{size:18})})]}),o&&t&&e.jsxs("div",{className:"password-strength",children:[e.jsx("div",{className:"password-strength-bar",children:e.jsx("div",{className:"password-strength-fill",style:{width:`${l.score/5*100}%`,background:l.color}})}),e.jsx("span",{className:"password-strength-label",style:{color:l.color},children:l.label})]})]})}function $a({onForemanAccess:t,onOfficeLogin:r,onShowToast:s}){const[a,n]=m.useState(null),[o,i]=m.useState(""),[c,l]=m.useState(null),[h,_]=m.useState(""),[p,x]=m.useState(!1),[F,b]=m.useState(""),[P,v]=m.useState(null),[M,j]=m.useState(()=>{try{return localStorage.getItem("fieldsync_foreman_name")||""}catch{return""}}),E=m.useRef(null),w=m.useRef(null);m.useEffect(()=>()=>{E.current&&clearTimeout(E.current),w.current&&clearTimeout(w.current)},[]);const[T,L]=m.useState(""),[K,ue]=m.useState(""),[oe,re]=m.useState(1),[Q,A]=m.useState(null),[Y,me]=m.useState(""),[f,k]=m.useState(""),[H,J]=m.useState(""),[q,z]=m.useState(""),[ae,C]=m.useState(!1),[y,X]=m.useState(1),[se,he]=m.useState(""),[W,Z]=m.useState(""),[te,ye]=m.useState(""),[de,fe]=m.useState(""),[qe,Ge]=m.useState(null),Pe=D=>{const _e=D.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20);i(_e)},B=async()=>{if(o.length<2){s("Enter company code","error");return}x(!0);try{const D=await I.getCompanyByCode(o);D?l(D):(s("Invalid company code","error"),i(""))}catch{s("Error checking code","error")}finally{x(!1)}},ce=async D=>{if(D.length===4){x(!0),b("");try{const _e=await I.getProjectByPinSecure(D,c.code);if(_e.rateLimited){b("error"),s("Too many attempts. Please wait 15 minutes.","error"),E.current&&clearTimeout(E.current),E.current=setTimeout(()=>{_(""),b("")},800);return}if(_e.success&&_e.project){v(_e.project);return}if(_e.error){const Ee=await I.getProjectByPinAndCompany(D,c.id);if(Ee){v(Ee);return}}s("Invalid PIN","error"),_("")}catch{try{const Ee=await I.getProjectByPinAndCompany(D,c.id);if(Ee){v(Ee);return}}catch{}s("Error checking PIN","error"),_("")}finally{x(!1)}}},ee=()=>{if(!M.trim()){s("Enter your name to continue","error");return}try{localStorage.setItem("fieldsync_foreman_name",M.trim())}catch{}t(P,M.trim())},Ne=D=>{if(h.length<4&&!p){const _e=h+D;_(_e),b(""),_e.length===4&&(w.current&&clearTimeout(w.current),w.current=setTimeout(()=>ce(_e),150))}},Re=()=>{p||(_(D=>D.slice(0,-1)),b(""))},je=()=>{l(null),_(""),b("")},ke=()=>{if(!T.trim()||!K.trim()){s("Enter email and password","error");return}r(T,K)},Ce=async()=>{if(o.length<2){s("Enter company code","error");return}x(!0);try{const D=await I.getCompanyByCode(o);D?(A(D),re(2)):(s("Invalid company code","error"),i(""))}catch{s("Error checking code","error")}finally{x(!1)}},xe=async()=>{if(!Y.trim()){s("Enter office code","error");return}x(!0);try{const{data:D,error:_e}=await d.rpc("verify_office_code",{company_id:Q.id,code:Y.trim()});if(_e)throw _e;D===!0?re(3):(s("Invalid office code","error"),me(""))}catch{s("Error verifying code","error")}finally{x(!1)}},De=async()=>{if(!p){if(!f.trim()){s("Enter your name","error");return}if(!H.trim()||!mt(H)){s("Enter a valid email address","error");return}if(q.length<6){s("Password must be 6+ characters","error");return}x(!0);try{const D=H.toLowerCase().trim(),{data:_e,error:Ee}=await d.auth.signUp({email:D,password:q});let Fe;if(Ee?.message?.includes("already registered")||_e?.user&&_e.user.identities?.length===0){const{data:$e,error:Ie}=await d.auth.signInWithPassword({email:D,password:q});if(Ie){s("Account exists with different password. Use your existing password.","error"),x(!1);return}Fe=$e.user.id;const{data:Be}=await d.from("user_companies").select("id, status").eq("user_id",Fe).eq("company_id",Q.id).maybeSingle();if(Be){Be.status==="active"?(s("You already belong to this company. Logging you in...","success"),setTimeout(()=>window.location.reload(),1e3)):Be.status==="pending"?(s("Your request is still pending approval.","error"),await d.auth.signOut()):(s("Your membership was removed. Contact the company admin.","error"),await d.auth.signOut());return}const{error:Ke}=await d.from("user_companies").insert({user_id:Fe,company_id:Q.id,role:"member",status:"pending"});if(Ke)throw console.error("Error adding to user_companies:",Ke),await d.auth.signOut(),new Error("Failed to submit join request");await d.auth.signOut(),C(!0)}else{if(Ee)throw Ee;{if(Fe=_e.user?.id,!Fe)throw new Error("Failed to create user");const{error:$e}=await d.from("users").insert({id:Fe,email:D,password_hash:"managed_by_supabase_auth",name:f.trim(),company_id:Q.id,role:"member",is_active:!0});if($e)throw $e;const{error:Ie}=await d.from("user_companies").insert({user_id:Fe,company_id:Q.id,role:"member",status:"pending"});if(Ie)throw console.error("Error adding to user_companies:",Ie),new Error("Failed to submit join request");await d.auth.signOut(),C(!0)}}}catch(D){console.error("Join error:",D),s(D.message||"Error creating account","error")}finally{x(!1)}}},Le=async()=>{if(!p){if(!W.trim()){s("Enter your name","error");return}if(!te.trim()||!mt(te)){s("Enter a valid email address","error");return}if(de.length<6){s("Password must be 6+ characters","error");return}x(!0);try{const D=te.toLowerCase().trim(),_e=Wr(6),Ee=Wr(6),{data:Fe,error:Ye}=await d.auth.signUp({email:D,password:de});if(Ye){if(Ye.message?.includes("already registered"))s("An account with this email already exists. Sign in instead.","error");else throw Ye;return}const $e=Fe.user?.id;if(!$e)throw new Error("Failed to create account");const{data:Ie,error:Be}=await d.from("companies").insert({name:se.trim(),code:_e,office_code:Ee,subscription_tier:"free",owner_user_id:$e}).select().single();if(Be)throw console.error("Company creation error:",Be),new Error("Failed to create company. Please try again.");const{error:Ke}=await d.from("users").insert({id:$e,email:D,password_hash:"managed_by_supabase_auth",name:W.trim(),company_id:Ie.id,role:"admin",is_active:!0});if(Ke)throw console.error("User record error:",Ke),new Error("Failed to set up user profile");const{error:dt}=await d.from("user_companies").insert({user_id:$e,company_id:Ie.id,role:"admin",access_level:"administrator",status:"active"});if(dt)throw console.error("User-company link error:",dt),new Error("Failed to link account to company");Ge({name:Ie.name,code:_e,officeCode:Ee}),X(3)}catch(D){console.error("Registration error:",D),s(D.message||"Error creating company","error")}finally{x(!1)}}},Me=()=>{re(1),A(null),me(""),k(""),J(""),z(""),C(!1),i("")},He=()=>{X(1),he(""),Z(""),ye(""),fe(""),Ge(null)};if(a===null)return e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in-up",children:[e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsxs("div",{className:"entry-buttons stagger-children",children:[e.jsxs("button",{className:"entry-mode-btn foreman",onClick:()=>n("foreman"),children:[e.jsx("span",{className:"entry-mode-icon",children:e.jsx(ot,{size:32})}),e.jsx("span",{className:"entry-mode-title",children:"Foreman"}),e.jsx("span",{className:"entry-mode-desc",children:"Enter project PIN"})]}),e.jsxs("button",{className:"entry-mode-btn office",onClick:()=>n("office"),children:[e.jsx("span",{className:"entry-mode-icon",children:e.jsx(qs,{size:32})}),e.jsx("span",{className:"entry-mode-title",children:"Office"}),e.jsx("span",{className:"entry-mode-desc",children:"Sign in to dashboard"})]})]})]})});if(a==="foreman")return P?e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx("div",{className:"entry-company-badge",children:P.name}),e.jsx("p",{className:"entry-subtitle",children:"Who's checking in?"}),e.jsxs("div",{className:"entry-form",children:[e.jsx("input",{type:"text",value:M,onChange:D=>j(D.target.value),placeholder:"Your name",autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&ee()},style:{fontSize:"1.1rem",textAlign:"center"}}),e.jsx("button",{className:"entry-login-btn",onClick:ee,disabled:!M.trim(),children:"Enter Site"})]}),e.jsx("p",{className:"entry-hint",style:{marginTop:"0.75rem"},children:"Your name will appear on reports and submissions"}),e.jsxs("button",{className:"entry-join-link",style:{marginTop:"0.5rem",display:"flex",alignSelf:"center"},onClick:()=>{v(null),_(""),b("")},children:[e.jsx(Se,{size:16}),e.jsx("span",{children:"Back"})]})]})}):c?e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:je,children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx("div",{className:"entry-company-badge",children:c.name}),e.jsx("p",{className:"entry-subtitle",children:"Enter project PIN"}),e.jsx("div",{className:`pin-display ${F==="error"?"shake":""}`,children:[0,1,2,3].map(D=>e.jsx("div",{className:`pin-dot ${h.length>D?"filled":""} ${F}`,children:h.length>D?"":""},D))}),e.jsxs("div",{className:"number-pad",role:"group","aria-label":"PIN entry keypad",children:[[1,2,3,4,5,6,7,8,9].map(D=>e.jsx("button",{className:"num-btn",onClick:()=>Ne(D.toString()),disabled:p,"aria-label":String(D),children:D},D)),e.jsx("button",{className:"num-btn empty",disabled:!0,"aria-hidden":"true"}),e.jsx("button",{className:"num-btn",onClick:()=>Ne("0"),disabled:p,"aria-label":"0",children:"0"}),e.jsx("button",{className:"num-btn backspace",onClick:Re,disabled:p||h.length===0,"aria-label":"Delete last digit",children:e.jsx(Se,{size:18})})]}),p&&e.jsx("div",{className:"entry-loading",children:e.jsx("div",{className:"spinner"})})]})}):e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>n(null),children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx("p",{className:"entry-subtitle",children:"Enter company code"}),e.jsxs("div",{className:"entry-input-group",children:[e.jsx("input",{type:"text",value:o,onChange:D=>Pe(D.target.value),placeholder:"Company Code",disabled:p,autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&B()}}),e.jsx("button",{className:"entry-submit-btn",onClick:B,disabled:p||o.length<2,children:p?e.jsx("div",{className:"spinner-small"}):e.jsx(jt,{size:20})})]})]})});if(a==="office")return e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>n(null),children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx("p",{className:"entry-subtitle",children:"Sign in to your account"}),e.jsxs("div",{className:"entry-form",children:[e.jsx("input",{type:"email",value:T,onChange:D=>L(D.target.value),placeholder:"Email",autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&ke()}}),e.jsx("input",{type:"password",value:K,onChange:D=>ue(D.target.value),placeholder:"Password",onKeyDown:D=>{D.key==="Enter"&&ke()}}),e.jsx("button",{className:"entry-login-btn",onClick:ke,children:"Sign In"})]}),e.jsx("div",{className:"entry-signup-hint",children:e.jsxs("div",{className:"entry-signup-options",children:[e.jsxs("button",{className:"entry-join-link",onClick:()=>{Me(),n("join")},children:[e.jsx(rs,{size:16}),e.jsx("span",{children:"Join your company"})]}),e.jsxs("button",{className:"entry-join-link",onClick:()=>{He(),n("register")},children:[e.jsx(Ds,{size:16}),e.jsx("span",{children:"Register a new company"})]})]})})]})});if(a==="join")return ae?e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-scale-in",children:[e.jsx("div",{className:"entry-success-icon",children:e.jsx(rt,{size:32})}),e.jsx("h2",{className:"entry-success-title",children:"Request Submitted"}),e.jsxs("p",{className:"entry-success-message",children:["Your request to join ",e.jsx("strong",{children:Q?.name})," has been submitted. A company admin will review and approve your access."]}),e.jsx("p",{className:"entry-success-detail",children:"You'll be able to sign in once approved."}),e.jsx("button",{className:"entry-login-btn",onClick:()=>{Me(),n("office")},style:{marginTop:"1.5rem"},children:"Back to Sign In"})]})}):oe===1?e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>{Me(),n("office")},children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx(gt,{steps:["Company","Verify","Account"],currentStep:1}),e.jsx("p",{className:"entry-subtitle",children:"Enter your company code"}),e.jsx("p",{className:"entry-hint",children:"Ask your manager or admin for the code"}),e.jsxs("div",{className:"entry-input-group",children:[e.jsx("input",{type:"text",value:o,onChange:D=>Pe(D.target.value),placeholder:"Company Code",disabled:p,autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&Ce()}}),e.jsx("button",{className:"entry-submit-btn",onClick:Ce,disabled:p||o.length<2,children:p?e.jsx("div",{className:"spinner-small"}):e.jsx(jt,{size:20})})]})]})}):oe===2?e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>{re(1),A(null),me("")},children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx(gt,{steps:["Company","Verify","Account"],currentStep:2}),e.jsx("div",{className:"entry-company-badge",children:Q?.name}),e.jsx("p",{className:"entry-subtitle",children:"Enter office code"}),e.jsx("p",{className:"entry-hint",children:"This verifies your office access"}),e.jsxs("div",{className:"entry-input-group",children:[e.jsx("input",{type:"password",value:Y,onChange:D=>me(D.target.value),placeholder:"Office Code",disabled:p,autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&xe()}}),e.jsx("button",{className:"entry-submit-btn",onClick:xe,disabled:p||!Y.trim(),children:p?e.jsx("div",{className:"spinner-small"}):e.jsx(jt,{size:20})})]})]})}):e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>{re(2),me("")},children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx(gt,{steps:["Company","Verify","Account"],currentStep:3}),e.jsx("div",{className:"entry-company-badge",children:Q?.name}),e.jsx("p",{className:"entry-subtitle",children:"Create your account"}),e.jsxs("div",{className:"entry-form",children:[e.jsx("input",{type:"text",value:f,onChange:D=>k(D.target.value),placeholder:"Your Name",autoFocus:!0}),e.jsx("input",{type:"email",value:H,onChange:D=>J(D.target.value),placeholder:"Email",className:H&&!mt(H)?"input-error":""}),e.jsx(Vr,{value:q,onChange:D=>z(D.target.value),placeholder:"Password (6+ characters)",onKeyDown:D=>{D.key==="Enter"&&De()},showStrength:!0}),e.jsx("button",{className:"entry-login-btn",onClick:De,disabled:p||!f.trim()||!mt(H)||q.length<6,children:p?e.jsxs("span",{className:"btn-loading",children:[e.jsx("div",{className:"spinner-small"}),"Creating account..."]}):"Join Company"})]}),e.jsx("p",{className:"entry-join-note",children:"You'll join as a team member. Your admin can update your role."})]})});if(a==="register"){if(y===3&&qe)return e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card entry-card-wide animate-scale-in",children:[e.jsx("div",{className:"entry-success-icon",children:e.jsx(rt,{size:32})}),e.jsx("h2",{className:"entry-success-title",children:"Company Created"}),e.jsxs("p",{className:"entry-success-message",children:[e.jsx("strong",{children:qe.name})," is ready to go. Save these codes to share with your team."]}),e.jsxs("div",{className:"entry-codes-grid",children:[e.jsxs("div",{className:"entry-code-card",children:[e.jsx("span",{className:"entry-code-label",children:"Company Code"}),e.jsx("span",{className:"entry-code-value",children:qe.code}),e.jsx("span",{className:"entry-code-hint",children:"Share with all employees"})]}),e.jsxs("div",{className:"entry-code-card",children:[e.jsx("span",{className:"entry-code-label",children:"Office Code"}),e.jsx("span",{className:"entry-code-value",children:qe.officeCode}),e.jsx("span",{className:"entry-code-hint",children:"Office staff only"})]})]}),e.jsx("p",{className:"entry-codes-warning",children:"Save these codes now. You can also find them in your company settings later."}),e.jsx("button",{className:"entry-login-btn",onClick:()=>{window.location.reload()},style:{marginTop:"0.5rem"},children:"Go to Dashboard"})]})});if(y===1)return e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>{He(),n("office")},children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx(gt,{steps:["Company","Your Account"],currentStep:1}),e.jsx("p",{className:"entry-subtitle",children:"Register your company"}),e.jsx("p",{className:"entry-hint",children:"Set up your company on FieldSync"}),e.jsxs("div",{className:"entry-form",children:[e.jsx("input",{type:"text",value:se,onChange:D=>he(D.target.value),placeholder:"Company Name",autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&se.trim()&&X(2)}}),e.jsx("button",{className:"entry-login-btn",onClick:()=>X(2),disabled:!se.trim(),children:"Continue"})]})]})});if(y===2)return e.jsx("div",{className:"entry-container",children:e.jsxs("div",{className:"entry-card animate-fade-in",children:[e.jsx("button",{className:"entry-back",onClick:()=>X(1),children:e.jsx(Se,{size:20})}),e.jsx(Te,{className:"entry-logo",showPoweredBy:!1}),e.jsx(gt,{steps:["Company","Your Account"],currentStep:2}),e.jsx("div",{className:"entry-company-badge",children:se}),e.jsx("p",{className:"entry-subtitle",children:"Create your admin account"}),e.jsxs("div",{className:"entry-form",children:[e.jsx("input",{type:"text",value:W,onChange:D=>Z(D.target.value),placeholder:"Your Name",autoFocus:!0}),e.jsx("input",{type:"email",value:te,onChange:D=>ye(D.target.value),placeholder:"Email",className:te&&!mt(te)?"input-error":""}),e.jsx(Vr,{value:de,onChange:D=>fe(D.target.value),placeholder:"Password (6+ characters)",onKeyDown:D=>{D.key==="Enter"&&Le()},showStrength:!0}),e.jsx("button",{className:"entry-login-btn",onClick:Le,disabled:p||!W.trim()||!mt(te)||de.length<6,children:p?e.jsxs("span",{className:"btn-loading",children:[e.jsx("div",{className:"spinner-small"}),"Setting up company..."]}):"Create Company"})]}),e.jsx("p",{className:"entry-join-note",children:"You'll be the administrator. Company and office codes will be generated for you."})]})})}}function tt({message:t,type:r="",onClose:s}){return m.useEffect(()=>{const a=setTimeout(s,3e3);return()=>clearTimeout(a)},[s]),e.jsx("div",{className:"toast-container",children:e.jsx("div",{className:`toast ${r}`,children:t})})}function Gr({compact:t=!1}){const{theme:r,toggleTheme:s}=Oa();return e.jsx("button",{className:`theme-toggle ${t?"theme-toggle-compact":""}`,onClick:s,title:`Switch to ${r==="dark"?"light":"dark"} mode`,"aria-label":`Switch to ${r==="dark"?"light":"dark"} mode`,children:r==="dark"?e.jsxs(e.Fragment,{children:[e.jsx(ss,{size:t?18:16}),!t&&e.jsx("span",{children:"Light"})]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{size:t?18:16}),!t&&e.jsx("span",{children:"Dark"})]})})}class at extends m.Component{constructor(r){super(r),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(r){return{hasError:!0}}componentDidCatch(r,s){this.setState({error:r,errorInfo:s}),console.error("ErrorBoundary caught an error:",r,s),(r?.message?.includes("Failed to fetch dynamically imported module")||r?.message?.includes("Loading chunk")||r?.message?.includes("Loading CSS chunk"))&&(console.warn("[ErrorBoundary] Chunk load failure detected, clearing cache and reloading..."),"caches"in window?caches.keys().then(n=>{Promise.all(n.map(o=>caches.delete(o))).then(()=>{window.location.reload()})}).catch(n=>{console.warn("[ErrorBoundary] Cache clear failed, reloading anyway:",n.message),window.location.reload()}):window.location.reload())}handleRetry=()=>{this.setState({hasError:!1,error:null,errorInfo:null})};handleReload=()=>{window.location.reload()};render(){return this.state.hasError?e.jsx("div",{className:"error-boundary",children:e.jsxs("div",{className:"error-boundary-content",children:[e.jsx("div",{className:"error-icon",children:e.jsx(Gt,{size:48})}),e.jsx("h2",{children:"Something went wrong"}),e.jsx("p",{children:"We're sorry, but something unexpected happened. Please try again."}),e.jsxs("div",{className:"error-actions",children:[e.jsx("button",{className:"btn btn-primary",onClick:this.handleRetry,children:"Try Again"}),e.jsx("button",{className:"btn btn-secondary",onClick:this.handleReload,children:"Reload Page"})]}),!1]})}):this.props.children}}function Kr(){const[t,r]=m.useState(We()),[s,a]=m.useState(0),[n,o]=m.useState(!1),i=m.useRef(!1),c=m.useRef(null);return m.useEffect(()=>{const l=kr(async _=>{r(_),_&&i.current&&(o(!0),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>o(!1),3e3),i.current=!1),_||(i.current=!0);const p=await zt();a(p)});zt().then(a);const h=setInterval(async()=>{if(!We()){const _=await zt();a(_)}},5e3);return()=>{l(),clearInterval(h),c.current&&clearTimeout(c.current)}},[]),t&&s===0&&!n?null:e.jsxs("div",{className:`offline-indicator ${t?"online":"offline"} ${n?"synced":""}`,children:[e.jsx("div",{className:"offline-indicator-content",children:t?n?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"online-icon",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}),e.jsx("span",{className:"offline-text",children:"Changes synced!"})]}):s>0?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"syncing-icon",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})}),e.jsxs("span",{className:"offline-text",children:["Syncing ",s,"..."]})]}):null:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"offline-icon",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"1",y1:"1",x2:"23",y2:"23"}),e.jsx("path",{d:"M16.72 11.06A10.94 10.94 0 0 1 19 12.55"}),e.jsx("path",{d:"M5 12.55a10.94 10.94 0 0 1 5.17-2.39"}),e.jsx("path",{d:"M10.71 5.05A16 16 0 0 1 22.58 9"}),e.jsx("path",{d:"M1.42 9a15.91 15.91 0 0 1 4.7-2.88"}),e.jsx("path",{d:"M8.53 16.11a6 6 0 0 1 6.95 0"}),e.jsx("line",{x1:"12",y1:"20",x2:"12.01",y2:"20"})]})}),e.jsxs("span",{className:"offline-text",children:["Offline",s>0&&e.jsxs("span",{className:"pending-badge",children:[s," pending"]})]})]})}),e.jsx("style",{children:`
        .offline-indicator {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 9999;
          padding: 10px 16px;
          border-radius: 24px;
          font-size: 14px;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
          from {
            transform: translateX(-50%) translateY(20px);
            opacity: 0;
          }
          to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
          }
        }

        .offline-indicator.offline {
          background: #1f2937;
          color: #fbbf24;
        }

        .offline-indicator.online {
          background: #065f46;
          color: #d1fae5;
        }

        .offline-indicator.synced {
          background: #065f46;
          color: #d1fae5;
        }

        .offline-indicator-content {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .offline-icon,
        .online-icon,
        .syncing-icon {
          display: flex;
          align-items: center;
        }

        .syncing-icon svg {
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        .offline-text {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .pending-badge {
          background: rgba(251, 191, 36, 0.2);
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 12px;
        }

        @media (max-width: 480px) {
          .offline-indicator {
            bottom: 70px; /* Above mobile nav */
            left: 16px;
            right: 16px;
            transform: none;
          }
        }
      `})]})}function Ia(){const[t,r]=m.useState(null),[s,a]=m.useState(!1);m.useEffect(()=>{if(window.matchMedia("(display-mode: standalone)").matches)return;const i=localStorage.getItem("pwa-install-dismissed");if(i){const l=parseInt(i,10);if(Date.now()-l<10080*60*1e3)return}const c=l=>{l.preventDefault(),r(l),a(!0)};return window.addEventListener("beforeinstallprompt",c),()=>window.removeEventListener("beforeinstallprompt",c)},[]);const n=async()=>{if(!t)return;t.prompt();const{outcome:i}=await t.userChoice;i==="accepted"&&a(!1),r(null)},o=()=>{a(!1),localStorage.setItem("pwa-install-dismissed",Date.now().toString())};return s?e.jsxs("div",{className:"install-prompt",children:[e.jsxs("div",{className:"install-prompt-content",children:[e.jsx(ns,{size:20}),e.jsxs("div",{className:"install-prompt-text",children:[e.jsx("strong",{children:"Install FieldSync"}),e.jsx("span",{children:"Add to home screen for quick access"})]})]}),e.jsxs("div",{className:"install-prompt-actions",children:[e.jsx("button",{className:"btn btn-primary btn-small",onClick:n,children:"Install"}),e.jsx("button",{className:"install-prompt-dismiss",onClick:o,"aria-label":"Dismiss",children:e.jsx(wr,{size:18})})]})]}):null}function za({factorId:t,onVerified:r,onCancel:s}){const[a,n]=m.useState(""),[o,i]=m.useState(!1),[c,l]=m.useState(null),h=async()=>{if(a.length===6){i(!0),l(null);try{const{data:p,error:x}=await d.auth.mfa.challenge({factorId:t});if(x)throw x;const{error:F}=await d.auth.mfa.verify({factorId:t,challengeId:p.id,code:a});if(F)throw F;r()}catch{l("Invalid code. Please try again."),n("")}finally{i(!1)}}},_=p=>{p.key==="Enter"&&a.length===6&&h()};return e.jsxs("div",{className:"mfa-challenge",children:[e.jsx("div",{className:"mfa-challenge-icon",children:e.jsx(os,{size:40})}),e.jsx("h2",{children:"Two-Factor Authentication"}),e.jsx("p",{children:"Enter the 6-digit code from your authenticator app"}),e.jsx("div",{className:"mfa-code-input",children:e.jsx("input",{type:"text",value:a,onChange:p=>n(p.target.value.replace(/\D/g,"").slice(0,6)),onKeyDown:_,placeholder:"000000",maxLength:6,autoFocus:!0,inputMode:"numeric",pattern:"[0-9]*",className:"mfa-input-large","aria-label":"MFA verification code"})}),c&&e.jsx("p",{className:"mfa-error",children:c}),e.jsxs("div",{className:"mfa-challenge-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:s,children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:h,disabled:a.length!==6||o,children:o?e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:14,className:"spinner"})," Verifying..."]}):"Verify"})]})]})}function Dn(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}function Ua(t){if(!t||t.length===0)return 0;let r=0;return t.forEach(s=>{s.status==="done"&&(r+=s.weight||0)}),Math.round(r)}function Rn(t){if(!t||t.length===0)return{progress:0,earnedValue:0,totalValue:0,isValueBased:!1};if(t.some(a=>a.scheduled_value>0)){const a=t.reduce((i,c)=>i+(c.scheduled_value||0),0),n=t.filter(i=>i.status==="done").reduce((i,c)=>i+(c.scheduled_value||0),0);return{progress:a>0?Math.round(n/a*100):0,earnedValue:n,totalValue:a,isValueBased:!0}}const s=t.filter(a=>a.status==="done").reduce((a,n)=>a+(n.weight||0),0);return{progress:Math.round(s),earnedValue:0,totalValue:0,isValueBased:!1}}function Ha(t){if(!t||t.length===0)return"not_started";const r=t.some(n=>n.status==="working"),s=t.some(n=>n.status==="done");return t.every(n=>n.status==="done")?"done":r||s?"working":"not_started"}function Pn(t){const r=Ha(t);return r==="done"?"Complete":r==="working"?"In Progress":"Not Started"}function Tn(t,r=0){const s=new Date;s.setHours(0,0,0,0);const a={scheduleStatus:"on_track",scheduleVariance:0,scheduleLabel:"On Track",laborStatus:"on_track",laborVariance:0,laborLabel:null,hasScheduleData:!1,hasLaborData:!1};if(t.start_date&&t.end_date){const n=new Date(t.start_date),o=new Date(t.end_date);n.setHours(0,0,0,0),o.setHours(0,0,0,0);const i=Math.max(1,Math.ceil((o-n)/(1e3*60*60*24))),c=Math.max(0,Math.ceil((s-n)/(1e3*60*60*24))),l=Math.min(100,c/i*100),_=(t.progress||0)-l;a.scheduleVariance=Math.round(_),a.hasScheduleData=!0,_>5?(a.scheduleStatus="ahead",a.scheduleLabel=`Ahead of Schedule (+${a.scheduleVariance}%)`):_<-5?(a.scheduleStatus="behind",a.scheduleLabel=`Behind Schedule (${a.scheduleVariance}%)`):(a.scheduleStatus="on_track",a.scheduleLabel="On Track")}if(t.planned_man_days&&t.planned_man_days>0){const o=(t.progress||0)/100*t.planned_man_days;if(o>0&&r>0){const i=(r-o)/o*100;a.laborVariance=Math.round(i),a.hasLaborData=!0,i>10?(a.laborStatus="over",a.laborLabel=`Over Planned (+${a.laborVariance}% man-days)`):i<-10?(a.laborStatus="under",a.laborLabel=`Under Planned (${a.laborVariance}% man-days)`):(a.laborStatus="on_track",a.laborLabel="Labor On Track")}else r>0&&(a.hasLaborData=!0,a.laborLabel=`${r} man-days used`)}return a}function An(t,r=30){if(t.status==="archived"||t.progress<100)return!1;const s=t.areas||[];if(s.length===0||!s.every(i=>i.status==="done"))return!1;const n=s.reduce((i,c)=>{const l=new Date(c.updated_at);return l>i?l:i},new Date(0));return n.getTime()===0?!1:Math.floor((Date.now()-n.getTime())/(1e3*60*60*24))>=r}const On=t=>{const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return r?[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16)]:[59,130,246]},Ba=(t,r=5e3,s=.85)=>new Promise(a=>{if(!t){a(null);return}const n=new Image;n.crossOrigin="anonymous";const o=setTimeout(()=>{n.src="",a(null)},r);n.onload=()=>{clearTimeout(o);try{const i=document.createElement("canvas");i.width=n.width,i.height=n.height,i.getContext("2d").drawImage(n,0,0);const l=i.toDataURL("image/jpeg",s);a(l)}catch{a(null)}},n.onerror=()=>{clearTimeout(o),a(null)},n.src=t}),Ln=async(t,r=5e3,s=.85)=>!t||t.length===0?[]:await Promise.all(t.map(n=>Ba(n,r,s)));async function Yr(t,r=1920,s=.8){return!t.type.startsWith("image/")||t.size<500*1024?t:new Promise(a=>{const n=document.createElement("canvas"),o=n.getContext("2d"),i=new Image;i.onload=()=>{let{width:c,height:l}=i;c>r&&(l=Math.round(l*r/c),c=r);const h=1920;l>h&&(c=Math.round(c*h/l),l=h),n.width=c,n.height=l,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(i,0,0,c,l),n.toBlob(_=>{if(_){const p=t.name.replace(/\.[^/.]+$/,""),x=new File([_],`${p}.jpg`,{type:"image/jpeg",lastModified:Date.now()});a(x)}else console.warn("Image compression failed, using original"),a(t)},"image/jpeg",s),URL.revokeObjectURL(i.src)},i.onerror=()=>{console.warn("Failed to load image for compression, using original"),URL.revokeObjectURL(i.src),a(t)},i.src=URL.createObjectURL(t)})}const cr=["Containment","PPE","Disposal","Equipment"],Wa={en:{workInfo:"Work Details",crewHours:"Crew & Hours",materialsEquipment:"Materials",evidence:"Evidence",review:"Review",quickActions:"Quick Actions",sameAsYesterday:"Same as Yesterday",setCrewHours:"Set Crew Hours",loading:"Loading...",supervision:"Supervision",operators:"Operators",laborers:"Laborers",addSupervision:"+ Add Supervision",addOperator:"+ Add Operator",addLaborer:"+ Add Laborer",foreman:"Foreman",superintendent:"Superintendent",firstLastName:"First & Last Name",start:"Start",end:"End",regHrs:"Reg Hrs",otHrs:"OT Hrs",selectCategory:"Select a category:",addCustomItem:"+ Add Custom Item",customItem:"Custom Item",itemName:"Item Name",category:"Category",quantity:"Quantity",addItem:"Add Item",cancel:"Cancel",noItemsCategory:"No items in this category yet",workDate:"Work Date",ceNumber:"CE/PCO #",optional:"optional",linkedCOR:"Link to Change Order",selectCOR:"Select COR (optional)",noCORs:"No pending CORs",laborSummary:"Labor Summary",worker:"worker",workers_plural:"workers",totalHours:"Total Hours",regular:"Regular",overtime:"Overtime",materials:"Materials",item:"item",items_plural:"items",noMaterials:"No materials added",notes:"Notes",addNotes:"Add notes about the work performed...",photos:"Photos",addPhotos:"Add Photos",maxPhotos:"max",noPhotos:"No photos added",certification:"Certification",certifyStatement:"I certify that this T&M ticket accurately reflects the work performed.",foremanSignature:"Foreman's Name (Signature)",yourName:"Your name",describeWork:"Describe the work performed",descriptionRequired:"Description is required",whatWorkPerformed:"What work was performed today?",searchMaterials:"Search materials & equipment...",noSearchResults:"No items found",orBrowse:"Or browse by category:",back:"Back",next:"Next",nextCrew:"Next: Crew",nextMaterials:"Next: Materials",reviewItems:"Review",skipNoMaterials:"Skip (no materials)",submitTM:"Submit T&M",submitting:"Submitting...",applySameHours:"Apply Same Hours",batchDescription:"Set start/end time and hours for all workers with names entered.",timeStarted:"Time Started",timeEnded:"Time Ended",regularHours:"Regular Hours",overtimeHours:"Overtime Hours",willApplyTo:"Will apply to",applyToAll:"Apply to All",preset8hr:"8hr Day",preset10hr:"10hr Day",preset4hr:"4hr Day",loadedWorkers:"Loaded {count} workers from {date}",noPreviousCrew:"No previous crew found for this project",appliedHours:"Applied hours to {count} worker(s)",assignedToCOR:"Assigned to COR"},es:{workInfo:"Info del Trabajo",crewHours:"Cuadrilla y Horas",materialsEquipment:"Materiales",evidence:"Evidencia",review:"Revisar",quickActions:"Acciones Rapidas",sameAsYesterday:"Igual que Ayer",setCrewHours:"Poner Horas",loading:"Cargando...",supervision:"Supervision",operators:"Operadores",laborers:"Trabajadores",addSupervision:"+ Agregar Supervision",addOperator:"+ Agregar Operador",addLaborer:"+ Agregar Trabajador",foreman:"Capataz",superintendent:"Superintendente",firstLastName:"Nombre y Apellido",start:"Inicio",end:"Fin",regHrs:"Hrs Reg",otHrs:"Hrs Extra",selectCategory:"Seleccione una categoria:",addCustomItem:"+ Agregar Articulo",customItem:"Articulo Personalizado",itemName:"Nombre del Articulo",category:"Categoria",quantity:"Cantidad",addItem:"Agregar",cancel:"Cancelar",noItemsCategory:"No hay articulos en esta categoria",workDate:"Fecha de Trabajo",ceNumber:"CE/PCO #",optional:"opcional",linkedCOR:"Vincular a Orden de Cambio",selectCOR:"Seleccionar COR (opcional)",noCORs:"No hay CORs pendientes",laborSummary:"Resumen de Mano de Obra",worker:"trabajador",workers_plural:"trabajadores",totalHours:"Horas Totales",regular:"Regular",overtime:"Extra",materials:"Materiales",item:"articulo",items_plural:"articulos",noMaterials:"No se agregaron materiales",notes:"Notas",addNotes:"Agregar notas sobre el trabajo realizado...",photos:"Fotos",addPhotos:"Agregar Fotos",maxPhotos:"max",noPhotos:"No se agregaron fotos",certification:"Certificacion",certifyStatement:"Certifico que este ticket T&M refleja con precision el trabajo realizado.",foremanSignature:"Nombre del Capataz (Firma)",yourName:"Su nombre",describeWork:"Describir el trabajo realizado",descriptionRequired:"Descripcion es requerida",whatWorkPerformed:"Que trabajo se realizo hoy?",searchMaterials:"Buscar materiales y equipo...",noSearchResults:"No se encontraron articulos",orBrowse:"O navegar por categoria:",back:"Atras",next:"Siguiente",nextCrew:"Siguiente: Cuadrilla",nextMaterials:"Siguiente: Materiales",reviewItems:"Revisar",skipNoMaterials:"Saltar (sin materiales)",submitTM:"Enviar T&M",submitting:"Enviando...",applySameHours:"Aplicar Mismas Horas",batchDescription:"Establezca hora de inicio/fin y horas para todos los trabajadores.",timeStarted:"Hora de Inicio",timeEnded:"Hora de Fin",regularHours:"Horas Regulares",overtimeHours:"Horas Extra",willApplyTo:"Se aplicara a",applyToAll:"Aplicar a Todos",preset8hr:"Dia 8hr",preset10hr:"Dia 10hr",preset4hr:"Dia 4hr",loadedWorkers:"Se cargaron {count} trabajadores del {date}",noPreviousCrew:"No se encontro equipo anterior para este proyecto",appliedHours:"Horas aplicadas a {count} trabajador(es)",assignedToCOR:"Asignado a COR"}};function Va({project:t,workDate:r,setWorkDate:s,cePcoNumber:a,setCePcoNumber:n,notes:o,setNotes:i,t:c,lang:l}){return e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-project-info",children:[t.job_number&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Job #"}),e.jsx("span",{className:"tm-project-value",children:t.job_number})]}),e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Project"}),e.jsx("span",{className:"tm-project-value",children:t.name})]}),t.address&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Address"}),e.jsx("span",{className:"tm-project-value",children:t.address})]}),t.general_contractor&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"GC"}),e.jsx("span",{className:"tm-project-value",children:t.general_contractor})]})]}),e.jsxs("div",{className:"tm-field-row",children:[e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:r,onChange:h=>s(h.target.value),className:"tm-date"})]}),e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"CE / PCO #"}),e.jsx("input",{type:"text",placeholder:"Change Event / PCO",value:a,onChange:h=>n(h.target.value),className:"tm-input"})]})]}),e.jsxs("div",{className:"tm-field tm-description-field",children:[e.jsxs("label",{children:[e.jsx(ct,{size:16,className:"inline-icon"}),c("describeWork")," ",e.jsx("span",{className:"tm-required",children:"*"})]}),e.jsx("textarea",{placeholder:c("whatWorkPerformed"),value:o,onChange:h=>i(h.target.value),rows:4,className:`tm-description ${o.trim()?"":"tm-field-required"}`})]})]})}const Ga=t=>{if(!t)return"empty";const r=t.name&&t.name.trim()!=="",s=parseFloat(t.hours)>0||parseFloat(t.overtimeHours)>0;return r?s?"complete":"incomplete":"empty"},Jr=(t,r)=>{if(!t||!r)return null;const[s,a]=t.split(":").map(Number),[n,o]=r.split(":").map(Number);let i=n*60+o-(s*60+a);i<0&&(i+=1440);const c=i/60,l=Math.min(c,8),h=Math.max(0,c-8);return{hours:l.toFixed(1),overtimeHours:h>0?h.toFixed(1):""}};function _t({worker:t,index:r,onUpdate:s,onRemove:a,t:n,roleSelect:o}){const i=Ga(t);return e.jsxs("div",{className:`tm-worker-card-expanded ${i!=="empty"?`worker-${i}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[i==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(rt,{size:14})}),o,e.jsx("input",{type:"text",placeholder:n("firstLastName"),value:t.name,onChange:c=>s(r,"name",c.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>a(r),children:""})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:n("start")}),e.jsx("input",{type:"time",value:t.timeStarted,onChange:c=>s(r,"timeStarted",c.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:n("end")}),e.jsx("input",{type:"time",value:t.timeEnded,onChange:c=>s(r,"timeEnded",c.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:n("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:t.hours,onChange:c=>s(r,"hours",c.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:n("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:t.overtimeHours,onChange:c=>s(r,"overtimeHours",c.target.value)})]})]})]})}function Ka({batchHours:t,setBatchHours:r,namedWorkerCount:s,onApply:a,onClose:n,t:o}){const i=c=>{let l,h,_,p;switch(c){case"full":l="07:00",h="15:30",_="8",p="";break;case"10hr":l="06:00",h="16:30",_="8",p="2";break;case"half":l="07:00",h="11:00",_="4",p="";break;default:return}r({timeStarted:l,timeEnded:h,hours:_,overtimeHours:p})};return e.jsx("div",{className:"tm-modal-overlay",onClick:n,children:e.jsxs("div",{className:"tm-batch-modal",onClick:c=>c.stopPropagation(),children:[e.jsxs("h3",{children:[e.jsx(it,{size:18})," ",o("applySameHours")]}),e.jsx("p",{className:"tm-batch-description",children:o("batchDescription")}),e.jsxs("div",{className:"tm-time-presets",children:[e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>i("full"),children:o("preset8hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>i("10hr"),children:o("preset10hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>i("half"),children:o("preset4hr")})]}),e.jsxs("div",{className:"tm-batch-form",children:[e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:o("timeStarted")}),e.jsx("input",{type:"time",value:t.timeStarted,onChange:c=>{const l=c.target.value,h=Jr(l,t.timeEnded);r({...t,timeStarted:l,...h||{}})}})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:o("timeEnded")}),e.jsx("input",{type:"time",value:t.timeEnded,onChange:c=>{const l=c.target.value,h=Jr(t.timeStarted,l);r({...t,timeEnded:l,...h||{}})}})]})]}),e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:o("regularHours")}),e.jsx("input",{type:"number",placeholder:"8",value:t.hours,onChange:c=>r({...t,hours:c.target.value})})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:o("overtimeHours")}),e.jsx("input",{type:"number",placeholder:"0",value:t.overtimeHours,onChange:c=>r({...t,overtimeHours:c.target.value})})]})]})]}),e.jsxs("div",{className:"tm-batch-preview",children:[e.jsxs("strong",{children:[o("willApplyTo"),":"]}),e.jsxs("span",{children:[s," ",o("workers_plural")]})]}),e.jsxs("div",{className:"tm-batch-actions",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:o("cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:a,disabled:!t.hours&&!t.overtimeHours,children:o("applyToAll")})]})]})})}function Ya({supervision:t,operators:r,laborers:s,dynamicWorkers:a,activeLaborClassIds:n,setActiveLaborClassIds:o,laborCategories:i,laborClasses:c,hasCustomLaborClasses:l,loadingLaborClasses:h,todaysCrew:_,showBatchHoursModal:p,setShowBatchHoursModal:x,batchHours:F,setBatchHours:b,loadingPreviousCrew:P,namedWorkers:v,workersNeedingHours:M,totalRegHours:j,totalOTHours:E,onLoadPreviousCrew:w,onApplyBatchHours:T,onApplyInlinePreset:L,onAddCrewWorker:K,onActivateLaborClass:ue,onDeactivateLaborClass:oe,addSupervision:re,updateSupervision:Q,removeSupervision:A,addOperator:Y,updateOperator:me,removeOperator:f,addLaborer:k,updateLaborer:H,removeLaborer:J,addDynamicWorker:q,updateDynamicWorker:z,removeDynamicWorker:ae,getInactiveLaborClasses:C,t:y,lang:X,onShowToast:se}){const he=v.length;return e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-crew-summary-bar",children:[e.jsxs("div",{className:"tm-summary-left",children:[e.jsx("span",{className:"tm-summary-count",children:v.length}),e.jsx("span",{className:"tm-summary-label",children:v.length===1?y("worker"):y("workers_plural")})]}),e.jsxs("div",{className:"tm-summary-middle",children:[e.jsxs("span",{className:"tm-summary-hours",children:[j+E,"h"]}),e.jsx("span",{className:"tm-summary-label",children:"total"})]}),M>0&&e.jsxs("div",{className:"tm-summary-warning",children:[e.jsx(xr,{size:14}),e.jsxs("span",{children:[M," ",X==="en"?"need hours":"sin horas"]})]})]}),e.jsxs("div",{className:"tm-quick-actions-row",children:[e.jsxs("button",{className:"tm-quick-action",onClick:w,disabled:P,children:[e.jsx(Ts,{size:16}),e.jsx("span",{children:P?X==="en"?"Loading...":"Cargando...":y("sameAsYesterday")})]}),v.length>0&&e.jsxs("div",{className:"tm-time-presets-inline",children:[e.jsx("button",{className:"tm-preset-chip",onClick:()=>L("8hr"),children:"8h"}),e.jsx("button",{className:"tm-preset-chip",onClick:()=>L("10hr"),children:"10h"}),e.jsx("button",{className:"tm-preset-chip",onClick:()=>L("4hr"),children:"4h"}),e.jsx("button",{className:"tm-preset-chip more",onClick:()=>x(!0),title:X==="en"?"Custom hours":"Horas personalizadas",children:e.jsx(it,{size:14})})]})]}),_.length>0&&e.jsxs("div",{className:"tm-crew-select-section",children:[e.jsxs("div",{className:"tm-section-header",children:[e.jsxs("h4",{children:[e.jsx(ot,{size:16})," ",X==="en"?"Select T&M Workers":"Seleccionar Trabajadores T&M"]}),e.jsx("span",{className:"tm-section-hint",children:X==="en"?"Tap to add":"Toca para agregar"})]}),e.jsx("div",{className:"tm-crew-grid",children:_.map((W,Z)=>{const te=t.some(fe=>fe.name.toLowerCase()===W.name.toLowerCase())||r.some(fe=>fe.name.toLowerCase()===W.name.toLowerCase())||s.some(fe=>fe.name.toLowerCase()===W.name.toLowerCase()),ye=Object.values(a).some(fe=>fe.some(qe=>qe.name.toLowerCase()===W.name.toLowerCase())),de=te||ye;return e.jsxs("button",{className:`tm-crew-item ${de?"added":""}`,onClick:()=>{de||K(W)},disabled:de,children:[e.jsx("span",{className:"tm-crew-item-name",children:W.name}),e.jsx("span",{className:`tm-crew-item-role ${(W.role||"laborer").toLowerCase()}`,children:W.role||"Laborer"}),de&&e.jsx("span",{className:"tm-crew-item-check",children:""})]},Z)})})]}),l&&!h&&e.jsxs(e.Fragment,{children:[i.map(W=>{const Z=c.filter(te=>te.category_id===W.id&&n.has(te.id));return Z.length===0?null:e.jsxs("div",{className:"tm-labor-category-section",children:[e.jsx("div",{className:"tm-category-header",children:W.name}),Z.map(te=>e.jsxs("div",{className:"tm-field",children:[e.jsxs("div",{className:"tm-field-header",children:[e.jsx("label",{children:te.name}),e.jsx("button",{type:"button",className:"tm-remove-class-btn",onClick:()=>oe(te.id),title:X==="en"?"Remove this labor class":"Eliminar esta clase",children:""})]}),e.jsx("div",{className:"tm-workers-list",children:(a[te.id]||[]).map((ye,de)=>e.jsx(_t,{worker:ye,index:de,onUpdate:(fe,qe,Ge)=>z(te.id,fe,qe,Ge),onRemove:fe=>ae(te.id,fe),t:y},de))}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>q(te.id),children:["+ ",X==="en"?"Add":"Agregar"," ",te.name]})]},te.id))]},W.id)}),c.filter(W=>!W.category_id&&n.has(W.id)).map(W=>e.jsxs("div",{className:"tm-field",children:[e.jsxs("div",{className:"tm-field-header",children:[e.jsx("label",{children:W.name}),e.jsx("button",{type:"button",className:"tm-remove-class-btn",onClick:()=>oe(W.id),title:X==="en"?"Remove this labor class":"Eliminar esta clase",children:""})]}),e.jsx("div",{className:"tm-workers-list",children:(a[W.id]||[]).map((Z,te)=>e.jsx(_t,{worker:Z,index:te,onUpdate:(ye,de,fe)=>z(W.id,ye,de,fe),onRemove:ye=>ae(W.id,ye),t:y},te))}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>q(W.id),children:["+ ",X==="en"?"Add":"Agregar"," ",W.name]})]},W.id)),C().length>0&&e.jsx("div",{className:"tm-add-labor-class-section",children:e.jsxs("select",{className:"tm-add-labor-class-select",value:"",onChange:W=>{W.target.value&&ue(W.target.value)},children:[e.jsxs("option",{value:"",children:["+ ",X==="en"?"Add Labor Class...":"Agregar Clase de Trabajo..."]}),i.map(W=>{const Z=C().filter(te=>te.category_id===W.id);return Z.length===0?null:e.jsx("optgroup",{label:W.name,children:Z.map(te=>e.jsx("option",{value:te.id,children:te.name},te.id))},W.id)}),C().filter(W=>!W.category_id).length>0&&e.jsx("optgroup",{label:X==="en"?"Other":"Otros",children:C().filter(W=>!W.category_id).map(W=>e.jsx("option",{value:W.id,children:W.name},W.id))})]})}),n.size===0&&e.jsx("div",{className:"tm-no-labor-classes",children:e.jsx("p",{children:X==="en"?"No labor classes added yet. Select from crew check-in above or add manually:":"No hay clases de trabajo agregadas. Seleccione del check-in o agregue manualmente:"})})]}),h&&e.jsxs("div",{className:"tm-loading-labor-classes",children:[e.jsx(pt,{size:20,className:"tm-spinner"}),e.jsx("span",{children:X==="en"?"Loading labor classes...":"Cargando clases de trabajo..."})]}),!l&&!h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:y("supervision")}),e.jsx("div",{className:"tm-workers-list",children:t.map((W,Z)=>e.jsx(_t,{worker:W,index:Z,onUpdate:Q,onRemove:A,t:y,roleSelect:e.jsx("div",{className:"tm-role-select",children:e.jsxs("select",{value:W.role,onChange:te=>Q(Z,"role",te.target.value),children:[e.jsx("option",{value:"Foreman",children:y("foreman")}),e.jsx("option",{value:"Superintendent",children:y("superintendent")})]})})},Z))}),e.jsx("button",{className:"tm-add-btn",onClick:re,children:y("addSupervision")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:y("operators")}),e.jsx("div",{className:"tm-workers-list",children:r.map((W,Z)=>e.jsx(_t,{worker:W,index:Z,onUpdate:me,onRemove:f,t:y},Z))}),e.jsx("button",{className:"tm-add-btn",onClick:Y,children:y("addOperator")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:y("laborers")}),e.jsx("div",{className:"tm-workers-list",children:s.map((W,Z)=>e.jsx(_t,{worker:W,index:Z,onUpdate:H,onRemove:J,t:y},Z))}),e.jsx("button",{className:"tm-add-btn",onClick:k,children:y("addLaborer")})]})]}),p&&e.jsx(Ka,{batchHours:F,setBatchHours:b,namedWorkerCount:he,onApply:T,onClose:()=>x(!1),t:y})]})}function Ja({companyId:t,items:r,setItems:s,t:a,lang:n,onShowToast:o}){const[i,c]=m.useState(null),[l,h]=m.useState([]),[_,p]=m.useState(!1),[x,F]=m.useState(""),[b,P]=m.useState([]),[v,M]=m.useState([]),[j,E]=m.useState(!1),[w,T]=m.useState({name:"",category:"",quantity:""}),L=m.useRef(null),K=m.useRef(null);m.useEffect(()=>{i&&t&&ue(i)},[i,t]),m.useEffect(()=>(!i&&L.current&&(K.current=setTimeout(()=>{L.current?.focus()},100)),()=>{K.current&&clearTimeout(K.current)}),[i]);const ue=async f=>{p(!0);try{const k=await I.getMaterialsEquipmentByCategory(t,f);h(k)}catch(k){console.error("Error loading items:",k),o("Error loading items","error")}finally{p(!1)}},oe=async()=>{if(!(v.length>0))try{const f=[];for(const k of cr){const H=await I.getMaterialsEquipmentByCategory(t,k);f.push(...H.map(J=>({...J,category:k})))}M(f)}catch(f){console.error("Error loading all materials:",f)}},re=f=>{if(F(f),!f.trim()){P([]);return}const k=f.toLowerCase(),H=v.filter(J=>J.name.toLowerCase().includes(k)||J.category.toLowerCase().includes(k));P(H.slice(0,10))},Q=f=>{const k=r.findIndex(H=>H.material_equipment_id===f.id);k>=0?s(r.map((H,J)=>J===k?{...H,quantity:H.quantity+1}:H)):s([...r,{material_equipment_id:f.id,name:f.name,unit:f.unit,category:f.category,quantity:1,isCustom:!1}]),o(`Added ${f.name}`,"success")},A=()=>{if(!w.name||!w.category||!w.quantity){o("Fill in all fields","error");return}s([...r,{material_equipment_id:null,custom_name:w.name,custom_category:w.category,name:w.name,category:w.category,quantity:parseFloat(w.quantity),unit:"each",isCustom:!0}]),T({name:"",category:"",quantity:""}),E(!1),c(null),o("Custom item added","success")},Y=(f,k)=>{const H=parseFloat(k)||0;H<=0?s(r.filter((J,q)=>q!==f)):s(r.map((J,q)=>q===f?{...J,quantity:H}:J))},me=()=>{j?E(!1):i&&(c(null),E(!1))};return i||j?e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-wizard-header",style:{margin:"-1rem -1rem 1rem -1rem",padding:"0.75rem 1rem"},children:[e.jsx("button",{className:"tm-back-btn",onClick:me,children:""}),e.jsx("h2",{children:j?"Add Custom Item":i}),e.jsxs("div",{className:"tm-item-count",children:[r.length," items"]})]}),j?e.jsxs("div",{className:"tm-custom-form",children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Item Name"}),e.jsx("input",{type:"text",placeholder:"What did you use?",value:w.name,onChange:f=>T({...w,name:f.target.value}),autoFocus:!0})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Category"}),e.jsx("div",{className:"tm-category-select",children:cr.map(f=>e.jsx("button",{className:`tm-cat-chip ${w.category===f?"active":""}`,onClick:()=>T({...w,category:f}),children:f},f))})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Quantity"}),e.jsx("input",{type:"number",placeholder:"How many?",value:w.quantity,onChange:f=>T({...w,quantity:f.target.value})})]}),e.jsx("button",{className:"tm-big-btn primary",onClick:A,children:"Add Custom Item"})]}):e.jsx("div",{className:"tm-item-grid",children:_?e.jsx("div",{className:"tm-loading",children:"Loading..."}):e.jsxs(e.Fragment,{children:[l.map(f=>{const k=r.find(H=>H.material_equipment_id===f.id);return e.jsxs("button",{className:`tm-item-card ${k?"added":""}`,onClick:()=>Q(f),children:[e.jsx("span",{className:"tm-item-name",children:f.name}),e.jsx("span",{className:"tm-item-unit",children:f.unit}),k&&e.jsx("span",{className:"tm-item-badge",children:k.quantity})]},f.id)}),e.jsxs("button",{className:"tm-item-card custom",onClick:()=>E(!0),children:[e.jsx("span",{className:"tm-item-name",children:"+ Add Other"}),e.jsx("span",{className:"tm-item-unit",children:"Not on list"})]})]})}),!j&&r.length>0&&e.jsx("div",{className:"tm-wizard-footer",children:e.jsxs("button",{className:"tm-big-btn primary",onClick:()=>c(null),children:["Done Adding (",r.length," items)"]})})]}):e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-field tm-search-field",children:[e.jsxs("div",{className:"tm-search-input-wrapper",children:[e.jsx(As,{size:18,className:"tm-search-icon"}),e.jsx("input",{ref:L,type:"text",placeholder:a("searchMaterials"),value:x,onChange:f=>re(f.target.value),onFocus:()=>oe(),className:"tm-search-input"}),x&&e.jsx("button",{className:"tm-search-clear",onClick:()=>{F(""),P([])},children:""})]}),x&&b.length>0&&e.jsx("div",{className:"tm-search-results",children:b.map((f,k)=>{const H=r.find(J=>J.id===f.id);return e.jsxs("button",{className:`tm-search-result-item ${H?"added":""}`,onClick:()=>{H?Y(r.indexOf(H),H.quantity+1):s([...r,{...f,quantity:1,isCustom:!1}]),F(""),P([])},children:[e.jsx("span",{className:"tm-search-result-name",children:f.name}),e.jsx("span",{className:"tm-search-result-category",children:f.category}),H&&e.jsxs("span",{className:"tm-search-result-qty",children:["",H.quantity]})]},k)})}),x&&b.length===0&&e.jsx("div",{className:"tm-search-no-results",children:a("noSearchResults")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:a("orBrowse")}),e.jsx("div",{className:"tm-category-grid",children:cr.map(f=>{const k=r.filter(H=>H.category===f);return e.jsxs("button",{className:"tm-category-card",onClick:()=>c(f),children:[e.jsx("span",{className:"tm-cat-name",children:f}),k.length>0&&e.jsx("span",{className:"tm-cat-count",children:k.length})]},f)})})]}),r.length>0&&e.jsxs("div",{className:"tm-field",children:[e.jsxs("label",{children:["Added Items (",r.length,")"]}),e.jsx("div",{className:"tm-added-list",children:r.map((f,k)=>e.jsxs("div",{className:"tm-added-item",children:[e.jsxs("div",{className:"tm-added-info",children:[f.isCustom&&e.jsx("span",{className:"tm-custom-badge",children:"Custom"}),e.jsx("span",{className:"tm-added-name",children:f.name})]}),e.jsxs("div",{className:"tm-added-qty",children:[e.jsx("button",{onClick:()=>Y(k,f.quantity-1),children:""}),e.jsx("span",{children:f.quantity}),e.jsx("button",{onClick:()=>Y(k,f.quantity+1),children:"+"})]})]},k))})]})]})}function Qa({photos:t,onPhotoAdd:r,onRemovePhoto:s,maxPhotos:a,selectedCorId:n,setSelectedCorId:o,assignableCORs:i,lang:c}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`tm-action-card-prominent ${t.length>0?"has-content":"needs-action"}`,children:[e.jsxs("div",{className:"tm-action-card-header",children:[e.jsx("div",{className:"tm-action-card-icon",children:e.jsx(pr,{size:24})}),e.jsxs("div",{className:"tm-action-card-title",children:[e.jsx("h4",{children:c==="en"?"Photo Evidence":"Evidencia Fotogrfica"}),e.jsx("span",{className:"tm-action-card-status",children:t.length>0?`${t.length} ${c==="en"?"photo(s) added":"foto(s) agregada(s)"}`:c==="en"?"Recommended for billing":"Recomendado para facturacin"})]})]}),t.length>0&&e.jsx("div",{className:"tm-photo-preview-row",children:t.map(l=>e.jsxs("div",{className:"tm-photo-preview-thumb",children:[e.jsx("img",{src:l.previewUrl,alt:l.name}),e.jsx("button",{className:"tm-photo-remove-x",onClick:()=>s(l.id),children:""})]},l.id))}),e.jsxs("label",{className:`tm-action-card-btn ${t.length===0?"primary":""}`,children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:r,style:{display:"none"}}),e.jsx(pr,{size:18}),e.jsx("span",{children:t.length>0?c==="en"?"Add More Photos":"Agregar Ms Fotos":c==="en"?"Add Photos":"Agregar Fotos"})]})]}),e.jsxs("div",{className:`tm-action-card-prominent ${n?"has-content":""}`,children:[e.jsxs("div",{className:"tm-action-card-header",children:[e.jsx("div",{className:"tm-action-card-icon cor",children:e.jsx(Os,{size:24})}),e.jsxs("div",{className:"tm-action-card-title",children:[e.jsx("h4",{children:c==="en"?"Link to Change Order":"Vincular a Orden de Cambio"}),e.jsx("span",{className:"tm-action-card-status",children:n?`${c==="en"?"Linked to":"Vinculado a"}: ${i.find(l=>l.id===n)?.cor_number||""}`:c==="en"?"Optional - Link this T&M to a COR":"Opcional - Vincular este T&M a un COR"})]})]}),e.jsxs("select",{value:n,onChange:l=>o(l.target.value),className:"tm-cor-select-prominent",children:[e.jsx("option",{value:"",children:c==="en"?"-- Select a COR (optional) --":"-- Seleccionar COR (opcional) --"}),i.map(l=>e.jsxs("option",{value:l.id,children:[l.cor_number,": ",l.title||"Untitled"," (",l.status,")"]},l.id))]}),i.length===0&&e.jsx("p",{className:"tm-cor-hint",children:c==="en"?"No active CORs available for this project":"No hay CORs activos para este proyecto"})]})]})}const Xa=m.lazy(()=>Je(()=>import("./SignatureLinkGenerator-CmyCQfb9.js"),__vite__mapDeps([0,1,2,3,4,5]))),Za=m.lazy(()=>Je(()=>import("./TMClientSignature-DfSsjNK_.js"),__vite__mapDeps([6,1,2,3,4,5])));function en({step:t,setStep:r,project:s,companyId:a,workDate:n,cePcoNumber:o,notes:i,photos:c,onPhotoAdd:l,onRemovePhoto:h,maxPhotos:_,selectedCorId:p,setSelectedCorId:x,assignableCORs:F,items:b,hasCustomLaborClasses:P,validDynamicWorkersList:v,validSupervision:M,validOperators:j,validLaborers:E,totalWorkers:w,totalRegHours:T,totalOTHours:L,submittedByName:K,setSubmittedByName:ue,submittedTicket:oe,submitting:re,submitProgress:Q,clientSigned:A,setClientSigned:Y,showSignatureLinkModal:me,setShowSignatureLinkModal:f,showOnSiteSignature:k,setShowOnSiteSignature:H,onRetryPhotoUpload:J,t:q,lang:z,onShowToast:ae}){return t===5&&oe?e.jsxs("div",{className:"tm-step-content tm-success-step",children:[e.jsxs("div",{className:"tm-success-header",children:[e.jsx("div",{className:"tm-success-icon",children:e.jsx(Ve,{size:48})}),e.jsx("h2",{children:z==="en"?"T&M Ticket Submitted!":"Ticket T&M Enviado!"}),e.jsx("p",{className:"tm-success-subtitle",children:z==="en"?"Your ticket has been saved and is ready for client signature.":"Su ticket ha sido guardado y est listo para la firma del cliente."})]}),e.jsxs("div",{className:"tm-success-summary",children:[e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:w}),e.jsx("span",{className:"tm-success-stat-label",children:z==="en"?"Workers":"Trabajadores"})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:T+L}),e.jsx("span",{className:"tm-success-stat-label",children:z==="en"?"Total Hours":"Horas Total"})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:new Date(n).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),e.jsx("span",{className:"tm-success-stat-label",children:z==="en"?"Work Date":"Fecha"})]})]}),c.some(C=>C.status==="failed")&&e.jsxs("div",{className:"tm-failed-photos-section",children:[e.jsxs("div",{className:"tm-failed-photos-header",children:[e.jsx(xr,{size:18}),e.jsx("span",{children:z==="en"?`${c.filter(C=>C.status==="failed").length} photo(s) failed to upload`:`${c.filter(C=>C.status==="failed").length} foto(s) no se subieron`})]}),e.jsx("div",{className:"tm-failed-photos-grid",children:c.filter(C=>C.status==="failed").map(C=>e.jsxs("div",{className:"tm-failed-photo-item",children:[e.jsx("img",{src:C.previewUrl,alt:C.name}),e.jsx("div",{className:"tm-failed-photo-overlay",children:e.jsx("button",{className:"tm-retry-photo-btn",onClick:()=>J(C.id,oe.id),disabled:C.status==="uploading"||C.status==="compressing",children:C.status==="uploading"||C.status==="compressing"?e.jsx(pt,{size:16,className:"tm-spinner"}):e.jsxs(e.Fragment,{children:[e.jsx(Rr,{size:16}),e.jsx("span",{children:z==="en"?"Retry":"Reintentar"})]})})}),C.error&&e.jsxs("div",{className:"tm-failed-photo-error",title:C.error,children:[C.error.substring(0,20),C.error.length>20?"...":""]})]},C.id))}),e.jsxs("button",{className:"tm-retry-all-btn",onClick:async()=>{const C=c.filter(y=>y.status==="failed");for(const y of C)await J(y.id,oe.id)},children:[e.jsx(Rr,{size:16}),z==="en"?"Retry All Failed Photos":"Reintentar Todas las Fotos"]})]}),c.length>0&&c.every(C=>C.status==="confirmed")&&e.jsxs("div",{className:"tm-photos-success",children:[e.jsx(rt,{size:16}),e.jsx("span",{children:z==="en"?`All ${c.length} photo(s) uploaded successfully`:`${c.length} foto(s) subidas exitosamente`})]}),e.jsxs("div",{className:"tm-signature-options",children:[e.jsx("h3",{children:z==="en"?"Get Client Signature":"Obtener Firma del Cliente"}),e.jsx("p",{className:"tm-signature-description",children:z==="en"?"Have the client sign this T&M ticket to verify the work performed.":"Haga que el cliente firme este ticket T&M para verificar el trabajo realizado."}),A?e.jsxs("div",{className:"tm-signed-confirmation",children:[e.jsx(Ve,{size:32,className:"tm-signed-icon"}),e.jsx("span",{children:z==="en"?"Client signature collected!":"Firma del cliente recopilada!"})]}):e.jsxs("div",{className:"tm-signature-buttons",children:[e.jsxs("button",{className:"tm-signature-option-btn primary",onClick:()=>H(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(wt,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:z==="en"?"Sign Now (On-Site)":"Firmar Ahora"}),e.jsx("span",{className:"tm-signature-option-desc",children:z==="en"?"Client signs on this device":"Cliente firma en este dispositivo"})]})]}),e.jsxs("button",{className:"tm-signature-option-btn",onClick:()=>f(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(wt,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:z==="en"?"Send Signature Link":"Enviar Enlace"}),e.jsx("span",{className:"tm-signature-option-desc",children:z==="en"?"Client signs later via link":"Cliente firma despus va enlace"})]})]})]})]}),me&&e.jsx(m.Suspense,{fallback:e.jsx("div",{className:"loading",children:"Loading..."}),children:e.jsx(Xa,{documentType:"tm_ticket",documentId:oe.id,companyId:a,projectId:s.id,project:s,documentTitle:`T&M - ${new Date(n).toLocaleDateString()}`,onClose:()=>f(!1),onShowToast:ae})}),k&&e.jsx(m.Suspense,{fallback:e.jsx("div",{className:"loading",children:"Loading..."}),children:e.jsx(Za,{ticketId:oe.id,ticketSummary:{workDate:n,workerCount:w,totalHours:T+L},lang:z,onSave:()=>{H(!1),Y(!0)},onClose:()=>H(!1),onShowToast:ae})})]}):e.jsxs("div",{className:"tm-step-content",children:[e.jsx(Qa,{photos:c,onPhotoAdd:l,onRemovePhoto:h,maxPhotos:_,selectedCorId:p,setSelectedCorId:x,assignableCORs:F,lang:z}),e.jsx("div",{className:"tm-review-divider",children:e.jsx("span",{children:z==="en"?"Ticket Summary":"Resumen del Ticket"})}),e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[""," ",q("workDate")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(1),children:z==="en"?"Edit":"Editar"})]}),e.jsxs("div",{className:"tm-review-row",children:[e.jsx("span",{children:new Date(n).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}),o&&e.jsxs("span",{children:["CE/PCO: ",o]})]})]}),i&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ct,{size:16,className:"inline-icon"})," ",q("notes")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(1),children:z==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-notes",children:i})]}),P&&v.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ot,{size:16,className:"inline-icon"})," ",z==="en"?"Workers":"Trabajadores"," (",T+L," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(2),children:z==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:v.map((C,y)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:C.role})," ",C.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[C.time_started&&C.time_ended&&e.jsxs("span",{className:"tm-review-time",children:[C.time_started," - ",C.time_ended]}),e.jsxs("span",{className:"tm-review-hours",children:[C.hours||0," reg",C.overtime_hours>0?` + ${C.overtime_hours} OT`:""]})]})]},y))})]}),!P&&M.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(Ls,{size:16,className:"inline-icon"})," Supervision (",M.reduce((C,y)=>C+parseFloat(y.hours||0)+parseFloat(y.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(2),children:z==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:M.map((C,y)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:C.role})," ",C.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[C.timeStarted&&C.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[C.timeStarted," - ",C.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[C.hours||0," reg",parseFloat(C.overtimeHours)>0?` + ${C.overtimeHours} OT`:""]})]})]},y))})]}),!P&&j.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[""," Operators (",j.reduce((C,y)=>C+parseFloat(y.hours||0)+parseFloat(y.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(2),children:z==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:j.map((C,y)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:C.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[C.timeStarted&&C.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[C.timeStarted," - ",C.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[C.hours||0," reg",parseFloat(C.overtimeHours)>0?` + ${C.overtimeHours} OT`:""]})]})]},y))})]}),!P&&E.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ot,{size:16,className:"inline-icon"})," Laborers (",E.reduce((C,y)=>C+parseFloat(y.hours||0)+parseFloat(y.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(2),children:z==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:E.map((C,y)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:C.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[C.timeStarted&&C.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[C.timeStarted," - ",C.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[C.hours||0," reg",parseFloat(C.overtimeHours)>0?` + ${C.overtimeHours} OT`:""]})]})]},y))})]}),b.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(Ms,{size:16,className:"inline-icon"})," Materials & Equipment (",b.length," items)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>r(3),children:z==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:b.map((C,y)=>e.jsxs("div",{className:"tm-review-row",children:[e.jsxs("span",{children:[C.isCustom&&e.jsxs(e.Fragment,{children:[e.jsx(Fs,{size:14,className:"inline-icon"})," "]}),C.name]}),e.jsxs("span",{children:[C.quantity," ",C.unit]})]},y))})]}),e.jsxs("div",{className:"tm-review-section tm-certification",children:[e.jsx("div",{className:"tm-review-header",children:e.jsxs("span",{children:[e.jsx(wt,{size:16,className:"inline-icon"})," Submitted By"]})}),e.jsx("input",{type:"text",className:"tm-certification-input",placeholder:"Enter your name",value:K,onChange:C=>ue(C.target.value)}),e.jsx("p",{className:"tm-certification-note",children:"By submitting, you certify this T&M is accurate."})]})]})}const Qr=()=>{const t=new Uint8Array(6);return crypto.getRandomValues(t),Array.from(t,r=>r.toString(36)).join("")},Mt=(t,r)=>{if(!t||!r)return null;const[s,a]=t.split(":").map(Number),[n,o]=r.split(":").map(Number);let i=n*60+o-(s*60+a);i<0&&(i+=1440);const c=i/60,l=Math.min(c,8),h=Math.max(0,c-8);return{hours:l.toFixed(1),overtimeHours:h>0?h.toFixed(1):""}};function tn({project:t,companyId:r,maxPhotos:s=10,onSubmit:a,onCancel:n,onShowToast:o}){const[i,c]=m.useState(1),[l,h]=m.useState(new Date().toISOString().split("T")[0]),[_,p]=m.useState(null),[x,F]=m.useState(!1),[b,P]=m.useState(!1),[v,M]=m.useState(!1),[j,E]=m.useState(""),[w,T]=m.useState(""),[L,K]=m.useState(""),[ue,oe]=m.useState([]),[re,Q]=m.useState(!1),[A,Y]=m.useState(!1),[me,f]=m.useState({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),[k,H]=m.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}]),[J,q]=m.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[z,ae]=m.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[C,y]=m.useState([]),[X,se]=m.useState(""),[he,W]=m.useState([]),[Z,te]=m.useState(!1),[ye,de]=m.useState(""),[fe,qe]=m.useState([]),[Ge,Pe]=m.useState(!1),[B,ce]=m.useState("en"),ee=g=>Wa[B][g]||g,[Ne,Re]=m.useState([]),[je,ke]=m.useState([]),[Ce,xe]=m.useState({}),[De,Le]=m.useState(!0),[Me,He]=m.useState(new Set),D=je.length>0;m.useEffect(()=>{Ye(),_e();const g=I.subscribeToCORs?.(t.id,()=>{_e()});return()=>{g?.unsubscribe?.()}},[t.id]),m.useEffect(()=>{(async()=>{if(!r){Le(!1);return}try{const R=await I.getLaborClassesForField(r);Re(R.categories||[]),ke(R.classes||[])}catch(R){console.error("Error loading labor classes:",R)}finally{Le(!1)}})()},[r]),m.useEffect(()=>{if(De||je.length===0)return;const g=new Set;fe.forEach(S=>{S.labor_class_id&&g.add(S.labor_class_id)});const R={},O=new Set;g.forEach(S=>{je.some(N=>N.id===S)&&(R[S]=[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}],O.add(S))}),xe(S=>Object.keys(S).length===0?R:S),He(S=>S.size===0?O:S)},[je,fe,De]);const _e=async()=>{Q(!0);try{const g=await I.getAssignableCORs(t.id);oe(g||[])}catch(g){console.error("Error loading assignable CORs:",g)}finally{Q(!1)}},Ee=()=>{const{timeStarted:g,timeEnded:R,hours:O,overtimeHours:S}=me;let N=0;if(D){const G={};Object.entries(Ce).forEach(([be,le])=>{G[be]=le.map(we=>we&&we.name&&we.name.trim()?(N++,{...we,timeStarted:g,timeEnded:R,hours:O,overtimeHours:S}):we)}),xe(G)}else H(k.map(G=>G&&G.name&&G.name.trim()?(N++,{...G,timeStarted:g,timeEnded:R,hours:O,overtimeHours:S}):G)),q(J.map(G=>G&&G.name&&G.name.trim()?(N++,{...G,timeStarted:g,timeEnded:R,hours:O,overtimeHours:S}):G)),ae(z.map(G=>G&&G.name&&G.name.trim()?(N++,{...G,timeStarted:g,timeEnded:R,hours:O,overtimeHours:S}):G));Y(!1),f({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),N>0?o(ee("appliedHours").replace("{count}",N),"success"):o(B==="en"?"Add workers first":"Agregue trabajadores primero","info")},Fe=g=>{let R,O,S,N;switch(g){case"8hr":R="07:00",O="15:30",S="8",N="";break;case"10hr":R="06:00",O="16:30",S="8",N="2";break;case"4hr":R="07:00",O="11:00",S="4",N="";break;default:return}let G=0;if(D){const be={};Object.entries(Ce).forEach(([le,we])=>{be[le]=we.map(ge=>ge&&ge.name&&ge.name.trim()?(G++,{...ge,timeStarted:R,timeEnded:O,hours:S,overtimeHours:N}):ge)}),xe(be)}else H(be=>be.map(le=>le&&le.name&&le.name.trim()?(G++,{...le,timeStarted:R,timeEnded:O,hours:S,overtimeHours:N}):le)),q(be=>be.map(le=>le&&le.name&&le.name.trim()?(G++,{...le,timeStarted:R,timeEnded:O,hours:S,overtimeHours:N}):le)),ae(be=>be.map(le=>le&&le.name&&le.name.trim()?(G++,{...le,timeStarted:R,timeEnded:O,hours:S,overtimeHours:N}):le));G>0?o(ee("appliedHours").replace("{count}",G),"success"):o(B==="en"?"Add workers first":"Agregue trabajadores primero","info")},Ye=async()=>{try{const g=await I.getCrewCheckin(t.id);g?.workers&&qe(g.workers)}catch(g){console.error("Error loading crew:",g)}},$e=async()=>{Pe(!0);try{const g=await I.getPreviousTicketCrew(t.id,l);if(!g||g.totalWorkers===0){o(ee("noPreviousCrew"),"info");return}D&&g.dynamicWorkers?xe(g.dynamicWorkers):(g.supervision&&H(g.supervision),g.operators&&q(g.operators),g.laborers&&ae(g.laborers));const R=new Date(g.workDate).toLocaleDateString();o(ee("loadedWorkers").replace("{count}",g.totalWorkers).replace("{date}",R),"success")}catch(g){console.error("Error loading previous crew:",g),o(B==="en"?"Error loading previous crew":"Error cargando equipo anterior","error")}finally{Pe(!1)}},Ie=()=>{H([...k,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},Be=(g,R,O)=>{H(k.map((S,N)=>{if(N!==g)return S;const G={...S,[R]:O};if(R==="timeStarted"||R==="timeEnded"){const be=R==="timeStarted"?O:S.timeStarted,le=R==="timeEnded"?O:S.timeEnded,we=Mt(be,le);we&&(G.hours=we.hours,G.overtimeHours=we.overtimeHours)}return G}))},Ke=g=>{k.length>1?H(k.filter((R,O)=>O!==g)):H([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},dt=()=>{ae([...z,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},ht=(g,R,O)=>{ae(z.map((S,N)=>{if(N!==g)return S;const G={...S,[R]:O};if(R==="timeStarted"||R==="timeEnded"){const be=R==="timeStarted"?O:S.timeStarted,le=R==="timeEnded"?O:S.timeEnded,we=Mt(be,le);we&&(G.hours=we.hours,G.overtimeHours=we.overtimeHours)}return G}))},Kt=g=>{z.length>1?ae(z.filter((R,O)=>O!==g)):ae([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Yt=()=>{q([...J,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Nt=(g,R,O)=>{q(J.map((S,N)=>{if(N!==g)return S;const G={...S,[R]:O};if(R==="timeStarted"||R==="timeEnded"){const be=R==="timeStarted"?O:S.timeStarted,le=R==="timeEnded"?O:S.timeEnded,we=Mt(be,le);we&&(G.hours=we.hours,G.overtimeHours=we.overtimeHours)}return G}))},kt=g=>{J.length>1?q(J.filter((R,O)=>O!==g)):q([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Jt=g=>{xe(R=>({...R,[g]:[...R[g]||[],{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))},Qt=(g,R,O,S)=>{xe(N=>({...N,[g]:(N[g]||[]).map((G,be)=>{if(be!==R)return G;const le={...G,[O]:S};if(O==="timeStarted"||O==="timeEnded"){const we=O==="timeStarted"?S:G.timeStarted,ge=O==="timeEnded"?S:G.timeEnded,Ae=Mt(we,ge);Ae&&(le.hours=Ae.hours,le.overtimeHours=Ae.overtimeHours)}return le})}))},Xt=(g,R)=>{xe(O=>{const S=O[g]||[];return S.length>1?{...O,[g]:S.filter((N,G)=>G!==R)}:{...O,[g]:[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}})},$=g=>{g&&(He(R=>new Set([...R,g])),xe(R=>!R[g]||R[g].length===0?{...R,[g]:[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}:R))},st=g=>{He(R=>{const O=new Set(R);return O.delete(g),O}),xe(R=>{const O={...R};return delete O[g],O})},Zt=()=>je.filter(g=>!Me.has(g.id)),er=()=>{if(!Ce||typeof Ce!="object")return[];const g=[];return Object.entries(Ce).forEach(([R,O])=>{if(!Array.isArray(O))return;const S=je.find(N=>N.id===R);O.forEach(N=>{N&&N.name&&N.name.trim()&&(parseFloat(N.hours)>0||parseFloat(N.overtimeHours)>0)&&g.push({name:N.name.trim(),hours:parseFloat(N.hours)||0,overtime_hours:parseFloat(N.overtimeHours)||0,time_started:N.timeStarted||null,time_ended:N.timeEnded||null,role:S?.name||"Worker",labor_class_id:R})})}),g},ws=g=>{if(g.labor_class_id&&D&&je.some(O=>O.id===g.labor_class_id)){Me.has(g.labor_class_id)||He(N=>new Set([...N,g.labor_class_id]));const O=Ce[g.labor_class_id]||[],S=O.findIndex(N=>!N||!N.name||!N.name.trim());if(S>=0){const N=[...O];N[S]={...N[S],name:g.name},xe(G=>({...G,[g.labor_class_id]:N}))}else xe(N=>({...N,[g.labor_class_id]:[...N[g.labor_class_id]||[],{name:g.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))}else{const O=(g.role||"").toLowerCase();if(O.includes("foreman")||O.includes("supervisor")||O.includes("superintendent")){const S=k.findIndex(N=>!N||!N.name||!N.name.trim());S>=0?(Be(S,"name",g.name),Be(S,"role",O.includes("superintendent")?"Superintendent":"Foreman")):H([...k,{name:g.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:O.includes("superintendent")?"Superintendent":"Foreman"}])}else if(O.includes("operator")){const S=J.findIndex(N=>!N||!N.name||!N.name.trim());S>=0?Nt(S,"name",g.name):q([...J,{name:g.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}else{const S=z.findIndex(N=>!N||!N.name||!N.name.trim());S>=0?ht(S,"name",g.name):ae([...z,{name:g.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}}o(`Added ${g.name}`,"success")},xs=g=>{const R=Array.from(g.target.files);if(R.length===0)return;const O=s===-1?1/0:s-he.length;if(O<=0){o(`Photo limit reached (${s} max)`,"error"),g.target.value="";return}const S=R.slice(0,O);S.length<R.length&&o(`Only ${S.length} photo(s) added (${s} max)`,"error");const N=10*1024*1024;S.forEach(G=>{if(!G.type.startsWith("image/")){o("Please select an image file","error");return}if(G.size>N){o(`Photo too large: ${G.name} (max 10MB)`,"error");return}const be=URL.createObjectURL(G),le=`photo-${Date.now()}-${Qr()}`;W(we=>[...we,{id:`${Date.now()}-${Qr()}`,tempId:le,file:G,previewUrl:be,name:G.name,status:"pending",attempts:0,error:null,uploadedUrl:null}])}),g.target.value=""},Xe=(g,R)=>{W(O=>O.map(S=>S.id===g?{...S,...R}:S))},vs=async(g,R)=>{const O=he.find(S=>S.id===g);if(!(!O||O.status!=="failed")){Xe(g,{status:"compressing",error:null});try{let S=O.file;try{S=await Yr(O.file)}catch(G){console.warn("Compression failed, using original:",G)}Xe(g,{status:"uploading"});const N=await I.uploadPhoto(r,t.id,R,S);Xe(g,{status:"confirmed",uploadedUrl:N,attempts:O.attempts+1}),await I.updateTMTicketPhotos(R,[...he.filter(G=>G.uploadedUrl).map(G=>G.uploadedUrl),N]),o("Photo uploaded successfully","success")}catch(S){console.error("Retry failed:",S),Xe(g,{status:"failed",error:S.message||"Upload failed",attempts:O.attempts+1}),o("Photo retry failed","error")}}},Ns=g=>{const R=he.find(O=>O.id===g);R?.previewUrl&&URL.revokeObjectURL(R.previewUrl),W(he.filter(O=>O.id!==g))},St=k.filter(g=>g&&g.name&&g.name.trim()&&(parseFloat(g.hours)>0||parseFloat(g.overtimeHours)>0)),Ct=J.filter(g=>g&&g.name&&g.name.trim()&&(parseFloat(g.hours)>0||parseFloat(g.overtimeHours)>0)),Et=z.filter(g=>g&&g.name&&g.name.trim()&&(parseFloat(g.hours)>0||parseFloat(g.overtimeHours)>0)),qt=er(),Dt=D?qt.length:St.length+Ct.length+Et.length,tr=D?qt.reduce((g,R)=>g+(R.hours||0),0):[...St,...Ct,...Et].reduce((g,R)=>g+parseFloat(R.hours||0),0),rr=D?qt.reduce((g,R)=>g+(R.overtime_hours||0),0):[...St,...Ct,...Et].reduce((g,R)=>g+parseFloat(R.overtimeHours||0),0),Er=D?Object.values(Ce||{}).flat().filter(g=>g&&g.name&&g.name.trim()):[...k.filter(g=>g&&g.name&&g.name.trim()),...J.filter(g=>g&&g.name&&g.name.trim()),...z.filter(g=>g&&g.name&&g.name.trim())],Rt=Er.length-Dt,qr=()=>{if(i===1)return X.trim().length>0;if(i===2){if(D)return er().length>0;const g=k.some(S=>S&&S.name&&S.name.trim()&&(parseFloat(S.hours)>0||parseFloat(S.overtimeHours)>0)),R=J.some(S=>S&&S.name&&S.name.trim()&&(parseFloat(S.hours)>0||parseFloat(S.overtimeHours)>0)),O=z.some(S=>S&&S.name&&S.name.trim()&&(parseFloat(S.hours)>0||parseFloat(S.overtimeHours)>0));return g||R||O}return!0},Dr=(()=>{const g=[];return i===1&&!X.trim()&&g.push(B==="en"?"Description recommended":"Descripcion recomendada"),i===2&&Rt>0&&g.push(B==="en"?`${Rt} worker(s) have no hours entered`:`${Rt} trabajador(es) sin horas`),i===4&&!w.trim()&&g.push(B==="en"?"Name required to submit":"Nombre requerido"),g})(),Pt=()=>{i<4&&c(i+1)},ks=()=>{i>1?c(i-1):n()},Ss=async()=>{if(!w.trim()){o("Enter your name to submit","error");return}let g=[];if(D){if(g=er(),g.length===0){o("Add at least one worker","error");return}}else{const R=k.filter(N=>N&&N.name&&N.name.trim()&&(parseFloat(N.hours)>0||parseFloat(N.overtimeHours)>0)),O=J.filter(N=>N&&N.name&&N.name.trim()&&(parseFloat(N.hours)>0||parseFloat(N.overtimeHours)>0)),S=z.filter(N=>N&&N.name&&N.name.trim()&&(parseFloat(N.hours)>0||parseFloat(N.overtimeHours)>0));if(R.length===0&&O.length===0&&S.length===0){o("Add at least one worker","error");return}g=[...R.map(N=>({name:N.name.trim(),hours:parseFloat(N.hours)||0,overtime_hours:parseFloat(N.overtimeHours)||0,time_started:N.timeStarted||null,time_ended:N.timeEnded||null,role:N.role})),...O.map(N=>({name:N.name.trim(),hours:parseFloat(N.hours)||0,overtime_hours:parseFloat(N.overtimeHours)||0,time_started:N.timeStarted||null,time_ended:N.timeEnded||null,role:"Operator"})),...S.map(N=>({name:N.name.trim(),hours:parseFloat(N.hours)||0,overtime_hours:parseFloat(N.overtimeHours)||0,time_started:N.timeStarted||null,time_ended:N.timeEnded||null,role:"Laborer"}))]}te(!0),de("Creating ticket...");try{const R=await I.createTMTicket({project_id:t.id,work_date:l,ce_pco_number:j.trim()||null,assigned_cor_id:L||null,notes:X.trim()||null,photos:[],created_by_name:w.trim()});if(!R||!R.id)throw new Error("Failed to create ticket - no ticket ID returned");let O=[];const S=he.filter(N=>N.status==="pending");if(S.length>0){de(`Compressing ${S.length} photo${S.length>1?"s":""}...`),S.forEach(ge=>Xe(ge.id,{status:"compressing"}));const N=await Promise.all(S.map(async ge=>{try{const Ae=await Yr(ge.file);return{...ge,file:Ae}}catch(Ae){return console.warn(`Failed to compress photo ${ge.name}, using original:`,Ae),ge}}));de(`Uploading ${S.length} photo${S.length>1?"s":""}...`),S.forEach(ge=>Xe(ge.id,{status:"uploading"}));let G=0,be=0;const le=N.map(async ge=>{try{const Ae=await I.uploadPhoto(r,t.id,R.id,ge.file);return G++,de(`Uploading ${G}/${S.length} photos...`),Xe(ge.id,{status:"confirmed",uploadedUrl:Ae,attempts:(ge.attempts||0)+1}),{id:ge.id,url:Ae}}catch(Ae){return console.error(`Photo ${ge.name} upload failed:`,Ae),be++,Xe(ge.id,{status:"failed",error:Ae.message||"Upload failed",attempts:(ge.attempts||0)+1}),{id:ge.id,url:null,error:Ae.message}}});O=(await Promise.all(le)).filter(ge=>ge.url!==null).map(ge=>ge.url),be>0&&O.length>0?o(`${O.length}/${S.length} photos uploaded. ${be} failed - can retry later.`,"warning"):be>0&&O.length===0&&o(`All ${be} photos failed to upload - can retry after submission.`,"error")}if(O.length>0&&(de("Saving photos..."),await I.updateTMTicketPhotos(R.id,O)),de("Saving workers..."),await I.addTMWorkers(R.id,g),C.length>0&&(de("Saving materials..."),await I.addTMItems(R.id,C.map(N=>({material_equipment_id:N.material_equipment_id,custom_name:N.custom_name||null,custom_category:N.custom_category||null,quantity:N.quantity})))),L){de("Importing to COR...");try{await I.importTicketDataToCOR(R.id,L,r,t.work_type||"demolition",t.job_type||"standard")}catch(N){console.error("Error importing to COR:",N);try{await I.markImportFailed(R.id,L,N?.message||"Import failed")}catch(G){console.error("Error marking import failed:",G)}o("T&M saved. COR data sync failed - retry from ticket list.","warning")}}he.forEach(N=>{N.previewUrl&&URL.revokeObjectURL(N.previewUrl)}),p(R),o("T&M submitted!","success"),c(5)}catch(R){console.error("Error submitting T&M:",R),o("Error submitting T&M","error")}finally{te(!1),de("")}};return e.jsxs("div",{className:"tm-wizard",children:[e.jsxs("div",{className:"tm-wizard-header",children:[i<5?e.jsx("button",{className:"tm-back-btn",onClick:ks,children:""}):e.jsx("div",{className:"tm-success-check",children:e.jsx(Ve,{size:24})}),e.jsxs("h2",{children:[i===1&&ee("workInfo"),i===2&&ee("crewHours"),i===3&&ee("materialsEquipment"),i===4&&ee("review"),i===5&&(B==="en"?"Submitted":"Enviado")]}),e.jsxs("div",{className:"tm-header-right",children:[i<4&&e.jsxs("button",{className:"tm-lang-toggle",onClick:()=>ce(B==="en"?"es":"en"),title:B==="en"?"Cambiar a Espanol":"Switch to English",children:[e.jsx($s,{size:16}),B==="en"?"ES":"EN"]}),i<5&&e.jsxs("div",{className:"tm-step-dots",children:[e.jsx("span",{className:`tm-dot ${i>=1?"active":""}`}),e.jsx("span",{className:`tm-dot ${i>=2?"active":""}`}),e.jsx("span",{className:`tm-dot ${i>=3?"active":""}`}),e.jsx("span",{className:`tm-dot ${i>=4?"active":""}`})]})]})]}),i===1&&e.jsx(Va,{project:t,workDate:l,setWorkDate:h,cePcoNumber:j,setCePcoNumber:E,notes:X,setNotes:se,t:ee,lang:B}),i===2&&e.jsx(Ya,{supervision:k,operators:J,laborers:z,dynamicWorkers:Ce,activeLaborClassIds:Me,setActiveLaborClassIds:He,laborCategories:Ne,laborClasses:je,hasCustomLaborClasses:D,loadingLaborClasses:De,todaysCrew:fe,showBatchHoursModal:A,setShowBatchHoursModal:Y,batchHours:me,setBatchHours:f,loadingPreviousCrew:Ge,namedWorkers:Er,workersNeedingHours:Rt,totalRegHours:tr,totalOTHours:rr,onLoadPreviousCrew:$e,onApplyBatchHours:Ee,onApplyInlinePreset:Fe,onAddCrewWorker:ws,onActivateLaborClass:$,onDeactivateLaborClass:st,addSupervision:Ie,updateSupervision:Be,removeSupervision:Ke,addOperator:Yt,updateOperator:Nt,removeOperator:kt,addLaborer:dt,updateLaborer:ht,removeLaborer:Kt,addDynamicWorker:Jt,updateDynamicWorker:Qt,removeDynamicWorker:Xt,getInactiveLaborClasses:Zt,t:ee,lang:B,onShowToast:o}),i===3&&e.jsx(Ja,{companyId:r,items:C,setItems:y,t:ee,lang:B,onShowToast:o}),(i===4||i===5)&&e.jsx(en,{step:i,setStep:c,project:t,companyId:r,workDate:l,cePcoNumber:j,notes:X,photos:he,onPhotoAdd:xs,onRemovePhoto:Ns,maxPhotos:s,selectedCorId:L,setSelectedCorId:K,assignableCORs:ue,items:C,hasCustomLaborClasses:D,validDynamicWorkersList:qt,validSupervision:St,validOperators:Ct,validLaborers:Et,totalWorkers:Dt,totalRegHours:tr,totalOTHours:rr,submittedByName:w,setSubmittedByName:T,submittedTicket:_,submitting:Z,submitProgress:ye,clientSigned:v,setClientSigned:M,showSignatureLinkModal:x,setShowSignatureLinkModal:F,showOnSiteSignature:b,setShowOnSiteSignature:P,onRetryPhotoUpload:vs,t:ee,lang:B,onShowToast:o}),i<5&&e.jsxs("div",{className:"tm-wizard-footer",children:[Dr.length>0&&e.jsxs("div",{className:"tm-validation-summary",children:[e.jsx(xr,{size:16}),e.jsx("span",{children:Dr[0]})]}),i===1&&e.jsx("button",{className:"tm-big-btn primary",onClick:Pt,disabled:!qr(),children:ee("nextCrew")}),i===2&&e.jsxs("button",{className:"tm-big-btn primary",onClick:Pt,disabled:!qr(),children:[ee("nextMaterials")," (",Dt," ",ee(Dt===1?"worker":"workers_plural"),", ",tr+rr," hrs)"]}),i===3&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:Pt,children:[B==="en"?"Review & Submit":"Revisar y Enviar"," (",C.length," ",C.length===1?ee("item"):ee("items_plural"),")"]}),e.jsx("button",{className:"tm-skip-btn",onClick:Pt,children:ee("skipNoMaterials")})]}),i===4&&e.jsx("button",{className:`tm-big-btn submit ${Z?"submitting":""} ${w.trim()?"ready":"needs-name"}`,onClick:Ss,disabled:Z||!w.trim(),children:Z?e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:20,className:"tm-spinner"}),e.jsx("span",{className:"tm-submit-text",children:ye||ee("submitting")})]}):w.trim()?e.jsxs(e.Fragment,{children:[e.jsx(rt,{size:20}),e.jsx("span",{children:ee("submitTM")})]}):e.jsxs(e.Fragment,{children:[e.jsx(wt,{size:18}),e.jsx("span",{children:B==="en"?"Enter name to submit":"Ingrese nombre"})]})})]}),i===5&&e.jsxs("div",{className:"tm-wizard-footer",children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:a,children:[e.jsx(rt,{size:20}),e.jsx("span",{children:B==="en"?"Done":"Listo"})]}),e.jsx("button",{className:"tm-skip-btn",onClick:a,children:B==="en"?"Skip signature for now":"Saltar firma por ahora"})]})]})}function rn({project:t,companyId:r,onShowToast:s}){const[a,n]=m.useState([]),[o,i]=m.useState(!0),[c,l]=m.useState(!1),[h,_]=m.useState(!1),[p,x]=m.useState({name:"",role:"",labor_class_id:null}),[F,b]=m.useState([]),[P,v]=m.useState(!0),[M,j]=m.useState([]),[E,w]=m.useState([]),[T,L]=m.useState(!0),K=["Foreman","Laborer","Supervisor","Operator"],ue=m.useCallback(async()=>{try{const q=await I.getCrewCheckin(t.id);q?.workers&&n(q.workers)}catch(q){console.error("Error loading crew:",q),s?.("Error loading today's crew","error")}finally{i(!1)}},[t?.id,s]),oe=m.useCallback(async()=>{try{const q=await I.getRecentWorkers(t.id,30);b(q)}catch(q){console.error("Error loading recent workers:",q)}finally{v(!1)}},[t?.id]),re=m.useCallback(async()=>{try{const q=await I.getLaborClassesForField(r);j(q.categories||[]),w(q.classes||[]),q.classes&&q.classes.length>0&&x(z=>({...z,role:q.classes[0].name,labor_class_id:q.classes[0].id}))}catch(q){console.error("Error loading labor classes:",q),s?.("Using default roles - custom labor classes unavailable","info")}finally{L(!1)}},[r,s]);m.useEffect(()=>{t?.id&&(ue(),oe(),r?re():L(!1))},[t?.id,r,ue,oe,re]);const Q=q=>{const z=E.find(ae=>ae.id===q);x(z?{...p,role:z.name,labor_class_id:z.id}:{...p,role:q,labor_class_id:null})},A=async()=>{if(!p.name.trim()){s("Enter worker name","error");return}if(!p.role){s("Select a role","error");return}if(a.find(q=>q.name.toLowerCase()===p.name.trim().toLowerCase())){s("Worker already added","error");return}l(!0);try{const q=[...a,{name:p.name.trim(),role:p.role,labor_class_id:p.labor_class_id}];await I.saveCrewCheckin(t.id,q),n(q),x({...p,name:""}),_(!1),s("Crew member added","success")}catch(q){console.error("Error adding worker:",q),s("Error adding crew member","error")}finally{l(!1)}},Y=async q=>{l(!0);try{const z=a.filter(ae=>ae.name.toLowerCase()!==q.toLowerCase());await I.saveCrewCheckin(t.id,z),n(z),s("Crew member removed","success")}catch(z){console.error("Error removing worker:",z),s("Error removing crew member","error")}finally{l(!1)}},me=async q=>{if(a.find(z=>z.name.toLowerCase()===q.name.toLowerCase())){s("Already checked in","info");return}l(!0);try{const z=[...a,{name:q.name,role:q.role,labor_class_id:q.labor_class_id}];await I.saveCrewCheckin(t.id,z),n(z),s(`${q.name} checked in`,"success")}catch(z){console.error("Error adding worker:",z),s("Error adding crew member","error")}finally{l(!1)}},f=F.filter(q=>!a.find(z=>z.name.toLowerCase()===q.name.toLowerCase())),k=new Date().toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"}),H=()=>{const q={};M.forEach(ae=>{q[ae.id]={name:ae.name,classes:E.filter(C=>C.category_id===ae.id)}});const z=E.filter(ae=>!ae.category_id);return z.length>0&&(q.uncategorized={name:"Other",classes:z}),q},J=E.length>0;return o||T?e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(ot,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:k})]}),e.jsx("div",{className:"crew-loading",children:"Loading..."})]}):e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(ot,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:k})]}),a.length===0?e.jsxs("div",{className:"crew-empty",children:[e.jsx("p",{children:"No crew checked in yet"}),e.jsx("p",{className:"crew-empty-hint",children:"Add your crew for the day"})]}):e.jsx("div",{className:"crew-list",children:a.map(q=>e.jsxs("div",{className:"crew-member",children:[e.jsxs("div",{className:"crew-member-info",children:[e.jsx("span",{className:"crew-member-name",children:q.name}),e.jsx("span",{className:`crew-member-role ${(q.role||"laborer").toLowerCase().replace(/\s+/g,"-")}`,children:q.role})]}),e.jsx("button",{className:"crew-remove-btn",onClick:()=>Y(q.name),disabled:c,children:""})]},q.name))}),!P&&f.length>0&&e.jsxs("div",{className:"crew-quick-add",children:[e.jsx("div",{className:"crew-quick-add-header",children:e.jsx("span",{children:"Tap to add"})}),e.jsx("div",{className:"crew-quick-add-grid",children:f.map(q=>e.jsxs("button",{className:"crew-quick-add-btn",onClick:()=>me(q),disabled:c,children:[e.jsx("span",{className:"crew-quick-add-name",children:q.name}),e.jsx("span",{className:"crew-quick-add-role",children:q.role})]},q.name))})]}),h?e.jsxs("div",{className:"crew-add-form",children:[e.jsx("input",{type:"text",value:p.name,onChange:q=>x({...p,name:q.target.value}),placeholder:"Name",autoFocus:!0}),e.jsx("select",{value:p.labor_class_id||p.role,onChange:q=>Q(q.target.value),children:J?Object.entries(H()).map(([q,z])=>e.jsx("optgroup",{label:z.name,children:z.classes.map(ae=>e.jsx("option",{value:ae.id,children:ae.name},ae.id))},q)):K.map(q=>e.jsx("option",{value:q,children:q},q))}),e.jsxs("div",{className:"crew-add-buttons",children:[e.jsx("button",{className:"crew-add-confirm",onClick:A,disabled:c,children:c?"...":"Add"}),e.jsx("button",{className:"crew-add-cancel",onClick:()=>{_(!1),x({name:"",role:E[0]?.name||"Laborer",labor_class_id:E[0]?.id||null})},children:"Cancel"})]})]}):e.jsxs("button",{className:"crew-add-btn",onClick:()=>_(!0),children:[e.jsx(rs,{size:18}),e.jsx("span",{children:"Add New Person"})]}),e.jsxs("div",{className:"crew-count",children:[a.length," ",a.length===1?"person":"people"," on site"]})]})}function sn({project:t,onShowToast:r,onClose:s}){const[a,n]=m.useState(!0),[o,i]=m.useState(!1),[c,l]=m.useState(null),[h,_]=m.useState(""),[p,x]=m.useState("");m.useEffect(()=>{t?.id&&F()},[t?.id]);const F=async()=>{try{const M=await I.getDailyReport(t.id);if(M)l(M),_(M.field_notes||""),x(M.issues||"");else{const j=await I.compileDailyReport(t.id);l({...j,status:"draft"})}}catch(M){console.error("Error loading report:",M),r("Error loading report","error")}finally{n(!1)}},b=async()=>{if(!u){r("Demo Mode: Report saved locally only - won't reach office","info"),s();return}i(!0);try{await I.saveDailyReport(t.id,{field_notes:h,issues:p}),await I.submitDailyReport(t.id,"Field")?(r("Daily report submitted!","success"),s()):r("Report not sent - check connection","error")}catch(M){console.error("Error submitting report:",M),r("Error submitting report","error")}finally{i(!1)}},P=new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"});if(a)return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:s,children:""}),e.jsx("h2",{children:"Daily Report"})]}),e.jsx("div",{className:"daily-report-loading",children:"Compiling report..."})]});if(!c)return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:s,children:""}),e.jsx("h2",{children:"Daily Report"})]}),e.jsxs("div",{className:"daily-report-error",children:[e.jsx("p",{children:"Unable to load report data."}),e.jsx("button",{className:"btn btn-secondary",onClick:F,children:"Retry"})]})]});const v=c.status==="submitted";return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:s,children:""}),e.jsxs("div",{children:[e.jsx("h2",{children:"Daily Report"}),e.jsx("p",{className:"daily-report-date",children:P})]})]}),v&&e.jsxs("div",{className:"daily-report-submitted-banner",children:[" Submitted ",new Date(c.submitted_at).toLocaleTimeString()]}),e.jsxs("div",{className:"daily-report-content",children:[e.jsxs("div",{className:"daily-report-summary",children:[e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:c.crew_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Crew on Site"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:c.tasks_completed||0}),e.jsx("div",{className:"daily-report-card-label",children:"Tasks Done"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:c.tm_tickets_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"T&M Tickets"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:c.photos_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Photos"})]})]}),c.crew_list?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(ot,{size:18,className:"inline-icon"})," Crew"]}),e.jsx("div",{className:"daily-report-crew",children:c.crew_list.map((M,j)=>e.jsxs("div",{className:"daily-report-crew-item",children:[e.jsx("span",{children:M.name}),e.jsx("span",{className:"daily-report-crew-role",children:M.role})]},j))})]}),c.completed_tasks?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(Is,{size:18,className:"inline-icon"})," Completed Today"]}),e.jsx("ul",{className:"daily-report-tasks",children:c.completed_tasks.map((M,j)=>e.jsxs("li",{children:[M.name,M.group&&e.jsx("span",{className:"daily-report-task-group",children:M.group})]},j))})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(ct,{size:18,className:"inline-icon"})," Notes"]}),e.jsx("textarea",{value:h,onChange:M=>_(M.target.value),placeholder:"Any notes about today's work...",rows:3,disabled:v})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(Gt,{size:18,className:"inline-icon"})," Issues / Concerns"]}),e.jsx("textarea",{value:p,onChange:M=>x(M.target.value),placeholder:"Any problems, delays, or concerns...",rows:3,disabled:v})]})]}),!v&&e.jsxs("div",{className:"daily-report-footer",children:[e.jsx("button",{className:"btn btn-primary daily-report-submit",onClick:b,disabled:o,children:o?"Submitting...":e.jsxs(e.Fragment,{children:[e.jsx(zs,{size:16,className:"inline-icon"})," Submit Report"]})}),e.jsx("p",{className:"daily-report-hint",children:"This will be sent to the office"})]})]})}function an({project:t,companyId:r,user:s,onClose:a,onReportCreated:n}){const[o,i]=m.useState(!1),[c,l]=m.useState(null),[h,_]=m.useState(1),[p,x]=m.useState(new Date().toISOString().split("T")[0]),[F,b]=m.useState(new Date().toTimeString().split(" ")[0].substring(0,5)),[P,v]=m.useState(""),[M,j]=m.useState(""),[E,w]=m.useState("minor"),[T,L]=m.useState(""),[K,ue]=m.useState(""),[oe,re]=m.useState(""),[Q,A]=m.useState(""),[Y,me]=m.useState(""),[f,k]=m.useState(""),[H,J]=m.useState(""),[q,z]=m.useState(s?.name||""),[ae,C]=m.useState(""),[y,X]=m.useState(""),[se,he]=m.useState(s?.email||""),[W,Z]=m.useState([]),[te,ye]=m.useState(""),[de,fe]=m.useState(""),[qe,Ge]=m.useState(""),[Pe,B]=m.useState(""),[ce,ee]=m.useState(!1),[Ne,Re]=m.useState(""),[je,ke]=m.useState(""),[Ce,xe]=m.useState(!1),[De,Le]=m.useState(""),[Me,He]=m.useState(""),[D,_e]=m.useState(""),[Ee,Fe]=m.useState(""),[Ye,$e]=m.useState(!1),[Ie,Be]=m.useState(!1),[Ke,dt]=m.useState(0),[ht,Kt]=m.useState(0),Yt=()=>{if(!te.trim()){l({type:"error",message:"Please enter witness name"});return}const $={name:te,phone:de,email:qe,testimony:Pe};Z([...W,$]),ye(""),fe(""),Ge(""),B(""),l({type:"success",message:"Witness added"})},Nt=$=>{Z(W.filter((st,Zt)=>Zt!==$))},kt=$=>{switch($){case 1:if(!P.trim()||!M.trim())return l({type:"error",message:"Please fill in all incident details"}),!1;break;case 2:if(!K.trim()||!f.trim())return l({type:"error",message:"Please fill in employee name and job title"}),!1;break;case 3:if(!q.trim()||!ae.trim())return l({type:"error",message:"Please fill in supervisor name and title"}),!1;break}return!0},Jt=()=>{kt(h)&&_(h+1)},Qt=()=>{_(h-1)},Xt=async()=>{if(kt(h)){if(!u){l({type:"info",message:"Demo Mode: Report saved locally only - won't reach office"}),setTimeout(()=>{a()},1500);return}i(!0);try{const $={project_id:t.id,company_id:r,incident_date:p,incident_time:F,incident_location:P,incident_description:M,injury_type:E,body_part_affected:T||null,employee_name:K,employee_phone:oe||null,employee_email:Q||null,employee_address:Y||null,employee_job_title:f,employee_hire_date:H||null,medical_treatment_required:ce,medical_facility_name:Ne||null,medical_facility_address:je||null,hospitalized:Ce,reported_by_name:q,reported_by_title:ae,reported_by_phone:y||null,reported_by_email:se||null,witnesses:W,immediate_actions_taken:De||null,corrective_actions_planned:Me||null,safety_equipment_used:D||null,safety_equipment_failed:Ee||null,osha_recordable:Ye,workers_comp_claim:Ie,days_away_from_work:parseInt(Ke)||0,restricted_work_days:parseInt(ht)||0,status:"reported",created_by:s?.id},st=await I.createInjuryReport($);l({type:"success",message:"Injury report submitted successfully"}),n&&n(st),setTimeout(()=>{a()},1500)}catch($){console.error("Error submitting injury report:",$),l({type:"error",message:"Failed to submit injury report"})}finally{i(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal-overlay",onClick:a,children:e.jsxs("div",{className:"modal-content injury-report-modal",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Workplace Injury/Incident Report"}),e.jsx("button",{className:"close-btn",onClick:a,children:""})]}),e.jsxs("div",{className:"progress-steps",children:[e.jsx("div",{className:`step ${h>=1?"active":""}`,children:"1. Incident"}),e.jsx("div",{className:`step ${h>=2?"active":""}`,children:"2. Employee"}),e.jsx("div",{className:`step ${h>=3?"active":""}`,children:"3. Supervisor"}),e.jsx("div",{className:`step ${h>=4?"active":""}`,children:"4. Witnesses"}),e.jsx("div",{className:`step ${h>=5?"active":""}`,children:"5. Medical & Safety"})]}),e.jsxs("div",{className:"modal-body",children:[h===1&&e.jsxs("div",{className:"form-step",children:[e.jsx("h3",{children:"Incident Details"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Date of Incident *"}),e.jsx("input",{type:"date",value:p,onChange:$=>x($.target.value),max:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Time of Incident *"}),e.jsx("input",{type:"time",value:F,onChange:$=>b($.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Location on Site *"}),e.jsx("input",{type:"text",value:P,onChange:$=>v($.target.value),placeholder:"e.g., Floor 2, near elevator shaft"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Incident Description *"}),e.jsx("textarea",{value:M,onChange:$=>j($.target.value),rows:4,placeholder:"Describe what happened in detail..."})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Injury Type *"}),e.jsxs("select",{value:E,onChange:$=>w($.target.value),children:[e.jsx("option",{value:"minor",children:"Minor Injury"}),e.jsx("option",{value:"serious",children:"Serious Injury"}),e.jsx("option",{value:"critical",children:"Critical Injury"}),e.jsx("option",{value:"near_miss",children:"Near Miss (No Injury)"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Body Part Affected"}),e.jsx("input",{type:"text",value:T,onChange:$=>L($.target.value),placeholder:"e.g., Left hand, lower back"})]})]})]}),h===2&&e.jsxs("div",{className:"form-step",children:[e.jsx("h3",{children:"Injured Employee Information"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Full Name *"}),e.jsx("input",{type:"text",value:K,onChange:$=>ue($.target.value),placeholder:"First and last name"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Phone Number"}),e.jsx("input",{type:"tel",value:oe,onChange:$=>re($.target.value),placeholder:"(555) 123-4567"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Email Address"}),e.jsx("input",{type:"email",value:Q,onChange:$=>A($.target.value),placeholder:"email@example.com"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Home Address"}),e.jsx("input",{type:"text",value:Y,onChange:$=>me($.target.value),placeholder:"Street address, city, state, zip"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Title *"}),e.jsx("input",{type:"text",value:f,onChange:$=>k($.target.value),placeholder:"e.g., Carpenter, Electrician"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Hire Date"}),e.jsx("input",{type:"date",value:H,onChange:$=>J($.target.value)})]})]})]}),h===3&&e.jsxs("div",{className:"form-step",children:[e.jsx("h3",{children:"Foreman/Supervisor Making Report"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Your Name *"}),e.jsx("input",{type:"text",value:q,onChange:$=>z($.target.value),placeholder:"Full name"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Your Title *"}),e.jsx("input",{type:"text",value:ae,onChange:$=>C($.target.value),placeholder:"e.g., Site Foreman, Project Manager"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Your Phone Number"}),e.jsx("input",{type:"tel",value:y,onChange:$=>X($.target.value),placeholder:"(555) 123-4567"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Your Email Address"}),e.jsx("input",{type:"email",value:se,onChange:$=>he($.target.value),placeholder:"email@example.com"})]})]}),h===4&&e.jsxs("div",{className:"form-step",children:[e.jsx("h3",{children:"Witness Testimonies (Optional)"}),W.length>0&&e.jsx("div",{className:"witnesses-list",children:W.map(($,st)=>e.jsxs("div",{className:"witness-item",children:[e.jsxs("div",{className:"witness-info",children:[e.jsx("strong",{children:$.name}),$.phone&&e.jsxs("span",{children:["  ",$.phone]}),$.testimony&&e.jsxs("p",{className:"witness-testimony",children:['"',$.testimony,'"']})]}),e.jsx("button",{className:"btn-danger btn-small",onClick:()=>Nt(st),children:"Remove"})]},st))}),e.jsxs("div",{className:"add-witness-form",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Witness Name"}),e.jsx("input",{type:"text",value:te,onChange:$=>ye($.target.value),placeholder:"Full name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Phone Number"}),e.jsx("input",{type:"tel",value:de,onChange:$=>fe($.target.value),placeholder:"(555) 123-4567"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Email Address"}),e.jsx("input",{type:"email",value:qe,onChange:$=>Ge($.target.value),placeholder:"email@example.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Witness Testimony"}),e.jsx("textarea",{value:Pe,onChange:$=>B($.target.value),rows:3,placeholder:"What did the witness see or hear?"})]}),e.jsx("button",{className:"btn-secondary",onClick:Yt,children:"+ Add Witness"})]})]}),h===5&&e.jsxs("div",{className:"form-step",children:[e.jsx("h3",{children:"Medical Treatment & Safety"}),e.jsx("div",{className:"form-group checkbox-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:ce,onChange:$=>ee($.target.checked)}),"Medical treatment required"]})}),ce&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Medical Facility Name"}),e.jsx("input",{type:"text",value:Ne,onChange:$=>Re($.target.value),placeholder:"Hospital or clinic name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Medical Facility Address"}),e.jsx("input",{type:"text",value:je,onChange:$=>ke($.target.value),placeholder:"Street address"})]}),e.jsx("div",{className:"form-group checkbox-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:Ce,onChange:$=>xe($.target.checked)}),"Employee was hospitalized"]})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Immediate Actions Taken"}),e.jsx("textarea",{value:De,onChange:$=>Le($.target.value),rows:2,placeholder:"What was done immediately after the incident?"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Corrective Actions Planned"}),e.jsx("textarea",{value:Me,onChange:$=>He($.target.value),rows:2,placeholder:"What will be done to prevent this in the future?"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Safety Equipment Used"}),e.jsx("input",{type:"text",value:D,onChange:$=>_e($.target.value),placeholder:"e.g., Hard hat, gloves, harness"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Safety Equipment Failed"}),e.jsx("input",{type:"text",value:Ee,onChange:$=>Fe($.target.value),placeholder:"Equipment that failed, if any"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Days Away From Work"}),e.jsx("input",{type:"number",min:"0",value:Ke,onChange:$=>dt($.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Restricted Work Days"}),e.jsx("input",{type:"number",min:"0",value:ht,onChange:$=>Kt($.target.value)})]})]}),e.jsx("div",{className:"form-group checkbox-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:Ye,onChange:$=>$e($.target.checked)}),"OSHA Recordable Incident"]})}),e.jsx("div",{className:"form-group checkbox-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:Ie,onChange:$=>Be($.target.checked)}),"Workers' Compensation Claim Filed"]})})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsxs("div",{className:"form-actions",children:[h>1&&e.jsx("button",{className:"btn-secondary",onClick:Qt,children:" Back"}),e.jsx("button",{className:"btn-secondary",onClick:a,children:"Cancel"}),h<5?e.jsx("button",{className:"btn-primary",onClick:Jt,children:"Next "}):e.jsx("button",{className:"btn-primary",onClick:Xt,disabled:o,children:o?"Submitting...":"Submit Report"})]})})]})}),c&&e.jsx(tt,{message:c.message,type:c.type,onClose:()=>l(null)}),e.jsx("style",{children:`
        .injury-report-modal {
          max-width: 800px;
          max-height: 90vh;
          overflow-y: auto;
        }

        .progress-steps {
          display: flex;
          justify-content: space-between;
          padding: 1rem 1.5rem;
          border-bottom: 1px solid var(--border-color);
          background-color: var(--bg-elevated);
          overflow-x: auto;
        }

        .progress-steps .step {
          font-size: 0.875rem;
          color: var(--text-muted);
          font-weight: 500;
          white-space: nowrap;
          padding: 0.5rem;
        }

        .progress-steps .step.active {
          color: var(--accent-primary);
          font-weight: 600;
        }

        .form-step h3 {
          margin-top: 0;
          margin-bottom: 1.5rem;
          color: var(--text-primary);
          font-size: 1.25rem;
        }

        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 1rem;
        }

        .form-group {
          margin-bottom: 1rem;
        }

        .form-group label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 500;
          color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
          width: 100%;
          padding: 0.5rem;
          border: 1px solid var(--border-color);
          border-radius: 4px;
          font-size: 1rem;
          background: var(--bg-card);
          color: var(--text-primary);
        }

        .form-group textarea {
          resize: vertical;
        }

        .checkbox-group label {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-weight: normal;
          cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
          width: auto;
          margin: 0;
        }

        .witnesses-list {
          margin-bottom: 1.5rem;
        }

        .witness-item {
          border: 1px solid var(--border-color);
          border-radius: 6px;
          padding: 1rem;
          margin-bottom: 0.5rem;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
        }

        .witness-info {
          flex: 1;
          color: var(--text-primary);
        }

        .witness-testimony {
          margin-top: 0.5rem;
          color: var(--text-secondary);
          font-style: italic;
          font-size: 0.875rem;
        }

        .add-witness-form {
          border: 2px dashed var(--border-color);
          border-radius: 6px;
          padding: 1rem;
          background-color: var(--bg-elevated);
        }

        .modal-footer {
          border-top: 1px solid var(--border-color);
          padding: 1rem 1.5rem;
        }

        .form-actions {
          display: flex;
          justify-content: space-between;
          gap: 0.5rem;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger {
          padding: 0.5rem 1rem;
          border-radius: 6px;
          font-weight: 500;
          cursor: pointer;
          border: none;
        }

        .btn-primary {
          background-color: var(--primary-color, #3b82f6);
          color: white;
        }

        .btn-primary:hover:not(:disabled) {
          opacity: 0.9;
        }

        .btn-primary:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .btn-secondary {
          background-color: var(--bg-elevated);
          color: var(--text-primary);
          border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
          background-color: var(--bg-tertiary);
        }

        .btn-danger {
          background-color: #ef4444;
          color: white;
        }

        .btn-danger:hover {
          background-color: #dc2626;
        }

        .btn-small {
          padding: 0.25rem 0.75rem;
          font-size: 0.875rem;
        }

        @media (max-width: 768px) {
          .injury-report-modal {
            max-width: 100%;
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
          }

          .form-row {
            grid-template-columns: 1fr;
          }

          .progress-steps .step {
            font-size: 0.75rem;
            padding: 0.25rem;
          }
        }
      `})]})}const Ht=[{value:"concrete",label:"Concrete",icon:""},{value:"trash",label:"Trash",icon:""},{value:"metals",label:"Metals",icon:""},{value:"hazardous_waste",label:"Hazardous",icon:""}],nn=t=>Ht.find(r=>r.value===t)||{label:t,icon:""};function on({project:t,user:r=null,date:s,onShowToast:a}){const[n,o]=m.useState([]),[i,c]=m.useState([]),[l,h]=m.useState(!0),[_,p]=m.useState(!1),[x,F]=m.useState(!1),[b,P]=m.useState(!1),[v,M]=m.useState({type:"concrete",count:1}),j=new Date(s).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});m.useEffect(()=>{E(),w()},[t.id,s]);const E=async()=>{try{h(!0);const A=await I.getDisposalLoads(t.id,s);o(A||[])}catch(A){console.error("Error loading disposal loads:",A)}finally{h(!1)}},w=async()=>{try{const Y=(await I.getDisposalLoadsHistory(t.id,14)||[]).filter(f=>f.load_date!==s).reduce((f,k)=>(f[k.load_date]||(f[k.load_date]=[]),f[k.load_date].push(k),f),{}),me=Object.entries(Y).map(([f,k])=>({date:f,loads:k,totalLoads:k.reduce((H,J)=>H+J.load_count,0)})).sort((f,k)=>new Date(k.date)-new Date(f.date));c(me)}catch(A){console.error("Error loading disposal history:",A)}},T=async()=>{if(!(v.count<1)){p(!0);try{await I.addDisposalLoad(t.id,r?.id||null,s,v.type,v.count),await E(),M({type:"concrete",count:1}),F(!1),a?.("Disposal load added","success")}catch(A){console.error("Error adding disposal load:",A),a?.("Error adding load","error")}finally{p(!1)}}},L=async A=>{p(!0);try{await I.deleteDisposalLoad(A),await E(),a?.("Load removed","success")}catch(Y){console.error("Error deleting disposal load:",Y),a?.("Error removing load","error")}finally{p(!1)}},K=async A=>{p(!0);try{await I.addDisposalLoad(t.id,r?.id||null,s,A,1),await E(),a?.("Load added","success")}catch(Y){console.error("Error adding disposal load:",Y),a?.("Error adding load","error")}finally{p(!1)}},ue=async A=>{p(!0);try{await I.updateDisposalLoad(A.id,A.load_type,A.load_count+1),await E()}catch(Y){console.error("Error updating load:",Y),a?.("Error updating load","error")}finally{p(!1)}},oe=async A=>{if(A.load_count<=1){await L(A.id);return}p(!0);try{await I.updateDisposalLoad(A.id,A.load_type,A.load_count-1),await E()}catch(Y){console.error("Error updating load:",Y),a?.("Error updating load","error")}finally{p(!1)}},re=n.reduce((A,Y)=>(A[Y.load_type]||(A[Y.load_type]={items:[],total:0}),A[Y.load_type].items.push(Y),A[Y.load_type].total+=Y.load_count,A),{}),Q=n.reduce((A,Y)=>A+Y.load_count,0);return l?e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsx(Bt,{size:20}),e.jsx("span",{children:"Disposal Loads"})]}),e.jsx("div",{className:"disposal-loading",children:"Loading..."})]}):e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsxs("div",{className:"disposal-title",children:[e.jsx(Bt,{size:20}),e.jsx("span",{children:"Disposal Loads"}),Q>0&&e.jsx("span",{className:"disposal-badge",children:Q})]}),e.jsx("span",{className:"disposal-date",children:j})]}),e.jsx("div",{className:"disposal-quick-add",children:Ht.map(A=>e.jsxs("button",{className:"quick-add-btn",onClick:()=>K(A.value),disabled:_,children:[e.jsx("span",{className:"quick-add-icon",children:A.icon}),e.jsxs("span",{className:"quick-add-label",children:["+ ",A.label]})]},A.value))}),Object.keys(re).length>0?e.jsx("div",{className:"disposal-loads-list",children:Ht.map(A=>{const Y=re[A.value];return Y?e.jsxs("div",{className:"disposal-load-row",children:[e.jsxs("div",{className:"load-info",children:[e.jsx("span",{className:"load-icon",children:A.icon}),e.jsx("span",{className:"load-label",children:A.label})]}),e.jsxs("div",{className:"load-controls",children:[e.jsx("button",{className:"load-btn decrement",onClick:()=>oe(Y.items[0]),disabled:_,children:e.jsx(Pr,{size:16})}),e.jsx("span",{className:"load-count",children:Y.total}),e.jsx("button",{className:"load-btn increment",onClick:()=>ue(Y.items[0]),disabled:_,children:e.jsx($t,{size:16})})]})]},A.value):null})}):e.jsxs("div",{className:"disposal-empty",children:[e.jsxs("p",{children:["No disposal loads recorded for ",j]}),e.jsx("p",{className:"disposal-hint",children:"Tap a button above to add loads"})]}),x&&e.jsxs("div",{className:"disposal-add-form",children:[e.jsxs("div",{className:"add-form-row",children:[e.jsx("select",{value:v.type,onChange:A=>M({...v,type:A.target.value}),className:"load-type-select",children:Ht.map(A=>e.jsxs("option",{value:A.value,children:[A.icon," ",A.label]},A.value))}),e.jsxs("div",{className:"count-input-group",children:[e.jsx("button",{className:"count-btn",onClick:()=>M({...v,count:Math.max(1,v.count-1)}),children:e.jsx(Pr,{size:16})}),e.jsx("input",{type:"number",min:"1",value:v.count,onChange:A=>M({...v,count:parseInt(A.target.value)||1}),className:"count-input"}),e.jsx("button",{className:"count-btn",onClick:()=>M({...v,count:v.count+1}),children:e.jsx($t,{size:16})})]})]}),e.jsxs("div",{className:"add-form-actions",children:[e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:()=>F(!1),children:[e.jsx(wr,{size:16})," Cancel"]}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:T,disabled:_,children:[e.jsx(rt,{size:16})," Add"]})]})]}),!x&&e.jsxs("button",{className:"disposal-add-custom",onClick:()=>F(!0),children:[e.jsx($t,{size:16}),"Add multiple loads"]}),Q>0&&e.jsxs("div",{className:"disposal-summary",children:[e.jsx("strong",{children:Q})," total load",Q!==1?"s":""," today"]}),i.length>0&&e.jsxs("div",{className:"disposal-history-section",children:[e.jsxs("button",{className:"disposal-history-toggle",onClick:()=>P(!b),children:[e.jsx(Us,{size:16}),e.jsxs("span",{children:["View History (",i.length," days)"]}),b?e.jsx(is,{size:16}):e.jsx(Wt,{size:16})]}),b&&e.jsx("div",{className:"disposal-history-list",children:i.map(A=>{const Y=new Date(A.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),me=A.loads.reduce((f,k)=>(f[k.load_type]||(f[k.load_type]=0),f[k.load_type]+=k.load_count,f),{});return e.jsxs("div",{className:"disposal-history-day",children:[e.jsxs("div",{className:"disposal-history-header",children:[e.jsx("span",{className:"disposal-history-date",children:Y}),e.jsxs("span",{className:"disposal-history-total",children:[A.totalLoads," load",A.totalLoads!==1?"s":""]})]}),e.jsx("div",{className:"disposal-history-types",children:Object.entries(me).map(([f,k])=>{const H=nn(f);return e.jsxs("span",{className:"disposal-history-type",children:[H.icon," ",k," ",H.label]},f)})})]},A.date)})})]})]})}const Xr={folder:yt,plans:Vs,specs:ct,permits:os,contracts:Ws,submittals:Bs,rfis:Hs,photos:pr,reports:cs,safety:Gt},Ft={blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b",red:"#ef4444",purple:"#8b5cf6",pink:"#ec4899",gray:"#6b7280",orange:"#f97316"},cn=t=>t?.startsWith("image/")?Gs:t?.includes("spreadsheet")||t?.includes("excel")?Ks:t?.includes("pdf")?ct:Ys,ln=t=>{if(!t)return"0 B";const r=["B","KB","MB","GB"];let s=t,a=0;for(;s>=1024&&a<r.length-1;)s/=1024,a++;return`${s.toFixed(s<10?1:0)} ${r[a]}`};function dn({projectId:t,onShowToast:r}){const[s,a]=m.useState([]),[n,o]=m.useState(!0),[i,c]=m.useState(null),[l,h]=m.useState([]),[_,p]=m.useState(!1),x=m.useRef(null),F=m.useCallback(async()=>{o(!0);try{const j=await I.getProjectFolders(t);a(j)}catch(j){console.error("Error loading folders:",j),r?.("Failed to load folders","error")}finally{o(!1)}},[t,r]),b=m.useCallback(async j=>{if(j){p(!0);try{const E=await I.getFolderDocuments(j);h(E.documents)}catch(E){console.error("Error loading documents:",E),r?.("Failed to load documents","error")}finally{p(!1)}}},[r]);m.useEffect(()=>{F();const j=I.subscribeToDocumentFolders?.(t,()=>{F()}),E=I.subscribeToDocuments?.(t,()=>{F(),x.current&&b(x.current.id)});return()=>{j?.unsubscribe?.(),E?.unsubscribe?.()}},[t,F,b]);const P=async j=>{c(j),x.current=j,await b(j.id)},v=async j=>{try{await I.logDocumentAccess(j.id,"downloaded");const E=j.url||`undefined/storage/v1/object/public/project-documents/${j.storage_path}`;window.open(E,"_blank")}catch(E){console.error("Download error:",E)}},M=()=>{c(null),x.current=null,h([])};if(n)return e.jsx("div",{className:"field-docs",children:e.jsxs("div",{className:"field-docs-loading",children:[e.jsx(pt,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading..."})]})});if(i){const j=Xr[i.icon]||yt,E=Ft[i.color]||Ft.blue;return e.jsxs("div",{className:"field-docs",children:[e.jsxs("div",{className:"field-docs-header",children:[e.jsx("button",{className:"field-docs-back",onClick:M,children:e.jsx(Se,{size:20})}),e.jsxs("div",{className:"field-docs-title",children:[e.jsx("div",{className:"field-docs-title-icon",style:{backgroundColor:`${E}15`},children:e.jsx(j,{size:20,style:{color:E}})}),e.jsxs("div",{className:"field-docs-title-text",children:[e.jsx("h2",{children:i.name}),e.jsxs("span",{children:[l.length," files"]})]})]})]}),e.jsx("div",{className:"field-docs-list",children:_?e.jsxs("div",{className:"field-docs-loading",children:[e.jsx(pt,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading..."})]}):l.length===0?e.jsxs("div",{className:"field-docs-empty",children:[e.jsx(yt,{size:48,style:{color:E,opacity:.3}}),e.jsx("p",{children:"No documents yet"})]}):l.map(w=>{const T=cn(w.mime_type);return e.jsxs("button",{className:"field-doc-item",onClick:()=>v(w),children:[e.jsx("div",{className:"field-doc-icon",children:e.jsx(T,{size:22})}),e.jsxs("div",{className:"field-doc-info",children:[e.jsx("span",{className:"field-doc-name",children:w.name}),e.jsx("span",{className:"field-doc-size",children:ln(w.file_size_bytes)})]}),e.jsx(ns,{size:20,className:"field-doc-download"})]},w.id)})})]})}return e.jsx("div",{className:"field-docs",children:e.jsx("div",{className:"field-docs-grid",children:s.length===0?e.jsxs("div",{className:"field-docs-empty",children:[e.jsx(yt,{size:56}),e.jsx("h3",{children:"No documents"}),e.jsx("p",{children:"Documents will appear here when added"})]}):s.map(j=>{const E=Xr[j.icon]||yt,w=Ft[j.color]||Ft.blue,T=j.document_count||0;return e.jsxs("button",{className:"field-folder-card",onClick:()=>P(j),children:[e.jsx("div",{className:"field-folder-icon",style:{backgroundColor:`${w}12`},children:e.jsx(E,{size:28,style:{color:w}})}),e.jsxs("div",{className:"field-folder-info",children:[e.jsx("span",{className:"field-folder-name",children:j.name}),e.jsxs("span",{className:"field-folder-count",children:[T," ",T===1?"file":"files"]})]}),e.jsx(jt,{size:20,className:"field-folder-arrow"})]},j.id)})})})}function un({project:t,companyId:r,onBack:s}){const[a,n]=m.useState(!0),[o,i]=m.useState("week"),[c,l]=m.useState({areas:[],tickets:[],crewHistory:[],disposalLoads:[],dailyReports:[]});m.useEffect(()=>{t?.id&&h()},[t?.id,o]);const h=async()=>{n(!0);try{const j=new Date,E=new Date;o==="week"?E.setDate(j.getDate()-7):E.setDate(j.getDate()-30);const w=E.toISOString().split("T")[0],T=o==="week"?7:30,[L,K,ue,oe]=await Promise.all([I.getAreas(t.id),I.getTMTickets?.(t.id)||[],I.getDisposalLoadsHistory?.(t.id,T)||[],I.getDailyReports?.(t.id)||[]]),re=[],Q=new Date(E);for(;Q<=j;){const A=Q.toISOString().split("T")[0];try{const Y=await I.getCrewCheckin(t.id,A);re.push({date:A,count:Y?.workers?.length||0,dayName:Q.toLocaleDateString("en-US",{weekday:"short"})})}catch{re.push({date:A,count:0,dayName:Q.toLocaleDateString("en-US",{weekday:"short"})})}Q.setDate(Q.getDate()+1)}l({areas:L,tickets:K.filter(A=>A.work_date>=w),crewHistory:re,disposalLoads:ue,dailyReports:oe.filter(A=>A.report_date>=w)})}catch(j){console.error("Error loading metrics:",j)}finally{n(!1)}},_=m.useRef(null),p=m.useCallback(()=>{_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{h()},300)},[t?.id,o]);m.useEffect(()=>{if(!t?.id)return;const j=[],E=I.subscribeToAreas?.(t.id,p);E&&j.push(E);const w=I.subscribeToCrewCheckins?.(t.id,p);w&&j.push(w);const T=I.subscribeToTMTickets?.(t.id,p);T&&j.push(T);const L=I.subscribeToHaulOffs?.(t.id,p);L&&j.push(L);const K=I.subscribeToDailyReports?.(t.id,p);return K&&j.push(K),()=>{_.current&&clearTimeout(_.current),j.forEach(ue=>I.unsubscribe?.(ue))}},[t?.id,p]);const x=m.useMemo(()=>{const{areas:j,tickets:E,crewHistory:w,disposalLoads:T,dailyReports:L}=c,K=j.length,ue=j.filter(y=>y.status==="done").length,oe=j.filter(y=>y.status==="working").length,re=j.filter(y=>y.status==="not_started").length,Q=K>0?Math.round(ue/K*100):0,A=w.reduce((y,X)=>y+X.count,0),Y=w.length>0&&Math.round(A/w.filter(y=>y.count>0).length*10)/10||0,me=w.filter(y=>y.count>0).length,f=E.filter(y=>y.status==="pending"||y.status==="draft").length,k=E.filter(y=>y.status==="signed"||y.status==="approved").length,H=E.reduce((y,X)=>y+(X.total_amount||0),0),J=T.reduce((y,X)=>y+(X.load_count||0),0),q=0,z=L.filter(y=>y.submitted).length,ae=o==="week"?7:30,C=F(L);return{progress:{totalAreas:K,completedAreas:ue,inProgressAreas:oe,notStartedAreas:re,progressPercent:Q},crew:{totalManDays:A,avgCrewSize:Y,daysWithCrew:me,history:w},tickets:{total:E.length,pending:f,signed:k,totalValue:H},disposal:{totalLoads:J,totalTonnage:q},reports:{submitted:z,due:ae,streak:C}}},[c,o]);function F(j){if(!j.length)return 0;const E=[...new Set(j.filter(K=>K.submitted).map(K=>K.report_date))].sort().reverse();let w=0;const T=new Date().toISOString().split("T")[0];let L=new Date(T);for(let K=0;K<30;K++){const ue=L.toISOString().split("T")[0];if(E.includes(ue))w++,L.setDate(L.getDate()-1);else break}return w}const b={primary:"#3b82f6",success:"#22c55e",warning:"#f59e0b",muted:"#6b7280",purple:"#8b5cf6"},P=[b.success,b.primary,b.muted],v=[{name:"Completed",value:x.progress.completedAreas},{name:"In Progress",value:x.progress.inProgressAreas},{name:"Not Started",value:x.progress.notStartedAreas}].filter(j=>j.value>0),M=m.useMemo(()=>{const j={};return c.tickets.forEach(E=>{const w=E.work_date;j[w]=(j[w]||0)+1}),x.crew.history.map(E=>({...E,tickets:j[E.date]||0}))},[c.tickets,x.crew.history]);return a?e.jsxs("div",{className:"foreman-metrics loading",children:[e.jsxs("div",{className:"metrics-header",children:[e.jsxs("button",{className:"back-btn",onClick:s,children:[e.jsx(Se,{size:20}),"Back"]}),e.jsx("h2",{children:"Project Metrics"})]}),e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading metrics..."})]})]}):e.jsxs("div",{className:"foreman-metrics",children:[e.jsxs("div",{className:"metrics-header",children:[e.jsxs("button",{className:"back-btn",onClick:s,children:[e.jsx(Se,{size:20}),"Back"]}),e.jsx("h2",{children:"Project Metrics"}),e.jsxs("div",{className:"time-toggle",children:[e.jsx("button",{className:o==="week"?"active":"",onClick:()=>i("week"),children:"7 Days"}),e.jsx("button",{className:o==="month"?"active":"",onClick:()=>i("month"),children:"30 Days"})]})]}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card progress-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(ls,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsxs("span",{className:"card-value",children:[x.progress.progressPercent,"%"]}),e.jsx("span",{className:"card-label",children:"Complete"})]}),e.jsxs("div",{className:"card-detail",children:[x.progress.completedAreas,"/",x.progress.totalAreas," areas"]})]}),e.jsxs("div",{className:"summary-card crew-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(ds,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsx("span",{className:"card-value",children:x.crew.totalManDays}),e.jsx("span",{className:"card-label",children:"Man-Days"})]}),e.jsxs("div",{className:"card-detail",children:["Avg ",x.crew.avgCrewSize," workers/day"]})]}),e.jsxs("div",{className:"summary-card tickets-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(ct,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsx("span",{className:"card-value",children:x.tickets.total}),e.jsx("span",{className:"card-label",children:"T&M Tickets"})]}),e.jsxs("div",{className:"card-detail",children:[x.tickets.signed," signed, ",x.tickets.pending," pending"]})]}),e.jsxs("div",{className:"summary-card disposal-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(Bt,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsx("span",{className:"card-value",children:x.disposal.totalLoads}),e.jsx("span",{className:"card-label",children:"Disposal Loads"})]}),e.jsxs("div",{className:"card-detail",children:[x.disposal.totalTonnage.toFixed(1)," tons"]})]})]}),e.jsxs("div",{className:"charts-grid",children:[e.jsxs("div",{className:"chart-card",children:[e.jsx("h3",{children:"Area Progress"}),v.length>0?e.jsx(sr,{width:"100%",height:200,children:e.jsxs(da,{children:[e.jsx(ua,{data:v,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:2,dataKey:"value",label:({name:j,value:E})=>`${j}: ${E}`,labelLine:!1,children:v.map((j,E)=>e.jsx(ma,{fill:P[E%P.length]},`cell-${E}`))}),e.jsx(ar,{})]})}):e.jsx("div",{className:"no-data",children:"No area data"})]}),e.jsxs("div",{className:"chart-card",children:[e.jsx("h3",{children:"Daily Crew Size"}),e.jsx(sr,{width:"100%",height:200,children:e.jsxs(pa,{data:x.crew.history,children:[e.jsx(Ar,{strokeDasharray:"3 3",opacity:.3}),e.jsx(Or,{dataKey:"dayName",tick:{fontSize:12}}),e.jsx(Lr,{tick:{fontSize:12}}),e.jsx(ar,{formatter:j=>[j,"Workers"],labelFormatter:j=>`Day: ${j}`}),e.jsx(ha,{dataKey:"count",fill:b.primary,radius:[4,4,0,0]})]})})]}),e.jsxs("div",{className:"chart-card",children:[e.jsx("h3",{children:"T&M Tickets by Day"}),e.jsx(sr,{width:"100%",height:200,children:e.jsxs(fa,{data:M,children:[e.jsx(Ar,{strokeDasharray:"3 3",opacity:.3}),e.jsx(Or,{dataKey:"dayName",tick:{fontSize:12}}),e.jsx(Lr,{tick:{fontSize:12}}),e.jsx(ar,{formatter:j=>[j,"Tickets"]}),e.jsx(ga,{type:"monotone",dataKey:"tickets",stroke:b.success,strokeWidth:2,dot:{fill:b.success,strokeWidth:2}})]})})]}),e.jsxs("div",{className:"chart-card activity-card",children:[e.jsx("h3",{children:"Activity Summary"}),e.jsxs("div",{className:"activity-list",children:[e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${b.success}20`,color:b.success},children:e.jsx(Ve,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"Days with Crew"}),e.jsxs("span",{className:"activity-value",children:[x.crew.daysWithCrew," of ",o==="week"?7:30]})]})]}),e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${b.primary}20`,color:b.primary},children:e.jsx(Js,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"Reports Submitted"}),e.jsx("span",{className:"activity-value",children:x.reports.submitted})]})]}),e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${b.warning}20`,color:b.warning},children:e.jsx(it,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"Report Streak"}),e.jsxs("span",{className:"activity-value",children:[x.reports.streak," days"]})]})]}),x.tickets.totalValue>0&&e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${b.purple}20`,color:b.purple},children:e.jsx(Qs,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"T&M Value"}),e.jsxs("span",{className:"activity-value",children:["$",x.tickets.totalValue.toLocaleString()]})]})]})]})]})]}),e.jsx("style",{children:`
        .foreman-metrics {
          padding: 1rem;
          max-width: 100%;
          overflow-x: hidden;
        }

        .foreman-metrics.loading {
          min-height: 400px;
        }

        .loading-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 3rem;
          color: var(--text-secondary);
        }

        .metrics-header {
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-bottom: 1.5rem;
          flex-wrap: wrap;
        }

        .metrics-header h2 {
          flex: 1;
          margin: 0;
          font-size: 1.25rem;
          color: var(--text-primary);
        }

        .back-btn {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 1rem;
          background: var(--bg-elevated);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          color: var(--text-primary);
          cursor: pointer;
          font-size: 0.875rem;
        }

        .back-btn:hover {
          background: var(--bg-tertiary);
        }

        .time-toggle {
          display: flex;
          background: var(--bg-elevated);
          border-radius: 8px;
          padding: 4px;
          gap: 4px;
        }

        .time-toggle button {
          padding: 0.5rem 1rem;
          border: none;
          background: transparent;
          border-radius: 6px;
          color: var(--text-secondary);
          cursor: pointer;
          font-size: 0.875rem;
          transition: all 0.2s;
        }

        .time-toggle button.active {
          background: var(--primary-color, #3b82f6);
          color: white;
        }

        .summary-cards {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
          margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
          .summary-cards {
            grid-template-columns: repeat(4, 1fr);
          }
        }

        .summary-card {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 1rem;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .card-icon {
          width: 40px;
          height: 40px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .progress-card .card-icon {
          background: #dbeafe;
          color: #3b82f6;
        }

        .crew-card .card-icon {
          background: #dcfce7;
          color: #22c55e;
        }

        .tickets-card .card-icon {
          background: #fef3c7;
          color: #f59e0b;
        }

        .disposal-card .card-icon {
          background: #f3e8ff;
          color: #8b5cf6;
        }

        [data-theme="dark"] .progress-card .card-icon {
          background: #1e3a5f;
        }

        [data-theme="dark"] .crew-card .card-icon {
          background: #14532d;
        }

        [data-theme="dark"] .tickets-card .card-icon {
          background: #451a03;
        }

        [data-theme="dark"] .disposal-card .card-icon {
          background: #3b0764;
        }

        .card-content {
          display: flex;
          flex-direction: column;
        }

        .card-value {
          font-size: 1.5rem;
          font-weight: 700;
          color: var(--text-primary);
          line-height: 1.2;
        }

        .card-label {
          font-size: 0.75rem;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .card-detail {
          font-size: 0.75rem;
          color: var(--text-secondary);
          margin-top: auto;
        }

        .charts-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        @media (min-width: 640px) {
          .charts-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }

        .chart-card {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 1rem;
        }

        .chart-card h3 {
          margin: 0 0 1rem 0;
          font-size: 0.875rem;
          font-weight: 600;
          color: var(--text-primary);
        }

        .no-data {
          height: 200px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--text-secondary);
          font-size: 0.875rem;
        }

        .activity-card {
          grid-column: 1 / -1;
        }

        @media (min-width: 640px) {
          .activity-card {
            grid-column: auto;
          }
        }

        .activity-list {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
        }

        .activity-item {
          display: flex;
          align-items: center;
          gap: 0.75rem;
        }

        .activity-icon {
          width: 40px;
          height: 40px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }

        .activity-info {
          display: flex;
          flex-direction: column;
          flex: 1;
        }

        .activity-label {
          font-size: 0.75rem;
          color: var(--text-secondary);
        }

        .activity-value {
          font-size: 1rem;
          font-weight: 600;
          color: var(--text-primary);
        }

        /* Recharts customization */
        .recharts-cartesian-grid-horizontal line,
        .recharts-cartesian-grid-vertical line {
          stroke: var(--border-color);
        }

        .recharts-text {
          fill: var(--text-secondary);
        }

        .recharts-tooltip-wrapper {
          outline: none;
        }

        .recharts-default-tooltip {
          background: var(--bg-card) !important;
          border: 1px solid var(--border-color) !important;
          border-radius: 8px !important;
        }

        .recharts-tooltip-label {
          color: var(--text-primary) !important;
        }

        .recharts-tooltip-item {
          color: var(--text-secondary) !important;
        }
      `})]})}const lr={crew:{id:"crew",label:"Crew Check-in",icon:ds,description:"Log who's on site today"},tm:{id:"tm",label:"T&M Ticket",icon:ct,description:"Create time & materials ticket"},report:{id:"report",label:"Daily Report",icon:cs,description:"Submit end-of-day report"},progress:{id:"progress",label:"Update Progress",icon:us,description:"Mark tasks complete"},disposal:{id:"disposal",label:"Disposal Loads",icon:Bt,description:"Log haul-off loads"},docs:{id:"docs",label:"Documents",icon:ea,description:"View project files"},metrics:{id:"metrics",label:"Project Metrics",icon:Zs,description:"View charts & trends"},punchlist:{id:"punchlist",label:"Punch List",icon:Xs,description:"View & resolve punch items"},injury:{id:"injury",label:"Report Injury",icon:Gt,description:"Log safety incident",isDanger:!0}},Zr=["crew","tm","report","progress"],es=t=>`fm_pinned_${t}`;function mn({project:t,todayStatus:r,progress:s,areasWorking:a,areasDone:n,areasRemaining:o,punchListOpenCount:i,onNavigate:c,onShowToast:l}){const[h,_]=m.useState(()=>{try{const w=localStorage.getItem(es(t?.id));return w?JSON.parse(w):Zr}catch{return Zr}}),[p,x]=m.useState(!1),[F,b]=m.useState(!0);m.useEffect(()=>{if(t?.id)try{localStorage.setItem(es(t.id),JSON.stringify(h))}catch{}},[h,t?.id]);const P=m.useCallback(w=>{_(T=>T.includes(w)?T.length<=1?(l?.("Keep at least one pinned action","info"),T):T.filter(L=>L!==w):T.length>=5?(l?.("Maximum 5 pinned actions","info"),T):[...T,w])},[l]),v=m.useMemo(()=>Object.keys(lr).filter(w=>!h.includes(w)),[h]),M=m.useCallback(w=>{switch(w){case"crew":return{done:r.crewCheckedIn,badge:r.crewCheckedIn?`${r.crewCount} on site`:null,status:r.crewCheckedIn?"Done today":"Not started"};case"tm":return{done:!1,badge:r.tmTicketsToday>0?`${r.tmTicketsToday} today`:null,status:r.tmTicketsToday>0?`${r.tmTicketsToday} created`:"Create new"};case"report":return{done:r.dailyReportDone,badge:null,status:r.dailyReportDone?"Submitted":"Not submitted"};case"progress":return{done:o===0,badge:o>0?`${o} left`:null,status:`${s}% complete`};case"disposal":return{done:!1,badge:r.disposalLoadsToday>0?`${r.disposalLoadsToday} today`:null,status:r.disposalLoadsToday>0?`${r.disposalLoadsToday} logged`:"Log loads"};case"punchlist":return{done:i===0&&i!==void 0,badge:i>0?`${i} open`:null,status:i>0?`${i} items open`:"All clear"};default:return{done:!1,badge:null,status:null}}},[r,s,o]),j=w=>{const T=lr[w];if(!T)return null;const L=T.icon,K=M(w);return e.jsxs("div",{className:"fm-pinned-card-wrapper",children:[e.jsxs("button",{className:`fm-pinned-card ${K.done?"completed":""} ${T.isDanger?"danger":""}`,onClick:()=>!p&&c(w),disabled:p,children:[e.jsx("div",{className:"fm-pinned-icon",children:e.jsx(L,{size:28})}),e.jsx("span",{className:"fm-pinned-label",children:T.label}),K.badge&&!p&&e.jsx("span",{className:"fm-pinned-badge",children:K.badge}),K.done&&!p&&e.jsx("div",{className:"fm-pinned-check",children:e.jsx(Ve,{size:18})})]}),p&&e.jsx("button",{className:"fm-pin-toggle pinned",onClick:()=>P(w),"aria-label":`Unpin ${T.label}`,children:e.jsx(ra,{size:16})})]},w)},E=w=>{const T=lr[w];if(!T)return null;const L=T.icon,K=M(w);return e.jsxs("div",{className:"fm-action-row-wrapper",children:[e.jsxs("button",{className:`fm-action-row ${T.isDanger?"danger":""}`,onClick:()=>!p&&c(w),disabled:p,children:[e.jsx(L,{size:20}),e.jsx("span",{className:"fm-action-label",children:T.label}),K.badge&&!p&&e.jsx("span",{className:"fm-action-badge",children:K.badge})]}),p&&e.jsx("button",{className:"fm-pin-toggle",onClick:()=>P(w),"aria-label":`Pin ${T.label}`,children:e.jsx(sa,{size:16})})]},w)};return e.jsxs("div",{className:"fm-landing",children:[e.jsxs("button",{className:"fm-metrics-snapshot",onClick:()=>c("metrics"),"aria-label":"View full project metrics",children:[e.jsxs("div",{className:"fm-snapshot-header",children:[e.jsx(ls,{size:18}),e.jsx("span",{children:"Project Overview"}),e.jsx(Wt,{size:16,className:"fm-snapshot-arrow"})]}),e.jsxs("div",{className:"fm-snapshot-stats",children:[e.jsxs("div",{className:"fm-snapshot-stat main",children:[e.jsxs("span",{className:"fm-snapshot-value",children:[s,"%"]}),e.jsx("span",{className:"fm-snapshot-label",children:"Complete"})]}),e.jsx("div",{className:"fm-snapshot-divider"}),e.jsxs("div",{className:"fm-snapshot-stat",children:[e.jsx("span",{className:"fm-snapshot-value",children:a}),e.jsx("span",{className:"fm-snapshot-label",children:"In Progress"})]}),e.jsxs("div",{className:"fm-snapshot-stat",children:[e.jsx("span",{className:"fm-snapshot-value",children:n}),e.jsx("span",{className:"fm-snapshot-label",children:"Done"})]}),e.jsxs("div",{className:"fm-snapshot-stat",children:[e.jsx("span",{className:"fm-snapshot-value",children:o}),e.jsx("span",{className:"fm-snapshot-label",children:"Remaining"})]})]}),r.crewCheckedIn&&e.jsxs("div",{className:"fm-snapshot-today",children:[e.jsx(it,{size:14}),e.jsxs("span",{children:[r.crewCount," crew on site today"]})]})]}),e.jsxs("div",{className:"fm-section-header",children:[e.jsx("h2",{children:"Quick Actions"}),e.jsx("button",{className:`fm-edit-btn ${p?"active":""}`,onClick:()=>x(!p),"aria-label":p?"Done editing":"Customize actions",children:p?"Done":e.jsx(ta,{size:18})})]}),p&&e.jsx("p",{className:"fm-edit-hint",children:"Tap icons to pin/unpin actions"}),e.jsx("div",{className:"fm-pinned-grid",children:h.map(j)}),v.length>0&&e.jsxs("div",{className:"fm-more-section",children:[e.jsxs("button",{className:"fm-more-header",onClick:()=>b(!F),"aria-expanded":!F,children:[e.jsx("span",{children:"More Actions"}),F?e.jsx(Wt,{size:20}):e.jsx(is,{size:20})]}),!F&&e.jsx("div",{className:"fm-more-content",children:v.map(E)})]}),e.jsx("style",{children:`
        .fm-landing {
          padding: 0 1rem 2rem;
        }

        /* Metrics Snapshot */
        .fm-metrics-snapshot {
          width: 100%;
          background: linear-gradient(135deg, var(--primary-color, #3b82f6) 0%, #2563eb 100%);
          border: none;
          border-radius: 16px;
          padding: 1rem;
          color: white;
          text-align: left;
          cursor: pointer;
          margin-bottom: 1.5rem;
          transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .fm-metrics-snapshot:active {
          transform: scale(0.98);
        }

        .fm-snapshot-header {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.875rem;
          opacity: 0.9;
          margin-bottom: 0.75rem;
        }

        .fm-snapshot-arrow {
          margin-left: auto;
          opacity: 0.7;
        }

        .fm-snapshot-stats {
          display: flex;
          align-items: center;
          gap: 0.75rem;
        }

        .fm-snapshot-stat {
          display: flex;
          flex-direction: column;
          align-items: center;
          flex: 1;
        }

        .fm-snapshot-stat.main {
          flex: 1.5;
          align-items: flex-start;
        }

        .fm-snapshot-value {
          font-size: 1.5rem;
          font-weight: 700;
          line-height: 1.2;
        }

        .fm-snapshot-stat.main .fm-snapshot-value {
          font-size: 2rem;
        }

        .fm-snapshot-label {
          font-size: 0.7rem;
          opacity: 0.85;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .fm-snapshot-divider {
          width: 1px;
          height: 40px;
          background: rgba(255,255,255,0.3);
        }

        .fm-snapshot-today {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-top: 0.75rem;
          padding-top: 0.75rem;
          border-top: 1px solid rgba(255,255,255,0.2);
          font-size: 0.8rem;
          opacity: 0.9;
        }

        /* Section Header */
        .fm-section-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 0.75rem;
        }

        .fm-section-header h2 {
          font-size: 1rem;
          font-weight: 600;
          color: var(--text-primary);
          margin: 0;
        }

        .fm-edit-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0.5rem;
          background: var(--bg-elevated);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          color: var(--text-secondary);
          cursor: pointer;
          font-size: 0.8rem;
          min-width: 36px;
          min-height: 36px;
          transition: all 0.15s ease;
        }

        .fm-edit-btn.active {
          background: var(--primary-color, #3b82f6);
          border-color: var(--primary-color, #3b82f6);
          color: white;
          padding: 0.5rem 1rem;
        }

        .fm-edit-hint {
          font-size: 0.8rem;
          color: var(--text-secondary);
          margin: 0 0 0.75rem;
          text-align: center;
        }

        /* Pinned Actions Grid */
        .fm-pinned-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
          margin-bottom: 1.5rem;
        }

        .fm-pinned-card-wrapper {
          position: relative;
        }

        .fm-pinned-card {
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 1.25rem 1rem;
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.15s ease;
          min-height: 110px;
          position: relative;
        }

        .fm-pinned-card:active:not(:disabled) {
          transform: scale(0.97);
          background: var(--bg-elevated);
        }

        .fm-pinned-card:disabled {
          opacity: 0.7;
          cursor: default;
        }

        .fm-pinned-card.completed {
          border-color: #22c55e;
          background: rgba(34, 197, 94, 0.08);
        }

        .fm-pinned-card.danger {
          border-color: #f59e0b;
        }

        .fm-pinned-card.danger .fm-pinned-icon {
          color: #f59e0b;
        }

        .fm-pinned-icon {
          color: var(--primary-color, #3b82f6);
          margin-bottom: 0.5rem;
        }

        .fm-pinned-label {
          font-size: 0.875rem;
          font-weight: 500;
          color: var(--text-primary);
          text-align: center;
        }

        .fm-pinned-badge {
          position: absolute;
          top: 8px;
          right: 8px;
          background: var(--primary-color, #3b82f6);
          color: white;
          font-size: 0.7rem;
          font-weight: 600;
          padding: 0.2rem 0.5rem;
          border-radius: 10px;
        }

        .fm-pinned-check {
          position: absolute;
          top: 8px;
          right: 8px;
          color: #22c55e;
        }

        .fm-pin-toggle {
          position: absolute;
          top: -8px;
          right: -8px;
          width: 28px;
          height: 28px;
          border-radius: 50%;
          background: var(--bg-card);
          border: 2px solid var(--border-color);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: var(--text-secondary);
          transition: all 0.15s ease;
          z-index: 10;
        }

        .fm-pin-toggle:hover {
          background: var(--bg-elevated);
        }

        .fm-pin-toggle.pinned {
          background: #ef4444;
          border-color: #ef4444;
          color: white;
        }

        /* More Actions Section */
        .fm-more-section {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          overflow: hidden;
        }

        .fm-more-header {
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1rem;
          background: transparent;
          border: none;
          cursor: pointer;
          font-size: 0.9rem;
          font-weight: 500;
          color: var(--text-primary);
        }

        .fm-more-header:active {
          background: var(--bg-elevated);
        }

        .fm-more-content {
          border-top: 1px solid var(--border-color);
        }

        .fm-action-row-wrapper {
          position: relative;
          display: flex;
          align-items: center;
        }

        .fm-action-row-wrapper .fm-pin-toggle {
          position: static;
          margin-right: 0.75rem;
          flex-shrink: 0;
        }

        .fm-action-row {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 0.75rem;
          padding: 1rem;
          background: transparent;
          border: none;
          border-bottom: 1px solid var(--border-color);
          cursor: pointer;
          text-align: left;
          color: var(--text-primary);
          transition: background 0.15s ease;
        }

        .fm-action-row:last-child {
          border-bottom: none;
        }

        .fm-action-row:active:not(:disabled) {
          background: var(--bg-elevated);
        }

        .fm-action-row:disabled {
          opacity: 0.7;
          cursor: default;
        }

        .fm-action-row.danger {
          color: #f59e0b;
        }

        .fm-action-label {
          flex: 1;
          font-size: 0.9rem;
        }

        .fm-action-badge {
          font-size: 0.75rem;
          color: var(--text-secondary);
          background: var(--bg-elevated);
          padding: 0.25rem 0.5rem;
          border-radius: 6px;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .fm-metrics-snapshot {
          background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }

        [data-theme="dark"] .fm-pinned-card.completed {
          background: rgba(34, 197, 94, 0.15);
        }
      `})]})}const dr=[{value:"high",label:"High",color:"#ef4444"},{value:"medium",label:"Medium",color:"#f59e0b"},{value:"low",label:"Low",color:"#6b7280"}],ur=[{value:"open",label:"Open",icon:na,color:"#ef4444"},{value:"in_progress",label:"In Progress",icon:it,color:"#f59e0b"},{value:"complete",label:"Complete",icon:Ve,color:"#10b981"}];function js({projectId:t,areas:r=[],companyId:s,onShowToast:a}){const[n,o]=m.useState([]),[i,c]=m.useState(!0),[l,h]=m.useState(!1),[_,p]=m.useState(null),[x,F]=m.useState("all"),[b,P]=m.useState("all"),[v,M]=m.useState(!1),[j,E]=m.useState({description:"",area_id:"",assigned_to:"",priority:"medium",notes:"",photo_url:""}),w=m.useCallback(async()=>{if(!t||!u){c(!1);return}try{const{data:f,error:k}=await d.from("punch_list_items").select("*").eq("project_id",t).order("created_at",{ascending:!1});if(k)throw k;o(f||[])}catch(f){console.error("Error loading punch list:",f),o([])}finally{c(!1)}},[t]);m.useEffect(()=>{w()},[w]),m.useEffect(()=>{if(!t||!u)return;const f=d.channel(`punch_list:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"punch_list_items",filter:`project_id=eq.${t}`},()=>w()).subscribe();return()=>{d.removeChannel(f)}},[t,w]);const T=m.useMemo(()=>n.filter(f=>!(x!=="all"&&f.status!==x||b!=="all"&&f.area_id!==b)),[n,x,b]),L=m.useMemo(()=>{const f=n.filter(J=>J.status==="open").length,k=n.filter(J=>J.status==="in_progress").length,H=n.filter(J=>J.status==="complete").length;return{open:f,inProgress:k,complete:H,total:n.length}},[n]),K=()=>{E({description:"",area_id:"",assigned_to:"",priority:"medium",notes:"",photo_url:""}),p(null),h(!1)},ue=async f=>{if(f.preventDefault(),!j.description.trim()){a?.("Please enter a description","error");return}M(!0);try{if(_){const{error:k}=await d.from("punch_list_items").update({description:j.description.trim(),area_id:j.area_id||null,assigned_to:j.assigned_to.trim()||null,priority:j.priority,notes:j.notes.trim()||null,photo_url:j.photo_url||null,updated_at:new Date().toISOString()}).eq("id",_.id);if(k)throw k;a?.("Punch item updated","success")}else{const{error:k}=await d.from("punch_list_items").insert({project_id:t,company_id:s,description:j.description.trim(),area_id:j.area_id||null,assigned_to:j.assigned_to.trim()||null,priority:j.priority,notes:j.notes.trim()||null,photo_url:j.photo_url||null,status:"open"});if(k)throw k;a?.("Punch item added","success")}K(),w()}catch(k){console.error("Error saving punch item:",k),a?.(k.message||"Error saving item","error")}finally{M(!1)}},oe=async(f,k)=>{try{const H={status:k,updated_at:new Date().toISOString()};k==="complete"?H.completed_at=new Date().toISOString():H.completed_at=null;const{error:J}=await d.from("punch_list_items").update(H).eq("id",f);if(J)throw J;w()}catch(H){console.error("Error updating status:",H),a?.("Error updating status","error")}},re=async f=>{if(confirm("Delete this punch item?"))try{const{error:k}=await d.from("punch_list_items").delete().eq("id",f);if(k)throw k;a?.("Item deleted","success"),w()}catch(k){console.error("Error deleting item:",k),a?.("Error deleting item","error")}},Q=f=>{E({description:f.description,area_id:f.area_id||"",assigned_to:f.assigned_to||"",priority:f.priority||"medium",notes:f.notes||"",photo_url:f.photo_url||""}),p(f),h(!0)},A=f=>f&&r.find(H=>H.id===f)?.name||null,Y=f=>dr.find(k=>k.value===f)||dr[1],me=f=>ur.find(k=>k.value===f)||ur[0];return e.jsxs("div",{className:"punch-list-card",children:[e.jsxs("div",{className:"punch-list-header",children:[e.jsxs("div",{className:"punch-list-title",children:[e.jsx(Ve,{size:18}),e.jsx("h3",{children:"Punch List"}),L.total>0&&e.jsxs("span",{className:"punch-stats-inline",children:[e.jsxs("span",{className:"punch-stat-open",children:[L.open," open"]}),L.inProgress>0&&e.jsxs("span",{className:"punch-stat-progress",children:[L.inProgress," in progress"]}),e.jsxs("span",{className:"punch-stat-complete",children:[L.complete,"/",L.total," complete"]})]})]}),e.jsxs("button",{className:"punch-add-btn",onClick:()=>{K(),h(!0)},children:[e.jsx($t,{size:16}),"Add Item"]})]}),L.total>0&&e.jsxs("div",{className:"punch-progress-bar",children:[e.jsx("div",{className:"punch-progress-fill",style:{width:`${L.complete/L.total*100}%`}}),e.jsxs("span",{className:"punch-progress-label",children:[Math.round(L.complete/L.total*100),"% complete"]})]}),L.total>0&&e.jsxs("div",{className:"punch-filters",children:[e.jsxs("div",{className:"punch-filter-group",children:[e.jsx(aa,{size:14}),e.jsxs("select",{value:x,onChange:f=>F(f.target.value),className:"punch-filter-select",children:[e.jsx("option",{value:"all",children:"All Status"}),ur.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))]})]}),r.length>0&&e.jsxs("div",{className:"punch-filter-group",children:[e.jsx(Tr,{size:14}),e.jsxs("select",{value:b,onChange:f=>P(f.target.value),className:"punch-filter-select",children:[e.jsx("option",{value:"all",children:"All Areas"}),r.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id))]})]})]}),l&&e.jsxs("form",{className:"punch-form",onSubmit:ue,children:[e.jsxs("div",{className:"punch-form-header",children:[e.jsx("h4",{children:_?"Edit Item":"New Punch Item"}),e.jsx("button",{type:"button",className:"punch-form-close",onClick:K,children:e.jsx(wr,{size:16})})]}),e.jsxs("div",{className:"punch-form-field",children:[e.jsx("label",{children:"Description *"}),e.jsx("textarea",{value:j.description,onChange:f=>E(k=>({...k,description:f.target.value})),placeholder:"What needs to be fixed or completed?",rows:2,required:!0})]}),e.jsxs("div",{className:"punch-form-row",children:[e.jsxs("div",{className:"punch-form-field",children:[e.jsx("label",{children:"Area"}),e.jsxs("select",{value:j.area_id,onChange:f=>E(k=>({...k,area_id:f.target.value})),children:[e.jsx("option",{value:"",children:"No area"}),r.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id))]})]}),e.jsxs("div",{className:"punch-form-field",children:[e.jsx("label",{children:"Assigned To"}),e.jsx("input",{type:"text",value:j.assigned_to,onChange:f=>E(k=>({...k,assigned_to:f.target.value})),placeholder:"Name or company"})]}),e.jsxs("div",{className:"punch-form-field",children:[e.jsx("label",{children:"Priority"}),e.jsx("select",{value:j.priority,onChange:f=>E(k=>({...k,priority:f.target.value})),children:dr.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))})]})]}),e.jsxs("div",{className:"punch-form-field",children:[e.jsx("label",{children:"Notes"}),e.jsx("textarea",{value:j.notes,onChange:f=>E(k=>({...k,notes:f.target.value})),placeholder:"Additional details...",rows:2})]}),e.jsxs("div",{className:"punch-form-actions",children:[e.jsx("button",{type:"button",className:"punch-btn-cancel",onClick:K,children:"Cancel"}),e.jsxs("button",{type:"submit",className:"punch-btn-save",disabled:v,children:[e.jsx(oa,{size:14}),v?"Saving...":_?"Update":"Add Item"]})]})]}),i?e.jsx("div",{className:"punch-loading",children:"Loading punch list..."}):T.length===0?e.jsxs("div",{className:"punch-empty",children:[e.jsx(Ve,{size:32,style:{opacity:.3}}),e.jsx("p",{children:n.length===0?"No punch items yet":"No items match filters"}),n.length===0&&e.jsx("span",{children:"Add items that need attention before project closeout"})]}):e.jsx("div",{className:"punch-items-list",children:T.map(f=>{const k=me(f.status),H=Y(f.priority),J=k.icon;return e.jsxs("div",{className:`punch-item punch-item-${f.status}`,children:[e.jsx("button",{className:"punch-item-status-btn",onClick:()=>{const q=f.status==="open"?"in_progress":f.status==="in_progress"?"complete":"open";oe(f.id,q)},title:`Click to change status (current: ${k.label})`,children:e.jsx(J,{size:18,style:{color:k.color}})}),e.jsxs("div",{className:"punch-item-content",children:[e.jsxs("div",{className:"punch-item-top",children:[e.jsx("span",{className:`punch-item-desc ${f.status==="complete"?"completed":""}`,children:f.description}),e.jsx("div",{className:"punch-item-badges",children:e.jsx("span",{className:"punch-priority-badge",style:{color:H.color,borderColor:`${H.color}40`},children:H.label})})]}),e.jsxs("div",{className:"punch-item-meta",children:[A(f.area_id)&&e.jsxs("span",{className:"punch-meta-tag",children:[e.jsx(Tr,{size:11}),A(f.area_id)]}),f.assigned_to&&e.jsxs("span",{className:"punch-meta-tag",children:[e.jsx(ia,{size:11}),f.assigned_to]}),f.completed_at&&e.jsxs("span",{className:"punch-meta-tag completed",children:[e.jsx(Ve,{size:11}),"Done ",new Date(f.completed_at).toLocaleDateString()]})]}),f.notes&&e.jsx("div",{className:"punch-item-notes",children:f.notes})]}),e.jsxs("div",{className:"punch-item-actions",children:[e.jsx("button",{className:"punch-action-btn",onClick:()=>Q(f),title:"Edit",children:e.jsx(wt,{size:14})}),e.jsx("button",{className:"punch-action-btn delete",onClick:()=>re(f.id),title:"Delete",children:e.jsx(ca,{size:14})})]})]},f.id)})})]})}const Mn=Object.freeze(Object.defineProperty({__proto__:null,default:js},Symbol.toStringTag,{value:"Module"}));function pn({project:t,companyId:r,foremanName:s,onShowToast:a,onExit:n}){const[o,i]=m.useState([]),[c,l]=m.useState(!0),[h,_]=m.useState(null),[p,x]=m.useState({}),[F,b]=m.useState("home"),[P,v]=m.useState(!1),[M,j]=m.useState(0),[E,w]=m.useState({crewCheckedIn:!1,crewCount:0,tmTicketsToday:0,dailyReportDone:!1,disposalLoadsToday:0}),[T,L]=m.useState(()=>typeof window<"u"?document.documentElement.getAttribute("data-theme")==="dark":!1);new Date().getHours(),m.useEffect(()=>{t?.id&&(Q(),K(),ue())},[t?.id]);const K=async()=>{try{const y=new Date().toISOString().split("T")[0],se=(await I.getCrewCheckin(t.id,y))?.workers||[],he=se.length>0,Z=(await I.getTMTickets?.(t.id)||[]).filter(ye=>ye.work_date===y),te=await I.getDisposalLoads?.(t.id,y)||[];w({crewCheckedIn:he,crewCount:se.length,tmTicketsToday:Z.length,dailyReportDone:!1,disposalLoadsToday:te.reduce((ye,de)=>ye+(de.load_count||1),0)})}catch(y){console.error("Error loading today status:",y)}},ue=async()=>{if(!(!t?.id||!u))try{const{count:y}=await d.from("punch_list_items").select("*",{count:"exact",head:!0}).eq("project_id",t.id).eq("status","open");j(y||0)}catch{}},oe=m.useRef(null),re=m.useCallback(()=>{oe.current&&clearTimeout(oe.current),oe.current=setTimeout(()=>{Q(),K()},300)},[t?.id]);m.useEffect(()=>{if(!t?.id)return;const y=[],X=I.subscribeToAreas?.(t.id,re);X&&y.push(X);const se=I.subscribeToCrewCheckins?.(t.id,re);se&&y.push(se);const he=I.subscribeToTMTickets?.(t.id,re);he&&y.push(he);const W=I.subscribeToHaulOffs?.(t.id,re);W&&y.push(W);const Z=I.subscribeToDailyReports?.(t.id,re);Z&&y.push(Z);const te=I.subscribeToCORs?.(t.id,re);te&&y.push(te);const ye=I.subscribeToMaterialRequests?.(t.id,re);ye&&y.push(ye);const de=I.subscribeToProject?.(t.id,re);if(de&&y.push(de),r){const fe=I.subscribeToMaterialsEquipment?.(r,re);fe&&y.push(fe);const qe=I.subscribeToLaborRates?.(r,re);qe&&y.push(qe)}return()=>{oe.current&&clearTimeout(oe.current),y.forEach(fe=>I.unsubscribe?.(fe))}},[t?.id,re]);const Q=async()=>{try{const y=await I.getAreas(t.id);i(y);const X=[...new Set(y.map(he=>he.group_name||"General"))],se={};X.forEach(he=>se[he]=!1),x(se)}catch(y){console.error("Error loading areas:",y),a?.("Error loading areas","error")}finally{l(!1)}},A=async(y,X)=>{const se=o.find(W=>W.id===y);if(!se)return;const he=se.status===X?"not_started":X;_(y);try{await I.updateAreaStatus(y,he),i(W=>W.map(Z=>Z.id===y?{...Z,status:he}:Z))}catch(W){console.error("Error updating status:",W),a?.("Error updating","error")}finally{_(null)}},Y=y=>{x(X=>({...X,[y]:!X[y]}))},me=()=>{const y=T?"light":"dark";document.documentElement.setAttribute("data-theme",y),localStorage.setItem("theme",y),L(!T)},f=Ua(o),k=o.filter(y=>y.status==="done").length,H=o.filter(y=>y.status==="working").length,J=o.length-k,q=o.reduce((y,X)=>{const se=X.group_name||"General";return y[se]||(y[se]=[]),y[se].push(X),y},{}),z=Object.keys(q).length>1||Object.keys(q).length===1&&!q.General,ae=y=>`${y.filter(se=>se.status==="done").length}/${y.length}`,C=m.useCallback(y=>{b(y)},[]);return F==="tm"?e.jsx("div",{className:"fm-view",children:e.jsx(tn,{project:t,companyId:r,onSubmit:()=>b("home"),onCancel:()=>b("home"),onShowToast:a})}):F==="report"?e.jsx(sn,{project:t,onShowToast:a,onClose:()=>b("home")}):F==="injury"?e.jsx("div",{className:"fm-view",children:e.jsx(an,{project:t,companyId:r,onClose:()=>b("home"),onReportCreated:()=>{b("home"),a?.("Injury report submitted","success")}})}):F==="crew"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>b("home"),children:e.jsx(Se,{size:20})}),e.jsx("h2",{children:"Crew Check-in"})]}),e.jsx(rn,{project:t,companyId:r,onShowToast:a})]}):F==="disposal"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>b("home"),children:e.jsx(Se,{size:20})}),e.jsx("h2",{children:"Disposal Loads"})]}),e.jsx(on,{project:t,date:new Date().toISOString().split("T")[0],onShowToast:a})]}):F==="docs"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>b("home"),children:e.jsx(Se,{size:20})}),e.jsx("h2",{children:"Documents"})]}),e.jsx(dn,{projectId:t.id,onShowToast:a})]}):F==="metrics"?e.jsx(un,{project:t,companyId:r,onBack:()=>b("home")}):F==="punchlist"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>{b("home"),ue()},children:e.jsx(Se,{size:20})}),e.jsx("h2",{children:"Punch List"})]}),e.jsx(js,{projectId:t.id,areas:o,companyId:r,onShowToast:a})]}):F==="progress"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>b("home"),children:e.jsx(Se,{size:20})}),e.jsx("h2",{children:"Progress"}),e.jsxs("span",{className:"fm-subheader-badge",children:[f,"%"]})]}),e.jsx("div",{className:"fm-progress-content",children:c?e.jsxs("div",{className:"fm-loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("span",{children:"Loading..."})]}):o.length===0?e.jsxs("div",{className:"fm-empty",children:[e.jsx(us,{size:48}),e.jsx("h3",{children:"No tasks yet"}),e.jsx("p",{children:"Office will add tasks to this project"})]}):z?Object.entries(q).map(([y,X])=>e.jsxs("div",{className:"fm-group",children:[e.jsxs("button",{className:"fm-group-header",onClick:()=>Y(y),children:[e.jsxs("div",{className:"fm-group-left",children:[p[y]?e.jsx(Wt,{size:18}):e.jsx(jt,{size:18}),e.jsx("span",{children:y})]}),e.jsx("span",{className:"fm-group-count",children:ae(X)})]}),p[y]&&e.jsx("div",{className:"fm-group-items",children:X.map(se=>e.jsxs("div",{className:`fm-task ${se.status}`,children:[e.jsx("span",{className:"fm-task-name",children:se.name}),e.jsxs("div",{className:"fm-task-btns",children:[e.jsx("button",{className:`fm-status-btn working ${se.status==="working"?"active":""}`,onClick:()=>A(se.id,"working"),disabled:h===se.id,children:e.jsx(it,{size:14})}),e.jsx("button",{className:`fm-status-btn done ${se.status==="done"?"active":""}`,onClick:()=>A(se.id,"done"),disabled:h===se.id,children:e.jsx(Ve,{size:14})})]})]},se.id))})]},y)):e.jsx("div",{className:"fm-task-list",children:o.map(y=>e.jsxs("div",{className:`fm-task ${y.status}`,children:[e.jsx("span",{className:"fm-task-name",children:y.name}),e.jsxs("div",{className:"fm-task-btns",children:[e.jsx("button",{className:`fm-status-btn working ${y.status==="working"?"active":""}`,onClick:()=>A(y.id,"working"),disabled:h===y.id,children:e.jsx(it,{size:14})}),e.jsx("button",{className:`fm-status-btn done ${y.status==="done"?"active":""}`,onClick:()=>A(y.id,"done"),disabled:h===y.id,children:e.jsx(Ve,{size:14})})]})]},y.id))})})]}):e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-header",children:[e.jsx("button",{className:"fm-exit",onClick:n,children:e.jsx(Se,{size:20})}),e.jsxs("div",{className:"fm-header-center",children:[e.jsx("h1",{className:"fm-project-name",children:t.name}),s&&e.jsx("span",{className:"fm-foreman-name",children:s}),e.jsx("button",{className:"fm-info-toggle",onClick:()=>v(!P),children:e.jsx(la,{size:16})})]}),e.jsx("button",{className:"fm-theme",onClick:me,children:T?e.jsx(ss,{size:20}):e.jsx(as,{size:20})})]}),P&&e.jsxs("div",{className:"fm-project-info",children:[t.job_number&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"Job #"}),e.jsx("span",{children:t.job_number})]}),t.address&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"Address"}),e.jsx("span",{children:t.address})]}),t.general_contractor&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"GC"}),e.jsx("span",{children:t.general_contractor})]}),t.client_phone&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"Phone"}),e.jsx("a",{href:`tel:${t.client_phone}`,children:t.client_phone})]})]}),e.jsx(mn,{project:t,todayStatus:E,progress:f,areasWorking:H,areasDone:k,areasRemaining:J,punchListOpenCount:M,onNavigate:C,onShowToast:a})]})}const hn=m.lazy(()=>Je(()=>import("./Dashboard-BNKOiQvY.js").then(t=>t.D),__vite__mapDeps([7,3,1,2,5,8]))),fn=m.lazy(()=>Je(()=>import("./Setup-Dl_F6HnT.js"),__vite__mapDeps([9,3,1,4,2,5]))),gn=m.lazy(()=>Je(()=>import("./BrandingSettings-Dvt1RgCd.js"),__vite__mapDeps([10,1,3,4,2,5]))),_n=m.lazy(()=>Je(()=>import("./PricingManager-CjUu-DHD.js"),__vite__mapDeps([11,1,2,3,4,5]))),yn=m.lazy(()=>Je(()=>import("./PublicView-BZfZeKDn.js"),__vite__mapDeps([12,1,2,3,4,5]))),bn=m.lazy(()=>Je(()=>import("./SignaturePage-UzUrubot.js"),__vite__mapDeps([13,1,8,3,14,2,4,5]))),jn=m.lazy(()=>Je(()=>import("./MembershipManager-B7BCoaXP.js"),__vite__mapDeps([15,1,2,3,4,5])));function mr(){return e.jsxs("div",{className:"page-loader",children:[e.jsx(Te,{className:"loading-logo"}),e.jsx("div",{className:"spinner"})]})}function wn({pendingCompanyName:t,userName:r,onCheckStatus:s,onLogout:a}){const[n,o]=m.useState(!1),[i,c]=m.useState(0);m.useEffect(()=>{const h=setInterval(()=>{c(_=>_+1),s()},3e4);return()=>clearInterval(h)},[s]);const l=async()=>{o(!0),await s(),setTimeout(()=>o(!1),1e3)};return e.jsxs("div",{className:"pending-approval-screen",children:[e.jsx(Te,{className:"pending-logo"}),e.jsx("div",{className:"pending-pulse-ring",children:e.jsx("div",{className:"pending-pulse-dot"})}),e.jsx("h2",{children:"Awaiting Approval"}),t&&e.jsx("div",{className:"pending-company-name",children:t}),e.jsxs("p",{className:"pending-message",children:[r?`Hi ${r.split(" ")[0]}, your`:"Your"," membership request has been submitted. A company administrator will review and approve your access."]}),e.jsx("p",{className:"pending-auto-check",children:"We'll automatically check for updates"}),e.jsxs("div",{className:"pending-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:a,children:"Sign Out"}),e.jsx("button",{className:"btn btn-primary",onClick:l,disabled:n,children:n?"Checking...":"Check Status"})]})]})}function xn(){const[t,r]=m.useState("entry"),[s,a]=m.useState(null),[n,o]=m.useState(null),[i,c]=m.useState([]),[l,h]=m.useState([]),[_,p]=m.useState(null),[x,F]=m.useState(""),[b,P]=m.useState(null),[v,M]=m.useState(null),[j,E]=m.useState(!0),[w,T]=m.useState("dashboard"),[L,K]=m.useState(null),[ue,oe]=m.useState(!1),[re,Q]=m.useState(!1),[A,Y]=m.useState(null),[me,f]=m.useState(0),[k,H]=m.useState(!1),[J,q]=m.useState(null),[z,ae]=m.useState(""),C=m.useCallback(async()=>{try{if(!u){E(!1);return}const{data:{user:B}}=await d.auth.getUser();if(!B){E(!1);return}const{data:ce}=await d.from("users").select("*").eq("id",B.id).single();if(ce){a(ce);let ee=await I.getUserCompanies(B.id);if(ee.length===0&&ce.company_id&&await I.repairLegacyUser(B.id,ce.company_id,ce.role||"member")&&(ee=await I.getUserCompanies(B.id)),c(ee),ee.length===0){if(await I.getUserPendingMemberships(B.id)>0){try{const{data:ke}=await d.from("user_companies").select("company_id, companies(name)").eq("user_id",B.id).eq("status","pending").limit(1);ke?.[0]?.companies?.name&&ae(ke[0].companies.name)}catch{}r("pending");return}K({message:"No company access. Join a company to continue.",type:"error"}),await Ut.signOut();return}const Ne=localStorage.getItem("selectedCompanyId");let Re=null;if(Ne&&ee.find(je=>je.id===Ne)?Re=ee.find(je=>je.id===Ne):ee.length>0&&(Re=ee[0]),Re){const{data:je}=await d.from("companies").select("*").eq("id",Re.id).single();o(je),r("office")}}}catch(B){console.error("Auth check error:",B)}finally{E(!1)}},[]);m.useEffect(()=>{const B=window.location.pathname,ce=B.match(/^\/view\/([a-zA-Z0-9_-]+)$/),ee=B.match(/^\/sign\/([a-zA-Z0-9_-]+)$/);ce?(P(ce[1]),r("public"),E(!1)):ee?(M(ee[1]),r("signature"),E(!1)):C()},[C]),m.useEffect(()=>{if(!u)return;const{data:{subscription:B}}=d.auth.onAuthStateChange(async(ce,ee)=>{if(ce==="SIGNED_OUT"||ce==="USER_DELETED"){const Ne=window.location.pathname;if(Ne.startsWith("/sign/")||Ne.startsWith("/view/"))return;a(null),o(null),c([]),r("entry")}else if(ce!=="TOKEN_REFRESHED"){if(ce==="SIGNED_IN"&&!s){const Ne=window.location.pathname;!Ne.startsWith("/sign/")&&!Ne.startsWith("/view/")&&C()}}});return()=>{B?.unsubscribe()}},[s,C]);const y=(B,ce="")=>{p(B),F(ce),r("foreman")},X=async(B,ce)=>{try{await _r();const{data:ee,error:Ne}=await d.auth.signInWithPassword({email:B,password:ce});if(Ne){Z(Ne.message||"Invalid credentials","error");return}const{data:Re,error:je}=await d.from("users").select("*").eq("id",ee.user.id).single();if(je){console.error("User fetch error:",je),Z("Error loading profile","error");return}if(Re){a(Re);let ke=await I.getUserCompanies(ee.user.id);ke.length===0&&Re.company_id&&await I.repairLegacyUser(ee.user.id,Re.company_id,Re.role||"member")&&(ke=await I.getUserCompanies(ee.user.id)),c(ke);const Ce=localStorage.getItem("selectedCompanyId");let xe=null;if(Ce&&ke.find(De=>De.id===Ce)?xe=ke.find(De=>De.id===Ce):ke.length>0&&(xe=ke[0]),xe){const{data:De}=await d.from("companies").select("*").eq("id",xe.id).single();o(De);const{data:Le}=await d.auth.mfa.listFactors(),Me=Le?.totp?.find(He=>He.status==="verified");Me?(q(Me.id),H(!0)):r("office")}else if(await I.getUserPendingMemberships(ee.user.id)>0){try{const{data:Le}=await d.from("user_companies").select("company_id, companies(name)").eq("user_id",ee.user.id).eq("status","pending").limit(1);Le?.[0]?.companies?.name&&ae(Le[0].companies.name)}catch{}r("pending")}else Z("No company access. Please contact admin.","error")}else Z("Profile not found. Please contact admin.","error")}catch(ee){console.error("Login error:",ee),Z("Login failed","error")}},se=async B=>{try{const{data:ce}=await d.from("companies").select("*").eq("id",B).single();ce&&(o(ce),localStorage.setItem("selectedCompanyId",B),oe(!1),T("dashboard"),Z(`Switched to ${ce.name}`,"success"))}catch(ce){console.error("Switch company error:",ce),Z("Error switching company","error")}},he=async()=>{try{await Ut.signOut(),a(null),o(null),c([]),r("entry"),T("dashboard"),localStorage.removeItem("selectedCompanyId")}catch(B){console.error("Logout error:",B),Z("Error signing out","error")}},W=async()=>{await _r(),p(null),F(""),r("entry")},Z=m.useCallback((B,ce="")=>{K({message:B,type:ce})},[]),te=()=>{T("dashboard"),n?.id&&ye()},ye=async()=>{if(n?.id)try{const B=await I.getProjects(n.id);h(B)}catch(B){console.error("Error loading projects:",B)}};m.useEffect(()=>{n?.id&&t==="office"&&(ye(),de())},[n?.id,t]);const de=async()=>{if(n?.id)try{const ce=(await I.getCompanyMemberships(n.id)).filter(ee=>ee.status==="pending").length;f(ce)}catch(B){console.error("Error loading pending count:",B)}},fe=m.useCallback(()=>{Y(null)},[]);if(j)return e.jsx(et,{children:e.jsx(Ze,{companyId:n?.id,children:e.jsxs("div",{className:"loading-screen",children:[e.jsx(Te,{className:"loading-logo"}),e.jsx("div",{className:"spinner"})]})})});if(k)return e.jsx(et,{children:e.jsxs(Ze,{companyId:n?.id,children:[e.jsx(at,{children:e.jsx(za,{factorId:J,onVerified:()=>{H(!1),r("office")},onCancel:async()=>{H(!1),q(null),await Ut.signOut(),a(null),o(null),c([]),r("entry")}})}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)})]})});if(t==="entry")return e.jsx(et,{children:e.jsxs(Ze,{children:[e.jsx(at,{children:e.jsx($a,{onForemanAccess:y,onOfficeLogin:X,onShowToast:Z})}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)})]})});if(t==="public"&&b)return e.jsx(et,{children:e.jsxs(Ze,{children:[e.jsx(at,{children:e.jsx(m.Suspense,{fallback:e.jsx(mr,{}),children:e.jsx(yn,{shareToken:b})})}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)})]})});if(t==="signature"&&v)return e.jsx(et,{children:e.jsxs(Ze,{children:[e.jsx(at,{children:e.jsx(m.Suspense,{fallback:e.jsx(mr,{}),children:e.jsx(bn,{signatureToken:v})})}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)})]})});if(t==="pending")return e.jsx(et,{children:e.jsxs(Ze,{children:[e.jsx(at,{children:e.jsx(wn,{pendingCompanyName:z,userName:s?.name,onCheckStatus:C,onLogout:he})}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)})]})});if(t==="foreman"&&_)return e.jsx(et,{children:e.jsxs(Ze,{companyId:_.company_id,children:[e.jsx(at,{children:e.jsx(pn,{project:_,companyId:_.company_id,foremanName:x,onShowToast:Z,onExit:W})}),e.jsx(Kr,{}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)})]})});const Pe=i.find(B=>B.id===n?.id)?.access_level==="administrator"||n?.owner_user_id===s?.id;return e.jsx(et,{children:e.jsx(Ze,{companyId:n?.id,children:e.jsx(Ma,{children:e.jsxs("div",{children:[!u&&e.jsx("div",{className:"demo-banner",children:"Demo Mode - Data saved locally in your browser"}),e.jsx("nav",{className:"nav",children:e.jsxs("div",{className:"nav-content",children:[e.jsx(Te,{}),e.jsxs("div",{className:"nav-tabs nav-tabs-desktop",children:[e.jsx("button",{className:`nav-tab ${w==="dashboard"?"active":""}`,onClick:()=>T("dashboard"),children:"Dashboard"}),e.jsx("button",{className:`nav-tab ${w==="setup"?"active":""}`,onClick:()=>T("setup"),children:"+ New Project"}),e.jsx("button",{className:`nav-tab ${w==="pricing"?"active":""}`,onClick:()=>T("pricing"),children:"Pricing"}),Pe&&e.jsx("button",{className:`nav-tab ${w==="branding"?"active":""}`,onClick:()=>T("branding"),children:"Branding"}),Pe&&e.jsxs("button",{className:`nav-tab ${w==="team"?"active":""}`,onClick:()=>T("team"),children:["Team",me>0&&e.jsx("span",{className:"nav-tab-badge",children:me})]})]}),e.jsxs("div",{className:"nav-user nav-user-desktop",children:[e.jsx(Gr,{compact:!0}),e.jsxs("div",{className:"mobile-menu",children:[e.jsx("button",{className:"mobile-menu-btn",onClick:()=>Q(!re),"aria-label":"User menu",children:""}),re&&e.jsxs("div",{className:"mobile-menu-dropdown",children:[e.jsxs("div",{className:"mobile-menu-info",children:[e.jsx("div",{className:"mobile-menu-user",children:s?.name||s?.email}),n&&e.jsx("div",{className:"mobile-menu-company",children:n.name})]}),e.jsx("button",{className:"mobile-menu-logout",onClick:()=>{Q(!1),he()},children:"Sign Out"})]})]}),i.length>1&&e.jsxs("div",{className:"company-switcher",children:[e.jsxs("button",{className:"company-switcher-btn",onClick:()=>oe(!ue),children:[n?.name||"Select Company",e.jsx("span",{className:"switcher-arrow",children:""})]}),ue&&e.jsx("div",{className:"company-dropdown",children:i.map(B=>e.jsxs("button",{className:`company-option ${B.id===n?.id?"active":""}`,onClick:()=>se(B.id),children:[B.name,B.id===n?.id&&e.jsx("span",{className:"check",children:""})]},B.id))})]}),i.length<=1&&n&&e.jsx("span",{className:"nav-company-name",children:n.name}),e.jsx("span",{className:"nav-user-name",children:s?.name||s?.email}),e.jsx("button",{className:"nav-logout",onClick:he,children:"Sign Out"})]}),e.jsx("button",{className:"mobile-menu-btn",onClick:()=>Q(!0),"aria-label":"Open menu",children:e.jsxs("span",{className:"hamburger-icon",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})})]})}),re&&e.jsx("div",{className:"mobile-drawer-overlay",onClick:()=>Q(!1),children:e.jsxs("div",{className:"mobile-drawer",onClick:B=>B.stopPropagation(),children:[e.jsxs("div",{className:"mobile-drawer-header",children:[e.jsx(Te,{}),e.jsx("button",{className:"mobile-drawer-close",onClick:()=>Q(!1),"aria-label":"Close menu",children:""})]}),e.jsxs("div",{className:"mobile-drawer-user",children:[e.jsx("div",{className:"mobile-user-avatar",children:(s?.name||s?.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"mobile-user-info",children:[e.jsx("span",{className:"mobile-user-name",children:s?.name||s?.email}),e.jsx("span",{className:"mobile-user-company",children:n?.name})]})]}),i.length>1&&e.jsxs("div",{className:"mobile-drawer-section",children:[e.jsx("div",{className:"mobile-section-title",children:"Switch Company"}),e.jsx("div",{className:"mobile-company-list",children:i.map(B=>e.jsxs("button",{className:`mobile-company-option ${B.id===n?.id?"active":""}`,onClick:()=>{se(B.id),Q(!1)},children:[e.jsx("span",{className:"mobile-company-name",children:B.name}),B.id===n?.id&&e.jsx("span",{className:"mobile-company-check",children:""})]},B.id))})]}),e.jsxs("div",{className:"mobile-drawer-section",children:[e.jsx("div",{className:"mobile-section-title",children:"Navigation"}),e.jsxs("div",{className:"mobile-nav-list",children:[e.jsx("button",{className:`mobile-nav-item ${w==="dashboard"?"active":""}`,onClick:()=>{T("dashboard"),Q(!1)},children:"Dashboard"}),e.jsx("button",{className:`mobile-nav-item ${w==="setup"?"active":""}`,onClick:()=>{T("setup"),Q(!1)},children:"+ New Project"}),e.jsx("button",{className:`mobile-nav-item ${w==="pricing"?"active":""}`,onClick:()=>{T("pricing"),Q(!1)},children:"Pricing"}),Pe&&e.jsx("button",{className:`mobile-nav-item ${w==="branding"?"active":""}`,onClick:()=>{T("branding"),Q(!1)},children:"Branding"}),Pe&&e.jsxs("button",{className:`mobile-nav-item ${w==="team"?"active":""}`,onClick:()=>{T("team"),Q(!1)},children:["Team",me>0&&e.jsx("span",{className:"mobile-nav-badge",children:me})]})]})]}),e.jsxs("div",{className:"mobile-drawer-section",children:[e.jsx("div",{className:"mobile-section-title",children:"Appearance"}),e.jsx("div",{className:"mobile-theme-toggle",children:e.jsx(Gr,{})})]}),e.jsx("div",{className:"mobile-drawer-footer",children:e.jsx("button",{className:"mobile-logout-btn",onClick:()=>{he(),Q(!1)},children:"Sign Out"})})]})}),e.jsx(at,{children:e.jsx(m.Suspense,{fallback:e.jsx(mr,{}),children:e.jsxs("div",{className:"container",children:[w==="dashboard"&&e.jsx(hn,{company:n,user:s,isAdmin:Pe,onShowToast:Z,navigateToProjectId:A,onProjectNavigated:fe}),w==="setup"&&e.jsx(fn,{company:n,user:s,onProjectCreated:te,onShowToast:Z}),w==="pricing"&&e.jsx(_n,{company:n,onShowToast:Z}),w==="branding"&&e.jsx(gn,{company:n,onShowToast:Z}),w==="team"&&Pe&&e.jsx(jn,{company:n,user:s,onShowToast:Z})]},n?.id)})}),e.jsx(Kr,{}),L&&e.jsx(tt,{message:L.message,type:L.type,onClose:()=>K(null)}),e.jsx(Ia,{})]})})})})}Cs.createRoot(document.getElementById("root")).render(e.jsx(Es.StrictMode,{children:e.jsx(xn,{})}));"serviceWorker"in navigator&&(window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(t=>{setInterval(()=>{t.update().catch(r=>console.debug("[SW] Update check failed:",r.message))},3e5)}).catch(t=>{console.debug("[SW] Registration failed:",t.message)})}),navigator.serviceWorker.addEventListener("message",t=>{t.data?.type==="SW_UPDATED"&&(console.log("[App] Service worker updated, reloading for fresh assets..."),window.location.reload()),t.data?.type==="ASSET_NOT_FOUND"&&(console.warn("[App] Asset not found:",t.data.url,"- reloading..."),"caches"in window?caches.keys().then(r=>{r.forEach(s=>caches.delete(s))}).finally(()=>{window.location.reload()}):window.location.reload())}));export{dn as F,an as I,Te as L,Mn as P,tt as T,Pa as a,An as b,Rn as c,I as d,Ra as e,Dn as f,Ha as g,On as h,Pn as i,Tn as j,Ln as k,Ba as l,u as m,qn as n,ne as o,d as s,Aa as u};
//# sourceMappingURL=index-BIaaQ6dM.js.map
