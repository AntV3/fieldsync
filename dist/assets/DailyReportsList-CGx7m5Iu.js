import{u as le,d as F,j as s,k as A,l as re}from"./index-UDxcK7mb.js";import{r as i,y as ie,t as B,q as oe,x as ce}from"./icons-_xHNNQgF.js";import{al as de,am as I}from"./Dashboard-BbceU_wI.js";import{E as he}from"./pdf-ChZ1zkDw.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";import"./corCalculations-D9qkkIbo.js";function fe({project:m,company:O,onShowToast:j}){const{branding:N}=le(),[p,U]=i.useState([]),[H,G]=i.useState(!0),[k,R]=i.useState(null),[f,Y]=i.useState(null),[c,b]=i.useState(new Set),[x,V]=i.useState(!1),[d,v]=i.useState("recent"),[w,T]=i.useState(new Set),[h,y]=i.useState({start:"",end:""});i.useEffect(()=>{S();const t=F.subscribeToDailyReports?.(m.id,()=>{S()});return()=>{t&&F.unsubscribe?.(t)}},[m.id]);const S=i.useCallback(async()=>{try{R(null);const t=await F.getDailyReports(m.id,365);U(t||[])}catch(t){console.error("Error loading daily reports:",t),R(t),j?.("Error loading daily reports","error")}finally{G(!1)}},[m.id]),o=i.useMemo(()=>{let t=[...p];if(h.start){const e=new Date(h.start);e.setHours(0,0,0,0),t=t.filter(a=>new Date(a.report_date||a.created_at)>=e)}if(h.end){const e=new Date(h.end);e.setHours(23,59,59,999),t=t.filter(a=>new Date(a.report_date||a.created_at)<=e)}if(d==="recent"){const e=new Date;e.setDate(e.getDate()-7),e.setHours(0,0,0,0),t=t.filter(a=>new Date(a.report_date||a.created_at)>=e)}return t},[p,d,h]),g=i.useMemo(()=>{if(d!=="all")return null;const t={};return o.forEach(e=>{const a=new Date(e.report_date||e.created_at),n=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`,l=a.toLocaleDateString("en-US",{month:"long",year:"numeric"});t[n]||(t[n]={label:l,reports:[]}),t[n].reports.push(e)}),Object.entries(t).sort((e,a)=>a[0].localeCompare(e[0]))},[o,d]);i.useEffect(()=>{if(g&&g.length>0){const t=g[0][0];T(new Set([t]))}},[g]);const W=()=>{V(!x),x&&b(new Set)},q=t=>{const e=new Set(c);e.has(t)?e.delete(t):e.add(t),b(e)},J=()=>{c.size===o.length?b(new Set):b(new Set(o.map(t=>t.id)))},Q=t=>{const e=new Set(w);e.has(t)?e.delete(t):e.add(t),T(e)},X=()=>c.size>0?o.filter(t=>c.has(t.id)):o,$=t=>new Date(t).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),Z=t=>new Date(t).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),K=t=>{switch(t){case"submitted":return"✓";case"reviewed":return"✓✓";case"draft":return"○";default:return"○"}},z=t=>{switch(t){case"submitted":return"Submitted";case"reviewed":return"Reviewed";case"draft":return"Draft";default:return t}},ee=async()=>{const t=X();if(t.length===0){j?.("No reports to export","error");return}j?.("Generating PDF...","info");const e=new he,a=e.internal.pageSize.getWidth(),n=20;let l=n;const C=A(N?.primary_color||"#3B82F6"),se=A(N?.secondary_color||"#1E40AF");e.setFillColor(...C),e.rect(0,0,a,45,"F"),e.setFillColor(...se),e.rect(0,42,a,3,"F");let D=n;if(N?.logo_url)try{const r=await re(N.logo_url);r&&(e.addImage(r,"PNG",n,7,30,30),D=n+40)}catch(r){console.error("Error adding logo:",r)}e.setTextColor(255,255,255),e.setFontSize(22),e.setFont("helvetica","bold"),e.text(O?.name||"Company Name",D,20),e.setFontSize(10),e.setFont("helvetica","normal"),e.text("DAILY REPORTS SUMMARY",D,30),e.setFontSize(9),e.text(`Generated: ${new Date().toLocaleDateString()}`,a-n,20,{align:"right"}),m.job_number&&e.text(`Job #: ${m.job_number}`,a-n,28,{align:"right"}),l=55,e.setFillColor(248,250,252),e.rect(n,l-5,a-n*2,20,"F"),e.setTextColor(...C),e.setFontSize(14),e.setFont("helvetica","bold"),e.text(`Project: ${m.name}`,n+5,l+7),e.setFontSize(10),e.setTextColor(100,100,100),e.text(`${t.length} Report${t.length!==1?"s":""}`,a-n-5,l+7,{align:"right"}),l+=25,t.forEach((r,me)=>{l>250&&(e.addPage(),l=n),e.setFillColor(...C),e.setTextColor(255,255,255),e.rect(n,l,a-n*2,10,"F"),e.setFontSize(11),e.setFont("helvetica","bold"),e.text($(r.report_date||r.created_at),n+5,l+7),e.text(z(r.status),a-n-5,l+7,{align:"right"}),l+=15,e.setTextColor(50,50,50),e.setFontSize(10),e.setFont("helvetica","normal");const ne=`Crew: ${r.crew_count||0}  |  Tasks: ${r.tasks_completed||0}  |  T&M: ${r.tm_tickets_count||0}  |  Photos: ${r.photos_count||0}`;if(e.text(ne,n+5,l),l+=8,r.crew_list?.length>0){e.setFont("helvetica","bold"),e.text("Crew:",n+5,l),e.setFont("helvetica","normal");const u=r.crew_list.map(L=>`${L.name} (${L.role})`).join(", "),P=e.splitTextToSize(u,a-n*2-30);e.text(P,n+25,l),l+=P.length*5+3}if(r.field_notes){e.setFont("helvetica","bold"),e.text("Notes:",n+5,l),e.setFont("helvetica","normal");const u=e.splitTextToSize(r.field_notes,a-n*2-30);e.text(u,n+25,l),l+=u.length*5+3}if(r.issues){e.setTextColor(180,50,50),e.setFont("helvetica","bold"),e.text("Issues:",n+5,l),e.setFont("helvetica","normal");const u=e.splitTextToSize(r.issues,a-n*2-30);e.text(u,n+25,l),e.setTextColor(50,50,50),l+=u.length*5+3}l+=10});const M=e.internal.getNumberOfPages();for(let r=1;r<=M;r++)e.setPage(r),e.setFontSize(8),e.setTextColor(150,150,150),e.text(`Page ${r} of ${M}`,a/2,e.internal.pageSize.getHeight()-10,{align:"center"});const ae=`${m.name}_Daily_Reports_${new Date().toISOString().split("T")[0]}.pdf`;e.save(ae),j?.("PDF exported!","success")},E=t=>s.jsxs("div",{className:`daily-report-card ${t.status} ${c.has(t.id)?"selected":""}`,children:[s.jsxs("div",{className:"daily-report-header-row",onClick:()=>Y(f===t.id?null:t.id),children:[x&&s.jsx("input",{type:"checkbox",className:"report-checkbox",checked:c.has(t.id),onChange:e=>{e.stopPropagation(),q(t.id)},onClick:e=>e.stopPropagation()}),s.jsxs("div",{className:"daily-report-info",children:[s.jsx("span",{className:"report-date",children:$(t.report_date||t.created_at)}),s.jsxs("span",{className:`report-status ${t.status}`,children:[K(t.status)," ",z(t.status)]})]}),s.jsxs("div",{className:"daily-report-summary",children:[s.jsxs("span",{className:"report-crew",children:[t.crew_count||0," crew"]}),s.jsxs("span",{className:"report-tasks",children:[t.tasks_completed||0," tasks"]}),s.jsx("span",{className:"report-expand",children:f===t.id?"▼":"▶"})]})]}),f===t.id&&s.jsxs("div",{className:"daily-report-details",children:[s.jsxs("div",{className:"report-stats-grid",children:[s.jsxs("div",{className:"report-stat",children:[s.jsx("span",{className:"stat-value",children:t.crew_count||0}),s.jsx("span",{className:"stat-label",children:"Crew on Site"})]}),s.jsxs("div",{className:"report-stat",children:[s.jsx("span",{className:"stat-value",children:t.tasks_completed||0}),s.jsx("span",{className:"stat-label",children:"Tasks Done"})]}),s.jsxs("div",{className:"report-stat",children:[s.jsx("span",{className:"stat-value",children:t.tm_tickets_count||0}),s.jsx("span",{className:"stat-label",children:"T&M Tickets"})]}),s.jsxs("div",{className:"report-stat",children:[s.jsx("span",{className:"stat-value",children:t.photos_count||0}),s.jsx("span",{className:"stat-label",children:"Photos"})]})]}),t.crew_list?.length>0&&s.jsxs("div",{className:"report-section",children:[s.jsx("h4",{children:"Crew"}),s.jsx("div",{className:"report-crew-list",children:t.crew_list.map((e,a)=>s.jsxs("div",{className:"crew-member",children:[s.jsx("span",{className:"crew-name",children:e.name}),s.jsx("span",{className:"crew-role",children:e.role})]},a))})]}),t.completed_tasks?.length>0&&s.jsxs("div",{className:"report-section",children:[s.jsx("h4",{children:"Completed Today"}),s.jsx("ul",{className:"report-tasks-list",children:t.completed_tasks.map((e,a)=>s.jsxs("li",{children:[e.name,e.group&&s.jsx("span",{className:"task-group",children:e.group})]},a))})]}),t.field_notes&&s.jsxs("div",{className:"report-section",children:[s.jsx("h4",{children:"Field Notes"}),s.jsx("p",{className:"report-notes",children:t.field_notes})]}),t.issues&&s.jsxs("div",{className:"report-section issues",children:[s.jsx("h4",{children:"Issues / Concerns"}),s.jsx("p",{className:"report-issues",children:t.issues})]}),t.submitted_at&&s.jsx("div",{className:"report-meta",children:s.jsxs("span",{children:["Submitted by ",t.submitted_by||"Field"," at ",Z(t.submitted_at)]})})]})]},t.id);if(H)return s.jsx("div",{className:"loading",children:"Loading daily reports..."});if(k)return s.jsx("div",{className:"daily-reports-list card",children:s.jsx(de,{title:"Unable to load reports",message:"There was a problem loading daily reports. Please try again.",error:k,onRetry:S})});const _=p.length,te=o.length;return s.jsxs("div",{className:"daily-reports-list card",children:[s.jsxs("div",{className:"daily-reports-header",children:[s.jsx("h3",{children:"Daily Reports"}),s.jsx("div",{className:"daily-reports-actions",children:p.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:`btn btn-small ${x?"btn-primary":"btn-secondary"}`,onClick:W,children:x?"Cancel":"Select"}),s.jsxs("button",{className:"btn btn-secondary btn-small",onClick:ee,children:["PDF",c.size>0?` (${c.size})`:""]})]})})]}),p.length>0&&s.jsxs("div",{className:"view-mode-bar",children:[s.jsxs("div",{className:"view-mode-tabs",children:[s.jsx("button",{className:`view-mode-tab ${d==="recent"?"active":""}`,onClick:()=>v("recent"),children:"Recent (7 days)"}),s.jsxs("button",{className:`view-mode-tab ${d==="all"?"active":""}`,onClick:()=>v("all"),children:["All (",_,")"]})]}),d==="all"&&s.jsxs("div",{className:"date-filter",children:[s.jsx(ie,{size:14,className:"date-filter-icon"}),s.jsx("input",{type:"date",value:h.start,onChange:t=>y(e=>({...e,start:t.target.value})),className:"date-input"}),s.jsx("span",{className:"date-separator",children:"to"}),s.jsx("input",{type:"date",value:h.end,onChange:t=>y(e=>({...e,end:t.target.value})),className:"date-input"}),(h.start||h.end)&&s.jsx("button",{className:"date-clear",onClick:()=>y({start:"",end:""}),children:"Clear"})]})]}),x&&o.length>0&&s.jsxs("div",{className:"select-all-bar",children:[s.jsxs("label",{className:"select-all-label",children:[s.jsx("input",{type:"checkbox",checked:c.size===o.length&&o.length>0,onChange:J}),"Select All (",o.length,")"]}),c.size>0&&s.jsxs("span",{className:"selected-count",children:[c.size," selected"]})]}),p.length===0?s.jsx(I,{icon:B,title:"No daily reports yet",message:"Reports from the field will appear here"}):o.length===0?s.jsx(I,{icon:B,title:"No reports in this time period",message:d==="recent"?"No reports in the last 7 days":"Try adjusting your date filter"}):d==="recent"?s.jsxs("div",{className:"daily-reports",children:[o.map(t=>E(t)),_>te&&s.jsx("div",{className:"view-all-prompt",children:s.jsxs("button",{className:"btn btn-secondary",onClick:()=>v("all"),children:["View All ",_," Reports"]})})]}):s.jsx("div",{className:"daily-reports grouped",children:g?.map(([t,{label:e,reports:a}])=>s.jsxs("div",{className:"month-group",children:[s.jsxs("div",{className:"month-header",onClick:()=>Q(t),children:[w.has(t)?s.jsx(oe,{size:18,className:"month-chevron"}):s.jsx(ce,{size:18,className:"month-chevron"}),s.jsx("span",{className:"month-label",children:e}),s.jsxs("span",{className:"month-count",children:[a.length," report",a.length!==1?"s":""]})]}),w.has(t)&&s.jsx("div",{className:"month-reports",children:a.map(n=>E(n))})]},t))})]})}export{fe as default};
//# sourceMappingURL=DailyReportsList-CGx7m5Iu.js.map
