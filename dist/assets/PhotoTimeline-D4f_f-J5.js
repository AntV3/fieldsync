import{i as E,s as w,d as M,j as e}from"./index-DRoKgDCS.js";import{r as i}from"./router-CeQ1XyMZ.js";import{i as f,aU as R,x as $,t as q,u as B,aV as F,j as S,X as O,a1 as V,C as X}from"./icons-CvO0oR7x.js";import"./pdf-rft6H0l9.js";import"./supabase-Ce1s_jZn.js";function Y({projectId:h,areas:u=[],onShowToast:Z}){const[g,z]=i.useState([]),[A,v]=i.useState(!0),[p,D]=i.useState("all"),[r,j]=i.useState(null),[x,N]=i.useState(0),[b,y]=i.useState(new Set),C=i.useCallback(async()=>{if(!h||!E){v(!1);return}try{const[s,t]=await Promise.all([w.from("t_and_m_tickets").select("id, work_date, notes, photos, area_id").eq("project_id",h).order("work_date",{ascending:!1}),w.from("daily_reports").select("id, report_date, field_notes, photos").eq("project_id",h).order("report_date",{ascending:!1})]),o=[];if(s.data)for(const a of s.data){const c=Array.isArray(a.photos)?a.photos:[];for(const d of c)d&&o.push({id:`tm-${a.id}-${o.length}`,url:d,date:a.work_date,source:"T&M Ticket",description:a.notes,areaId:a.area_id})}if(t.data)for(const a of t.data){const c=Array.isArray(a.photos)?a.photos:[];for(const d of c)d&&o.push({id:`dr-${a.id}-${o.length}`,url:d,date:a.report_date,source:"Daily Report",description:a.field_notes,areaId:null})}const T=o.map(a=>a.url);(await M.resolvePhotoUrls(T)).forEach((a,c)=>{o[c].url=a}),z(o.filter(a=>a.url)),o.length>0&&y(new Set([o[0].date]))}catch(s){console.error("Error loading photos:",s)}finally{v(!1)}},[h]);i.useEffect(()=>{C()},[C]);const n=i.useMemo(()=>p==="all"?g:g.filter(s=>s.areaId===p),[g,p]),L=i.useMemo(()=>{const s={};for(const t of n)s[t.date]||(s[t.date]=[]),s[t.date].push(t);return Object.entries(s).sort(([t],[o])=>o.localeCompare(t))},[n]),l=i.useMemo(()=>n,[n]),U=s=>{y(t=>{const o=new Set(t);return o.has(s)?o.delete(s):o.add(s),o})},I=s=>{const t=l.findIndex(o=>o.id===s.id);N(t>=0?t:0),j(s)},P=()=>j(null),_=s=>{const t=x+s;t>=0&&t<l.length&&(N(t),j(l[t]))},k=s=>new Date(s+"T00:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),m=s=>s&&u.find(o=>o.id===s)?.name||null;return A?e.jsxs("div",{className:"photo-timeline-card",children:[e.jsxs("div",{className:"photo-timeline-header",children:[e.jsx(f,{size:18}),e.jsx("h3",{children:"Progress Photos"})]}),e.jsx("div",{className:"photo-timeline-loading",children:"Loading photos..."})]}):e.jsxs("div",{className:"photo-timeline-card",children:[e.jsxs("div",{className:"photo-timeline-header",children:[e.jsxs("div",{className:"photo-timeline-title",children:[e.jsx(f,{size:18}),e.jsx("h3",{children:"Progress Photos"}),e.jsx("span",{className:"photo-count-badge",children:n.length})]}),u.length>0&&e.jsxs("div",{className:"photo-area-filter",children:[e.jsx(R,{size:14}),e.jsxs("select",{value:p,onChange:s=>D(s.target.value),className:"photo-area-select",children:[e.jsx("option",{value:"all",children:"All Areas"}),u.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})]}),n.length===0?e.jsxs("div",{className:"photo-timeline-empty",children:[e.jsx(f,{size:32,style:{opacity:.3}}),e.jsx("p",{children:"No photos yet"}),e.jsx("span",{children:"Photos from T&M tickets and daily reports will appear here"})]}):e.jsx("div",{className:"photo-timeline-dates",children:L.map(([s,t])=>e.jsxs("div",{className:"photo-date-group",children:[e.jsxs("button",{className:"photo-date-header",onClick:()=>U(s),children:[e.jsxs("div",{className:"photo-date-info",children:[e.jsx($,{size:14}),e.jsx("span",{className:"photo-date-label",children:k(s)}),e.jsxs("span",{className:"photo-date-count",children:[t.length," photo",t.length!==1?"s":""]})]}),b.has(s)?e.jsx(q,{size:16}):e.jsx(B,{size:16})]}),b.has(s)&&e.jsx("div",{className:"photo-grid",children:t.map(o=>e.jsxs("div",{className:"photo-grid-item",onClick:()=>I(o),children:[e.jsx("img",{src:o.url,alt:o.description||"Project photo",loading:"lazy"}),e.jsx("div",{className:"photo-grid-overlay",children:e.jsx(F,{size:16})}),e.jsxs("div",{className:"photo-grid-meta",children:[e.jsx("span",{className:"photo-source-badge",children:o.source}),m(o.areaId)&&e.jsxs("span",{className:"photo-area-badge",children:[e.jsx(S,{size:10}),m(o.areaId)]})]})]},o.id))})]},s))}),r&&e.jsx("div",{className:"photo-lightbox",onClick:P,children:e.jsxs("div",{className:"photo-lightbox-content",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{className:"photo-lightbox-close",onClick:P,children:e.jsx(O,{size:24})}),x>0&&e.jsx("button",{className:"photo-lightbox-nav prev",onClick:()=>_(-1),children:e.jsx(V,{size:24})}),e.jsx("img",{src:r.url,alt:r.description||"Project photo"}),x<l.length-1&&e.jsx("button",{className:"photo-lightbox-nav next",onClick:()=>_(1),children:e.jsx(X,{size:24})}),e.jsxs("div",{className:"photo-lightbox-info",children:[e.jsx("div",{className:"photo-lightbox-date",children:k(r.date)}),e.jsx("div",{className:"photo-lightbox-source",children:r.source}),m(r.areaId)&&e.jsxs("div",{className:"photo-lightbox-area",children:[e.jsx(S,{size:12}),m(r.areaId)]}),r.description&&e.jsx("div",{className:"photo-lightbox-desc",children:r.description}),e.jsxs("div",{className:"photo-lightbox-counter",children:[x+1," / ",l.length]})]})]})})]})}export{Y as default};
