{"version":3,"file":"CORLogPreview-BI1KpwCy.js","sources":["../../src/components/cor/CORLogPreview.jsx"],"sourcesContent":["import { useState, useEffect, useMemo } from 'react'\nimport { Clock, CheckCircle, XCircle, ChevronDown, ChevronUp, Plus, Table, List } from 'lucide-react'\nimport { db } from '../../lib/supabase'\nimport { formatCurrency } from '../../lib/corCalculations'\n\n/**\n * CORLogPreview - COR Log view for the Financials tab\n * Shows summary statistics and full log table\n * \"Show Full List\" expands the card list below\n */\n\nconst STATUS_CATEGORIES = {\n  pending: ['draft', 'pending_approval'],\n  approved: ['approved', 'billed'],\n  void: ['rejected', 'closed']\n}\n\nconst STATUS_DISPLAY = {\n  draft: { label: 'Draft', className: 'draft' },\n  pending_approval: { label: 'Pending', className: 'pending' },\n  approved: { label: 'Approved', className: 'approved' },\n  rejected: { label: 'Rejected', className: 'rejected' },\n  billed: { label: 'Billed', className: 'billed' },\n  closed: { label: 'Closed', className: 'closed' }\n}\n\nexport default function CORLogPreview({\n  project,\n  onShowToast,\n  onToggleList,      // Toggles the full card list below\n  showingList,       // Whether the list is currently expanded\n  onViewFullLog,     // Opens full COR log modal (with edit capabilities)\n  onCreateCOR,\n}) {\n  const [logEntries, setLogEntries] = useState([])\n  const [loading, setLoading] = useState(true)\n\n  useEffect(() => {\n    loadCORLog()\n\n    // Subscribe to COR changes\n    const subscription = db.subscribeToCORLog?.(project.id, () => {\n      loadCORLog()\n    })\n\n    return () => {\n      if (subscription) db.unsubscribe?.(subscription)\n    }\n  }, [project.id])\n\n  const loadCORLog = async () => {\n    try {\n      const data = await db.getCORLog(project.id)\n      setLogEntries(data || [])\n    } catch (error) {\n      console.error('Error loading COR log:', error)\n      onShowToast?.('Error loading COR log', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Group entries by status category\n  const groupedEntries = useMemo(() => {\n    const pending = logEntries.filter(e => STATUS_CATEGORIES.pending.includes(e.changeOrder?.status))\n    const approved = logEntries.filter(e => STATUS_CATEGORIES.approved.includes(e.changeOrder?.status))\n    const voided = logEntries.filter(e => STATUS_CATEGORIES.void.includes(e.changeOrder?.status))\n\n    return { pending, approved, voided }\n  }, [logEntries])\n\n  // Calculate summary statistics\n  const summary = useMemo(() => {\n    const { pending, approved, voided } = groupedEntries\n\n    return {\n      totalCORs: logEntries.length,\n      approvedCount: approved.length,\n      pendingCount: pending.length,\n      voidCount: voided.length,\n      approvedTotal: approved.reduce((sum, e) => sum + (e.changeOrder?.corTotal || 0), 0),\n      pendingTotal: pending.reduce((sum, e) => sum + (e.changeOrder?.corTotal || 0), 0)\n    }\n  }, [logEntries, groupedEntries])\n\n  // All entries sorted by most recent\n  const sortedEntries = useMemo(() => {\n    return [...logEntries]\n      .sort((a, b) => new Date(b.changeOrder?.createdAt || 0) - new Date(a.changeOrder?.createdAt || 0))\n  }, [logEntries])\n\n  if (loading) {\n    return (\n      <div className=\"cor-log-preview\">\n        <div className=\"cor-log-preview-loading\">\n          <div className=\"skeleton-stats\">\n            <div className=\"skeleton-stat\"></div>\n            <div className=\"skeleton-stat\"></div>\n            <div className=\"skeleton-stat\"></div>\n          </div>\n          <div className=\"skeleton-table\">\n            {[1, 2, 3].map(i => <div key={i} className=\"skeleton-row\"></div>)}\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"cor-log-preview\">\n      {/* Header with actions */}\n      <div className=\"cor-log-preview-header\">\n        <div className=\"cor-log-preview-title\">\n          <h3>Change Order Log</h3>\n          <span className=\"cor-log-preview-count\">{summary.totalCORs} total</span>\n        </div>\n        <div className=\"cor-log-preview-actions\">\n          <button\n            className=\"btn btn-secondary btn-small\"\n            onClick={onViewFullLog}\n            title=\"Open full COR log with edit & export\"\n          >\n            <Table size={14} /> Edit Log\n          </button>\n          <button className=\"btn btn-primary btn-small\" onClick={onCreateCOR}>\n            <Plus size={14} /> New COR\n          </button>\n        </div>\n      </div>\n\n      {/* Summary Stats Row */}\n      <div className=\"cor-log-preview-stats\">\n        <div className=\"cor-log-stat approved\">\n          <div className=\"cor-log-stat-icon\">\n            <CheckCircle size={18} />\n          </div>\n          <div className=\"cor-log-stat-content\">\n            <span className=\"cor-log-stat-value\">{formatCurrency(summary.approvedTotal)}</span>\n            <span className=\"cor-log-stat-label\">{summary.approvedCount} Approved</span>\n          </div>\n        </div>\n\n        <div className=\"cor-log-stat pending\">\n          <div className=\"cor-log-stat-icon\">\n            <Clock size={18} />\n          </div>\n          <div className=\"cor-log-stat-content\">\n            <span className=\"cor-log-stat-value\">{formatCurrency(summary.pendingTotal)}</span>\n            <span className=\"cor-log-stat-label\">{summary.pendingCount} Pending</span>\n          </div>\n        </div>\n\n        {summary.voidCount > 0 && (\n          <div className=\"cor-log-stat void\">\n            <div className=\"cor-log-stat-icon\">\n              <XCircle size={18} />\n            </div>\n            <div className=\"cor-log-stat-content\">\n              <span className=\"cor-log-stat-value\">{summary.voidCount}</span>\n              <span className=\"cor-log-stat-label\">Void/Rejected</span>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Full Log Table */}\n      {sortedEntries.length > 0 ? (\n        <div className=\"cor-log-preview-table-wrapper\">\n          <table className=\"cor-log-preview-table\">\n            <thead>\n              <tr>\n                <th>COR #</th>\n                <th>Title</th>\n                <th>Amount</th>\n                <th>Status</th>\n                <th>Date</th>\n              </tr>\n            </thead>\n            <tbody>\n              {sortedEntries.map(entry => (\n                <tr key={entry.id}>\n                  <td className=\"cor-number\">{entry.changeOrder?.corNumber || '—'}</td>\n                  <td className=\"cor-title\">{entry.changeOrder?.title || 'Untitled'}</td>\n                  <td className=\"cor-amount\">{formatCurrency(entry.changeOrder?.corTotal || 0)}</td>\n                  <td>\n                    <span className={`cor-status-badge ${STATUS_DISPLAY[entry.changeOrder?.status]?.className || ''}`}>\n                      {STATUS_DISPLAY[entry.changeOrder?.status]?.label || entry.changeOrder?.status}\n                    </span>\n                  </td>\n                  <td className=\"cor-date\">\n                    {entry.changeOrder?.createdAt\n                      ? new Date(entry.changeOrder.createdAt).toLocaleDateString()\n                      : '—'}\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      ) : (\n        <div className=\"cor-log-preview-empty\">\n          <p>No change orders yet</p>\n          <button className=\"btn btn-primary btn-small\" onClick={onCreateCOR}>\n            <Plus size={14} /> Create First COR\n          </button>\n        </div>\n      )}\n\n      {/* Show/Hide Full List Toggle */}\n      {sortedEntries.length > 0 && (\n        <button className=\"cor-log-preview-view-all\" onClick={onToggleList}>\n          <List size={14} />\n          <span>{showingList ? 'Hide' : 'Show'} Full COR List</span>\n          {showingList ? <ChevronUp size={16} /> : <ChevronDown size={16} />}\n        </button>\n      )}\n    </div>\n  )\n}\n"],"names":["STATUS_CATEGORIES","STATUS_DISPLAY","CORLogPreview","project","onShowToast","onToggleList","showingList","onViewFullLog","onCreateCOR","logEntries","setLogEntries","useState","loading","setLoading","useEffect","loadCORLog","subscription","db","data","error","groupedEntries","useMemo","pending","e","approved","voided","summary","sum","sortedEntries","a","b","jsxs","jsx","i","Table","Plus","CheckCircle","formatCurrency","Clock","XCircle","entry","List","ChevronUp","ChevronDown"],"mappings":"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"}