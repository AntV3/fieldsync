import{_ as U}from"./pdf-aQqpMATS.js";import{q as e,p as F}from"./index-CNYT6krf.js";import{r as n,aH as se,aa as ae,y as te,aI as le,q as ne,L as G,C as oe,X as q,P as ce,z as M,a7 as re,F as ie,e as de,b as Y,j as B,a5 as K}from"./icons-Bl--ZLwb.js";import{f as O}from"./corCalculations-vdJc_BOT.js";function me(s={}){const{itemsPerPage:j=50,initialPage:d=1,totalItems:i=0}=s,[l,N]=n.useState({page:d,totalItems:i,itemsPerPage:j}),h=n.useMemo(()=>Math.ceil(l.totalItems/l.itemsPerPage)||1,[l.totalItems,l.itemsPerPage]),c=n.useMemo(()=>l.page<h,[l.page,h]),v=n.useMemo(()=>l.page>1,[l.page]),m=n.useMemo(()=>(l.page-1)*l.itemsPerPage,[l.page,l.itemsPerPage]),T=n.useMemo(()=>{const g=m,D=m+l.itemsPerPage-1;return{start:g,end:D}},[m,l.itemsPerPage]),P=n.useCallback(g=>{N(D=>({...D,page:Math.max(1,Math.min(g,h||g))}))},[h]),R=n.useCallback(()=>{c&&N(g=>({...g,page:g.page+1}))},[c]),_=n.useCallback(()=>{v&&N(g=>({...g,page:g.page-1}))},[v]),L=n.useCallback(()=>{N(g=>({...g,page:1}))},[]),E=n.useCallback(()=>{N(g=>({...g,page:h}))},[h]),o=n.useCallback(g=>{N(D=>({...D,totalItems:g}))},[]),f=n.useCallback(g=>{N(D=>({...D,itemsPerPage:g,page:1}))},[]),I=n.useCallback(()=>{N({page:d,totalItems:0,itemsPerPage:j})},[d,j]),$=n.useCallback(g=>Array.isArray(g)?g.slice(m,m+l.itemsPerPage):[],[m,l.itemsPerPage]),y=n.useCallback(()=>({from:m,to:m+l.itemsPerPage-1}),[m,l.itemsPerPage]);return{page:l.page,totalItems:l.totalItems,itemsPerPage:l.itemsPerPage,totalPages:h,offset:m,range:T,hasNextPage:c,hasPrevPage:v,isFirstPage:l.page===1,isLastPage:l.page===h,goToPage:P,nextPage:R,prevPage:_,firstPage:L,lastPage:E,setTotalItems:o,setItemsPerPage:f,reset:I,paginate:$,getSupabaseRange:y}}function ge(s=[],j={}){const{pageSize:d=25,searchFields:i=[]}=j,[l,N]=n.useState(""),h=n.useMemo(()=>{if(!l.trim()||i.length===0)return s;const P=l.toLowerCase();return s.filter(R=>i.some(_=>{const L=R?.[_];return L==null?!1:String(L).toLowerCase().includes(P)}))},[s,l,i]),c=me({itemsPerPage:d,totalItems:h.length});n.useMemo(()=>{c.setTotalItems(h.length)},[h.length]);const v=n.useMemo(()=>c.paginate(h),[h,c.paginate]),m=n.useCallback(P=>{N(P),c.goToPage(1)},[c.goToPage]),T=n.useCallback(P=>{c.setItemsPerPage(P)},[c.setItemsPerPage]);return{paginatedItems:v,searchTerm:l,setSearchTerm:m,currentPage:c.page,totalPages:c.totalPages,goToPage:c.goToPage,nextPage:c.nextPage,prevPage:c.prevPage,pageSize:c.itemsPerPage,setPageSize:T,totalItems:h.length}}function ue({currentPage:s,totalPages:j,onPageChange:d,pageSize:i,onPageSizeChange:l,totalItems:N,pageSizeOptions:h=[10,25,50,100]}){const c=N===0?0:(s-1)*i+1,v=Math.min(s*i,N);return e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{className:"pagination-info",children:["Showing ",c,"â€“",v," of ",N," items"]}),e.jsxs("div",{className:"pagination-controls",children:[l&&e.jsx("select",{className:"pagination-size-select",value:i,onChange:m=>l(Number(m.target.value)),children:h.map(m=>e.jsxs("option",{value:m,children:[m," / page"]},m))}),e.jsx("button",{className:"pagination-btn",onClick:()=>d(1),disabled:s<=1,title:"First page",children:e.jsx(se,{size:16})}),e.jsx("button",{className:"pagination-btn",onClick:()=>d(s-1),disabled:s<=1,title:"Previous page",children:e.jsx(ae,{size:16})}),e.jsxs("span",{className:"pagination-page-info",children:["Page ",s," of ",j]}),e.jsx("button",{className:"pagination-btn",onClick:()=>d(s+1),disabled:s>=j,title:"Next page",children:e.jsx(te,{size:16})}),e.jsx("button",{className:"pagination-btn",onClick:()=>d(j),disabled:s>=j,title:"Last page",children:e.jsx(le,{size:16})})]})]})}const he=[{value:"draft",label:"Draft"},{value:"pending_approval",label:"Pending Approval"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"billed",label:"Billed"},{value:"closed",label:"Closed"}];function pe({entry:s,isEditing:j,isSaving:d,onEdit:i,onSave:l,onCancel:N,statusDisplay:h}){const[c,v]=n.useState({dateSentToClient:s.dateSentToClient||"",ceNumber:s.ceNumber||"",comments:s.comments||"",status:s.changeOrder?.status||"draft"}),m=n.useRef(null);n.useEffect(()=>{j&&m.current&&m.current.focus()},[j]),n.useEffect(()=>{v({dateSentToClient:s.dateSentToClient||"",ceNumber:s.ceNumber||"",comments:s.comments||"",status:s.changeOrder?.status||"draft"})},[s]);const T=o=>{o.key==="Enter"&&!o.shiftKey?(o.preventDefault(),P()):o.key==="Escape"&&R()},P=()=>{l(c)},R=()=>{v({dateSentToClient:s.dateSentToClient||"",ceNumber:s.ceNumber||"",comments:s.comments||"",status:s.changeOrder?.status||"draft"}),N()},_=h[s.changeOrder.status]||{label:s.changeOrder.status,className:""},L=o=>{if(!o)return"-";try{return new Date(o).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch{return o}},E=o=>{if(!o)return"";try{return new Date(o).toISOString().split("T")[0]}catch{return o}};return j?e.jsxs("tr",{className:"cor-log-row editing",children:[e.jsx("td",{className:"col-log-num",children:s.logNumber}),e.jsx("td",{className:"col-date-sent",children:e.jsx("input",{ref:m,type:"date",value:E(c.dateSentToClient),onChange:o=>v(f=>({...f,dateSentToClient:o.target.value})),onKeyDown:T,disabled:d,className:"cor-log-input"})}),e.jsx("td",{className:"col-ce-num",children:e.jsx("input",{type:"text",value:c.ceNumber,onChange:o=>v(f=>({...f,ceNumber:o.target.value})),onKeyDown:T,disabled:d,placeholder:"CE-XXX",className:"cor-log-input",maxLength:50})}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:s.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:s.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:O(s.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status",children:e.jsxs("div",{className:"cor-log-status-select",children:[e.jsx("select",{value:c.status,onChange:o=>v(f=>({...f,status:o.target.value})),disabled:d,className:"cor-log-select",children:he.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))}),e.jsx(ne,{size:14,className:"select-icon"})]})}),e.jsx("td",{className:"col-comments",children:e.jsx("textarea",{value:c.comments,onChange:o=>v(f=>({...f,comments:o.target.value})),onKeyDown:T,disabled:d,placeholder:"Add comments...",className:"cor-log-textarea",rows:2})}),e.jsx("td",{className:"col-actions",children:d?e.jsx(G,{size:16,className:"spin"}):e.jsxs("div",{className:"cor-log-edit-actions",children:[e.jsx("button",{className:"btn btn-icon btn-success",onClick:P,title:"Save",children:e.jsx(oe,{size:14})}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:R,title:"Cancel",children:e.jsx(q,{size:14})})]})})]}):e.jsxs("tr",{className:"cor-log-row",children:[e.jsx("td",{className:"col-log-num",children:s.logNumber}),e.jsx("td",{className:"col-date-sent editable",onClick:i,children:L(s.dateSentToClient)}),e.jsx("td",{className:"col-ce-num editable",onClick:i,children:s.ceNumber||"-"}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:s.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:s.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:O(s.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status editable",onClick:i,children:e.jsx("span",{className:`cor-log-status ${_.className}`,children:_.label})}),e.jsx("td",{className:"col-comments editable",onClick:i,children:s.comments||e.jsx("span",{className:"placeholder",children:"Click to add..."})}),e.jsx("td",{className:"col-actions",children:e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:i,title:"Edit",children:e.jsx(ce,{size:14})})})]})}const V={draft:{label:"Draft",className:"draft"},pending_approval:{label:"Pending",className:"pending"},approved:{label:"Approved",className:"approved"},rejected:{label:"Rejected",className:"rejected"},billed:{label:"Billed",className:"billed"},closed:{label:"Closed",className:"closed"}},X={pending:["draft","pending_approval"],approved:["approved","billed"],void:["rejected","closed"]};function xe({project:s,company:j,onShowToast:d}){const[i,l]=n.useState([]),[N,h]=n.useState(!0),[c,v]=n.useState(null),[m,T]=n.useState(null),[P,R]=n.useState(!1);n.useEffect(()=>{_();const t=F.subscribeToCORLog?.(s.id,()=>{_()});return()=>{t&&F.unsubscribe?.(t)}},[s.id]);const _=async()=>{try{const t=await F.getCORLog(s.id);l(t||[])}catch(t){console.error("Error loading COR log:",t),d?.("Error loading COR log","error")}finally{h(!1),R(!1)}},L=()=>{R(!0),_()},E=async(t,b,a)=>{T(t);try{await F.updateCORLogEntry(t,b),b.status&&await F.updateChangeOrderStatus(a,b.status),l(r=>r.map(C=>C.id===t?{...C,dateSentToClient:b.dateSentToClient,ceNumber:b.ceNumber,comments:b.comments,changeOrder:{...C.changeOrder,status:b.status||C.changeOrder.status}}:C)),v(null),d?.("Log entry updated","success")}catch(r){console.error("Error updating log entry:",r),d?.("Error updating log entry","error")}finally{T(null)}},o=n.useMemo(()=>i.map(t=>({...t,_title:t.changeOrder?.title||"",_cor_number:t.changeOrder?.corNumber||"",_status:t.changeOrder?.status||"",_scope:t.changeOrder?.scopeOfWork||""})),[i]),{paginatedItems:f,searchTerm:I,setSearchTerm:$,currentPage:y,totalPages:g,goToPage:D,pageSize:H,setPageSize:J,totalItems:Q}=ge(o,{pageSize:25,searchFields:["_title","_cor_number","_status","_scope","ceNumber","comments"]}),S=n.useMemo(()=>{const t=f.filter(r=>X.pending.includes(r.changeOrder.status)),b=f.filter(r=>X.approved.includes(r.changeOrder.status)),a=f.filter(r=>X.void.includes(r.changeOrder.status));return{pending:t,approved:b,voided:a}},[f]),u=n.useMemo(()=>{const{pending:t,approved:b,voided:a}=S;return{totalCORs:i.length,approvedCount:b.length,pendingCount:t.length,voidCount:a.length,approvedTotal:b.reduce((r,C)=>r+(C.changeOrder.corTotal||0),0),pendingTotal:t.reduce((r,C)=>r+(C.changeOrder.corTotal||0),0),voidTotal:a.reduce((r,C)=>r+(C.changeOrder.corTotal||0),0),grandTotal:i.reduce((r,C)=>r+(C.changeOrder.corTotal||0),0)}},[i,S]),Z=async()=>{try{const{default:t}=await U(async()=>{const{default:x}=await import("./pdf-aQqpMATS.js").then(w=>w.j);return{default:x}},[]),{default:b}=await U(async()=>{const{default:x}=await import("./pdf-aQqpMATS.js").then(w=>w.c);return{default:x}},[]),a=new t("landscape"),r=a.internal.pageSize.width;a.setFontSize(18),a.setFont(void 0,"bold"),a.text("CHANGE ORDER LOG",r/2,20,{align:"center"}),a.setFontSize(12),a.setFont(void 0,"normal"),a.text(`Project: ${s.name}`,r/2,28,{align:"center"}),s.job_number&&a.text(`Job #${s.job_number}`,r/2,35,{align:"center"}),a.setFontSize(10),a.text(`Generated: ${new Date().toLocaleDateString()}`,r/2,42,{align:"center"}),j?.name&&(a.setFontSize(11),a.setFont(void 0,"bold"),a.text(j.name,14,20),a.setFont(void 0,"normal"),j.phone&&(a.setFontSize(9),a.text(j.phone,14,25)));const C=i.map(x=>[x.logNumber,x.changeOrder.corNumber||"-",x.dateSentToClient?new Date(x.dateSentToClient).toLocaleDateString():"-",x.ceNumber||"-",x.changeOrder.title||"Untitled",O(x.changeOrder.corTotal||0),V[x.changeOrder.status]?.label||x.changeOrder.status,x.comments||"-"]);b(a,{startY:50,head:[["Log #","COR #","Date Sent","CE #","Description","Amount","Status","Comments"]],body:C,styles:{fontSize:8,cellPadding:3,overflow:"linebreak",valign:"top"},headStyles:{fillColor:[51,51,51],textColor:255,fontStyle:"bold",fontSize:8},columnStyles:{0:{cellWidth:12,halign:"center"},1:{cellWidth:18},2:{cellWidth:22},3:{cellWidth:18},4:{cellWidth:55},5:{cellWidth:22,halign:"right"},6:{cellWidth:18,halign:"center"},7:{cellWidth:"auto",minCellWidth:50}},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:x=>{if(x.column.index===6&&x.section==="body"){const w=x.cell.raw?.toLowerCase();w==="approved"||w==="billed"?x.cell.styles.textColor=[5,150,105]:w==="pending"||w==="pending approval"?x.cell.styles.textColor=[217,119,6]:(w==="rejected"||w==="void")&&(x.cell.styles.textColor=[220,38,38])}}});const z=(a.lastAutoTable?.finalY||100)+10;a.setFontSize(10),a.setFont(void 0,"bold"),a.text("SUMMARY",14,z),a.setFont(void 0,"normal"),a.setFontSize(9);const k=14,p=100;a.text(`Total CORs: ${u.totalCORs}`,k,z+7),a.text(`Approved: ${u.approvedCount} (${O(u.approvedTotal)})`,k,z+14),a.text(`Pending: ${u.pendingCount} (${O(u.pendingTotal)})`,p,z+7),a.text(`Void: ${u.voidCount} (${O(u.voidTotal)})`,p,z+14),a.setFont(void 0,"bold"),a.setFontSize(10),a.text(`Total Value: ${O(u.grandTotal)}`,k,z+24);const A=`COR_Log_${s.job_number||s.name.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`;a.save(A),d?.("PDF exported successfully","success")}catch(t){console.error("Error exporting PDF:",t),d?.("Error exporting PDF","error")}},ee=async()=>{try{const t=await U(()=>import("./xlsx-BvJTHLik.js"),[]),b=i.map(p=>({"Log #":p.logNumber,"COR Number":p.changeOrder.corNumber,"Date Sent to Client":p.dateSentToClient||"","CE Number":p.ceNumber||"",Description:p.changeOrder.title||"Untitled",Amount:p.changeOrder.corTotal||0,Status:V[p.changeOrder.status]?.label||p.changeOrder.status,"Created Date":p.changeOrder.createdAt?new Date(p.changeOrder.createdAt).toLocaleDateString():"","Approved Date":p.changeOrder.approvedAt?new Date(p.changeOrder.approvedAt).toLocaleDateString():"","Approved By":p.changeOrder.approvedBy||"",Comments:p.comments||""}));b.push({}),b.push({"Log #":"SUMMARY",Description:`Total CORs: ${u.totalCORs}`,Amount:u.grandTotal,Status:`Approved: ${u.approvedCount}, Pending: ${u.pendingCount}`});const a=t.utils.json_to_sheet(b),r=t.utils.book_new();t.utils.book_append_sheet(r,a,"COR Log");const C=5,z=t.utils.decode_range(a["!ref"]);for(let p=z.s.r+1;p<=z.e.r;p++){const A=t.utils.encode_cell({r:p,c:C});a[A]&&typeof a[A].v=="number"&&(a[A].z="$#,##0.00")}a["!cols"]=[{wch:8},{wch:12},{wch:15},{wch:12},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:20},{wch:30}];const k=`COR_Log_${s.job_number||s.name}_${new Date().toISOString().split("T")[0]}.xlsx`;t.writeFile(r,k),d?.("Excel exported successfully","success")}catch(t){console.error("Error exporting Excel:",t),d?.("Error exporting Excel","error")}};if(N)return e.jsxs("div",{className:"cor-log cor-log-loading",children:[e.jsx(G,{size:24,className:"spin"}),e.jsx("span",{children:"Loading COR Log..."})]});const W=(t,b=!0)=>e.jsxs("table",{className:"cor-log-table",children:[b&&e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-log-num",children:"Log #"}),e.jsx("th",{className:"col-date-sent",children:"Date Sent"}),e.jsx("th",{className:"col-ce-num",children:"CE #"}),e.jsx("th",{className:"col-description",children:"Description"}),e.jsx("th",{className:"col-amount",children:"Amount"}),e.jsx("th",{className:"col-status",children:"Status"}),e.jsx("th",{className:"col-comments",children:"Comments"}),e.jsx("th",{className:"col-actions",children:"Actions"})]})}),e.jsx("tbody",{children:t.map(a=>e.jsx(pe,{entry:a,isEditing:c===a.id,isSaving:m===a.id,onEdit:()=>v(a.id),onSave:r=>E(a.id,r,a.changeOrder.id),onCancel:()=>v(null),statusDisplay:V},a.id))})]});return e.jsxs("div",{className:"cor-log cor-log-expanded",children:[e.jsxs("div",{className:"cor-log-header",children:[e.jsxs("div",{className:"cor-log-title",children:[e.jsx(M,{size:20}),e.jsx("h3",{children:"Change Order Log"}),e.jsxs("span",{className:"cor-log-count",children:[i.length," entries"]})]}),e.jsxs("div",{className:"cor-log-actions",children:[e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:L,disabled:P,title:"Refresh",children:e.jsx(re,{size:16,className:P?"spin":""})}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:ee,children:[e.jsx(M,{size:14})," Excel"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:Z,children:[e.jsx(ie,{size:14})," PDF"]})]})]}),e.jsxs("div",{className:"cor-search",style:{margin:"0 0 12px 0"},children:[e.jsx(de,{size:14,className:"cor-search-icon"}),e.jsx("input",{type:"text",className:"cor-search-input",placeholder:"Search log entries by title, COR #, status, or comments...",value:I,onChange:t=>$(t.target.value)}),I&&e.jsx("button",{className:"cor-search-clear",onClick:()=>$(""),children:e.jsx(q,{size:14})})]}),e.jsxs("div",{className:"cor-log-summary-cards",children:[e.jsxs("div",{className:"summary-card pending",children:[e.jsx(Y,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Pending"}),e.jsxs("span",{className:"summary-card-count",children:[u.pendingCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(u.pendingTotal)})]})]}),e.jsxs("div",{className:"summary-card approved",children:[e.jsx(B,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Approved"}),e.jsxs("span",{className:"summary-card-count",children:[u.approvedCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(u.approvedTotal)})]})]}),e.jsxs("div",{className:"summary-card void",children:[e.jsx(K,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Void"}),e.jsxs("span",{className:"summary-card-count",children:[u.voidCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(u.voidTotal)})]})]}),e.jsxs("div",{className:"summary-card total",children:[e.jsx(M,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Total"}),e.jsxs("span",{className:"summary-card-count",children:[u.totalCORs," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(u.grandTotal)})]})]})]}),i.length===0?e.jsxs("div",{className:"cor-log-empty",children:[e.jsx(M,{size:32}),e.jsx("p",{children:"No change orders in log"}),e.jsx("span",{children:"CORs will appear here as they are created"})]}):e.jsxs("div",{className:"cor-log-sections",children:[S.pending.length>0&&e.jsxs("div",{className:"cor-log-section pending",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(Y,{size:16}),e.jsx("h4",{children:"Pending Change Orders"}),e.jsx("span",{className:"section-count",children:S.pending.length}),e.jsx("span",{className:"section-total",children:O(u.pendingTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:W(S.pending)})]}),S.approved.length>0&&e.jsxs("div",{className:"cor-log-section approved",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(B,{size:16}),e.jsx("h4",{children:"Approved Change Orders"}),e.jsx("span",{className:"section-count",children:S.approved.length}),e.jsx("span",{className:"section-total",children:O(u.approvedTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:W(S.approved)})]}),S.voided.length>0&&e.jsxs("div",{className:"cor-log-section void",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(K,{size:16}),e.jsx("h4",{children:"Void Change Orders"}),e.jsx("span",{className:"section-count",children:S.voided.length}),e.jsx("span",{className:"section-total",children:O(u.voidTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:W(S.voided)})]})]}),g>1&&e.jsx(ue,{currentPage:y,totalPages:g,onPageChange:D,pageSize:H,onPageSizeChange:J,totalItems:Q})]})}const Ce=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"}));export{xe as C,ue as P,Ce as a,ge as u};
//# sourceMappingURL=CORLog-DPw3m66-.js.map
