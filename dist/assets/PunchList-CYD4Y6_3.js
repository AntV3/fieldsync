import{i as A,g as j,s as D,j as s}from"./index-DRoKgDCS.js";import{r as l}from"./router-CeQ1XyMZ.js";import{l as v,r as X,aU as Y,aW as B,e as G,j as I,X as J,au as K,an as Q,P as V,ab as Z}from"./icons-CvO0oR7x.js";import"./pdf-rft6H0l9.js";import"./supabase-Ce1s_jZn.js";const N=[{value:"high",label:"High",color:"#ef4444"},{value:"medium",label:"Medium",color:"#f59e0b"},{value:"low",label:"Low",color:"#6b7280"}],b=[{value:"open",label:"Open",icon:B,color:"#ef4444"},{value:"in_progress",label:"In Progress",icon:G,color:"#f59e0b"},{value:"complete",label:"Complete",icon:v,color:"#10b981"}];function le({projectId:o,areas:h=[],companyId:k,onShowToast:d}){const[c,y]=l.useState([]),[O,C]=l.useState(!0),[F,_]=l.useState(!1),[m,S]=l.useState(null),[g,L]=l.useState("all"),[x,$]=l.useState("all"),[P,w]=l.useState(!1),[n,u]=l.useState({description:"",area_id:"",assigned_to:"",priority:"medium",notes:"",photo_url:""}),p=l.useCallback(async()=>{if(!o||!A){C(!1);return}try{const e=j(),{data:t,error:a}=await e.from("punch_list_items").select("*").eq("project_id",o).order("created_at",{ascending:!1});if(a)throw a;y(t||[])}catch(e){console.error("Error loading punch list:",e),y([])}finally{C(!1)}},[o]);l.useEffect(()=>{p()},[p]),l.useEffect(()=>{if(!o||!A)return;const e=D.channel(`punch_list:${o}`).on("postgres_changes",{event:"*",schema:"public",table:"punch_list_items",filter:`project_id=eq.${o}`},()=>p()).subscribe();return()=>{D.removeChannel(e)}},[o,p]);const E=l.useMemo(()=>c.filter(e=>!(g!=="all"&&e.status!==g||x!=="all"&&e.area_id!==x)),[c,g,x]),r=l.useMemo(()=>{const e=c.filter(i=>i.status==="open").length,t=c.filter(i=>i.status==="in_progress").length,a=c.filter(i=>i.status==="complete").length;return{open:e,inProgress:t,complete:a,total:c.length}},[c]),f=()=>{u({description:"",area_id:"",assigned_to:"",priority:"medium",notes:"",photo_url:""}),S(null),_(!1)},q=async e=>{if(e.preventDefault(),!n.description.trim()){d?.("Please enter a description","error");return}w(!0);try{const t=j();if(m){const{error:a}=await t.from("punch_list_items").update({description:n.description.trim(),area_id:n.area_id||null,assigned_to:n.assigned_to.trim()||null,priority:n.priority,notes:n.notes.trim()||null,photo_url:n.photo_url||null,updated_at:new Date().toISOString()}).eq("id",m.id);if(a)throw a;d?.("Punch item updated","success")}else{const{error:a}=await t.from("punch_list_items").insert({project_id:o,company_id:k,description:n.description.trim(),area_id:n.area_id||null,assigned_to:n.assigned_to.trim()||null,priority:n.priority,notes:n.notes.trim()||null,photo_url:n.photo_url||null,status:"open"});if(a)throw a;d?.("Punch item added","success")}f(),p()}catch(t){console.error("Error saving punch item:",t),d?.(t.message||"Error saving item","error")}finally{w(!1)}},M=async(e,t)=>{try{const a={status:t,updated_at:new Date().toISOString()};t==="complete"?a.completed_at=new Date().toISOString():a.completed_at=null;const{error:i}=await j().from("punch_list_items").update(a).eq("id",e);if(i)throw i;p()}catch(a){console.error("Error updating status:",a),d?.("Error updating status","error")}},U=async e=>{if(confirm("Delete this punch item?"))try{const{error:t}=await j().from("punch_list_items").delete().eq("id",e);if(t)throw t;d?.("Item deleted","success"),p()}catch(t){console.error("Error deleting item:",t),d?.("Error deleting item","error")}},R=e=>{u({description:e.description,area_id:e.area_id||"",assigned_to:e.assigned_to||"",priority:e.priority||"medium",notes:e.notes||"",photo_url:e.photo_url||""}),S(e),_(!0)},z=e=>e&&h.find(a=>a.id===e)?.name||null,W=e=>N.find(t=>t.value===e)||N[1],H=e=>b.find(t=>t.value===e)||b[0];return s.jsxs("div",{className:"punch-list-card",children:[s.jsxs("div",{className:"punch-list-header",children:[s.jsxs("div",{className:"punch-list-title",children:[s.jsx(v,{size:18}),s.jsx("h3",{children:"Punch List"}),r.total>0&&s.jsxs("span",{className:"punch-stats-inline",children:[s.jsxs("span",{className:"punch-stat-open",children:[r.open," open"]}),r.inProgress>0&&s.jsxs("span",{className:"punch-stat-progress",children:[r.inProgress," in progress"]}),s.jsxs("span",{className:"punch-stat-complete",children:[r.complete,"/",r.total," complete"]})]})]}),s.jsxs("button",{className:"punch-add-btn",onClick:()=>{f(),_(!0)},children:[s.jsx(X,{size:16}),"Add Item"]})]}),r.total>0&&s.jsxs("div",{className:"punch-progress-bar",children:[s.jsx("div",{className:"punch-progress-fill",style:{width:`${r.complete/r.total*100}%`}}),s.jsxs("span",{className:"punch-progress-label",children:[Math.round(r.complete/r.total*100),"% complete"]})]}),r.total>0&&s.jsxs("div",{className:"punch-filters",children:[s.jsxs("div",{className:"punch-filter-group",children:[s.jsx(Y,{size:14}),s.jsxs("select",{value:g,onChange:e=>L(e.target.value),className:"punch-filter-select",children:[s.jsx("option",{value:"all",children:"All Status"}),b.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))]})]}),h.length>0&&s.jsxs("div",{className:"punch-filter-group",children:[s.jsx(I,{size:14}),s.jsxs("select",{value:x,onChange:e=>$(e.target.value),className:"punch-filter-select",children:[s.jsx("option",{value:"all",children:"All Areas"}),h.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]})]}),F&&s.jsxs("form",{className:"punch-form",onSubmit:q,children:[s.jsxs("div",{className:"punch-form-header",children:[s.jsx("h4",{children:m?"Edit Item":"New Punch Item"}),s.jsx("button",{type:"button",className:"punch-form-close",onClick:f,children:s.jsx(J,{size:16})})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Description *"}),s.jsx("textarea",{value:n.description,onChange:e=>u(t=>({...t,description:e.target.value})),placeholder:"What needs to be fixed or completed?",rows:2,required:!0})]}),s.jsxs("div",{className:"punch-form-row",children:[s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Area"}),s.jsxs("select",{value:n.area_id,onChange:e=>u(t=>({...t,area_id:e.target.value})),children:[s.jsx("option",{value:"",children:"No area"}),h.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Assigned To"}),s.jsx("input",{type:"text",value:n.assigned_to,onChange:e=>u(t=>({...t,assigned_to:e.target.value})),placeholder:"Name or company"})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Priority"}),s.jsx("select",{value:n.priority,onChange:e=>u(t=>({...t,priority:e.target.value})),children:N.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})]}),s.jsxs("div",{className:"punch-form-field",children:[s.jsx("label",{children:"Notes"}),s.jsx("textarea",{value:n.notes,onChange:e=>u(t=>({...t,notes:e.target.value})),placeholder:"Additional details...",rows:2})]}),s.jsxs("div",{className:"punch-form-actions",children:[s.jsx("button",{type:"button",className:"punch-btn-cancel",onClick:f,children:"Cancel"}),s.jsxs("button",{type:"submit",className:"punch-btn-save",disabled:P,children:[s.jsx(K,{size:14}),P?"Saving...":m?"Update":"Add Item"]})]})]}),O?s.jsx("div",{className:"punch-loading",children:"Loading punch list..."}):E.length===0?s.jsxs("div",{className:"punch-empty",children:[s.jsx(v,{size:32,style:{opacity:.3}}),s.jsx("p",{children:c.length===0?"No punch items yet":"No items match filters"}),c.length===0&&s.jsx("span",{children:"Add items that need attention before project closeout"})]}):s.jsx("div",{className:"punch-items-list",children:E.map(e=>{const t=H(e.status),a=W(e.priority),i=t.icon;return s.jsxs("div",{className:`punch-item punch-item-${e.status}`,children:[s.jsx("button",{className:"punch-item-status-btn",onClick:()=>{const T=e.status==="open"?"in_progress":e.status==="in_progress"?"complete":"open";M(e.id,T)},title:`Click to change status (current: ${t.label})`,children:s.jsx(i,{size:18,style:{color:t.color}})}),s.jsxs("div",{className:"punch-item-content",children:[s.jsxs("div",{className:"punch-item-top",children:[s.jsx("span",{className:`punch-item-desc ${e.status==="complete"?"completed":""}`,children:e.description}),s.jsx("div",{className:"punch-item-badges",children:s.jsx("span",{className:"punch-priority-badge",style:{color:a.color,borderColor:`${a.color}40`},children:a.label})})]}),s.jsxs("div",{className:"punch-item-meta",children:[z(e.area_id)&&s.jsxs("span",{className:"punch-meta-tag",children:[s.jsx(I,{size:11}),z(e.area_id)]}),e.assigned_to&&s.jsxs("span",{className:"punch-meta-tag",children:[s.jsx(Q,{size:11}),e.assigned_to]}),e.completed_at&&s.jsxs("span",{className:"punch-meta-tag completed",children:[s.jsx(v,{size:11}),"Done ",new Date(e.completed_at).toLocaleDateString()]})]}),e.notes&&s.jsx("div",{className:"punch-item-notes",children:e.notes})]}),s.jsxs("div",{className:"punch-item-actions",children:[s.jsx("button",{className:"punch-action-btn",onClick:()=>R(e),title:"Edit",children:s.jsx(V,{size:14})}),s.jsx("button",{className:"punch-action-btn delete",onClick:()=>U(e.id),title:"Delete",children:s.jsx(Z,{size:14})})]})]},e.id)})})]})}export{le as default};
