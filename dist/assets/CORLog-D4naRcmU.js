import{_ as P}from"./pdf-aQqpMATS.js";import{as as e,ar as w}from"./index-B8N_SJu5.js";import{r as g,q as M,L as W,d as Y,X as B,P as K,z as _,ae as G,F as q,c as y,j as I,a5 as U}from"./icons-B-oSmWeD.js";import{f as u}from"./corCalculations-D9qkkIbo.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const H=[{value:"draft",label:"Draft"},{value:"pending_approval",label:"Pending Approval"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"billed",label:"Billed"},{value:"closed",label:"Closed"}];function J({entry:a,isEditing:j,isSaving:h,onEdit:i,onSave:R,onCancel:E,statusDisplay:L}){const[b,p]=g.useState({dateSentToClient:a.dateSentToClient||"",ceNumber:a.ceNumber||"",comments:a.comments||"",status:a.changeOrder?.status||"draft"}),f=g.useRef(null);g.useEffect(()=>{j&&f.current&&f.current.focus()},[j]),g.useEffect(()=>{p({dateSentToClient:a.dateSentToClient||"",ceNumber:a.ceNumber||"",comments:a.comments||"",status:a.changeOrder?.status||"draft"})},[a]);const v=t=>{t.key==="Enter"&&!t.shiftKey?(t.preventDefault(),O()):t.key==="Escape"&&S()},O=()=>{R(b)},S=()=>{p({dateSentToClient:a.dateSentToClient||"",ceNumber:a.ceNumber||"",comments:a.comments||"",status:a.changeOrder?.status||"draft"}),E()},C=L[a.changeOrder.status]||{label:a.changeOrder.status,className:""},z=t=>{if(!t)return"-";try{return new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch{return t}},A=t=>{if(!t)return"";try{return new Date(t).toISOString().split("T")[0]}catch{return t}};return j?e.jsxs("tr",{className:"cor-log-row editing",children:[e.jsx("td",{className:"col-log-num",children:a.logNumber}),e.jsx("td",{className:"col-date-sent",children:e.jsx("input",{ref:f,type:"date",value:A(b.dateSentToClient),onChange:t=>p(l=>({...l,dateSentToClient:t.target.value})),onKeyDown:v,disabled:h,className:"cor-log-input"})}),e.jsx("td",{className:"col-ce-num",children:e.jsx("input",{type:"text",value:b.ceNumber,onChange:t=>p(l=>({...l,ceNumber:t.target.value})),onKeyDown:v,disabled:h,placeholder:"CE-XXX",className:"cor-log-input",maxLength:50})}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:a.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:a.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:u(a.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status",children:e.jsxs("div",{className:"cor-log-status-select",children:[e.jsx("select",{value:b.status,onChange:t=>p(l=>({...l,status:t.target.value})),disabled:h,className:"cor-log-select",children:H.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx(M,{size:14,className:"select-icon"})]})}),e.jsx("td",{className:"col-comments",children:e.jsx("textarea",{value:b.comments,onChange:t=>p(l=>({...l,comments:t.target.value})),onKeyDown:v,disabled:h,placeholder:"Add comments...",className:"cor-log-textarea",rows:2})}),e.jsx("td",{className:"col-actions",children:h?e.jsx(W,{size:16,className:"spin"}):e.jsxs("div",{className:"cor-log-edit-actions",children:[e.jsx("button",{className:"btn btn-icon btn-success",onClick:O,title:"Save",children:e.jsx(Y,{size:14})}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:S,title:"Cancel",children:e.jsx(B,{size:14})})]})})]}):e.jsxs("tr",{className:"cor-log-row",children:[e.jsx("td",{className:"col-log-num",children:a.logNumber}),e.jsx("td",{className:"col-date-sent editable",onClick:i,children:z(a.dateSentToClient)}),e.jsx("td",{className:"col-ce-num editable",onClick:i,children:a.ceNumber||"-"}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:a.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:a.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:u(a.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status editable",onClick:i,children:e.jsx("span",{className:`cor-log-status ${C.className}`,children:C.label})}),e.jsx("td",{className:"col-comments editable",onClick:i,children:a.comments||e.jsx("span",{className:"placeholder",children:"Click to add..."})}),e.jsx("td",{className:"col-actions",children:e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:i,title:"Edit",children:e.jsx(K,{size:14})})})]})}const $={draft:{label:"Draft",className:"draft"},pending_approval:{label:"Pending",className:"pending"},approved:{label:"Approved",className:"approved"},rejected:{label:"Rejected",className:"rejected"},billed:{label:"Billed",className:"billed"},closed:{label:"Closed",className:"closed"}},k={pending:["draft","pending_approval"],approved:["approved","billed"],void:["rejected","closed"]};function le({project:a,company:j,onShowToast:h}){const[i,R]=g.useState([]),[E,L]=g.useState(!0),[b,p]=g.useState(null),[f,v]=g.useState(null),[O,S]=g.useState(!1);g.useEffect(()=>{C();const c=w.subscribeToCORLog?.(a.id,()=>{C()});return()=>{c&&w.unsubscribe?.(c)}},[a.id]);const C=async()=>{try{const c=await w.getCORLog(a.id);R(c||[])}catch(c){console.error("Error loading COR log:",c),h?.("Error loading COR log","error")}finally{L(!1),S(!1)}},z=()=>{S(!0),C()},A=async(c,d,s)=>{v(c);try{await w.updateCORLogEntry(c,d),d.status&&await w.updateChangeOrderStatus(s,d.status),R(n=>n.map(m=>m.id===c?{...m,dateSentToClient:d.dateSentToClient,ceNumber:d.ceNumber,comments:d.comments,changeOrder:{...m.changeOrder,status:d.status||m.changeOrder.status}}:m)),p(null),h?.("Log entry updated","success")}catch(n){console.error("Error updating log entry:",n),h?.("Error updating log entry","error")}finally{v(null)}},t=g.useMemo(()=>{const c=i.filter(n=>k.pending.includes(n.changeOrder.status)),d=i.filter(n=>k.approved.includes(n.changeOrder.status)),s=i.filter(n=>k.void.includes(n.changeOrder.status));return{pending:c,approved:d,voided:s}},[i]),l=g.useMemo(()=>{const{pending:c,approved:d,voided:s}=t;return{totalCORs:i.length,approvedCount:d.length,pendingCount:c.length,voidCount:s.length,approvedTotal:d.reduce((n,m)=>n+(m.changeOrder.corTotal||0),0),pendingTotal:c.reduce((n,m)=>n+(m.changeOrder.corTotal||0),0),voidTotal:s.reduce((n,m)=>n+(m.changeOrder.corTotal||0),0),grandTotal:i.reduce((n,m)=>n+(m.changeOrder.corTotal||0),0)}},[i,t]),V=async()=>{try{const{default:c}=await P(async()=>{const{default:r}=await import("./pdf-aQqpMATS.js").then(x=>x.j);return{default:r}},[]),{default:d}=await P(async()=>{const{default:r}=await import("./pdf-aQqpMATS.js").then(x=>x.c);return{default:r}},[]),s=new c("landscape"),n=s.internal.pageSize.width;s.setFontSize(18),s.setFont(void 0,"bold"),s.text("CHANGE ORDER LOG",n/2,20,{align:"center"}),s.setFontSize(12),s.setFont(void 0,"normal"),s.text(`Project: ${a.name}`,n/2,28,{align:"center"}),a.job_number&&s.text(`Job #${a.job_number}`,n/2,35,{align:"center"}),s.setFontSize(10),s.text(`Generated: ${new Date().toLocaleDateString()}`,n/2,42,{align:"center"}),j?.name&&(s.setFontSize(11),s.setFont(void 0,"bold"),s.text(j.name,14,20),s.setFont(void 0,"normal"),j.phone&&(s.setFontSize(9),s.text(j.phone,14,25)));const m=i.map(r=>[r.logNumber,r.changeOrder.corNumber||"-",r.dateSentToClient?new Date(r.dateSentToClient).toLocaleDateString():"-",r.ceNumber||"-",r.changeOrder.title||"Untitled",u(r.changeOrder.corTotal||0),$[r.changeOrder.status]?.label||r.changeOrder.status,r.comments||"-"]);d(s,{startY:50,head:[["Log #","COR #","Date Sent","CE #","Description","Amount","Status","Comments"]],body:m,styles:{fontSize:8,cellPadding:3,overflow:"linebreak",valign:"top"},headStyles:{fillColor:[51,51,51],textColor:255,fontStyle:"bold",fontSize:8},columnStyles:{0:{cellWidth:12,halign:"center"},1:{cellWidth:18},2:{cellWidth:22},3:{cellWidth:18},4:{cellWidth:55},5:{cellWidth:22,halign:"right"},6:{cellWidth:18,halign:"center"},7:{cellWidth:"auto",minCellWidth:50}},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:r=>{if(r.column.index===6&&r.section==="body"){const x=r.cell.raw?.toLowerCase();x==="approved"||x==="billed"?r.cell.styles.textColor=[5,150,105]:x==="pending"||x==="pending approval"?r.cell.styles.textColor=[217,119,6]:(x==="rejected"||x==="void")&&(r.cell.styles.textColor=[220,38,38])}}});const N=(s.lastAutoTable?.finalY||100)+10;s.setFontSize(10),s.setFont(void 0,"bold"),s.text("SUMMARY",14,N),s.setFont(void 0,"normal"),s.setFontSize(9);const T=14,o=100;s.text(`Total CORs: ${l.totalCORs}`,T,N+7),s.text(`Approved: ${l.approvedCount} (${u(l.approvedTotal)})`,T,N+14),s.text(`Pending: ${l.pendingCount} (${u(l.pendingTotal)})`,o,N+7),s.text(`Void: ${l.voidCount} (${u(l.voidTotal)})`,o,N+14),s.setFont(void 0,"bold"),s.setFontSize(10),s.text(`Total Value: ${u(l.grandTotal)}`,T,N+24);const D=`COR_Log_${a.job_number||a.name.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`;s.save(D),h?.("PDF exported successfully","success")}catch(c){console.error("Error exporting PDF:",c),h?.("Error exporting PDF","error")}},X=async()=>{try{const c=await P(()=>import("./xlsx-BvJTHLik.js"),[]),d=i.map(o=>({"Log #":o.logNumber,"COR Number":o.changeOrder.corNumber,"Date Sent to Client":o.dateSentToClient||"","CE Number":o.ceNumber||"",Description:o.changeOrder.title||"Untitled",Amount:o.changeOrder.corTotal||0,Status:$[o.changeOrder.status]?.label||o.changeOrder.status,"Created Date":o.changeOrder.createdAt?new Date(o.changeOrder.createdAt).toLocaleDateString():"","Approved Date":o.changeOrder.approvedAt?new Date(o.changeOrder.approvedAt).toLocaleDateString():"","Approved By":o.changeOrder.approvedBy||"",Comments:o.comments||""}));d.push({}),d.push({"Log #":"SUMMARY",Description:`Total CORs: ${l.totalCORs}`,Amount:l.grandTotal,Status:`Approved: ${l.approvedCount}, Pending: ${l.pendingCount}`});const s=c.utils.json_to_sheet(d),n=c.utils.book_new();c.utils.book_append_sheet(n,s,"COR Log");const m=5,N=c.utils.decode_range(s["!ref"]);for(let o=N.s.r+1;o<=N.e.r;o++){const D=c.utils.encode_cell({r:o,c:m});s[D]&&typeof s[D].v=="number"&&(s[D].z="$#,##0.00")}s["!cols"]=[{wch:8},{wch:12},{wch:15},{wch:12},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:20},{wch:30}];const T=`COR_Log_${a.job_number||a.name}_${new Date().toISOString().split("T")[0]}.xlsx`;c.writeFile(n,T),h?.("Excel exported successfully","success")}catch(c){console.error("Error exporting Excel:",c),h?.("Error exporting Excel","error")}};if(E)return e.jsxs("div",{className:"cor-log cor-log-loading",children:[e.jsx(W,{size:24,className:"spin"}),e.jsx("span",{children:"Loading COR Log..."})]});const F=(c,d=!0)=>e.jsxs("table",{className:"cor-log-table",children:[d&&e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-log-num",children:"Log #"}),e.jsx("th",{className:"col-date-sent",children:"Date Sent"}),e.jsx("th",{className:"col-ce-num",children:"CE #"}),e.jsx("th",{className:"col-description",children:"Description"}),e.jsx("th",{className:"col-amount",children:"Amount"}),e.jsx("th",{className:"col-status",children:"Status"}),e.jsx("th",{className:"col-comments",children:"Comments"}),e.jsx("th",{className:"col-actions",children:"Actions"})]})}),e.jsx("tbody",{children:c.map(s=>e.jsx(J,{entry:s,isEditing:b===s.id,isSaving:f===s.id,onEdit:()=>p(s.id),onSave:n=>A(s.id,n,s.changeOrder.id),onCancel:()=>p(null),statusDisplay:$},s.id))})]});return e.jsxs("div",{className:"cor-log cor-log-expanded",children:[e.jsxs("div",{className:"cor-log-header",children:[e.jsxs("div",{className:"cor-log-title",children:[e.jsx(_,{size:20}),e.jsx("h3",{children:"Change Order Log"}),e.jsxs("span",{className:"cor-log-count",children:[i.length," entries"]})]}),e.jsxs("div",{className:"cor-log-actions",children:[e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:z,disabled:O,title:"Refresh",children:e.jsx(G,{size:16,className:O?"spin":""})}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:X,children:[e.jsx(_,{size:14})," Excel"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:V,children:[e.jsx(q,{size:14})," PDF"]})]})]}),e.jsxs("div",{className:"cor-log-summary-cards",children:[e.jsxs("div",{className:"summary-card pending",children:[e.jsx(y,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Pending"}),e.jsxs("span",{className:"summary-card-count",children:[l.pendingCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:u(l.pendingTotal)})]})]}),e.jsxs("div",{className:"summary-card approved",children:[e.jsx(I,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Approved"}),e.jsxs("span",{className:"summary-card-count",children:[l.approvedCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:u(l.approvedTotal)})]})]}),e.jsxs("div",{className:"summary-card void",children:[e.jsx(U,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Void"}),e.jsxs("span",{className:"summary-card-count",children:[l.voidCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:u(l.voidTotal)})]})]}),e.jsxs("div",{className:"summary-card total",children:[e.jsx(_,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Total"}),e.jsxs("span",{className:"summary-card-count",children:[l.totalCORs," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:u(l.grandTotal)})]})]})]}),i.length===0?e.jsxs("div",{className:"cor-log-empty",children:[e.jsx(_,{size:32}),e.jsx("p",{children:"No change orders in log"}),e.jsx("span",{children:"CORs will appear here as they are created"})]}):e.jsxs("div",{className:"cor-log-sections",children:[t.pending.length>0&&e.jsxs("div",{className:"cor-log-section pending",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(y,{size:16}),e.jsx("h4",{children:"Pending Change Orders"}),e.jsx("span",{className:"section-count",children:t.pending.length}),e.jsx("span",{className:"section-total",children:u(l.pendingTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:F(t.pending)})]}),t.approved.length>0&&e.jsxs("div",{className:"cor-log-section approved",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(I,{size:16}),e.jsx("h4",{children:"Approved Change Orders"}),e.jsx("span",{className:"section-count",children:t.approved.length}),e.jsx("span",{className:"section-total",children:u(l.approvedTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:F(t.approved)})]}),t.voided.length>0&&e.jsxs("div",{className:"cor-log-section void",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(U,{size:16}),e.jsx("h4",{children:"Void Change Orders"}),e.jsx("span",{className:"section-count",children:t.voided.length}),e.jsx("span",{className:"section-total",children:u(l.voidTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:F(t.voided)})]})]})]})}export{le as default};
//# sourceMappingURL=CORLog-D4naRcmU.js.map
