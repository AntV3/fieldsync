import{_ as et}from"./pdf-aQqpMATS.js";import{N as we,O as tt,P as Lt,Q as zt,U as Pa,V as Ea,W as at,Z as st,_ as Ia,$ as wa,a0 as $t,a1 as Nt,a2 as Fa,a3 as Da,r as Ht,a4 as Oa,a5 as Wt,a6 as Ma,a7 as Ra,a8 as La,a9 as za,aa as qt,ab as $a,ac as Ha,ad as Wa,ae as qa,u as Ba,af as Va,c as Ua,ag as Ga,ah as Ka,ai as Ya,aj as Pe,ak as Xa,al as Ct,am as St,an as kt,j as xe,ao as Za,ap as Ja,aq as Qa,ar as he,as as es,at as ts,au as as,av as ss,aw as Bt,ax as rs,ay as Ze,az as ns,aA as Ee,aB as ls,aC as is,aD as os,q as e,R as Je,aE as cs,aF as ds,aG as us,T as Qe,B as ms,C as hs,X as Tt,Y as At,t as ps,F as xs,p as J,H as Pt,I as gs}from"./index-DCd80LHj.js";import{r as o,s as Et,b as vs,N as fs,Q as bs,c as ys,j as Vt,F as rt,K as js,aB as It,f as wt,T as _s,H as Ns,W as Cs,g as Ss,ay as ks,a8 as Ts,ae as As,aC as Ps,z as Ft,O as Es,q as Is,y as Dt,X as ws}from"./icons-CosbTI8G.js";import Fs from"./SignatureLinkGenerator-C7ooXMpJ.js";import{C as Ut,T as Ds,a as Os}from"./Dashboard-BNIG6aF7.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";import"./corCalculations-vdJc_BOT.js";var Gt=(r,t,a)=>Lt(r,"xAxis",at(r,t),a),Kt=(r,t,a)=>zt(r,"xAxis",at(r,t),a),Yt=(r,t,a)=>Lt(r,"yAxis",st(r,t),a),Xt=(r,t,a)=>zt(r,"yAxis",st(r,t),a),Ms=we([tt,Gt,Yt,Kt,Xt],(r,t,a,l,m)=>$t(r,"xAxis")?Nt(t,l,!1):Nt(a,m,!1)),Rs=(r,t)=>t,Zt=we([Fa,Rs],(r,t)=>r.filter(a=>a.type==="area").find(a=>a.id===t)),Jt=r=>{var t=tt(r),a=$t(t,"xAxis");return a?"yAxis":"xAxis"},Ls=(r,t)=>{var a=Jt(r);return a==="yAxis"?st(r,t):at(r,t)},zs=(r,t,a)=>Ia(r,Jt(r),Ls(r,t),a),$s=we([Zt,zs],(r,t)=>{var a;if(!(r==null||t==null)){var{stackId:l}=r,m=wa(r);if(!(l==null||m==null)){var d=(a=t[l])===null||a===void 0?void 0:a.stackedData,h=d?.find(i=>i.key===m);if(h!=null)return h.map(i=>[i[0],i[1]])}}}),Hs=we([tt,Gt,Yt,Kt,Xt,$s,Pa,Ms,Zt,Ea],(r,t,a,l,m,d,h,i,v,C)=>{var{chartData:N,dataStartIndex:S,dataEndIndex:E}=h;if(!(v==null||r!=="horizontal"&&r!=="vertical"||t==null||a==null||l==null||m==null||l.length===0||m.length===0||i==null)){var{data:y}=v,F;if(y&&y.length>0?F=y:F=N?.slice(S,E+1),F!=null)return lr({layout:r,xAxis:t,yAxis:a,xAxisTicks:l,yAxisTicks:m,dataStartIndex:S,areaSettings:v,stackedData:d,displayedData:F,chartBaseValue:C,bandSize:i})}}),Ws=["id"],qs=["activeDot","animationBegin","animationDuration","animationEasing","connectNulls","dot","fill","fillOpacity","hide","isAnimationActive","legendType","stroke","xAxisId","yAxisId"];function de(){return de=Object.assign?Object.assign.bind():function(r){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var l in a)({}).hasOwnProperty.call(a,l)&&(r[l]=a[l])}return r},de.apply(null,arguments)}function Qt(r,t){if(r==null)return{};var a,l,m=Bs(r,t);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(r);for(l=0;l<d.length;l++)a=d[l],t.indexOf(a)===-1&&{}.propertyIsEnumerable.call(r,a)&&(m[a]=r[a])}return m}function Bs(r,t){if(r==null)return{};var a={};for(var l in r)if({}.hasOwnProperty.call(r,l)){if(t.indexOf(l)!==-1)continue;a[l]=r[l]}return a}function Ot(r,t){var a=Object.keys(r);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(r);t&&(l=l.filter(function(m){return Object.getOwnPropertyDescriptor(r,m).enumerable})),a.push.apply(a,l)}return a}function pe(r){for(var t=1;t<arguments.length;t++){var a=arguments[t]!=null?arguments[t]:{};t%2?Ot(Object(a),!0).forEach(function(l){Vs(r,l,a[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):Ot(Object(a)).forEach(function(l){Object.defineProperty(r,l,Object.getOwnPropertyDescriptor(a,l))})}return r}function Vs(r,t,a){return(t=Us(t))in r?Object.defineProperty(r,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[t]=a,r}function Us(r){var t=Gs(r,"string");return typeof t=="symbol"?t:t+""}function Gs(r,t){if(typeof r!="object"||!r)return r;var a=r[Symbol.toPrimitive];if(a!==void 0){var l=a.call(r,t);if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(r)}function Ie(r,t){return r&&r!=="none"?r:t}var Ks=r=>{var{dataKey:t,name:a,stroke:l,fill:m,legendType:d,hide:h}=r;return[{inactive:h,dataKey:t,type:d,color:Ie(l,m),value:qt(a,t),payload:r}]},Ys=o.memo(r=>{var{dataKey:t,data:a,stroke:l,strokeWidth:m,fill:d,name:h,hide:i,unit:v,tooltipType:C,id:N}=r,S={dataDefinedOnItem:a,positions:void 0,settings:{stroke:l,strokeWidth:m,fill:d,dataKey:t,nameKey:void 0,name:qt(h,t),hide:i,type:C,color:Ie(l,d),unit:v,graphicalItemId:N}};return o.createElement($a,{tooltipEntrySettings:S})});function Xs(r){var{clipPathId:t,points:a,props:l}=r,{needClip:m,dot:d,dataKey:h}=l,i=Bt(l);return o.createElement(ns,{points:a,dot:d,className:"recharts-area-dots",dotClassName:"recharts-area-dot",dataKey:h,baseProps:i,needClip:m,clipPathId:t})}function Zs(r){var{showLabels:t,children:a,points:l}=r,m=l.map(d=>{var h,i,v={x:(h=d.x)!==null&&h!==void 0?h:0,y:(i=d.y)!==null&&i!==void 0?i:0,width:0,lowerWidth:0,upperWidth:0,height:0};return pe(pe({},v),{},{value:d.value,payload:d.payload,parentViewBox:void 0,viewBox:v,fill:void 0})});return o.createElement(ss,{value:t?m:void 0},a)}function Mt(r){var{points:t,baseLine:a,needClip:l,clipPathId:m,props:d}=r,{layout:h,type:i,stroke:v,connectNulls:C,isRange:N}=d,{id:S}=d,E=Qt(d,Ws),y=Bt(E),F=rs(E);return o.createElement(o.Fragment,null,t?.length>1&&o.createElement(Pe,{clipPath:l?"url(#clipPath-".concat(m,")"):void 0},o.createElement(Ze,de({},F,{id:S,points:t,connectNulls:C,type:i,baseLine:a,layout:h,stroke:"none",className:"recharts-area-area"})),v!=="none"&&o.createElement(Ze,de({},y,{className:"recharts-area-curve",layout:h,type:i,connectNulls:C,fill:"none",points:t})),v!=="none"&&N&&o.createElement(Ze,de({},y,{className:"recharts-area-curve",layout:h,type:i,connectNulls:C,fill:"none",points:a}))),o.createElement(Xs,{points:t,props:E,clipPathId:m}))}function Js(r){var t,a,{alpha:l,baseLine:m,points:d,strokeWidth:h}=r,i=(t=d[0])===null||t===void 0?void 0:t.y,v=(a=d[d.length-1])===null||a===void 0?void 0:a.y;if(!Ee(i)||!Ee(v))return null;var C=l*Math.abs(i-v),N=Math.max(...d.map(S=>S.x||0));return xe(m)?N=Math.max(m,N):m&&Array.isArray(m)&&m.length&&(N=Math.max(...m.map(S=>S.x||0),N)),xe(N)?o.createElement("rect",{x:0,y:i<v?i:i-C,width:N+(h?parseInt("".concat(h),10):1),height:Math.floor(C)}):null}function Qs(r){var t,a,{alpha:l,baseLine:m,points:d,strokeWidth:h}=r,i=(t=d[0])===null||t===void 0?void 0:t.x,v=(a=d[d.length-1])===null||a===void 0?void 0:a.x;if(!Ee(i)||!Ee(v))return null;var C=l*Math.abs(i-v),N=Math.max(...d.map(S=>S.y||0));return xe(m)?N=Math.max(m,N):m&&Array.isArray(m)&&m.length&&(N=Math.max(...m.map(S=>S.y||0),N)),xe(N)?o.createElement("rect",{x:i<v?i:i-C,y:0,width:C,height:Math.floor(N+(h?parseInt("".concat(h),10):1))}):null}function er(r){var{alpha:t,layout:a,points:l,baseLine:m,strokeWidth:d}=r;return a==="vertical"?o.createElement(Js,{alpha:t,points:l,baseLine:m,strokeWidth:d}):o.createElement(Qs,{alpha:t,points:l,baseLine:m,strokeWidth:d})}function tr(r){var{needClip:t,clipPathId:a,props:l,previousPointsRef:m,previousBaselineRef:d}=r,{points:h,baseLine:i,isAnimationActive:v,animationBegin:C,animationDuration:N,animationEasing:S,onAnimationStart:E,onAnimationEnd:y}=l,F=o.useMemo(()=>({points:h,baseLine:i}),[h,i]),G=Za(F,"recharts-area-"),M=Ja(),[D,$]=o.useState(!1),K=!D,k=o.useCallback(()=>{typeof y=="function"&&y(),$(!1)},[y]),w=o.useCallback(()=>{typeof E=="function"&&E(),$(!0)},[E]);if(M==null)return null;var p=m.current,W=d.current;return o.createElement(Zs,{showLabels:K,points:h},l.children,o.createElement(Qa,{animationId:G,begin:C,duration:N,isActive:v,easing:S,onAnimationEnd:k,onAnimationStart:w,key:G},I=>{if(p){var q=p.length/h.length,Z=I===1?h:h.map((x,_)=>{var P=Math.floor(_*q);if(p[P]){var O=p[P];return pe(pe({},x),{},{x:he(O.x,x.x,I),y:he(O.y,x.y,I)})}return x}),R;return xe(i)?R=he(W,i,I):es(i)||ts(i)?R=he(W,0,I):R=i.map((x,_)=>{var P=Math.floor(_*q);if(Array.isArray(W)&&W[P]){var O=W[P];return pe(pe({},x),{},{x:he(O.x,x.x,I),y:he(O.y,x.y,I)})}return x}),I>0&&(m.current=Z,d.current=R),o.createElement(Mt,{points:Z,baseLine:R,needClip:t,clipPathId:a,props:l})}return I>0&&(m.current=h,d.current=i),o.createElement(Pe,null,v&&o.createElement("defs",null,o.createElement("clipPath",{id:"animationClipPath-".concat(a)},o.createElement(er,{alpha:I,points:h,baseLine:i,layout:M,strokeWidth:l.strokeWidth}))),o.createElement(Pe,{clipPath:"url(#animationClipPath-".concat(a,")")},o.createElement(Mt,{points:h,baseLine:i,needClip:t,clipPathId:a,props:l})))}),o.createElement(as,{label:l.label}))}function ar(r){var{needClip:t,clipPathId:a,props:l}=r,m=o.useRef(null),d=o.useRef();return o.createElement(tr,{needClip:t,clipPathId:a,props:l,previousPointsRef:m,previousBaselineRef:d})}class sr extends o.PureComponent{render(){var{hide:t,dot:a,points:l,className:m,top:d,left:h,needClip:i,xAxisId:v,yAxisId:C,width:N,height:S,id:E,baseLine:y,zIndex:F}=this.props;if(t)return null;var G=Ua("recharts-area",m),M=E,{r:D,strokeWidth:$}=Ga(a),K=Ka(a),k=D*2+$,w=i?"url(#clipPath-".concat(K?"":"dots-").concat(M,")"):void 0;return o.createElement(Ya,{zIndex:F},o.createElement(Pe,{className:G},i&&o.createElement("defs",null,o.createElement(Xa,{clipPathId:M,xAxisId:v,yAxisId:C}),!K&&o.createElement("clipPath",{id:"clipPath-dots-".concat(M)},o.createElement("rect",{x:h-k/2,y:d-k/2,width:N+k,height:S+k}))),o.createElement(ar,{needClip:i,clipPathId:M,props:this.props})),o.createElement(Ct,{points:l,mainColor:Ie(this.props.stroke,this.props.fill),itemDataKey:this.props.dataKey,activeDot:this.props.activeDot,clipPath:w}),this.props.isRange&&Array.isArray(y)&&o.createElement(Ct,{points:y,mainColor:Ie(this.props.stroke,this.props.fill),itemDataKey:this.props.dataKey,activeDot:this.props.activeDot,clipPath:w}))}}var ea={activeDot:!0,animationBegin:0,animationDuration:1500,animationEasing:"ease",connectNulls:!1,dot:!1,fill:"#3182bd",fillOpacity:.6,hide:!1,isAnimationActive:"auto",legendType:"line",stroke:"#3182bd",strokeWidth:1,type:"linear",label:!1,xAxisId:0,yAxisId:0,zIndex:Oa.area};function rr(r){var t,a=Ht(r,ea),{activeDot:l,animationBegin:m,animationDuration:d,animationEasing:h,connectNulls:i,dot:v,fill:C,fillOpacity:N,hide:S,isAnimationActive:E,legendType:y,stroke:F,xAxisId:G,yAxisId:M}=a,D=Qt(a,qs),$=Ha(),K=Wa(),{needClip:k}=qa(G,M),w=Wt(),{points:p,isRange:W,baseLine:I}=(t=Ba(P=>Hs(P,r.id,w)))!==null&&t!==void 0?t:{},q=Va();if($!=="horizontal"&&$!=="vertical"||q==null||K!=="AreaChart"&&K!=="ComposedChart")return null;var{height:Z,width:R,x,y:_}=q;return!p||!p.length?null:o.createElement(sr,de({},D,{activeDot:l,animationBegin:m,animationDuration:d,animationEasing:h,baseLine:I,connectNulls:i,dot:v,fill:C,fillOpacity:N,height:Z,hide:S,layout:$,isAnimationActive:E==="auto"?!ls.isSsr:E,isRange:W,legendType:y,needClip:k,points:p,stroke:F,width:R,left:x,top:_,xAxisId:G,yAxisId:M}))}var nr=(r,t,a,l,m)=>{var d=a??t;if(xe(d))return d;var h=r==="horizontal"?m:l,i=h.scale.domain();if(h.type==="number"){var v=Math.max(i[0],i[1]),C=Math.min(i[0],i[1]);return d==="dataMin"?C:d==="dataMax"||v<0?v:Math.max(Math.min(i[0],i[1]),0)}return d==="dataMin"?i[0]:d==="dataMax"?i[1]:i[0]};function lr(r){var{areaSettings:{connectNulls:t,baseValue:a,dataKey:l},stackedData:m,layout:d,chartBaseValue:h,xAxis:i,yAxis:v,displayedData:C,dataStartIndex:N,xAxisTicks:S,yAxisTicks:E,bandSize:y}=r,F=m&&m.length,G=nr(d,h,a,i,v),M=d==="horizontal",D=!1,$=C.map((k,w)=>{var p,W,I;if(F)I=m[N+w];else{var q=St(k,l);Array.isArray(q)?(I=q,D=!0):I=[G,q]}var Z=(p=(W=I)===null||W===void 0?void 0:W[1])!==null&&p!==void 0?p:null,R=Z==null||F&&!t&&St(k,l)==null;return M?{x:kt({axis:i,ticks:S,bandSize:y,entry:k,index:w}),y:R?null:v.scale(Z),value:I,payload:k}:{x:R?null:i.scale(Z),y:kt({axis:v,ticks:E,bandSize:y,entry:k,index:w}),value:I,payload:k}}),K;return F||D?K=$.map(k=>{var w=Array.isArray(k.value)?k.value[0]:null;return M?{x:k.x,y:w!=null&&k.y!=null?v.scale(w):null,payload:k.payload}:{x:w!=null?i.scale(w):null,y:k.y,payload:k.payload}}):K=M?v.scale(G):i.scale(G),{points:$,baseLine:K,isRange:D}}function ir(r){var t=Ht(r,ea),a=Wt();return o.createElement(Ma,{id:t.id,type:"area"},l=>o.createElement(o.Fragment,null,o.createElement(Ra,{legendPayload:Ks(t)}),o.createElement(Ys,{dataKey:t.dataKey,data:t.data,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:t.fill,name:t.name,hide:t.hide,unit:t.unit,tooltipType:t.tooltipType,id:l}),o.createElement(La,{type:"area",id:l,data:t.data,dataKey:t.dataKey,xAxisId:t.xAxisId,yAxisId:t.yAxisId,zAxisId:0,stackId:za(t.stackId),hide:t.hide,barSize:void 0,baseValue:t.baseValue,isPanorama:a,connectNulls:t.connectNulls}),o.createElement(rr,de({},t,{id:l}))))}var ta=o.memo(ir,Da);ta.displayName="Area";var or=["axis"],cr=o.forwardRef((r,t)=>o.createElement(is,{chartName:"AreaChart",defaultTooltipEventType:"axis",validateTooltipEventTypes:or,tooltipPayloadSearcher:os,categoricalChartProps:r,ref:t}));function dr({tickets:r=[],laborRates:t={}}){const a=o.useMemo(()=>{if(!r.length)return{total:0,pending:0,approved:0,billed:0,rejected:0,totalHours:0,regularHours:0,overtimeHours:0,materialsCost:0,uniqueWorkers:0,avgHoursPerTicket:0,approvalRate:0,pendingValue:0,approvedValue:0,billedValue:0,workersByRole:{},topWorkers:[],byMonth:[],byStatus:[]};const d=r.filter(x=>x.status==="pending").length,h=r.filter(x=>x.status==="approved").length,i=r.filter(x=>x.status==="billed").length,v=r.filter(x=>x.status==="rejected").length;let C=0,N=0,S=0;const E={},y={Foreman:0,Superintendent:0,Operator:0,Laborer:0};r.forEach(x=>{x.t_and_m_workers&&x.t_and_m_workers.forEach(_=>{const P=parseFloat(_.hours)||0,O=parseFloat(_.overtime_hours)||0;N+=P,S+=O,C+=P+O;const Y=_.name||"Unknown";E[Y]||(E[Y]={name:Y,hours:0,role:_.role||"Laborer"}),E[Y].hours+=P+O;const H=_.role||"Laborer";y[H]!==void 0?y[H]+=P+O:y[H]=P+O})});let F=0;r.forEach(x=>{x.t_and_m_items&&x.t_and_m_items.forEach(_=>{const P=_.materials_equipment?.cost_per_unit||0;F+=_.quantity*P})});const G=Object.keys(E).length,M=Object.values(E).sort((x,_)=>_.hours-x.hours).slice(0,5),D=h+i+v,$=D>0?Math.round((h+i)/D*100):0,k={...{Foreman:85,Superintendent:95,Operator:75,Laborer:55},...t},w=x=>{let _=0,P=0;return x.t_and_m_workers&&x.t_and_m_workers.forEach(O=>{const Y=O.role||"Laborer",H=k[Y]||k.Laborer,ne=parseFloat(O.hours)||0,Fe=parseFloat(O.overtime_hours)||0;_+=ne*H+Fe*H*1.5}),x.t_and_m_items&&x.t_and_m_items.forEach(O=>{const Y=O.materials_equipment?.cost_per_unit||0;P+=O.quantity*Y}),_+P},p=r.filter(x=>x.status==="pending").reduce((x,_)=>x+w(_),0),W=r.filter(x=>x.status==="approved").reduce((x,_)=>x+w(_),0),I=r.filter(x=>x.status==="billed").reduce((x,_)=>x+w(_),0),q={};r.forEach(x=>{const _=new Date(x.work_date),P=`${_.getFullYear()}-${String(_.getMonth()+1).padStart(2,"0")}`,O=_.toLocaleDateString("en-US",{month:"short",year:"2-digit"});q[P]||(q[P]={month:O,monthKey:P,tickets:0,hours:0,cost:0,value:0}),q[P].tickets+=1,q[P].cost+=w(x)-F,x.t_and_m_workers&&x.t_and_m_workers.forEach(Y=>{const H=parseFloat(Y.hours)||0,ne=parseFloat(Y.overtime_hours)||0;q[P].hours+=H+ne}),x.t_and_m_items&&x.t_and_m_items.forEach(Y=>{const H=Y.materials_equipment?.cost_per_unit||0;q[P].value+=Y.quantity*H})});const Z=Object.values(q).sort((x,_)=>x.monthKey.localeCompare(_.monthKey)).slice(-6),R=[{name:"Pending",value:d,color:"#f59e0b"},{name:"Approved",value:h,color:"#10b981"},{name:"Billed",value:i,color:"#3b82f6"},{name:"Rejected",value:v,color:"#ef4444"}].filter(x=>x.value>0);return{total:r.length,pending:d,approved:h,billed:i,rejected:v,totalHours:C,regularHours:N,overtimeHours:S,materialsCost:F,uniqueWorkers:G,avgHoursPerTicket:r.length>0?C/r.length:0,approvalRate:$,pendingValue:p,approvedValue:W,billedValue:I,workersByRole:y,topWorkers:M,byMonth:Z,byStatus:R}},[r,t]),l=d=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(d),m=({active:d,payload:h,label:i})=>d&&h&&h.length?e.jsxs("div",{className:"tm-chart-tooltip",children:[e.jsx("p",{className:"tm-tooltip-label",children:i}),h.map((v,C)=>e.jsxs("p",{style:{color:v.color},children:[v.name,": ",v.name.includes("Cost")||v.name.includes("Value")?l(v.value):v.value.toFixed(1)]},C))]}):null;return r.length===0?e.jsxs("div",{className:"tm-dashboard tm-dashboard-empty",children:[e.jsx("div",{className:"tm-empty-icon",children:e.jsx(Et,{size:48})}),e.jsx("p",{children:"No T&M tickets yet"}),e.jsx("p",{className:"tm-empty-hint",children:"Create tickets to see analytics and trends"})]}):e.jsxs("div",{className:"tm-dashboard",children:[e.jsxs("div",{className:"tm-summary-cards",children:[e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon tickets",children:e.jsx(Et,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:a.total}),e.jsx("span",{className:"tm-card-label",children:"Total Tickets"})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon hours",children:e.jsx(vs,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:a.totalHours.toFixed(1)}),e.jsx("span",{className:"tm-card-label",children:"Total Hours"}),a.overtimeHours>0&&e.jsxs("span",{className:"tm-card-detail",children:[a.overtimeHours.toFixed(1)," OT"]})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon workers",children:e.jsx(fs,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:a.uniqueWorkers}),e.jsx("span",{className:"tm-card-label",children:"Workers"})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon materials",children:e.jsx(bs,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l(a.materialsCost)}),e.jsx("span",{className:"tm-card-label",children:"Materials"})]})]})]}),e.jsxs("div",{className:"tm-status-cards",children:[e.jsxs("div",{className:"tm-status-card pending",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(ys,{size:16}),e.jsx("span",{children:"Pending"})]}),e.jsx("div",{className:"tm-status-count",children:a.pending}),e.jsx("div",{className:"tm-status-value",children:l(a.pendingValue)})]}),e.jsxs("div",{className:"tm-status-card approved",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(Vt,{size:16}),e.jsx("span",{children:"Approved"})]}),e.jsx("div",{className:"tm-status-count",children:a.approved}),e.jsx("div",{className:"tm-status-value",children:l(a.approvedValue)})]}),e.jsxs("div",{className:"tm-status-card billed",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(rt,{size:16}),e.jsx("span",{children:"Billed"})]}),e.jsx("div",{className:"tm-status-count",children:a.billed}),e.jsx("div",{className:"tm-status-value",children:l(a.billedValue)})]}),e.jsxs("div",{className:"tm-status-card rate",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(js,{size:16}),e.jsx("span",{children:"Approval Rate"})]}),e.jsxs("div",{className:"tm-status-count",children:[a.approvalRate,"%"]}),e.jsxs("div",{className:"tm-status-value",children:[a.approved+a.billed," / ",a.total-a.pending]})]})]}),e.jsxs("div",{className:"tm-charts-row",children:[a.byStatus.length>0&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Status Distribution"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(Je,{width:"100%",height:200,children:e.jsxs(cs,{children:[e.jsx(ds,{data:a.byStatus,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:2,dataKey:"value",label:({name:d,percent:h})=>`${d} ${(h*100).toFixed(0)}%`,labelLine:!1,children:a.byStatus.map((d,h)=>e.jsx(us,{fill:d.color},`cell-${h}`))}),e.jsx(Qe,{})]})})}),e.jsx("div",{className:"tm-chart-legend",children:a.byStatus.map((d,h)=>e.jsxs("div",{className:"tm-legend-item",children:[e.jsx("span",{className:"tm-legend-color",style:{background:d.color}}),e.jsx("span",{className:"tm-legend-label",children:d.name}),e.jsx("span",{className:"tm-legend-value",children:d.value})]},h))})]}),a.byMonth.length>0&&e.jsxs("div",{className:"tm-chart-card wide",children:[e.jsx("h4",{className:"tm-chart-title",children:"Hours by Month"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(Je,{width:"100%",height:200,children:e.jsxs(ms,{data:a.byMonth,children:[e.jsx(hs,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(Tt,{dataKey:"month",tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:{stroke:"var(--border-color)"}}),e.jsx(At,{tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:{stroke:"var(--border-color)"}}),e.jsx(Qe,{content:e.jsx(m,{})}),e.jsx(ps,{dataKey:"hours",name:"Hours",fill:"var(--primary-color)",radius:[4,4,0,0]})]})})})]})]}),e.jsxs("div",{className:"tm-charts-row",children:[e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Hours by Role"}),e.jsx("div",{className:"tm-role-breakdown",children:Object.entries(a.workersByRole).filter(([,d])=>d>0).sort((d,h)=>h[1]-d[1]).map(([d,h])=>{const i=h/a.totalHours*100;return e.jsxs("div",{className:"tm-role-bar",children:[e.jsxs("div",{className:"tm-role-info",children:[e.jsx("span",{className:"tm-role-name",children:d}),e.jsxs("span",{className:"tm-role-hours",children:[h.toFixed(1)," hrs"]})]}),e.jsx("div",{className:"tm-role-track",children:e.jsx("div",{className:"tm-role-fill",style:{width:`${i}%`}})})]},d)})})]}),a.topWorkers.length>0&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Top Workers"}),e.jsx("div",{className:"tm-top-workers",children:a.topWorkers.map((d,h)=>e.jsxs("div",{className:"tm-worker-row",children:[e.jsxs("span",{className:"tm-worker-rank",children:["#",h+1]}),e.jsxs("div",{className:"tm-worker-info",children:[e.jsx("span",{className:"tm-worker-name",children:d.name}),e.jsx("span",{className:"tm-worker-role",children:d.role})]}),e.jsxs("span",{className:"tm-worker-hours",children:[d.hours.toFixed(1)," hrs"]})]},d.name))})]}),a.byMonth.length>1&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Ticket Volume"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(Je,{width:"100%",height:150,children:e.jsxs(cr,{data:a.byMonth,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"ticketGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"var(--primary-color)",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"var(--primary-color)",stopOpacity:0})]})}),e.jsx(Tt,{dataKey:"month",tick:{fill:"var(--text-secondary)",fontSize:10},axisLine:!1,tickLine:!1}),e.jsx(At,{hide:!0}),e.jsx(Qe,{content:e.jsx(m,{})}),e.jsx(ta,{type:"monotone",dataKey:"tickets",name:"Tickets",stroke:"var(--primary-color)",fill:"url(#ticketGradient)",strokeWidth:2})]})})})]})]}),e.jsxs("div",{className:"tm-quick-stats",children:[e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Avg Hours/Ticket"}),e.jsx("span",{className:"tm-quick-value",children:a.avgHoursPerTicket.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Regular Hours"}),e.jsx("span",{className:"tm-quick-value",children:a.regularHours.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Overtime Hours"}),e.jsx("span",{className:"tm-quick-value",children:a.overtimeHours.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Total Est. Value"}),e.jsx("span",{className:"tm-quick-value",children:l(a.pendingValue+a.approvedValue+a.billedValue)})]})]})]})}const ur=o.memo(function({ticket:t,isExpanded:a,isSelected:l,isLocked:m,lockInfo:d,hasFailedImport:h,isRetrying:i,onToggleExpand:v,onToggleSelect:C,onApprove:N,onUpdateStatus:S,onDelete:E,onOpenCorAssign:y,onRetryImport:F,onShowSignatureLink:G,formatDate:M,calculateTotalHours:D,calculateTicketTotal:$}){const K=D(t),k=$(t),w=p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),v(t.id))};return e.jsxs("div",{className:`tm-ticket-card hover-lift animate-fade-in-up ${t.status} ${l?"selected":""} ${m?"locked":""}`,role:"article","aria-label":`T&M Ticket for ${M(t.work_date)}, ${K} hours, $${k.toFixed(2)}, status: ${t.status}`,children:[e.jsxs("div",{className:"tm-ticket-header",onClick:()=>v(t.id),onKeyDown:w,role:"button",tabIndex:0,"aria-expanded":a,"aria-label":`${a?"Collapse":"Expand"} ticket details`,children:[e.jsx("input",{type:"checkbox",checked:l,onChange:p=>C(t.id,p),onClick:p=>p.stopPropagation(),className:"tm-checkbox","aria-label":`Select ticket for ${M(t.work_date)}`}),e.jsxs("div",{className:"tm-ticket-info",children:[e.jsx("span",{className:"tm-ticket-date",children:M(t.work_date)}),t.ce_pco_number&&e.jsx("span",{className:"tm-ce-badge",children:t.ce_pco_number}),t.assigned_cor_id&&d?.lockedBy&&e.jsxs("span",{className:`tm-cor-badge ${m?"locked":""}`,title:d?.reason,children:[m&&e.jsx(It,{size:10}),d.lockedBy.cor_number]}),t.photos?.length>0&&e.jsx(Ut,{count:t.photos.length,icon:wt,size:"small",variant:"default"}),h&&e.jsxs("span",{className:"tm-import-failed-badge",title:"COR data import failed - retry needed",children:[e.jsx(_s,{size:12})," Import Failed"]}),t.client_signature_data&&e.jsxs("span",{className:"tm-verified-badge",title:`Verified by ${t.client_signature_name||"client"}${t.client_signature_date?` on ${M(t.client_signature_date)}`:""}`,children:[e.jsx(Vt,{size:12})," Verified"]}),e.jsx("span",{className:`tm-ticket-status ${t.status}`,children:t.status})]}),e.jsxs("div",{className:"tm-ticket-summary",children:[e.jsxs("span",{className:"tm-ticket-hours",children:[K," hrs"]}),e.jsxs("span",{className:"tm-ticket-total",children:["$",k.toFixed(2)]}),e.jsx("span",{className:"tm-expand-arrow","aria-hidden":"true",children:a?"▼":"▶"})]})]}),a&&e.jsxs("div",{className:"tm-ticket-details",children:[t.t_and_m_workers?.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(Ns,{size:16,className:"inline-icon"})," Workers"]}),e.jsx("div",{className:"tm-detail-list",children:t.t_and_m_workers.map(p=>e.jsxs("div",{className:"tm-detail-row",children:[e.jsxs("span",{children:[p.role&&p.role!=="Laborer"&&e.jsx("span",{className:"tm-role-badge",children:p.role}),p.name]}),e.jsxs("span",{children:[p.hours," hrs",parseFloat(p.overtime_hours)>0&&e.jsxs("span",{className:"tm-ot-badge",children:[" +",p.overtime_hours," OT"]})]})]},p.id))})]}),t.t_and_m_items?.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(Cs,{size:16,className:"inline-icon"})," Materials & Equipment"]}),e.jsx("div",{className:"tm-detail-list",children:t.t_and_m_items.map(p=>e.jsxs("div",{className:"tm-detail-row",children:[e.jsx("span",{children:p.custom_name?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tm-custom-badge",children:"Custom"})," ",p.custom_name]}):p.materials_equipment?.name}),e.jsxs("span",{className:"tm-detail-qty",children:[p.quantity," ",p.materials_equipment?.unit||"each",p.materials_equipment?.cost_per_unit>0&&e.jsxs("span",{className:"tm-item-cost",children:["$",(p.quantity*p.materials_equipment.cost_per_unit).toFixed(2)]})]})]},p.id))})]}),t.notes&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(rt,{size:16,className:"inline-icon"})," Description"]}),e.jsx("p",{className:"tm-notes-text",children:t.notes})]}),t.photos&&t.photos.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(wt,{size:16,className:"inline-icon"})," Photos (",t.photos.length,")"]}),e.jsx("div",{className:"tm-photos-grid",children:t.photos.map((p,W)=>e.jsx("a",{href:p,target:"_blank",rel:"noopener noreferrer",className:"tm-photo-thumb",children:e.jsx("img",{src:p,alt:`Photo ${W+1}`,onError:I=>{I.target.onerror=null,I.target.classList.add("photo-error"),I.target.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=="}})},W))})]}),t.ce_pco_number&&t.change_order_value>0&&e.jsxs("div",{className:"tm-change-order-value",children:[e.jsx("span",{className:"tm-co-label",children:"Change Order Value:"}),e.jsxs("span",{className:"tm-co-amount",children:["$",t.change_order_value.toLocaleString()]})]}),m&&e.jsxs("div",{className:"tm-lock-notice",children:[e.jsx(It,{size:14}),e.jsx("span",{children:d?.reason||"This ticket is locked (COR approved)"})]}),e.jsxs("div",{className:"tm-ticket-actions",role:"group","aria-label":"Ticket actions",children:[t.status==="pending"&&!m&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-success btn-small",onClick:p=>{p.stopPropagation(),N(t)},"aria-label":"Approve this ticket",children:"Approve"}),e.jsx("button",{className:"btn btn-warning btn-small",onClick:p=>{p.stopPropagation(),S(t.id,"rejected")},"aria-label":"Reject this ticket",children:"Reject"})]}),t.status==="approved"&&!m&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-primary btn-small",onClick:p=>{p.stopPropagation(),S(t.id,"billed")},"aria-label":"Mark ticket as billed",children:"Mark Billed"}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:p=>{p.stopPropagation(),G(t)},"aria-label":"Get signature link for this ticket",children:[e.jsx(Ss,{size:14,"aria-hidden":"true"})," Signature Link"]})]}),t.status==="rejected"&&!m&&e.jsx("button",{className:"btn btn-secondary btn-small",onClick:p=>{p.stopPropagation(),S(t.id,"pending")},"aria-label":"Restore rejected ticket to pending",children:"Restore"}),!m&&e.jsxs("button",{className:`btn btn-small ${t.assigned_cor_id?"btn-ghost":"btn-secondary"}`,onClick:p=>{p.stopPropagation(),y(t)},"aria-label":t.assigned_cor_id?"Change COR link":"Link to Change Order",children:[e.jsx(ks,{size:14,"aria-hidden":"true"})," ",t.assigned_cor_id?"COR":"Link COR"]}),h&&!m&&e.jsxs("button",{className:"btn btn-warning btn-small",onClick:p=>F(t,p),disabled:i,"aria-label":"Retry syncing data to COR","aria-busy":i,children:[e.jsx(Ts,{size:14,className:i?"spin":"","aria-hidden":"true"})," ",i?"Syncing...":"Retry Sync"]}),!m&&e.jsx("button",{className:"btn btn-danger btn-small",onClick:p=>{p.stopPropagation(),E(t.id)},"aria-label":"Delete this ticket",children:"Delete"})]})]})]})}),Rt=()=>et(()=>import("./xlsx-BvJTHLik.js"),[]),mr=()=>Promise.all([et(()=>import("./pdf-aQqpMATS.js").then(r=>r.j),[]),et(()=>import("./pdf-aQqpMATS.js").then(r=>r.c),[])]);function _r({project:r,company:t,onShowToast:a,compact:l=!1,previewMode:m=!1,onViewAll:d}){const{branding:h}=xs(),[i,v]=o.useState([]),[C,N]=o.useState(!0),[S,E]=o.useState(!1),[y,F]=o.useState("all"),[G,M]=o.useState(null),[D,$]=o.useState(new Set),[K,k]=o.useState(0),[w,p]=o.useState(!0),[W,I]=o.useState(0),q=25,Z=500,[R,x]=o.useState("recent"),[_,P]=o.useState(()=>{const s=localStorage.getItem("fieldsync-tm-default-view");return s==="list"||s==="dashboard"?s:"dashboard"}),[O,Y]=o.useState(new Set),[H,ne]=o.useState({start:"",end:""}),[Fe,De]=o.useState(!1),[ge,aa]=o.useState(null),[Oe,nt]=o.useState(""),[sa,lt]=o.useState(!1),[ve,it]=o.useState(null),[ra,fe]=o.useState(!1),[te,ot]=o.useState(null),[Se,na]=o.useState([]),[be,Me]=o.useState(""),[ct,dt]=o.useState(!1),[Q,la]=o.useState({}),[ia,ut]=o.useState({}),[oa,mt]=o.useState(null);o.useEffect(()=>{v([]),k(0),p(!0),ue(0,!0);const s=J.subscribeToTMTickets?.(r.id,()=>{ue(0,!0)});return()=>{s&&J.unsubscribe?.(s)}},[r.id]),o.useEffect(()=>{l||localStorage.setItem("fieldsync-tm-default-view",_)},[_,l]),o.useEffect(()=>{if(!l){const s=localStorage.getItem("fieldsync-tm-default-view");P(s==="list"||s==="dashboard"?s:"dashboard")}},[l]);const ue=async(s=0,c=!1)=>{try{c?N(!0):E(!0);const f=await J.getTMTicketsPaginated(r.id,{page:s,limit:q,status:y!=="all"?y:null});v(c?f.tickets:B=>{const n=[...B,...f.tickets];return n.length>Z?n.slice(-Z):n}),k(s),p(f.hasMore),I(f.totalCount);const T=f.tickets.filter(B=>B.assigned_cor_id);if(T.length>0){const B={},n={};await Promise.all(T.map(async A=>{const ae=await J.isTicketEditable(A);ae.editable||(B[A.id]=ae);try{const u=await J.getTicketImportStatus(A.id,A.assigned_cor_id);u?.import_status==="failed"&&(n[A.id]=u)}catch{}})),la(A=>c?B:{...A,...B}),ut(A=>c?n:{...A,...n})}}catch{a("Error loading T&M tickets","error")}finally{N(!1),E(!1)}},ca=()=>{!S&&w&&ue(K+1,!1)};o.useEffect(()=>{r?.id&&(v([]),k(0),p(!0),ue(0,!0))},[y]);const Re=o.useCallback(async(s,c)=>{if(Q[s]){a(Q[s].reason||"This ticket is locked (COR approved)","error");return}try{await J.updateTMTicketStatus(s,c),v(f=>f.map(T=>T.id===s?{...T,status:c}:T)),a(`Ticket ${c}`,"success")}catch(f){console.error("Error updating status:",f),a("Error updating status","error")}},[Q]),da=o.useCallback(s=>{if(Q[s.id]){a(Q[s.id].reason||"This ticket is locked (COR approved)","error");return}Re(s.id,"approved")},[Q,Re]),ua=async()=>{if(ge)try{const s=parseFloat(Oe)||0;await J.approveTMTicket(ge.id,null,null,s),v(i.map(c=>c.id===ge.id?{...c,status:"approved",change_order_value:s}:c)),a(`Ticket approved with $${s.toLocaleString()} change order`,"success"),De(!1),aa(null),nt("")}catch(s){console.error("Error approving ticket:",s),a("Error approving ticket","error")}},ma=o.useCallback(async s=>{if(Q[s]){a(Q[s].reason||"This ticket is locked (COR approved)","error");return}if(confirm("Delete this T&M ticket?"))try{await J.deleteTMTicket(s),v(c=>c.filter(f=>f.id!==s)),a("Ticket deleted","success")}catch(c){console.error("Error deleting ticket:",c),a("Error deleting ticket","error")}},[Q]),ha=o.useCallback(async s=>{ot(s),Me(s.assigned_cor_id||""),fe(!0),dt(!0);try{const c=await J.getAssignableCORs(r.id);na(c||[])}catch(c){console.error("Error loading CORs:",c),a("Error loading change orders","error")}finally{dt(!1)}},[r.id]),pa=async()=>{if(te)try{if(be){await J.assignTicketToCOR(te.id,be);const s=Se.find(c=>c.id===be);a(`Ticket linked to ${s?.cor_number||"COR"}`,"success")}else te.assigned_cor_id&&(await J.unassignTicketFromCOR(te.id,te.assigned_cor_id),a("Ticket unlinked from COR","success"));ue(),fe(!1),ot(null),Me("")}catch(s){console.error("Error updating COR association:",s),a("Error updating COR link","error")}},xa=o.useCallback(async(s,c)=>{if(c?.stopPropagation(),!!s.assigned_cor_id){mt(s.id);try{await J.importTicketDataToCOR(s.id,s.assigned_cor_id,t.id,r.work_type||"demolition",r.job_type||"standard"),a("COR data import successful!","success"),ut(f=>{const T={...f};return delete T[s.id],T}),ue()}catch(f){console.error("Error retrying import:",f),a("Import retry failed. Please try again.","error")}finally{mt(null)}}},[t.id,r.work_type,r.job_type]),ye=s=>{let c=0;return s.t_and_m_items&&s.t_and_m_items.forEach(f=>{f.materials_equipment?.cost_per_unit&&(c+=f.quantity*f.materials_equipment.cost_per_unit)}),c},je=s=>s.t_and_m_workers?s.t_and_m_workers.reduce((c,f)=>{const T=parseFloat(f.hours)||0,B=parseFloat(f.overtime_hours)||0;return c+T+B},0):0,ke=s=>new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),ga=o.useCallback((s,c)=>{c?.stopPropagation(),$(f=>{const T=new Set(f);return T.has(s)?T.delete(s):T.add(s),T})},[]),va=o.useCallback(s=>{M(c=>c===s?null:s)},[]),fa=o.useCallback(s=>{it(s),lt(!0)},[]),ht=()=>{const s=y==="all"?i:i.filter(f=>f.status===y),c=s.every(f=>D.has(f.id));$(c?new Set:new Set(s.map(f=>f.id)))},pt=()=>{$(new Set)},xt=()=>{const s=y==="all"?i:i.filter(c=>c.status===y);return D.size>0?s.filter(c=>D.has(c.id)):s},ba=async()=>{const s=xt();if(s.length===0){a("No tickets to export","error");return}a("Preparing Excel export...","info");const c=(await Rt()).default||await Rt(),f=[],T=[],B=[];s.forEach(u=>{const g=ke(u.work_date),L=u.status;u.t_and_m_workers&&u.t_and_m_workers.forEach(U=>{const le=parseFloat(U.hours)||0,ie=parseFloat(U.overtime_hours)||0;f.push({Date:g,Status:L,"Worker Name":U.name,Role:U.role||"Laborer","Regular Hours":le,"OT Hours":ie,"Total Hours":le+ie})}),u.t_and_m_items&&u.t_and_m_items.forEach(U=>{const le=U.custom_name||U.materials_equipment?.name||"Unknown",ie=U.custom_category||U.materials_equipment?.category||"Unknown",ze=U.materials_equipment?.unit||"each",Te=U.materials_equipment?.cost_per_unit||0,$e=U.quantity*Te;T.push({Date:g,Status:L,Category:ie,Item:le,Quantity:U.quantity,Unit:ze,"Cost/Unit":Te,Total:$e})}),B.push({Date:g,Status:L,Workers:u.t_and_m_workers?.length||0,"Total Hours":je(u),Items:u.t_and_m_items?.length||0,"Materials Cost":ye(u),Notes:u.notes||""})});const n=c.utils.book_new(),A=c.utils.json_to_sheet(B);if(c.utils.book_append_sheet(n,A,"Summary"),f.length>0){const u=c.utils.json_to_sheet(f);c.utils.book_append_sheet(n,u,"Workers")}if(T.length>0){const u=c.utils.json_to_sheet(T);c.utils.book_append_sheet(n,u,"Materials & Equipment")}const ae=`${r.name}_TM_${new Date().toISOString().split("T")[0]}.xlsx`;c.writeFile(n,ae),a("Export downloaded!","success")},ya=async()=>{const s=xt();if(s.length===0){a("No tickets to export","error");return}a("Generating PDF...","info");const[c,f]=await mr(),T=c.default,B=f.default,n=new T,A=n.internal.pageSize.getWidth(),ae=n.internal.pageSize.getHeight(),u=20;let g=u;const L=Pt(h?.primary_color||"#3B82F6"),U=Pt(h?.secondary_color||"#1E40AF");n.setFillColor(...L),n.rect(0,0,A,45,"F"),n.setFillColor(...U),n.rect(0,42,A,3,"F");let le=u;if(h?.logo_url)try{const b=await gs(h.logo_url);b&&(n.addImage(b,"PNG",u,7,30,30),le=u+30+10)}catch(b){console.error("Error adding logo:",b)}n.setTextColor(255,255,255),n.setFontSize(22),n.setFont("helvetica","bold"),n.text(t?.name||"Company Name",le,20),n.setFontSize(10),n.setFont("helvetica","normal"),n.text("TIME & MATERIALS REPORT",le,30),n.setFontSize(9),n.text(`Report Date: ${new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}`,A-u,18,{align:"right"}),r.job_number&&n.text(`Job #: ${r.job_number}`,A-u,26,{align:"right"}),n.text(`Status: ${y.charAt(0).toUpperCase()+y.slice(1)}`,A-u,34,{align:"right"}),g=55,n.setFillColor(248,250,252),n.rect(u,g-5,A-u*2,30,"F"),n.setDrawColor(...L),n.setLineWidth(.5),n.rect(u,g-5,A-u*2,30,"S"),n.setTextColor(...L),n.setFontSize(14),n.setFont("helvetica","bold"),n.text(`Project: ${r.name}`,u+5,g+7),n.setFontSize(10),n.setFont("helvetica","normal"),n.setTextColor(51,65,85);const ie=s.map(b=>new Date(b.work_date)).sort((b,j)=>b-j),ze=ie[0]?.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),Te=ie[ie.length-1]?.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});n.text(`Date Range: ${ze} - ${Te}`,u+5,g+17),n.text(`Total Tickets: ${s.length}`,A-u-5,g+7,{align:"right"}),g+=40;const $e=s.reduce((b,j)=>b+je(j),0),ft=s.reduce((b,j)=>b+ye(j),0),Sa=new Set(s.flatMap(b=>b.t_and_m_workers?.map(j=>j.name)||[])).size;n.setTextColor(...L),n.setFontSize(12),n.setFont("helvetica","bold"),n.text("SUMMARY",u,g),g+=8;const _e=(A-u*2-20)/3,ka=[{label:"Total Labor Hours",value:$e.toFixed(1)},{label:"Unique Workers",value:Sa.toString()},{label:"Materials Cost",value:`$${ft.toFixed(2)}`}],Ta=L.map(b=>Math.min(255,b+180));ka.forEach((b,j)=>{const z=u+j*(_e+10);n.setFillColor(...Ta),n.rect(z,g,_e,25,"F"),n.setDrawColor(...L),n.setLineWidth(.5),n.rect(z,g,_e,25,"S"),n.setTextColor(...L),n.setFontSize(16),n.setFont("helvetica","bold"),n.text(b.value,z+_e/2,g+12,{align:"center"}),n.setTextColor(100,116,139),n.setFontSize(8),n.setFont("helvetica","normal"),n.text(b.label,z+_e/2,g+20,{align:"center"})}),g+=35;const He=[],We=[],qe=[];let Be=0,Ve=0,Ue=0,Ge=0,Ke=0,Ye=0;s.forEach(b=>{b.t_and_m_workers&&b.t_and_m_workers.forEach(j=>{const z=parseFloat(j.hours)||0,V=parseFloat(j.overtime_hours)||0,ce=j.role||"Laborer",re=[ke(b.work_date),j.name,z.toString(),V>0?V.toString():"-",(z+V).toString()];ce==="Foreman"||ce==="Superintendent"?(He.push(re),Be+=z,Ve+=V):ce==="Operator"?(We.push(re),Ue+=z,Ge+=V):(qe.push(re),Ke+=z,Ye+=V)})});const Xe=(b,j,z,V)=>{j.length!==0&&(g>ae-80&&(n.addPage(),g=u),n.setTextColor(...L),n.setFontSize(11),n.setFont("helvetica","bold"),n.text(b,u,g),g+=5,B(n,{startY:g,head:[["Date","Name","Reg Hrs","OT Hrs","Total"]],body:j,margin:{left:u,right:u},headStyles:{fillColor:L,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:9,textColor:[51,65,85]},alternateRowStyles:{fillColor:[248,250,252]},columnStyles:{0:{cellWidth:30},2:{halign:"center",cellWidth:22},3:{halign:"center",cellWidth:22},4:{halign:"center",cellWidth:22}},foot:[["","SUBTOTAL:",z.toString(),V>0?V.toString():"-",(z+V).toString()]],footStyles:{fillColor:U,textColor:[255,255,255],fontStyle:"bold",fontSize:9}}),g=n.lastAutoTable.finalY+10)};if(He.length>0||We.length>0||qe.length>0){n.setTextColor(...L),n.setFontSize(12),n.setFont("helvetica","bold"),n.text("LABOR",u,g),g+=8,Xe("SUPERVISION",He,Be,Ve),Xe("OPERATORS",We,Ue,Ge),Xe("LABORERS",qe,Ke,Ye);const b=Be+Ue+Ke,j=Ve+Ge+Ye;n.setFillColor(...L),n.rect(u,g,A-u*2,12,"F"),n.setTextColor(255,255,255),n.setFontSize(10),n.setFont("helvetica","bold"),n.text("LABOR TOTAL:",u+5,g+8),n.text(`${b} Reg + ${j} OT = ${b+j} Hours`,A-u-5,g+8,{align:"right"}),g+=20}g>ae-100&&(n.addPage(),g=u);const oe={},Ae={},bt=["Containment","PPE","Disposal","Equipment","Other"];s.forEach(b=>{b.t_and_m_items&&b.t_and_m_items.forEach(j=>{const z=j.custom_name||j.materials_equipment?.name||"Unknown",V=j.custom_category||j.materials_equipment?.category||"Other",ce=j.materials_equipment?.unit||"each",re=j.materials_equipment?.cost_per_unit||0,Ne=j.quantity*re;oe[V]||(oe[V]=[],Ae[V]=0),oe[V].push([ke(b.work_date),z,j.quantity.toString(),ce,`$${re.toFixed(2)}`,`$${Ne.toFixed(2)}`]),Ae[V]+=Ne})});const yt=(b,j,z)=>{!j||j.length===0||(g>ae-80&&(n.addPage(),g=u),n.setTextColor(...L),n.setFontSize(11),n.setFont("helvetica","bold"),n.text(b.toUpperCase(),u,g),g+=5,B(n,{startY:g,head:[["Date","Item","Qty","Unit","Rate","Total"]],body:j,margin:{left:u,right:u},headStyles:{fillColor:L,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:9,textColor:[51,65,85]},alternateRowStyles:{fillColor:[248,250,252]},columnStyles:{2:{halign:"center",cellWidth:20},3:{halign:"center",cellWidth:25},4:{halign:"right",cellWidth:25},5:{halign:"right",cellWidth:30}},foot:[["","","","","Subtotal:",`$${z.toFixed(2)}`]],footStyles:{fillColor:U,textColor:[255,255,255],fontStyle:"bold",fontSize:9}}),g=n.lastAutoTable.finalY+10)};Object.keys(oe).length>0&&(n.setTextColor(...L),n.setFontSize(12),n.setFont("helvetica","bold"),n.text("MATERIALS & EQUIPMENT",u,g),g+=8,bt.forEach(b=>{oe[b]&&yt(b,oe[b],Ae[b])}),Object.keys(oe).forEach(b=>{bt.includes(b)||yt(b,oe[b],Ae[b])}),n.setFillColor(...L),n.rect(u,g,A-u*2,12,"F"),n.setTextColor(255,255,255),n.setFontSize(10),n.setFont("helvetica","bold"),n.text("MATERIALS TOTAL:",u+5,g+8),n.text(`$${ft.toFixed(2)}`,A-u-5,g+8,{align:"right"}),g+=20),g>ae-80&&(n.addPage(),g=u),g+=10,n.setDrawColor(...L),n.setLineWidth(1),n.line(u,g,A-u,g),g+=15,n.setTextColor(...L),n.setFontSize(12),n.setFont("helvetica","bold"),n.text("AUTHORIZATION",u,g),g+=10,n.setFontSize(10),n.setFont("helvetica","normal"),n.setTextColor(71,85,105),n.text("I hereby authorize the above time and materials charges as accurate and approved for billing.",u,g),g+=20;const se=s[0]||{},jt=(b,j,z,V,ce,re,Ne)=>{n.setFont("helvetica","bold"),n.setFontSize(8),n.setTextColor(...L),n.text(j,u,b),n.setFont("helvetica","normal"),n.setFontSize(9),n.setTextColor(100,116,139);const X=b+18;if(n.setDrawColor(...U),n.setLineWidth(.5),n.line(u,X,u+70,X),n.text("Signature",u,X+8),n.line(u+85,X,u+145,X),n.text("Title / Company",u+85,X+8),n.line(A-u-40,X,A-u,X),n.text("Date",A-u-40,X+8),z)try{if(n.addImage(z,"PNG",u,X-16,60,16),V&&(n.setFontSize(8),n.text(V,u,X+15)),ce||re){const Ce=[ce,re].filter(Boolean).join(" - ");n.text(Ce,u+85,X-5)}if(Ne){const Ce=new Date(Ne).toLocaleDateString();n.text(Ce,A-u-40,X-5)}}catch(Ce){console.error("Error adding signature to PDF:",Ce)}return X+25};g=jt(g,"GC AUTHORIZATION",se.gc_signature_data,se.gc_signature_name,se.gc_signature_title,se.gc_signature_company,se.gc_signature_date),g+=8,g=jt(g,"CLIENT AUTHORIZATION",se.client_signature_data,se.client_signature_name,se.client_signature_title,se.client_signature_company,se.client_signature_date);const _t=n.internal.getNumberOfPages();for(let b=1;b<=_t;b++){n.setPage(b);const j=ae-15;n.setFontSize(8),n.setTextColor(148,163,184),n.text(`${t?.name||"Company"} - T&M Report - ${r.name}`,u,j),n.text(`Page ${b} of ${_t}`,A-u,j,{align:"right"})}const Aa=`${r.name}_TM_Report_${new Date().toISOString().split("T")[0]}.pdf`;n.save(Aa),a("PDF exported!","success")},ee=o.useMemo(()=>{let s=y==="all"?[...i]:i.filter(c=>c.status===y);if(H.start){const c=new Date(H.start);c.setHours(0,0,0,0),s=s.filter(f=>new Date(f.work_date)>=c)}if(H.end){const c=new Date(H.end);c.setHours(23,59,59,999),s=s.filter(f=>new Date(f.work_date)<=c)}if(m){const c=new Date,f=c.getMonth(),T=c.getFullYear();s=s.filter(B=>{const n=new Date(B.work_date);return n.getMonth()===f&&n.getFullYear()===T})}else if(R==="recent"){const c=new Date;c.setDate(c.getDate()-7),c.setHours(0,0,0,0),s=s.filter(f=>new Date(f.work_date)>=c)}return s},[i,y,R,H,m]),me=o.useMemo(()=>{if(R!=="all")return null;const s={};return ee.forEach(c=>{const f=new Date(c.work_date),T=`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}`,B=f.toLocaleDateString("en-US",{month:"long",year:"numeric"});s[T]||(s[T]={label:B,tickets:[],hours:0,cost:0}),s[T].tickets.push(c),s[T].hours+=je(c),s[T].cost+=ye(c)}),Object.entries(s).sort((c,f)=>f[0].localeCompare(c[0]))},[ee,R]);o.useEffect(()=>{if(me&&me.length>0){const s=me[0][0];Y(new Set([s]))}},[me]);const ja=s=>{const c=new Set(O);c.has(s)?c.delete(s):c.add(s),Y(c)},_a=ee.reduce((s,c)=>s+je(c),0),Na=ee.reduce((s,c)=>s+ye(c),0),gt=y==="all"?i.length:i.filter(s=>s.status===y).length;if(C)return e.jsx("div",{className:`tm-list ${l?"tm-list-compact":""}`,children:e.jsx("div",{className:"tm-loading-skeletons",children:[1,2,3].map(s=>e.jsx(Ds,{},s))})});const Ca=ee.length>0&&ee.every(s=>D.has(s.id)),Le=D.size>0,vt=s=>e.jsx(ur,{ticket:s,isExpanded:G===s.id,isSelected:D.has(s.id),isLocked:!!Q[s.id],lockInfo:Q[s.id],hasFailedImport:!!ia[s.id],isRetrying:oa===s.id,onToggleExpand:va,onToggleSelect:ga,onApprove:da,onUpdateStatus:Re,onDelete:ma,onOpenCorAssign:ha,onRetryImport:xa,onShowSignatureLink:fa,formatDate:ke,calculateTotalHours:je,calculateTicketTotal:ye},s.id);return e.jsxs("div",{className:`tm-list ${l?"tm-list-compact":""}`,children:[e.jsx("div",{className:"tm-list-header",children:e.jsxs("div",{className:"tm-list-title",children:[e.jsx("h3",{children:"T&M Tickets"}),e.jsxs("div",{className:"tm-header-controls",children:[!l&&e.jsxs("div",{className:"tm-display-toggle",children:[e.jsxs("button",{className:`tm-display-btn ${_==="dashboard"?"active":""}`,onClick:()=>P("dashboard"),title:"Dashboard View",children:[e.jsx(As,{size:16})," Dashboard"]}),e.jsxs("button",{className:`tm-display-btn ${_==="list"?"active":""}`,onClick:()=>P("list"),title:"List View",children:[e.jsx(Ps,{size:16})," List"]})]}),e.jsxs("div",{className:"tm-export-buttons",children:[!l&&Le&&e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:pt,children:["Clear (",D.size,")"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Os(i,r),disabled:i.length===0,children:[e.jsx(Ft,{size:14})," CSV"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:ba,disabled:i.length===0,children:[e.jsx(Ft,{size:14})," Excel ",!l&&Le?`(${D.size})`:""]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:ya,disabled:i.length===0,children:[e.jsx(rt,{size:14})," PDF ",!l&&Le?`(${D.size})`:""]})]})]})]})}),!l&&e.jsxs("div",{className:"tm-list-filters",children:[e.jsx("div",{className:"tm-filter-tabs",children:["all","pending","approved","billed","rejected"].map(s=>e.jsxs("button",{className:`tm-filter-tab ${y===s?"active":""}`,onClick:()=>{F(s),pt()},children:[s.charAt(0).toUpperCase()+s.slice(1),e.jsx("span",{className:"tm-filter-count",children:s==="all"?i.length:i.filter(c=>c.status===s).length})]},s))}),e.jsxs("div",{className:"view-mode-bar",children:[e.jsxs("div",{className:"view-mode-tabs",children:[e.jsx("button",{className:`view-mode-tab ${R==="recent"?"active":""}`,onClick:()=>{x("recent"),ne({start:"",end:""})},children:"Recent (7 days)"}),e.jsxs("button",{className:`view-mode-tab ${R==="all"?"active":""}`,onClick:()=>x("all"),children:["All (",gt,")"]})]}),R==="all"&&e.jsxs("div",{className:"date-filter",children:[e.jsx(Es,{size:16}),e.jsx("input",{type:"date",value:H.start,onChange:s=>ne(c=>({...c,start:s.target.value})),placeholder:"Start date"}),e.jsx("span",{children:"to"}),e.jsx("input",{type:"date",value:H.end,onChange:s=>ne(c=>({...c,end:s.target.value})),placeholder:"End date"}),(H.start||H.end)&&e.jsx("button",{className:"btn btn-ghost btn-small",onClick:()=>ne({start:"",end:""}),children:"Clear"})]})]})]}),!l&&_==="dashboard"&&e.jsx(dr,{tickets:i}),_==="list"&&e.jsxs(e.Fragment,{children:[!l&&ee.length>0&&e.jsxs("div",{className:"tm-summary-bar",children:[e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Tickets"}),e.jsx("span",{className:"tm-summary-value",children:ee.length})]}),e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Total Hours"}),e.jsx("span",{className:"tm-summary-value",children:_a.toFixed(1)})]}),e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Materials Cost"}),e.jsxs("span",{className:"tm-summary-value",children:["$",Na.toFixed(2)]})]})]}),ee.length===0?e.jsxs("div",{className:"tm-empty-state",children:[e.jsxs("p",{children:["No ",y==="all"?"":y," T&M tickets",R==="recent"?" in the last 7 days":""]}),R==="recent"&&gt>0&&e.jsx("button",{className:"btn btn-secondary btn-small",onClick:()=>x("all"),children:"View All Tickets"})]}):e.jsxs("div",{className:"tm-tickets stagger-children",children:[e.jsx("div",{className:"tm-select-all-row",children:e.jsxs("label",{className:"tm-checkbox-label",onClick:ht,children:[e.jsx("input",{type:"checkbox",checked:Ca,onChange:ht,className:"tm-checkbox"}),e.jsxs("span",{children:["Select All (",ee.length,")"]})]})}),R==="all"&&me?me.map(([s,c])=>e.jsxs("div",{className:"month-group animate-fade-in",children:[e.jsxs("div",{className:"month-header",onClick:()=>ja(s),children:[e.jsxs("div",{className:"month-header-left",children:[O.has(s)?e.jsx(Is,{size:18}):e.jsx(Dt,{size:18}),e.jsx("span",{className:"month-label",children:c.label}),e.jsx(Ut,{count:c.tickets.length,label:"tickets",size:"small"})]}),e.jsxs("div",{className:"month-header-right",children:[e.jsxs("span",{className:"month-stat",children:[c.hours.toFixed(1)," hrs"]}),e.jsxs("span",{className:"month-stat",children:["$",c.cost.toFixed(2)]})]})]}),O.has(s)&&e.jsx("div",{className:"month-tickets stagger-children",children:c.tickets.map(f=>vt(f))})]},s)):ee.map(s=>vt(s))]}),!m&&w&&!C&&i.length>0&&e.jsx("div",{className:"tm-load-more",children:e.jsx("button",{className:"btn btn-secondary",onClick:ca,disabled:S,children:S?"Loading...":`Load More (${i.length} of ${W})`})}),m&&i.length>0&&e.jsxs("button",{className:"tm-see-all-btn",onClick:d,children:["See all ",W||i.length," T&M tickets",e.jsx(Dt,{size:16})]})]}),Fe&&ge&&e.jsx("div",{className:"modal-overlay",onClick:()=>De(!1),children:e.jsxs("div",{className:"modal change-order-modal",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{children:"Approve Change Order Work"}),e.jsxs("p",{className:"modal-subtitle",children:["This T&M ticket is associated with ",e.jsx("strong",{children:ge.ce_pco_number})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Change Order Value ($)"}),e.jsx("input",{type:"number",value:Oe,onChange:s=>nt(s.target.value),placeholder:"Enter the change order amount",autoFocus:!0}),e.jsx("p",{className:"form-help",children:"This amount will be added to the project's total contract value."})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>De(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-success",onClick:ua,children:["Approve with $",parseFloat(Oe||0).toLocaleString()]})]})]})}),sa&&ve&&e.jsx(Fs,{documentType:"tm_ticket",documentId:ve.id,companyId:t?.id,projectId:r?.id,documentTitle:`T&M Ticket - ${new Date(ve.work_date).toLocaleDateString()}${ve.ce_pco_number?` (${ve.ce_pco_number})`:""}`,onClose:()=>{lt(!1),it(null)},onShowToast:a}),ra&&te&&e.jsx("div",{className:"modal-overlay",onClick:()=>fe(!1),children:e.jsxs("div",{className:"modal cor-assign-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Link Ticket to Change Order"}),e.jsx("button",{className:"close-btn",onClick:()=>fe(!1),children:e.jsx(ws,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{className:"modal-subtitle",children:["Ticket: ",e.jsx("strong",{children:new Date(te.work_date).toLocaleDateString()}),te.ce_pco_number&&` (${te.ce_pco_number})`]}),ct?e.jsx("div",{className:"loading",children:"Loading change orders..."}):Se.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No change orders found for this project."}),e.jsx("p",{className:"text-muted",children:"Create a COR first, then link tickets to it."})]}):e.jsxs("div",{className:"cor-select-wrapper",children:[e.jsx("label",{children:"Select Change Order:"}),e.jsxs("select",{value:be,onChange:s=>Me(s.target.value),className:"cor-select",children:[e.jsx("option",{value:"",children:"-- No COR (unlink) --"}),Se.map(s=>e.jsxs("option",{value:s.id,children:[s.cor_number," - ",s.title||"Untitled"," (",s.status,")"]},s.id))]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>fe(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:pa,disabled:ct||Se.length===0,children:te.assigned_cor_id&&!be?"Unlink from COR":"Link to COR"})]})]})})]})}export{_r as default};
//# sourceMappingURL=TMList-BXyChvPR.js.map
