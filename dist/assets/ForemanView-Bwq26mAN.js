import{c as Se,r as c,j as e,B as ra,d as H,H as pe,T as Ss,i as ia,a as na}from"./index-a-YrXzcF.js";import{C as la,L as De,S as oa,a as ca,R as da,P as es,b as ma,c as ua,M as ys,d as ha,I as pa,e as xa,f as ja,g as ga,h as Cs}from"./InjuryReportForm-p7wShmBe.js";import{R as ns,F as qe,C as ss,a as as,c as ks,b as va,T as ls}from"./imageUtils-uDO2iS_R.js";import{X as Es,P as Na,C as ie,a as Te}from"./x-xJB3tAdu.js";import{U as fa,a as ba}from"./user-RaKmC-40.js";import{W as ya,P as ts}from"./wrench-DmgFLHOp.js";import{C as Ca}from"./chevron-down-CtW6OEE-.js";import"./react-DXGY7bZi.js";import"./pdf-ChZ1zkDw.js";import"./supabase-VuevzHjS.js";const ka=[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]],wa=Se("building",ka);const Sa=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],rs=Se("circle-check",Sa);const Ea=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],Ha=Se("globe",Ea);const _a=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],La=Se("history",_a);const Fa=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Da=Se("upload",Fa);const za=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],os=Se("zap",za);function Ra({ticketId:m,ticketSummary:C,lang:b="en",onSave:F,onClose:A,onShowToast:v}){const x=c.useRef(null),[k,_]=c.useState(""),[G,R]=c.useState(""),[S,q]=c.useState(""),[T,V]=c.useState(!1),[$,D]=c.useState(!1),[w,P]=c.useState(!1),Y={en:{title:"Client Signature",subtitle:"Sign to verify the work performed",signerName:"Your Name",signerNamePlaceholder:"Full name",signerTitle:"Title",signerTitlePlaceholder:"e.g. Project Manager",signerCompany:"Company",signerCompanyPlaceholder:"Company name",signBelow:"Sign below",signHere:"Sign here",clear:"Clear",cancel:"Cancel",saveSignature:"Submit Signature",saving:"Saving...",workDate:"Work Date",workers:"Workers",hours:"Total Hours",certification:"By signing, I acknowledge that the work described in this T&M ticket was performed as documented.",nameRequired:"Please enter your name",signatureRequired:"Please sign above",signatureSaved:"Signature saved successfully",signatureError:"Error saving signature"},es:{title:"Firma del Cliente",subtitle:"Firme para verificar el trabajo realizado",signerName:"Su Nombre",signerNamePlaceholder:"Nombre completo",signerTitle:"Titulo",signerTitlePlaceholder:"ej. Gerente de Proyecto",signerCompany:"Empresa",signerCompanyPlaceholder:"Nombre de la empresa",signBelow:"Firme abajo",signHere:"Firme aqui",clear:"Borrar",cancel:"Cancelar",saveSignature:"Enviar Firma",saving:"Guardando...",workDate:"Fecha",workers:"Trabajadores",hours:"Horas Total",certification:"Al firmar, reconozco que el trabajo descrito en este ticket T&M fue realizado como se documenta.",nameRequired:"Por favor ingrese su nombre",signatureRequired:"Por favor firme arriba",signatureSaved:"Firma guardada exitosamente",signatureError:"Error al guardar la firma"}},E=Y[b]||Y.en,Z=()=>{const o=x.current;return o?o.getContext("2d"):null},I=o=>{const u=x.current;if(!u)return{x:0,y:0};const y=u.getBoundingClientRect(),N=u.width/y.width,W=u.height/y.height,O=o.touches?o.touches[0].clientX:o.clientX,re=o.touches?o.touches[0].clientY:o.clientY;return{x:(O-y.left)*N,y:(re-y.top)*W}},ne=o=>{o.preventDefault();const u=Z();if(!u)return;const{x:y,y:N}=I(o);u.beginPath(),u.moveTo(y,N),D(!0),V(!0)},Q=o=>{if(!$)return;o.preventDefault();const u=Z();if(!u)return;const{x:y,y:N}=I(o);u.lineTo(y,N),u.stroke()},K=()=>{D(!1)},te=()=>{const o=x.current,u=Z();!o||!u||(u.clearRect(0,0,o.width,o.height),V(!1))},B=o=>{if(!o)return;x.current=o;const u=o.getContext("2d");u.strokeStyle="#1e293b",u.lineWidth=2,u.lineCap="round",u.lineJoin="round"},n=async()=>{if(!k.trim()){v?.(E.nameRequired,"error");return}if(!T){v?.(E.signatureRequired,"error");return}const o=x.current;if(o){P(!0);try{const u=o.toDataURL("image/png");await H.saveTMClientSignature(m,{signature:u,signerName:k.trim(),signerTitle:G.trim()||null,signerCompany:S.trim()||null,signedAt:new Date().toISOString()}),v?.(E.signatureSaved,"success"),F?.({signerName:k.trim(),signerTitle:G.trim(),signerCompany:S.trim()})}catch(u){console.error("Error saving signature:",u),v?.(E.signatureError,"error")}finally{P(!1)}}};return e.jsx("div",{className:"tm-modal-overlay",onClick:A,children:e.jsxs("div",{className:"tm-client-signature-modal",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"tm-sig-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:E.title}),e.jsx("p",{className:"tm-sig-subtitle",children:E.subtitle})]}),e.jsx("button",{className:"tm-sig-close",onClick:A,children:e.jsx(Es,{size:20})})]}),e.jsxs("div",{className:"tm-sig-body",children:[C&&e.jsxs("div",{className:"tm-sig-summary",children:[e.jsxs("div",{className:"tm-sig-summary-item",children:[e.jsx("span",{className:"tm-sig-summary-label",children:E.workDate}),e.jsx("span",{className:"tm-sig-summary-value",children:new Date(C.workDate).toLocaleDateString()})]}),e.jsxs("div",{className:"tm-sig-summary-item",children:[e.jsx("span",{className:"tm-sig-summary-label",children:E.workers}),e.jsx("span",{className:"tm-sig-summary-value",children:C.workerCount})]}),e.jsxs("div",{className:"tm-sig-summary-item",children:[e.jsx("span",{className:"tm-sig-summary-label",children:E.hours}),e.jsx("span",{className:"tm-sig-summary-value",children:C.totalHours})]})]}),e.jsxs("div",{className:"tm-sig-fields",children:[e.jsxs("div",{className:"tm-sig-field",children:[e.jsxs("label",{children:[e.jsx(fa,{size:14}),E.signerName," *"]}),e.jsx("input",{type:"text",value:k,onChange:o=>_(o.target.value),placeholder:E.signerNamePlaceholder})]}),e.jsxs("div",{className:"tm-sig-field-row",children:[e.jsxs("div",{className:"tm-sig-field",children:[e.jsxs("label",{children:[e.jsx(ra,{size:14}),E.signerTitle]}),e.jsx("input",{type:"text",value:G,onChange:o=>R(o.target.value),placeholder:E.signerTitlePlaceholder})]}),e.jsxs("div",{className:"tm-sig-field",children:[e.jsxs("label",{children:[e.jsx(wa,{size:14}),E.signerCompany]}),e.jsx("input",{type:"text",value:S,onChange:o=>q(o.target.value),placeholder:E.signerCompanyPlaceholder})]})]})]}),e.jsxs("div",{className:"tm-sig-area",children:[e.jsxs("div",{className:"tm-sig-label",children:[e.jsx(Na,{size:14}),e.jsx("span",{children:E.signBelow})]}),e.jsxs("div",{className:"tm-sig-canvas-container",children:[e.jsx("canvas",{ref:B,width:500,height:180,className:"tm-sig-canvas",onMouseDown:ne,onMouseMove:Q,onMouseUp:K,onMouseLeave:K,onTouchStart:ne,onTouchMove:Q,onTouchEnd:K}),!T&&e.jsx("div",{className:"tm-sig-placeholder",children:E.signHere})]}),e.jsxs("button",{className:"tm-sig-clear",onClick:te,disabled:!T,children:[e.jsx(ns,{size:14})," ",E.clear]})]}),e.jsx("p",{className:"tm-sig-certification",children:E.certification})]}),e.jsxs("div",{className:"tm-sig-footer",children:[e.jsx("button",{className:"tm-sig-btn secondary",onClick:A,disabled:w,children:E.cancel}),e.jsx("button",{className:"tm-sig-btn primary",onClick:n,disabled:!T||!k.trim()||w,children:w?E.saving:e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:16})," ",E.saveSignature]})})]})]})})}const ws=()=>{const m=new Uint8Array(6);return crypto.getRandomValues(m),Array.from(m,C=>C.toString(36)).join("")},is=["Containment","PPE","Disposal","Equipment"],Aa={en:{workInfo:"Work Details",crewHours:"Crew & Hours",materialsEquipment:"Materials",evidence:"Evidence",review:"Review",quickActions:"Quick Actions",sameAsYesterday:"Same as Yesterday",setCrewHours:"Set Crew Hours",loading:"Loading...",supervision:"Supervision",operators:"Operators",laborers:"Laborers",addSupervision:"+ Add Supervision",addOperator:"+ Add Operator",addLaborer:"+ Add Laborer",foreman:"Foreman",superintendent:"Superintendent",firstLastName:"First & Last Name",start:"Start",end:"End",regHrs:"Reg Hrs",otHrs:"OT Hrs",selectCategory:"Select a category:",addCustomItem:"+ Add Custom Item",customItem:"Custom Item",itemName:"Item Name",category:"Category",quantity:"Quantity",addItem:"Add Item",cancel:"Cancel",noItemsCategory:"No items in this category yet",workDate:"Work Date",ceNumber:"CE/PCO #",optional:"optional",linkedCOR:"Link to Change Order",selectCOR:"Select COR (optional)",noCORs:"No pending CORs",laborSummary:"Labor Summary",worker:"worker",workers_plural:"workers",totalHours:"Total Hours",regular:"Regular",overtime:"Overtime",materials:"Materials",item:"item",items_plural:"items",noMaterials:"No materials added",notes:"Notes",addNotes:"Add notes about the work performed...",photos:"Photos",addPhotos:"Add Photos",maxPhotos:"max",noPhotos:"No photos added",certification:"Certification",certifyStatement:"I certify that this T&M ticket accurately reflects the work performed.",foremanSignature:"Foreman's Name (Signature)",yourName:"Your name",describeWork:"Describe the work performed",descriptionRequired:"Description is required",whatWorkPerformed:"What work was performed today?",searchMaterials:"Search materials & equipment...",noSearchResults:"No items found",orBrowse:"Or browse by category:",back:"Back",next:"Next",nextCrew:"Next: Crew",nextMaterials:"Next: Materials",reviewItems:"Review",skipNoMaterials:"Skip (no materials)",submitTM:"Submit T&M",submitting:"Submitting...",applySameHours:"Apply Same Hours",batchDescription:"Set start/end time and hours for all workers with names entered.",timeStarted:"Time Started",timeEnded:"Time Ended",regularHours:"Regular Hours",overtimeHours:"Overtime Hours",willApplyTo:"Will apply to",applyToAll:"Apply to All",preset8hr:"8hr Day",preset10hr:"10hr Day",preset4hr:"4hr Day",loadedWorkers:"Loaded {count} workers from {date}",noPreviousCrew:"No previous crew found for this project",appliedHours:"Applied hours to {count} worker(s)",assignedToCOR:"Assigned to COR"},es:{workInfo:"Info del Trabajo",crewHours:"Cuadrilla y Horas",materialsEquipment:"Materiales",evidence:"Evidencia",review:"Revisar",quickActions:"Acciones Rapidas",sameAsYesterday:"Igual que Ayer",setCrewHours:"Poner Horas",loading:"Cargando...",supervision:"Supervision",operators:"Operadores",laborers:"Trabajadores",addSupervision:"+ Agregar Supervision",addOperator:"+ Agregar Operador",addLaborer:"+ Agregar Trabajador",foreman:"Capataz",superintendent:"Superintendente",firstLastName:"Nombre y Apellido",start:"Inicio",end:"Fin",regHrs:"Hrs Reg",otHrs:"Hrs Extra",selectCategory:"Seleccione una categoria:",addCustomItem:"+ Agregar Articulo",customItem:"Articulo Personalizado",itemName:"Nombre del Articulo",category:"Categoria",quantity:"Cantidad",addItem:"Agregar",cancel:"Cancelar",noItemsCategory:"No hay articulos en esta categoria",workDate:"Fecha de Trabajo",ceNumber:"CE/PCO #",optional:"opcional",linkedCOR:"Vincular a Orden de Cambio",selectCOR:"Seleccionar COR (opcional)",noCORs:"No hay CORs pendientes",laborSummary:"Resumen de Mano de Obra",worker:"trabajador",workers_plural:"trabajadores",totalHours:"Horas Totales",regular:"Regular",overtime:"Extra",materials:"Materiales",item:"articulo",items_plural:"articulos",noMaterials:"No se agregaron materiales",notes:"Notas",addNotes:"Agregar notas sobre el trabajo realizado...",photos:"Fotos",addPhotos:"Agregar Fotos",maxPhotos:"max",noPhotos:"No se agregaron fotos",certification:"Certificacion",certifyStatement:"Certifico que este ticket T&M refleja con precision el trabajo realizado.",foremanSignature:"Nombre del Capataz (Firma)",yourName:"Su nombre",describeWork:"Describir el trabajo realizado",descriptionRequired:"Descripcion es requerida",whatWorkPerformed:"Que trabajo se realizo hoy?",searchMaterials:"Buscar materiales y equipo...",noSearchResults:"No se encontraron articulos",orBrowse:"O navegar por categoria:",back:"Atras",next:"Siguiente",nextCrew:"Siguiente: Cuadrilla",nextMaterials:"Siguiente: Materiales",reviewItems:"Revisar",skipNoMaterials:"Saltar (sin materiales)",submitTM:"Enviar T&M",submitting:"Enviando...",applySameHours:"Aplicar Mismas Horas",batchDescription:"Establezca hora de inicio/fin y horas para todos los trabajadores.",timeStarted:"Hora de Inicio",timeEnded:"Hora de Fin",regularHours:"Horas Regulares",overtimeHours:"Horas Extra",willApplyTo:"Se aplicara a",applyToAll:"Aplicar a Todos",preset8hr:"Dia 8hr",preset10hr:"Dia 10hr",preset4hr:"Dia 4hr",loadedWorkers:"Se cargaron {count} trabajadores del {date}",noPreviousCrew:"No se encontro equipo anterior para este proyecto",appliedHours:"Horas aplicadas a {count} trabajador(es)",assignedToCOR:"Asignado a COR"}};function Ma({project:m,companyId:C,maxPhotos:b=10,onSubmit:F,onCancel:A,onShowToast:v}){const[x,k]=c.useState(1),[_,G]=c.useState(new Date().toISOString().split("T")[0]),[R,S]=c.useState(null),[q,T]=c.useState(!1),[V,$]=c.useState(!1),[D,w]=c.useState(!1),[P,Y]=c.useState(""),[E,Z]=c.useState(""),[I,ne]=c.useState(""),[Q,K]=c.useState([]),[te,B]=c.useState(!1),[n,o]=c.useState(!1),[u,y]=c.useState({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),[N,W]=c.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}]),[O,re]=c.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[h,M]=c.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[g,ee]=c.useState([]),[se,Ee]=c.useState(""),[z,Ie]=c.useState([]),[We,cs]=c.useState(!1),[Hs,oe]=c.useState(""),[Ue,_s]=c.useState([]),[Be,Ls]=c.useState(!1),[ce,ze]=c.useState(null),[Fs,Ds]=c.useState([]),[zs,ds]=c.useState(!1),[Re,Ge]=c.useState(""),[Ye,Ae]=c.useState([]),[ms,Rs]=c.useState([]),[He,Me]=c.useState(!1),[X,Oe]=c.useState({name:"",category:"",quantity:""}),Qe=c.useRef(null),[us,hs]=c.useState(!1),[j,As]=c.useState("en"),l=s=>Aa[j][s]||s,[Ms,Os]=c.useState([]),[Pe,Ps]=c.useState([]),[de,je]=c.useState({}),[Ve,ps]=c.useState(!0),ae=Pe.length>0,ge=(s,a)=>{if(!s||!a)return null;const[t,r]=s.split(":").map(Number),[i,d]=a.split(":").map(Number);let p=i*60+d-(t*60+r);p<0&&(p+=1440);const f=p/60,U=Math.min(f,8),L=Math.max(0,f-8);return{hours:U.toFixed(1),overtimeHours:L>0?L.toFixed(1):""}},_e=s=>{const a=s.name.trim()!=="",t=parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0;return a?t?"complete":"incomplete":"empty"},Xe=s=>{let a,t,r,i;switch(s){case"full":a="07:00",t="15:30",r="8",i="";break;case"10hr":a="06:00",t="16:30",r="8",i="2";break;case"half":a="07:00",t="11:00",r="4",i="";break;default:return}y({timeStarted:a,timeEnded:t,hours:r,overtimeHours:i})};c.useEffect(()=>{$s(),xs()},[m.id]),c.useEffect(()=>{(async()=>{if(!C){ps(!1);return}try{const a=await H.getLaborClassesForField(C);if(Os(a.categories||[]),Ps(a.classes||[]),a.classes&&a.classes.length>0){const t={};a.classes.forEach(r=>{t[r.id]=[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}),je(t)}}catch(a){console.error("Error loading labor classes:",a)}finally{ps(!1)}})()},[C]);const xs=async()=>{B(!0);try{const s=await H.getAssignableCORs(m.id);K(s||[])}catch(s){console.error("Error loading assignable CORs:",s)}finally{B(!1)}},Ts=()=>{const{timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}=u;W(N.map(d=>d.name.trim()?{...d,timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}:d)),re(O.map(d=>d.name.trim()?{...d,timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}:d)),M(h.map(d=>d.name.trim()?{...d,timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}:d));const i=[...N.filter(d=>d.name.trim()),...O.filter(d=>d.name.trim()),...h.filter(d=>d.name.trim())].length;o(!1),y({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),v(`Applied hours to ${i} worker${i!==1?"s":""}`,"success")},Je=s=>{let a,t,r,i;switch(s){case"8hr":a="07:00",t="15:30",r="8",i="";break;case"10hr":a="06:00",t="16:30",r="8",i="2";break;case"4hr":a="07:00",t="11:00",r="4",i="";break;default:return}W(p=>p.map(f=>f.name.trim()?{...f,timeStarted:a,timeEnded:t,hours:r,overtimeHours:i}:f)),re(p=>p.map(f=>f.name.trim()?{...f,timeStarted:a,timeEnded:t,hours:r,overtimeHours:i}:f)),M(p=>p.map(f=>f.name.trim()?{...f,timeStarted:a,timeEnded:t,hours:r,overtimeHours:i}:f));const d=[...N.filter(p=>p.name.trim()),...O.filter(p=>p.name.trim()),...h.filter(p=>p.name.trim())].length;d>0?v(l("appliedHours").replace("{count}",d),"success"):v(j==="en"?"Add workers first":"Agregue trabajadores primero","info")},$s=async()=>{try{const s=await H.getCrewCheckin(m.id);s?.workers&&_s(s.workers)}catch(s){console.error("Error loading crew:",s)}};c.useEffect(()=>{ce&&C&&qs(ce)},[ce,C]),c.useEffect(()=>{x===3&&Qe.current&&!ce&&setTimeout(()=>{Qe.current?.focus()},100)},[x,ce]);const qs=async s=>{ds(!0);try{const a=await H.getMaterialsEquipmentByCategory(C,s);Ds(a)}catch(a){console.error("Error loading items:",a),v("Error loading items","error")}finally{ds(!1)}},Is=async()=>{if(!(ms.length>0))try{const s=[];for(const a of is){const t=await H.getMaterialsEquipmentByCategory(C,a);s.push(...t.map(r=>({...r,category:a})))}Rs(s)}catch(s){console.error("Error loading all materials:",s)}},Ws=s=>{if(Ge(s),!s.trim()){Ae([]);return}const a=s.toLowerCase(),t=ms.filter(r=>r.name.toLowerCase().includes(a)||r.category.toLowerCase().includes(a));Ae(t.slice(0,10))},Us=async()=>{hs(!0);try{const s=await H.getPreviousTicketCrew(m.id,_);if(!s||s.totalWorkers===0){v("No previous crew found for this project","info");return}s.supervision&&W(s.supervision),s.operators&&re(s.operators),s.laborers&&M(s.laborers);const a=new Date(s.workDate).toLocaleDateString();v(`Loaded ${s.totalWorkers} workers from ${a}`,"success")}catch(s){console.error("Error loading previous crew:",s),v("Error loading previous crew","error")}finally{hs(!1)}},Bs=()=>{W([...N,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},me=(s,a,t)=>{W(N.map((r,i)=>{if(i!==s)return r;const d={...r,[a]:t};if(a==="timeStarted"||a==="timeEnded"){const p=a==="timeStarted"?t:r.timeStarted,f=a==="timeEnded"?t:r.timeEnded,U=ge(p,f);U&&(d.hours=U.hours,d.overtimeHours=U.overtimeHours)}return d}))},Gs=s=>{N.length>1?W(N.filter((a,t)=>t!==s)):W([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},Ys=()=>{M([...h,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},ve=(s,a,t)=>{M(h.map((r,i)=>{if(i!==s)return r;const d={...r,[a]:t};if(a==="timeStarted"||a==="timeEnded"){const p=a==="timeStarted"?t:r.timeStarted,f=a==="timeEnded"?t:r.timeEnded,U=ge(p,f);U&&(d.hours=U.hours,d.overtimeHours=U.overtimeHours)}return d}))},Qs=s=>{h.length>1?M(h.filter((a,t)=>t!==s)):M([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Vs=()=>{re([...O,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Ne=(s,a,t)=>{re(O.map((r,i)=>{if(i!==s)return r;const d={...r,[a]:t};if(a==="timeStarted"||a==="timeEnded"){const p=a==="timeStarted"?t:r.timeStarted,f=a==="timeEnded"?t:r.timeEnded,U=ge(p,f);U&&(d.hours=U.hours,d.overtimeHours=U.overtimeHours)}return d}))},Xs=s=>{O.length>1?re(O.filter((a,t)=>t!==s)):re([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},js=s=>{je(a=>({...a,[s]:[...a[s]||[],{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))},le=(s,a,t,r)=>{je(i=>({...i,[s]:(i[s]||[]).map((d,p)=>{if(p!==a)return d;const f={...d,[t]:r};if(t==="timeStarted"||t==="timeEnded"){const U=t==="timeStarted"?r:d.timeStarted,L=t==="timeEnded"?r:d.timeEnded,J=ge(U,L);J&&(f.hours=J.hours,f.overtimeHours=J.overtimeHours)}return f})}))},gs=(s,a)=>{je(t=>{const r=t[s]||[];return r.length>1?{...t,[s]:r.filter((i,d)=>d!==a)}:{...t,[s]:[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}})},Ze=()=>{const s=[];return Object.entries(de).forEach(([a,t])=>{const r=Pe.find(i=>i.id===a);t.forEach(i=>{i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)&&s.push({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:r?.name||"Worker",labor_class_id:a})})}),s},Js=s=>{const a=g.findIndex(t=>t.material_equipment_id===s.id);a>=0?ee(g.map((t,r)=>r===a?{...t,quantity:t.quantity+1}:t)):ee([...g,{material_equipment_id:s.id,name:s.name,unit:s.unit,category:s.category,quantity:1,isCustom:!1}]),v(`Added ${s.name}`,"success")},Zs=()=>{if(!X.name||!X.category||!X.quantity){v("Fill in all fields","error");return}ee([...g,{material_equipment_id:null,custom_name:X.name,custom_category:X.category,name:X.name,category:X.category,quantity:parseFloat(X.quantity),unit:"each",isCustom:!0}]),Oe({name:"",category:"",quantity:""}),Me(!1),ze(null),v("Custom item added","success")},Ke=(s,a)=>{const t=parseFloat(a)||0;t<=0?Ks(s):ee(g.map((r,i)=>i===s?{...r,quantity:t}:r))},Ks=s=>{ee(g.filter((a,t)=>t!==s))},ea=s=>{const a=Array.from(s.target.files);if(a.length===0)return;const t=b===-1?1/0:b-z.length;if(t<=0){v(`Photo limit reached (${b} max)`,"error"),s.target.value="";return}const r=a.slice(0,t);r.length<a.length&&v(`Only ${r.length} photo(s) added (${b} max)`,"error");const i=10*1024*1024;r.forEach(d=>{if(!d.type.startsWith("image/")){v("Please select an image file","error");return}if(d.size>i){v(`Photo too large: ${d.name} (max 10MB)`,"error");return}const p=URL.createObjectURL(d),f=`photo-${Date.now()}-${ws()}`;Ie(U=>[...U,{id:`${Date.now()}-${ws()}`,tempId:f,file:d,previewUrl:p,name:d.name,status:"pending",attempts:0,error:null,uploadedUrl:null}])}),s.target.value=""},ue=(s,a)=>{Ie(t=>t.map(r=>r.id===s?{...r,...a}:r))},vs=async(s,a)=>{const t=z.find(r=>r.id===s);if(!(!t||t.status!=="failed")){ue(s,{status:"compressing",error:null});try{let r=t.file;try{r=await ks(t.file)}catch(d){console.warn("Compression failed, using original:",d)}ue(s,{status:"uploading"});const i=await H.uploadPhoto(C,m.id,a,r);ue(s,{status:"confirmed",uploadedUrl:i,attempts:t.attempts+1}),await H.updateTMTicketPhotos(a,[...z.filter(d=>d.uploadedUrl).map(d=>d.uploadedUrl),i]),v("Photo uploaded successfully","success")}catch(r){console.error("Retry failed:",r),ue(s,{status:"failed",error:r.message||"Upload failed",attempts:t.attempts+1}),v("Photo retry failed","error")}}},sa=s=>{const a=z.find(t=>t.id===s);a?.previewUrl&&URL.revokeObjectURL(a.previewUrl),Ie(z.filter(t=>t.id!==s))},Ns=()=>{if(x===1)return se.trim().length>0;if(x===2){if(ae)return Ze().length>0;{const s=N.some(r=>r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)),a=O.some(r=>r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)),t=h.some(r=>r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0));return s||a||t}}return!0},fs=(()=>{const s=[];return x===1&&(se.trim()||s.push(j==="en"?"Description recommended":"Descripción recomendada")),x===2&&xe>0&&s.push(j==="en"?`${xe} worker(s) have no hours entered`:`${xe} trabajador(es) sin horas`),x===5&&(E.trim()||s.push(j==="en"?"Name required to submit":"Nombre requerido")),s})(),fe=()=>{x<5&&k(x+1)},bs=()=>{ce?(ze(null),Me(!1)):He?Me(!1):x>1?k(x-1):A()},aa=async()=>{if(!E.trim()){v("Enter your name to submit","error");return}let s=[];if(ae){if(s=Ze(),s.length===0){v("Add at least one worker","error");return}}else{const a=N.filter(i=>i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)),t=O.filter(i=>i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)),r=h.filter(i=>i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0));if(a.length===0&&t.length===0&&r.length===0){v("Add at least one worker","error");return}s=[...a.map(i=>({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:i.role})),...t.map(i=>({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:"Operator"})),...r.map(i=>({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:"Laborer"}))]}cs(!0),oe("Creating ticket...");try{const a=await H.createTMTicket({project_id:m.id,work_date:_,ce_pco_number:P.trim()||null,assigned_cor_id:I||null,notes:se.trim()||null,photos:[],created_by_name:E.trim()});let t=[];const r=z.filter(i=>i.status==="pending");if(r.length>0){oe(`Compressing ${r.length} photo${r.length>1?"s":""}...`),r.forEach(L=>ue(L.id,{status:"compressing"}));const i=await Promise.all(r.map(async L=>{try{const J=await ks(L.file);return{...L,file:J}}catch(J){return console.warn(`Failed to compress photo ${L.name}, using original:`,J),L}}));oe(`Uploading ${r.length} photo${r.length>1?"s":""}...`),r.forEach(L=>ue(L.id,{status:"uploading"}));let d=0,p=0;const f=i.map(async L=>{try{const J=await H.uploadPhoto(C,m.id,a.id,L.file);return d++,oe(`Uploading ${d}/${r.length} photos...`),ue(L.id,{status:"confirmed",uploadedUrl:J,attempts:(L.attempts||0)+1}),{id:L.id,url:J}}catch(J){return console.error(`Photo ${L.name} upload failed:`,J),p++,ue(L.id,{status:"failed",error:J.message||"Upload failed",attempts:(L.attempts||0)+1}),{id:L.id,url:null,error:J.message}}});t=(await Promise.all(f)).filter(L=>L.url!==null).map(L=>L.url),p>0&&t.length>0?v(`${t.length}/${r.length} photos uploaded. ${p} failed - can retry later.`,"warning"):p>0&&t.length===0&&v(`All ${p} photos failed to upload - can retry after submission.`,"error")}if(t.length>0&&(oe("Saving photos..."),await H.updateTMTicketPhotos(a.id,t)),oe("Saving workers..."),await H.addTMWorkers(a.id,s),g.length>0&&(oe("Saving materials..."),await H.addTMItems(a.id,g.map(i=>({material_equipment_id:i.material_equipment_id,custom_name:i.custom_name||null,custom_category:i.custom_category||null,quantity:i.quantity})))),I){oe("Importing to COR...");try{await H.importTicketDataToCOR(a.id,I,C,m.work_type||"demolition",m.job_type||"standard")}catch(i){console.error("Error importing to COR:",i);try{await H.markImportFailed(a.id,I,i?.message||"Import failed")}catch(d){console.error("Error marking import failed:",d)}v("T&M saved. COR data sync failed - retry from ticket list.","warning")}}z.forEach(i=>{i.previewUrl&&URL.revokeObjectURL(i.previewUrl)}),S(a),v("T&M submitted!","success"),k(6)}catch(a){console.error("Error submitting T&M:",a),v("Error submitting T&M","error")}finally{cs(!1),oe("")}},be=N.filter(s=>s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),ye=O.filter(s=>s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),Ce=h.filter(s=>s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),Le=Ze(),ke=ae?Le.length:be.length+ye.length+Ce.length,we=ae?Le.reduce((s,a)=>s+(a.hours||0),0):[...be,...ye,...Ce].reduce((s,a)=>s+parseFloat(a.hours||0),0),he=ae?Le.reduce((s,a)=>s+(a.overtime_hours||0),0):[...be,...ye,...Ce].reduce((s,a)=>s+parseFloat(a.overtimeHours||0),0);g.reduce((s,a)=>s+a.quantity,0);const Fe=ae?Object.values(de).flat().filter(s=>s.name.trim()):[...N.filter(s=>s.name.trim()),...O.filter(s=>s.name.trim()),...h.filter(s=>s.name.trim())],ta=ke,xe=Fe.length-ta;return x===3&&(ce||He)?e.jsxs("div",{className:"tm-wizard",children:[e.jsxs("div",{className:"tm-wizard-header",children:[e.jsx("button",{className:"tm-back-btn",onClick:bs,children:"←"}),e.jsx("h2",{children:He?"Add Custom Item":ce}),e.jsxs("div",{className:"tm-item-count",children:[g.length," items"]})]}),He?e.jsxs("div",{className:"tm-custom-form",children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Item Name"}),e.jsx("input",{type:"text",placeholder:"What did you use?",value:X.name,onChange:s=>Oe({...X,name:s.target.value}),autoFocus:!0})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Category"}),e.jsx("div",{className:"tm-category-select",children:is.map(s=>e.jsx("button",{className:`tm-cat-chip ${X.category===s?"active":""}`,onClick:()=>Oe({...X,category:s}),children:s},s))})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Quantity"}),e.jsx("input",{type:"number",placeholder:"How many?",value:X.quantity,onChange:s=>Oe({...X,quantity:s.target.value})})]}),e.jsx("button",{className:"tm-big-btn primary",onClick:Zs,children:"Add Custom Item"})]}):e.jsx("div",{className:"tm-item-grid",children:zs?e.jsx("div",{className:"tm-loading",children:"Loading..."}):e.jsxs(e.Fragment,{children:[Fs.map(s=>{const a=g.find(t=>t.material_equipment_id===s.id);return e.jsxs("button",{className:`tm-item-card ${a?"added":""}`,onClick:()=>Js(s),children:[e.jsx("span",{className:"tm-item-name",children:s.name}),e.jsx("span",{className:"tm-item-unit",children:s.unit}),a&&e.jsx("span",{className:"tm-item-badge",children:a.quantity})]},s.id)}),e.jsxs("button",{className:"tm-item-card custom",onClick:()=>Me(!0),children:[e.jsx("span",{className:"tm-item-name",children:"+ Add Other"}),e.jsx("span",{className:"tm-item-unit",children:"Not on list"})]})]})}),!He&&g.length>0&&e.jsx("div",{className:"tm-wizard-footer",children:e.jsxs("button",{className:"tm-big-btn primary",onClick:()=>ze(null),children:["Done Adding (",g.length," items)"]})})]}):e.jsxs("div",{className:"tm-wizard",children:[e.jsxs("div",{className:"tm-wizard-header",children:[x<5?e.jsx("button",{className:"tm-back-btn",onClick:bs,children:"←"}):e.jsx("div",{className:"tm-success-check",children:e.jsx(rs,{size:24})}),e.jsxs("h2",{children:[x===1&&l("workInfo"),x===2&&l("crewHours"),x===3&&l("materialsEquipment"),x===4&&l("evidence"),x===5&&l("review"),x===6&&(j==="en"?"Submitted":"Enviado")]}),e.jsxs("div",{className:"tm-header-right",children:[x<5&&e.jsxs("button",{className:"tm-lang-toggle",onClick:()=>As(j==="en"?"es":"en"),title:j==="en"?"Cambiar a Español":"Switch to English",children:[e.jsx(Ha,{size:16}),j==="en"?"ES":"EN"]}),x<6&&e.jsxs("div",{className:"tm-step-dots",children:[e.jsx("span",{className:`tm-dot ${x>=1?"active":""}`}),e.jsx("span",{className:`tm-dot ${x>=2?"active":""}`}),e.jsx("span",{className:`tm-dot ${x>=3?"active":""}`}),e.jsx("span",{className:`tm-dot ${x>=4?"active":""}`}),e.jsx("span",{className:`tm-dot ${x>=5?"active":""}`})]})]})]}),x===1&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-project-info",children:[m.job_number&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Job #"}),e.jsx("span",{className:"tm-project-value",children:m.job_number})]}),e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Project"}),e.jsx("span",{className:"tm-project-value",children:m.name})]}),m.address&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Address"}),e.jsx("span",{className:"tm-project-value",children:m.address})]}),m.general_contractor&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"GC"}),e.jsx("span",{className:"tm-project-value",children:m.general_contractor})]})]}),e.jsxs("div",{className:"tm-field-row",children:[e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:_,onChange:s=>G(s.target.value),className:"tm-date"})]}),e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"CE / PCO #"}),e.jsx("input",{type:"text",placeholder:"Change Event / PCO",value:P,onChange:s=>Y(s.target.value),className:"tm-input"})]})]}),e.jsxs("div",{className:"tm-field tm-description-field",children:[e.jsxs("label",{children:[e.jsx(qe,{size:16,className:"inline-icon"}),l("describeWork")," ",e.jsx("span",{className:"tm-required",children:"*"})]}),e.jsx("textarea",{placeholder:l("whatWorkPerformed"),value:se,onChange:s=>Ee(s.target.value),rows:4,className:`tm-description ${se.trim()?"":"tm-field-required"}`})]})]}),x===2&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-crew-summary-pill",children:[e.jsxs("span",{className:"pill-stat",children:[Fe.length," ",Fe.length===1?l("worker"):l("workers_plural")]}),e.jsxs("span",{className:"pill-stat",children:[we+he,"h ","total"]}),xe>0&&e.jsxs("span",{className:"pill-warning",children:[e.jsx(Te,{size:14}),xe," ",j==="en"?"need hours":"sin horas"]})]}),Ue.length>0&&e.jsxs("div",{className:"tm-crew-picker",children:[e.jsxs("button",{className:"tm-crew-picker-btn",onClick:()=>Ls(!Be),children:[e.jsx(pe,{size:16})," ",Be?"Hide":"Select from"," Today's Crew (",Ue.length,")"]}),Be&&e.jsx("div",{className:"tm-crew-list",children:Ue.map((s,a)=>{const t=N.some(d=>d.name.toLowerCase()===s.name.toLowerCase())||O.some(d=>d.name.toLowerCase()===s.name.toLowerCase())||h.some(d=>d.name.toLowerCase()===s.name.toLowerCase()),r=Object.values(de).some(d=>d.some(p=>p.name.toLowerCase()===s.name.toLowerCase())),i=t||r;return e.jsxs("button",{className:`tm-crew-item ${i?"added":""}`,onClick:()=>{if(!i){if(s.labor_class_id&&ae&&de[s.labor_class_id]){const d=de[s.labor_class_id]||[],p=d.findIndex(f=>!f.name.trim());if(p>=0){const f=[...d];f[p]={...f[p],name:s.name},je({...de,[s.labor_class_id]:f})}else je({...de,[s.labor_class_id]:[...d,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]})}else{const d=(s.role||"").toLowerCase();if(d.includes("foreman")||d.includes("supervisor")||d.includes("superintendent")){const p=N.findIndex(f=>!f.name.trim());p>=0?(me(p,"name",s.name),me(p,"role",d.includes("superintendent")?"Superintendent":"Foreman")):W([...N,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:d.includes("superintendent")?"Superintendent":"Foreman"}])}else if(d.includes("operator")){const p=O.findIndex(f=>!f.name.trim());p>=0?Ne(p,"name",s.name):re([...O,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}else{const p=h.findIndex(f=>!f.name.trim());p>=0?ve(p,"name",s.name):M([...h,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}}v(`Added ${s.name}`,"success")}},disabled:i,children:[e.jsx("span",{className:"tm-crew-item-name",children:s.name}),e.jsx("span",{className:`tm-crew-item-role ${(s.role||"laborer").toLowerCase()}`,children:s.role||"Laborer"}),i&&e.jsx("span",{className:"tm-crew-item-check",children:"✓"})]},a)})})]}),e.jsxs("div",{className:"tm-quick-actions-panel",children:[e.jsxs("div",{className:"tm-batch-hours-header",children:[e.jsx(os,{size:18}),e.jsx("span",{children:l("quickActions")})]}),e.jsxs("div",{className:"tm-quick-actions-buttons",children:[e.jsxs("button",{type:"button",className:"tm-quick-action-btn primary",onClick:Us,disabled:us,children:[e.jsx(la,{size:16}),l(us?"loading":"sameAsYesterday")]}),e.jsxs("button",{type:"button",className:"tm-quick-action-btn",onClick:()=>o(!0),children:[e.jsx(ss,{size:16}),l("setCrewHours")]})]})]}),e.jsxs("div",{className:"tm-inline-presets",children:[e.jsx("span",{className:"tm-inline-presets-label",children:j==="en"?"Apply to all:":"Aplicar a todos:"}),e.jsxs("div",{className:"tm-inline-presets-buttons",children:[e.jsx("button",{type:"button",className:"tm-preset-chip",onClick:()=>Je("8hr"),children:l("preset8hr")}),e.jsx("button",{type:"button",className:"tm-preset-chip",onClick:()=>Je("10hr"),children:l("preset10hr")}),e.jsx("button",{type:"button",className:"tm-preset-chip",onClick:()=>Je("4hr"),children:l("preset4hr")})]})]}),e.jsxs("div",{className:`tm-running-total ${ke>0?"has-data":""}`,children:[e.jsxs("div",{className:"tm-running-total-workers",children:[e.jsx(pe,{size:18}),e.jsx("span",{className:"tm-running-total-count",children:Fe.length}),e.jsx("span",{className:"tm-running-total-label",children:Fe.length===1?l("worker"):l("workers_plural")}),xe>0&&e.jsxs("span",{className:"tm-running-total-warning",children:["(",xe," ",j==="en"?"need hours":"sin horas",")"]})]}),e.jsxs("div",{className:"tm-running-total-hours",children:[e.jsx(ss,{size:18}),e.jsx("span",{className:"tm-running-total-count",children:we+he}),e.jsx("span",{className:"tm-running-total-label",children:j==="en"?"total hrs":"hrs total"}),he>0&&e.jsxs("span",{className:"tm-running-total-ot",children:["(",he," OT)"]})]})]}),ae&&!Ve&&e.jsxs(e.Fragment,{children:[Ms.map(s=>{const a=Pe.filter(t=>t.category_id===s.id);return a.length===0?null:e.jsxs("div",{className:"tm-labor-category-section",children:[e.jsx("div",{className:"tm-category-header",children:s.name}),a.map(t=>e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:t.name}),e.jsx("div",{className:"tm-workers-list",children:(de[t.id]||[]).map((r,i)=>{const d=_e(r);return e.jsxs("div",{className:`tm-worker-card-expanded ${d!=="empty"?`worker-${d}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[d==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:l("firstLastName"),value:r.name,onChange:p=>le(t.id,i,"name",p.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>gs(t.id,i),children:"×"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("start")}),e.jsx("input",{type:"time",value:r.timeStarted,onChange:p=>le(t.id,i,"timeStarted",p.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("end")}),e.jsx("input",{type:"time",value:r.timeEnded,onChange:p=>le(t.id,i,"timeEnded",p.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:r.hours,onChange:p=>le(t.id,i,"hours",p.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:r.overtimeHours,onChange:p=>le(t.id,i,"overtimeHours",p.target.value)})]})]})]},i)})}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>js(t.id),children:["+ ",j==="en"?"Add":"Agregar"," ",t.name]})]},t.id))]},s.id)}),Pe.filter(s=>!s.category_id).map(s=>e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:s.name}),e.jsx("div",{className:"tm-workers-list",children:(de[s.id]||[]).map((a,t)=>{const r=_e(a);return e.jsxs("div",{className:`tm-worker-card-expanded ${r!=="empty"?`worker-${r}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[r==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:l("firstLastName"),value:a.name,onChange:i=>le(s.id,t,"name",i.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>gs(s.id,t),children:"×"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("start")}),e.jsx("input",{type:"time",value:a.timeStarted,onChange:i=>le(s.id,t,"timeStarted",i.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("end")}),e.jsx("input",{type:"time",value:a.timeEnded,onChange:i=>le(s.id,t,"timeEnded",i.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:a.hours,onChange:i=>le(s.id,t,"hours",i.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:a.overtimeHours,onChange:i=>le(s.id,t,"overtimeHours",i.target.value)})]})]})]},t)})}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>js(s.id),children:["+ ",j==="en"?"Add":"Agregar"," ",s.name]})]},s.id))]}),Ve&&e.jsxs("div",{className:"tm-loading-labor-classes",children:[e.jsx(De,{size:20,className:"tm-spinner"}),e.jsx("span",{children:j==="en"?"Loading labor classes...":"Cargando clases de trabajo..."})]}),!ae&&!Ve&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:l("supervision")}),e.jsx("div",{className:"tm-workers-list",children:N.map((s,a)=>{const t=_e(s);return e.jsxs("div",{className:`tm-worker-card-expanded ${t!=="empty"?`worker-${t}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[t==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("div",{className:"tm-role-select",children:e.jsxs("select",{value:s.role,onChange:r=>me(a,"role",r.target.value),children:[e.jsx("option",{value:"Foreman",children:l("foreman")}),e.jsx("option",{value:"Superintendent",children:l("superintendent")})]})}),e.jsx("input",{type:"text",placeholder:l("firstLastName"),value:s.name,onChange:r=>me(a,"name",r.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>Gs(a),children:"×"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("start")}),e.jsx("input",{type:"time",value:s.timeStarted,onChange:r=>me(a,"timeStarted",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("end")}),e.jsx("input",{type:"time",value:s.timeEnded,onChange:r=>me(a,"timeEnded",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.hours,onChange:r=>me(a,"hours",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.overtimeHours,onChange:r=>me(a,"overtimeHours",r.target.value)})]})]})]},a)})}),e.jsx("button",{className:"tm-add-btn",onClick:Bs,children:l("addSupervision")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:l("operators")}),e.jsx("div",{className:"tm-workers-list",children:O.map((s,a)=>{const t=_e(s);return e.jsxs("div",{className:`tm-worker-card-expanded ${t!=="empty"?`worker-${t}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[t==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:l("firstLastName"),value:s.name,onChange:r=>Ne(a,"name",r.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>Xs(a),children:"×"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("start")}),e.jsx("input",{type:"time",value:s.timeStarted,onChange:r=>Ne(a,"timeStarted",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("end")}),e.jsx("input",{type:"time",value:s.timeEnded,onChange:r=>Ne(a,"timeEnded",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.hours,onChange:r=>Ne(a,"hours",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.overtimeHours,onChange:r=>Ne(a,"overtimeHours",r.target.value)})]})]})]},a)})}),e.jsx("button",{className:"tm-add-btn",onClick:Vs,children:l("addOperator")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:l("laborers")}),e.jsx("div",{className:"tm-workers-list",children:h.map((s,a)=>{const t=_e(s);return e.jsxs("div",{className:`tm-worker-card-expanded ${t!=="empty"?`worker-${t}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[t==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:l("firstLastName"),value:s.name,onChange:r=>ve(a,"name",r.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>Qs(a),children:"×"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("start")}),e.jsx("input",{type:"time",value:s.timeStarted,onChange:r=>ve(a,"timeStarted",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("end")}),e.jsx("input",{type:"time",value:s.timeEnded,onChange:r=>ve(a,"timeEnded",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.hours,onChange:r=>ve(a,"hours",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:l("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.overtimeHours,onChange:r=>ve(a,"overtimeHours",r.target.value)})]})]})]},a)})}),e.jsx("button",{className:"tm-add-btn",onClick:Ys,children:l("addLaborer")})]})]})]}),x===3&&!ce&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-field tm-search-field",children:[e.jsxs("div",{className:"tm-search-input-wrapper",children:[e.jsx(oa,{size:18,className:"tm-search-icon"}),e.jsx("input",{ref:Qe,type:"text",placeholder:l("searchMaterials"),value:Re,onChange:s=>Ws(s.target.value),onFocus:()=>Is(),className:"tm-search-input"}),Re&&e.jsx("button",{className:"tm-search-clear",onClick:()=>{Ge(""),Ae([])},children:"×"})]}),Re&&Ye.length>0&&e.jsx("div",{className:"tm-search-results",children:Ye.map((s,a)=>{const t=g.find(r=>r.id===s.id);return e.jsxs("button",{className:`tm-search-result-item ${t?"added":""}`,onClick:()=>{t?Ke(g.indexOf(t),t.quantity+1):ee([...g,{...s,quantity:1,isCustom:!1}]),Ge(""),Ae([])},children:[e.jsx("span",{className:"tm-search-result-name",children:s.name}),e.jsx("span",{className:"tm-search-result-category",children:s.category}),t&&e.jsxs("span",{className:"tm-search-result-qty",children:["×",t.quantity]})]},a)})}),Re&&Ye.length===0&&e.jsx("div",{className:"tm-search-no-results",children:l("noSearchResults")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:l("orBrowse")}),e.jsx("div",{className:"tm-category-grid",children:is.map(s=>{const a=g.filter(t=>t.category===s);return e.jsxs("button",{className:"tm-category-card",onClick:()=>ze(s),children:[e.jsx("span",{className:"tm-cat-name",children:s}),a.length>0&&e.jsx("span",{className:"tm-cat-count",children:a.length})]},s)})})]}),g.length>0&&e.jsxs("div",{className:"tm-field",children:[e.jsxs("label",{children:["Added Items (",g.length,")"]}),e.jsx("div",{className:"tm-added-list",children:g.map((s,a)=>e.jsxs("div",{className:"tm-added-item",children:[e.jsxs("div",{className:"tm-added-info",children:[s.isCustom&&e.jsx("span",{className:"tm-custom-badge",children:"Custom"}),e.jsx("span",{className:"tm-added-name",children:s.name})]}),e.jsxs("div",{className:"tm-added-qty",children:[e.jsx("button",{onClick:()=>Ke(a,s.quantity-1),children:"−"}),e.jsx("span",{children:s.quantity}),e.jsx("button",{onClick:()=>Ke(a,s.quantity+1),children:"+"})]})]},a))})]})]}),x===4&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-evidence-section",children:[e.jsxs("h3",{children:[e.jsx(as,{size:18})," ",l("photos")]}),z.length>0&&e.jsx("div",{className:"tm-photo-grid",children:z.map(s=>e.jsxs("div",{className:`tm-photo-item ${s.status?`photo-${s.status}`:""}`,children:[e.jsx("img",{src:s.previewUrl,alt:s.name}),s.status==="compressing"&&e.jsxs("div",{className:"tm-photo-status compressing",children:[e.jsx(De,{size:20,className:"tm-spinner"}),e.jsx("span",{children:j==="en"?"Compressing":"Comprimiendo"})]}),s.status==="uploading"&&e.jsxs("div",{className:"tm-photo-status uploading",children:[e.jsx(De,{size:20,className:"tm-spinner"}),e.jsx("span",{children:j==="en"?"Uploading":"Subiendo"})]}),s.status==="confirmed"&&e.jsx("div",{className:"tm-photo-status confirmed",children:e.jsx(ie,{size:20})}),s.status==="failed"&&e.jsxs("div",{className:"tm-photo-status failed",title:s.error||"Upload failed",children:[e.jsx(Te,{size:20}),e.jsx("span",{children:j==="en"?"Failed":"Error"})]}),(!s.status||s.status==="pending"||s.status==="failed")&&e.jsx("button",{className:"tm-photo-remove",onClick:()=>sa(s.id),children:"×"})]},s.id))}),(b===-1||z.length<b)&&e.jsxs("label",{className:"tm-photo-btn",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:ea,style:{display:"none"}}),e.jsx(as,{size:16,className:"inline-icon"})," ",z.length>0?j==="en"?"Add More Photos":"Más Fotos":l("addPhotos")]}),b!==-1&&e.jsxs("p",{className:"tm-photo-hint",children:[z.length,"/",b," ",l("maxPhotos")]})]}),e.jsxs("div",{className:"tm-evidence-section",children:[e.jsxs("h3",{children:[e.jsx(ca,{size:18})," ",l("linkedCOR")]}),e.jsxs("div",{className:"tm-cor-row",children:[e.jsxs("select",{value:I,onChange:s=>ne(s.target.value),className:"tm-input tm-select",children:[e.jsxs("option",{value:"",children:["-- ",j==="en"?"No COR":"Sin COR"," --"]}),Q.map(s=>e.jsxs("option",{value:s.id,children:[s.cor_number,": ",s.title||"Untitled"," (",s.status,")"]},s.id))]}),e.jsx("button",{type:"button",className:"tm-refresh-btn",onClick:xs,disabled:te,title:j==="en"?"Refresh COR list":"Actualizar lista",children:e.jsx(da,{size:16,className:te?"spinning":""})})]}),Q.length===0&&!te&&e.jsx("p",{className:"tm-cor-hint",children:l("noCORs")})]})]}),x===5&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:["📅 ",l("workDate")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(1),children:j==="en"?"Edit":"Editar"})]}),e.jsxs("div",{className:"tm-review-row",children:[e.jsx("span",{children:new Date(_).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}),P&&e.jsxs("span",{children:["CE/PCO: ",P]})]})]}),se&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(qe,{size:16,className:"inline-icon"})," ",l("notes")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(1),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-notes",children:se})]}),z.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(as,{size:16,className:"inline-icon"})," ",l("photos")," (",z.length,")"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(4),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-photos",children:z.map(s=>e.jsx("img",{src:s.previewUrl,alt:s.name},s.id))})]}),I&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:["🔗 ",l("linkedCOR")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(4),children:j==="en"?"Edit":"Editar"})]}),e.jsxs("div",{className:"tm-review-cor",children:[Q.find(s=>s.id===I)?.cor_number,": ",Q.find(s=>s.id===I)?.title||"Untitled"]})]}),ae&&Le.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(pe,{size:16,className:"inline-icon"})," ",j==="en"?"Workers":"Trabajadores"," (",we+he," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(2),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:Le.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:s.role})," ",s.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.time_started&&s.time_ended&&e.jsxs("span",{className:"tm-review-time",children:[s.time_started," - ",s.time_ended]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",s.overtime_hours>0?` + ${s.overtime_hours} OT`:""]})]})]},a))})]}),!ae&&be.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ba,{size:16,className:"inline-icon"})," Supervision (",be.reduce((s,a)=>s+parseFloat(a.hours||0)+parseFloat(a.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(2),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:be.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:s.role})," ",s.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.timeStarted&&s.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[s.timeStarted," - ",s.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",parseFloat(s.overtimeHours)>0?` + ${s.overtimeHours} OT`:""]})]})]},a))})]}),!ae&&ye.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:["🚜 Operators (",ye.reduce((s,a)=>s+parseFloat(a.hours||0)+parseFloat(a.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(2),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:ye.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:s.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.timeStarted&&s.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[s.timeStarted," - ",s.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",parseFloat(s.overtimeHours)>0?` + ${s.overtimeHours} OT`:""]})]})]},a))})]}),!ae&&Ce.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(pe,{size:16,className:"inline-icon"})," Laborers (",Ce.reduce((s,a)=>s+parseFloat(a.hours||0)+parseFloat(a.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(2),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:Ce.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:s.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.timeStarted&&s.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[s.timeStarted," - ",s.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",parseFloat(s.overtimeHours)>0?` + ${s.overtimeHours} OT`:""]})]})]},a))})]}),g.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ya,{size:16,className:"inline-icon"})," Materials & Equipment (",g.length," items)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>k(3),children:j==="en"?"Edit":"Editar"})]}),e.jsx("div",{className:"tm-review-list",children:g.map((s,a)=>e.jsxs("div",{className:"tm-review-row",children:[e.jsxs("span",{children:[s.isCustom&&e.jsxs(e.Fragment,{children:[e.jsx(os,{size:14,className:"inline-icon"})," "]}),s.name]}),e.jsxs("span",{children:[s.quantity," ",s.unit]})]},a))})]}),e.jsxs("div",{className:"tm-review-section tm-certification",children:[e.jsx("div",{className:"tm-review-header",children:e.jsxs("span",{children:[e.jsx(es,{size:16,className:"inline-icon"})," Submitted By"]})}),e.jsx("input",{type:"text",className:"tm-certification-input",placeholder:"Enter your name",value:E,onChange:s=>Z(s.target.value)}),e.jsx("p",{className:"tm-certification-note",children:"By submitting, you certify this T&M is accurate."})]})]}),x===6&&R&&e.jsxs("div",{className:"tm-step-content tm-success-step",children:[e.jsxs("div",{className:"tm-success-header",children:[e.jsx("div",{className:"tm-success-icon",children:e.jsx(rs,{size:48})}),e.jsx("h2",{children:j==="en"?"T&M Ticket Submitted!":"¡Ticket T&M Enviado!"}),e.jsx("p",{className:"tm-success-subtitle",children:j==="en"?"Your ticket has been saved and is ready for client signature.":"Su ticket ha sido guardado y está listo para la firma del cliente."})]}),e.jsxs("div",{className:"tm-success-summary",children:[e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:ke}),e.jsx("span",{className:"tm-success-stat-label",children:j==="en"?"Workers":"Trabajadores"})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:we+he}),e.jsx("span",{className:"tm-success-stat-label",children:j==="en"?"Total Hours":"Horas Total"})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:new Date(_).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),e.jsx("span",{className:"tm-success-stat-label",children:j==="en"?"Work Date":"Fecha"})]})]}),z.some(s=>s.status==="failed")&&e.jsxs("div",{className:"tm-failed-photos-section",children:[e.jsxs("div",{className:"tm-failed-photos-header",children:[e.jsx(Te,{size:18}),e.jsx("span",{children:j==="en"?`${z.filter(s=>s.status==="failed").length} photo(s) failed to upload`:`${z.filter(s=>s.status==="failed").length} foto(s) no se subieron`})]}),e.jsx("div",{className:"tm-failed-photos-grid",children:z.filter(s=>s.status==="failed").map(s=>e.jsxs("div",{className:"tm-failed-photo-item",children:[e.jsx("img",{src:s.previewUrl,alt:s.name}),e.jsx("div",{className:"tm-failed-photo-overlay",children:e.jsx("button",{className:"tm-retry-photo-btn",onClick:()=>vs(s.id,R.id),disabled:s.status==="uploading"||s.status==="compressing",children:s.status==="uploading"||s.status==="compressing"?e.jsx(De,{size:16,className:"tm-spinner"}):e.jsxs(e.Fragment,{children:[e.jsx(ns,{size:16}),e.jsx("span",{children:j==="en"?"Retry":"Reintentar"})]})})}),s.error&&e.jsxs("div",{className:"tm-failed-photo-error",title:s.error,children:[s.error.substring(0,20),s.error.length>20?"...":""]})]},s.id))}),e.jsxs("button",{className:"tm-retry-all-btn",onClick:async()=>{const s=z.filter(a=>a.status==="failed");for(const a of s)await vs(a.id,R.id)},children:[e.jsx(ns,{size:16}),j==="en"?"Retry All Failed Photos":"Reintentar Todas las Fotos"]})]}),z.length>0&&z.every(s=>s.status==="confirmed")&&e.jsxs("div",{className:"tm-photos-success",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:j==="en"?`All ${z.length} photo(s) uploaded successfully`:`${z.length} foto(s) subidas exitosamente`})]}),e.jsxs("div",{className:"tm-signature-options",children:[e.jsx("h3",{children:j==="en"?"Get Client Signature":"Obtener Firma del Cliente"}),e.jsx("p",{className:"tm-signature-description",children:j==="en"?"Have the client sign this T&M ticket to verify the work performed.":"Haga que el cliente firme este ticket T&M para verificar el trabajo realizado."}),D?e.jsxs("div",{className:"tm-signed-confirmation",children:[e.jsx(rs,{size:32,className:"tm-signed-icon"}),e.jsx("span",{children:j==="en"?"Client signature collected!":"¡Firma del cliente recopilada!"})]}):e.jsxs("div",{className:"tm-signature-buttons",children:[e.jsxs("button",{className:"tm-signature-option-btn primary",onClick:()=>$(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(es,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:j==="en"?"Sign Now (On-Site)":"Firmar Ahora"}),e.jsx("span",{className:"tm-signature-option-desc",children:j==="en"?"Client signs on this device":"Cliente firma en este dispositivo"})]})]}),e.jsxs("button",{className:"tm-signature-option-btn",onClick:()=>T(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(ma,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:j==="en"?"Send Signature Link":"Enviar Enlace"}),e.jsx("span",{className:"tm-signature-option-desc",children:j==="en"?"Client signs later via link":"Cliente firma después vía enlace"})]})]})]})]})]}),q&&R&&e.jsx(ua,{documentType:"tm_ticket",documentId:R.id,companyId:C,projectId:m.id,documentTitle:`T&M - ${new Date(_).toLocaleDateString()}`,onClose:()=>T(!1),onShowToast:v}),V&&R&&e.jsx(Ra,{ticketId:R.id,ticketSummary:{workDate:_,workerCount:ke,totalHours:we+he},lang:j,onSave:()=>{$(!1),w(!0)},onClose:()=>$(!1),onShowToast:v}),x<6&&e.jsxs("div",{className:"tm-wizard-footer",children:[fs.length>0&&e.jsxs("div",{className:"tm-validation-summary",children:[e.jsx(Te,{size:16}),e.jsx("span",{children:fs[0]})]}),x===1&&e.jsx("button",{className:"tm-big-btn primary",onClick:fe,disabled:!Ns(),children:l("nextCrew")}),x===2&&e.jsx(e.Fragment,{children:e.jsxs("button",{className:"tm-big-btn primary",onClick:fe,disabled:!Ns(),children:[l("nextMaterials")," (",ke," ",l(ke===1?"worker":"workers_plural"),", ",we+he," hrs)"]})}),x===3&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:fe,children:[j==="en"?"Next: Evidence":"Siguiente: Evidencia"," (",g.length," ",g.length===1?l("item"):l("items_plural"),")"]}),e.jsx("button",{className:"tm-skip-btn",onClick:fe,children:l("skipNoMaterials")})]}),x===4&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:fe,children:[l("reviewItems")," (",z.length," ",j==="en"?"photos":"fotos",")"]}),e.jsx("button",{className:"tm-skip-btn",onClick:fe,children:j==="en"?"Skip (no photos)":"Saltar (sin fotos)"})]}),x===5&&e.jsx("button",{className:`tm-big-btn submit ${We?"submitting":""} ${E.trim()?"ready":"needs-name"}`,onClick:aa,disabled:We||!E.trim(),children:We?e.jsxs(e.Fragment,{children:[e.jsx(De,{size:20,className:"tm-spinner"}),e.jsx("span",{className:"tm-submit-text",children:Hs||l("submitting")})]}):E.trim()?e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:20}),e.jsx("span",{children:l("submitTM")})]}):e.jsxs(e.Fragment,{children:[e.jsx(es,{size:18}),e.jsx("span",{children:j==="en"?"Enter name to submit":"Ingrese nombre"})]})})]}),x===6&&e.jsxs("div",{className:"tm-wizard-footer",children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:F,children:[e.jsx(ie,{size:20}),e.jsx("span",{children:j==="en"?"Done":"Listo"})]}),e.jsx("button",{className:"tm-skip-btn",onClick:F,children:j==="en"?"Skip signature for now":"Saltar firma por ahora"})]}),n&&e.jsx("div",{className:"tm-modal-overlay",onClick:()=>o(!1),children:e.jsxs("div",{className:"tm-batch-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("h3",{children:[e.jsx(ss,{size:18})," ",l("applySameHours")]}),e.jsx("p",{className:"tm-batch-description",children:l("batchDescription")}),e.jsxs("div",{className:"tm-time-presets",children:[e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>Xe("full"),children:l("preset8hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>Xe("10hr"),children:l("preset10hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>Xe("half"),children:l("preset4hr")})]}),e.jsxs("div",{className:"tm-batch-form",children:[e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:l("timeStarted")}),e.jsx("input",{type:"time",value:u.timeStarted,onChange:s=>{const a=s.target.value,t=ge(a,u.timeEnded);y({...u,timeStarted:a,...t||{}})}})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:l("timeEnded")}),e.jsx("input",{type:"time",value:u.timeEnded,onChange:s=>{const a=s.target.value,t=ge(u.timeStarted,a);y({...u,timeEnded:a,...t||{}})}})]})]}),e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:l("regularHours")}),e.jsx("input",{type:"number",placeholder:"8",value:u.hours,onChange:s=>y({...u,hours:s.target.value})})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:l("overtimeHours")}),e.jsx("input",{type:"number",placeholder:"0",value:u.overtimeHours,onChange:s=>y({...u,overtimeHours:s.target.value})})]})]})]}),e.jsxs("div",{className:"tm-batch-preview",children:[e.jsxs("strong",{children:[l("willApplyTo"),":"]}),e.jsxs("span",{children:[[...N.filter(s=>s.name.trim()),...O.filter(s=>s.name.trim()),...h.filter(s=>s.name.trim())].length," ",l("workers_plural")]})]}),e.jsxs("div",{className:"tm-batch-actions",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>o(!1),children:l("cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:Ts,disabled:!u.hours&&!u.overtimeHours,children:l("applyToAll")})]})]})})]})}function Oa({project:m,companyId:C,onShowToast:b}){const[F,A]=c.useState([]),[v,x]=c.useState(!0),[k,_]=c.useState(!1),[G,R]=c.useState(!1),[S,q]=c.useState({name:"",role:"",labor_class_id:null}),[T,V]=c.useState([]),[$,D]=c.useState([]),[w,P]=c.useState(!0),Y=["Foreman","Laborer","Supervisor","Operator"];c.useEffect(()=>{Z(),C?E():P(!1)},[m.id,C]);const E=async()=>{try{const n=await H.getLaborClassesForField(C);V(n.categories||[]),D(n.classes||[]),n.classes&&n.classes.length>0&&q(o=>({...o,role:n.classes[0].name,labor_class_id:n.classes[0].id}))}catch(n){console.error("Error loading labor classes:",n)}finally{P(!1)}},Z=async()=>{try{const n=await H.getCrewCheckin(m.id);n?.workers&&A(n.workers)}catch(n){console.error("Error loading crew:",n)}finally{x(!1)}},I=n=>{const o=$.find(u=>u.id===n);q(o?{...S,role:o.name,labor_class_id:o.id}:{...S,role:n,labor_class_id:null})},ne=async()=>{if(!S.name.trim()){b("Enter worker name","error");return}if(!S.role){b("Select a role","error");return}if(F.find(n=>n.name.toLowerCase()===S.name.trim().toLowerCase())){b("Worker already added","error");return}_(!0);try{const n=[...F,{name:S.name.trim(),role:S.role,labor_class_id:S.labor_class_id}];await H.saveCrewCheckin(m.id,n),A(n),q({...S,name:""}),R(!1),b("Crew member added","success")}catch(n){console.error("Error adding worker:",n),b("Error adding crew member","error")}finally{_(!1)}},Q=async n=>{_(!0);try{const o=F.filter(u=>u.name.toLowerCase()!==n.toLowerCase());await H.saveCrewCheckin(m.id,o),A(o),b("Crew member removed","success")}catch(o){console.error("Error removing worker:",o),b("Error removing crew member","error")}finally{_(!1)}},K=new Date().toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"}),te=()=>{const n={};T.forEach(u=>{n[u.id]={name:u.name,classes:$.filter(y=>y.category_id===u.id)}});const o=$.filter(u=>!u.category_id);return o.length>0&&(n.uncategorized={name:"Other",classes:o}),n},B=$.length>0;return v||w?e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(pe,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:K})]}),e.jsx("div",{className:"crew-loading",children:"Loading..."})]}):e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(pe,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:K})]}),F.length===0?e.jsxs("div",{className:"crew-empty",children:[e.jsx("p",{children:"No crew checked in yet"}),e.jsx("p",{className:"crew-empty-hint",children:"Add your crew for the day"})]}):e.jsx("div",{className:"crew-list",children:F.map(n=>e.jsxs("div",{className:"crew-member",children:[e.jsxs("div",{className:"crew-member-info",children:[e.jsx("span",{className:"crew-member-name",children:n.name}),e.jsx("span",{className:`crew-member-role ${(n.role||"laborer").toLowerCase().replace(/\s+/g,"-")}`,children:n.role})]}),e.jsx("button",{className:"crew-remove-btn",onClick:()=>Q(n.name),disabled:k,children:"×"})]},n.name))}),G?e.jsxs("div",{className:"crew-add-form",children:[e.jsx("input",{type:"text",value:S.name,onChange:n=>q({...S,name:n.target.value}),placeholder:"Name",autoFocus:!0}),e.jsx("select",{value:S.labor_class_id||S.role,onChange:n=>I(n.target.value),children:B?Object.entries(te()).map(([n,o])=>e.jsx("optgroup",{label:o.name,children:o.classes.map(u=>e.jsx("option",{value:u.id,children:u.name},u.id))},n)):Y.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsxs("div",{className:"crew-add-buttons",children:[e.jsx("button",{className:"crew-add-confirm",onClick:ne,disabled:k,children:k?"...":"Add"}),e.jsx("button",{className:"crew-add-cancel",onClick:()=>{R(!1),q({name:"",role:$[0]?.name||"Laborer",labor_class_id:$[0]?.id||null})},children:"Cancel"})]})]}):e.jsx("button",{className:"crew-add-btn",onClick:()=>R(!0),children:"+ Add Crew Member"}),e.jsxs("div",{className:"crew-count",children:[F.length," ",F.length===1?"person":"people"," on site"]})]})}function Pa({project:m,onShowToast:C,onClose:b}){const[F,A]=c.useState(!0),[v,x]=c.useState(!1),[k,_]=c.useState(null),[G,R]=c.useState(""),[S,q]=c.useState("");c.useEffect(()=>{T()},[m.id]);const T=async()=>{try{const w=await H.getDailyReport(m.id);if(w)_(w),R(w.field_notes||""),q(w.issues||"");else{const P=await H.compileDailyReport(m.id);_({...P,status:"draft"})}}catch(w){console.error("Error loading report:",w),C("Error loading report","error")}finally{A(!1)}},V=async()=>{if(!ia){C("Demo Mode: Report saved locally only - won't reach office","info"),b();return}x(!0);try{await H.saveDailyReport(m.id,{field_notes:G,issues:S}),await H.submitDailyReport(m.id,"Field")?(C("Daily report submitted!","success"),b()):C("Report not sent - check connection","error")}catch(w){console.error("Error submitting report:",w),C("Error submitting report","error")}finally{x(!1)}},$=new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"});if(F)return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:b,children:"←"}),e.jsx("h2",{children:"Daily Report"})]}),e.jsx("div",{className:"daily-report-loading",children:"Compiling report..."})]});const D=k?.status==="submitted";return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:b,children:"←"}),e.jsxs("div",{children:[e.jsx("h2",{children:"Daily Report"}),e.jsx("p",{className:"daily-report-date",children:$})]})]}),D&&e.jsxs("div",{className:"daily-report-submitted-banner",children:["✓ Submitted ",new Date(k.submitted_at).toLocaleTimeString()]}),e.jsxs("div",{className:"daily-report-content",children:[e.jsxs("div",{className:"daily-report-summary",children:[e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:k.crew_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Crew on Site"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:k.tasks_completed||0}),e.jsx("div",{className:"daily-report-card-label",children:"Tasks Done"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:k.tm_tickets_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"T&M Tickets"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:k.photos_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Photos"})]})]}),k.crew_list?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(pe,{size:18,className:"inline-icon"})," Crew"]}),e.jsx("div",{className:"daily-report-crew",children:k.crew_list.map((w,P)=>e.jsxs("div",{className:"daily-report-crew-item",children:[e.jsx("span",{children:w.name}),e.jsx("span",{className:"daily-report-crew-role",children:w.role})]},P))})]}),k.completed_tasks?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(va,{size:18,className:"inline-icon"})," Completed Today"]}),e.jsx("ul",{className:"daily-report-tasks",children:k.completed_tasks.map((w,P)=>e.jsxs("li",{children:[w.name,w.group&&e.jsx("span",{className:"daily-report-task-group",children:w.group})]},P))})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(qe,{size:18,className:"inline-icon"})," Notes"]}),e.jsx("textarea",{value:G,onChange:w=>R(w.target.value),placeholder:"Any notes about today's work...",rows:3,disabled:D})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(Ss,{size:18,className:"inline-icon"})," Issues / Concerns"]}),e.jsx("textarea",{value:S,onChange:w=>q(w.target.value),placeholder:"Any problems, delays, or concerns...",rows:3,disabled:D})]})]}),!D&&e.jsxs("div",{className:"daily-report-footer",children:[e.jsx("button",{className:"btn btn-primary daily-report-submit",onClick:V,disabled:v,children:v?"Submitting...":e.jsxs(e.Fragment,{children:[e.jsx(Da,{size:16,className:"inline-icon"})," Submit Report"]})}),e.jsx("p",{className:"daily-report-hint",children:"This will be sent to the office"})]})]})}const $e=[{value:"concrete",label:"Concrete",icon:"🧱"},{value:"trash",label:"Trash",icon:"🗑️"},{value:"metals",label:"Metals",icon:"🔩"},{value:"hazardous_waste",label:"Hazardous",icon:"☣️"}],Ta=m=>$e.find(C=>C.value===m)||{label:m,icon:"📦"};function $a({project:m,user:C=null,date:b,onShowToast:F}){const[A,v]=c.useState([]),[x,k]=c.useState([]),[_,G]=c.useState(!0),[R,S]=c.useState(!1),[q,T]=c.useState(!1),[V,$]=c.useState(!1),[D,w]=c.useState({type:"concrete",count:1}),P=new Date(b).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});c.useEffect(()=>{Y(),E()},[m.id,b]);const Y=async()=>{try{G(!0);const n=await H.getDisposalLoads(m.id,b);v(n||[])}catch(n){console.error("Error loading disposal loads:",n)}finally{G(!1)}},E=async()=>{try{const o=(await H.getDisposalLoadsHistory(m.id,14)||[]).filter(y=>y.load_date!==b).reduce((y,N)=>(y[N.load_date]||(y[N.load_date]=[]),y[N.load_date].push(N),y),{}),u=Object.entries(o).map(([y,N])=>({date:y,loads:N,totalLoads:N.reduce((W,O)=>W+O.load_count,0)})).sort((y,N)=>new Date(N.date)-new Date(y.date));k(u)}catch(n){console.error("Error loading disposal history:",n)}},Z=async()=>{if(!(D.count<1)){S(!0);try{await H.addDisposalLoad(m.id,C?.id||null,b,D.type,D.count),await Y(),w({type:"concrete",count:1}),T(!1),F?.("Disposal load added","success")}catch(n){console.error("Error adding disposal load:",n),F?.("Error adding load","error")}finally{S(!1)}}},I=async n=>{S(!0);try{await H.deleteDisposalLoad(n),await Y(),F?.("Load removed","success")}catch(o){console.error("Error deleting disposal load:",o),F?.("Error removing load","error")}finally{S(!1)}},ne=async n=>{S(!0);try{await H.addDisposalLoad(m.id,C?.id||null,b,n,1),await Y(),F?.("Load added","success")}catch(o){console.error("Error adding disposal load:",o),F?.("Error adding load","error")}finally{S(!1)}},Q=async n=>{S(!0);try{await H.updateDisposalLoad(n.id,n.load_type,n.load_count+1),await Y()}catch(o){console.error("Error updating load:",o),F?.("Error updating load","error")}finally{S(!1)}},K=async n=>{if(n.load_count<=1){await I(n.id);return}S(!0);try{await H.updateDisposalLoad(n.id,n.load_type,n.load_count-1),await Y()}catch(o){console.error("Error updating load:",o),F?.("Error updating load","error")}finally{S(!1)}},te=A.reduce((n,o)=>(n[o.load_type]||(n[o.load_type]={items:[],total:0}),n[o.load_type].items.push(o),n[o.load_type].total+=o.load_count,n),{}),B=A.reduce((n,o)=>n+o.load_count,0);return _?e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsx(ls,{size:20}),e.jsx("span",{children:"Disposal Loads"})]}),e.jsx("div",{className:"disposal-loading",children:"Loading..."})]}):e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsxs("div",{className:"disposal-title",children:[e.jsx(ls,{size:20}),e.jsx("span",{children:"Disposal Loads"}),B>0&&e.jsx("span",{className:"disposal-badge",children:B})]}),e.jsx("span",{className:"disposal-date",children:P})]}),e.jsx("div",{className:"disposal-quick-add",children:$e.map(n=>e.jsxs("button",{className:"quick-add-btn",onClick:()=>ne(n.value),disabled:R,children:[e.jsx("span",{className:"quick-add-icon",children:n.icon}),e.jsxs("span",{className:"quick-add-label",children:["+ ",n.label]})]},n.value))}),Object.keys(te).length>0?e.jsx("div",{className:"disposal-loads-list",children:$e.map(n=>{const o=te[n.value];return o?e.jsxs("div",{className:"disposal-load-row",children:[e.jsxs("div",{className:"load-info",children:[e.jsx("span",{className:"load-icon",children:n.icon}),e.jsx("span",{className:"load-label",children:n.label})]}),e.jsxs("div",{className:"load-controls",children:[e.jsx("button",{className:"load-btn decrement",onClick:()=>K(o.items[0]),disabled:R,children:e.jsx(ys,{size:16})}),e.jsx("span",{className:"load-count",children:o.total}),e.jsx("button",{className:"load-btn increment",onClick:()=>Q(o.items[0]),disabled:R,children:e.jsx(ts,{size:16})})]})]},n.value):null})}):e.jsxs("div",{className:"disposal-empty",children:[e.jsxs("p",{children:["No disposal loads recorded for ",P]}),e.jsx("p",{className:"disposal-hint",children:"Tap a button above to add loads"})]}),q&&e.jsxs("div",{className:"disposal-add-form",children:[e.jsxs("div",{className:"add-form-row",children:[e.jsx("select",{value:D.type,onChange:n=>w({...D,type:n.target.value}),className:"load-type-select",children:$e.map(n=>e.jsxs("option",{value:n.value,children:[n.icon," ",n.label]},n.value))}),e.jsxs("div",{className:"count-input-group",children:[e.jsx("button",{className:"count-btn",onClick:()=>w({...D,count:Math.max(1,D.count-1)}),children:e.jsx(ys,{size:16})}),e.jsx("input",{type:"number",min:"1",value:D.count,onChange:n=>w({...D,count:parseInt(n.target.value)||1}),className:"count-input"}),e.jsx("button",{className:"count-btn",onClick:()=>w({...D,count:D.count+1}),children:e.jsx(ts,{size:16})})]})]}),e.jsxs("div",{className:"add-form-actions",children:[e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:()=>T(!1),children:[e.jsx(Es,{size:16})," Cancel"]}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:Z,disabled:R,children:[e.jsx(ie,{size:16})," Add"]})]})]}),!q&&e.jsxs("button",{className:"disposal-add-custom",onClick:()=>T(!0),children:[e.jsx(ts,{size:16}),"Add multiple loads"]}),B>0&&e.jsxs("div",{className:"disposal-summary",children:[e.jsx("strong",{children:B})," total load",B!==1?"s":""," today"]}),x.length>0&&e.jsxs("div",{className:"disposal-history-section",children:[e.jsxs("button",{className:"disposal-history-toggle",onClick:()=>$(!V),children:[e.jsx(La,{size:16}),e.jsxs("span",{children:["View History (",x.length," days)"]}),V?e.jsx(ha,{size:16}):e.jsx(Ca,{size:16})]}),V&&e.jsx("div",{className:"disposal-history-list",children:x.map(n=>{const o=new Date(n.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),u=n.loads.reduce((y,N)=>(y[N.load_type]||(y[N.load_type]=0),y[N.load_type]+=N.load_count,y),{});return e.jsxs("div",{className:"disposal-history-day",children:[e.jsxs("div",{className:"disposal-history-header",children:[e.jsx("span",{className:"disposal-history-date",children:o}),e.jsxs("span",{className:"disposal-history-total",children:[n.totalLoads," load",n.totalLoads!==1?"s":""]})]}),e.jsx("div",{className:"disposal-history-types",children:Object.entries(u).map(([y,N])=>{const W=Ta(y);return e.jsxs("span",{className:"disposal-history-type",children:[W.icon," ",N," ",W.label]},y)})})]},n.date)})})]})]})}function Za({project:m,companyId:C,onShowToast:b,onExit:F}){const[A,v]=c.useState([]),[x,k]=c.useState(!0),[_,G]=c.useState(null),[R,S]=c.useState({}),[q,T]=c.useState(!1),[V,$]=c.useState(!1),[D,w]=c.useState(!1),[P,Y]=c.useState(!1),[E,Z]=c.useState(!1),[I,ne]=c.useState(!1),[Q,K]=c.useState("actions");c.useEffect(()=>{te()},[m.id]);const te=async()=>{try{const h=await H.getAreas(m.id);v(h);const M=[...new Set(h.map(ee=>ee.group_name||"General"))],g={};M.forEach(ee=>g[ee]=!1),S(g)}catch(h){console.error("Error loading areas:",h),b("Error loading areas","error")}finally{k(!1)}},B=async(h,M)=>{const g=A.find(se=>se.id===h);if(!g)return;const ee=g.status===M?"not_started":M;G(h);try{await H.updateAreaStatus(h,ee),v(se=>se.map(Ee=>Ee.id===h?{...Ee,status:ee}:Ee)),b("Updated","success")}catch(se){console.error("Error updating status:",se),b("Error updating","error")}finally{G(null)}},n=h=>{S(M=>({...M,[h]:!M[h]}))};if(x)return e.jsx("div",{className:"foreman-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),"Loading..."]})});if(q)return e.jsx("div",{className:"foreman-container",children:e.jsx(Ma,{project:m,companyId:C,onSubmit:()=>T(!1),onCancel:()=>T(!1),onShowToast:b})});if(P)return e.jsx(Pa,{project:m,onShowToast:b,onClose:()=>Y(!1)});if(E)return e.jsx("div",{className:"foreman-container",children:e.jsx(pa,{project:m,companyId:C,onClose:()=>Z(!1),onReportCreated:()=>{Z(!1),b("Injury report submitted","success")}})});if(V)return e.jsxs("div",{className:"foreman-container",children:[e.jsxs("div",{className:"foreman-view-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:()=>$(!1),children:"←"}),e.jsx("h2",{children:"Crew Check-in"})]}),e.jsx(Oa,{project:m,companyId:C,onShowToast:b})]});if(D)return e.jsxs("div",{className:"foreman-container",children:[e.jsxs("div",{className:"foreman-view-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:()=>w(!1),children:"←"}),e.jsx("h2",{children:"Disposal Loads"})]}),e.jsx($a,{project:m,date:new Date().toISOString().split("T")[0],onShowToast:b})]});const o=xa(A),u=A.reduce((h,M)=>{const g=M.group_name||"General";return h[g]||(h[g]=[]),h[g].push(M),h},{}),y=Object.keys(u).length>1||Object.keys(u).length===1&&!u.General,N=h=>`${h.filter(g=>g.status==="done").length}/${h.length}`,W=A.filter(h=>h.status==="done").length,O=A.filter(h=>h.status==="working").length,re=A.length-W;return e.jsxs("div",{className:"foreman-container",children:[e.jsxs("div",{className:"foreman-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:F,children:"←"}),e.jsxs("div",{className:"foreman-header-info",children:[e.jsx("div",{className:"foreman-project-name",children:m.name}),e.jsxs("div",{className:"foreman-progress",children:[o,"% Complete"]})]}),e.jsxs("div",{className:"foreman-header-actions",children:[e.jsx(na,{compact:!0}),e.jsx("button",{className:"foreman-info-btn",onClick:()=>ne(!I),children:e.jsx(ja,{size:20})})]})]}),I&&e.jsxs("div",{className:"foreman-project-info",children:[m.job_number&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Job #"}),e.jsx("span",{className:"foreman-info-value",children:m.job_number})]}),m.address&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Address"}),e.jsx("span",{className:"foreman-info-value",children:m.address})]}),m.general_contractor&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"GC / Client"}),e.jsx("span",{className:"foreman-info-value",children:m.general_contractor})]}),m.client_contact&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Contact"}),e.jsx("span",{className:"foreman-info-value",children:m.client_contact})]}),m.client_phone&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Phone"}),e.jsx("a",{href:`tel:${m.client_phone}`,className:"foreman-info-value foreman-info-link",children:m.client_phone})]})]}),e.jsxs("div",{className:"foreman-stats",children:[e.jsxs("div",{className:"foreman-stat",children:[e.jsx("div",{className:"foreman-stat-value working",children:O}),e.jsx("div",{className:"foreman-stat-label",children:"Working"})]}),e.jsxs("div",{className:"foreman-stat",children:[e.jsx("div",{className:"foreman-stat-value done",children:W}),e.jsx("div",{className:"foreman-stat-label",children:"Done"})]}),e.jsxs("div",{className:"foreman-stat",children:[e.jsx("div",{className:"foreman-stat-value remaining",children:re}),e.jsx("div",{className:"foreman-stat-label",children:"Remaining"})]})]}),e.jsxs("div",{className:"foreman-tabs",children:[e.jsxs("button",{className:`foreman-tab ${Q==="actions"?"active":""}`,onClick:()=>K("actions"),children:[e.jsx(os,{size:18}),"Actions"]}),e.jsxs("button",{className:`foreman-tab ${Q==="progress"?"active":""}`,onClick:()=>K("progress"),children:[e.jsx(ga,{size:18}),"Progress"]})]}),Q==="actions"&&e.jsxs("div",{className:"field-actions",children:[e.jsxs("button",{className:"field-action-btn",onClick:()=>$(!0),children:[e.jsx(pe,{size:22}),"Crew Check-in"]}),e.jsxs("button",{className:"field-action-btn",onClick:()=>T(!0),children:[e.jsx(qe,{size:22}),"T&M Ticket"]}),e.jsxs("button",{className:"field-action-btn",onClick:()=>w(!0),children:[e.jsx(ls,{size:22}),"Disposal Loads"]}),e.jsxs("button",{className:"field-action-btn",onClick:()=>Y(!0),children:[e.jsx(Cs,{size:22}),"Daily Report"]}),e.jsxs("button",{className:"field-action-btn danger",onClick:()=>Z(!0),children:[e.jsx(Ss,{size:22}),"Report Injury"]})]}),Q==="progress"&&e.jsxs("div",{className:"foreman-areas",children:[y?Object.entries(u).map(([h,M])=>e.jsxs("div",{className:"foreman-group",children:[e.jsxs("div",{className:"foreman-group-header",onClick:()=>n(h),children:[e.jsxs("div",{className:"foreman-group-title",children:[e.jsx("span",{className:"foreman-group-arrow",children:R[h]?"▼":"▶"}),e.jsx("span",{className:"foreman-group-name",children:h})]}),e.jsx("span",{className:"foreman-group-progress",children:N(M)})]}),R[h]&&e.jsx("div",{className:"foreman-group-tasks",children:M.map(g=>e.jsxs("div",{className:`foreman-area-card ${g.status}`,children:[e.jsx("div",{className:"foreman-area-name",children:g.name}),e.jsxs("div",{className:"foreman-area-buttons",children:[e.jsx("button",{className:`foreman-btn working ${g.status==="working"?"active":""}`,onClick:()=>B(g.id,"working"),disabled:_===g.id,children:_===g.id?"...":"Working"}),e.jsx("button",{className:`foreman-btn done ${g.status==="done"?"active":""}`,onClick:()=>B(g.id,"done"),disabled:_===g.id,children:_===g.id?"...":"Done"})]})]},g.id))})]},h)):A.map(h=>e.jsxs("div",{className:`foreman-area-card ${h.status}`,children:[e.jsx("div",{className:"foreman-area-name",children:h.name}),e.jsxs("div",{className:"foreman-area-buttons",children:[e.jsx("button",{className:`foreman-btn working ${h.status==="working"?"active":""}`,onClick:()=>B(h.id,"working"),disabled:_===h.id,children:_===h.id?"...":"Working"}),e.jsx("button",{className:`foreman-btn done ${h.status==="done"?"active":""}`,onClick:()=>B(h.id,"done"),disabled:_===h.id,children:_===h.id?"...":"Done"})]})]},h.id)),A.length===0&&e.jsxs("div",{className:"foreman-empty",children:[e.jsx(Cs,{size:48,className:"foreman-empty-icon"}),e.jsx("div",{className:"foreman-empty-text",children:"No areas yet"}),e.jsx("div",{className:"foreman-empty-subtext",children:"Office needs to add areas to this project"})]})]})]})}export{Za as default};
