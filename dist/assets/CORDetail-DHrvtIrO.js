const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BIaaQ6dM.js","assets/react-BSqwb0tX.js","assets/pdf-DgmPe6PY.js","assets/supabase-CJTGJ4KY.js","assets/icons-B4eeUMwP.js","assets/recharts-CI1uxbzf.js","assets/index-Bk8JRRJt.css","assets/corPdfGenerator-CRCFF7Zw.js","assets/corCalculations-vdJc_BOT.js"])))=>i.map(i=>d[i]);
import{r as f,j as e}from"./react-BSqwb0tX.js";import{o as z,s as O,d as w}from"./index-BIaaQ6dM.js";import{c as me,k as xe,a as je,f as m,e as L,d as I,b as S}from"./corCalculations-vdJc_BOT.js";import{_ as $}from"./pdf-DgmPe6PY.js";import{e as ge}from"./Dashboard-BNKOiQvY.js";import{S as be}from"./SignatureCanvas-ClNi7ES9.js";import Ne from"./SignatureLinkGenerator-CmyCQfb9.js";import{b as fe,X as B,ax as ve,e as ye,F as V,V as Z,O as ee,an as ke,o as Ce,B as Ee,aB as Re,d as we,a as Oe,t as De,C as Ie,Q as Se,I as Pe,aC as H,aD as ze,ac as se,P as qe,m as Fe,j as Te,D as ae}from"./icons-B4eeUMwP.js";import"./supabase-CJTGJ4KY.js";import"./recharts-CI1uxbzf.js";const P={PENDING:"pending",GENERATING:"generating",COMPLETED:"completed",FAILED:"failed"},Ae={PDF:"pdf"};function Le(t,d,_=null){if(_)return`custom_${_}`;const j=Math.floor(Date.now()/6e4);return`cor_${t}_v${d||1}_${j}`}function Ue(t){return`cor_${t}_force_${Date.now()}`}function Ge(t,d,_={}){const j=new Date().toISOString(),g=[];let y=0;for(const r of d||[]){const n=r.photos||[];y+=n.length;for(const U of n)g.push({ticketId:r.id,workDate:r.work_date,url:U,verified:!1,includedInExport:!0})}const i=(t.change_order_labor||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0),c=(t.change_order_materials||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0),l=(t.change_order_equipment||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0),h=(t.change_order_subcontractors||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0);let a=0,o=0;for(const r of d||[])for(const n of r.t_and_m_workers||[])a+=parseFloat(n.hours)||0,o+=parseFloat(n.overtime_hours)||0;const v=JSON.stringify({corId:t.id,version:t.version,totals:{laborTotal:i,materialsTotal:c,equipmentTotal:l,subcontractorsTotal:h},ticketCount:d?.length||0,photoCount:y});let x=0;for(let r=0;r<v.length;r++){const n=v.charCodeAt(r);x=(x<<5)-x+n,x=x&x}const D=Math.abs(x).toString(16).padStart(16,"0");return{snapshotId:crypto.randomUUID(),corId:t.id,corVersion:t.version||1,createdAt:j,checksum:D,corData:{id:t.id,cor_number:t.cor_number,title:t.title,description:t.description,scope_of_work:t.scope_of_work,status:t.status,period_start:t.period_start,period_end:t.period_end,change_order_labor:t.change_order_labor||[],change_order_materials:t.change_order_materials||[],change_order_equipment:t.change_order_equipment||[],change_order_subcontractors:t.change_order_subcontractors||[],labor_markup_percent:t.labor_markup_percent,materials_markup_percent:t.materials_markup_percent,equipment_markup_percent:t.equipment_markup_percent,subcontractors_markup_percent:t.subcontractors_markup_percent,liability_insurance_percent:t.liability_insurance_percent,bond_percent:t.bond_percent,license_fee_percent:t.license_fee_percent,labor_subtotal:t.labor_subtotal,materials_subtotal:t.materials_subtotal,equipment_subtotal:t.equipment_subtotal,subcontractors_subtotal:t.subcontractors_subtotal,labor_markup_amount:t.labor_markup_amount,materials_markup_amount:t.materials_markup_amount,equipment_markup_amount:t.equipment_markup_amount,subcontractors_markup_amount:t.subcontractors_markup_amount,liability_insurance_amount:t.liability_insurance_amount,bond_amount:t.bond_amount,license_fee_amount:t.license_fee_amount,cor_subtotal:t.cor_subtotal,additional_fees_total:t.additional_fees_total,cor_total:t.cor_total,gc_signature_data:t.gc_signature_data,gc_signature_name:t.gc_signature_name,gc_signature_date:t.gc_signature_date,created_at:t.created_at,submitted_at:t.submitted_at,approved_at:t.approved_at},ticketsData:(d||[]).map(r=>({id:r.id,work_date:r.work_date,ticket_date:r.ticket_date,ce_pco_number:r.ce_pco_number,notes:r.notes,status:r.status,created_at:r.created_at,t_and_m_workers:(r.t_and_m_workers||[]).map(n=>({id:n.id,name:n.name,role:n.role,labor_class:n.labor_class,hours:n.hours,overtime_hours:n.overtime_hours,time_started:n.time_started,time_ended:n.time_ended})),t_and_m_items:(r.t_and_m_items||[]).map(n=>({id:n.id,description:n.description,quantity:n.quantity,unit:n.unit,materials_equipment:n.materials_equipment})),photos:r.photos||[],client_signature_data:r.client_signature_data,client_signature_name:r.client_signature_name,client_signature_title:r.client_signature_title,client_signature_company:r.client_signature_company,client_signature_date:r.client_signature_date})),photoManifest:g,totals:{laborTotal:i,materialsTotal:c,equipmentTotal:l,subcontractorsTotal:h,totalLaborHours:a,totalOTHours:o,ticketCount:d?.length||0,photoCount:y,verifiedTicketCount:(d||[]).filter(r=>r.client_signature_data).length}}}async function Me(t,d={}){const{forceNew:_=!1,idempotencyKey:j=null,exportType:g=Ae.PDF,includeBackup:y=!0}=d;try{const{data:i,error:c}=await O.from("change_orders").select("id, version, cor_number").eq("id",t).single();if(c||!i)throw new Error(`COR not found: ${t}`);const l=_?Ue(t):j||Le(t,i.version),{data:h,error:a}=await O.rpc("request_cor_export",{p_cor_id:t,p_idempotency_key:l,p_options:{exportType:g,includeBackup:y},p_requested_by:(await O.auth.getUser())?.data?.user?.id});if(a)throw a;const o=h?.[0];if(!o)throw new Error("Failed to create export job");return z.activity("cor_export_requested",{cor_id:t,job_id:o.job_id,is_new:o.is_new,status:o.status}),{jobId:o.job_id,status:o.status,isNew:o.is_new,snapshotId:o.snapshot_id,pdfUrl:o.pdf_url,idempotencyKey:l}}catch(i){throw z.error("cor_export_request_failed",{cor_id:t,error:i.message}),i}}async function K(t,d,_={}){const{data:j,error:g}=await O.rpc("update_export_job_status",{p_job_id:t,p_status:d,p_snapshot_id:_.snapshotId||null,p_pdf_url:_.pdfUrl||null,p_error:_.error||null,p_error_details:_.errorDetails||null,p_metrics:_.metrics||null});if(g)throw z.error("cor_export_job_update_failed",{job_id:t,status:d,error:g.message}),g;return j}async function $e(t,d){await O.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",t.corId);const{data:_,error:j}=await O.from("cor_export_snapshots").insert({id:t.snapshotId,cor_id:t.corId,job_id:d,cor_version:t.corVersion,cor_data:t.corData,tickets_data:t.ticketsData,photos_manifest:t.photoManifest,totals_snapshot:t.totals,checksum:t.checksum,is_current:!0,exported_by:(await O.auth.getUser())?.data?.user?.id}).select().single();if(j)throw j;return await O.from("change_orders").update({last_snapshot_version:t.corVersion}).eq("id",t.corId),_}async function Be(t,{cor:d,tickets:_,project:j,company:g,branding:y,options:i={}}={}){let c=null;try{if(c=await Me(t,i),c.status===P.COMPLETED&&c.pdfUrl)return z.activity("cor_export_cache_hit",{cor_id:t,job_id:c.jobId}),{success:!0,jobId:c.jobId,cached:!0,pdfUrl:c.pdfUrl};if(c.status===P.GENERATING)return{success:!0,jobId:c.jobId,status:P.GENERATING,message:"Export already in progress"};if(await K(c.jobId,P.GENERATING),!d){const{db:v}=await $(async()=>{const{db:x}=await import("./index-BIaaQ6dM.js").then(D=>D.n);return{db:x}},__vite__mapDeps([0,1,2,3,4,5,6]));d=await v.getCORById(t)}if(!_&&i.includeBackup!==!1){const{db:v}=await $(async()=>{const{db:x}=await import("./index-BIaaQ6dM.js").then(D=>D.n);return{db:x}},__vite__mapDeps([0,1,2,3,4,5,6]));_=await v.getCORTickets(t)}const l=Ge(d,_,i),h=await $e(l,c.jobId),{generatePDFFromSnapshot:a}=await $(async()=>{const{generatePDFFromSnapshot:v}=await import("./corPdfGenerator-CRCFF7Zw.js");return{generatePDFFromSnapshot:v}},__vite__mapDeps([7,2,8,0,1,3,4,5,6])),o=await a(l,{project:j,company:g,branding:y});return await K(c.jobId,P.COMPLETED,{snapshotId:h.id,pdfUrl:o.fileName,metrics:{photo_count:l.totals.photoCount,ticket_count:l.totals.ticketCount,page_count:o.pageCount||1,pdf_size_bytes:o.sizeBytes||0}}),z.activity("cor_export_completed",{cor_id:t,job_id:c.jobId,photo_count:l.totals.photoCount,ticket_count:l.totals.ticketCount}),{success:!0,jobId:c.jobId,snapshotId:h.id,fileName:o.fileName,snapshot:l.totals}}catch(l){throw c?.jobId&&await K(c.jobId,P.FAILED,{error:l.message,errorDetails:{stack:l.stack}}).catch(()=>{}),z.error("cor_export_failed",{cor_id:t,job_id:c?.jobId,error:l.message}),l}}function ss({cor:t,project:d,company:_,areas:j,onClose:g,onEdit:y,onShowToast:i,onStatusChange:c}){const[l,h]=f.useState(!0),[a,o]=f.useState(t),[v,x]=f.useState(!1),[D,r]=f.useState(!1),[n,U]=f.useState(new Set),[Q,G]=f.useState(null),[te,q]=f.useState(!1),[T,J]=f.useState(""),A=f.useCallback(async()=>{try{const s=await w.getCORById(t.id);if(s){if(s.tickets?.length){const u=s.tickets.map(k=>k.photos||[]),N=u.flat();if(N.length){const k=await w.resolvePhotoUrls(N);let C=0;s.tickets=s.tickets.map((E,p)=>{const R=u[p].length,pe=k.slice(C,C+R);return C+=R,{...E,photos:pe}})}}o(s)}}catch(s){console.error("Error fetching COR details:",s),i?.("Error loading COR details","error")}finally{h(!1)}},[t.id]);f.useEffect(()=>{A()},[A]),f.useEffect(()=>{const s=w.subscribeToCorTickets?.(t.id,()=>{A()});return()=>{s&&w.unsubscribe?.(s)}},[t.id,A]);const b=f.useMemo(()=>me(a),[a]),M=xe(a.status),re=a.status==="pending_approval",X=["draft","pending_approval","approved"].includes(a.status),W=s=>j?.find(N=>N.id===s)?.name||null,ne=async()=>{if(confirm("Approve this change order request?")){h(!0);try{await w.approveCOR(a.id),o({...a,status:"approved",approved_at:new Date().toISOString()}),i?.("COR approved","success"),c?.()}catch(s){console.error("Error approving COR:",s),i?.("Error approving COR","error")}finally{h(!1)}}},ie=async()=>{const s=prompt("Enter rejection reason (optional):");if(s!==null){h(!0);try{await w.rejectCOR(a.id,s),o({...a,status:"rejected",rejection_reason:s}),i?.("COR rejected","success"),c?.()}catch(u){console.error("Error rejecting COR:",u),i?.("Error rejecting COR","error")}finally{h(!1)}}},ce=async()=>{if(confirm("Mark this COR as billed?")){h(!0);try{await w.markCORAsBilled(a.id),o({...a,status:"billed"}),i?.("COR marked as billed","success"),c?.()}catch(s){console.error("Error marking COR as billed:",s),i?.("Error updating status","error")}finally{h(!1)}}},le=async s=>{h(!0);try{await w.saveCORSignature?.(a.id,{gc_signature:s.signature,gc_signer_name:s.signerName,signed_at:s.signedAt}),o({...a,gc_signature:s.signature,gc_signer_name:s.signerName,signed_at:s.signedAt}),x(!1),i?.("Signature saved","success"),c?.()}catch(u){console.error("Error saving signature:",u),i?.("Error saving signature","error")}finally{h(!1)}},oe=a.status==="approved"&&!a.gc_signature,Y=async()=>{if(!T.trim()){q(!1);return}h(!0);try{await w.updateCOR(a.id,{cor_number:T.trim()}),o({...a,cor_number:T.trim()}),q(!1),i?.("COR number updated","success")}catch(s){console.error("Error updating COR number:",s),i?.("Error updating COR number","error")}finally{h(!1)}},de=()=>{J(a.cor_number||""),q(!0)},ue=s=>{U(u=>{const N=new Set(u);return N.has(s)?N.delete(s):N.add(s),N})},F=f.useMemo(()=>a.change_order_ticket_associations?.map(s=>s.t_and_m_tickets).filter(Boolean)||[],[a.change_order_ticket_associations]),_e=s=>{const u=s.t_and_m_workers||[],N=u.reduce((C,E)=>C+(parseFloat(E.hours)||0),0),k=u.reduce((C,E)=>C+(parseFloat(E.overtime_hours)||0),0);return{regular:N,overtime:k,total:N+k}},he=async()=>{try{i?.("Generating PDF with backup...","info"),(await Be(a.id,{cor:a,tickets:F,project:d,company:_,branding:{logoUrl:_?.logo_url,primaryColor:_?.branding_color},options:{includeBackup:!0}})).cached?i?.("PDF downloaded (cached)","success"):i?.("PDF downloaded","success")}catch(s){console.error("Error exporting PDF:",s),i?.("Error generating PDF","error")}};return l?e.jsx("div",{className:"modal-overlay",onClick:g,children:e.jsx("div",{className:"modal-content cor-detail-modal",onClick:s=>s.stopPropagation(),children:e.jsx("div",{className:"cor-detail-loading",children:"Loading COR details..."})})}):e.jsxs("div",{className:"modal-overlay",onClick:g,role:"dialog","aria-modal":"true","aria-labelledby":"cor-detail-title",children:[e.jsxs("div",{className:"modal-content cor-detail-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header cor-detail-header",children:[e.jsxs("div",{className:"cor-detail-title-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"cor-detail-number",children:te?e.jsxs("div",{className:"cor-number-edit",children:[e.jsx("input",{type:"text",value:T,onChange:s=>J(s.target.value),onKeyDown:s=>{s.key==="Enter"&&Y(),s.key==="Escape"&&q(!1)},autoFocus:!0,className:"cor-number-input"}),e.jsx("button",{className:"btn-icon-sm",onClick:Y,title:"Save",children:e.jsx(fe,{size:14})}),e.jsx("button",{className:"btn-icon-sm",onClick:()=>q(!1),title:"Cancel",children:e.jsx(B,{size:14})})]}):e.jsxs("div",{className:"cor-number-display",children:[e.jsx("span",{children:a.cor_number}),X&&e.jsx("button",{className:"btn-icon-sm",onClick:de,title:"Edit COR number",children:e.jsx(ve,{size:12})})]})}),e.jsx("h2",{id:"cor-detail-title",children:a.title||"Untitled COR"})]}),e.jsx("button",{className:"close-btn",onClick:g,"aria-label":"Close COR details",children:e.jsx(B,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"cor-detail-meta",children:[e.jsx("span",{className:"cor-detail-status",style:{backgroundColor:M.bgColor,color:M.color},children:M.label}),a.group_name&&e.jsx("span",{className:"cor-detail-group",children:a.group_name}),W(a.area_id)&&e.jsx("span",{className:"cor-detail-area",children:W(a.area_id)}),e.jsxs("span",{className:"cor-detail-period",children:[e.jsx(ye,{size:14})," ",je(a.period_start,a.period_end)]})]})]}),e.jsxs("div",{className:"modal-body cor-detail-body",children:[e.jsxs("div",{className:"cor-detail-section",children:[e.jsxs("h3",{children:[e.jsx(V,{size:18})," Scope of Work"]}),e.jsx("p",{className:"cor-scope-text",children:a.scope_of_work||"No scope of work provided."})]}),e.jsxs("div",{className:"cor-detail-section pricing-breakdown",children:[e.jsxs("h3",{children:[e.jsx(Z,{size:18})," Pricing Breakdown"]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ee,{size:16}),e.jsx("span",{children:"Labor"})]}),e.jsx("span",{className:"category-subtotal",children:m(b.labor_subtotal)})]}),a.change_order_labor?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"Reg Rate"}),e.jsx("th",{children:"OT Hrs"}),e.jsx("th",{children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_labor.map((s,u)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.labor_class}),e.jsx("td",{children:s.wage_type}),e.jsx("td",{children:s.regular_hours}),e.jsxs("td",{children:["$",L(s.regular_rate),"/hr"]}),e.jsx("td",{children:s.overtime_hours||"-"}),e.jsx("td",{children:s.overtime_hours?`$${L(s.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:m(s.total)})]},u))})]})}):e.jsx("div",{className:"category-empty",children:"No labor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.labor_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",m(b.labor_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ke,{size:16}),e.jsx("span",{children:"Materials"})]}),e.jsx("span",{className:"category-subtotal",children:m(b.materials_subtotal)})]}),a.change_order_materials?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_materials.map((s,u)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{children:s.quantity}),e.jsx("td",{children:s.unit}),e.jsxs("td",{children:["$",L(s.unit_cost)]}),e.jsx("td",{className:"text-right",children:m(s.total)})]},u))})]})}):e.jsx("div",{className:"category-empty",children:"No material items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.materials_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",m(b.materials_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Ce,{size:16}),e.jsx("span",{children:"Equipment"})]}),e.jsx("span",{className:"category-subtotal",children:m(b.equipment_subtotal)})]}),a.change_order_equipment?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_equipment.map((s,u)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{children:s.quantity}),e.jsx("td",{children:s.unit}),e.jsxs("td",{children:["$",L(s.unit_cost)]}),e.jsx("td",{className:"text-right",children:m(s.total)})]},u))})]})}):e.jsx("div",{className:"category-empty",children:"No equipment items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.equipment_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",m(b.equipment_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Ee,{size:16}),e.jsx("span",{children:"Subcontractors"})]}),e.jsx("span",{className:"category-subtotal",children:m(b.subcontractors_subtotal)})]}),a.change_order_subcontractors?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:a.change_order_subcontractors.map((s,u)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.company_name}),e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{className:"text-right",children:m(s.total)})]},u))})]})}):e.jsx("div",{className:"category-empty",children:"No subcontractor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.subcontractors_markup_percent||500),")"]}),e.jsxs("span",{children:["+",m(b.subcontractors_markup_amount)]})]})]}),e.jsxs("div",{className:"cor-subtotal-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:m(b.cor_subtotal)})]}),e.jsxs("div",{className:"pricing-category fees-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Re,{size:16}),e.jsx("span",{children:"Additional Fees"})]}),e.jsx("span",{className:"category-subtotal",children:m(b.additional_fees_total)})]}),e.jsxs("div",{className:"fees-list",children:[e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(we,{size:14}),e.jsxs("span",{children:["Liability Insurance (",I(a.liability_insurance_percent||144),")"]})]}),e.jsx("span",{className:"fee-amount",children:m(b.liability_insurance_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(V,{size:14}),e.jsxs("span",{children:["Bond (",I(a.bond_percent||100),")"]})]}),e.jsx("span",{className:"fee-amount",children:m(b.bond_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(Oe,{size:14}),e.jsxs("span",{children:["City License Fee (",I(a.license_fee_percent||10),")"]})]}),e.jsx("span",{className:"fee-amount",children:m(b.license_fee_amount)})]})]})]}),e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:m(b.cor_total)})]})]}),F.length>0&&e.jsxs("div",{className:"cor-detail-section backup-section",children:[e.jsxs("h3",{children:[e.jsx(V,{size:18})," Backup Documentation"]}),e.jsxs("p",{className:"backup-summary",children:[F.length," T&M ticket",F.length!==1?"s":""," associated with this COR"]}),e.jsx("div",{className:"backup-tickets-list",children:F.map(s=>{const u=n.has(s.id),N=_e(s),k=s.t_and_m_workers?.length||0,C=s.t_and_m_items?.length||0,E=s.photos?.length||0;return e.jsxs("div",{className:"backup-ticket-card",children:[e.jsxs("div",{className:"backup-ticket-header",onClick:()=>ue(s.id),children:[e.jsx("div",{className:"backup-ticket-toggle",children:u?e.jsx(De,{size:18}):e.jsx(Ie,{size:18})}),e.jsxs("div",{className:"backup-ticket-info",children:[e.jsxs("div",{className:"backup-ticket-date",children:[e.jsx(Se,{size:14}),e.jsx("span",{children:S(s.work_date)})]}),s.ce_pco_number&&e.jsxs("span",{className:"backup-ticket-pco",children:["CE/PCO: ",s.ce_pco_number]})]}),e.jsxs("div",{className:"backup-ticket-stats",children:[e.jsxs("span",{className:"backup-stat",children:[e.jsx(ee,{size:14})," ",k]}),e.jsxs("span",{className:"backup-stat",children:[N.total.toFixed(1)," hrs"]}),E>0&&e.jsxs("span",{className:"backup-stat",children:[e.jsx(Pe,{size:14})," ",E]}),s.client_signature_data&&e.jsxs("span",{className:"backup-stat verified",title:`Verified by ${s.client_signature_name}`,children:[e.jsx(H,{size:14})," Verified"]})]}),e.jsx("span",{className:`backup-ticket-status status-${s.status}`,children:s.status})]}),u&&e.jsxs("div",{className:"backup-ticket-details",children:[s.notes&&e.jsxs("div",{className:"backup-ticket-notes",children:[e.jsx("strong",{children:"Notes:"})," ",s.notes]}),s.t_and_m_workers?.length>0&&e.jsxs("div",{className:"backup-workers",children:[e.jsxs("h4",{children:["Labor (",k," workers)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT Hrs"})]})}),e.jsx("tbody",{children:s.t_and_m_workers.map((p,R)=>e.jsxs("tr",{children:[e.jsx("td",{children:p.name}),e.jsx("td",{children:p.role||"-"}),e.jsx("td",{className:"backup-time-range",children:p.time_started&&p.time_ended?`${p.time_started} - ${p.time_ended}`:"-"}),e.jsx("td",{children:p.hours||0}),e.jsx("td",{children:p.overtime_hours||"-"})]},R))})]})]}),s.t_and_m_items?.length>0&&e.jsxs("div",{className:"backup-items",children:[e.jsxs("h4",{children:["Materials & Equipment (",C," items)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Qty"})]})}),e.jsx("tbody",{children:s.t_and_m_items.map((p,R)=>e.jsxs("tr",{children:[e.jsx("td",{children:p.custom_name||p.materials_equipment?.name||"Unnamed Item"}),e.jsx("td",{children:p.custom_category||p.materials_equipment?.category||"-"}),e.jsx("td",{children:p.quantity})]},R))})]})]}),s.photos?.length>0&&e.jsxs("div",{className:"backup-photos",children:[e.jsxs("h4",{children:["Photos (",E,")"]}),e.jsx("div",{className:"backup-photos-grid",children:s.photos.map((p,R)=>e.jsx("div",{className:"backup-photo-thumb",onClick:()=>G(p),children:e.jsx("img",{src:p,alt:`Photo ${R+1}`})},R))})]}),s.client_signature_data&&e.jsxs("div",{className:"backup-verification",children:[e.jsxs("h4",{children:[e.jsx(H,{size:14})," Client Verification"]}),e.jsxs("div",{className:"backup-signature-display",children:[e.jsx("img",{src:s.client_signature_data,alt:"Client Signature",className:"backup-signature-image"}),e.jsxs("div",{className:"backup-signature-info",children:[e.jsx("span",{className:"backup-signer-name",children:s.client_signature_name}),s.client_signature_title&&e.jsx("span",{className:"backup-signer-title",children:s.client_signature_title}),s.client_signature_company&&e.jsx("span",{className:"backup-signer-company",children:s.client_signature_company}),e.jsxs("span",{className:"backup-signed-date",children:["Verified: ",S(s.client_signature_date)]})]})]})]})]})]},s.id)})})]}),(a.gc_signature_data||a.gc_signature||a.client_signature_data)&&e.jsxs("div",{className:"cor-detail-section signature-section",children:[e.jsxs("h3",{children:[e.jsx(ze,{size:18})," Signatures"]}),e.jsxs("div",{className:"dual-signatures",children:[(a.gc_signature_data||a.gc_signature)&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"GC Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.gc_signature_data||a.gc_signature,alt:"GC Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.gc_signature_name||a.gc_signer_name}),(a.gc_signature_title||a.gc_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.gc_signature_title,a.gc_signature_title&&a.gc_signature_company&&" - ",a.gc_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",S(a.gc_signature_date||a.signed_at)]})]})]})]}),a.client_signature_data&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"Client Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.client_signature_data,alt:"Client Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.client_signature_name}),(a.client_signature_title||a.client_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.client_signature_title,a.client_signature_title&&a.client_signature_company&&" - ",a.client_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",S(a.client_signature_date)]})]})]})]})]})]}),a.status==="rejected"&&a.rejection_reason&&e.jsxs("div",{className:"cor-detail-section rejection-section",children:[e.jsxs("h3",{children:[e.jsx(se,{size:18})," Rejection Reason"]}),e.jsx("p",{className:"rejection-text",children:a.rejection_reason})]})]}),e.jsxs("div",{className:"modal-footer cor-detail-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{children:["Created: ",S(a.created_at)]}),a.approved_at&&e.jsxs("span",{children:["Approved: ",S(a.approved_at)]})]}),e.jsxs("div",{className:"footer-actions",role:"group","aria-label":"COR actions",children:[X&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>y?.(a),disabled:l,"aria-label":"Edit this COR",children:[e.jsx(qe,{size:16,"aria-hidden":"true"})," Edit"]}),re&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:ie,disabled:l,"aria-label":"Reject this COR",children:[e.jsx(se,{size:16,"aria-hidden":"true"})," Reject"]}),e.jsxs("button",{className:"btn btn-success",onClick:ne,disabled:l,"aria-label":"Approve this COR",children:[e.jsx(Fe,{size:16,"aria-hidden":"true"})," Approve"]})]}),oe&&e.jsxs("button",{className:"btn btn-success",onClick:()=>x(!0),disabled:l,"aria-label":"Get GC signature for this COR",children:[e.jsx(H,{size:16,"aria-hidden":"true"})," Get GC Signature"]}),(a.status==="approved"||a.status==="pending_approval")&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>r(!0),disabled:l,"aria-label":"Get shareable signature link",children:[e.jsx(Te,{size:16,"aria-hidden":"true"})," Get Signature Link"]}),a.status==="approved"&&e.jsxs("button",{className:"btn btn-primary",onClick:ce,disabled:l,"aria-label":"Mark this COR as billed",children:[e.jsx(Z,{size:16,"aria-hidden":"true"})," Mark Billed"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>ge(a),"aria-label":"Export COR to CSV",children:[e.jsx(ae,{size:16,"aria-hidden":"true"})," Export CSV"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:he,"aria-label":"Export COR to PDF",children:[e.jsx(ae,{size:16,"aria-hidden":"true"})," Export PDF"]})]})]})]}),v&&e.jsx(be,{onSave:le,onClose:()=>x(!1),signerName:""}),D&&e.jsx(Ne,{documentType:"cor",documentId:a.id,companyId:_?.id,projectId:d?.id,project:d,documentTitle:`COR ${a.cor_number}: ${a.title||"Untitled"}`,onClose:()=>r(!1),onShowToast:i}),Q&&e.jsxs("div",{className:"photo-lightbox",onClick:()=>G(null),children:[e.jsx("button",{className:"lightbox-close",onClick:()=>G(null),children:e.jsx(B,{size:24})}),e.jsx("img",{src:Q,alt:"Full size photo",onClick:s=>s.stopPropagation()})]})]})}export{ss as default};
//# sourceMappingURL=CORDetail-DHrvtIrO.js.map
