import{E as q,a as F}from"./pdf-ChZ1zkDw.js";import{f as H,a as r,b as p,c as U}from"./index-jGSKx-B5.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";import"./xlsx-BvJTHLik.js";const j=s=>{const S=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return S?[parseInt(S[1],16),parseInt(S[2],16),parseInt(S[3],16)]:[30,41,59]},w=s=>{if(!s)return"";const[S,u]=s.split(":"),d=parseInt(S),b=d>=12?"pm":"am";return`${d%12||12}:${u}${b}`},G=s=>s.time_started&&s.time_ended?`${w(s.time_started)} - ${w(s.time_ended)}`:"-",Y=(s,S=5e3)=>new Promise(u=>{const d=new Image;d.crossOrigin="anonymous";const b=setTimeout(()=>{u(null)},S);d.onload=()=>{clearTimeout(b);try{const n=document.createElement("canvas");n.width=d.width,n.height=d.height,n.getContext("2d").drawImage(d,0,0),u(n.toDataURL("image/png"))}catch{u(null)}},d.onerror=()=>{clearTimeout(b),u(null)},d.src=s});async function K(s,S={}){const{project:u,company:d,branding:b={}}=S,n=s.corData,T=s.ticketsData||[],t=new q,c=t.internal.pageSize.getWidth(),_=t.internal.pageSize.getHeight(),o=20;let e=o;const m=b.primaryColor?j(b.primaryColor):[30,58,95];if(b.logoUrl)try{const l=await Y(b.logoUrl);l&&t.addImage(l,"PNG",o,e,40,15)}catch{d?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...m),t.text(d.name,o,e+8))}else d?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...m),t.text(d.name,o,e+8));if(t.setFontSize(18),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("CHANGE ORDER REQUEST",c-o,e+5,{align:"right"}),t.setFontSize(12),t.setTextColor(...m),t.text(n.cor_number||"COR",c-o,e+12,{align:"right"}),e+=25,t.setDrawColor(...m),t.setLineWidth(.5),t.line(o,e,c-o,e),e+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(n.title||"Untitled Change Order",o,e),e+=8,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),u?.name&&(t.text(`Project: ${u.name}`,o,e),e+=5),u?.job_number&&(t.text(`Job #: ${u.job_number}`,o,e),e+=5),(n.period_start||n.period_end)&&(t.text(`Period: ${H(n.period_start,n.period_end)}`,o,e),e+=5),e+=5,n.scope_of_work){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("Scope of Work:",o,e),e+=5,t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const l=t.splitTextToSize(n.scope_of_work,c-o*2);t.text(l,o,e),e+=l.length*4+8}n.change_order_labor?.length>0&&(t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Labor",o,e),e+=5,F(t,{startY:e,head:[["Class","Wage Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:n.change_order_labor.map(l=>[l.labor_class,l.wage_type||"Standard",l.regular_hours?.toString()||"0",r(l.regular_rate),l.overtime_hours?.toString()||"0",r(l.overtime_rate),r(l.total)]),foot:[[{content:"Labor Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.labor_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:m,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),n.change_order_materials?.length>0&&(e>_-60&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Materials",o,e),e+=5,F(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:n.change_order_materials.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"ea",r(l.unit_cost),r(l.total)]),foot:[[{content:"Materials Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.materials_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:m,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),n.change_order_equipment?.length>0&&(e>_-60&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Equipment",o,e),e+=5,F(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:n.change_order_equipment.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"day",r(l.unit_cost),r(l.total)]),foot:[[{content:"Equipment Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.equipment_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:m,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),n.change_order_subcontractors?.length>0&&(e>_-60&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Subcontractors",o,e),e+=5,F(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:n.change_order_subcontractors.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"lump sum",r(l.unit_cost),r(l.total)]),foot:[[{content:"Subcontractors Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:r(n.subcontractors_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:o,right:o},headStyles:{fillColor:m,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),e=t.lastAutoTable.finalY+10),e>_-100&&(t.addPage(),e=o),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Cost Summary",o,e),e+=5;const A=[["Labor Subtotal",r(n.labor_subtotal)],[`  Markup (${p(n.labor_markup_percent)})`,r(n.labor_markup_amount)],["Materials Subtotal",r(n.materials_subtotal)],[`  Markup (${p(n.materials_markup_percent)})`,r(n.materials_markup_amount)],["Equipment Subtotal",r(n.equipment_subtotal)],[`  Markup (${p(n.equipment_markup_percent)})`,r(n.equipment_markup_amount)],["Subcontractors Subtotal",r(n.subcontractors_subtotal)],[`  Markup (${p(n.subcontractors_markup_percent)})`,r(n.subcontractors_markup_amount)]];F(t,{startY:e,body:A,margin:{left:o,right:o},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),e=t.lastAutoTable.finalY+5,t.setFillColor(248,250,252),t.rect(o,e,c-o*2,8,"F"),t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(30,41,59),t.text("COR Subtotal:",o+5,e+5.5),t.text(r(n.cor_subtotal),c-o-5,e+5.5,{align:"right"}),e+=12;const N=[[`Liability Insurance (${p(n.liability_insurance_percent)})`,r(n.liability_insurance_amount)],[`Bond (${p(n.bond_percent)})`,r(n.bond_amount)],[`License Fee (${p(n.license_fee_percent)})`,r(n.license_fee_amount)]];if(F(t,{startY:e,body:N,margin:{left:o,right:o},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),e=t.lastAutoTable.finalY+5,t.setFillColor(...m),t.rect(o,e,c-o*2,10,"F"),t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(255,255,255),t.text("COR TOTAL:",o+5,e+7),t.text(r(n.cor_total),c-o-5,e+7,{align:"right"}),e+=20,T.length>0){t.addPage(),e=o,d?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...m),t.text(d.name,o,e),e+=15),t.setDrawColor(...m),t.setLineWidth(.8),t.line(o,e,c-o,e),e+=3,t.setLineWidth(.3),t.line(o,e,c-o,e),e+=15,t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",c/2,e,{align:"center"}),e+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("Change Order Request Backup",c/2,e,{align:"center"}),e+=20,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`COR Reference: ${n.cor_number}`,o,e),e+=6,t.setFont("helvetica","normal"),t.setTextColor(71,85,105),u?.name&&(t.text(`Project: ${u.name}`,o,e),e+=5),u?.job_number&&(t.text(`Job #: ${u.job_number}`,o,e),e+=5),e+=15,t.setFillColor(248,250,252),t.setDrawColor(226,232,240),t.roundedRect(o,e,c-o*2,55,3,3,"FD"),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",o+10,e+12),t.setDrawColor(226,232,240),t.line(o+10,e+16,c-o-10,e+16);const l=o+15,C=o+80;let g=e+25;t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("T&M Tickets:",l,g),t.setFont("helvetica","bold"),t.text(String(T.length),C,g),t.setFont("helvetica","normal"),g+=7,t.text("Total Labor:",l,g),t.setFont("helvetica","bold"),t.text(`${s.totals.totalLaborHours.toFixed(1)} hrs`,C,g),t.setFont("helvetica","normal"),g+=7,s.totals.totalOTHours>0&&(t.text("Total OT:",l,g),t.setFont("helvetica","bold"),t.text(`${s.totals.totalOTHours.toFixed(1)} hrs`,C,g),t.setFont("helvetica","normal"),g+=7),t.text("Photo Evidence:",l,g),t.setFont("helvetica","bold"),t.text(`${s.totals.photoCount} photos`,C,g),t.setFont("helvetica","normal"),g+=7,t.text("Client Verified:",l,g),t.setFont("helvetica","bold");const W=s.totals.verifiedTicketCount>0?[16,185,129]:[71,85,105];t.setTextColor(...W),t.text(`${s.totals.verifiedTicketCount} of ${T.length} tickets`,C,g),e+=70,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const O=new Date(s.createdAt);t.text(`Generated: ${O.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${O.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,o,e),e+=6,t.text(`Document ID: ${s.checksum.substring(0,16).toUpperCase()}`,o,e);for(const i of T){t.addPage(),e=o;const E=!!i.client_signature_data,$=22,M=E?[16,185,129]:[245,158,11];if(t.setFillColor(...M),t.rect(o,e,4,$,"F"),t.setFillColor(248,250,252),t.rect(o+4,e,c-o*2-4,$,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`T&M TICKET — ${U(i.work_date||i.ticket_date)}`,o+10,e+8),i.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${i.ce_pco_number}`,o+10,e+16)),E&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",c-o-35,e+12)),e+=$+8,i.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",o,e),e+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const a=t.splitTextToSize(i.notes,c-o*2);t.text(a,o,e),e+=a.length*4+10}if(i.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",o,e),e+=6,F(t,{startY:e,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:i.t_and_m_workers.map(a=>[a.name,G(a),a.role||a.labor_class||"Laborer",a.hours?.toString()||"0",a.overtime_hours?.toString()||"-"]),margin:{left:o,right:o},headStyles:{fillColor:m,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),e=t.lastAutoTable.finalY+10),i.t_and_m_items?.length>0&&(e>_-60&&(t.addPage(),e=o),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",o,e),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: T&M Ticket",o+55,e),e+=6,F(t,{startY:e,head:[["Item","Qty","Unit"]],body:i.t_and_m_items.map(a=>[a.custom_name||a.materials_equipment?.name||a.description||"Unnamed Item",a.quantity?.toString()||"1",a.materials_equipment?.unit||a.unit||"ea"]),margin:{left:o,right:o},headStyles:{fillColor:m,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),e=t.lastAutoTable.finalY+10),i.photos?.length>0){e>_-80&&(t.addPage(),e=o),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",o,e),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${i.photos.length} photo${i.photos.length!==1?"s":""}`,o+50,e),e+=8;let a=o;const f=55,h=45,y=6,P=3;for(let x=0;x<i.photos.length;x++){x>0&&x%P===0&&(a=o,e+=h+y+4),e+h>_-20&&(t.addPage(),e=o,a=o);try{const z=await Y(i.photos[x]);z?(t.setDrawColor(200,200,200),t.setLineWidth(1),t.rect(a-1,e-1,f+2,h+2,"S"),t.setFillColor(230,230,230),t.rect(a+2,e+2,f,h,"F"),t.addImage(z,"JPEG",a,e,f,h)):(t.setFillColor(245,245,245),t.rect(a,e,f,h,"F"),t.setDrawColor(200,200,200),t.rect(a,e,f,h,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",a+8,e+h/2))}catch{t.setFillColor(245,245,245),t.rect(a,e,f,h,"F"),t.setDrawColor(200,200,200),t.rect(a,e,f,h,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",a+8,e+h/2)}a+=f+y}e+=h+12}if(i.client_signature_data){e>_-50&&(t.addPage(),e=o);const a=32,f=c-o*2;t.setFillColor(240,253,244),t.roundedRect(o,e,f,a,3,3,"F"),t.setFillColor(16,185,129),t.rect(o,e,4,a,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(o+4,e,o+f,e);const h=o+14,y=e+a/2;t.setFillColor(16,185,129),t.circle(h,y,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",h-2.5,y+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",o+26,e+10);try{t.addImage(i.client_signature_data,"PNG",o+26,e+13,50,16);const z=i.client_signature_name||"Client",D=i.client_signature_title||"",k=i.client_signature_company||"",L=i.client_signature_date?U(i.client_signature_date):"",I=o+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(z,I,e+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(D||k)&&t.text(`${D}${D&&k?", ":""}${k}`,I,e+18),L&&(t.setTextColor(100,116,139),t.text(`Verified: ${L}`,I,e+24))}catch{const x=i.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${x}`,o+26,e+20)}}}}const v=t.internal.getNumberOfPages();for(let l=1;l<=v;l++){t.setPage(l);const C=_-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,o,C),t.text(`Page ${l} of ${v}`,c-o,C,{align:"right"})}const R=`${n.cor_number||"COR"}_${u?.job_number||"export"}${T.length?"_with_backup":""}.pdf`;return t.save(R),{success:!0,fileName:R,pageCount:v,sizeBytes:t.output().length}}export{K as generatePDFFromSnapshot};
