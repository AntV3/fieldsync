import{H as Ce,I as xe,J as Fe,p as oe,q as e}from"./index-CNYT6krf.js";import{r as M,c as pe,aj as _e,j as G,D as he,F as je,H as be,ak as me,f as fe,N as Pe,l as De,B as Ie,q as Ne,y as Se,O as $e,b as ue}from"./icons-Bl--ZLwb.js";import{c as Te,a as ze,b as te,f as p,d as q,e as ae}from"./corCalculations-vdJc_BOT.js";import{E as we,a as se}from"./pdf-aQqpMATS.js";import{S as ve}from"./SignatureCanvas-pNbfu6sf.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const ye=o=>{if(!o)return"";const[j,N]=o.split(":"),S=parseInt(j),a=S>=12?"pm":"am";return`${S%12||12}:${N}${a}`},ke=o=>o.time_started&&o.time_ended?`${ye(o.time_started)} - ${ye(o.time_ended)}`:"-";async function Re(o){if(!o||o.length===0)return{totalPhotos:0,verified:0,failed:0,issues:[],manifest:[]};const j=[];let N=0,S=0;const a=[];for(const x of o)if(!(!x.photos||x.photos.length===0))for(const I of x.photos){const l={ticketId:x.id,workDate:x.work_date,url:I,verified:!1,error:null};try{await xe(I)?(l.verified=!0,N++):(l.error="Failed to load image",S++,a.push({ticketId:x.id,workDate:x.work_date,url:I,error:"Failed to load image"}))}catch(i){l.error=i.message||"Unknown error",S++,a.push({ticketId:x.id,workDate:x.work_date,url:I,error:l.error})}j.push(l)}return{totalPhotos:N+S,verified:N,failed:S,issues:a,manifest:j,allVerified:S===0,verifiedAt:new Date().toISOString()}}function Oe(o,j,N,S){const a=JSON.stringify({cor:o,tmTickets:j,photoManifest:N,totals:S});let x=0;for(let l=0;l<a.length;l++){const i=a.charCodeAt(l);x=(x<<5)-x+i,x=x&x}const I=Math.abs(x).toString(16).padStart(16,"0");return{cor_data:{id:o.id,cor_number:o.cor_number,title:o.title,description:o.description,status:o.status,created_at:o.created_at,submitted_at:o.submitted_at,labor_items:o.labor_items,material_items:o.material_items,equipment_items:o.equipment_items,gc_markup_percent:o.gc_markup_percent,profit_markup_percent:o.profit_markup_percent},tickets_data:(j||[]).map(l=>({id:l.id,work_date:l.work_date,ce_pco_number:l.ce_pco_number,notes:l.notes,status:l.status,created_at:l.created_at,workers:l.t_and_m_workers||[],items:l.t_and_m_items||[],photos:l.photos||[],client_signature_name:l.client_signature_name,client_signature_date:l.client_signature_date})),photos_manifest:N,totals_snapshot:S,checksum:I}}async function Ae(o,j,N,S={},a=null,x={}){const{verifyPhotos:I=!1,createSnapshot:l=!1}=x;let i=null;I&&a?.length>0&&(i=await Re(a));const t=new we,b=t.internal.pageSize.getWidth(),k=t.internal.pageSize.getHeight(),n=20;let s=n;const y=Te(o),c=S.primaryColor?Ce(S.primaryColor):[30,58,138],C=[241,245,249];let v=null;if(S.logoUrl)try{v=await xe(S.logoUrl)}catch(u){console.error("Error loading logo:",u)}if(v)try{t.addImage(v,"PNG",n,s,40,15),s+=20}catch{t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(N?.name||"Company Name",n,s+10),s+=20}else t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(N?.name||"Company Name",n,s+10),s+=20;t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("CHANGE ORDER REQUEST",n,s),s+=10,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(100,100,100),t.text(o.cor_number||"COR-XXXX",n,s);const L=o.status?.replace("_"," ").toUpperCase()||"DRAFT";t.setTextColor(...c),t.text(L,b-n-t.getTextWidth(L),s),s+=12,t.setDrawColor(...c),t.setLineWidth(.5),t.line(n,s,b-n,s),s+=10,t.setFontSize(10),t.setTextColor(0,0,0);const $=n,W=b/2;t.setFont("helvetica","bold"),t.text("Project:",$,s),t.setFont("helvetica","normal"),t.text(j?.name||"Project Name",$+25,s),t.setFont("helvetica","bold"),t.text("Job #:",W,s),t.setFont("helvetica","normal"),t.text(j?.job_number||"N/A",W+25,s),s+=6,t.setFont("helvetica","bold"),t.text("Period:",$,s),t.setFont("helvetica","normal"),t.text(ze(o.period_start,o.period_end),$+25,s),t.setFont("helvetica","bold"),t.text("Date:",W,s),t.setFont("helvetica","normal"),t.text(te(o.created_at),W+25,s),s+=10,t.setFont("helvetica","bold"),t.setFontSize(12),t.text(o.title||"Untitled Change Order",n,s),s+=8,t.setFont("helvetica","normal"),t.setFontSize(10),t.setTextColor(80,80,80);const O=t.splitTextToSize(o.scope_of_work||"No scope of work provided.",b-n*2);t.text(O,n,s),s+=O.length*5+10,o.change_order_labor?.length>0&&(t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("LABOR",n,s),s+=6,se(t,{startY:s,head:[["Class","Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:o.change_order_labor.map(u=>[u.labor_class,u.wage_type,u.regular_hours.toString(),`$${ae(u.regular_rate)}/hr`,u.overtime_hours?.toString()||"-",u.overtime_hours?`$${ae(u.overtime_rate)}/hr`:"-",p(u.total)]),foot:[[{content:`Subtotal: ${p(y.labor_subtotal)}`,colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(o.labor_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:p(y.labor_subtotal+y.labor_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),o.change_order_materials?.length>0&&(s>k-80&&(t.addPage(),s=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("MATERIALS",n,s),s+=6,se(t,{startY:s,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:o.change_order_materials.map(u=>[u.description,u.source_reference||u.source_type,u.quantity.toString(),u.unit,`$${ae(u.unit_cost)}`,p(u.total)]),foot:[[{content:`Subtotal: ${p(y.materials_subtotal)}`,colSpan:4,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(o.materials_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:p(y.materials_subtotal+y.materials_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),o.change_order_equipment?.length>0&&(s>k-80&&(t.addPage(),s=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("EQUIPMENT",n,s),s+=6,se(t,{startY:s,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:o.change_order_equipment.map(u=>[u.description,u.source_reference||u.source_type,u.quantity.toString(),u.unit,`$${ae(u.unit_cost)}`,p(u.total)]),foot:[[{content:`Subtotal: ${p(y.equipment_subtotal)}`,colSpan:4,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(o.equipment_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:p(y.equipment_subtotal+y.equipment_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),o.change_order_subcontractors?.length>0&&(s>k-80&&(t.addPage(),s=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("SUBCONTRACTORS",n,s),s+=6,se(t,{startY:s,head:[["Company","Description","Source","Amount"]],body:o.change_order_subcontractors.map(u=>[u.company_name,u.description,u.source_reference||u.source_type,p(u.total)]),foot:[[{content:`Subtotal: ${p(y.subcontractors_subtotal)}`,colSpan:2,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(o.subcontractors_markup_percent||500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:p(y.subcontractors_subtotal+y.subcontractors_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),s>k-100&&(t.addPage(),s=n),t.setFillColor(...C),t.roundedRect(n,s,b-n*2,70,3,3,"F"),s+=10,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(0,0,0);const A=n+10,H=b-n-60;t.text("COR Subtotal:",A,s),t.setFont("helvetica","bold"),t.text(p(y.cor_subtotal),H,s,{align:"right"}),s+=8,t.setFont("helvetica","normal"),t.setFontSize(9),t.text(`Liability Insurance (${q(o.liability_insurance_percent||144)}):`,A,s),t.text(p(y.liability_insurance_amount),H,s,{align:"right"}),s+=6,t.text(`Bond (${q(o.bond_percent||100)}):`,A,s),t.text(p(y.bond_amount),H,s,{align:"right"}),s+=6,t.text(`City License Fee (${q(o.license_fee_percent||10)}):`,A,s),t.text(p(y.license_fee_amount),H,s,{align:"right"}),s+=10,t.setFillColor(...c),t.roundedRect(A-5,s-3,b-n*2-10,16,2,2,"F"),t.setTextColor(255,255,255),t.setFontSize(12),t.setFont("helvetica","bold"),t.text("COR TOTAL:",A,s+8),t.text(p(y.cor_total),H,s+8,{align:"right"}),s+=25,s>k-120&&(t.addPage(),s=n),s+=10,t.setTextColor(0,0,0),t.setFontSize(10),t.setFont("helvetica","bold"),t.text("AUTHORIZATION",n,s),s+=15,t.setFont("helvetica","normal"),t.setFontSize(9),t.setDrawColor(0,0,0);const ne=(u,V,Y,J,Z,T,z)=>{t.setFont("helvetica","bold"),t.setFontSize(8),t.text(V,n,u),t.setFont("helvetica","normal"),t.setFontSize(9);const D=u+20;if(t.line(n,D,n+70,D),t.text("Signature",n,D+8),t.line(n+85,D,n+145,D),t.text("Title / Company",n+85,D+8),t.line(b-n-40,D,b-n,D),t.text("Date",b-n-40,D+8),Y)try{if(t.addImage(Y,"PNG",n,D-18,60,18),J&&(t.setFontSize(8),t.text(J,n,D+15)),Z||T){const R=[Z,T].filter(Boolean).join(" - ");t.text(R,n+85,D-5)}z&&t.text(te(z),b-n-40,D-5)}catch(R){console.error("Error adding signature:",R)}else t.setFont("helvetica","italic"),t.setFontSize(9),t.setTextColor(150,150,150),t.text("Awaiting Signature",n+5,D-5),t.setTextColor(0,0,0),t.setFont("helvetica","normal");return D+25};if(s=ne(s,"GC AUTHORIZATION",o.gc_signature_data||o.gc_signature,o.gc_signature_name||o.gc_signer_name,o.gc_signature_title,o.gc_signature_company,o.gc_signature_date||o.signed_at),s+=10,s=ne(s,"CLIENT AUTHORIZATION",o.client_signature_data,o.client_signature_name,o.client_signature_title,o.client_signature_company,o.client_signature_date),a&&a.length>0){const u=a.reduce((m,r)=>m+(r.t_and_m_workers?.reduce((_,g)=>_+(parseFloat(g.hours)||0),0)||0),0),V=a.reduce((m,r)=>m+(r.t_and_m_workers?.reduce((_,g)=>_+(parseFloat(g.overtime_hours)||0),0)||0),0),Y=a.reduce((m,r)=>m+(r.photos?.length||0),0),J=a.filter(m=>m.client_signature_data).length,Z=a.length>0?{start:a.reduce((m,r)=>!m||r.work_date<m?r.work_date:m,null),end:a.reduce((m,r)=>!m||r.work_date>m?r.work_date:m,null)}:null,T=new Uint8Array(3);crypto.getRandomValues(T);const z=Array.from(T,m=>m.toString(36)).join("").toUpperCase().substring(0,4),D=`FS-${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}${String(new Date().getDate()).padStart(2,"0")}-${z}`;if(t.addPage(),s=n,v)try{t.addImage(v,"PNG",n,s,50,18)}catch{t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(N?.name||"Company Name",n,s+10)}else t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(N?.name||"Company Name",n,s+10);s+=35,t.setDrawColor(...c),t.setLineWidth(.8),t.line(n,s,b-n,s),t.setLineWidth(.3),t.line(n,s+3,b-n,s+3),s+=15,t.setFontSize(22),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",b/2,s,{align:"center"}),s+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Change Order Request Backup",b/2,s,{align:"center"}),s+=8,t.setDrawColor(...c),t.setLineWidth(.3),t.line(n,s,b-n,s),t.setLineWidth(.8),t.line(n,s+3,b-n,s+3),s+=20,t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("COR Reference:",n,s),t.setFont("helvetica","normal"),t.text(o.cor_number||"N/A",n+35,s),t.setFont("helvetica","bold"),t.text("Project:",b/2,s),t.setFont("helvetica","normal"),t.text(j?.name||"N/A",b/2+20,s),s+=7,t.setFont("helvetica","bold"),t.text("Job #:",n,s),t.setFont("helvetica","normal"),t.text(j?.job_number||"N/A",n+35,s),s+=20,t.setFillColor(248,250,252),t.setDrawColor(203,213,225),t.roundedRect(n,s,b-n*2,65,4,4,"FD"),s+=10,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",n+10,s),t.setDrawColor(203,213,225),t.setLineWidth(.3),t.line(n+10,s+3,n+80,s+3),s+=12,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(71,85,105);const R=n+15,K=n+70;t.text("T&M Tickets:",R,s),t.setFont("helvetica","bold"),t.text(String(a.length),K,s),t.setFont("helvetica","normal"),s+=7,t.text("Total Labor:",R,s),t.setFont("helvetica","bold"),t.text(`${u.toFixed(1)} hrs`,K,s),t.setFont("helvetica","normal"),s+=7,V>0&&(t.text("Total OT:",R,s),t.setFont("helvetica","bold"),t.text(`${V.toFixed(1)} hrs`,K,s),t.setFont("helvetica","normal"),s+=7),t.text("Photo Evidence:",R,s),t.setFont("helvetica","bold"),t.text(`${Y} photos`,K,s),t.setFont("helvetica","normal"),s+=7,t.text("Client Verified:",R,s),t.setFont("helvetica","bold"),t.setTextColor(J>0?16:71,J>0?185:85,J>0?129:105),t.text(`${J} of ${a.length} tickets`,K,s),t.setTextColor(71,85,105),t.setFont("helvetica","normal"),s+=7,Z?.start&&Z?.end&&(t.text("Date Range:",R,s),t.setFont("helvetica","bold"),t.text(`${te(Z.start)} - ${te(Z.end)}`,K,s)),s+=30,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const E=new Date;t.text(`Generated: ${E.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${E.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,n,s),s+=6,t.text(`Document ID: ${D}`,n,s);for(const m of a){t.addPage(),s=n;const r=!!m.client_signature_data,_=22,g=r?[16,185,129]:m.status==="approved"?[16,185,129]:[245,158,11];if(t.setFillColor(...g),t.rect(n,s,4,_,"F"),t.setFillColor(248,250,252),t.rect(n+4,s,b-n*2-4,_,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`T&M TICKET — ${te(m.work_date)}`,n+10,s+8),m.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${m.ce_pco_number}`,n+10,s+16)),r&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",b-n-35,s+12)),s+=_+8,m.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",n,s),s+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const h=t.splitTextToSize(m.notes,b-n*2);t.text(h,n,s),s+=h.length*4+10}if(m.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",n,s),s+=6,se(t,{startY:s,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:m.t_and_m_workers.map(h=>[h.name,ke(h),h.role||h.labor_class||"Laborer",h.hours?.toString()||"0",h.overtime_hours?.toString()||"-"]),margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=t.lastAutoTable.finalY+10),m.t_and_m_items?.length>0&&(s>k-60&&(t.addPage(),s=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",n,s),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: T&M Ticket",n+55,s),s+=6,se(t,{startY:s,head:[["Item","Qty","Unit","Unit Cost","Total"]],body:m.t_and_m_items.map(h=>[h.materials_equipment?.name||h.description||"Item",h.quantity?.toString()||"1",h.materials_equipment?.unit||"ea",h.materials_equipment?.cost_per_unit?`$${h.materials_equipment.cost_per_unit}`:"-",h.materials_equipment?.cost_per_unit&&h.quantity?`$${(h.quantity*h.materials_equipment.cost_per_unit).toFixed(2)}`:"-"]),margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=t.lastAutoTable.finalY+10),m.photos?.length>0){s>k-80&&(t.addPage(),s=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",n,s),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${m.photos.length} photo${m.photos.length!==1?"s":""}`,n+50,s),s+=8;let h=n;const d=55,w=45,U=6,Q=3,B=1,f=await Fe(m.photos);for(let P=0;P<m.photos.length;P++){P>0&&P%Q===0&&(h=n,s+=w+U+4),s+w>k-20&&(t.addPage(),s=n,h=n);const ee=f[P];ee?(t.setDrawColor(200,200,200),t.setLineWidth(B),t.rect(h-B,s-B,d+B*2,w+B*2,"S"),t.setFillColor(230,230,230),t.rect(h+2,s+2,d,w,"F"),t.addImage(ee,"JPEG",h,s,d,w)):(t.setFillColor(245,245,245),t.rect(h,s,d,w,"F"),t.setDrawColor(200,200,200),t.rect(h,s,d,w,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",h+8,s+w/2)),h+=d+U}s+=w+12}if(m.client_signature_data){s>k-50&&(t.addPage(),s=n);const h=32,d=b-n*2;t.setFillColor(240,253,244),t.roundedRect(n,s,d,h,3,3,"F"),t.setFillColor(16,185,129),t.rect(n,s,4,h,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(n+4,s,n+d,s);const w=n+14,U=s+h/2;t.setFillColor(16,185,129),t.circle(w,U,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",w-2.5,U+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",n+26,s+10);try{t.addImage(m.client_signature_data,"PNG",n+26,s+13,50,16);const f=m.client_signature_name||"Client",P=m.client_signature_title||"",ee=m.client_signature_company||"",ge=m.client_signature_date?te(m.client_signature_date):"",de=n+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(f,de,s+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(P||ee)&&t.text(`${P}${P&&ee?", ":""}${ee}`,de,s+18),ge&&(t.setTextColor(100,116,139),t.text(`Verified: ${ge}`,de,s+24))}catch{const B=m.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${B}`,n+26,s+20)}s+=h+8}s+=5,t.setDrawColor(200,200,200),t.setLineWidth(.2),t.line(n,s,b-n,s),s+=10}}const X=t.internal.getNumberOfPages();for(let u=1;u<=X;u++){t.setPage(u);const V=k-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,n,V),t.text(`Page ${u} of ${X}`,b-n,V,{align:"right"})}const F=`${o.cor_number||"COR"}_${j?.job_number||"export"}${a?.length?"_with_backup":""}.pdf`;t.save(F);const re={success:!0,fileName:F,exportedAt:new Date().toISOString(),photoManifest:i};return l&&(re.snapshot=Oe(o,a,i,y)),re}async function Ee(o,j,N,S={}){const a=new we("p","mm","letter"),x=a.internal.pageSize.getWidth(),I=a.internal.pageSize.getHeight(),l=20;let i=l;const t=S.primaryColor?Ce(S.primaryColor):[30,58,95];if(S.logoUrl)try{const c=await xe(S.logoUrl);c&&a.addImage(c,"PNG",l,i,40,15)}catch{N?.name&&(a.setFontSize(14),a.setFont("helvetica","bold"),a.setTextColor(...t),a.text(N.name,l,i+8))}else N?.name&&(a.setFontSize(14),a.setFont("helvetica","bold"),a.setTextColor(...t),a.text(N.name,l,i+8));if(a.setFontSize(16),a.setFont("helvetica","bold"),a.setTextColor(30,41,59),a.text("T&M TICKET",x-l,i+8,{align:"right"}),i+=25,a.setDrawColor(...t),a.setLineWidth(.5),a.line(l,i,x-l,i),i+=10,!!o.client_signature_data&&(a.setFillColor(240,253,244),a.roundedRect(x-l-45,i-5,45,12,2,2,"F"),a.setFontSize(9),a.setFont("helvetica","bold"),a.setTextColor(16,185,129),a.text("✓ CLIENT VERIFIED",x-l-42,i+3)),a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("Project:",l,i),a.setFont("helvetica","normal"),a.setTextColor(30,41,59),a.text(j?.name||"N/A",l+20,i),i+=6,j?.job_number&&(a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("Job #:",l,i),a.setFont("helvetica","normal"),a.setTextColor(30,41,59),a.text(j.job_number,l+20,i),i+=6),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("Work Date:",l,i),a.setFont("helvetica","normal"),a.setTextColor(30,41,59),a.text(te(o.work_date||o.ticket_date),l+26,i),o.ce_pco_number&&(a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("CE/PCO:",l+70,i),a.setFont("helvetica","normal"),a.setTextColor(59,130,246),a.text(o.ce_pco_number,l+88,i)),i+=12,o.notes){a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("DESCRIPTION",l,i),i+=6,a.setFontSize(9),a.setFont("helvetica","normal"),a.setTextColor(51,65,85);const c=a.splitTextToSize(o.notes,x-l*2);a.text(c,l,i),i+=c.length*4+10}o.t_and_m_workers?.length>0&&(a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("LABOR",l,i),i+=6,se(a,{startY:i,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:o.t_and_m_workers.map(c=>[c.name,ke(c),c.role||c.labor_class||"Laborer",c.hours?.toString()||"0",c.overtime_hours?.toString()||"-"]),margin:{left:l,right:l},headStyles:{fillColor:t,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),i=a.lastAutoTable.finalY+10);const k=o.t_and_m_items||o.materials_equipment?.filter(c=>c.type==="material")||[];if(k.length>0&&(i>I-60&&(a.addPage(),i=l),a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("MATERIALS / EQUIPMENT",l,i),i+=6,se(a,{startY:i,head:[["Item","Qty","Unit"]],body:k.map(c=>[c.materials_equipment?.name||c.description||c.name||"Item",c.quantity?.toString()||"1",c.materials_equipment?.unit||c.unit||"ea"]),margin:{left:l,right:l},headStyles:{fillColor:t,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),i=a.lastAutoTable.finalY+10),o.photos?.length>0){i>I-80&&(a.addPage(),i=l),a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("PHOTO DOCUMENTATION",l,i),a.setFontSize(8),a.setFont("helvetica","normal"),a.setTextColor(59,130,246),a.text(`${o.photos.length} photo${o.photos.length!==1?"s":""}`,l+50,i),i+=8;let c=l;const C=55,v=45,L=6,$=3,W=await Fe(o.photos);for(let O=0;O<o.photos.length;O++){O>0&&O%$===0&&(c=l,i+=v+L+4),i+v>I-20&&(a.addPage(),i=l,c=l);const A=W[O];A?(a.setDrawColor(200,200,200),a.setLineWidth(1),a.rect(c-1,i-1,C+2,v+2,"S"),a.setFillColor(230,230,230),a.rect(c+2,i+2,C,v,"F"),a.addImage(A,"JPEG",c,i,C,v)):(a.setFillColor(245,245,245),a.rect(c,i,C,v,"F"),a.setDrawColor(200,200,200),a.rect(c,i,C,v,"S"),a.setFontSize(7),a.setTextColor(150,150,150),a.text("Photo unavailable",c+8,i+v/2)),c+=C+L}i+=v+12}if(o.client_signature_data){i>I-50&&(a.addPage(),i=l);const c=32,C=x-l*2;a.setFillColor(240,253,244),a.roundedRect(l,i,C,c,3,3,"F"),a.setFillColor(16,185,129),a.rect(l,i,4,c,"F"),a.setDrawColor(187,247,208),a.setLineWidth(.5),a.line(l+4,i,l+C,i);const v=l+14,L=i+c/2;a.setFillColor(16,185,129),a.circle(v,L,6,"F"),a.setFontSize(9),a.setTextColor(255,255,255),a.text("✓",v-2.5,L+3),a.setFontSize(9),a.setFont("helvetica","bold"),a.setTextColor(16,185,129),a.text("CLIENT VERIFIED",l+26,i+10);try{a.addImage(o.client_signature_data,"PNG",l+26,i+13,50,16);const O=o.client_signature_name||"Client",A=o.client_signature_title||"",H=o.client_signature_company||"",ne=o.client_signature_date?te(o.client_signature_date):"",X=l+85;a.setFont("helvetica","bold"),a.setFontSize(9),a.setTextColor(30,41,59),a.text(O,X,i+12),a.setFont("helvetica","normal"),a.setFontSize(8),a.setTextColor(71,85,105),(A||H)&&a.text(`${A}${A&&H?", ":""}${H}`,X,i+18),ne&&(a.setTextColor(100,116,139),a.text(`Verified: ${ne}`,X,i+24))}catch{const W=o.client_signature_name||"Client";a.setFont("helvetica","normal"),a.setFontSize(9),a.setTextColor(30,41,59),a.text(`Signed by: ${W}`,l+26,i+20)}i+=c+8}const n=a.internal.getNumberOfPages();for(let c=1;c<=n;c++){a.setPage(c);const C=I-10;a.setFontSize(8),a.setTextColor(150,150,150),a.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,l,C),a.text(`Page ${c} of ${n}`,x-l,C,{align:"right"})}const y=`TM_Ticket_${te(o.work_date||o.ticket_date).replace(/\//g,"-")}${o.ce_pco_number?"_"+o.ce_pco_number:""}.pdf`;return a.save(y),{success:!0,fileName:y}}const le=o=>o?new Date(o).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"",ie=o=>{if(!o)return"";const[j,N]=o.split(":"),S=parseInt(j),a=S>=12?"pm":"am";return`${S%12||12}:${N}${a}`},Me=({status:o})=>{const j={draft:{label:"Draft",color:"#6b7280",bg:"#f3f4f6"},pending_approval:{label:"Pending Approval",color:"#d97706",bg:"#fef3c7"},approved:{label:"Approved",color:"#059669",bg:"#d1fae5"},rejected:{label:"Rejected",color:"#dc2626",bg:"#fee2e2"},billed:{label:"Billed",color:"#2563eb",bg:"#dbeafe"},closed:{label:"Closed",color:"#4b5563",bg:"#e5e7eb"}},N=j[o]||j.draft;return e.jsx("span",{className:"cor-status-badge",style:{color:N.color,backgroundColor:N.bg},children:N.label})};function Ge({signatureToken:o}){const[j,N]=M.useState(!0),[S,a]=M.useState(null),[x,I]=M.useState(null),[l,i]=M.useState(null),[t,b]=M.useState(!1),[k,n]=M.useState(null),[s,y]=M.useState(!1),[c,C]=M.useState(null),[v,L]=M.useState(!1),[$,W]=M.useState([]),[O,A]=M.useState(!1),[H,ne]=M.useState(new Set);M.useEffect(()=>{X()},[o]);const X=async()=>{try{N(!0),a(null);const r=await oe.getSignatureRequestByToken(o);if(!r){a("This signature link is invalid or has expired.");return}if(r.status==="completed"){a("This document has already been fully signed.");return}if(r.status==="revoked"){a("This signature link has been revoked.");return}if(r.status==="expired"){a("This signature link has expired.");return}I(r);const _=await oe.getDocumentForSigning(r.document_type,r.document_id);if(!_){a("The document associated with this link could not be found.");return}if(i(_),r.document_type==="cor"&&_?.id)try{const g=await oe.getCORTickets(_.id);W(g||[])}catch(g){console.warn("Failed to load backup tickets:",g)}}catch(r){console.error("Error loading signature data:",r),a("Unable to load signature request. Please try again.")}finally{N(!1)}},F=M.useMemo(()=>!l||x?.document_type!=="cor"?null:Te(l),[l,x]),re=()=>{if(!x)return{slot1:null,slot2:null,availableSlots:[]};const r=x.signatures||[],_=r.find(d=>d.signature_slot===1),g=r.find(d=>d.signature_slot===2),h=[];return _||h.push(1),g||h.push(2),{slot1:_,slot2:g,availableSlots:h}},u=async()=>{try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch{return null}},V=async r=>{if(!(!x||!k))try{y(!0);const _=await u(),g=await oe.addSignature(x.id,k,{...r,ipAddress:_,userAgent:navigator.userAgent});await oe.syncSignatureToDocument(g,x),await X(),b(!1),n(null),C("signed")}catch(_){console.error("Error submitting signature:",_),a("Failed to submit signature. Please try again.")}finally{y(!1)}},Y=r=>{n(r),b(!0)},J=async()=>{if(!(!l||!x))try{L(!0);let r=null;if(K)try{r=await oe.getCORTickets(l.id)}catch(g){console.warn("Failed to fetch T&M tickets for backup:",g)}const _={logoUrl:E?.logo_url,primaryColor:E?.branding_color};await Ae(l,m,E,_,r),C("PDF downloaded successfully!"),setTimeout(()=>C(null),3e3)}catch(r){console.error("Download failed:",r),a("Failed to generate PDF. Please try again.")}finally{L(!1)}},Z=async()=>{if(!(!l||!x))try{L(!0);const r=l?.projects?.companies,_=l?.projects,g={logoUrl:r?.logo_url,primaryColor:r?.branding_color};await Ee(l,_,r,g),C("PDF downloaded successfully!"),setTimeout(()=>C(null),3e3)}catch(r){console.error("Download failed:",r),a("Failed to generate PDF. Please try again.")}finally{L(!1)}};if(j)return e.jsx("div",{className:"signature-page",children:e.jsxs("div",{className:"signature-page-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading document..."})]})});if(S)return e.jsx("div",{className:"signature-page",children:e.jsxs("div",{className:"signature-page-error",children:[e.jsx(pe,{size:48}),e.jsx("h2",{children:"Unable to Load Document"}),e.jsx("p",{children:S})]})});const{slot1:T,slot2:z,availableSlots:D}=re(),R=T||z,K=x?.document_type==="cor",E=l?.projects?.companies,m=l?.projects;if(!K){const r=l.t_and_m_workers?.length||0,_=l.t_and_m_workers?.reduce((g,h)=>g+(h.hours||0),0)||0;return e.jsxs("div",{className:"signature-page",children:[e.jsxs("header",{className:"signature-page-header",children:[E?.logo_url?e.jsx("img",{src:E.logo_url,alt:E.name,className:"company-logo"}):e.jsx("div",{className:"company-logo-placeholder",children:e.jsx(_e,{size:24})}),e.jsxs("div",{className:"company-info",children:[e.jsx("h1",{children:E?.name||"FieldSync"}),e.jsx("span",{className:"doc-type-label",children:"T&M Ticket Signature"})]})]}),c==="signed"&&e.jsx("div",{className:"signature-signed-overlay",children:e.jsxs("div",{className:"signature-signed-content",children:[e.jsx(G,{size:48}),e.jsx("h2",{children:"Document Signed Successfully"}),e.jsx("p",{children:"This document has been signed and submitted."}),e.jsx("button",{className:"btn btn-primary download-copy-btn",onClick:Z,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{size:18}),"Save a Copy for Your Records"]})}),e.jsx("p",{className:"close-prompt",children:"You may close this page when done."})]})}),e.jsxs("main",{className:"signature-page-content",children:[e.jsxs("div",{className:"signature-document-card",children:[e.jsxs("div",{className:"document-card-header",children:[e.jsx(je,{size:20}),e.jsxs("div",{className:"document-card-title",children:[e.jsx("h2",{children:"T&M Ticket"}),e.jsx("span",{className:"document-subtitle",children:l.ce_pco_number?`CE/PCO: ${l.ce_pco_number}`:"Time & Materials"})]})]}),e.jsxs("div",{className:"document-card-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Project"}),e.jsx("span",{className:"detail-value",children:m?.name})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Work Date"}),e.jsx("span",{className:"detail-value",children:le(l.work_date)})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Workers"}),e.jsxs("span",{className:"detail-value",children:[r," (",_," hrs)"]})]}),l.notes&&e.jsxs("div",{className:"detail-row full-width",children:[e.jsx("span",{className:"detail-label",children:"Description"}),e.jsx("span",{className:"detail-value",children:l.notes})]})]}),l.t_and_m_workers?.length>0&&e.jsxs("div",{className:"signature-detail-section",children:[e.jsxs("h4",{children:[e.jsx(be,{size:16})," Workers"]}),e.jsxs("table",{className:"signature-detail-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT"})]})}),e.jsx("tbody",{children:l.t_and_m_workers.map((g,h)=>e.jsxs("tr",{children:[e.jsx("td",{children:g.name}),e.jsx("td",{children:g.role||"Laborer"}),e.jsx("td",{children:g.time_started&&g.time_ended?`${ie(g.time_started)} - ${ie(g.time_ended)}`:"-"}),e.jsx("td",{children:g.hours||0}),e.jsx("td",{children:g.overtime_hours||"-"})]},h))})]})]}),l.t_and_m_items?.length>0&&e.jsxs("div",{className:"signature-detail-section",children:[e.jsxs("h4",{children:[e.jsx(me,{size:16})," Materials & Equipment"]}),e.jsxs("table",{className:"signature-detail-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"})]})}),e.jsx("tbody",{children:l.t_and_m_items.map((g,h)=>e.jsxs("tr",{children:[e.jsx("td",{children:g.custom_name||g.materials_equipment?.name||"Item"}),e.jsx("td",{children:g.quantity}),e.jsx("td",{children:g.materials_equipment?.unit||"each"})]},h))})]})]}),l.photos?.length>0&&e.jsxs("div",{className:"signature-detail-section",children:[e.jsxs("h4",{children:[e.jsx(fe,{size:16})," Photos (",l.photos.length,")"]}),e.jsx("div",{className:"signature-photo-grid",children:l.photos.map((g,h)=>e.jsx("div",{className:"signature-photo-thumb",children:e.jsx("img",{src:typeof g=="string"?g:g.url,alt:`Photo ${h+1}`,onError:d=>{d.target.style.display="none"}})},h))})]})]}),e.jsxs("div",{className:"signature-status-section",children:[e.jsx("h3",{children:"Signature"}),R?e.jsxs(e.Fragment,{children:[T&&ce(1,T,"GC Authorization",Y,s),z&&ce(2,z,"Client Authorization",Y,s)]}):e.jsxs(e.Fragment,{children:[ce(1,T,"GC Authorization",Y,s),!T&&e.jsx("p",{className:"or-divider",children:"— or —"}),ce(2,z,"Client Authorization",Y,s)]}),R&&e.jsxs("div",{className:"fully-signed-message",children:[e.jsx(G,{size:24}),e.jsx("p",{children:"This document has been signed."})]})]})]}),e.jsx("footer",{className:"signature-page-footer",children:e.jsx("p",{children:"Powered by FieldSync"})}),t&&k&&e.jsx(ve,{enhanced:!0,requireAcknowledgment:!0,lockBodyScroll:!0,slot:k,documentType:"tm_ticket",documentTitle:"T&M Ticket",onSave:V,onClose:()=>{b(!1),n(null)}})]})}return e.jsxs("div",{className:"signature-page",children:[e.jsxs("header",{className:"signature-page-header",children:[E?.logo_url?e.jsx("img",{src:E.logo_url,alt:E.name,className:"company-logo"}):e.jsx("div",{className:"company-logo-placeholder",children:e.jsx(_e,{size:24})}),e.jsxs("div",{className:"company-info",children:[e.jsx("h1",{children:E?.name||"FieldSync"}),e.jsx("span",{className:"doc-type-label",children:"Change Order Request"})]})]}),c==="signed"&&e.jsx("div",{className:"signature-signed-overlay",children:e.jsxs("div",{className:"signature-signed-content",children:[e.jsx(G,{size:48}),e.jsx("h2",{children:"Document Signed Successfully"}),e.jsx("p",{children:"This document has been signed and submitted."}),e.jsx("button",{className:"btn btn-primary download-copy-btn",onClick:J,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{size:18}),"Save a Copy for Your Records"]})}),e.jsx("p",{className:"close-prompt",children:"You may close this page when done."})]})}),e.jsxs("main",{className:"signature-page-content cor-full-document",children:[e.jsxs("div",{className:"cor-header-card",children:[e.jsxs("div",{className:"cor-header-top",children:[e.jsxs("div",{className:"cor-title-section",children:[e.jsx("h2",{className:"cor-number",children:l.cor_number}),e.jsx(Me,{status:l.status})]}),e.jsxs("div",{className:"cor-date",children:["Created ",le(l.created_at)]})]}),e.jsx("h3",{className:"cor-title",children:l.title||"Untitled Change Order"}),e.jsxs("div",{className:"cor-info-grid",children:[e.jsxs("div",{className:"cor-info-item",children:[e.jsx("span",{className:"cor-info-label",children:"Project"}),e.jsx("span",{className:"cor-info-value",children:m?.name})]}),m?.job_number&&e.jsxs("div",{className:"cor-info-item",children:[e.jsx("span",{className:"cor-info-label",children:"Job #"}),e.jsx("span",{className:"cor-info-value",children:m.job_number})]}),e.jsxs("div",{className:"cor-info-item",children:[e.jsx("span",{className:"cor-info-label",children:"Period"}),e.jsx("span",{className:"cor-info-value",children:ze(l.period_start,l.period_end)})]})]}),l.scope_of_work&&e.jsxs("div",{className:"cor-scope",children:[e.jsx("h4",{children:"Scope of Work"}),e.jsx("p",{children:l.scope_of_work})]})]}),l.change_order_labor?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(Pe,{size:18}),e.jsx("h4",{children:"Labor"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{className:"text-right",children:"Reg Hrs"}),e.jsx("th",{className:"text-right",children:"Reg Rate"}),e.jsx("th",{className:"text-right",children:"OT Hrs"}),e.jsx("th",{className:"text-right",children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:l.change_order_labor.map((r,_)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.labor_class}),e.jsx("td",{children:r.wage_type}),e.jsx("td",{className:"text-right",children:r.regular_hours}),e.jsxs("td",{className:"text-right",children:["$",ae(r.regular_rate),"/hr"]}),e.jsx("td",{className:"text-right",children:r.overtime_hours||"-"}),e.jsx("td",{className:"text-right",children:r.overtime_hours?`$${ae(r.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:p(r.total)})]},_))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.labor_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"5",className:"text-right",children:["+ ",q(l.labor_markup_percent||1500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.labor_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"5",className:"text-right",children:e.jsx("strong",{children:"Labor Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:p(F.labor_subtotal+F.labor_markup_amount)})})]})]})]})})]}),l.change_order_materials?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(me,{size:18}),e.jsx("h4",{children:"Materials"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{className:"text-right",children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:l.change_order_materials.map((r,_)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{className:"text-right",children:r.quantity}),e.jsx("td",{children:r.unit}),e.jsxs("td",{className:"text-right",children:["$",ae(r.unit_cost)]}),e.jsx("td",{className:"text-right",children:p(r.total)})]},_))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"4",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.materials_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"4",className:"text-right",children:["+ ",q(l.materials_markup_percent||1500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.materials_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"4",className:"text-right",children:e.jsx("strong",{children:"Materials Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:p(F.materials_subtotal+F.materials_markup_amount)})})]})]})]})})]}),l.change_order_equipment?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(De,{size:18}),e.jsx("h4",{children:"Equipment"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{className:"text-right",children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:l.change_order_equipment.map((r,_)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{className:"text-right",children:r.quantity}),e.jsx("td",{children:r.unit}),e.jsxs("td",{className:"text-right",children:["$",ae(r.unit_cost)]}),e.jsx("td",{className:"text-right",children:p(r.total)})]},_))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"4",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.equipment_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"4",className:"text-right",children:["+ ",q(l.equipment_markup_percent||1500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.equipment_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"4",className:"text-right",children:e.jsx("strong",{children:"Equipment Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:p(F.equipment_subtotal+F.equipment_markup_amount)})})]})]})]})})]}),l.change_order_subcontractors?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(Ie,{size:18}),e.jsx("h4",{children:"Subcontractors"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:l.change_order_subcontractors.map((r,_)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.company_name}),e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{className:"text-right",children:p(r.total)})]},_))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"2",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.subcontractors_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"2",className:"text-right",children:["+ ",q(l.subcontractors_markup_percent||500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:p(F.subcontractors_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"2",className:"text-right",children:e.jsx("strong",{children:"Subcontractors Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:p(F.subcontractors_subtotal+F.subcontractors_markup_amount)})})]})]})]})})]}),$.length>0&&(()=>{const r=$.reduce((d,w)=>d+(w.t_and_m_workers?.reduce((U,Q)=>U+(parseFloat(Q.hours)||0),0)||0),0),_=$.reduce((d,w)=>d+(w.t_and_m_workers?.reduce((U,Q)=>U+(parseFloat(Q.overtime_hours)||0),0)||0),0),g=$.reduce((d,w)=>d+(w.photos?.length||0),0),h=$.filter(d=>d.client_signature_data).length;return e.jsxs("div",{className:"cor-section cor-backup-section",children:[e.jsxs("div",{className:"backup-official-header",children:[e.jsxs("div",{className:"backup-official-badge",children:[e.jsx(je,{size:16}),e.jsx("span",{children:"Supporting Documentation"})]}),e.jsxs("div",{className:"backup-summary-bar",children:[e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:$.length}),e.jsx("span",{className:"backup-stat-label",children:"Tickets"})]}),e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:r.toFixed(1)}),e.jsx("span",{className:"backup-stat-label",children:"Labor Hrs"})]}),_>0&&e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:_.toFixed(1)}),e.jsx("span",{className:"backup-stat-label",children:"OT Hrs"})]}),e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:g}),e.jsx("span",{className:"backup-stat-label",children:"Photos"})]}),h>0&&e.jsxs("div",{className:"backup-stat verified",children:[e.jsx("span",{className:"backup-stat-value",children:h}),e.jsx("span",{className:"backup-stat-label",children:"Verified"})]})]})]}),e.jsxs("div",{className:"cor-section-header cor-backup-header",onClick:()=>A(!O),style:{cursor:"pointer",marginBottom:O?"1rem":0},children:[e.jsx("div",{className:"backup-header-left",children:e.jsx("span",{children:"View All T&M Tickets"})}),e.jsx("div",{className:"backup-header-toggle",children:O?e.jsx(Ne,{size:20}):e.jsx(Se,{size:20})})]}),O&&e.jsx("div",{className:"backup-tickets-list",style:{padding:"0 0.5rem"},children:$.map(d=>{const w=H.has(d.id),U=d.t_and_m_workers?.reduce((f,P)=>f+(parseFloat(P.hours)||0),0)||0,Q=d.t_and_m_workers?.reduce((f,P)=>f+(parseFloat(P.overtime_hours)||0),0)||0,B=!!d.client_signature_data;return e.jsxs("div",{className:"backup-ticket-pro","data-verified":B,"data-status":d.status||"pending",children:[e.jsxs("div",{className:"ticket-pro-header",onClick:()=>{const f=new Set(H);w?f.delete(d.id):f.add(d.id),ne(f)},style:{cursor:"pointer"},children:[e.jsxs("div",{className:"ticket-date-badge",children:[e.jsx($e,{size:14}),e.jsx("span",{children:le(d.work_date)})]}),d.ce_pco_number&&e.jsx("span",{className:"ticket-pco-badge",children:d.ce_pco_number}),B&&e.jsxs("span",{className:"ticket-verified-seal",children:[e.jsx(G,{size:12})," Verified"]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.85rem",color:"var(--text-muted)"},children:[d.t_and_m_workers?.length||0," workers • ",U+Q," hrs"]}),w?e.jsx(Ne,{size:16}):e.jsx(Se,{size:16})]})]}),w&&e.jsxs("div",{className:"ticket-pro-body",children:[d.notes&&e.jsx("div",{className:"ticket-description-box",children:e.jsx("p",{children:d.notes})}),d.t_and_m_workers?.length>0&&e.jsxs("div",{className:"ticket-section-pro",children:[e.jsxs("div",{className:"ticket-section-header",children:[e.jsx(be,{size:14}),e.jsx("span",{children:"Labor"}),e.jsxs("span",{className:"section-count",children:[U+Q," hrs total"]})]}),e.jsx("div",{className:"worker-pro-grid",children:d.t_and_m_workers.map((f,P)=>e.jsxs("div",{className:"worker-pro-row",children:[e.jsxs("div",{children:[e.jsx("span",{className:"worker-name",children:f.name}),f.role&&e.jsxs("span",{className:"worker-role",children:[" • ",f.role]})]}),e.jsx("span",{className:"worker-time",children:f.time_started&&f.time_ended?`${ie(f.time_started)} - ${ie(f.time_ended)}`:"-"}),e.jsxs("span",{className:"worker-hours",children:[f.hours||0," hrs"]}),e.jsx("span",{className:"worker-ot",children:parseFloat(f.overtime_hours)>0?`+${f.overtime_hours} OT`:"-"})]},P))})]}),d.t_and_m_items?.length>0&&e.jsxs("div",{className:"ticket-section-pro",children:[e.jsxs("div",{className:"ticket-section-header",children:[e.jsx(me,{size:14}),e.jsx("span",{children:"Materials / Equipment"}),e.jsxs("span",{className:"section-count",children:[d.t_and_m_items.length," items"]})]}),e.jsx("div",{className:"materials-pro-list",children:d.t_and_m_items.map((f,P)=>e.jsxs("div",{className:"material-pro-row",children:[e.jsx("span",{className:"material-name",children:f.materials_equipment?.name||f.description||"Item"}),e.jsxs("span",{className:"material-qty",children:[f.quantity||1," ",f.materials_equipment?.unit||"ea"]}),e.jsx("span",{className:"material-source",children:"T&M Ticket"})]},P))})]}),d.photos?.length>0&&e.jsxs("div",{className:"ticket-section-pro",children:[e.jsxs("div",{className:"ticket-section-header",children:[e.jsx(fe,{size:14}),e.jsx("span",{children:"Photo Evidence"}),e.jsx("span",{className:"section-count",children:d.photos.length})]}),e.jsx("div",{className:"photo-evidence-grid",children:d.photos.map((f,P)=>e.jsx("a",{href:f,target:"_blank",rel:"noopener noreferrer",className:"photo-evidence-item",children:e.jsx("img",{src:f,alt:`Evidence ${P+1}`,onError:ee=>{ee.target.onerror=null,ee.target.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=="}})},P))})]}),B&&e.jsxs("div",{className:"ticket-verification-footer",children:[e.jsx("div",{className:"verification-seal-icon",children:e.jsx(G,{size:22})}),d.client_signature_data&&e.jsx("img",{src:d.client_signature_data,alt:"Client Signature",className:"verification-signature-img"}),e.jsxs("div",{className:"verification-info",children:[e.jsx("span",{className:"signer-name",children:d.client_signature_name||"Client"}),(d.client_signature_title||d.client_signature_company)&&e.jsx("span",{className:"signer-title",children:[d.client_signature_title,d.client_signature_company].filter(Boolean).join(", ")}),d.client_signature_date&&e.jsxs("span",{className:"verify-date",children:["Verified ",le(d.client_signature_date)]})]})]})]})]},d.id)})}),e.jsxs("div",{className:"backup-note",children:[e.jsx(pe,{size:14}),e.jsx("span",{children:"This documentation supports the work described in this Change Order Request."})]})]})})(),e.jsxs("div",{className:"cor-totals-card",children:[e.jsx("h4",{children:"COR Summary"}),e.jsxs("div",{className:"cor-totals-grid",children:[e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:p(F.cor_subtotal)})]}),e.jsxs("div",{className:"cor-fees-section",children:[e.jsxs("div",{className:"cor-fee-row",children:[e.jsxs("span",{children:["Liability Insurance (",q(l.liability_insurance_percent||144),")"]}),e.jsx("span",{children:p(F.liability_insurance_amount)})]}),e.jsxs("div",{className:"cor-fee-row",children:[e.jsxs("span",{children:["Bond (",q(l.bond_percent||100),")"]}),e.jsx("span",{children:p(F.bond_amount)})]}),e.jsxs("div",{className:"cor-fee-row",children:[e.jsxs("span",{children:["City License Fee (",q(l.license_fee_percent||10),")"]}),e.jsx("span",{children:p(F.license_fee_amount)})]})]}),e.jsxs("div",{className:"cor-grand-total",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:p(F.cor_total)})]})]})]}),e.jsxs("div",{className:"cor-signature-section",children:[e.jsx("h4",{children:"Authorization"}),e.jsx("p",{className:"signature-instruction",children:"By signing below, you authorize the above change order request and agree to the terms and costs outlined."}),e.jsx("div",{className:"signature-slots-grid",children:R?e.jsxs(e.Fragment,{children:[T&&e.jsxs("div",{className:"signature-slot-card signed",children:[e.jsxs("div",{className:"slot-header",children:[e.jsx(G,{size:20,className:"status-icon signed"}),e.jsx("span",{className:"slot-label",children:"GC Authorization"})]}),e.jsxs("div",{className:"slot-signed-info",children:[T.signature_data&&e.jsx("img",{src:T.signature_data,alt:"Signature",className:"signature-image"}),e.jsxs("div",{className:"signer-details",children:[e.jsx("span",{className:"signer-name",children:T.signer_name}),(T.signer_title||T.signer_company)&&e.jsxs("span",{className:"signer-org",children:[T.signer_title,T.signer_title&&T.signer_company&&" — ",T.signer_company]})]}),e.jsxs("span",{className:"signed-date",children:["Signed ",le(T.signed_at)]})]})]}),z&&e.jsxs("div",{className:"signature-slot-card signed",children:[e.jsxs("div",{className:"slot-header",children:[e.jsx(G,{size:20,className:"status-icon signed"}),e.jsx("span",{className:"slot-label",children:"Client Authorization"})]}),e.jsxs("div",{className:"slot-signed-info",children:[z.signature_data&&e.jsx("img",{src:z.signature_data,alt:"Signature",className:"signature-image"}),e.jsxs("div",{className:"signer-details",children:[e.jsx("span",{className:"signer-name",children:z.signer_name}),(z.signer_title||z.signer_company)&&e.jsxs("span",{className:"signer-org",children:[z.signer_title,z.signer_title&&z.signer_company&&" — ",z.signer_company]})]}),e.jsxs("span",{className:"signed-date",children:["Signed ",le(z.signed_at)]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`signature-slot-card ${T?"signed":"unsigned"}`,children:[e.jsxs("div",{className:"slot-header",children:[T?e.jsx(G,{size:20,className:"status-icon signed"}):e.jsx(ue,{size:20,className:"status-icon pending"}),e.jsx("span",{className:"slot-label",children:"GC Authorization"})]}),e.jsx("button",{className:"btn btn-primary sign-btn",onClick:()=>Y(1),disabled:s,children:"Sign as GC"})]}),e.jsx("p",{className:"or-divider",children:"— or —"}),e.jsxs("div",{className:`signature-slot-card ${z?"signed":"unsigned"}`,children:[e.jsxs("div",{className:"slot-header",children:[z?e.jsx(G,{size:20,className:"status-icon signed"}):e.jsx(ue,{size:20,className:"status-icon pending"}),e.jsx("span",{className:"slot-label",children:"Client Authorization"})]}),e.jsx("button",{className:"btn btn-primary sign-btn",onClick:()=>Y(2),disabled:s,children:"Sign as Client"})]})]})}),R&&e.jsxs("div",{className:"fully-signed-message",children:[e.jsx(G,{size:24}),e.jsx("p",{children:"This change order request has been signed."})]}),e.jsxs("div",{className:"cor-download-section",children:[e.jsx("h4",{children:"Download Your Copy"}),e.jsx("p",{className:"download-description",children:R?"Download a PDF copy of this fully signed COR including all T&M backup documentation.":"Download a PDF copy of this COR for your records. Signature status will be included."}),e.jsx("button",{className:"btn btn-primary download-btn",onClick:J,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"download-spinner"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{size:18}),"Download COR + Backup"]})})]})]})]}),e.jsx("footer",{className:"signature-page-footer",children:e.jsx("p",{children:"Powered by FieldSync"})}),t&&k&&e.jsx(ve,{enhanced:!0,requireAcknowledgment:!0,lockBodyScroll:!0,slot:k,documentType:x.document_type,documentTitle:`${l.cor_number} - ${l.title}`,onSave:V,onClose:()=>{b(!1),n(null)}})]})}function ce(o,j,N,S,a){return e.jsxs("div",{className:`signature-slot-card ${j?"signed":"unsigned"}`,children:[e.jsxs("div",{className:"slot-header",children:[j?e.jsx(G,{size:20,className:"status-icon signed"}):e.jsx(ue,{size:20,className:"status-icon pending"}),e.jsxs("span",{className:"slot-label",children:["Signature ",o," — ",N]})]}),j?e.jsxs("div",{className:"slot-signed-info",children:[e.jsxs("div",{className:"signer-details",children:[e.jsx("span",{className:"signer-name",children:j.signer_name}),(j.signer_title||j.signer_company)&&e.jsxs("span",{className:"signer-org",children:[j.signer_title,j.signer_title&&j.signer_company&&" — ",j.signer_company]})]}),e.jsxs("span",{className:"signed-date",children:["Signed ",le(j.signed_at)]})]}):e.jsxs("button",{className:"btn btn-primary sign-btn",onClick:()=>S(o),disabled:a,children:["Sign as ",o===1?"GC":"Client"]})]})}export{Ge as default};
//# sourceMappingURL=SignaturePage-ClTZyGw2.js.map
