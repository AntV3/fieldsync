import{_ as Re}from"./pdf-aQqpMATS.js";import{as as e,ar as H}from"./index-DaMZDs6Q.js";import{r as m}from"./icons-BkAyv-fR.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const Ne=()=>Re(()=>import("./xlsx-BvJTHLik.js"),[]),Y=x=>{if(x==null||x==="")return"";const y=parseFloat(x);return isNaN(y)?"":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(y)},ye=x=>{if(!x)return null;const y=String(x).replace(/[$,\s]/g,""),V=parseFloat(y);return isNaN(V)?null:V};function Je({company:x,user:y,onProjectCreated:V,onShowToast:c}){const[$,K]=m.useState(""),[Q,Z]=m.useState(""),[ee,te]=m.useState(""),[ae,se]=m.useState(""),[ne,re]=m.useState(""),[k,_]=m.useState(""),[M,T]=m.useState("demolition"),[L,O]=m.useState("standard"),[g,f]=m.useState([{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null}]),[le,ie]=m.useState(!1),[ce,R]=m.useState(!1),[we,A]=m.useState(!1),[j,U]=m.useState([]),[oe,q]=m.useState(!1),[v,de]=m.useState(""),[w,ue]=m.useState(""),[B,me]=m.useState(""),P=m.useRef(null),G=g.reduce((t,s)=>t+(parseFloat(s.weight)||0),0),Ce=t=>{const s=t.replace(/\D/g,"").slice(0,4);_(s)},Se=()=>{const t=new Uint32Array(1);crypto.getRandomValues(t);const s=(1e3+t[0]%9e3).toString();_(s)},C=(t,s,a)=>{f(n=>n.map((r,l)=>l===t?{...r,[s]:a}:r))},Ve=()=>{f(t=>[...t,{name:"",weight:"",group:"",scheduledValue:null}])},pe=t=>{g.length>1&&f(s=>s.filter((a,n)=>n!==t))},he=(t="value")=>{const s=g.filter(o=>o.name.trim());if(s.length===0){c("Add tasks first","error");return}let a=[...g];const n=g.map((o,i)=>o.name.trim()?i:-1).filter(o=>o>=0);if(t==="value"){const o=s.reduce((i,d)=>i+(parseFloat(d.scheduledValue)||0),0);if(o===0)c("No scheduled values - using equal distribution","info"),t="equal";else{let i=0;n.forEach((d,W)=>{const z=parseFloat(g[d].scheduledValue)||0;let b;W===n.length-1?b=100-i:(b=Math.round(z/o*1e4)/100,i+=b),a[d]={...a[d],weight:b.toFixed(2)}}),f(a),q(!1),c("Weights calculated by value","success");return}}const r=Math.round(100/n.length*100)/100;let l=0;n.forEach((o,i)=>{let d;i===n.length-1?d=100-l:(d=r,l+=d),a[o]={...a[o],weight:d.toFixed(2)}}),f(a),q(!1),c("Weights distributed equally","success")},ke=()=>{K(""),Z(""),te(""),se(""),re(""),_(""),T("demolition"),O("standard"),de(""),ue(""),me(""),f([{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null}]),A(!1),U([])},Ae=()=>{P.current?.click()},Pe=async t=>{const s=(await Ne()).default||await Ne();return new Promise((a,n)=>{const r=new FileReader;r.onload=l=>{try{const o=new Uint8Array(l.target.result),i=s.read(o,{type:"array"}),d=i.SheetNames[0],W=i.Sheets[d],z=s.utils.sheet_to_json(W,{header:1}),b=[];let ge="General";const xe=/^\$?\d{1,3}(,\d{3})*(\.\d{2})?$/,F=/^(\d+\.?\d*|[A-Z]\.?\d*)$/i,_e=/^(SF|LF|EA|LS|Days?|MD|Load|CY|SY|GAL|TON)$/i,Me=/^\d{1,3}(,\d{3})*$|^\d+$/,je=/^(Item|#|No\.?|Description|Scheduled|Value|Amount|Quantity|Unit|Total|Application|Balance|Completed|Stored|Retainage)/i;for(const S of z){if(!S||S.length===0)continue;const u=S.map(h=>h==null?"":String(h).trim()).filter(h=>h.length>0);if(u.length===0)continue;const Le=u.join(" ");if(je.test(u[0])||u.length>1&&je.test(u[1])||/^(Total|Subtotal|Grand Total|Base Bid|Contract Sum)/i.test(Le))continue;const J=u.some(h=>xe.test(h.replace(/[$,]/g,"")+(h.includes(".")?"":".00")));if((!J&&u.length<=3&&/^(L\d|Level|Floor|\d+(?:st|nd|rd|th)|Plaza|Street|Basement|Roof|Penthouse|Site|Exterior|Interior|Misc|MEP|ABATEMENT|DEMOLITION|UNIVERSAL|SOFT|TRASH|DEMO|Phase|Division|Section|Area|Building|Wing)/i.test(u[0])||u.length===2&&F.test(u[0])&&!J&&!/^\d+\.\d+$/.test(u[0]))&&!J){ge=(u.find(p=>!F.test(p)&&p.length>1)||u.join(" ")).replace(/\s*\(\d{1,3}(?:,\d{3})*\s*SF\)\s*$/i,"").replace(/\s*[-:]\s*$/,"").trim();continue}let N="",X=!1,ve="",I=null;const be=[];for(let h=0;h<u.length;h++){const p=u[h];if(h===0&&F.test(p)){ve=p;continue}if(!/^ID-\d+$/i.test(p)&&!/^KN\s*\d+$/i.test(p)){if(xe.test(p.replace(/[$,]/g,"")+(p.includes(".")?"":".00"))||/^\$/.test(p)){const Oe=p.replace(/[$,]/g,""),E=parseFloat(Oe);!isNaN(E)&&E>100&&(I===null||E>I)&&(I=E),X=!0;continue}if(Me.test(p.replace(/,/g,""))){X=!0;continue}_e.test(p)||/^\d+\.?\d*%$/.test(p)||p.length>1&&!F.test(p)&&be.push(p)}}N=be.join(" ").trim(),N=N.replace(/\s+/g," ").replace(/^[-â€¢]\s*/,"").trim(),!(N.length<3)&&(/^(Plan|Page|Total|Base Bid|Payment|Condition|Exclusion|Subtotal)/i.test(N)||X&&N.length>=3&&b.push({name:N,group:ge,itemNumber:ve,scheduledValue:I,selected:!0}))}const fe=new Set,Te=b.filter(S=>{const u=`${S.group}:${S.name}`;return fe.has(u)?!1:(fe.add(u),!0)});a(Te)}catch(o){n(o)}},r.onerror=()=>n(new Error("Failed to read file")),r.readAsArrayBuffer(t)})},De=async t=>{const s=t.target.files?.[0];if(!s)return;const a=s.name.split(".").pop().toLowerCase();if(!["xlsx","xls","csv"].includes(a)){c("Please upload an Excel file (.xlsx, .xls, or .csv)","error");return}R(!0);try{const n=await Pe(s);if(n.length===0){c("No tasks found. Check Excel format.","error"),R(!1);return}U(n),A(!0),c(`Found ${n.length} tasks`,"success")}catch(n){console.error("Excel import error:",n),c("Error reading Excel file","error")}finally{R(!1),P.current&&(P.current.value="")}},Fe=t=>{U(s=>s.map((a,n)=>n===t?{...a,selected:!a.selected}:a))},Ie=()=>{const t=j.filter(r=>r.selected);if(t.length===0){c("Please select at least one task","error");return}const s=t.reduce((r,l)=>r+(l.scheduledValue||0),0),a=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});let n;if(s>0){let r=0;n=t.map((l,o)=>{const i=l.scheduledValue||0;let d;return o===t.length-1?d=100-r:(d=Math.round(i/s*1e4)/100,r+=d),{name:l.name,weight:d.toFixed(2),group:l.group,scheduledValue:l.scheduledValue||null}}),c(`Tasks imported with value-based weights! Total SOV: ${a.format(s)}`,"success")}else{const r=Math.round(100/t.length*100)/100;n=t.map((l,o)=>({name:l.name,weight:o===t.length-1?(100-r*(t.length-1)).toFixed(2):r.toFixed(2),group:l.group,scheduledValue:l.scheduledValue||null})),c("Tasks imported with equal weights","success")}f(n),A(!1)},Ee=async()=>{if(!x?.id){c("No company selected. Please log in again.","error");return}if(!$.trim()){c("Please enter a project name","error");return}const t=parseFloat(ne);if(!t||t<=0){c("Please enter a valid contract value","error");return}if(k.length!==4){c("Please enter a 4-digit PIN","error");return}if(!await H.isPinAvailable(k)){c("This PIN is already in use. Try another.","error");return}const a=g.filter(n=>n.name.trim()&&parseFloat(n.weight)>0);if(a.length===0){c("Please add at least one area","error");return}if(Math.abs(G-100)>.1){c("Area weights must total 100%","error");return}if(!v||!w){c("Start date and end date are required","error");return}if(new Date(w)<new Date(v)){c("End date must be on or after start date","error");return}ie(!0);try{const n=await H.createProject({name:$.trim(),job_number:Q.trim()||null,address:ee.trim()||null,general_contractor:ae.trim()||null,contract_value:t,pin:k,work_type:M,job_type:L,company_id:x?.id,created_by:y?.id,start_date:v,end_date:w,planned_man_days:B?parseInt(B):null});for(let r=0;r<a.length;r++)await H.createArea({project_id:n.id,name:a[r].name.trim(),weight:parseFloat(a[r].weight),scheduled_value:a[r].scheduledValue||null,group_name:a[r].group||null,status:"not_started",sort_order:r});c("Project created!","success"),ke(),V()}catch(n){console.error("Error creating project:",n),c("Error creating project","error")}finally{ie(!1)}};if(we){const t=[...new Set(j.map(r=>r.group))],s=j.filter(r=>r.selected).length,a=j.reduce((r,l)=>r+(l.scheduledValue||0),0),n=j.filter(r=>r.selected).reduce((r,l)=>r+(l.scheduledValue||0),0);return e.jsxs("div",{children:[e.jsx("h1",{children:"Review Imported Tasks"}),e.jsx("p",{className:"subtitle",children:"Select the tasks to include in your project"}),e.jsxs("div",{className:"import-summary",children:[e.jsxs("span",{children:[s," of ",j.length," tasks selected"]}),a>0&&e.jsxs("span",{className:"import-sov-total",children:["Â· Total SOV: ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(n)]})]}),t.map(r=>{const l=j.filter(i=>i.group===r),o=l.filter(i=>i.selected).length;return e.jsxs("div",{className:"card import-group",children:[e.jsxs("div",{className:"import-group-header",children:[e.jsx("h3",{children:r}),e.jsxs("span",{className:"import-group-count",children:[o,"/",l.length]})]}),e.jsx("div",{className:"import-task-list",children:l.map(i=>{const d=j.indexOf(i);return e.jsxs("label",{className:"import-task-item",children:[e.jsx("input",{type:"checkbox",checked:i.selected,onChange:()=>Fe(d)}),e.jsx("span",{className:"import-task-name",children:i.name}),i.scheduledValue>0&&e.jsx("span",{className:"import-task-value",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(i.scheduledValue)})]},d)})})]},r)}),e.jsxs("div",{className:"import-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>A(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:Ie,children:["Use Selected Tasks (",s,")"]})]})]})}const D=g.reduce((t,s,a)=>{const n=s.group||"General";return t[n]||(t[n]=[]),t[n].push({...s,originalIndex:a}),t},{}),$e=Object.keys(D).length>1||Object.keys(D).length===1&&!D.General;return e.jsxs("div",{children:[e.jsx("h1",{children:"New Project"}),e.jsx("p",{className:"subtitle",children:"Set up a new project to track"}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Name"}),e.jsx("input",{type:"text",placeholder:"e.g., Sunrise Apartments",value:$,onChange:t=>K(t.target.value)})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Number"}),e.jsx("input",{type:"text",placeholder:"e.g., 4032",value:Q,onChange:t=>Z(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Contract Value ($)"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"e.g., 365000",value:ne,onChange:t=>{const s=t.target.value.replace(/[^0-9.]/g,"");re(s)},className:"currency-input"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Address"}),e.jsx("input",{type:"text",placeholder:"e.g., 123 Main St, Los Angeles, CA 90001",value:ee,onChange:t=>te(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"General Contractor"}),e.jsx("input",{type:"text",placeholder:"e.g., ABC Construction Inc.",value:ae,onChange:t=>se(t.target.value)})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Start Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:v,onChange:t=>de(t.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["End Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:w,onChange:t=>ue(t.target.value),min:v||void 0,required:!0}),v&&w&&new Date(w)<new Date(v)&&e.jsx("span",{className:"error-text",children:"End date must be after start date"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Planned Man-Days ",e.jsx("span",{className:"optional",children:"(optional)"})]}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.85rem",marginBottom:"0.5rem"},children:"Total estimated man-days to complete the project"}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"e.g., 120",value:B,onChange:t=>me(t.target.value.replace(/\D/g,"")),min:"1"})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Work Type"}),e.jsxs("div",{className:"project-type-toggle",children:[e.jsx("button",{type:"button",className:`toggle-btn ${M==="demolition"?"active":""}`,onClick:()=>T("demolition"),children:"Demolition"}),e.jsx("button",{type:"button",className:`toggle-btn ${M==="abatement"?"active":""}`,onClick:()=>T("abatement"),children:"Abatement"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Type"}),e.jsxs("div",{className:"project-type-toggle",children:[e.jsx("button",{type:"button",className:`toggle-btn ${L==="standard"?"active":""}`,onClick:()=>O("standard"),children:"Standard"}),e.jsx("button",{type:"button",className:`toggle-btn ${L==="pla"?"active":""}`,onClick:()=>O("pla"),children:"PLA"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Foreman PIN (4 digits)"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.85rem",marginBottom:"0.5rem"},children:"Foremen will enter this PIN to access this project"}),e.jsxs("div",{className:"pin-input-row",children:[e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"e.g., 2847",value:k,onChange:t=>Ce(t.target.value),maxLength:4,className:"pin-input"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:Se,children:"Generate"})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"areas-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Areas / Tasks"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.9rem",marginTop:"0.25rem"},children:"Define the areas for this project. Weights must total 100%."})]}),e.jsxs("div",{className:"import-btn-container",children:[e.jsx("input",{ref:P,type:"file",accept:".xlsx,.xls,.csv",onChange:De,style:{display:"none"}}),e.jsx("button",{className:"btn btn-secondary btn-small",onClick:Ae,disabled:ce,children:ce?"Reading...":"ðŸ“Š Import Excel"})]})]}),$e?Object.entries(D).map(([t,s])=>e.jsxs("div",{className:"area-group",children:[e.jsx("div",{className:"area-group-header",children:t}),s.map(a=>e.jsxs("div",{className:"area-row area-row-with-value",children:[e.jsx("input",{type:"text",placeholder:"Task name",value:a.name,onChange:n=>C(a.originalIndex,"name",n.target.value),className:"area-name-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"$0",value:a.scheduledValue?Y(a.scheduledValue):"",onChange:n=>C(a.originalIndex,"scheduledValue",ye(n.target.value)),className:"currency-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"%",value:a.weight,onChange:n=>C(a.originalIndex,"weight",n.target.value),className:"weight-input"}),e.jsx("button",{className:"remove-btn",onClick:()=>pe(a.originalIndex),children:"Ã—"})]},a.originalIndex))]},t)):g.map((t,s)=>e.jsxs("div",{className:"area-row area-row-with-value",children:[e.jsx("input",{type:"text",placeholder:"Area name (e.g., Level 1)",value:t.name,onChange:a=>C(s,"name",a.target.value),className:"area-name-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"$0",value:t.scheduledValue?Y(t.scheduledValue):"",onChange:a=>C(s,"scheduledValue",ye(a.target.value)),className:"currency-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"%",value:t.weight,onChange:a=>C(s,"weight",a.target.value),className:"weight-input"}),e.jsx("button",{className:"remove-btn",onClick:()=>pe(s),children:"Ã—"})]},s)),e.jsxs("div",{className:"weight-total-row",children:[e.jsxs("div",{className:"weight-total",children:[e.jsx("span",{className:"weight-total-label",children:"Total Weight:"}),e.jsxs("span",{className:`weight-total-value ${Math.abs(G-100)<.1?"valid":"invalid"}`,children:[G.toFixed(1),"%"]}),g.some(t=>t.scheduledValue>0)&&e.jsxs("span",{className:"sov-total",children:["Â· SOV: ",Y(g.reduce((t,s)=>t+(parseFloat(s.scheduledValue)||0),0))]})]}),e.jsxs("div",{className:"auto-weight-dropdown",children:[e.jsx("button",{type:"button",className:"btn btn-secondary btn-small",onClick:()=>q(!oe),children:"Auto-Calculate â–¼"}),oe&&e.jsxs("div",{className:"weight-dropdown-menu",children:[e.jsxs("button",{onClick:()=>he("value"),children:["By Value ",e.jsx("span",{className:"dropdown-hint",children:"(Recommended)"})]}),e.jsx("button",{onClick:()=>he("equal"),children:"Equal Distribution"})]})]})]}),e.jsx("button",{className:"btn btn-secondary",onClick:Ve,children:"+ Add Area"})]}),e.jsx("button",{className:"btn btn-primary btn-full",onClick:Ee,disabled:le,children:le?"Creating...":"Create Project"})]})}export{Je as default};
//# sourceMappingURL=Setup-muV83_g1.js.map
