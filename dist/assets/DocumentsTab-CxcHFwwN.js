import{j as e,d as v,F as Fe}from"./index-P4-kdNvF.js";import{r as l,X as H,E as fe,aD as De,a as ce,L,k as ae,A as be,D as X,aE as ve,c as ke,j as ge,Q as Z,F as te,x as G,Y as Se,am as _e,au as le,aq as we,w as Ee,v as Pe,u as Ie,i as Ae,t as Me,f as Re,s as Le,T as Ue,n as ne,aF as Oe,_ as $e,$ as Be,e as oe,aG as Ve,N as Ge,I as We,z as qe}from"./icons-DdhIMWD5.js";import"./react-DXGY7bZi.js";import"./pdf-ChZ1zkDw.js";import"./supabase-VuevzHjS.js";const Ne=[{id:"plans",label:"Plans & Drawings",icon:"Map"},{id:"specs",label:"Specifications",icon:"FileText"},{id:"permits",label:"Permits & Approvals",icon:"Shield"},{id:"contracts",label:"Contracts",icon:"FileSignature"},{id:"submittals",label:"Submittals",icon:"Send"},{id:"rfis",label:"RFIs",icon:"HelpCircle"},{id:"photos",label:"Site Photos",icon:"Camera"},{id:"reports",label:"Reports",icon:"ClipboardList"},{id:"safety",label:"Safety Documents",icon:"AlertTriangle"},{id:"general",label:"General",icon:"Folder"}],de={"application/pdf":{ext:"pdf",maxSize:25*1024*1024,label:"PDF"},"application/msword":{ext:"doc",maxSize:15*1024*1024,label:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{ext:"docx",maxSize:15*1024*1024,label:"Word"},"application/vnd.ms-excel":{ext:"xls",maxSize:15*1024*1024,label:"Excel"},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{ext:"xlsx",maxSize:15*1024*1024,label:"Excel"},"image/jpeg":{ext:"jpg",maxSize:10*1024*1024,label:"Image"},"image/png":{ext:"png",maxSize:10*1024*1024,label:"Image"}},ye={all:{label:"Everyone",description:"Visible to all team members including field users"},office_only:{label:"Office Only",description:"Only visible to office staff and admins"},admin_only:{label:"Admins Only",description:"Only visible to company administrators"}},Qe=["contracts"],He=25,me=c=>{if(!c)return"0 B";const h=["B","KB","MB","GB"];let r=c,o=0;for(;r>=1024&&o<h.length-1;)r/=1024,o++;return`${r.toFixed(r<10?1:0)} ${h[o]}`};function ue({projectId:c,companyId:h,folderId:r,folderName:o,onClose:S,onUploadComplete:n,onShowToast:V}){const[p,d]=l.useState(null),[A,_]=l.useState(!1),[y,D]=l.useState(!1),[k,C]=l.useState(""),[z,x]=l.useState(null),[g,w]=l.useState(""),[E,N]=l.useState(""),[f,j]=l.useState("general"),[b,U]=l.useState("all"),M=l.useRef(null),O=s=>{if(!s)return"Please select a file";const P=de[s.type];return P?s.size>P.maxSize?`File too large. Maximum size for ${P.label}: ${me(P.maxSize)}`:null:"File type not supported. Allowed: PDF, Word, Excel, Images"},t=l.useCallback(s=>{const P=O(s);if(P){x(P);return}if(x(null),d(s),!g){const Y=s.name.replace(/\.[^/.]+$/,"");w(Y)}},[g]),$=s=>{s.preventDefault(),s.stopPropagation(),s.type==="dragenter"||s.type==="dragover"?_(!0):s.type==="dragleave"&&_(!1)},a=s=>{s.preventDefault(),s.stopPropagation(),_(!1),s.dataTransfer.files&&s.dataTransfer.files[0]&&t(s.dataTransfer.files[0])},F=s=>{s.target.files&&s.target.files[0]&&t(s.target.files[0])},R=async()=>{if(!p){x("Please select a file");return}if(!g.trim()){x("Please enter a document name");return}D(!0),x(null),C("Uploading document...");try{const s=await v.uploadDocument(h,c,p,{name:g.trim(),description:E.trim()||null,category:f,visibility:b,folderId:r||null});C("Upload complete!"),n(s)}catch(s){console.error("Upload error:",s),x(s.message||"Failed to upload document"),D(!1)}},I=Qe.includes(f);return e.jsx("div",{className:"modal-overlay",onClick:S,children:e.jsxs("div",{className:"document-upload-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Upload Document"}),o&&e.jsxs("span",{className:"modal-subtitle",children:["to ",o]})]}),e.jsx("button",{className:"modal-close",onClick:S,children:e.jsx(H,{size:20})})]}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:`document-dropzone ${A?"drag-active":""} ${p?"has-file":""}`,onDragEnter:$,onDragLeave:$,onDragOver:$,onDrop:a,onClick:()=>!p&&M.current?.click(),children:[e.jsx("input",{ref:M,type:"file",accept:Object.keys(de).join(","),onChange:F,style:{display:"none"}}),p?e.jsxs("div",{className:"dropzone-file",children:[e.jsx(fe,{size:32}),e.jsxs("div",{className:"dropzone-file-info",children:[e.jsx("span",{className:"dropzone-file-name",children:p.name}),e.jsx("span",{className:"dropzone-file-size",children:me(p.size)})]}),e.jsx("button",{className:"dropzone-file-remove",onClick:s=>{s.stopPropagation(),d(null),x(null)},children:e.jsx(H,{size:16})})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{size:48}),e.jsxs("p",{className:"dropzone-text",children:["Drag & drop files here",e.jsx("br",{}),"or click to browse"]}),e.jsx("p",{className:"dropzone-hint",children:"PDF, Word, Excel, Images â€¢ Max 25MB"})]})]}),z&&e.jsxs("div",{className:"document-upload-error",children:[e.jsx(ce,{size:16}),z]}),e.jsxs("div",{className:"document-upload-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-name",children:"Document Name *"}),e.jsx("input",{id:"doc-name",type:"text",value:g,onChange:s=>w(s.target.value),placeholder:"Enter document name",disabled:y})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-category",children:"Category"}),e.jsx("select",{id:"doc-category",value:f,onChange:s=>j(s.target.value),disabled:y,children:Ne.map(s=>e.jsx("option",{value:s.id,children:s.label},s.id))}),I&&e.jsxs("p",{className:"form-hint warning",children:[e.jsx(ce,{size:14}),"Documents in this category require admin approval before becoming visible."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-description",children:"Description"}),e.jsx("textarea",{id:"doc-description",value:E,onChange:s=>N(s.target.value),placeholder:"Optional description...",rows:3,disabled:y})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Visibility"}),e.jsx("div",{className:"visibility-options",children:Object.entries(ye).map(([s,{label:P,description:Y}])=>e.jsxs("label",{className:`visibility-option ${b===s?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"visibility",value:s,checked:b===s,onChange:B=>U(B.target.value),disabled:y}),e.jsxs("div",{className:"visibility-content",children:[e.jsx("span",{className:"visibility-label",children:P}),e.jsx("span",{className:"visibility-desc",children:Y})]})]},s))})]})]})]}),e.jsx("div",{className:"modal-footer",children:y?e.jsxs("div",{className:"upload-progress",children:[e.jsx(L,{size:20,className:"spinner"}),e.jsx("span",{children:k})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:S,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:R,disabled:!p||!g.trim(),children:[e.jsx(ae,{size:18}),"Upload Document"]})]})})]})})}const Ye=c=>{if(!c)return"0 B";const h=["B","KB","MB","GB"];let r=c,o=0;for(;r>=1024&&o<h.length-1;)r/=1024,o++;return`${r.toFixed(r<10?1:0)} ${h[o]}`},he=c=>c?new Date(c).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"";function Ke({document:c,onBack:h,onUpdate:r,onShowToast:o,isOfficeOrAdmin:S}){const[n,V]=l.useState(c),[p,d]=l.useState([]),[A,_]=l.useState(!0),[y,D]=l.useState(!1),[k,C]=l.useState(""),[z,x]=l.useState(!1),g=Ne.find(t=>t.id===n.category),w=ye[n.visibility],E=n.approval_status==="pending",N=n.approval_status==="rejected",f=S;l.useEffect(()=>{j()},[n.id]);const j=async()=>{_(!0);try{const t=await v.getDocumentVersions(n.id);d(t)}catch(t){console.error("Error loading versions:",t)}finally{_(!1)}},b=async()=>{await v.logDocumentAccess(n.id,"downloaded");const t=`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${n.storage_path}`;window.open(t,"_blank")},U=async()=>{x(!0);try{await v.approveDocument(n.id),V(t=>({...t,approval_status:"approved"})),o?.("Document approved","success"),r?.()}catch(t){console.error("Error approving document:",t),o?.("Failed to approve document","error")}finally{x(!1)}},M=async()=>{if(!k.trim()){o?.("Please provide a reason for rejection","error");return}x(!0);try{await v.rejectDocument(n.id,k.trim()),V(t=>({...t,approval_status:"rejected",rejection_reason:k.trim()})),D(!1),C(""),o?.("Document rejected","success"),r?.()}catch(t){console.error("Error rejecting document:",t),o?.("Failed to reject document","error")}finally{x(!1)}},O=async()=>{if(confirm("Are you sure you want to archive this document?")){x(!0);try{await v.archiveDocument(n.id),o?.("Document archived","success"),h(),r?.()}catch(t){console.error("Error archiving document:",t),o?.("Failed to archive document","error")}finally{x(!1)}}};return e.jsxs("div",{className:"document-detail",children:[e.jsxs("div",{className:"document-detail-header",children:[e.jsxs("button",{className:"back-btn",onClick:h,children:[e.jsx(be,{size:20}),"Back"]}),e.jsxs("div",{className:"document-detail-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:b,children:[e.jsx(X,{size:18}),"Download"]}),S&&e.jsxs("button",{className:"btn btn-secondary btn-danger",onClick:O,disabled:z,children:[e.jsx(ve,{size:18}),"Archive"]})]})]}),e.jsxs("div",{className:"document-detail-content",children:[e.jsxs("div",{className:"document-detail-main",children:[e.jsxs("div",{className:"document-detail-title",children:[e.jsx("h2",{children:n.name}),n.version>1&&e.jsxs("span",{className:"version-badge",children:["v",n.version]})]}),(E||N)&&e.jsxs("div",{className:"document-detail-status",children:[E&&e.jsxs("div",{className:"status-banner pending",children:[e.jsx(ke,{size:18}),e.jsx("span",{children:"Pending Approval"}),f&&e.jsxs("div",{className:"status-actions",children:[e.jsxs("button",{className:"btn btn-sm btn-success",onClick:U,disabled:z,children:[e.jsx(ge,{size:16}),"Approve"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:()=>D(!0),disabled:z,children:[e.jsx(Z,{size:16}),"Reject"]})]})]}),N&&e.jsxs("div",{className:"status-banner rejected",children:[e.jsx(Z,{size:18}),e.jsxs("div",{className:"rejected-info",children:[e.jsx("span",{children:"Rejected"}),n.rejection_reason&&e.jsx("p",{className:"rejection-reason",children:n.rejection_reason})]})]})]}),e.jsxs("div",{className:"document-detail-meta",children:[e.jsxs("div",{className:"meta-item",children:[e.jsx(te,{size:16}),e.jsx("span",{children:n.file_name})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(G,{size:16}),e.jsx("span",{children:g?.label||n.category})]}),e.jsx("div",{className:"meta-item",children:e.jsx("span",{className:"meta-size",children:Ye(n.file_size_bytes)})}),e.jsxs("div",{className:"meta-item",children:[e.jsx(Se,{size:16}),e.jsx("span",{children:he(n.uploaded_at)})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(_e,{size:16}),e.jsx("span",{children:n.uploaded_by_user?.email||"Unknown"})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(le,{size:16}),e.jsx("span",{children:w?.label||n.visibility})]})]}),n.description&&e.jsxs("div",{className:"document-detail-description",children:[e.jsx("h3",{children:"Description"}),e.jsx("p",{children:n.description})]}),n.resource_type&&n.resource_id&&e.jsxs("div",{className:"document-detail-linked",children:[e.jsxs("h3",{children:[e.jsx(we,{size:16}),"Linked To"]}),e.jsxs("p",{children:[n.resource_type==="cor"&&"Change Order Request",n.resource_type==="tm_ticket"&&"T&M Ticket",n.resource_type==="daily_report"&&"Daily Report"]})]})]}),e.jsxs("div",{className:"document-detail-sidebar",children:[e.jsx("h3",{children:"Version History"}),A?e.jsxs("div",{className:"versions-loading",children:[e.jsx(L,{size:20,className:"spinner"}),"Loading versions..."]}):p.length===0?e.jsx("p",{className:"versions-empty",children:"No version history"}):e.jsx("div",{className:"versions-list",children:p.map(t=>e.jsxs("div",{className:`version-item ${t.id===n.id?"current":""}`,children:[e.jsxs("div",{className:"version-info",children:[e.jsxs("span",{className:"version-number",children:["v",t.version,t.is_current&&e.jsx("span",{className:"current-badge",children:"Current"})]}),e.jsx("span",{className:"version-date",children:he(t.uploaded_at)}),e.jsx("span",{className:"version-user",children:t.uploaded_by_user?.email})]}),e.jsx("button",{className:"version-download",onClick:async()=>{await v.logDocumentAccess(t.id,"downloaded"),window.open(`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${t.storage_path}`,"_blank")},title:"Download this version",children:e.jsx(X,{size:16})})]},t.id))}),S&&e.jsx("div",{className:"upload-version",children:e.jsx("p",{className:"upload-version-hint",children:'To upload a new version, use the main upload button and select "Replace existing document"'})})]})]}),y&&e.jsx("div",{className:"modal-overlay",onClick:()=>D(!1),children:e.jsxs("div",{className:"reject-modal",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:"Reject Document"}),e.jsx("p",{children:"Please provide a reason for rejection:"}),e.jsx("textarea",{value:k,onChange:t=>C(t.target.value),placeholder:"Enter reason...",rows:4}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-danger",onClick:M,disabled:!k.trim()||z,children:[z?e.jsx(L,{size:16,className:"spinner"}):e.jsx(Z,{size:16}),"Reject Document"]})]})]})})]})}const ee=[{id:"folder",label:"Folder",icon:G},{id:"plans",label:"Plans",icon:Ee},{id:"specs",label:"Specs",icon:te},{id:"permits",label:"Permits",icon:Pe},{id:"contracts",label:"Contracts",icon:Ie},{id:"submittals",label:"Submittals",icon:Ae},{id:"rfis",label:"RFIs",icon:Me},{id:"photos",label:"Photos",icon:Re},{id:"reports",label:"Reports",icon:Le},{id:"safety",label:"Safety",icon:Ue}],se=[{id:"blue",label:"Blue",hex:"#3b82f6"},{id:"green",label:"Green",hex:"#10b981"},{id:"yellow",label:"Yellow",hex:"#f59e0b"},{id:"red",label:"Red",hex:"#ef4444"},{id:"purple",label:"Purple",hex:"#8b5cf6"},{id:"pink",label:"Pink",hex:"#ec4899"},{id:"orange",label:"Orange",hex:"#f97316"},{id:"gray",label:"Gray",hex:"#6b7280"}];function Te({projectId:c,companyId:h,folders:r,onFoldersChange:o,onClose:S,onShowToast:n}){const[V,p]=l.useState(!1),[d,A]=l.useState(null),[_,y]=l.useState(null),[D,k]=l.useState(!1),[C,z]=l.useState(""),[x,g]=l.useState("folder"),[w,E]=l.useState("blue"),[N,f]=l.useState(""),j=()=>{z(""),g("folder"),E("blue"),f(""),A(null)},b=()=>{j(),p(!0)},U=a=>{z(a.name),g(a.icon||"folder"),E(a.color||"blue"),f(a.description||""),A(a),p(!0)},M=async a=>{if(a.preventDefault(),!C.trim()){n?.("Please enter a folder name","error");return}k(!0);try{if(d)await v.updateFolder(d.id,{name:C.trim(),icon:x,color:w,description:N.trim()||null}),n?.("Folder updated","success");else{const F=Math.max(0,...r.map(R=>R.sort_order||0));await v.createFolder(h,c,{name:C.trim(),icon:x,color:w,description:N.trim()||null,sort_order:F+1}),n?.("Folder created","success")}p(!1),j(),o?.()}catch(F){console.error("Error saving folder:",F),F.message?.includes("duplicate key")||F.code==="23505"?n?.("A folder with this name already exists","error"):n?.("Failed to save folder","error")}finally{k(!1)}},O=async a=>{if(confirm(`Delete "${a.name}"? Documents in this folder will be moved to Unfiled.`)){y(a.id);try{await v.deleteFolder(a.id),n?.("Folder deleted","success"),o?.()}catch(F){console.error("Error deleting folder:",F),n?.("Failed to delete folder","error")}finally{y(null)}}},t=ee.find(a=>a.id===x),$=se.find(a=>a.id===w);return e.jsxs("div",{className:"folder-manager",children:[e.jsxs("div",{className:"folder-manager-header",children:[e.jsx("h3",{children:"Manage Folders"}),e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:b,children:[e.jsx(ne,{size:16}),"New Folder"]})]}),e.jsx("div",{className:"folder-manager-list",children:r.length===0?e.jsxs("div",{className:"folder-manager-empty",children:[e.jsx(G,{size:40}),e.jsx("p",{children:"No folders created yet"}),e.jsx("button",{className:"btn btn-secondary",onClick:b,children:"Create First Folder"})]}):r.map(a=>{const F=ee.find(I=>I.id===a.icon)?.icon||G,R=se.find(I=>I.id===a.color)?.hex||"#3b82f6";return e.jsxs("div",{className:"folder-manager-item",children:[e.jsx("div",{className:"folder-manager-item-drag",children:e.jsx(Oe,{size:16})}),e.jsx("div",{className:"folder-manager-item-icon",style:{backgroundColor:`${R}15`},children:e.jsx(F,{size:20,style:{color:R}})}),e.jsxs("div",{className:"folder-manager-item-info",children:[e.jsx("span",{className:"folder-manager-item-name",children:a.name}),e.jsxs("span",{className:"folder-manager-item-count",children:[a.document_count||0," documents"]})]}),e.jsxs("div",{className:"folder-manager-item-actions",children:[e.jsx("button",{className:"folder-action-btn",onClick:()=>U(a),title:"Edit folder",children:e.jsx($e,{size:16})}),e.jsx("button",{className:"folder-action-btn danger",onClick:()=>O(a),disabled:_===a.id,title:"Delete folder",children:_===a.id?e.jsx(L,{size:16,className:"spinner"}):e.jsx(Be,{size:16})})]})]},a.id)})}),V&&e.jsx("div",{className:"modal-overlay",onClick:()=>p(!1),children:e.jsxs("div",{className:"folder-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"folder-modal-header",children:[e.jsx("h3",{children:d?"Edit Folder":"Create Folder"}),e.jsx("button",{className:"modal-close",onClick:()=>p(!1),children:e.jsx(H,{size:20})})]}),e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{className:"folder-modal-content",children:[e.jsxs("div",{className:"folder-preview",children:[e.jsx("div",{className:"folder-preview-icon",style:{backgroundColor:`${$?.hex}15`},children:t&&e.jsx(t.icon,{size:40,style:{color:$?.hex}})}),e.jsx("span",{className:"folder-preview-name",children:C||"Folder Name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-name",children:"Folder Name *"}),e.jsx("input",{id:"folder-name",type:"text",value:C,onChange:a=>z(a.target.value),placeholder:"e.g., Site Plans, Safety Documents",autoFocus:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Icon"}),e.jsx("div",{className:"folder-icon-grid",children:ee.map(a=>e.jsx("button",{type:"button",className:`folder-icon-option ${x===a.id?"selected":""}`,onClick:()=>g(a.id),title:a.label,children:e.jsx(a.icon,{size:20})},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Color"}),e.jsx("div",{className:"folder-color-grid",children:se.map(a=>e.jsx("button",{type:"button",className:`folder-color-option ${w===a.id?"selected":""}`,onClick:()=>E(a.id),style:{backgroundColor:a.hex},title:a.label},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-desc",children:"Description (optional)"}),e.jsx("input",{id:"folder-desc",type:"text",value:N,onChange:a=>f(a.target.value),placeholder:"Brief description of folder contents"})]})]}),e.jsxs("div",{className:"folder-modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>p(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!C.trim()||D,children:D?e.jsxs(e.Fragment,{children:[e.jsx(L,{size:16,className:"spinner"}),"Saving..."]}):d?"Save Changes":"Create Folder"})]})]})]})})]})}const pe=c=>c?.startsWith("image/")?We:c?.includes("spreadsheet")||c?.includes("excel")?qe:c?.includes("pdf")?te:fe,xe=c=>{if(!c)return"0 B";const h=["B","KB","MB","GB"];let r=c,o=0;for(;r>=1024&&o<h.length-1;)r/=1024,o++;return`${r.toFixed(r<10?1:0)} ${h[o]}`},je=c=>c?new Date(c).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",T={blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b",red:"#ef4444",purple:"#8b5cf6",pink:"#ec4899",gray:"#6b7280",orange:"#f97316"};function as({project:c,companyId:h,onShowToast:r,userRole:o}){const[S,n]=l.useState([]),[V,p]=l.useState(!0),[d,A]=l.useState(null),[_,y]=l.useState([]),[D,k]=l.useState(!1),[C,z]=l.useState(!1),[x,g]=l.useState(0),[w,E]=l.useState(0),[N,f]=l.useState(""),[j,b]=l.useState(null),[U,M]=l.useState(!1),[O,t]=l.useState(!1),[$,a]=l.useState(!1),[F,R]=l.useState(null),[I,s]=l.useState(null),P=o==="office"||o==="administrator",Y=o==="foreman",B=l.useCallback(async()=>{p(!0);try{const i=await v.getProjectFolders(c.id);n(i)}catch(i){console.error("Error loading folders:",i),r?.("Failed to load folders","error")}finally{p(!1)}},[c.id,r]);l.useEffect(()=>{B()},[B]);const W=async(i,u=!1)=>{u&&(g(0),k(!0));try{const m=u?0:x,Q=await v.getFolderDocuments(i.id,{page:m,limit:He});y(u?Q.documents:K=>[...K,...Q.documents]),E(Q.totalCount),z(Q.hasMore)}catch(m){console.error("Error loading documents:",m),r?.("Failed to load documents","error")}finally{k(!1)}},Ce=i=>{A(i),f(""),b(null),W(i,!0)},ze=()=>{A(null),y([]),b(null),f("")},ie=l.useCallback(async i=>{if(f(i),!i.trim()){b(null);return}M(!0);try{const u=await v.searchDocuments(c.id,i.trim());b(u)}catch(u){console.error("Error searching documents:",u)}finally{M(!1)}},[c.id]),re=()=>{t(!1),s(null),B(),d&&W(d,!0),r?.("Document uploaded successfully","success")},q=async(i,u)=>{try{switch(i){case"view":R(u);break;case"download":await v.logDocumentAccess(u.id,"downloaded"),window.open(u.url||`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${u.storage_path}`,"_blank");break;case"archive":await v.archiveDocument(u.id),d&&W(d,!0),B(),r?.("Document archived","success");break;case"approve":await v.approveDocument(u.id),d&&W(d,!0),r?.("Document approved","success");break;default:break}}catch(m){console.error("Error performing action:",m),r?.("Action failed","error")}},J=i=>{s(i),t(!0)};if(Y)return e.jsx(Fe,{projectId:c.id,onShowToast:r});if(F)return e.jsx(Ke,{document:F,onBack:()=>R(null),onUpdate:()=>{d&&W(d,!0),B()},onShowToast:r,isOfficeOrAdmin:P});if(V)return e.jsx("div",{className:"documents-tab",children:e.jsxs("div",{className:"documents-loading",children:[e.jsx(L,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading folders..."})]})});if(d){const i=T[d.color]||T.blue,u=j!==null?j:_;return e.jsxs("div",{className:"documents-tab",children:[e.jsxs("div",{className:"documents-folder-header",children:[e.jsxs("button",{className:"back-btn",onClick:ze,children:[e.jsx(be,{size:20}),"Back"]}),e.jsxs("div",{className:"documents-folder-title",children:[e.jsx(G,{size:24,style:{color:i}}),e.jsx("h3",{children:d.name}),e.jsxs("span",{className:"documents-folder-count",children:[w," files"]})]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>J(d),children:[e.jsx(ae,{size:18}),"Upload"]})]}),e.jsx("div",{className:"documents-search-bar",children:e.jsxs("div",{className:"documents-search",children:[e.jsx(oe,{size:18,className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Search in folder...",value:N,onChange:m=>ie(m.target.value),className:"documents-search-input"}),N&&e.jsx("button",{className:"search-clear",onClick:()=>{f(""),b(null)},children:e.jsx(H,{size:16})}),U&&e.jsx(L,{size:16,className:"search-spinner"})]})}),j!==null&&e.jsxs("div",{className:"documents-search-results",children:[e.jsxs("span",{children:[j.length," result",j.length!==1?"s":"",' for "',N,'"']}),e.jsx("button",{onClick:()=>{f(""),b(null)},children:"Clear search"})]}),e.jsx("div",{className:"documents-list",children:D?e.jsxs("div",{className:"documents-loading",children:[e.jsx(L,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading documents..."})]}):u.length===0?e.jsxs("div",{className:"documents-empty",children:[e.jsx(G,{size:48,style:{color:i,opacity:.3}}),e.jsx("h3",{children:"No documents"}),e.jsx("p",{children:j!==null?"No documents match your search.":"Upload your first document to this folder."}),j===null&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>J(d),children:[e.jsx(ae,{size:18}),"Upload Document"]})]}):e.jsxs(e.Fragment,{children:[u.map(m=>{const Q=pe(m.mime_type),K=m.approval_status==="pending";return e.jsxs("div",{className:`document-card ${K?"pending":""}`,children:[e.jsx("div",{className:"document-icon",children:e.jsx(Q,{size:24})}),e.jsxs("div",{className:"document-info",children:[e.jsxs("div",{className:"document-name",children:[m.name,m.version>1&&e.jsxs("span",{className:"document-version",children:["v",m.version]})]}),e.jsxs("div",{className:"document-meta",children:[e.jsx("span",{children:xe(m.file_size_bytes)}),e.jsx("span",{children:je(m.uploaded_at)})]})]}),K&&e.jsx("span",{className:"status-badge pending",children:"Pending"}),e.jsxs("div",{className:"document-actions",children:[e.jsx("button",{className:"document-action-btn",onClick:()=>q("view",m),title:"View details",children:e.jsx(le,{size:18})}),e.jsx("button",{className:"document-action-btn",onClick:()=>q("download",m),title:"Download",children:e.jsx(X,{size:18})}),K&&e.jsx("button",{className:"document-action-btn approve",onClick:()=>q("approve",m),title:"Approve",children:e.jsx(ge,{size:18})}),e.jsx("button",{className:"document-action-btn danger",onClick:()=>q("archive",m),title:"Archive",children:e.jsx(ve,{size:18})})]})]},m.id)}),C&&j===null&&e.jsx("div",{className:"documents-load-more",children:e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{g(m=>m+1),W(d,!1)},disabled:D,children:["Load More (",_.length," of ",w,")"]})})]})}),O&&e.jsx(ue,{projectId:c.id,companyId:h,folderId:I?.id,folderName:I?.name,onClose:()=>{t(!1),s(null)},onUploadComplete:re,onShowToast:r})]})}return e.jsxs("div",{className:"documents-tab",children:[e.jsxs("div",{className:"documents-header",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>a(!0),children:[e.jsx(Ve,{size:18}),"Manage Folders"]}),e.jsxs("div",{className:"documents-search",children:[e.jsx(oe,{size:18,className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Search all documents...",value:N,onChange:i=>ie(i.target.value),className:"documents-search-input"}),N&&e.jsx("button",{className:"search-clear",onClick:()=>{f(""),b(null)},children:e.jsx(H,{size:16})}),U&&e.jsx(L,{size:16,className:"search-spinner"})]})]}),j!==null?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"documents-search-results",children:[e.jsxs("span",{children:[j.length," result",j.length!==1?"s":"",' for "',N,'"']}),e.jsx("button",{onClick:()=>{f(""),b(null)},children:"Clear search"})]}),e.jsx("div",{className:"documents-list",children:j.map(i=>{const u=pe(i.mime_type);return e.jsxs("div",{className:"document-card",children:[e.jsx("div",{className:"document-icon",children:e.jsx(u,{size:24})}),e.jsxs("div",{className:"document-info",children:[e.jsx("div",{className:"document-name",children:i.name}),e.jsxs("div",{className:"document-meta",children:[e.jsx("span",{children:xe(i.file_size_bytes)}),e.jsx("span",{children:je(i.uploaded_at)})]})]}),e.jsxs("div",{className:"document-actions",children:[e.jsx("button",{className:"document-action-btn",onClick:()=>q("view",i),children:e.jsx(le,{size:18})}),e.jsx("button",{className:"document-action-btn",onClick:()=>q("download",i),children:e.jsx(X,{size:18})})]})]},i.id)})})]}):e.jsx("div",{className:"documents-folder-grid",children:S.length===0?e.jsxs("div",{className:"documents-empty",children:[e.jsx(Ge,{size:64}),e.jsx("h3",{children:"No folders yet"}),e.jsx("p",{children:"Create folders to organize your project documents."}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>a(!0),children:[e.jsx(ne,{size:18}),"Create Folder"]})]}):S.map(i=>{const u=T[i.color]||T.blue;return e.jsxs("button",{className:"documents-folder-card",onClick:()=>Ce(i),children:[e.jsx("div",{className:"documents-folder-icon",style:{backgroundColor:`${u}15`},children:e.jsx(G,{size:32,style:{color:u}})}),e.jsxs("div",{className:"documents-folder-info",children:[e.jsx("span",{className:"documents-folder-name",children:i.name}),e.jsxs("span",{className:"documents-folder-meta",children:[i.document_count||0," ",i.document_count===1?"file":"files"]})]}),e.jsx("button",{className:"documents-folder-upload",onClick:m=>{m.stopPropagation(),J(i)},title:"Upload to folder",children:e.jsx(ne,{size:20})})]},i.id)})}),$&&e.jsx("div",{className:"modal-overlay",onClick:()=>a(!1),children:e.jsxs("div",{className:"folder-manager-modal",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"folder-manager-modal-header",children:[e.jsx("h2",{children:"Folder Management"}),e.jsx("button",{className:"modal-close",onClick:()=>a(!1),children:e.jsx(H,{size:20})})]}),e.jsx(Te,{projectId:c.id,companyId:h,folders:S,onFoldersChange:B,onClose:()=>a(!1),onShowToast:r})]})}),O&&e.jsx(ue,{projectId:c.id,companyId:h,folderId:I?.id,folderName:I?.name,onClose:()=>{t(!1),s(null)},onUploadComplete:re,onShowToast:r})]})}export{as as default};
//# sourceMappingURL=DocumentsTab-CxcHFwwN.js.map
