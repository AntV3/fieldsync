import{aE as m,as as e}from"./index-Cp3nbsT5.js";import{r as o,N as Y,X as Z,_ as $,aE as ee,D as se,a9 as te}from"./icons-DsFyWu_8.js";import{f as i}from"./corCalculations-vdJc_BOT.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";const de=o.memo(function({project:h,company:U,areas:T=[],corStats:X={},editDrawRequest:n=null,onSave:G,onClose:b,onDownloadPDF:F}){const[H,D]=o.useState(!0),[N,E]=o.useState(!1),[f,M]=o.useState(1),[z,R]=o.useState(""),[q,B]=o.useState(new Date().toISOString().split("T")[0]),[j,k]=o.useState(10),[A,I]=o.useState(""),[v,y]=o.useState([]),[J,O]=o.useState(0),[_,L]=o.useState(0),w=!!n,P=o.useMemo(()=>T.reduce((s,t)=>{const a=(t.square_footage||0)*(t.price_per_sqft||0);return s+Math.round(a*100)},0),[T]),g=X?.approvedTotal||0,K=P+g,V=o.useCallback(async()=>{if(h?.id)try{if(D(!0),n){M(n.draw_number),R(n.period_start||""),B(n.period_end||""),k((n.retention_percent||1e3)/100),I(n.notes||""),O(n.previous_billings||0),L(n.previous_retention||0);const s=await m.getDrawRequest(n.id);s?.draw_request_items&&y(s.draw_request_items.map(t=>({...t,current_percent_input:(t.current_percent||0)/100})))}else{const s=await m.getNextDrawNumber(h.id);M(s);const{totalBilled:t,totalRetention:a}=await m.getPreviousBillingTotals(h.id);O(t),L(a);const l=await m.getPreviousDrawItems(h.id),r=await m.getScheduleOfValues(h.id);y(r.map(u=>{const d=l[u.area_id]||{previous_percent:0,previous_amount:0};return{...u,previous_percent:d.previous_percent,previous_amount:d.previous_amount,current_percent:0,current_percent_input:0,current_amount:0}}))}}catch(s){console.error("Error initializing draw request:",s)}finally{D(!1)}},[h?.id,n]);o.useEffect(()=>{V()},[V]);const Q=(s,t)=>{const a=parseFloat(t)||0,l=v[s],u=100-(l.previous_percent||0)/100,d=Math.min(Math.max(0,a),u),C=m.calculateAmountFromPercent(d*100,l.scheduled_value);y(S=>S.map((p,x)=>x===s?{...p,current_percent_input:d,current_percent:Math.round(d*100),current_amount:C}:p))},c=o.useMemo(()=>{const s=v.reduce((p,x)=>p+(x.scheduled_value||0),0),t=v.reduce((p,x)=>p+(x.previous_amount||0),0),a=v.reduce((p,x)=>p+(x.current_amount||0),0),l=t+a,r=j*100,u=Math.round(l*r/1e4),d=u-_,C=a-d,S=s-l;return{scheduledTotal:s,previousTotal:t,currentTotal:a,completedTotal:l,totalRetention:u,currentRetentionChange:d,paymentDue:C,balanceToFinish:S}},[v,j,_]),W=async s=>{if(s.preventDefault(),c.currentTotal===0){alert("Please enter at least one line item with work completed this period.");return}try{E(!0);const t={project_id:h.id,company_id:U.id,draw_number:f,period_start:z||null,period_end:q||null,retention_percent:Math.round(j*100),original_contract:P,approved_changes:g,previous_billings:J,current_billing:c.currentTotal,retention_held:c.totalRetention,previous_retention:_,notes:A.trim()||null},a=v.map(r=>({area_id:r.area_id,item_number:r.item_number,description:r.description,scheduled_value:r.scheduled_value,previous_percent:r.previous_percent||0,previous_amount:r.previous_amount||0,current_percent:r.current_percent||0,current_amount:r.current_amount||0}));let l;w?(await m.updateDrawRequest(n.id,t),await m.updateDrawRequestItems(n.id,a),l=await m.getDrawRequest(n.id)):l=await m.createDrawRequest(t,a),G?.(l)}catch(t){console.error("Error saving draw request:",t),alert("Failed to save draw request. Please try again.")}finally{E(!1)}};return e.jsx("div",{className:"modal-overlay",onClick:b,children:e.jsxs("div",{className:"modal-content draw-request-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:[e.jsx(Y,{size:20}),w?`Edit Draw #${f}`:`Create Draw #${f}`]}),e.jsx("button",{className:"close-btn",onClick:b,"aria-label":"Close",children:e.jsx(Z,{size:20})})]}),H?e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"draw-request-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading schedule of values..."})]})}):e.jsxs("form",{onSubmit:W,children:[e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"draw-request-header-fields",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"period-start",children:[e.jsx($,{size:14}),"Period Start"]}),e.jsx("input",{id:"period-start",type:"date",value:z,onChange:s=>R(s.target.value),className:"form-input"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"period-end",children:[e.jsx($,{size:14}),"Period End"]}),e.jsx("input",{id:"period-end",type:"date",value:q,onChange:s=>B(s.target.value),className:"form-input",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"retention",children:[e.jsx(ee,{size:14}),"Retention"]}),e.jsxs("div",{className:"input-with-suffix",children:[e.jsx("input",{id:"retention",type:"number",step:"0.5",min:"0",max:"20",value:j,onChange:s=>k(parseFloat(s.target.value)||0),className:"form-input"}),e.jsx("span",{className:"input-suffix",children:"%"})]})]})]}),e.jsxs("div",{className:"draw-contract-summary",children:[e.jsxs("div",{className:"contract-item",children:[e.jsx("span",{children:"Original Contract"}),e.jsx("span",{children:i(P)})]}),g>0&&e.jsxs("div",{className:"contract-item",children:[e.jsx("span",{children:"Approved COs"}),e.jsxs("span",{className:"positive",children:["+",i(g)]})]}),e.jsxs("div",{className:"contract-item total",children:[e.jsx("span",{children:"Revised Contract"}),e.jsx("span",{children:i(K)})]})]}),e.jsx("div",{className:"sov-table-container",children:e.jsxs("table",{className:"sov-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sov-col-num",children:"#"}),e.jsx("th",{className:"sov-col-desc",children:"Description"}),e.jsx("th",{className:"sov-col-scheduled",children:"Scheduled Value"}),e.jsx("th",{className:"sov-col-prev",children:"Previous %"}),e.jsx("th",{className:"sov-col-current",children:"This Period %"}),e.jsx("th",{className:"sov-col-total",children:"Total %"}),e.jsx("th",{className:"sov-col-amount",children:"This Amount"})]})}),e.jsx("tbody",{children:v.map((s,t)=>{const a=(s.previous_percent||0)/100,l=s.current_percent_input||0,r=a+l,u=r>=100;return e.jsxs("tr",{className:u?"complete":"",children:[e.jsx("td",{className:"sov-col-num",children:s.item_number}),e.jsx("td",{className:"sov-col-desc",children:s.description}),e.jsx("td",{className:"sov-col-scheduled",children:i(s.scheduled_value)}),e.jsxs("td",{className:"sov-col-prev",children:[a.toFixed(0),"%"]}),e.jsx("td",{className:"sov-col-current",children:u&&a>=100?e.jsx("span",{className:"complete-indicator",children:"-"}):e.jsxs("div",{className:"sov-input-wrapper",children:[e.jsx("input",{type:"number",step:"1",min:"0",max:100-a,value:l||"",onChange:d=>Q(t,d.target.value),className:"sov-percent-input",placeholder:"0"}),e.jsx("span",{className:"sov-input-suffix",children:"%"})]})}),e.jsx("td",{className:"sov-col-total",children:e.jsxs("span",{className:r>=100?"complete":"",children:[r.toFixed(0),"%"]})}),e.jsx("td",{className:"sov-col-amount",children:s.current_amount>0?i(s.current_amount):"-"})]},s.area_id||t)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"sov-totals",children:[e.jsx("td",{colSpan:"2",children:"Totals"}),e.jsx("td",{children:i(c.scheduledTotal)}),e.jsx("td",{}),e.jsx("td",{}),e.jsx("td",{}),e.jsx("td",{children:i(c.currentTotal)})]})})]})}),e.jsxs("div",{className:"draw-summary",children:[e.jsxs("div",{className:"draw-summary-row",children:[e.jsx("span",{children:"Previous Billings"}),e.jsx("span",{children:i(c.previousTotal)})]}),e.jsxs("div",{className:"draw-summary-row current",children:[e.jsx("span",{children:"Current Billing (This Draw)"}),e.jsx("span",{children:i(c.currentTotal)})]}),e.jsxs("div",{className:"draw-summary-row",children:[e.jsx("span",{children:"Total Completed"}),e.jsx("span",{children:i(c.completedTotal)})]}),e.jsx("div",{className:"draw-summary-divider"}),e.jsxs("div",{className:"draw-summary-row retention",children:[e.jsxs("span",{children:["Retention (",j,"%)"]}),e.jsxs("span",{children:["-",i(c.totalRetention)]})]}),_>0&&e.jsxs("div",{className:"draw-summary-row",children:[e.jsx("span",{children:"Less Previous Retention"}),e.jsxs("span",{children:["+",i(_)]})]}),e.jsx("div",{className:"draw-summary-divider"}),e.jsxs("div",{className:"draw-summary-row total",children:[e.jsx("span",{children:"Current Payment Due"}),e.jsx("span",{children:i(c.paymentDue)})]}),e.jsxs("div",{className:"draw-summary-row balance",children:[e.jsx("span",{children:"Balance to Finish"}),e.jsx("span",{children:i(c.balanceToFinish)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"draw-notes",children:"Notes (optional)"}),e.jsx("textarea",{id:"draw-notes",value:A,onChange:s=>I(s.target.value),placeholder:"Additional notes for this draw request...",className:"form-textarea",rows:2})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:b,disabled:N,children:"Cancel"}),w&&F&&e.jsxs("button",{type:"button",className:"btn btn-outline",onClick:()=>F?.(n),disabled:N,children:[e.jsx(se,{size:16}),"Download PDF"]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:N||c.currentTotal===0,children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"loading-spinner small"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{size:16}),w?"Update Draw":"Create Draw"]})})]})]})]})})});export{de as default};
//# sourceMappingURL=DrawRequestModal-DtoRspge.js.map
