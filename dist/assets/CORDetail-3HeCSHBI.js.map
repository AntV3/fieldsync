{"version":3,"mappings":"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","names":["ExportStatus","ExportType","generateIdempotencyKey","corId","corVersion","customKey","minuteTimestamp","generateForcedExportKey","createSnapshot","cor","tickets","options","snapshotTime","photoManifest","totalPhotos","ticket","ticketPhotos","photoUrl","laborTotal","sum","item","materialsTotal","equipmentTotal","subcontractorsTotal","totalLaborHours","totalOTHours","worker","dataString","hash","i","char","checksum","w","t","requestExport","forceNew","idempotencyKey","exportType","includeBackup","corError","supabase","key","data","error","job","observe","err","updateJobStatus","jobId","status","details","saveSnapshot","snapshot","executeExport","project","company","branding","db","__vitePreload","n","savedSnapshot","generatePDFFromSnapshot","pdfResult","SignatureCapture","onSave","onClose","initialName","canvasRef","useRef","signerName","setSignerName","useState","hasSignature","setHasSignature","isDrawing","setIsDrawing","getContext","canvas","getPosition","e","rect","scaleX","scaleY","clientX","clientY","startDrawing","ctx","x","y","draw","stopDrawing","clearSignature","initCanvas","handleSave","signatureData","jsx","jsxs","X","Pen","RotateCcw","Check","CORDetail","areas","onEdit","onShowToast","onStatusChange","loading","setLoading","corData","setCORData","showSignature","setShowSignature","showSignatureLink","setShowSignatureLink","expandedTickets","setExpandedTickets","selectedPhoto","setSelectedPhoto","editingNumber","setEditingNumber","newCorNumber","setNewCorNumber","fetchFullCOR","useCallback","fullCOR","useEffect","subscription","totals","useMemo","calculateCORTotals","statusInfo","getStatusInfo","canApprove","canEdit","getAreaName","areaId","a","handleApprove","handleReject","reason","handleMarkBilled","handleSaveSignature","canSign","handleUpdateCorNumber","startEditingNumber","toggleTicketExpanded","ticketId","prev","next","associatedTickets","assoc","getTicketHours","workers","regular","overtime","handleExportPDF","Pencil","Clock","formatDateRange","FileText","DollarSign","Users","formatCurrency","idx","centsToDollars","formatPercent","Package","Truck","Briefcase","Percent","Shield","Building2","isExpanded","hours","workerCount","itemCount","photoCount","ChevronDown","ChevronRight","Calendar","formatDate","Image","PenTool","Stamp","XCircle","Edit3","Fragment","CheckCircle","Link","Download","SignatureLinkGenerator"],"ignoreList":[],"sources":["../../src/lib/corExportPipeline.js","../../src/components/cor/SignatureCapture.jsx","../../src/components/cor/CORDetail.jsx"],"sourcesContent":["// ============================================\n// COR Export Pipeline\n// ============================================\n// Industrial-grade, idempotent, snapshot-based export system\n//\n// Core Principles (from specification):\n// 1. Idempotency - Repeat requests return same result\n// 2. Deterministic - Same COR state = same export output\n// 3. Async by default - Heavy operations don't block UI\n// 4. Fail loudly - All failures are detectable and recoverable\n// 5. Separation of concerns - Creation, aggregation, export decoupled\n//\n// This module orchestrates the export pipeline:\n// 1. Request export (idempotent, returns job)\n// 2. Create snapshot (frozen state)\n// 3. Generate PDF (from snapshot only)\n// 4. Return result (stable, immutable)\n// ============================================\n\nimport { supabase } from './supabase'\nimport { observe } from './observability'\n\n// ============================================\n// CONSTANTS\n// ============================================\n\nexport const ExportStatus = {\n  PENDING: 'pending',\n  GENERATING: 'generating',\n  COMPLETED: 'completed',\n  FAILED: 'failed'\n}\n\nexport const ExportType = {\n  PDF: 'pdf',\n  EMAIL: 'email',\n  DOWNLOAD: 'download'\n}\n\n// ============================================\n// IDEMPOTENCY KEY GENERATION\n// ============================================\n\n/**\n * Generate a deterministic idempotency key for an export request\n * Key format: cor_{corId}_v{version}_{timestamp_minute}\n *\n * Same COR at same version within same minute = same key\n * This prevents duplicate exports while allowing re-exports after changes\n */\nexport function generateIdempotencyKey(corId, corVersion, customKey = null) {\n  if (customKey) {\n    return `custom_${customKey}`\n  }\n\n  // Round timestamp to minute for deduplication window\n  const minuteTimestamp = Math.floor(Date.now() / 60000)\n  return `cor_${corId}_v${corVersion || 1}_${minuteTimestamp}`\n}\n\n/**\n * Generate a forced-new idempotency key (for explicit re-exports)\n * Includes millisecond timestamp to guarantee uniqueness\n */\nexport function generateForcedExportKey(corId) {\n  return `cor_${corId}_force_${Date.now()}`\n}\n\n// ============================================\n// SNAPSHOT CREATION\n// ============================================\n\n/**\n * Create a frozen snapshot of COR data for export\n * Snapshots are immutable - once created, never change\n *\n * @param {Object} cor - Full COR data with line items\n * @param {Object[]} tickets - Associated T&M tickets with workers/items/photos\n * @param {Object} options - Snapshot options\n * @returns {Object} Frozen snapshot ready for PDF generation\n */\nexport function createSnapshot(cor, tickets, options = {}) {\n  const snapshotTime = new Date().toISOString()\n\n  // Calculate photo manifest\n  const photoManifest = []\n  let totalPhotos = 0\n\n  for (const ticket of (tickets || [])) {\n    const ticketPhotos = ticket.photos || []\n    totalPhotos += ticketPhotos.length\n\n    for (const photoUrl of ticketPhotos) {\n      photoManifest.push({\n        ticketId: ticket.id,\n        workDate: ticket.work_date,\n        url: photoUrl,\n        verified: false, // Will be verified during PDF generation\n        includedInExport: true\n      })\n    }\n  }\n\n  // Calculate totals from line items\n  const laborTotal = (cor.change_order_labor || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const materialsTotal = (cor.change_order_materials || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const equipmentTotal = (cor.change_order_equipment || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const subcontractorsTotal = (cor.change_order_subcontractors || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n\n  // Calculate labor hours from tickets\n  let totalLaborHours = 0\n  let totalOTHours = 0\n  for (const ticket of (tickets || [])) {\n    for (const worker of (ticket.t_and_m_workers || [])) {\n      totalLaborHours += parseFloat(worker.hours) || 0\n      totalOTHours += parseFloat(worker.overtime_hours) || 0\n    }\n  }\n\n  // Create deterministic checksum\n  const dataString = JSON.stringify({\n    corId: cor.id,\n    version: cor.version,\n    totals: { laborTotal, materialsTotal, equipmentTotal, subcontractorsTotal },\n    ticketCount: tickets?.length || 0,\n    photoCount: totalPhotos\n  })\n\n  let hash = 0\n  for (let i = 0; i < dataString.length; i++) {\n    const char = dataString.charCodeAt(i)\n    hash = ((hash << 5) - hash) + char\n    hash = hash & hash\n  }\n  const checksum = Math.abs(hash).toString(16).padStart(16, '0')\n\n  return {\n    // Metadata\n    snapshotId: crypto.randomUUID(),\n    corId: cor.id,\n    corVersion: cor.version || 1,\n    createdAt: snapshotTime,\n    checksum,\n\n    // Frozen COR data\n    corData: {\n      id: cor.id,\n      cor_number: cor.cor_number,\n      title: cor.title,\n      description: cor.description,\n      scope_of_work: cor.scope_of_work,\n      status: cor.status,\n      period_start: cor.period_start,\n      period_end: cor.period_end,\n\n      // Line items (frozen)\n      change_order_labor: cor.change_order_labor || [],\n      change_order_materials: cor.change_order_materials || [],\n      change_order_equipment: cor.change_order_equipment || [],\n      change_order_subcontractors: cor.change_order_subcontractors || [],\n\n      // Percentages\n      labor_markup_percent: cor.labor_markup_percent,\n      materials_markup_percent: cor.materials_markup_percent,\n      equipment_markup_percent: cor.equipment_markup_percent,\n      subcontractors_markup_percent: cor.subcontractors_markup_percent,\n      liability_insurance_percent: cor.liability_insurance_percent,\n      bond_percent: cor.bond_percent,\n      license_fee_percent: cor.license_fee_percent,\n\n      // Calculated amounts (frozen)\n      labor_subtotal: cor.labor_subtotal,\n      materials_subtotal: cor.materials_subtotal,\n      equipment_subtotal: cor.equipment_subtotal,\n      subcontractors_subtotal: cor.subcontractors_subtotal,\n      labor_markup_amount: cor.labor_markup_amount,\n      materials_markup_amount: cor.materials_markup_amount,\n      equipment_markup_amount: cor.equipment_markup_amount,\n      subcontractors_markup_amount: cor.subcontractors_markup_amount,\n      liability_insurance_amount: cor.liability_insurance_amount,\n      bond_amount: cor.bond_amount,\n      license_fee_amount: cor.license_fee_amount,\n      cor_subtotal: cor.cor_subtotal,\n      additional_fees_total: cor.additional_fees_total,\n      cor_total: cor.cor_total,\n\n      // Signature data\n      gc_signature_data: cor.gc_signature_data,\n      gc_signature_name: cor.gc_signature_name,\n      gc_signature_date: cor.gc_signature_date,\n\n      // Audit\n      created_at: cor.created_at,\n      submitted_at: cor.submitted_at,\n      approved_at: cor.approved_at\n    },\n\n    // Frozen tickets data\n    ticketsData: (tickets || []).map(ticket => ({\n      id: ticket.id,\n      work_date: ticket.work_date,\n      ticket_date: ticket.ticket_date,\n      ce_pco_number: ticket.ce_pco_number,\n      notes: ticket.notes,\n      status: ticket.status,\n      created_at: ticket.created_at,\n\n      // Workers (frozen)\n      t_and_m_workers: (ticket.t_and_m_workers || []).map(w => ({\n        id: w.id,\n        name: w.name,\n        role: w.role,\n        labor_class: w.labor_class,\n        hours: w.hours,\n        overtime_hours: w.overtime_hours,\n        time_started: w.time_started,\n        time_ended: w.time_ended\n      })),\n\n      // Items (frozen)\n      t_and_m_items: (ticket.t_and_m_items || []).map(item => ({\n        id: item.id,\n        description: item.description,\n        quantity: item.quantity,\n        unit: item.unit,\n        materials_equipment: item.materials_equipment\n      })),\n\n      // Photos (frozen URLs)\n      photos: ticket.photos || [],\n\n      // Client verification (frozen)\n      client_signature_data: ticket.client_signature_data,\n      client_signature_name: ticket.client_signature_name,\n      client_signature_title: ticket.client_signature_title,\n      client_signature_company: ticket.client_signature_company,\n      client_signature_date: ticket.client_signature_date\n    })),\n\n    // Photo manifest for verification\n    photoManifest,\n\n    // Pre-calculated totals\n    totals: {\n      laborTotal,\n      materialsTotal,\n      equipmentTotal,\n      subcontractorsTotal,\n      totalLaborHours,\n      totalOTHours,\n      ticketCount: tickets?.length || 0,\n      photoCount: totalPhotos,\n      verifiedTicketCount: (tickets || []).filter(t => t.client_signature_data).length\n    }\n  }\n}\n\n// ============================================\n// EXPORT JOB MANAGEMENT\n// ============================================\n\n/**\n * Request a COR export (idempotent)\n * Returns existing job if same idempotency key, otherwise creates new job\n *\n * @param {string} corId - COR ID to export\n * @param {Object} options - Export options\n * @returns {Promise<Object>} Export job with status\n */\nexport async function requestExport(corId, options = {}) {\n  const {\n    forceNew = false,\n    idempotencyKey = null,\n    exportType = ExportType.PDF,\n    includeBackup = true\n  } = options\n\n  try {\n    // Get COR version for idempotency key\n    const { data: cor, error: corError } = await supabase\n      .from('change_orders')\n      .select('id, version, cor_number')\n      .eq('id', corId)\n      .single()\n\n    if (corError || !cor) {\n      throw new Error(`COR not found: ${corId}`)\n    }\n\n    // Generate idempotency key\n    const key = forceNew\n      ? generateForcedExportKey(corId)\n      : (idempotencyKey || generateIdempotencyKey(corId, cor.version))\n\n    // Request export via RPC (handles idempotency in database)\n    const { data, error } = await supabase.rpc('request_cor_export', {\n      p_cor_id: corId,\n      p_idempotency_key: key,\n      p_options: { exportType, includeBackup },\n      p_requested_by: (await supabase.auth.getUser())?.data?.user?.id\n    })\n\n    if (error) {\n      throw error\n    }\n\n    const job = data?.[0]\n    if (!job) {\n      throw new Error('Failed to create export job')\n    }\n\n    observe.activity('cor_export_requested', {\n      cor_id: corId,\n      job_id: job.job_id,\n      is_new: job.is_new,\n      status: job.status\n    })\n\n    return {\n      jobId: job.job_id,\n      status: job.status,\n      isNew: job.is_new,\n      snapshotId: job.snapshot_id,\n      pdfUrl: job.pdf_url,\n      idempotencyKey: key\n    }\n  } catch (err) {\n    observe.error('cor_export_request_failed', {\n      cor_id: corId,\n      error: err.message\n    })\n    throw err\n  }\n}\n\n/**\n * Get export job status\n * @param {string} jobId - Export job ID\n * @returns {Promise<Object>} Job status with all details\n */\nexport async function getExportJobStatus(jobId) {\n  const { data, error } = await supabase\n    .from('cor_export_jobs')\n    .select('*')\n    .eq('id', jobId)\n    .single()\n\n  if (error) {\n    throw error\n  }\n\n  return data\n}\n\n/**\n * Get export history for a COR\n * @param {string} corId - COR ID\n * @param {number} limit - Max results\n * @returns {Promise<Object[]>} Export jobs ordered by date\n */\nexport async function getExportHistory(corId, limit = 10) {\n  const { data, error } = await supabase\n    .from('cor_export_jobs')\n    .select('*')\n    .eq('cor_id', corId)\n    .order('created_at', { ascending: false })\n    .limit(limit)\n\n  if (error) {\n    throw error\n  }\n\n  return data || []\n}\n\n/**\n * Update export job status (internal use)\n * @param {string} jobId - Job ID\n * @param {string} status - New status\n * @param {Object} details - Additional details\n */\nexport async function updateJobStatus(jobId, status, details = {}) {\n  const { data, error } = await supabase.rpc('update_export_job_status', {\n    p_job_id: jobId,\n    p_status: status,\n    p_snapshot_id: details.snapshotId || null,\n    p_pdf_url: details.pdfUrl || null,\n    p_error: details.error || null,\n    p_error_details: details.errorDetails || null,\n    p_metrics: details.metrics || null\n  })\n\n  if (error) {\n    observe.error('cor_export_job_update_failed', {\n      job_id: jobId,\n      status,\n      error: error.message\n    })\n    throw error\n  }\n\n  return data\n}\n\n// ============================================\n// SNAPSHOT STORAGE\n// ============================================\n\n/**\n * Save snapshot to database\n * @param {Object} snapshot - Frozen snapshot data\n * @param {string} jobId - Associated job ID\n * @returns {Promise<Object>} Saved snapshot record\n */\nexport async function saveSnapshot(snapshot, jobId) {\n  // Mark previous snapshots as not current\n  await supabase\n    .from('cor_export_snapshots')\n    .update({ is_current: false })\n    .eq('cor_id', snapshot.corId)\n\n  const { data, error } = await supabase\n    .from('cor_export_snapshots')\n    .insert({\n      id: snapshot.snapshotId,\n      cor_id: snapshot.corId,\n      job_id: jobId,\n      cor_version: snapshot.corVersion,\n      cor_data: snapshot.corData,\n      tickets_data: snapshot.ticketsData,\n      photos_manifest: snapshot.photoManifest,\n      totals_snapshot: snapshot.totals,\n      checksum: snapshot.checksum,\n      is_current: true,\n      exported_by: (await supabase.auth.getUser())?.data?.user?.id\n    })\n    .select()\n    .single()\n\n  if (error) {\n    throw error\n  }\n\n  // Update COR's last snapshot version\n  await supabase\n    .from('change_orders')\n    .update({ last_snapshot_version: snapshot.corVersion })\n    .eq('id', snapshot.corId)\n\n  return data\n}\n\n/**\n * Get current snapshot for a COR (if exists and still valid)\n * @param {string} corId - COR ID\n * @returns {Promise<Object|null>} Current snapshot or null\n */\nexport async function getCurrentSnapshot(corId) {\n  // Get COR's current version\n  const { data: cor } = await supabase\n    .from('change_orders')\n    .select('version, last_snapshot_version')\n    .eq('id', corId)\n    .single()\n\n  // If version has changed since last snapshot, snapshot is stale\n  if (cor?.version !== cor?.last_snapshot_version) {\n    return null\n  }\n\n  // Get current snapshot\n  const { data: snapshot } = await supabase\n    .from('cor_export_snapshots')\n    .select('*')\n    .eq('cor_id', corId)\n    .eq('is_current', true)\n    .single()\n\n  return snapshot || null\n}\n\n// ============================================\n// FULL EXPORT ORCHESTRATION\n// ============================================\n\n/**\n * Execute full export pipeline\n * This is the main entry point for COR exports\n *\n * Pipeline:\n * 1. Request export (idempotent)\n * 2. If new job, create snapshot\n * 3. Generate PDF from snapshot\n * 4. Update job with result\n *\n * @param {string} corId - COR to export\n * @param {Object} cor - Full COR data (optional, will fetch if not provided)\n * @param {Object[]} tickets - Associated tickets (optional, will fetch if not provided)\n * @param {Object} project - Project data\n * @param {Object} company - Company data\n * @param {Object} branding - Company branding\n * @param {Object} options - Export options\n * @returns {Promise<Object>} Export result\n */\nexport async function executeExport(corId, { cor, tickets, project, company, branding, options = {} } = {}) {\n  let job = null\n\n  try {\n    // Step 1: Request export (idempotent)\n    job = await requestExport(corId, options)\n\n    // If job already completed, return existing result\n    if (job.status === ExportStatus.COMPLETED && job.pdfUrl) {\n      observe.activity('cor_export_cache_hit', {\n        cor_id: corId,\n        job_id: job.jobId\n      })\n      return {\n        success: true,\n        jobId: job.jobId,\n        cached: true,\n        pdfUrl: job.pdfUrl\n      }\n    }\n\n    // If job is already generating, return job for polling\n    if (job.status === ExportStatus.GENERATING) {\n      return {\n        success: true,\n        jobId: job.jobId,\n        status: ExportStatus.GENERATING,\n        message: 'Export already in progress'\n      }\n    }\n\n    // Step 2: Mark job as generating\n    await updateJobStatus(job.jobId, ExportStatus.GENERATING)\n\n    // Step 3: Fetch data if not provided\n    if (!cor) {\n      const { db } = await import('./supabase')\n      cor = await db.getCORById(corId)\n    }\n\n    if (!tickets && options.includeBackup !== false) {\n      const { db } = await import('./supabase')\n      tickets = await db.getCORTickets(corId)\n    }\n\n    // Step 4: Create snapshot\n    const snapshot = createSnapshot(cor, tickets, options)\n    const savedSnapshot = await saveSnapshot(snapshot, job.jobId)\n\n    // Step 5: Generate PDF from snapshot\n    // Import the PDF generator dynamically to avoid circular deps\n    const { generatePDFFromSnapshot } = await import('./corPdfGenerator')\n    const pdfResult = await generatePDFFromSnapshot(\n      snapshot,\n      { project, company, branding }\n    )\n\n    // Step 6: Update job as completed\n    await updateJobStatus(job.jobId, ExportStatus.COMPLETED, {\n      snapshotId: savedSnapshot.id,\n      pdfUrl: pdfResult.fileName,\n      metrics: {\n        photo_count: snapshot.totals.photoCount,\n        ticket_count: snapshot.totals.ticketCount,\n        page_count: pdfResult.pageCount || 1,\n        pdf_size_bytes: pdfResult.sizeBytes || 0\n      }\n    })\n\n    observe.activity('cor_export_completed', {\n      cor_id: corId,\n      job_id: job.jobId,\n      photo_count: snapshot.totals.photoCount,\n      ticket_count: snapshot.totals.ticketCount\n    })\n\n    return {\n      success: true,\n      jobId: job.jobId,\n      snapshotId: savedSnapshot.id,\n      fileName: pdfResult.fileName,\n      snapshot: snapshot.totals\n    }\n\n  } catch (err) {\n    // Update job as failed\n    if (job?.jobId) {\n      await updateJobStatus(job.jobId, ExportStatus.FAILED, {\n        error: err.message,\n        errorDetails: { stack: err.stack }\n      }).catch(() => {}) // Don't throw on status update failure\n    }\n\n    observe.error('cor_export_failed', {\n      cor_id: corId,\n      job_id: job?.jobId,\n      error: err.message\n    })\n\n    throw err\n  }\n}\n\n// ============================================\n// EXPORTS\n// ============================================\n\nexport default {\n  // Constants\n  ExportStatus,\n  ExportType,\n\n  // Key generation\n  generateIdempotencyKey,\n  generateForcedExportKey,\n\n  // Snapshot\n  createSnapshot,\n  saveSnapshot,\n  getCurrentSnapshot,\n\n  // Job management\n  requestExport,\n  getExportJobStatus,\n  getExportHistory,\n  updateJobStatus,\n\n  // Full pipeline\n  executeExport\n}\n","import { useState, useRef } from 'react'\nimport { X, Check, RotateCcw, Pen } from 'lucide-react'\n\nexport default function SignatureCapture({ onSave, onClose, signerName: initialName = '' }) {\n  const canvasRef = useRef(null)\n  const [signerName, setSignerName] = useState(initialName)\n  const [hasSignature, setHasSignature] = useState(false)\n  const [isDrawing, setIsDrawing] = useState(false)\n\n  // Get canvas context\n  const getContext = () => {\n    const canvas = canvasRef.current\n    if (!canvas) return null\n    return canvas.getContext('2d')\n  }\n\n  // Get position relative to canvas\n  const getPosition = (e) => {\n    const canvas = canvasRef.current\n    if (!canvas) return { x: 0, y: 0 }\n\n    const rect = canvas.getBoundingClientRect()\n    const scaleX = canvas.width / rect.width\n    const scaleY = canvas.height / rect.height\n\n    // Handle both mouse and touch events (with bounds checking)\n    const clientX = e.touches?.length ? e.touches[0].clientX : e.clientX\n    const clientY = e.touches?.length ? e.touches[0].clientY : e.clientY\n\n    return {\n      x: (clientX - rect.left) * scaleX,\n      y: (clientY - rect.top) * scaleY\n    }\n  }\n\n  // Start drawing\n  const startDrawing = (e) => {\n    e.preventDefault()\n    const ctx = getContext()\n    if (!ctx) return\n\n    const { x, y } = getPosition(e)\n    ctx.beginPath()\n    ctx.moveTo(x, y)\n    setIsDrawing(true)\n    setHasSignature(true)\n  }\n\n  // Continue drawing\n  const draw = (e) => {\n    if (!isDrawing) return\n    e.preventDefault()\n\n    const ctx = getContext()\n    if (!ctx) return\n\n    const { x, y } = getPosition(e)\n    ctx.lineTo(x, y)\n    ctx.stroke()\n  }\n\n  // Stop drawing\n  const stopDrawing = () => {\n    setIsDrawing(false)\n  }\n\n  // Clear signature\n  const clearSignature = () => {\n    const canvas = canvasRef.current\n    const ctx = getContext()\n    if (!canvas || !ctx) return\n\n    ctx.clearRect(0, 0, canvas.width, canvas.height)\n    setHasSignature(false)\n  }\n\n  // Initialize canvas\n  const initCanvas = (canvas) => {\n    if (!canvas) return\n    canvasRef.current = canvas\n\n    const ctx = canvas.getContext('2d')\n    ctx.strokeStyle = '#1e293b'\n    ctx.lineWidth = 2\n    ctx.lineCap = 'round'\n    ctx.lineJoin = 'round'\n  }\n\n  // Save signature\n  const handleSave = () => {\n    if (!hasSignature) {\n      return\n    }\n\n    if (!signerName.trim()) {\n      return\n    }\n\n    const canvas = canvasRef.current\n    if (!canvas) return\n\n    // Get signature as base64 PNG\n    const signatureData = canvas.toDataURL('image/png')\n\n    onSave({\n      signature: signatureData,\n      signerName: signerName.trim(),\n      signedAt: new Date().toISOString()\n    })\n  }\n\n  return (\n    <div className=\"modal-overlay\" onClick={onClose} role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"signature-title\">\n      <div className=\"modal-content signature-modal\" onClick={e => e.stopPropagation()}>\n        <div className=\"modal-header\">\n          <h2 id=\"signature-title\">GC Signature</h2>\n          <button className=\"close-btn\" onClick={onClose} aria-label=\"Close signature modal\"><X size={20} aria-hidden=\"true\" /></button>\n        </div>\n\n        <div className=\"modal-body signature-body\">\n          <div className=\"form-group\">\n            <label htmlFor=\"signer-name\">Signer Name *</label>\n            <input\n              id=\"signer-name\"\n              type=\"text\"\n              value={signerName}\n              onChange={(e) => setSignerName(e.target.value)}\n              placeholder=\"Enter full name\"\n              aria-required=\"true\"\n            />\n          </div>\n\n          <div className=\"signature-area\">\n            <div className=\"signature-label\" id=\"signature-instructions\">\n              <Pen size={16} aria-hidden=\"true\" />\n              <span>Sign below</span>\n            </div>\n\n            <div className=\"signature-canvas-container\">\n              <canvas\n                ref={initCanvas}\n                width={500}\n                height={200}\n                className=\"signature-canvas\"\n                onMouseDown={startDrawing}\n                onMouseMove={draw}\n                onMouseUp={stopDrawing}\n                onMouseLeave={stopDrawing}\n                onTouchStart={startDrawing}\n                onTouchMove={draw}\n                onTouchEnd={stopDrawing}\n                role=\"img\"\n                aria-label=\"Signature drawing area. Use mouse or touch to draw your signature.\"\n                aria-describedby=\"signature-instructions\"\n                tabIndex={0}\n              />\n\n              {!hasSignature && (\n                <div className=\"signature-placeholder\">\n                  Sign here\n                </div>\n              )}\n            </div>\n\n            <button\n              className=\"btn btn-ghost btn-small\"\n              onClick={clearSignature}\n              disabled={!hasSignature}\n              aria-label=\"Clear signature\"\n            >\n              <RotateCcw size={14} aria-hidden=\"true\" /> Clear\n            </button>\n          </div>\n\n          <p className=\"signature-legal\" role=\"note\">\n            By signing above, I acknowledge that I have reviewed and approve this Change Order Request.\n          </p>\n        </div>\n\n        <div className=\"modal-footer\">\n          <button className=\"btn btn-secondary\" onClick={onClose} aria-label=\"Cancel and close\">\n            Cancel\n          </button>\n          <button\n            className=\"btn btn-primary\"\n            onClick={handleSave}\n            disabled={!hasSignature || !signerName.trim()}\n            aria-label=\"Save signature\"\n          >\n            <Check size={16} aria-hidden=\"true\" /> Save Signature\n          </button>\n        </div>\n      </div>\n    </div>\n  )\n}\n","import { useState, useEffect, useMemo, useCallback } from 'react'\nimport { X, Edit3, Download, CheckCircle, XCircle, Send, Clock, FileText, Users, Package, Truck, Briefcase, DollarSign, Percent, Shield, Building2, Stamp, PenTool, Link, Image, ChevronDown, ChevronRight, Calendar, Pencil, Check } from 'lucide-react'\nimport { db } from '../../lib/supabase'\nimport {\n  formatCurrency,\n  formatPercent,\n  centsToDollars,\n  calculateCORTotals,\n  getStatusInfo,\n  formatDate,\n  formatDateRange\n} from '../../lib/corCalculations'\nimport { executeExport, ExportStatus } from '../../lib/corExportPipeline'\nimport SignatureCapture from './SignatureCapture'\nimport SignatureLinkGenerator from '../SignatureLinkGenerator'\n\nexport default function CORDetail({ cor, project, company, areas, onClose, onEdit, onShowToast, onStatusChange }) {\n  const [loading, setLoading] = useState(true)\n  const [corData, setCORData] = useState(cor)\n  const [showSignature, setShowSignature] = useState(false)\n  const [showSignatureLink, setShowSignatureLink] = useState(false)\n  const [expandedTickets, setExpandedTickets] = useState(new Set())\n  const [selectedPhoto, setSelectedPhoto] = useState(null)\n  const [editingNumber, setEditingNumber] = useState(false)\n  const [newCorNumber, setNewCorNumber] = useState('')\n\n  // Fetch full COR data with line items\n  const fetchFullCOR = useCallback(async () => {\n    try {\n      const fullCOR = await db.getCORById(cor.id)\n      if (fullCOR) {\n        setCORData(fullCOR)\n      }\n    } catch (error) {\n      console.error('Error fetching COR details:', error)\n      onShowToast?.('Error loading COR details', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }, [cor.id]) // onShowToast is stable (memoized in App.jsx)\n\n  // Fetch on mount\n  useEffect(() => {\n    fetchFullCOR()\n  }, [fetchFullCOR])\n\n  // Subscribe to T&M ticket associations for real-time updates\n  // When tickets are added/removed from this COR, refresh the data\n  useEffect(() => {\n    const subscription = db.subscribeToCorTickets?.(cor.id, () => {\n      // Refetch COR data when ticket associations change\n      fetchFullCOR()\n    })\n\n    return () => {\n      if (subscription) {\n        db.unsubscribe?.(subscription)\n      }\n    }\n  }, [cor.id, fetchFullCOR])\n\n  // Calculate totals\n  const totals = useMemo(() => calculateCORTotals(corData), [corData])\n\n  const statusInfo = getStatusInfo(corData.status)\n  const canApprove = corData.status === 'pending_approval'\n  // Allow editing before billed (draft, pending_approval, approved)\n  const canEdit = ['draft', 'pending_approval', 'approved'].includes(corData.status)\n\n  const getAreaName = (areaId) => {\n    const area = areas?.find(a => a.id === areaId)\n    return area?.name || null\n  }\n\n  const handleApprove = async () => {\n    if (!confirm('Approve this change order request?')) return\n    setLoading(true)\n    try {\n      await db.approveCOR(corData.id)\n      setCORData({ ...corData, status: 'approved', approved_at: new Date().toISOString() })\n      onShowToast?.('COR approved', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error approving COR:', error)\n      onShowToast?.('Error approving COR', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleReject = async () => {\n    const reason = prompt('Enter rejection reason (optional):')\n    if (reason === null) return // User cancelled\n\n    setLoading(true)\n    try {\n      await db.rejectCOR(corData.id, reason)\n      setCORData({ ...corData, status: 'rejected', rejection_reason: reason })\n      onShowToast?.('COR rejected', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error rejecting COR:', error)\n      onShowToast?.('Error rejecting COR', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleMarkBilled = async () => {\n    if (!confirm('Mark this COR as billed?')) return\n    setLoading(true)\n    try {\n      await db.markCORAsBilled(corData.id)\n      setCORData({ ...corData, status: 'billed' })\n      onShowToast?.('COR marked as billed', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error marking COR as billed:', error)\n      onShowToast?.('Error updating status', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSaveSignature = async (signatureData) => {\n    setLoading(true)\n    try {\n      await db.saveCORSignature?.(corData.id, {\n        gc_signature: signatureData.signature,\n        gc_signer_name: signatureData.signerName,\n        signed_at: signatureData.signedAt\n      })\n      setCORData({\n        ...corData,\n        gc_signature: signatureData.signature,\n        gc_signer_name: signatureData.signerName,\n        signed_at: signatureData.signedAt\n      })\n      setShowSignature(false)\n      onShowToast?.('Signature saved', 'success')\n      onStatusChange?.()\n    } catch (error) {\n      console.error('Error saving signature:', error)\n      onShowToast?.('Error saving signature', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const canSign = corData.status === 'approved' && !corData.gc_signature\n\n  const handleUpdateCorNumber = async () => {\n    if (!newCorNumber.trim()) {\n      setEditingNumber(false)\n      return\n    }\n    setLoading(true)\n    try {\n      await db.updateCOR(corData.id, { cor_number: newCorNumber.trim() })\n      setCORData({ ...corData, cor_number: newCorNumber.trim() })\n      setEditingNumber(false)\n      onShowToast?.('COR number updated', 'success')\n    } catch (error) {\n      console.error('Error updating COR number:', error)\n      onShowToast?.('Error updating COR number', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const startEditingNumber = () => {\n    setNewCorNumber(corData.cor_number || '')\n    setEditingNumber(true)\n  }\n\n  // Toggle ticket expansion in backup section\n  const toggleTicketExpanded = (ticketId) => {\n    setExpandedTickets(prev => {\n      const next = new Set(prev)\n      if (next.has(ticketId)) {\n        next.delete(ticketId)\n      } else {\n        next.add(ticketId)\n      }\n      return next\n    })\n  }\n\n  // Get associated tickets from the COR data\n  const associatedTickets = useMemo(() => {\n    return corData.change_order_ticket_associations?.map(assoc => assoc.t_and_m_tickets).filter(Boolean) || []\n  }, [corData.change_order_ticket_associations])\n\n  // Calculate total hours for a ticket\n  const getTicketHours = (ticket) => {\n    const workers = ticket.t_and_m_workers || []\n    const regular = workers.reduce((sum, w) => sum + (parseFloat(w.hours) || 0), 0)\n    const overtime = workers.reduce((sum, w) => sum + (parseFloat(w.overtime_hours) || 0), 0)\n    return { regular, overtime, total: regular + overtime }\n  }\n\n  const handleExportPDF = async () => {\n    try {\n      onShowToast?.('Generating PDF with backup...', 'info')\n\n      // Use new snapshot-based export pipeline (idempotent, reliable)\n      const result = await executeExport(corData.id, {\n        cor: corData,\n        tickets: associatedTickets,\n        project,\n        company,\n        branding: {\n          logoUrl: company?.logo_url,\n          primaryColor: company?.branding_color\n        },\n        options: {\n          includeBackup: true\n        }\n      })\n\n      if (result.cached) {\n        onShowToast?.('PDF downloaded (cached)', 'success')\n      } else {\n        onShowToast?.('PDF downloaded', 'success')\n      }\n    } catch (error) {\n      console.error('Error exporting PDF:', error)\n      onShowToast?.('Error generating PDF', 'error')\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"modal-overlay\" onClick={onClose}>\n        <div className=\"modal-content cor-detail-modal\" onClick={e => e.stopPropagation()}>\n          <div className=\"cor-detail-loading\">Loading COR details...</div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"modal-overlay\" onClick={onClose} role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"cor-detail-title\">\n      <div className=\"modal-content cor-detail-modal\" onClick={e => e.stopPropagation()}>\n        <div className=\"modal-header cor-detail-header\">\n          <div className=\"cor-detail-title-row\">\n            <div>\n              <div className=\"cor-detail-number\">\n                {editingNumber ? (\n                  <div className=\"cor-number-edit\">\n                    <input\n                      type=\"text\"\n                      value={newCorNumber}\n                      onChange={(e) => setNewCorNumber(e.target.value)}\n                      onKeyDown={(e) => {\n                        if (e.key === 'Enter') handleUpdateCorNumber()\n                        if (e.key === 'Escape') setEditingNumber(false)\n                      }}\n                      autoFocus\n                      className=\"cor-number-input\"\n                    />\n                    <button className=\"btn-icon-sm\" onClick={handleUpdateCorNumber} title=\"Save\">\n                      <Check size={14} />\n                    </button>\n                    <button className=\"btn-icon-sm\" onClick={() => setEditingNumber(false)} title=\"Cancel\">\n                      <X size={14} />\n                    </button>\n                  </div>\n                ) : (\n                  <div className=\"cor-number-display\">\n                    <span>{corData.cor_number}</span>\n                    {canEdit && (\n                      <button className=\"btn-icon-sm\" onClick={startEditingNumber} title=\"Edit COR number\">\n                        <Pencil size={12} />\n                      </button>\n                    )}\n                  </div>\n                )}\n              </div>\n              <h2 id=\"cor-detail-title\">{corData.title || 'Untitled COR'}</h2>\n            </div>\n            <button className=\"close-btn\" onClick={onClose} aria-label=\"Close COR details\"><X size={20} aria-hidden=\"true\" /></button>\n          </div>\n\n          <div className=\"cor-detail-meta\">\n            <span\n              className=\"cor-detail-status\"\n              style={{ backgroundColor: statusInfo.bgColor, color: statusInfo.color }}\n            >\n              {statusInfo.label}\n            </span>\n            {corData.group_name && (\n              <span className=\"cor-detail-group\">{corData.group_name}</span>\n            )}\n            {getAreaName(corData.area_id) && (\n              <span className=\"cor-detail-area\">{getAreaName(corData.area_id)}</span>\n            )}\n            <span className=\"cor-detail-period\">\n              <Clock size={14} /> {formatDateRange(corData.period_start, corData.period_end)}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"modal-body cor-detail-body\">\n          {/* Scope of Work */}\n          <div className=\"cor-detail-section\">\n            <h3><FileText size={18} /> Scope of Work</h3>\n            <p className=\"cor-scope-text\">{corData.scope_of_work || 'No scope of work provided.'}</p>\n          </div>\n\n          {/* Pricing Breakdown */}\n          <div className=\"cor-detail-section pricing-breakdown\">\n            <h3><DollarSign size={18} /> Pricing Breakdown</h3>\n\n            {/* Labor Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Users size={16} />\n                  <span>Labor</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.labor_subtotal)}</span>\n              </div>\n\n              {corData.change_order_labor?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Class</th>\n                        <th>Type</th>\n                        <th>Reg Hrs</th>\n                        <th>Reg Rate</th>\n                        <th>OT Hrs</th>\n                        <th>OT Rate</th>\n                        <th className=\"text-right\">Total</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_labor.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.labor_class}</td>\n                          <td>{item.wage_type}</td>\n                          <td>{item.regular_hours}</td>\n                          <td>${centsToDollars(item.regular_rate)}/hr</td>\n                          <td>{item.overtime_hours || '-'}</td>\n                          <td>{item.overtime_hours ? `$${centsToDollars(item.overtime_rate)}/hr` : '-'}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No labor items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.labor_markup_percent || 1500)})</span>\n                <span>+{formatCurrency(totals.labor_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* Materials Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Package size={16} />\n                  <span>Materials</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.materials_subtotal)}</span>\n              </div>\n\n              {corData.change_order_materials?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Description</th>\n                        <th>Source</th>\n                        <th>Qty</th>\n                        <th>Unit</th>\n                        <th>Unit Cost</th>\n                        <th className=\"text-right\">Total</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_materials.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.description}</td>\n                          <td>{item.source_reference || item.source_type}</td>\n                          <td>{item.quantity}</td>\n                          <td>{item.unit}</td>\n                          <td>${centsToDollars(item.unit_cost)}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No material items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.materials_markup_percent || 1500)})</span>\n                <span>+{formatCurrency(totals.materials_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* Equipment Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Truck size={16} />\n                  <span>Equipment</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.equipment_subtotal)}</span>\n              </div>\n\n              {corData.change_order_equipment?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Description</th>\n                        <th>Source</th>\n                        <th>Qty</th>\n                        <th>Unit</th>\n                        <th>Unit Cost</th>\n                        <th className=\"text-right\">Total</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_equipment.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.description}</td>\n                          <td>{item.source_reference || item.source_type}</td>\n                          <td>{item.quantity}</td>\n                          <td>{item.unit}</td>\n                          <td>${centsToDollars(item.unit_cost)}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No equipment items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.equipment_markup_percent || 1500)})</span>\n                <span>+{formatCurrency(totals.equipment_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* Subcontractors Section */}\n            <div className=\"pricing-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Briefcase size={16} />\n                  <span>Subcontractors</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.subcontractors_subtotal)}</span>\n              </div>\n\n              {corData.change_order_subcontractors?.length > 0 ? (\n                <div className=\"category-items\">\n                  <table className=\"pricing-table\">\n                    <thead>\n                      <tr>\n                        <th>Company</th>\n                        <th>Description</th>\n                        <th>Source</th>\n                        <th className=\"text-right\">Amount</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {corData.change_order_subcontractors.map((item, idx) => (\n                        <tr key={idx}>\n                          <td>{item.company_name}</td>\n                          <td>{item.description}</td>\n                          <td>{item.source_reference || item.source_type}</td>\n                          <td className=\"text-right\">{formatCurrency(item.total)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              ) : (\n                <div className=\"category-empty\">No subcontractor items</div>\n              )}\n\n              <div className=\"category-markup\">\n                <span>Markup ({formatPercent(corData.subcontractors_markup_percent || 500)})</span>\n                <span>+{formatCurrency(totals.subcontractors_markup_amount)}</span>\n              </div>\n            </div>\n\n            {/* COR Subtotal */}\n            <div className=\"cor-subtotal-row\">\n              <span>COR Subtotal</span>\n              <span>{formatCurrency(totals.cor_subtotal)}</span>\n            </div>\n\n            {/* Additional Fees */}\n            <div className=\"pricing-category fees-category\">\n              <div className=\"category-header\">\n                <div className=\"category-title\">\n                  <Percent size={16} />\n                  <span>Additional Fees</span>\n                </div>\n                <span className=\"category-subtotal\">{formatCurrency(totals.additional_fees_total)}</span>\n              </div>\n\n              <div className=\"fees-list\">\n                <div className=\"fee-row\">\n                  <div className=\"fee-label\">\n                    <Shield size={14} />\n                    <span>Liability Insurance ({formatPercent(corData.liability_insurance_percent || 144)})</span>\n                  </div>\n                  <span className=\"fee-amount\">{formatCurrency(totals.liability_insurance_amount)}</span>\n                </div>\n\n                <div className=\"fee-row\">\n                  <div className=\"fee-label\">\n                    <FileText size={14} />\n                    <span>Bond ({formatPercent(corData.bond_percent || 100)})</span>\n                  </div>\n                  <span className=\"fee-amount\">{formatCurrency(totals.bond_amount)}</span>\n                </div>\n\n                <div className=\"fee-row\">\n                  <div className=\"fee-label\">\n                    <Building2 size={14} />\n                    <span>City License Fee ({formatPercent(corData.license_fee_percent || 10)})</span>\n                  </div>\n                  <span className=\"fee-amount\">{formatCurrency(totals.license_fee_amount)}</span>\n                </div>\n              </div>\n            </div>\n\n            {/* COR Total */}\n            <div className=\"cor-total-row\">\n              <span>COR TOTAL</span>\n              <span>{formatCurrency(totals.cor_total)}</span>\n            </div>\n          </div>\n\n          {/* Backup Documentation Section */}\n          {associatedTickets.length > 0 && (\n            <div className=\"cor-detail-section backup-section\">\n              <h3><FileText size={18} /> Backup Documentation</h3>\n              <p className=\"backup-summary\">\n                {associatedTickets.length} T&M ticket{associatedTickets.length !== 1 ? 's' : ''} associated with this COR\n              </p>\n\n              <div className=\"backup-tickets-list\">\n                {associatedTickets.map(ticket => {\n                  const isExpanded = expandedTickets.has(ticket.id)\n                  const hours = getTicketHours(ticket)\n                  const workerCount = ticket.t_and_m_workers?.length || 0\n                  const itemCount = ticket.t_and_m_items?.length || 0\n                  const photoCount = ticket.photos?.length || 0\n\n                  return (\n                    <div key={ticket.id} className=\"backup-ticket-card\">\n                      <div\n                        className=\"backup-ticket-header\"\n                        onClick={() => toggleTicketExpanded(ticket.id)}\n                      >\n                        <div className=\"backup-ticket-toggle\">\n                          {isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}\n                        </div>\n                        <div className=\"backup-ticket-info\">\n                          <div className=\"backup-ticket-date\">\n                            <Calendar size={14} />\n                            <span>{formatDate(ticket.work_date)}</span>\n                          </div>\n                          {ticket.ce_pco_number && (\n                            <span className=\"backup-ticket-pco\">CE/PCO: {ticket.ce_pco_number}</span>\n                          )}\n                        </div>\n                        <div className=\"backup-ticket-stats\">\n                          <span className=\"backup-stat\">\n                            <Users size={14} /> {workerCount}\n                          </span>\n                          <span className=\"backup-stat\">\n                            {hours.total.toFixed(1)} hrs\n                          </span>\n                          {photoCount > 0 && (\n                            <span className=\"backup-stat\">\n                              <Image size={14} /> {photoCount}\n                            </span>\n                          )}\n                          {ticket.client_signature_data && (\n                            <span className=\"backup-stat verified\" title={`Verified by ${ticket.client_signature_name}`}>\n                              <PenTool size={14} /> Verified\n                            </span>\n                          )}\n                        </div>\n                        <span className={`backup-ticket-status status-${ticket.status}`}>\n                          {ticket.status}\n                        </span>\n                      </div>\n\n                      {isExpanded && (\n                        <div className=\"backup-ticket-details\">\n                          {/* Notes */}\n                          {ticket.notes && (\n                            <div className=\"backup-ticket-notes\">\n                              <strong>Notes:</strong> {ticket.notes}\n                            </div>\n                          )}\n\n                          {/* Workers Table */}\n                          {ticket.t_and_m_workers?.length > 0 && (\n                            <div className=\"backup-workers\">\n                              <h4>Labor ({workerCount} workers)</h4>\n                              <table className=\"backup-table\">\n                                <thead>\n                                  <tr>\n                                    <th>Name</th>\n                                    <th>Role</th>\n                                    <th>Time</th>\n                                    <th>Reg Hrs</th>\n                                    <th>OT Hrs</th>\n                                  </tr>\n                                </thead>\n                                <tbody>\n                                  {ticket.t_and_m_workers.map((worker, idx) => (\n                                    <tr key={idx}>\n                                      <td>{worker.name}</td>\n                                      <td>{worker.role || '-'}</td>\n                                      <td className=\"backup-time-range\">\n                                        {worker.time_started && worker.time_ended\n                                          ? `${worker.time_started} - ${worker.time_ended}`\n                                          : '-'}\n                                      </td>\n                                      <td>{worker.hours || 0}</td>\n                                      <td>{worker.overtime_hours || '-'}</td>\n                                    </tr>\n                                  ))}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n\n                          {/* Materials/Equipment Table */}\n                          {ticket.t_and_m_items?.length > 0 && (\n                            <div className=\"backup-items\">\n                              <h4>Materials & Equipment ({itemCount} items)</h4>\n                              <table className=\"backup-table\">\n                                <thead>\n                                  <tr>\n                                    <th>Item</th>\n                                    <th>Category</th>\n                                    <th>Qty</th>\n                                  </tr>\n                                </thead>\n                                <tbody>\n                                  {ticket.t_and_m_items.map((item, idx) => (\n                                    <tr key={idx}>\n                                      <td>{item.custom_name || item.materials_equipment?.name || 'Unnamed Item'}</td>\n                                      <td>{item.custom_category || item.materials_equipment?.category || '-'}</td>\n                                      <td>{item.quantity}</td>\n                                    </tr>\n                                  ))}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n\n                          {/* Photos Gallery */}\n                          {ticket.photos?.length > 0 && (\n                            <div className=\"backup-photos\">\n                              <h4>Photos ({photoCount})</h4>\n                              <div className=\"backup-photos-grid\">\n                                {ticket.photos.map((photoUrl, idx) => (\n                                  <div\n                                    key={idx}\n                                    className=\"backup-photo-thumb\"\n                                    onClick={() => setSelectedPhoto(photoUrl)}\n                                  >\n                                    <img src={photoUrl} alt={`Photo ${idx + 1}`} />\n                                  </div>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Client Verification Signature */}\n                          {ticket.client_signature_data && (\n                            <div className=\"backup-verification\">\n                              <h4><PenTool size={14} /> Client Verification</h4>\n                              <div className=\"backup-signature-display\">\n                                <img\n                                  src={ticket.client_signature_data}\n                                  alt=\"Client Signature\"\n                                  className=\"backup-signature-image\"\n                                />\n                                <div className=\"backup-signature-info\">\n                                  <span className=\"backup-signer-name\">{ticket.client_signature_name}</span>\n                                  {ticket.client_signature_title && (\n                                    <span className=\"backup-signer-title\">{ticket.client_signature_title}</span>\n                                  )}\n                                  {ticket.client_signature_company && (\n                                    <span className=\"backup-signer-company\">{ticket.client_signature_company}</span>\n                                  )}\n                                  <span className=\"backup-signed-date\">\n                                    Verified: {formatDate(ticket.client_signature_date)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                  )\n                })}\n              </div>\n            </div>\n          )}\n\n          {/* Signature Section */}\n          {(corData.gc_signature_data || corData.gc_signature || corData.client_signature_data) && (\n            <div className=\"cor-detail-section signature-section\">\n              <h3><Stamp size={18} /> Signatures</h3>\n              <div className=\"dual-signatures\">\n                {/* GC Signature */}\n                {(corData.gc_signature_data || corData.gc_signature) && (\n                  <div className=\"signature-block\">\n                    <span className=\"signature-label\">GC Authorization</span>\n                    <div className=\"signature-display\">\n                      <img\n                        src={corData.gc_signature_data || corData.gc_signature}\n                        alt=\"GC Signature\"\n                        className=\"signature-image\"\n                      />\n                      <div className=\"signature-info\">\n                        <span className=\"signer-name\">{corData.gc_signature_name || corData.gc_signer_name}</span>\n                        {(corData.gc_signature_title || corData.gc_signature_company) && (\n                          <span className=\"signer-org\">\n                            {corData.gc_signature_title}\n                            {corData.gc_signature_title && corData.gc_signature_company && ' - '}\n                            {corData.gc_signature_company}\n                          </span>\n                        )}\n                        <span className=\"signed-date\">\n                          Signed: {formatDate(corData.gc_signature_date || corData.signed_at)}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Client Signature */}\n                {corData.client_signature_data && (\n                  <div className=\"signature-block\">\n                    <span className=\"signature-label\">Client Authorization</span>\n                    <div className=\"signature-display\">\n                      <img\n                        src={corData.client_signature_data}\n                        alt=\"Client Signature\"\n                        className=\"signature-image\"\n                      />\n                      <div className=\"signature-info\">\n                        <span className=\"signer-name\">{corData.client_signature_name}</span>\n                        {(corData.client_signature_title || corData.client_signature_company) && (\n                          <span className=\"signer-org\">\n                            {corData.client_signature_title}\n                            {corData.client_signature_title && corData.client_signature_company && ' - '}\n                            {corData.client_signature_company}\n                          </span>\n                        )}\n                        <span className=\"signed-date\">\n                          Signed: {formatDate(corData.client_signature_date)}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Rejection Reason (if rejected) */}\n          {corData.status === 'rejected' && corData.rejection_reason && (\n            <div className=\"cor-detail-section rejection-section\">\n              <h3><XCircle size={18} /> Rejection Reason</h3>\n              <p className=\"rejection-text\">{corData.rejection_reason}</p>\n            </div>\n          )}\n        </div>\n\n        {/* Footer Actions */}\n        <div className=\"modal-footer cor-detail-footer\">\n          <div className=\"footer-info\">\n            <span>Created: {formatDate(corData.created_at)}</span>\n            {corData.approved_at && <span>Approved: {formatDate(corData.approved_at)}</span>}\n          </div>\n\n          <div className=\"footer-actions\" role=\"group\" aria-label=\"COR actions\">\n            {canEdit && (\n              <button className=\"btn btn-secondary\" onClick={() => onEdit?.(corData)} disabled={loading} aria-label=\"Edit this COR\">\n                <Edit3 size={16} aria-hidden=\"true\" /> Edit\n              </button>\n            )}\n\n            {canApprove && (\n              <>\n                <button className=\"btn btn-danger\" onClick={handleReject} disabled={loading} aria-label=\"Reject this COR\">\n                  <XCircle size={16} aria-hidden=\"true\" /> Reject\n                </button>\n                <button className=\"btn btn-success\" onClick={handleApprove} disabled={loading} aria-label=\"Approve this COR\">\n                  <CheckCircle size={16} aria-hidden=\"true\" /> Approve\n                </button>\n              </>\n            )}\n\n            {canSign && (\n              <button className=\"btn btn-success\" onClick={() => setShowSignature(true)} disabled={loading} aria-label=\"Get GC signature for this COR\">\n                <PenTool size={16} aria-hidden=\"true\" /> Get GC Signature\n              </button>\n            )}\n\n            {/* Show signature link button for approved/pending CORs */}\n            {(corData.status === 'approved' || corData.status === 'pending_approval') && (\n              <button\n                className=\"btn btn-secondary\"\n                onClick={() => setShowSignatureLink(true)}\n                disabled={loading}\n                aria-label=\"Get shareable signature link\"\n              >\n                <Link size={16} aria-hidden=\"true\" /> Get Signature Link\n              </button>\n            )}\n\n            {corData.status === 'approved' && (\n              <button className=\"btn btn-primary\" onClick={handleMarkBilled} disabled={loading} aria-label=\"Mark this COR as billed\">\n                <DollarSign size={16} aria-hidden=\"true\" /> Mark Billed\n              </button>\n            )}\n\n            <button className=\"btn btn-secondary\" onClick={handleExportPDF} aria-label=\"Export COR to PDF\">\n              <Download size={16} aria-hidden=\"true\" /> Export PDF\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Signature Capture Modal */}\n      {showSignature && (\n        <SignatureCapture\n          onSave={handleSaveSignature}\n          onClose={() => setShowSignature(false)}\n          signerName=\"\"\n        />\n      )}\n\n      {/* Signature Link Generator Modal */}\n      {showSignatureLink && (\n        <SignatureLinkGenerator\n          documentType=\"cor\"\n          documentId={corData.id}\n          companyId={company?.id}\n          projectId={project?.id}\n          documentTitle={`COR ${corData.cor_number}: ${corData.title || 'Untitled'}`}\n          onClose={() => setShowSignatureLink(false)}\n          onShowToast={onShowToast}\n        />\n      )}\n\n      {/* Photo Lightbox Modal */}\n      {selectedPhoto && (\n        <div className=\"photo-lightbox\" onClick={() => setSelectedPhoto(null)}>\n          <button className=\"lightbox-close\" onClick={() => setSelectedPhoto(null)}>\n            <X size={24} />\n          </button>\n          <img src={selectedPhoto} alt=\"Full size photo\" onClick={e => e.stopPropagation()} />\n        </div>\n      )}\n    </div>\n  )\n}\n"],"file":"CORDetail-3HeCSHBI.js"}