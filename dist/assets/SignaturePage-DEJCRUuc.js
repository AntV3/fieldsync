import{aG as Te,aH as pe,aU as we,ar as se,as as e}from"./index-Da6Ug3b9.js";import{r as L,f as je,a as be,n as Q,D as ue,F as fe,H as Ne,ar as xe,i as Se,_ as De,p as Ie,B as $e,v as ve,C as ye,$ as Re,e as ge}from"./icons-BDU0tZd_.js";import{c as ze,a as Pe,b as Z,f as _,d as q,e as te}from"./corCalculations-vdJc_BOT.js";import{_ as he}from"./pdf-Dbgi5wV4.js";import{S as Ce}from"./SignatureCanvas-BuOv264D.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const Fe=l=>{if(!l)return"";const[j,S]=l.split(":"),v=parseInt(j),p=v>=12?"pm":"am";return`${v%12||12}:${S}${p}`},ke=l=>l.time_started&&l.time_ended?`${Fe(l.time_started)} - ${Fe(l.time_ended)}`:"-";async function Ae(l){if(!l||l.length===0)return{totalPhotos:0,verified:0,failed:0,issues:[],manifest:[]};const j=[];let S=0,v=0;const p=[];for(const b of l)if(!(!b.photos||b.photos.length===0))for(const a of b.photos){const o={ticketId:b.id,workDate:b.work_date,url:a,verified:!1,error:null};try{await pe(a)?(o.verified=!0,S++):(o.error="Failed to load image",v++,p.push({ticketId:b.id,workDate:b.work_date,url:a,error:"Failed to load image"}))}catch(E){o.error=E.message||"Unknown error",v++,p.push({ticketId:b.id,workDate:b.work_date,url:a,error:o.error})}j.push(o)}return{totalPhotos:S+v,verified:S,failed:v,issues:p,manifest:j,allVerified:v===0,verifiedAt:new Date().toISOString()}}function Ee(l,j,S,v){const p=JSON.stringify({cor:l,tmTickets:j,photoManifest:S,totals:v});let b=0;for(let o=0;o<p.length;o++){const E=p.charCodeAt(o);b=(b<<5)-b+E,b=b&b}const a=Math.abs(b).toString(16).padStart(16,"0");return{cor_data:{id:l.id,cor_number:l.cor_number,title:l.title,description:l.description,status:l.status,created_at:l.created_at,submitted_at:l.submitted_at,labor_items:l.labor_items,material_items:l.material_items,equipment_items:l.equipment_items,gc_markup_percent:l.gc_markup_percent,profit_markup_percent:l.profit_markup_percent},tickets_data:(j||[]).map(o=>({id:o.id,work_date:o.work_date,ce_pco_number:o.ce_pco_number,notes:o.notes,status:o.status,created_at:o.created_at,workers:o.t_and_m_workers||[],items:o.t_and_m_items||[],photos:o.photos||[],client_signature_name:o.client_signature_name,client_signature_date:o.client_signature_date})),photos_manifest:S,totals_snapshot:v,checksum:a}}async function Oe(l,j,S,v={},p=null,b={}){const{verifyPhotos:a=!1,createSnapshot:o=!1}=b;let E=null;a&&p?.length>0&&(E=await Ae(p));const{default:x}=await he(async()=>{const{default:h}=await import("./pdf-Dbgi5wV4.js").then(M=>M.j);return{default:h}},[]),{default:r}=await he(async()=>{const{default:h}=await import("./pdf-Dbgi5wV4.js").then(M=>M.b);return{default:h}},[]),t=new x,f=t.internal.pageSize.getWidth(),$=t.internal.pageSize.getHeight(),n=20;let s=n;const y=ze(l),c=v.primaryColor?Te(v.primaryColor):[30,58,138],C=[241,245,249];let T=null;if(v.logoUrl)try{T=await pe(v.logoUrl)}catch(h){console.error("Error loading logo:",h)}if(T)try{t.addImage(T,"PNG",n,s,40,15),s+=20}catch{t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(S?.name||"Company Name",n,s+10),s+=20}else t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(S?.name||"Company Name",n,s+10),s+=20;t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("CHANGE ORDER REQUEST",n,s),s+=10,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(100,100,100),t.text(l.cor_number||"COR-XXXX",n,s);const B=l.status?.replace("_"," ").toUpperCase()||"DRAFT";t.setTextColor(...c),t.text(B,f-n-t.getTextWidth(B),s),s+=12,t.setDrawColor(...c),t.setLineWidth(.5),t.line(n,s,f-n,s),s+=10,t.setFontSize(10),t.setTextColor(0,0,0);const H=n,G=f/2;t.setFont("helvetica","bold"),t.text("Project:",H,s),t.setFont("helvetica","normal"),t.text(j?.name||"Project Name",H+25,s),t.setFont("helvetica","bold"),t.text("Job #:",G,s),t.setFont("helvetica","normal"),t.text(j?.job_number||"N/A",G+25,s),s+=6,t.setFont("helvetica","bold"),t.text("Period:",H,s),t.setFont("helvetica","normal"),t.text(Pe(l.period_start,l.period_end),H+25,s),t.setFont("helvetica","bold"),t.text("Date:",G,s),t.setFont("helvetica","normal"),t.text(Z(l.created_at),G+25,s),s+=10,t.setFont("helvetica","bold"),t.setFontSize(12),t.text(l.title||"Untitled Change Order",n,s),s+=8,t.setFont("helvetica","normal"),t.setFontSize(10),t.setTextColor(80,80,80);const U=t.splitTextToSize(l.scope_of_work||"No scope of work provided.",f-n*2);t.text(U,n,s),s+=U.length*5+10,l.change_order_labor?.length>0&&(t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("LABOR",n,s),s+=6,r(t,{startY:s,head:[["Class","Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:l.change_order_labor.map(h=>[h.labor_class,h.wage_type,h.regular_hours.toString(),`$${te(h.regular_rate)}/hr`,h.overtime_hours?.toString()||"-",h.overtime_hours?`$${te(h.overtime_rate)}/hr`:"-",_(h.total)]),foot:[[{content:`Subtotal: ${_(y.labor_subtotal)}`,colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(l.labor_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:_(y.labor_subtotal+y.labor_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),l.change_order_materials?.length>0&&(s>$-80&&(t.addPage(),s=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("MATERIALS",n,s),s+=6,r(t,{startY:s,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:l.change_order_materials.map(h=>[h.description,h.source_reference||h.source_type,h.quantity.toString(),h.unit,`$${te(h.unit_cost)}`,_(h.total)]),foot:[[{content:`Subtotal: ${_(y.materials_subtotal)}`,colSpan:4,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(l.materials_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:_(y.materials_subtotal+y.materials_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),l.change_order_equipment?.length>0&&(s>$-80&&(t.addPage(),s=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("EQUIPMENT",n,s),s+=6,r(t,{startY:s,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:l.change_order_equipment.map(h=>[h.description,h.source_reference||h.source_type,h.quantity.toString(),h.unit,`$${te(h.unit_cost)}`,_(h.total)]),foot:[[{content:`Subtotal: ${_(y.equipment_subtotal)}`,colSpan:4,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(l.equipment_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:_(y.equipment_subtotal+y.equipment_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),l.change_order_subcontractors?.length>0&&(s>$-80&&(t.addPage(),s=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("SUBCONTRACTORS",n,s),s+=6,r(t,{startY:s,head:[["Company","Description","Source","Amount"]],body:l.change_order_subcontractors.map(h=>[h.company_name,h.description,h.source_reference||h.source_type,_(h.total)]),foot:[[{content:`Subtotal: ${_(y.subcontractors_subtotal)}`,colSpan:2,styles:{halign:"right",fontStyle:"bold"}},{content:`+${q(l.subcontractors_markup_percent||500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:_(y.subcontractors_subtotal+y.subcontractors_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:C,textColor:[0,0,0],fontSize:8},theme:"striped"}),s=t.lastAutoTable.finalY+10),s>$-100&&(t.addPage(),s=n),t.setFillColor(...C),t.roundedRect(n,s,f-n*2,70,3,3,"F"),s+=10,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(0,0,0);const O=n+10,W=f-n-60;t.text("COR Subtotal:",O,s),t.setFont("helvetica","bold"),t.text(_(y.cor_subtotal),W,s,{align:"right"}),s+=8,t.setFont("helvetica","normal"),t.setFontSize(9),t.text(`Liability Insurance (${q(l.liability_insurance_percent||144)}):`,O,s),t.text(_(y.liability_insurance_amount),W,s,{align:"right"}),s+=6,t.text(`Bond (${q(l.bond_percent||100)}):`,O,s),t.text(_(y.bond_amount),W,s,{align:"right"}),s+=6,t.text(`City License Fee (${q(l.license_fee_percent||10)}):`,O,s),t.text(_(y.license_fee_amount),W,s,{align:"right"}),s+=10,t.setFillColor(...c),t.roundedRect(O-5,s-3,f-n*2-10,16,2,2,"F"),t.setTextColor(255,255,255),t.setFontSize(12),t.setFont("helvetica","bold"),t.text("COR TOTAL:",O,s+8),t.text(_(y.cor_total),W,s+8,{align:"right"}),s+=25,s>$-120&&(t.addPage(),s=n),s+=10,t.setTextColor(0,0,0),t.setFontSize(10),t.setFont("helvetica","bold"),t.text("AUTHORIZATION",n,s),s+=15,t.setFont("helvetica","normal"),t.setFontSize(9),t.setDrawColor(0,0,0);const F=(h,M,ne,w,P,le,J)=>{t.setFont("helvetica","bold"),t.setFontSize(8),t.text(M,n,h),t.setFont("helvetica","normal"),t.setFontSize(9);const R=h+20;if(t.line(n,R,n+70,R),t.text("Signature",n,R+8),t.line(n+85,R,n+145,R),t.text("Title / Company",n+85,R+8),t.line(f-n-40,R,f-n,R),t.text("Date",f-n-40,R+8),ne)try{if(t.addImage(ne,"PNG",n,R-18,60,18),w&&(t.setFontSize(8),t.text(w,n,R+15)),P||le){const k=[P,le].filter(Boolean).join(" - ");t.text(k,n+85,R-5)}J&&t.text(Z(J),f-n-40,R-5)}catch(k){console.error("Error adding signature:",k)}else t.setFont("helvetica","italic"),t.setFontSize(9),t.setTextColor(150,150,150),t.text("Awaiting Signature",n+5,R-5),t.setTextColor(0,0,0),t.setFont("helvetica","normal");return R+25};if(s=F(s,"GC AUTHORIZATION",l.gc_signature_data||l.gc_signature,l.gc_signature_name||l.gc_signer_name,l.gc_signature_title,l.gc_signature_company,l.gc_signature_date||l.signed_at),s+=10,s=F(s,"CLIENT AUTHORIZATION",l.client_signature_data,l.client_signature_name,l.client_signature_title,l.client_signature_company,l.client_signature_date),p&&p.length>0){const h=p.reduce((i,u)=>i+(u.t_and_m_workers?.reduce((z,m)=>z+(parseFloat(m.hours)||0),0)||0),0),M=p.reduce((i,u)=>i+(u.t_and_m_workers?.reduce((z,m)=>z+(parseFloat(m.overtime_hours)||0),0)||0),0),ne=p.reduce((i,u)=>i+(u.photos?.length||0),0),w=p.filter(i=>i.client_signature_data).length,P=p.length>0?{start:p.reduce((i,u)=>!i||u.work_date<i?u.work_date:i,null),end:p.reduce((i,u)=>!i||u.work_date>i?u.work_date:i,null)}:null,le=new Uint8Array(3);crypto.getRandomValues(le);const J=Array.from(le,i=>i.toString(36)).join("").toUpperCase().substring(0,4),R=`FS-${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}${String(new Date().getDate()).padStart(2,"0")}-${J}`;if(t.addPage(),s=n,T)try{t.addImage(T,"PNG",n,s,50,18)}catch{t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(S?.name||"Company Name",n,s+10)}else t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...c),t.text(S?.name||"Company Name",n,s+10);s+=35,t.setDrawColor(...c),t.setLineWidth(.8),t.line(n,s,f-n,s),t.setLineWidth(.3),t.line(n,s+3,f-n,s+3),s+=15,t.setFontSize(22),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",f/2,s,{align:"center"}),s+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Change Order Request Backup",f/2,s,{align:"center"}),s+=8,t.setDrawColor(...c),t.setLineWidth(.3),t.line(n,s,f-n,s),t.setLineWidth(.8),t.line(n,s+3,f-n,s+3),s+=20,t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("COR Reference:",n,s),t.setFont("helvetica","normal"),t.text(l.cor_number||"N/A",n+35,s),t.setFont("helvetica","bold"),t.text("Project:",f/2,s),t.setFont("helvetica","normal"),t.text(j?.name||"N/A",f/2+20,s),s+=7,t.setFont("helvetica","bold"),t.text("Job #:",n,s),t.setFont("helvetica","normal"),t.text(j?.job_number||"N/A",n+35,s),s+=20,t.setFillColor(248,250,252),t.setDrawColor(203,213,225),t.roundedRect(n,s,f-n*2,65,4,4,"FD"),s+=10,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",n+10,s),t.setDrawColor(203,213,225),t.setLineWidth(.3),t.line(n+10,s+3,n+80,s+3),s+=12,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(71,85,105);const k=n+15,Y=n+70;t.text("Time & Material Tickets:",k,s),t.setFont("helvetica","bold"),t.text(String(p.length),Y,s),t.setFont("helvetica","normal"),s+=7,t.text("Total Labor:",k,s),t.setFont("helvetica","bold"),t.text(`${h.toFixed(1)} hrs`,Y,s),t.setFont("helvetica","normal"),s+=7,M>0&&(t.text("Total OT:",k,s),t.setFont("helvetica","bold"),t.text(`${M.toFixed(1)} hrs`,Y,s),t.setFont("helvetica","normal"),s+=7),t.text("Photo Evidence:",k,s),t.setFont("helvetica","bold"),t.text(`${ne} photos`,Y,s),t.setFont("helvetica","normal"),s+=7,t.text("Client Verified:",k,s),t.setFont("helvetica","bold"),t.setTextColor(w>0?16:71,w>0?185:85,w>0?129:105),t.text(`${w} of ${p.length} tickets`,Y,s),t.setTextColor(71,85,105),t.setFont("helvetica","normal"),s+=7,P?.start&&P?.end&&(t.text("Date Range:",k,s),t.setFont("helvetica","bold"),t.text(`${Z(P.start)} - ${Z(P.end)}`,Y,s)),s+=30,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const d=new Date;t.text(`Generated: ${d.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${d.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,n,s),s+=6,t.text(`Document ID: ${R}`,n,s);for(const i of p){t.addPage(),s=n;const u=!!i.client_signature_data,z=22,m=u?[16,185,129]:i.status==="approved"?[16,185,129]:[245,158,11];if(t.setFillColor(...m),t.rect(n,s,4,z,"F"),t.setFillColor(248,250,252),t.rect(n+4,s,f-n*2-4,z,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`TIME & MATERIAL TICKET — ${Z(i.work_date)}`,n+10,s+8),i.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${i.ce_pco_number}`,n+10,s+16)),u&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",f-n-35,s+12)),s+=z+8,i.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",n,s),s+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const g=t.splitTextToSize(i.notes,f-n*2);t.text(g,n,s),s+=g.length*4+10}if(i.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",n,s),s+=6,r(t,{startY:s,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:i.t_and_m_workers.map(g=>[g.name,ke(g),g.role||g.labor_class||"Laborer",g.hours?.toString()||"0",g.overtime_hours?.toString()||"-"]),margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=t.lastAutoTable.finalY+10),i.t_and_m_items?.length>0&&(s>$-60&&(t.addPage(),s=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",n,s),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: Time & Material Ticket",n+55,s),s+=6,r(t,{startY:s,head:[["Item","Qty","Unit","Unit Cost","Total"]],body:i.t_and_m_items.map(g=>[g.materials_equipment?.name||g.description||"Item",g.quantity?.toString()||"1",g.materials_equipment?.unit||"ea",g.materials_equipment?.cost_per_unit?`$${g.materials_equipment.cost_per_unit}`:"-",g.materials_equipment?.cost_per_unit&&g.quantity?`$${(g.quantity*g.materials_equipment.cost_per_unit).toFixed(2)}`:"-"]),margin:{left:n,right:n},headStyles:{fillColor:c,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=t.lastAutoTable.finalY+10),i.photos?.length>0){s>$-80&&(t.addPage(),s=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",n,s),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${i.photos.length} photo${i.photos.length!==1?"s":""}`,n+50,s),s+=8;let g=n;const A=55,I=45,V=6,N=3,D=1,ee=await we(i.photos);for(let X=0;X<i.photos.length;X++){X>0&&X%N===0&&(g=n,s+=I+V+4),s+I>$-20&&(t.addPage(),s=n,g=n);const oe=ee[X];oe?(t.setDrawColor(200,200,200),t.setLineWidth(D),t.rect(g-D,s-D,A+D*2,I+D*2,"S"),t.setFillColor(230,230,230),t.rect(g+2,s+2,A,I,"F"),t.addImage(oe,"JPEG",g,s,A,I)):(t.setFillColor(245,245,245),t.rect(g,s,A,I,"F"),t.setDrawColor(200,200,200),t.rect(g,s,A,I,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",g+8,s+I/2)),g+=A+V}s+=I+12}if(i.client_signature_data){s>$-50&&(t.addPage(),s=n);const g=32,A=f-n*2;t.setFillColor(240,253,244),t.roundedRect(n,s,A,g,3,3,"F"),t.setFillColor(16,185,129),t.rect(n,s,4,g,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(n+4,s,n+A,s);const I=n+14,V=s+g/2;t.setFillColor(16,185,129),t.circle(I,V,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",I-2.5,V+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",n+26,s+10);try{t.addImage(i.client_signature_data,"PNG",n+26,s+13,50,16);const ee=i.client_signature_name||"Client",X=i.client_signature_title||"",oe=i.client_signature_company||"",_e=i.client_signature_date?Z(i.client_signature_date):"",me=n+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(ee,me,s+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(X||oe)&&t.text(`${X}${X&&oe?", ":""}${oe}`,me,s+18),_e&&(t.setTextColor(100,116,139),t.text(`Verified: ${_e}`,me,s+24))}catch{const D=i.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${D}`,n+26,s+20)}s+=g+8}s+=5,t.setDrawColor(200,200,200),t.setLineWidth(.2),t.line(n,s,f-n,s),s+=10}}const K=t.internal.getNumberOfPages();for(let h=1;h<=K;h++){t.setPage(h);const M=$-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,n,M),t.text(`Page ${h} of ${K}`,f-n,M,{align:"right"})}const ie=`${l.cor_number||"COR"}_${j?.job_number||"export"}${p?.length?"_with_backup":""}.pdf`;t.save(ie);const re={success:!0,fileName:ie,exportedAt:new Date().toISOString(),photoManifest:E};return o&&(re.snapshot=Ee(l,p,E,y)),re}async function Me(l,j,S,v={}){const{default:p}=await he(async()=>{const{default:c}=await import("./pdf-Dbgi5wV4.js").then(C=>C.j);return{default:c}},[]),{default:b}=await he(async()=>{const{default:c}=await import("./pdf-Dbgi5wV4.js").then(C=>C.b);return{default:c}},[]),a=new p("p","mm","letter"),o=a.internal.pageSize.getWidth(),E=a.internal.pageSize.getHeight(),x=20;let r=x;const t=v.primaryColor?Te(v.primaryColor):[30,58,95];if(v.logoUrl)try{const c=await pe(v.logoUrl);c&&a.addImage(c,"PNG",x,r,40,15)}catch{S?.name&&(a.setFontSize(14),a.setFont("helvetica","bold"),a.setTextColor(...t),a.text(S.name,x,r+8))}else S?.name&&(a.setFontSize(14),a.setFont("helvetica","bold"),a.setTextColor(...t),a.text(S.name,x,r+8));if(a.setFontSize(16),a.setFont("helvetica","bold"),a.setTextColor(30,41,59),a.text("TIME & MATERIAL TICKET",o-x,r+8,{align:"right"}),r+=25,a.setDrawColor(...t),a.setLineWidth(.5),a.line(x,r,o-x,r),r+=10,!!l.client_signature_data&&(a.setFillColor(240,253,244),a.roundedRect(o-x-45,r-5,45,12,2,2,"F"),a.setFontSize(9),a.setFont("helvetica","bold"),a.setTextColor(16,185,129),a.text("✓ CLIENT VERIFIED",o-x-42,r+3)),a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("Project:",x,r),a.setFont("helvetica","normal"),a.setTextColor(30,41,59),a.text(j?.name||"N/A",x+20,r),r+=6,j?.job_number&&(a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("Job #:",x,r),a.setFont("helvetica","normal"),a.setTextColor(30,41,59),a.text(j.job_number,x+20,r),r+=6),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("Work Date:",x,r),a.setFont("helvetica","normal"),a.setTextColor(30,41,59),a.text(Z(l.work_date||l.ticket_date),x+26,r),l.ce_pco_number&&(a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("CE/PCO:",x+70,r),a.setFont("helvetica","normal"),a.setTextColor(59,130,246),a.text(l.ce_pco_number,x+88,r)),r+=12,l.notes){a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("DESCRIPTION",x,r),r+=6,a.setFontSize(9),a.setFont("helvetica","normal"),a.setTextColor(51,65,85);const c=a.splitTextToSize(l.notes,o-x*2);a.text(c,x,r),r+=c.length*4+10}l.t_and_m_workers?.length>0&&(a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("LABOR",x,r),r+=6,b(a,{startY:r,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:l.t_and_m_workers.map(c=>[c.name,ke(c),c.role||c.labor_class||"Laborer",c.hours?.toString()||"0",c.overtime_hours?.toString()||"-"]),margin:{left:x,right:x},headStyles:{fillColor:t,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),r=a.lastAutoTable.finalY+10);const $=l.t_and_m_items||l.materials_equipment?.filter(c=>c.type==="material")||[];if($.length>0&&(r>E-60&&(a.addPage(),r=x),a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("MATERIALS / EQUIPMENT",x,r),r+=6,b(a,{startY:r,head:[["Item","Qty","Unit"]],body:$.map(c=>[c.materials_equipment?.name||c.description||c.name||"Item",c.quantity?.toString()||"1",c.materials_equipment?.unit||c.unit||"ea"]),margin:{left:x,right:x},headStyles:{fillColor:t,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),r=a.lastAutoTable.finalY+10),l.photos?.length>0){r>E-80&&(a.addPage(),r=x),a.setFontSize(10),a.setFont("helvetica","bold"),a.setTextColor(71,85,105),a.text("PHOTO DOCUMENTATION",x,r),a.setFontSize(8),a.setFont("helvetica","normal"),a.setTextColor(59,130,246),a.text(`${l.photos.length} photo${l.photos.length!==1?"s":""}`,x+50,r),r+=8;let c=x;const C=55,T=45,B=6,H=3,G=await we(l.photos);for(let U=0;U<l.photos.length;U++){U>0&&U%H===0&&(c=x,r+=T+B+4),r+T>E-20&&(a.addPage(),r=x,c=x);const O=G[U];O?(a.setDrawColor(200,200,200),a.setLineWidth(1),a.rect(c-1,r-1,C+2,T+2,"S"),a.setFillColor(230,230,230),a.rect(c+2,r+2,C,T,"F"),a.addImage(O,"JPEG",c,r,C,T)):(a.setFillColor(245,245,245),a.rect(c,r,C,T,"F"),a.setDrawColor(200,200,200),a.rect(c,r,C,T,"S"),a.setFontSize(7),a.setTextColor(150,150,150),a.text("Photo unavailable",c+8,r+T/2)),c+=C+B}r+=T+12}if(l.client_signature_data){r>E-50&&(a.addPage(),r=x);const c=32,C=o-x*2;a.setFillColor(240,253,244),a.roundedRect(x,r,C,c,3,3,"F"),a.setFillColor(16,185,129),a.rect(x,r,4,c,"F"),a.setDrawColor(187,247,208),a.setLineWidth(.5),a.line(x+4,r,x+C,r);const T=x+14,B=r+c/2;a.setFillColor(16,185,129),a.circle(T,B,6,"F"),a.setFontSize(9),a.setTextColor(255,255,255),a.text("✓",T-2.5,B+3),a.setFontSize(9),a.setFont("helvetica","bold"),a.setTextColor(16,185,129),a.text("CLIENT VERIFIED",x+26,r+10);try{a.addImage(l.client_signature_data,"PNG",x+26,r+13,50,16);const U=l.client_signature_name||"Client",O=l.client_signature_title||"",W=l.client_signature_company||"",F=l.client_signature_date?Z(l.client_signature_date):"",K=x+85;a.setFont("helvetica","bold"),a.setFontSize(9),a.setTextColor(30,41,59),a.text(U,K,r+12),a.setFont("helvetica","normal"),a.setFontSize(8),a.setTextColor(71,85,105),(O||W)&&a.text(`${O}${O&&W?", ":""}${W}`,K,r+18),F&&(a.setTextColor(100,116,139),a.text(`Verified: ${F}`,K,r+24))}catch{const G=l.client_signature_name||"Client";a.setFont("helvetica","normal"),a.setFontSize(9),a.setTextColor(30,41,59),a.text(`Signed by: ${G}`,x+26,r+20)}r+=c+8}const n=a.internal.getNumberOfPages();for(let c=1;c<=n;c++){a.setPage(c);const C=E-10;a.setFontSize(8),a.setTextColor(150,150,150),a.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,x,C),a.text(`Page ${c} of ${n}`,o-x,C,{align:"right"})}const y=`TM_Ticket_${Z(l.work_date||l.ticket_date).replace(/\//g,"-")}${l.ce_pco_number?"_"+l.ce_pco_number:""}.pdf`;return a.save(y),{success:!0,fileName:y}}const ae=l=>l?new Date(l).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"",ce=l=>{if(!l)return"";const[j,S]=l.split(":"),v=parseInt(j),p=v>=12?"pm":"am";return`${v%12||12}:${S}${p}`},Le=({status:l})=>{const j={draft:{label:"Draft",color:"#6b7280",bg:"#f3f4f6"},pending_approval:{label:"Pending Approval",color:"#d97706",bg:"#fef3c7"},approved:{label:"Approved",color:"#059669",bg:"#d1fae5"},rejected:{label:"Rejected",color:"#dc2626",bg:"#fee2e2"},billed:{label:"Billed",color:"#2563eb",bg:"#dbeafe"},closed:{label:"Closed",color:"#4b5563",bg:"#e5e7eb"}},S=j[l]||j.draft;return e.jsx("span",{className:"cor-status-badge",style:{color:S.color,backgroundColor:S.bg},children:S.label})};function Ve({signatureToken:l}){const[j,S]=L.useState(!0),[v,p]=L.useState(null),[b,a]=L.useState(null),[o,E]=L.useState(null),[x,r]=L.useState(!1),[t,f]=L.useState(null),[$,n]=L.useState(!1),[s,y]=L.useState(null),[c,C]=L.useState(!1),[T,B]=L.useState([]),[H,G]=L.useState(!1),[U,O]=L.useState(new Set);L.useEffect(()=>{W()},[l]);const W=async()=>{try{S(!0),p(null);const d=await se.getSignatureRequestByToken(l);if(!d){p("This signature link is invalid or has expired.");return}if(d.status==="completed"){p("This document has already been fully signed.");return}if(d.status==="revoked"){p("This signature link has been revoked.");return}if(d.status==="expired"){p("This signature link has expired.");return}a(d);const i=await se.getDocumentForSigning(d.document_type,d.document_id);if(!i){p("The document associated with this link could not be found.");return}if(E(i),d.document_type==="cor"&&i?.id)try{const u=await se.getCORTickets(i.id);if(u?.length){const z=u.map(g=>g.photos||[]),m=z.flat();if(m.length){const g=await se.resolvePhotoUrls(m);let A=0;const I=u.map((V,N)=>{const D=z[N].length,ee=g.slice(A,A+D);return A+=D,{...V,photos:ee}});B(I)}else B(u)}else B(u||[])}catch(u){console.warn("Failed to load backup tickets:",u)}}catch(d){console.error("Error loading signature data:",d),p("Unable to load signature request. Please try again.")}finally{S(!1)}},F=L.useMemo(()=>!o||b?.document_type!=="cor"?null:ze(o),[o,b]),K=()=>{if(!b)return{slot1:null,slot2:null,availableSlots:[]};const d=b.signatures||[],i=d.find(m=>m.signature_slot===1),u=d.find(m=>m.signature_slot===2),z=[];return i||z.push(1),u||z.push(2),{slot1:i,slot2:u,availableSlots:z}},ie=async()=>{try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch{return null}},re=async d=>{if(!(!b||!t))try{n(!0);const i=await ie(),u=await se.addSignature(b.id,t,{...d,ipAddress:i,userAgent:navigator.userAgent});await se.syncSignatureToDocument(u,b),await W(),r(!1),f(null),y("signed")}catch(i){console.error("Error submitting signature:",i),p("Failed to submit signature. Please try again.")}finally{n(!1)}},h=d=>{f(d),r(!0)},M=async()=>{if(!(!o||!b))try{C(!0);let d=null;if(R)try{d=await se.getCORTickets(o.id)}catch(u){console.warn("Failed to fetch T&M tickets for backup:",u)}const i={logoUrl:k?.logo_url,primaryColor:k?.branding_color};await Oe(o,Y,k,i,d),y("PDF downloaded successfully!"),setTimeout(()=>y(null),3e3)}catch(d){console.error("Download failed:",d),p("Failed to generate PDF. Please try again.")}finally{C(!1)}},ne=async()=>{if(!(!o||!b))try{C(!0);const d=o?.projects?.companies,i=o?.projects,u={logoUrl:d?.logo_url,primaryColor:d?.branding_color};await Me(o,i,d,u),y("PDF downloaded successfully!"),setTimeout(()=>y(null),3e3)}catch(d){console.error("Download failed:",d),p("Failed to generate PDF. Please try again.")}finally{C(!1)}};if(j)return e.jsx("div",{className:"signature-page",children:e.jsxs("div",{className:"signature-page-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading document..."})]})});if(v)return e.jsx("div",{className:"signature-page",children:e.jsxs("div",{className:"signature-page-error",children:[e.jsx(je,{size:48}),e.jsx("h2",{children:"Unable to Load Document"}),e.jsx("p",{children:v})]})});const{slot1:w,slot2:P,availableSlots:le}=K(),J=w||P,R=b?.document_type==="cor",k=o?.projects?.companies,Y=o?.projects;if(!R){const d=o.t_and_m_workers?.length||0,i=o.t_and_m_workers?.reduce((u,z)=>u+(z.hours||0),0)||0;return e.jsxs("div",{className:"signature-page",children:[e.jsxs("header",{className:"signature-page-header",children:[k?.logo_url?e.jsx("img",{src:k.logo_url,alt:k.name,className:"company-logo"}):e.jsx("div",{className:"company-logo-placeholder",children:e.jsx(be,{size:24})}),e.jsxs("div",{className:"company-info",children:[e.jsx("h1",{children:k?.name||"FieldSync"}),e.jsx("span",{className:"doc-type-label",children:"Time & Material Ticket"})]})]}),s==="signed"&&e.jsx("div",{className:"signature-signed-overlay",children:e.jsxs("div",{className:"signature-signed-content",children:[e.jsx(Q,{size:48}),e.jsx("h2",{children:"Document Signed Successfully"}),e.jsx("p",{children:"This document has been signed and submitted."}),e.jsx("button",{className:"btn btn-primary download-copy-btn",onClick:ne,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:18}),"Save a Copy for Your Records"]})}),e.jsx("p",{className:"close-prompt",children:"You may close this page when done."})]})}),e.jsxs("main",{className:"signature-page-content",children:[e.jsxs("div",{className:"signature-document-card",children:[e.jsxs("div",{className:"document-card-header",children:[e.jsx(fe,{size:20}),e.jsxs("div",{className:"document-card-title",children:[e.jsx("h2",{children:"Time & Material Ticket"}),e.jsx("span",{className:"document-subtitle",children:o.ce_pco_number?`CE/PCO: ${o.ce_pco_number}`:"Time & Materials"})]})]}),e.jsxs("div",{className:"document-card-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Project"}),e.jsx("span",{className:"detail-value",children:Y?.name})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Work Date"}),e.jsx("span",{className:"detail-value",children:ae(o.work_date)})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Workers"}),e.jsxs("span",{className:"detail-value",children:[d," (",i," hrs)"]})]}),o.notes&&e.jsxs("div",{className:"detail-row full-width",children:[e.jsx("span",{className:"detail-label",children:"Description"}),e.jsx("span",{className:"detail-value",children:o.notes})]})]}),o.t_and_m_workers?.length>0&&e.jsxs("div",{className:"signature-detail-section",children:[e.jsxs("h4",{children:[e.jsx(Ne,{size:16})," Workers"]}),e.jsxs("table",{className:"signature-detail-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT"})]})}),e.jsx("tbody",{children:o.t_and_m_workers.map((u,z)=>e.jsxs("tr",{children:[e.jsx("td",{children:u.name}),e.jsx("td",{children:u.role||"Laborer"}),e.jsx("td",{children:u.time_started&&u.time_ended?`${ce(u.time_started)} - ${ce(u.time_ended)}`:"-"}),e.jsx("td",{children:u.hours||0}),e.jsx("td",{children:u.overtime_hours||"-"})]},z))})]})]}),o.t_and_m_items?.length>0&&e.jsxs("div",{className:"signature-detail-section",children:[e.jsxs("h4",{children:[e.jsx(xe,{size:16})," Materials & Equipment"]}),e.jsxs("table",{className:"signature-detail-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"})]})}),e.jsx("tbody",{children:o.t_and_m_items.map((u,z)=>e.jsxs("tr",{children:[e.jsx("td",{children:u.custom_name||u.materials_equipment?.name||"Item"}),e.jsx("td",{children:u.quantity}),e.jsx("td",{children:u.materials_equipment?.unit||"each"})]},z))})]})]}),o.photos?.length>0&&e.jsxs("div",{className:"signature-detail-section",children:[e.jsxs("h4",{children:[e.jsx(Se,{size:16})," Photos (",o.photos.length,")"]}),e.jsx("div",{className:"signature-photo-grid",children:o.photos.map((u,z)=>e.jsx("div",{className:"signature-photo-thumb",children:e.jsx("img",{src:typeof u=="string"?u:u.url,alt:`Photo ${z+1}`,onError:m=>{m.target.style.display="none"}})},z))})]})]}),e.jsxs("div",{className:"signature-status-section",children:[e.jsx("h3",{children:"Signature"}),J?e.jsxs(e.Fragment,{children:[w&&de(1,w,"GC Authorization",h,$),P&&de(2,P,"Client Authorization",h,$)]}):e.jsxs(e.Fragment,{children:[de(1,w,"GC Authorization",h,$),!w&&e.jsx("p",{className:"or-divider",children:"— or —"}),de(2,P,"Client Authorization",h,$)]}),J&&e.jsxs("div",{className:"fully-signed-message",children:[e.jsx(Q,{size:24}),e.jsx("p",{children:"This document has been signed."})]})]})]}),e.jsx("footer",{className:"signature-page-footer",children:e.jsx("p",{children:"Powered by FieldSync"})}),x&&t&&e.jsx(Ce,{enhanced:!0,requireAcknowledgment:!0,lockBodyScroll:!0,slot:t,documentType:"tm_ticket",documentTitle:"Time & Material Ticket",onSave:re,onClose:()=>{r(!1),f(null)}})]})}return e.jsxs("div",{className:"signature-page",children:[e.jsxs("header",{className:"signature-page-header",children:[k?.logo_url?e.jsx("img",{src:k.logo_url,alt:k.name,className:"company-logo"}):e.jsx("div",{className:"company-logo-placeholder",children:e.jsx(be,{size:24})}),e.jsxs("div",{className:"company-info",children:[e.jsx("h1",{children:k?.name||"FieldSync"}),e.jsx("span",{className:"doc-type-label",children:"Change Order Request"})]})]}),s==="signed"&&e.jsx("div",{className:"signature-signed-overlay",children:e.jsxs("div",{className:"signature-signed-content",children:[e.jsx(Q,{size:48}),e.jsx("h2",{children:"Document Signed Successfully"}),e.jsx("p",{children:"This document has been signed and submitted."}),e.jsx("button",{className:"btn btn-primary download-copy-btn",onClick:M,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:18}),"Save a Copy for Your Records"]})}),e.jsx("p",{className:"close-prompt",children:"You may close this page when done."})]})}),e.jsxs("main",{className:"signature-page-content cor-full-document",children:[e.jsxs("div",{className:"cor-header-card",children:[e.jsxs("div",{className:"cor-header-top",children:[e.jsxs("div",{className:"cor-title-section",children:[e.jsx("h2",{className:"cor-number",children:o.cor_number}),e.jsx(Le,{status:o.status})]}),e.jsxs("div",{className:"cor-date",children:["Created ",ae(o.created_at)]})]}),e.jsx("h3",{className:"cor-title",children:o.title||"Untitled Change Order"}),e.jsxs("div",{className:"cor-info-grid",children:[e.jsxs("div",{className:"cor-info-item",children:[e.jsx("span",{className:"cor-info-label",children:"Project"}),e.jsx("span",{className:"cor-info-value",children:Y?.name})]}),Y?.job_number&&e.jsxs("div",{className:"cor-info-item",children:[e.jsx("span",{className:"cor-info-label",children:"Job #"}),e.jsx("span",{className:"cor-info-value",children:Y.job_number})]}),e.jsxs("div",{className:"cor-info-item",children:[e.jsx("span",{className:"cor-info-label",children:"Period"}),e.jsx("span",{className:"cor-info-value",children:Pe(o.period_start,o.period_end)})]})]}),o.scope_of_work&&e.jsxs("div",{className:"cor-scope",children:[e.jsx("h4",{children:"Scope of Work"}),e.jsx("p",{children:o.scope_of_work})]})]}),o.change_order_labor?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(De,{size:18}),e.jsx("h4",{children:"Labor"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{className:"text-right",children:"Reg Hrs"}),e.jsx("th",{className:"text-right",children:"Reg Rate"}),e.jsx("th",{className:"text-right",children:"OT Hrs"}),e.jsx("th",{className:"text-right",children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:o.change_order_labor.map((d,i)=>e.jsxs("tr",{children:[e.jsx("td",{children:d.labor_class}),e.jsx("td",{children:d.wage_type}),e.jsx("td",{className:"text-right",children:d.regular_hours}),e.jsxs("td",{className:"text-right",children:["$",te(d.regular_rate),"/hr"]}),e.jsx("td",{className:"text-right",children:d.overtime_hours||"-"}),e.jsx("td",{className:"text-right",children:d.overtime_hours?`$${te(d.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:_(d.total)})]},i))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"5",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.labor_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"5",className:"text-right",children:["+ ",q(o.labor_markup_percent||1500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.labor_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"5",className:"text-right",children:e.jsx("strong",{children:"Labor Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:_(F.labor_subtotal+F.labor_markup_amount)})})]})]})]})})]}),o.change_order_materials?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(xe,{size:18}),e.jsx("h4",{children:"Materials"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{className:"text-right",children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:o.change_order_materials.map((d,i)=>e.jsxs("tr",{children:[e.jsx("td",{children:d.description}),e.jsx("td",{children:d.source_reference||d.source_type}),e.jsx("td",{className:"text-right",children:d.quantity}),e.jsx("td",{children:d.unit}),e.jsxs("td",{className:"text-right",children:["$",te(d.unit_cost)]}),e.jsx("td",{className:"text-right",children:_(d.total)})]},i))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"4",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.materials_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"4",className:"text-right",children:["+ ",q(o.materials_markup_percent||1500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.materials_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"4",className:"text-right",children:e.jsx("strong",{children:"Materials Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:_(F.materials_subtotal+F.materials_markup_amount)})})]})]})]})})]}),o.change_order_equipment?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx(Ie,{size:18}),e.jsx("h4",{children:"Equipment"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{className:"text-right",children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:o.change_order_equipment.map((d,i)=>e.jsxs("tr",{children:[e.jsx("td",{children:d.description}),e.jsx("td",{children:d.source_reference||d.source_type}),e.jsx("td",{className:"text-right",children:d.quantity}),e.jsx("td",{children:d.unit}),e.jsxs("td",{className:"text-right",children:["$",te(d.unit_cost)]}),e.jsx("td",{className:"text-right",children:_(d.total)})]},i))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"4",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.equipment_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"4",className:"text-right",children:["+ ",q(o.equipment_markup_percent||1500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.equipment_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"4",className:"text-right",children:e.jsx("strong",{children:"Equipment Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:_(F.equipment_subtotal+F.equipment_markup_amount)})})]})]})]})})]}),o.change_order_subcontractors?.length>0&&e.jsxs("div",{className:"cor-section",children:[e.jsxs("div",{className:"cor-section-header",children:[e.jsx($e,{size:18}),e.jsx("h4",{children:"Subcontractors"})]}),e.jsx("div",{className:"cor-table-wrapper",children:e.jsxs("table",{className:"cor-line-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:o.change_order_subcontractors.map((d,i)=>e.jsxs("tr",{children:[e.jsx("td",{children:d.company_name}),e.jsx("td",{children:d.description}),e.jsx("td",{children:d.source_reference||d.source_type}),e.jsx("td",{className:"text-right",children:_(d.total)})]},i))}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:"2",className:"text-right",children:"Subtotal:"}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.subcontractors_subtotal)})]}),e.jsxs("tr",{className:"markup-row",children:[e.jsxs("td",{colSpan:"2",className:"text-right",children:["+ ",q(o.subcontractors_markup_percent||500)," Markup:"]}),e.jsx("td",{className:"text-right",colSpan:"2",children:_(F.subcontractors_markup_amount)})]}),e.jsxs("tr",{className:"section-total-row",children:[e.jsx("td",{colSpan:"2",className:"text-right",children:e.jsx("strong",{children:"Subcontractors Total:"})}),e.jsx("td",{className:"text-right",colSpan:"2",children:e.jsx("strong",{children:_(F.subcontractors_subtotal+F.subcontractors_markup_amount)})})]})]})]})})]}),T.length>0&&(()=>{const d=T.reduce((m,g)=>m+(g.t_and_m_workers?.reduce((A,I)=>A+(parseFloat(I.hours)||0),0)||0),0),i=T.reduce((m,g)=>m+(g.t_and_m_workers?.reduce((A,I)=>A+(parseFloat(I.overtime_hours)||0),0)||0),0),u=T.reduce((m,g)=>m+(g.photos?.length||0),0),z=T.filter(m=>m.client_signature_data).length;return e.jsxs("div",{className:"cor-section cor-backup-section",children:[e.jsxs("div",{className:"backup-official-header",children:[e.jsxs("div",{className:"backup-official-badge",children:[e.jsx(fe,{size:16}),e.jsx("span",{children:"Supporting Documentation"})]}),e.jsxs("div",{className:"backup-summary-bar",children:[e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:T.length}),e.jsx("span",{className:"backup-stat-label",children:"Tickets"})]}),e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:d.toFixed(1)}),e.jsx("span",{className:"backup-stat-label",children:"Labor Hrs"})]}),i>0&&e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:i.toFixed(1)}),e.jsx("span",{className:"backup-stat-label",children:"OT Hrs"})]}),e.jsxs("div",{className:"backup-stat",children:[e.jsx("span",{className:"backup-stat-value",children:u}),e.jsx("span",{className:"backup-stat-label",children:"Photos"})]}),z>0&&e.jsxs("div",{className:"backup-stat verified",children:[e.jsx("span",{className:"backup-stat-value",children:z}),e.jsx("span",{className:"backup-stat-label",children:"Verified"})]})]})]}),e.jsxs("div",{className:"cor-section-header cor-backup-header",onClick:()=>G(!H),style:{cursor:"pointer",marginBottom:H?"1rem":0},children:[e.jsx("div",{className:"backup-header-left",children:e.jsx("span",{children:"View All T&M Tickets"})}),e.jsx("div",{className:"backup-header-toggle",children:H?e.jsx(ve,{size:20}):e.jsx(ye,{size:20})})]}),H&&e.jsx("div",{className:"backup-tickets-list",style:{padding:"0 0.5rem"},children:T.map(m=>{const g=U.has(m.id),A=m.t_and_m_workers?.reduce((N,D)=>N+(parseFloat(D.hours)||0),0)||0,I=m.t_and_m_workers?.reduce((N,D)=>N+(parseFloat(D.overtime_hours)||0),0)||0,V=!!m.client_signature_data;return e.jsxs("div",{className:"backup-ticket-pro","data-verified":V,"data-status":m.status||"pending",children:[e.jsxs("div",{className:"ticket-pro-header",onClick:()=>{const N=new Set(U);g?N.delete(m.id):N.add(m.id),O(N)},style:{cursor:"pointer"},children:[e.jsxs("div",{className:"ticket-date-badge",children:[e.jsx(Re,{size:14}),e.jsx("span",{children:ae(m.work_date)})]}),m.ce_pco_number&&e.jsx("span",{className:"ticket-pco-badge",children:m.ce_pco_number}),V&&e.jsxs("span",{className:"ticket-verified-seal",children:[e.jsx(Q,{size:12})," Verified"]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.85rem",color:"var(--text-muted)"},children:[m.t_and_m_workers?.length||0," workers • ",A+I," hrs"]}),g?e.jsx(ve,{size:16}):e.jsx(ye,{size:16})]})]}),g&&e.jsxs("div",{className:"ticket-pro-body",children:[m.notes&&e.jsx("div",{className:"ticket-description-box",children:e.jsx("p",{children:m.notes})}),m.t_and_m_workers?.length>0&&e.jsxs("div",{className:"ticket-section-pro",children:[e.jsxs("div",{className:"ticket-section-header",children:[e.jsx(Ne,{size:14}),e.jsx("span",{children:"Labor"}),e.jsxs("span",{className:"section-count",children:[A+I," hrs total"]})]}),e.jsx("div",{className:"worker-pro-grid",children:m.t_and_m_workers.map((N,D)=>e.jsxs("div",{className:"worker-pro-row",children:[e.jsxs("div",{children:[e.jsx("span",{className:"worker-name",children:N.name}),N.role&&e.jsxs("span",{className:"worker-role",children:[" • ",N.role]})]}),e.jsx("span",{className:"worker-time",children:N.time_started&&N.time_ended?`${ce(N.time_started)} - ${ce(N.time_ended)}`:"-"}),e.jsxs("span",{className:"worker-hours",children:[N.hours||0," hrs"]}),e.jsx("span",{className:"worker-ot",children:parseFloat(N.overtime_hours)>0?`+${N.overtime_hours} OT`:"-"})]},D))})]}),m.t_and_m_items?.length>0&&e.jsxs("div",{className:"ticket-section-pro",children:[e.jsxs("div",{className:"ticket-section-header",children:[e.jsx(xe,{size:14}),e.jsx("span",{children:"Materials / Equipment"}),e.jsxs("span",{className:"section-count",children:[m.t_and_m_items.length," items"]})]}),e.jsx("div",{className:"materials-pro-list",children:m.t_and_m_items.map((N,D)=>e.jsxs("div",{className:"material-pro-row",children:[e.jsx("span",{className:"material-name",children:N.materials_equipment?.name||N.description||"Item"}),e.jsxs("span",{className:"material-qty",children:[N.quantity||1," ",N.materials_equipment?.unit||"ea"]}),e.jsx("span",{className:"material-source",children:"Time & Material"})]},D))})]}),m.photos?.length>0&&e.jsxs("div",{className:"ticket-section-pro",children:[e.jsxs("div",{className:"ticket-section-header",children:[e.jsx(Se,{size:14}),e.jsx("span",{children:"Photo Evidence"}),e.jsx("span",{className:"section-count",children:m.photos.length})]}),e.jsx("div",{className:"photo-evidence-grid",children:m.photos.map((N,D)=>e.jsx("a",{href:N,target:"_blank",rel:"noopener noreferrer",className:"photo-evidence-item",children:e.jsx("img",{src:N,alt:`Evidence ${D+1}`,onError:ee=>{ee.target.onerror=null,ee.target.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=="}})},D))})]}),V&&e.jsxs("div",{className:"ticket-verification-footer",children:[e.jsx("div",{className:"verification-seal-icon",children:e.jsx(Q,{size:22})}),m.client_signature_data&&e.jsx("img",{src:m.client_signature_data,alt:"Client Signature",className:"verification-signature-img"}),e.jsxs("div",{className:"verification-info",children:[e.jsx("span",{className:"signer-name",children:m.client_signature_name||"Client"}),(m.client_signature_title||m.client_signature_company)&&e.jsx("span",{className:"signer-title",children:[m.client_signature_title,m.client_signature_company].filter(Boolean).join(", ")}),m.client_signature_date&&e.jsxs("span",{className:"verify-date",children:["Verified ",ae(m.client_signature_date)]})]})]})]})]},m.id)})}),e.jsxs("div",{className:"backup-note",children:[e.jsx(je,{size:14}),e.jsx("span",{children:"This documentation supports the work described in this Change Order Request."})]})]})})(),e.jsxs("div",{className:"cor-totals-card",children:[e.jsx("h4",{children:"COR Summary"}),e.jsxs("div",{className:"cor-totals-grid",children:[e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:_(F.cor_subtotal)})]}),e.jsxs("div",{className:"cor-fees-section",children:[e.jsxs("div",{className:"cor-fee-row",children:[e.jsxs("span",{children:["Liability Insurance (",q(o.liability_insurance_percent||144),")"]}),e.jsx("span",{children:_(F.liability_insurance_amount)})]}),e.jsxs("div",{className:"cor-fee-row",children:[e.jsxs("span",{children:["Bond (",q(o.bond_percent||100),")"]}),e.jsx("span",{children:_(F.bond_amount)})]}),e.jsxs("div",{className:"cor-fee-row",children:[e.jsxs("span",{children:["City License Fee (",q(o.license_fee_percent||10),")"]}),e.jsx("span",{children:_(F.license_fee_amount)})]})]}),e.jsxs("div",{className:"cor-grand-total",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:_(F.cor_total)})]})]})]}),e.jsxs("div",{className:"cor-signature-section",children:[e.jsx("h4",{children:"Authorization"}),e.jsx("p",{className:"signature-instruction",children:"By signing below, you authorize the above change order request and agree to the terms and costs outlined."}),e.jsx("div",{className:"signature-slots-grid",children:J?e.jsxs(e.Fragment,{children:[w&&e.jsxs("div",{className:"signature-slot-card signed",children:[e.jsxs("div",{className:"slot-header",children:[e.jsx(Q,{size:20,className:"status-icon signed"}),e.jsx("span",{className:"slot-label",children:"GC Authorization"})]}),e.jsxs("div",{className:"slot-signed-info",children:[w.signature_data&&e.jsx("img",{src:w.signature_data,alt:"Signature",className:"signature-image"}),e.jsxs("div",{className:"signer-details",children:[e.jsx("span",{className:"signer-name",children:w.signer_name}),(w.signer_title||w.signer_company)&&e.jsxs("span",{className:"signer-org",children:[w.signer_title,w.signer_title&&w.signer_company&&" — ",w.signer_company]})]}),e.jsxs("span",{className:"signed-date",children:["Signed ",ae(w.signed_at)]})]})]}),P&&e.jsxs("div",{className:"signature-slot-card signed",children:[e.jsxs("div",{className:"slot-header",children:[e.jsx(Q,{size:20,className:"status-icon signed"}),e.jsx("span",{className:"slot-label",children:"Client Authorization"})]}),e.jsxs("div",{className:"slot-signed-info",children:[P.signature_data&&e.jsx("img",{src:P.signature_data,alt:"Signature",className:"signature-image"}),e.jsxs("div",{className:"signer-details",children:[e.jsx("span",{className:"signer-name",children:P.signer_name}),(P.signer_title||P.signer_company)&&e.jsxs("span",{className:"signer-org",children:[P.signer_title,P.signer_title&&P.signer_company&&" — ",P.signer_company]})]}),e.jsxs("span",{className:"signed-date",children:["Signed ",ae(P.signed_at)]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`signature-slot-card ${w?"signed":"unsigned"}`,children:[e.jsxs("div",{className:"slot-header",children:[w?e.jsx(Q,{size:20,className:"status-icon signed"}):e.jsx(ge,{size:20,className:"status-icon pending"}),e.jsx("span",{className:"slot-label",children:"GC Authorization"})]}),e.jsx("button",{className:"btn btn-primary sign-btn",onClick:()=>h(1),disabled:$,children:"Sign as GC"})]}),e.jsx("p",{className:"or-divider",children:"— or —"}),e.jsxs("div",{className:`signature-slot-card ${P?"signed":"unsigned"}`,children:[e.jsxs("div",{className:"slot-header",children:[P?e.jsx(Q,{size:20,className:"status-icon signed"}):e.jsx(ge,{size:20,className:"status-icon pending"}),e.jsx("span",{className:"slot-label",children:"Client Authorization"})]}),e.jsx("button",{className:"btn btn-primary sign-btn",onClick:()=>h(2),disabled:$,children:"Sign as Client"})]})]})}),J&&e.jsxs("div",{className:"fully-signed-message",children:[e.jsx(Q,{size:24}),e.jsx("p",{children:"This change order request has been signed."})]}),e.jsxs("div",{className:"cor-download-section",children:[e.jsx("h4",{children:"Download Your Copy"}),e.jsx("p",{className:"download-description",children:J?"Download a PDF copy of this fully signed COR including all T&M backup documentation.":"Download a PDF copy of this COR for your records. Signature status will be included."}),e.jsx("button",{className:"btn btn-primary download-btn",onClick:M,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"download-spinner"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:18}),"Download COR + Backup"]})})]})]})]}),e.jsx("footer",{className:"signature-page-footer",children:e.jsx("p",{children:"Powered by FieldSync"})}),x&&t&&e.jsx(Ce,{enhanced:!0,requireAcknowledgment:!0,lockBodyScroll:!0,slot:t,documentType:b.document_type,documentTitle:`${o.cor_number} - ${o.title}`,onSave:re,onClose:()=>{r(!1),f(null)}})]})}function de(l,j,S,v,p){return e.jsxs("div",{className:`signature-slot-card ${j?"signed":"unsigned"}`,children:[e.jsxs("div",{className:"slot-header",children:[j?e.jsx(Q,{size:20,className:"status-icon signed"}):e.jsx(ge,{size:20,className:"status-icon pending"}),e.jsxs("span",{className:"slot-label",children:["Signature ",l," — ",S]})]}),j?e.jsxs("div",{className:"slot-signed-info",children:[e.jsxs("div",{className:"signer-details",children:[e.jsx("span",{className:"signer-name",children:j.signer_name}),(j.signer_title||j.signer_company)&&e.jsxs("span",{className:"signer-org",children:[j.signer_title,j.signer_title&&j.signer_company&&" — ",j.signer_company]})]}),e.jsxs("span",{className:"signed-date",children:["Signed ",ae(j.signed_at)]})]}):e.jsxs("button",{className:"btn btn-primary sign-btn",onClick:()=>v(l),disabled:p,children:["Sign as ",l===1?"GC":"Client"]})]})}export{Ve as default};
//# sourceMappingURL=SignaturePage-DEJCRUuc.js.map
