import{j as e,d as g}from"./index-CycIrh0T.js";import{r as l,X as K,ax as re,ay as Oe,a as me,L as R,k as ne,az as oe,ae as X,aA as Ne,c as Ae,j as ye,v as se,F as J,aB as L,y as Me,af as Be,an as te,aj as Ue,T as Ce,t as ze,f as Fe,aC as De,i as ke,aD as Se,ad as we,aE as _e,x as Ge,as as Ee,w as Pe,n as ie,aF as Ve,z as We,D as qe,e as ue,aG as He,a7 as Ke}from"./icons-CJNREYZA.js";import"./react-DXGY7bZi.js";import"./pdf-ChZ1zkDw.js";import"./supabase-VuevzHjS.js";const Ie=[{id:"plans",label:"Plans & Drawings",icon:"Map"},{id:"specs",label:"Specifications",icon:"FileText"},{id:"permits",label:"Permits & Approvals",icon:"Shield"},{id:"contracts",label:"Contracts",icon:"FileSignature"},{id:"submittals",label:"Submittals",icon:"Send"},{id:"rfis",label:"RFIs",icon:"HelpCircle"},{id:"photos",label:"Site Photos",icon:"Camera"},{id:"reports",label:"Reports",icon:"ClipboardList"},{id:"safety",label:"Safety Documents",icon:"AlertTriangle"},{id:"general",label:"General",icon:"Folder"}],he={"application/pdf":{ext:"pdf",maxSize:25*1024*1024,label:"PDF"},"application/msword":{ext:"doc",maxSize:15*1024*1024,label:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{ext:"docx",maxSize:15*1024*1024,label:"Word"},"application/vnd.ms-excel":{ext:"xls",maxSize:15*1024*1024,label:"Excel"},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{ext:"xlsx",maxSize:15*1024*1024,label:"Excel"},"image/jpeg":{ext:"jpg",maxSize:10*1024*1024,label:"Image"},"image/png":{ext:"png",maxSize:10*1024*1024,label:"Image"}},Le={all:{label:"Everyone",description:"Visible to all team members including field users"},office_only:{label:"Office Only",description:"Only visible to office staff and admins"},admin_only:{label:"Admins Only",description:"Only visible to company administrators"}},Qe=["contracts"],Ye=25,xe=n=>{if(!n)return"0 B";const u=["B","KB","MB","GB"];let t=n,d=0;for(;t>=1024&&d<u.length-1;)t/=1024,d++;return`${t.toFixed(t<10?1:0)} ${u[d]}`};function pe({projectId:n,companyId:u,folderId:t,folderName:d,onClose:S,onUploadComplete:i,onShowToast:P}){const[x,h]=l.useState(null),[I,w]=l.useState(!1),[v,F]=l.useState(!1),[D,C]=l.useState(""),[z,r]=l.useState(null),[m,j]=l.useState(""),[E,k]=l.useState(""),[N,b]=l.useState("general"),[y,B]=l.useState("all"),A=l.useRef(null),U=s=>{if(!s)return"Please select a file";const $=he[s.type];return $?s.size>$.maxSize?`File too large. Maximum size for ${$.label}: ${xe($.maxSize)}`:null:"File type not supported. Allowed: PDF, Word, Excel, Images"},o=l.useCallback(s=>{const $=U(s);if($){r($);return}if(r(null),h(s),!m){const Q=s.name.replace(/\.[^/.]+$/,"");j(Q)}},[m]),G=s=>{s.preventDefault(),s.stopPropagation(),s.type==="dragenter"||s.type==="dragover"?w(!0):s.type==="dragleave"&&w(!1)},a=s=>{s.preventDefault(),s.stopPropagation(),w(!1),s.dataTransfer.files&&s.dataTransfer.files[0]&&o(s.dataTransfer.files[0])},_=s=>{s.target.files&&s.target.files[0]&&o(s.target.files[0])},M=async()=>{if(!x){r("Please select a file");return}if(!m.trim()){r("Please enter a document name");return}F(!0),r(null),C("Uploading document...");try{const s=await g.uploadDocument(u,n,x,{name:m.trim(),description:E.trim()||null,category:N,visibility:y,folderId:t||null});C("Upload complete!"),i(s)}catch(s){console.error("Upload error:",s),r(s.message||"Failed to upload document"),F(!1)}},O=Qe.includes(N);return e.jsx("div",{className:"modal-overlay",onClick:S,children:e.jsxs("div",{className:"document-upload-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Upload Document"}),d&&e.jsxs("span",{className:"modal-subtitle",children:["to ",d]})]}),e.jsx("button",{className:"modal-close",onClick:S,children:e.jsx(K,{size:20})})]}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:`document-dropzone ${I?"drag-active":""} ${x?"has-file":""}`,onDragEnter:G,onDragLeave:G,onDragOver:G,onDrop:a,onClick:()=>!x&&A.current?.click(),children:[e.jsx("input",{ref:A,type:"file",accept:Object.keys(he).join(","),onChange:_,style:{display:"none"}}),x?e.jsxs("div",{className:"dropzone-file",children:[e.jsx(re,{size:32}),e.jsxs("div",{className:"dropzone-file-info",children:[e.jsx("span",{className:"dropzone-file-name",children:x.name}),e.jsx("span",{className:"dropzone-file-size",children:xe(x.size)})]}),e.jsx("button",{className:"dropzone-file-remove",onClick:s=>{s.stopPropagation(),h(null),r(null)},children:e.jsx(K,{size:16})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{size:48}),e.jsxs("p",{className:"dropzone-text",children:["Drag & drop files here",e.jsx("br",{}),"or click to browse"]}),e.jsx("p",{className:"dropzone-hint",children:"PDF, Word, Excel, Images • Max 25MB"})]})]}),z&&e.jsxs("div",{className:"document-upload-error",children:[e.jsx(me,{size:16}),z]}),e.jsxs("div",{className:"document-upload-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-name",children:"Document Name *"}),e.jsx("input",{id:"doc-name",type:"text",value:m,onChange:s=>j(s.target.value),placeholder:"Enter document name",disabled:v})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-category",children:"Category"}),e.jsx("select",{id:"doc-category",value:N,onChange:s=>b(s.target.value),disabled:v,children:Ie.map(s=>e.jsx("option",{value:s.id,children:s.label},s.id))}),O&&e.jsxs("p",{className:"form-hint warning",children:[e.jsx(me,{size:14}),"Documents in this category require admin approval before becoming visible."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-description",children:"Description"}),e.jsx("textarea",{id:"doc-description",value:E,onChange:s=>k(s.target.value),placeholder:"Optional description...",rows:3,disabled:v})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Visibility"}),e.jsx("div",{className:"visibility-options",children:Object.entries(Le).map(([s,{label:$,description:Q}])=>e.jsxs("label",{className:`visibility-option ${y===s?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"visibility",value:s,checked:y===s,onChange:V=>B(V.target.value),disabled:v}),e.jsxs("div",{className:"visibility-content",children:[e.jsx("span",{className:"visibility-label",children:$}),e.jsx("span",{className:"visibility-desc",children:Q})]})]},s))})]})]})]}),e.jsx("div",{className:"modal-footer",children:v?e.jsxs("div",{className:"upload-progress",children:[e.jsx(R,{size:20,className:"spinner"}),e.jsx("span",{children:D})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:S,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:M,disabled:!x||!m.trim(),children:[e.jsx(ne,{size:18}),"Upload Document"]})]})})]})})}const Xe=n=>{if(!n)return"0 B";const u=["B","KB","MB","GB"];let t=n,d=0;for(;t>=1024&&d<u.length-1;)t/=1024,d++;return`${t.toFixed(t<10?1:0)} ${u[d]}`},je=n=>n?new Date(n).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"";function Je({document:n,onBack:u,onUpdate:t,onShowToast:d,isOfficeOrAdmin:S}){const[i,P]=l.useState(n),[x,h]=l.useState([]),[I,w]=l.useState(!0),[v,F]=l.useState(!1),[D,C]=l.useState(""),[z,r]=l.useState(!1),m=Ie.find(o=>o.id===i.category),j=Le[i.visibility],E=i.approval_status==="pending",k=i.approval_status==="rejected",N=S;l.useEffect(()=>{b()},[i.id]);const b=async()=>{w(!0);try{const o=await g.getDocumentVersions(i.id);h(o)}catch(o){console.error("Error loading versions:",o)}finally{w(!1)}},y=async()=>{await g.logDocumentAccess(i.id,"downloaded");const o=`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${i.storage_path}`;window.open(o,"_blank")},B=async()=>{r(!0);try{await g.approveDocument(i.id),P(o=>({...o,approval_status:"approved"})),d?.("Document approved","success"),t?.()}catch(o){console.error("Error approving document:",o),d?.("Failed to approve document","error")}finally{r(!1)}},A=async()=>{if(!D.trim()){d?.("Please provide a reason for rejection","error");return}r(!0);try{await g.rejectDocument(i.id,D.trim()),P(o=>({...o,approval_status:"rejected",rejection_reason:D.trim()})),F(!1),C(""),d?.("Document rejected","success"),t?.()}catch(o){console.error("Error rejecting document:",o),d?.("Failed to reject document","error")}finally{r(!1)}},U=async()=>{if(confirm("Are you sure you want to archive this document?")){r(!0);try{await g.archiveDocument(i.id),d?.("Document archived","success"),u(),t?.()}catch(o){console.error("Error archiving document:",o),d?.("Failed to archive document","error")}finally{r(!1)}}};return e.jsxs("div",{className:"document-detail",children:[e.jsxs("div",{className:"document-detail-header",children:[e.jsxs("button",{className:"back-btn",onClick:u,children:[e.jsx(oe,{size:20}),"Back"]}),e.jsxs("div",{className:"document-detail-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:y,children:[e.jsx(X,{size:18}),"Download"]}),S&&e.jsxs("button",{className:"btn btn-secondary btn-danger",onClick:U,disabled:z,children:[e.jsx(Ne,{size:18}),"Archive"]})]})]}),e.jsxs("div",{className:"document-detail-content",children:[e.jsxs("div",{className:"document-detail-main",children:[e.jsxs("div",{className:"document-detail-title",children:[e.jsx("h2",{children:i.name}),i.version>1&&e.jsxs("span",{className:"version-badge",children:["v",i.version]})]}),(E||k)&&e.jsxs("div",{className:"document-detail-status",children:[E&&e.jsxs("div",{className:"status-banner pending",children:[e.jsx(Ae,{size:18}),e.jsx("span",{children:"Pending Approval"}),N&&e.jsxs("div",{className:"status-actions",children:[e.jsxs("button",{className:"btn btn-sm btn-success",onClick:B,disabled:z,children:[e.jsx(ye,{size:16}),"Approve"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:()=>F(!0),disabled:z,children:[e.jsx(se,{size:16}),"Reject"]})]})]}),k&&e.jsxs("div",{className:"status-banner rejected",children:[e.jsx(se,{size:18}),e.jsxs("div",{className:"rejected-info",children:[e.jsx("span",{children:"Rejected"}),i.rejection_reason&&e.jsx("p",{className:"rejection-reason",children:i.rejection_reason})]})]})]}),e.jsxs("div",{className:"document-detail-meta",children:[e.jsxs("div",{className:"meta-item",children:[e.jsx(J,{size:16}),e.jsx("span",{children:i.file_name})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(L,{size:16}),e.jsx("span",{children:m?.label||i.category})]}),e.jsx("div",{className:"meta-item",children:e.jsx("span",{className:"meta-size",children:Xe(i.file_size_bytes)})}),e.jsxs("div",{className:"meta-item",children:[e.jsx(Me,{size:16}),e.jsx("span",{children:je(i.uploaded_at)})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(Be,{size:16}),e.jsx("span",{children:i.uploaded_by_user?.email||"Unknown"})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(te,{size:16}),e.jsx("span",{children:j?.label||i.visibility})]})]}),i.description&&e.jsxs("div",{className:"document-detail-description",children:[e.jsx("h3",{children:"Description"}),e.jsx("p",{children:i.description})]}),i.resource_type&&i.resource_id&&e.jsxs("div",{className:"document-detail-linked",children:[e.jsxs("h3",{children:[e.jsx(Ue,{size:16}),"Linked To"]}),e.jsxs("p",{children:[i.resource_type==="cor"&&"Change Order Request",i.resource_type==="tm_ticket"&&"T&M Ticket",i.resource_type==="daily_report"&&"Daily Report"]})]})]}),e.jsxs("div",{className:"document-detail-sidebar",children:[e.jsx("h3",{children:"Version History"}),I?e.jsxs("div",{className:"versions-loading",children:[e.jsx(R,{size:20,className:"spinner"}),"Loading versions..."]}):x.length===0?e.jsx("p",{className:"versions-empty",children:"No version history"}):e.jsx("div",{className:"versions-list",children:x.map(o=>e.jsxs("div",{className:`version-item ${o.id===i.id?"current":""}`,children:[e.jsxs("div",{className:"version-info",children:[e.jsxs("span",{className:"version-number",children:["v",o.version,o.is_current&&e.jsx("span",{className:"current-badge",children:"Current"})]}),e.jsx("span",{className:"version-date",children:je(o.uploaded_at)}),e.jsx("span",{className:"version-user",children:o.uploaded_by_user?.email})]}),e.jsx("button",{className:"version-download",onClick:async()=>{await g.logDocumentAccess(o.id,"downloaded"),window.open(`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${o.storage_path}`,"_blank")},title:"Download this version",children:e.jsx(X,{size:16})})]},o.id))}),S&&e.jsx("div",{className:"upload-version",children:e.jsx("p",{className:"upload-version-hint",children:'To upload a new version, use the main upload button and select "Replace existing document"'})})]})]}),v&&e.jsx("div",{className:"modal-overlay",onClick:()=>F(!1),children:e.jsxs("div",{className:"reject-modal",onClick:o=>o.stopPropagation(),children:[e.jsx("h3",{children:"Reject Document"}),e.jsx("p",{children:"Please provide a reason for rejection:"}),e.jsx("textarea",{value:D,onChange:o=>C(o.target.value),placeholder:"Enter reason...",rows:4}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>F(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-danger",onClick:A,disabled:!D.trim()||z,children:[z?e.jsx(R,{size:16,className:"spinner"}):e.jsx(se,{size:16}),"Reject Document"]})]})]})})]})}const fe={folder:L,plans:_e,specs:J,permits:we,contracts:Se,submittals:ke,rfis:De,photos:Fe,reports:ze,safety:Ce},T={blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b",red:"#ef4444",purple:"#8b5cf6",pink:"#ec4899",gray:"#6b7280",orange:"#f97316"},Te=n=>n?.startsWith("image/")?Ee:n?.includes("spreadsheet")||n?.includes("excel")?Pe:n?.includes("pdf")?J:re,Ze=n=>{if(!n)return"0 B";const u=["B","KB","MB","GB"];let t=n,d=0;for(;t>=1024&&d<u.length-1;)t/=1024,d++;return`${t.toFixed(t<10?1:0)} ${u[d]}`},es=n=>n?new Date(n).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"";function ss({projectId:n,onShowToast:u}){const[t,d]=l.useState([]),[S,i]=l.useState(!0),[P,x]=l.useState(null),[h,I]=l.useState([]),[w,v]=l.useState(!1);l.useEffect(()=>{F()},[n]);const F=async()=>{i(!0);try{const r=await g.getProjectFolders(n);d(r)}catch(r){console.error("Error loading folders:",r),u?.("Failed to load folders","error")}finally{i(!1)}},D=async r=>{x(r),v(!0);try{const m=await g.getFolderDocuments(r.id);I(m.documents)}catch(m){console.error("Error loading documents:",m),u?.("Failed to load documents","error")}finally{v(!1)}},C=async r=>{try{await g.logDocumentAccess(r.id,"downloaded");const m=r.url||`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${r.storage_path}`;window.open(m,"_blank")}catch(m){console.error("Download error:",m)}},z=()=>{x(null),I([])};if(S)return e.jsxs("div",{className:"folder-grid-loading",children:[e.jsx(R,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading folders..."})]});if(P){const r=fe[P.icon]||L,m=T[P.color]||T.blue;return e.jsxs("div",{className:"folder-documents-view",children:[e.jsxs("div",{className:"folder-documents-header",children:[e.jsxs("button",{className:"folder-back-btn",onClick:z,children:[e.jsx(oe,{size:20}),"Back"]}),e.jsxs("div",{className:"folder-title",style:{"--folder-color":m},children:[e.jsx(r,{size:24,style:{color:m}}),e.jsx("h2",{children:P.name}),e.jsxs("span",{className:"folder-count",children:[h.length," files"]})]})]}),w?e.jsxs("div",{className:"folder-grid-loading",children:[e.jsx(R,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading documents..."})]}):h.length===0?e.jsxs("div",{className:"folder-empty",children:[e.jsx(L,{size:48,style:{color:m,opacity:.3}}),e.jsx("p",{children:"No documents in this folder"})]}):e.jsx("div",{className:"folder-document-list",children:h.map(j=>{const E=Te(j.mime_type);return e.jsxs("div",{className:"folder-document-item",onClick:()=>C(j),children:[e.jsx("div",{className:"folder-doc-icon",children:e.jsx(E,{size:24})}),e.jsxs("div",{className:"folder-doc-info",children:[e.jsx("span",{className:"folder-doc-name",children:j.name}),e.jsxs("span",{className:"folder-doc-meta",children:[Ze(j.file_size_bytes)," • ",es(j.uploaded_at)]})]}),e.jsx(X,{size:20,className:"folder-doc-download"})]},j.id)})})]})}return e.jsx("div",{className:"folder-grid",children:t.length===0?e.jsxs("div",{className:"folder-grid-empty",children:[e.jsx(L,{size:64}),e.jsx("h3",{children:"No folders yet"}),e.jsx("p",{children:"The office team will create folders for your project documents."})]}):e.jsx("div",{className:"folder-grid-items",children:t.map(r=>{const m=fe[r.icon]||L,j=T[r.color]||T.blue;return e.jsxs("button",{className:"folder-card",onClick:()=>D(r),style:{"--folder-color":j},children:[e.jsx("div",{className:"folder-card-icon",style:{backgroundColor:`${j}15`},children:e.jsx(m,{size:32,style:{color:j}})}),e.jsxs("div",{className:"folder-card-info",children:[e.jsx("span",{className:"folder-card-name",children:r.name}),e.jsxs("span",{className:"folder-card-count",children:[r.document_count||0," ",r.document_count===1?"file":"files"]})]}),e.jsx(Ge,{size:20,className:"folder-card-arrow"})]},r.id)})})})}const ae=[{id:"folder",label:"Folder",icon:L},{id:"plans",label:"Plans",icon:_e},{id:"specs",label:"Specs",icon:J},{id:"permits",label:"Permits",icon:we},{id:"contracts",label:"Contracts",icon:Se},{id:"submittals",label:"Submittals",icon:ke},{id:"rfis",label:"RFIs",icon:De},{id:"photos",label:"Photos",icon:Fe},{id:"reports",label:"Reports",icon:ze},{id:"safety",label:"Safety",icon:Ce}],le=[{id:"blue",label:"Blue",hex:"#3b82f6"},{id:"green",label:"Green",hex:"#10b981"},{id:"yellow",label:"Yellow",hex:"#f59e0b"},{id:"red",label:"Red",hex:"#ef4444"},{id:"purple",label:"Purple",hex:"#8b5cf6"},{id:"pink",label:"Pink",hex:"#ec4899"},{id:"orange",label:"Orange",hex:"#f97316"},{id:"gray",label:"Gray",hex:"#6b7280"}];function as({projectId:n,companyId:u,folders:t,onFoldersChange:d,onClose:S,onShowToast:i}){const[P,x]=l.useState(!1),[h,I]=l.useState(null),[w,v]=l.useState(null),[F,D]=l.useState(!1),[C,z]=l.useState(""),[r,m]=l.useState("folder"),[j,E]=l.useState("blue"),[k,N]=l.useState(""),b=()=>{z(""),m("folder"),E("blue"),N(""),I(null)},y=()=>{b(),x(!0)},B=a=>{z(a.name),m(a.icon||"folder"),E(a.color||"blue"),N(a.description||""),I(a),x(!0)},A=async a=>{if(a.preventDefault(),!C.trim()){i?.("Please enter a folder name","error");return}D(!0);try{if(h)await g.updateFolder(h.id,{name:C.trim(),icon:r,color:j,description:k.trim()||null}),i?.("Folder updated","success");else{const _=Math.max(0,...t.map(M=>M.sort_order||0));await g.createFolder(u,n,{name:C.trim(),icon:r,color:j,description:k.trim()||null,sort_order:_+1}),i?.("Folder created","success")}x(!1),b(),d?.()}catch(_){console.error("Error saving folder:",_),_.message?.includes("duplicate key")||_.code==="23505"?i?.("A folder with this name already exists","error"):i?.("Failed to save folder","error")}finally{D(!1)}},U=async a=>{if(confirm(`Delete "${a.name}"? Documents in this folder will be moved to Unfiled.`)){v(a.id);try{await g.deleteFolder(a.id),i?.("Folder deleted","success"),d?.()}catch(_){console.error("Error deleting folder:",_),i?.("Failed to delete folder","error")}finally{v(null)}}},o=ae.find(a=>a.id===r),G=le.find(a=>a.id===j);return e.jsxs("div",{className:"folder-manager",children:[e.jsxs("div",{className:"folder-manager-header",children:[e.jsx("h3",{children:"Manage Folders"}),e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:y,children:[e.jsx(ie,{size:16}),"New Folder"]})]}),e.jsx("div",{className:"folder-manager-list",children:t.length===0?e.jsxs("div",{className:"folder-manager-empty",children:[e.jsx(L,{size:40}),e.jsx("p",{children:"No folders created yet"}),e.jsx("button",{className:"btn btn-secondary",onClick:y,children:"Create First Folder"})]}):t.map(a=>{const _=ae.find(O=>O.id===a.icon)?.icon||L,M=le.find(O=>O.id===a.color)?.hex||"#3b82f6";return e.jsxs("div",{className:"folder-manager-item",children:[e.jsx("div",{className:"folder-manager-item-drag",children:e.jsx(Ve,{size:16})}),e.jsx("div",{className:"folder-manager-item-icon",style:{backgroundColor:`${M}15`},children:e.jsx(_,{size:20,style:{color:M}})}),e.jsxs("div",{className:"folder-manager-item-info",children:[e.jsx("span",{className:"folder-manager-item-name",children:a.name}),e.jsxs("span",{className:"folder-manager-item-count",children:[a.document_count||0," documents"]})]}),e.jsxs("div",{className:"folder-manager-item-actions",children:[e.jsx("button",{className:"folder-action-btn",onClick:()=>B(a),title:"Edit folder",children:e.jsx(We,{size:16})}),e.jsx("button",{className:"folder-action-btn danger",onClick:()=>U(a),disabled:w===a.id,title:"Delete folder",children:w===a.id?e.jsx(R,{size:16,className:"spinner"}):e.jsx(qe,{size:16})})]})]},a.id)})}),P&&e.jsx("div",{className:"modal-overlay",onClick:()=>x(!1),children:e.jsxs("div",{className:"folder-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"folder-modal-header",children:[e.jsx("h3",{children:h?"Edit Folder":"Create Folder"}),e.jsx("button",{className:"modal-close",onClick:()=>x(!1),children:e.jsx(K,{size:20})})]}),e.jsxs("form",{onSubmit:A,children:[e.jsxs("div",{className:"folder-modal-content",children:[e.jsxs("div",{className:"folder-preview",children:[e.jsx("div",{className:"folder-preview-icon",style:{backgroundColor:`${G?.hex}15`},children:o&&e.jsx(o.icon,{size:40,style:{color:G?.hex}})}),e.jsx("span",{className:"folder-preview-name",children:C||"Folder Name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-name",children:"Folder Name *"}),e.jsx("input",{id:"folder-name",type:"text",value:C,onChange:a=>z(a.target.value),placeholder:"e.g., Site Plans, Safety Documents",autoFocus:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Icon"}),e.jsx("div",{className:"folder-icon-grid",children:ae.map(a=>e.jsx("button",{type:"button",className:`folder-icon-option ${r===a.id?"selected":""}`,onClick:()=>m(a.id),title:a.label,children:e.jsx(a.icon,{size:20})},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Color"}),e.jsx("div",{className:"folder-color-grid",children:le.map(a=>e.jsx("button",{type:"button",className:`folder-color-option ${j===a.id?"selected":""}`,onClick:()=>E(a.id),style:{backgroundColor:a.hex},title:a.label},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-desc",children:"Description (optional)"}),e.jsx("input",{id:"folder-desc",type:"text",value:k,onChange:a=>N(a.target.value),placeholder:"Brief description of folder contents"})]})]}),e.jsxs("div",{className:"folder-modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>x(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!C.trim()||F,children:F?e.jsxs(e.Fragment,{children:[e.jsx(R,{size:16,className:"spinner"}),"Saving..."]}):h?"Save Changes":"Create Folder"})]})]})]})})]})}const be=n=>n?.startsWith("image/")?Ee:n?.includes("spreadsheet")||n?.includes("excel")?Pe:n?.includes("pdf")?J:re,ge=n=>{if(!n)return"0 B";const u=["B","KB","MB","GB"];let t=n,d=0;for(;t>=1024&&d<u.length-1;)t/=1024,d++;return`${t.toFixed(t<10?1:0)} ${u[d]}`},ve=n=>n?new Date(n).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",Z={blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b",red:"#ef4444",purple:"#8b5cf6",pink:"#ec4899",gray:"#6b7280",orange:"#f97316"};function os({project:n,companyId:u,onShowToast:t,userRole:d}){const[S,i]=l.useState([]),[P,x]=l.useState(!0),[h,I]=l.useState(null),[w,v]=l.useState([]),[F,D]=l.useState(!1),[C,z]=l.useState(!1),[r,m]=l.useState(0),[j,E]=l.useState(0),[k,N]=l.useState(""),[b,y]=l.useState(null),[B,A]=l.useState(!1),[U,o]=l.useState(!1),[G,a]=l.useState(!1),[_,M]=l.useState(null),[O,s]=l.useState(null),$=d==="office"||d==="administrator",Q=d==="foreman",V=l.useCallback(async()=>{x(!0);try{const c=await g.getProjectFolders(n.id);i(c)}catch(c){console.error("Error loading folders:",c),t?.("Failed to load folders","error")}finally{x(!1)}},[n.id,t]);l.useEffect(()=>{V()},[V]);const W=async(c,f=!1)=>{f&&(m(0),D(!0));try{const p=f?0:r,H=await g.getFolderDocuments(c.id,{page:p,limit:Ye});v(f?H.documents:Y=>[...Y,...H.documents]),E(H.totalCount),z(H.hasMore)}catch(p){console.error("Error loading documents:",p),t?.("Failed to load documents","error")}finally{D(!1)}},$e=c=>{I(c),N(""),y(null),W(c,!0)},Re=()=>{I(null),v([]),y(null),N("")},ce=l.useCallback(async c=>{if(N(c),!c.trim()){y(null);return}A(!0);try{const f=await g.searchDocuments(n.id,c.trim());y(f)}catch(f){console.error("Error searching documents:",f)}finally{A(!1)}},[n.id]),de=()=>{o(!1),s(null),V(),h&&W(h,!0),t?.("Document uploaded successfully","success")},q=async(c,f)=>{try{switch(c){case"view":M(f);break;case"download":await g.logDocumentAccess(f.id,"downloaded"),window.open(f.url||`https://cegifnrcwdilromcyouq.supabase.co/storage/v1/object/public/project-documents/${f.storage_path}`,"_blank");break;case"archive":await g.archiveDocument(f.id),h&&W(h,!0),V(),t?.("Document archived","success");break;case"approve":await g.approveDocument(f.id),h&&W(h,!0),t?.("Document approved","success");break;default:break}}catch(p){console.error("Error performing action:",p),t?.("Action failed","error")}},ee=c=>{s(c),o(!0)};if(Q)return e.jsx(ss,{projectId:n.id,onShowToast:t});if(_)return e.jsx(Je,{document:_,onBack:()=>M(null),onUpdate:()=>{h&&W(h,!0),V()},onShowToast:t,isOfficeOrAdmin:$});if(P)return e.jsx("div",{className:"documents-tab",children:e.jsxs("div",{className:"documents-loading",children:[e.jsx(R,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading folders..."})]})});if(h){const c=Z[h.color]||Z.blue,f=b!==null?b:w;return e.jsxs("div",{className:"documents-tab",children:[e.jsxs("div",{className:"documents-folder-header",children:[e.jsxs("button",{className:"back-btn",onClick:Re,children:[e.jsx(oe,{size:20}),"Back"]}),e.jsxs("div",{className:"documents-folder-title",children:[e.jsx(L,{size:24,style:{color:c}}),e.jsx("h3",{children:h.name}),e.jsxs("span",{className:"documents-folder-count",children:[j," files"]})]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>ee(h),children:[e.jsx(ne,{size:18}),"Upload"]})]}),e.jsx("div",{className:"documents-search-bar",children:e.jsxs("div",{className:"documents-search",children:[e.jsx(ue,{size:18,className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Search in folder...",value:k,onChange:p=>ce(p.target.value),className:"documents-search-input"}),k&&e.jsx("button",{className:"search-clear",onClick:()=>{N(""),y(null)},children:e.jsx(K,{size:16})}),B&&e.jsx(R,{size:16,className:"search-spinner"})]})}),b!==null&&e.jsxs("div",{className:"documents-search-results",children:[e.jsxs("span",{children:[b.length," result",b.length!==1?"s":"",' for "',k,'"']}),e.jsx("button",{onClick:()=>{N(""),y(null)},children:"Clear search"})]}),e.jsx("div",{className:"documents-list",children:F?e.jsxs("div",{className:"documents-loading",children:[e.jsx(R,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading documents..."})]}):f.length===0?e.jsxs("div",{className:"documents-empty",children:[e.jsx(L,{size:48,style:{color:c,opacity:.3}}),e.jsx("h3",{children:"No documents"}),e.jsx("p",{children:b!==null?"No documents match your search.":"Upload your first document to this folder."}),b===null&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>ee(h),children:[e.jsx(ne,{size:18}),"Upload Document"]})]}):e.jsxs(e.Fragment,{children:[f.map(p=>{const H=be(p.mime_type),Y=p.approval_status==="pending";return e.jsxs("div",{className:`document-card ${Y?"pending":""}`,children:[e.jsx("div",{className:"document-icon",children:e.jsx(H,{size:24})}),e.jsxs("div",{className:"document-info",children:[e.jsxs("div",{className:"document-name",children:[p.name,p.version>1&&e.jsxs("span",{className:"document-version",children:["v",p.version]})]}),e.jsxs("div",{className:"document-meta",children:[e.jsx("span",{children:ge(p.file_size_bytes)}),e.jsx("span",{children:ve(p.uploaded_at)})]})]}),Y&&e.jsx("span",{className:"status-badge pending",children:"Pending"}),e.jsxs("div",{className:"document-actions",children:[e.jsx("button",{className:"document-action-btn",onClick:()=>q("view",p),title:"View details",children:e.jsx(te,{size:18})}),e.jsx("button",{className:"document-action-btn",onClick:()=>q("download",p),title:"Download",children:e.jsx(X,{size:18})}),Y&&e.jsx("button",{className:"document-action-btn approve",onClick:()=>q("approve",p),title:"Approve",children:e.jsx(ye,{size:18})}),e.jsx("button",{className:"document-action-btn danger",onClick:()=>q("archive",p),title:"Archive",children:e.jsx(Ne,{size:18})})]})]},p.id)}),C&&b===null&&e.jsx("div",{className:"documents-load-more",children:e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{m(p=>p+1),W(h,!1)},disabled:F,children:["Load More (",w.length," of ",j,")"]})})]})}),U&&e.jsx(pe,{projectId:n.id,companyId:u,folderId:O?.id,folderName:O?.name,onClose:()=>{o(!1),s(null)},onUploadComplete:de,onShowToast:t})]})}return e.jsxs("div",{className:"documents-tab",children:[e.jsxs("div",{className:"documents-header",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>a(!0),children:[e.jsx(He,{size:18}),"Manage Folders"]}),e.jsxs("div",{className:"documents-search",children:[e.jsx(ue,{size:18,className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Search all documents...",value:k,onChange:c=>ce(c.target.value),className:"documents-search-input"}),k&&e.jsx("button",{className:"search-clear",onClick:()=>{N(""),y(null)},children:e.jsx(K,{size:16})}),B&&e.jsx(R,{size:16,className:"search-spinner"})]})]}),b!==null?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"documents-search-results",children:[e.jsxs("span",{children:[b.length," result",b.length!==1?"s":"",' for "',k,'"']}),e.jsx("button",{onClick:()=>{N(""),y(null)},children:"Clear search"})]}),e.jsx("div",{className:"documents-list",children:b.map(c=>{const f=be(c.mime_type);return e.jsxs("div",{className:"document-card",children:[e.jsx("div",{className:"document-icon",children:e.jsx(f,{size:24})}),e.jsxs("div",{className:"document-info",children:[e.jsx("div",{className:"document-name",children:c.name}),e.jsxs("div",{className:"document-meta",children:[e.jsx("span",{children:ge(c.file_size_bytes)}),e.jsx("span",{children:ve(c.uploaded_at)})]})]}),e.jsxs("div",{className:"document-actions",children:[e.jsx("button",{className:"document-action-btn",onClick:()=>q("view",c),children:e.jsx(te,{size:18})}),e.jsx("button",{className:"document-action-btn",onClick:()=>q("download",c),children:e.jsx(X,{size:18})})]})]},c.id)})})]}):e.jsx("div",{className:"documents-folder-grid",children:S.length===0?e.jsxs("div",{className:"documents-empty",children:[e.jsx(Ke,{size:64}),e.jsx("h3",{children:"No folders yet"}),e.jsx("p",{children:"Create folders to organize your project documents."}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>a(!0),children:[e.jsx(ie,{size:18}),"Create Folder"]})]}):S.map(c=>{const f=Z[c.color]||Z.blue;return e.jsxs("button",{className:"documents-folder-card",onClick:()=>$e(c),children:[e.jsx("div",{className:"documents-folder-icon",style:{backgroundColor:`${f}15`},children:e.jsx(L,{size:32,style:{color:f}})}),e.jsxs("div",{className:"documents-folder-info",children:[e.jsx("span",{className:"documents-folder-name",children:c.name}),e.jsxs("span",{className:"documents-folder-meta",children:[c.document_count||0," ",c.document_count===1?"file":"files"]})]}),e.jsx("button",{className:"documents-folder-upload",onClick:p=>{p.stopPropagation(),ee(c)},title:"Upload to folder",children:e.jsx(ie,{size:20})})]},c.id)})}),G&&e.jsx("div",{className:"modal-overlay",onClick:()=>a(!1),children:e.jsxs("div",{className:"folder-manager-modal",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"folder-manager-modal-header",children:[e.jsx("h2",{children:"Folder Management"}),e.jsx("button",{className:"modal-close",onClick:()=>a(!1),children:e.jsx(K,{size:20})})]}),e.jsx(as,{projectId:n.id,companyId:u,folders:S,onFoldersChange:V,onClose:()=>a(!1),onShowToast:t})]})}),U&&e.jsx(pe,{projectId:n.id,companyId:u,folderId:O?.id,folderName:O?.name,onClose:()=>{o(!1),s(null)},onUploadComplete:de,onShowToast:t})]})}export{os as default};
//# sourceMappingURL=DocumentsTab-DsbCl1i5.js.map
