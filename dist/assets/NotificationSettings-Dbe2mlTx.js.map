{"version":3,"file":"NotificationSettings-Dbe2mlTx.js","sources":["../../src/components/NotificationSettings.jsx"],"sourcesContent":["import { useState, useEffect } from 'react'\nimport { MessageSquare, Package, AlertCircle, ClipboardList } from 'lucide-react'\nimport { db } from '../lib/supabase'\n\nconst NOTIFICATION_TYPES = [\n  { id: 'message', label: 'Messages', Icon: MessageSquare, description: 'Chat messages from field' },\n  { id: 'material_request', label: 'Material Requests', Icon: Package, description: 'Equipment and material requests' },\n  { id: 'injury_report', label: 'Safety Reports', Icon: AlertCircle, description: 'Injury and safety incident reports' },\n  { id: 'tm_ticket', label: 'T&M Tickets', Icon: ClipboardList, description: 'Time and materials tickets' }\n]\n\nexport default function NotificationSettings({ project, company, onShowToast, onClose }) {\n  const [users, setUsers] = useState([])\n  const [preferences, setPreferences] = useState({}) // { userId: { types: [], presetId: null } }\n  const [presets, setPresets] = useState([])\n  const [loading, setLoading] = useState(true)\n  const [saving, setSaving] = useState(false)\n\n  useEffect(() => {\n    loadData()\n  }, [project?.id, company?.id])\n\n  const loadData = async () => {\n    if (!project?.id || !company?.id) return\n\n    try {\n      setLoading(true)\n\n      // Load company users\n      const companyUsers = await db.getCompanyUsers(company.id)\n      setUsers(companyUsers)\n\n      // Load existing preferences for this project\n      const existingPrefs = await db.getProjectNotificationPreferences(project.id)\n      const prefsMap = {}\n      existingPrefs.forEach(pref => {\n        prefsMap[pref.user_id] = {\n          types: pref.notification_types || [],\n          presetId: null\n        }\n      })\n      setPreferences(prefsMap)\n\n      // Load notification presets\n      const companyPresets = await db.getNotificationPresets(company.id)\n      setPresets(companyPresets)\n\n    } catch (error) {\n      console.error('Error loading notification settings:', error)\n      onShowToast?.('Error loading notification settings', 'error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleToggleType = (userId, typeId) => {\n    setPreferences(prev => {\n      const userPrefs = prev[userId] || { types: [], presetId: null }\n      const types = userPrefs.types.includes(typeId)\n        ? userPrefs.types.filter(t => t !== typeId)\n        : [...userPrefs.types, typeId]\n\n      return {\n        ...prev,\n        [userId]: { types, presetId: null } // Clear preset when manually changing\n      }\n    })\n  }\n\n  const handleApplyPreset = (userId, presetId) => {\n    const preset = presets.find(p => p.id === presetId)\n    if (!preset) return\n\n    setPreferences(prev => ({\n      ...prev,\n      [userId]: {\n        types: [...preset.notification_types],\n        presetId\n      }\n    }))\n  }\n\n  const handleToggleAll = (userId, enable) => {\n    setPreferences(prev => ({\n      ...prev,\n      [userId]: {\n        types: enable ? NOTIFICATION_TYPES.map(t => t.id) : [],\n        presetId: null\n      }\n    }))\n  }\n\n  const handleSave = async () => {\n    try {\n      setSaving(true)\n\n      // Build the preferences array for bulk update\n      const userPreferences = Object.entries(preferences).map(([userId, pref]) => ({\n        userId,\n        notificationTypes: pref.types\n      }))\n\n      await db.setProjectNotificationPreferences(project.id, userPreferences)\n\n      onShowToast?.('Notification settings saved', 'success')\n      onClose?.()\n    } catch (error) {\n      console.error('Error saving notification settings:', error)\n      onShowToast?.('Error saving notification settings', 'error')\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"notification-settings\">\n        <div className=\"notification-settings-header\">\n          <h3>Notification Settings</h3>\n          <button className=\"close-btn\" onClick={onClose}>×</button>\n        </div>\n        <div className=\"loading-message\">Loading...</div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"notification-settings\">\n      <div className=\"notification-settings-header\">\n        <h3>Notification Settings for {project?.name}</h3>\n        <button className=\"close-btn\" onClick={onClose}>×</button>\n      </div>\n\n      <p className=\"settings-description\">\n        Choose who receives notifications when field workers send messages, request materials,\n        submit safety reports, or create T&M tickets for this project.\n      </p>\n\n      {users.length === 0 ? (\n        <div className=\"no-users-message\">\n          <p>No users found in this company.</p>\n          <small>Users need to be added to the company to receive notifications.</small>\n        </div>\n      ) : (\n        <div className=\"notification-users-list\">\n          {users.map(user => {\n            const userPrefs = preferences[user.id] || { types: [], presetId: null }\n            const allSelected = userPrefs.types.length === NOTIFICATION_TYPES.length\n            const someSelected = userPrefs.types.length > 0 && !allSelected\n\n            return (\n              <div key={user.id} className=\"notification-user-row\">\n                <div className=\"user-info\">\n                  <div className=\"user-avatar\">\n                    {user.name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase()}\n                  </div>\n                  <div className=\"user-details\">\n                    <span className=\"user-name\">{user.name || user.email}</span>\n                    {user.role && <span className=\"user-role\">{user.role}</span>}\n                  </div>\n                </div>\n\n                <div className=\"notification-controls\">\n                  {/* Preset dropdown */}\n                  <select\n                    className=\"preset-select\"\n                    value={userPrefs.presetId || ''}\n                    onChange={(e) => e.target.value && handleApplyPreset(user.id, e.target.value)}\n                  >\n                    <option value=\"\">Apply preset...</option>\n                    {presets.map(preset => (\n                      <option key={preset.id} value={preset.id}>{preset.name}</option>\n                    ))}\n                  </select>\n\n                  {/* Toggle all */}\n                  <button\n                    className={`toggle-all-btn ${allSelected ? 'all-on' : someSelected ? 'some-on' : ''}`}\n                    onClick={() => handleToggleAll(user.id, !allSelected)}\n                    title={allSelected ? 'Disable all' : 'Enable all'}\n                  >\n                    {allSelected ? 'All On' : someSelected ? 'Some' : 'None'}\n                  </button>\n                </div>\n\n                <div className=\"notification-types\">\n                  {NOTIFICATION_TYPES.map(type => (\n                    <label\n                      key={type.id}\n                      className={`notification-type-toggle ${userPrefs.types.includes(type.id) ? 'active' : ''}`}\n                      title={type.description}\n                    >\n                      <input\n                        type=\"checkbox\"\n                        checked={userPrefs.types.includes(type.id)}\n                        onChange={() => handleToggleType(user.id, type.id)}\n                      />\n                      <span className=\"type-icon\"><type.Icon size={16} /></span>\n                      <span className=\"type-label\">{type.label}</span>\n                    </label>\n                  ))}\n                </div>\n              </div>\n            )\n          })}\n        </div>\n      )}\n\n      <div className=\"notification-settings-footer\">\n        <button className=\"btn-secondary\" onClick={onClose}>Cancel</button>\n        <button\n          className=\"btn-primary\"\n          onClick={handleSave}\n          disabled={saving}\n        >\n          {saving ? 'Saving...' : 'Save Settings'}\n        </button>\n      </div>\n    </div>\n  )\n}\n"],"names":["NOTIFICATION_TYPES","MessageSquare","Package","AlertCircle","ClipboardList","NotificationSettings","project","company","onShowToast","onClose","users","setUsers","useState","preferences","setPreferences","presets","setPresets","loading","setLoading","saving","setSaving","useEffect","loadData","companyUsers","db","existingPrefs","prefsMap","pref","companyPresets","error","handleToggleType","userId","typeId","prev","userPrefs","types","t","handleApplyPreset","presetId","preset","p","handleToggleAll","enable","handleSave","userPreferences","jsxs","jsx","user","allSelected","someSelected","e","type"],"mappings":"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"}