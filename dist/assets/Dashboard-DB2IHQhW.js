const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/TMList-CHvAwVa1.js","assets/pdf-aQqpMATS.js","assets/index-CNYT6krf.js","assets/icons-Bl--ZLwb.js","assets/react-DXGY7bZi.js","assets/supabase-VuevzHjS.js","assets/index-Ct9GPi7W.css","assets/SignatureLinkGenerator-C9C8Ug_H.js","assets/corCalculations-vdJc_BOT.js","assets/CORLogPreview-CQATCuVD.js","assets/CORList-Cl9x5PGB.js","assets/CORLog-DPw3m66-.js","assets/BillingCenter-BaOmQ5LT.js","assets/DailyReportsList-C0qx4Xmf.js","assets/InjuryReportsList-MhRrBb7D.js","assets/ShareModal-BMuqLNaR.js","assets/NotificationSettings-GYY1yp8x.js","assets/CORForm-DvEstILx.js","assets/CORDetail-CAJsxIa4.js","assets/SignatureCanvas-pNbfu6sf.js","assets/DrawRequestModal-B7iaMbwC.js","assets/EquipmentModal-f295Uqh1.js","assets/AddCostModal-CoxgyMBT.js","assets/DocumentsTab-D5Orqzjo.js"])))=>i.map(i=>d[i]);
import{_ as X}from"./pdf-aQqpMATS.js";import{r as Pt,c as nn,a as rn,S as ln,b as cn,u as on,s as dn,d as un,e as mn,f as hn,g as pn,h as xn,i as jn,j as gn,k as Ft,l as fn,m as bt,n as vn,o as bn,p as $,q as e,R as Nn,B as yn,C as wn,X as Cn,Y as kn,T as Sn,t as Nt,v as Se,w as _n,x as yt,y as Q,z as Dn,A as Rn,D as En,E as Tn}from"./index-CNYT6krf.js";import{r as o,e as $t,X as ds,a4 as On,Y as Es,y as De,F as Ts,s as ue,N as ze,a2 as is,T as ls,a5 as Pn,a6 as Fn,a7 as _s,a8 as $n,c as us,K as Mt,a9 as Mn,m as An,b as wt,C as Ln,D as we,aa as At,O as Lt,H as qe,W as Ct,Q as Le,ab as zt,ac as zn,ad as qn,ae as In,l as Os,n as cs,p as Vn,q as Bn,R as Wn,af as Un,ag as Hn,z as Kn,ah as kt}from"./icons-Bl--ZLwb.js";import{f as ie}from"./corCalculations-vdJc_BOT.js";function os(){return os=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)({}).hasOwnProperty.call(r,a)&&(s[a]=r[a])}return s},os.apply(null,arguments)}function St(s,t){var r=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),r.push.apply(r,a)}return r}function Gn(s){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?St(Object(r),!0).forEach(function(a){Jn(s,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(r)):St(Object(r)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(r,a))})}return s}function Jn(s,t,r){return(t=Yn(t))in s?Object.defineProperty(s,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[t]=r,s}function Yn(s){var t=Qn(s,"string");return typeof t=="symbol"?t:t+""}function Qn(s,t){if(typeof s!="object"||!s)return s;var r=s[Symbol.toPrimitive];if(r!==void 0){var a=r.call(s,t);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(s)}var re=32,Zn={align:"center",iconSize:14,inactiveColor:"#ccc",layout:"horizontal",verticalAlign:"middle"};function Xn(s){var{data:t,iconType:r,inactiveColor:a}=s,n=re/2,l=re/6,i=re/3,d=t.inactive?a:t.color,h=r??t.type;if(h==="none")return null;if(h==="plainline"){var m;return o.createElement("line",{strokeWidth:4,fill:"none",stroke:d,strokeDasharray:(m=t.payload)===null||m===void 0?void 0:m.strokeDasharray,x1:0,y1:n,x2:re,y2:n,className:"recharts-legend-icon"})}if(h==="line")return o.createElement("path",{strokeWidth:4,fill:"none",stroke:d,d:"M0,".concat(n,"h").concat(i,`
            A`).concat(l,",").concat(l,",0,1,1,").concat(2*i,",").concat(n,`
            H`).concat(re,"M").concat(2*i,",").concat(n,`
            A`).concat(l,",").concat(l,",0,1,1,").concat(i,",").concat(n),className:"recharts-legend-icon"});if(h==="rect")return o.createElement("path",{stroke:"none",fill:d,d:"M0,".concat(re/8,"h").concat(re,"v").concat(re*3/4,"h").concat(-re,"z"),className:"recharts-legend-icon"});if(o.isValidElement(t.legendIcon)){var c=Gn({},t);return delete c.legendIcon,o.cloneElement(t.legendIcon,c)}return o.createElement(cn,{fill:d,cx:n,cy:n,size:re,sizeType:"diameter",type:h})}function er(s){var{payload:t,iconSize:r,layout:a,formatter:n,inactiveColor:l,iconType:i}=s,d={x:0,y:0,width:re,height:re},h={display:a==="horizontal"?"inline-block":"block",marginRight:10},m={display:"inline-block",verticalAlign:"middle",marginRight:4};return t.map((c,g)=>{var f=c.formatter||n,y=nn({"recharts-legend-item":!0,["legend-item-".concat(g)]:!0,inactive:c.inactive});if(c.type==="none")return null;var w=c.inactive?l:c.color,D=f?f(c.value,c,g):c.value;return o.createElement("li",os({className:y,style:h,key:"legend-item-".concat(g)},rn(s,c,g)),o.createElement(ln,{width:r,height:r,viewBox:d,style:m,"aria-label":"".concat(D," legend icon")},o.createElement(Xn,{data:c,iconType:i,inactiveColor:l})),o.createElement("span",{className:"recharts-legend-item-text",style:{color:w}},D))})}var sr=s=>{var t=Pt(s,Zn),{payload:r,layout:a,align:n}=t;if(!r||!r.length)return null;var l={padding:0,margin:0,textAlign:a==="horizontal"?n:"left"};return o.createElement("ul",{className:"recharts-default-legend",style:l},o.createElement(er,os({},t,{payload:r})))};function tr(){return on(dn)}var ar=["contextPayload"];function Ps(){return Ps=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)({}).hasOwnProperty.call(r,a)&&(s[a]=r[a])}return s},Ps.apply(null,arguments)}function _t(s,t){var r=Object.keys(s);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(s);t&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),r.push.apply(r,a)}return r}function Re(s){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?_t(Object(r),!0).forEach(function(a){nr(s,a,r[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(r)):_t(Object(r)).forEach(function(a){Object.defineProperty(s,a,Object.getOwnPropertyDescriptor(r,a))})}return s}function nr(s,t,r){return(t=rr(t))in s?Object.defineProperty(s,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[t]=r,s}function rr(s){var t=ir(s,"string");return typeof t=="symbol"?t:t+""}function ir(s,t){if(typeof s!="object"||!s)return s;var r=s[Symbol.toPrimitive];if(r!==void 0){var a=r.call(s,t);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(s)}function lr(s,t){if(s==null)return{};var r,a,n=cr(s,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(s);for(a=0;a<l.length;a++)r=l[a],t.indexOf(r)===-1&&{}.propertyIsEnumerable.call(s,r)&&(n[r]=s[r])}return n}function cr(s,t){if(s==null)return{};var r={};for(var a in s)if({}.hasOwnProperty.call(s,a)){if(t.indexOf(a)!==-1)continue;r[a]=s[a]}return r}function or(s){return s.value}function dr(s){var{contextPayload:t}=s,r=lr(s,ar),a=vn(t,s.payloadUniqBy,or),n=Re(Re({},r),{},{payload:a});return o.isValidElement(s.content)?o.cloneElement(s.content,n):typeof s.content=="function"?o.createElement(s.content,n):o.createElement(sr,n)}function ur(s,t,r,a,n,l){var{layout:i,align:d,verticalAlign:h}=t,m,c;return(!s||(s.left===void 0||s.left===null)&&(s.right===void 0||s.right===null))&&(d==="center"&&i==="vertical"?m={left:((a||0)-l.width)/2}:m=d==="right"?{right:r&&r.right||0}:{left:r&&r.left||0}),(!s||(s.top===void 0||s.top===null)&&(s.bottom===void 0||s.bottom===null))&&(h==="middle"?c={top:((n||0)-l.height)/2}:c=h==="bottom"?{bottom:r&&r.bottom||0}:{top:r&&r.top||0}),Re(Re({},m),c)}function mr(s){var t=Ft();return o.useEffect(()=>{t(fn(s))},[t,s]),null}function hr(s){var t=Ft();return o.useEffect(()=>(t(bt(s)),()=>{t(bt({width:0,height:0}))}),[t,s]),null}function pr(s,t,r,a){return s==="vertical"&&gn(t)?{height:t}:s==="horizontal"?{width:r||a}:null}var xr={align:"center",iconSize:14,itemSorter:"value",layout:"horizontal",verticalAlign:"bottom"};function qt(s){var t=Pt(s,xr),r=tr(),a=un(),n=mn(),{width:l,height:i,wrapperStyle:d,portal:h}=t,[m,c]=hn([r]),g=pn(),f=xn();if(g==null||f==null)return null;var y=g-(n?.left||0)-(n?.right||0),w=pr(t.layout,i,l,y),D=h?d:Re(Re({position:"absolute",width:w?.width||l||"auto",height:w?.height||i||"auto"},ur(d,t,n,g,f,m)),d),q=h??a;if(q==null||r==null)return null;var I=o.createElement("div",{className:"recharts-legend-wrapper",style:D,ref:c},o.createElement(mr,{layout:t.layout,align:t.align,verticalAlign:t.verticalAlign,itemSorter:t.itemSorter}),!h&&o.createElement(hr,{width:m.width,height:m.height}),o.createElement(dr,Ps({},t,w,{margin:n,chartWidth:g,chartHeight:f,contextPayload:r})));return jn.createPortal(I,q)}qt.displayName="Legend";const Dt={WARNING:"warning",ERROR:"error"},le={DATABASE:"database",NETWORK:"network",AUTH:"auth",VALIDATION:"validation",STORAGE:"storage",SYNC:"sync",GENERAL:"general"};function jr(s){const t=s?.message?.toLowerCase()||"",r=s?.code?.toLowerCase()||"";return t.includes("fetch")||t.includes("network")||t.includes("offline")?le.NETWORK:t.includes("auth")||t.includes("unauthorized")||r.includes("auth")?le.AUTH:t.includes("storage")||t.includes("bucket")||t.includes("upload")?le.STORAGE:t.includes("validation")||t.includes("invalid")||t.includes("required")?le.VALIDATION:t.includes("sync")||t.includes("conflict")?le.SYNC:s?.code||t.includes("database")||t.includes("supabase")?le.DATABASE:le.GENERAL}function gr(s,t,r){return r?.userMessage?r.userMessage:t===le.NETWORK?"Network connection issue. Your changes will sync when back online.":t===le.AUTH?"Session expired. Please sign in again.":t===le.STORAGE?"Failed to upload file. Please try again.":t===le.VALIDATION?s?.message||"Please check your input and try again.":t===le.SYNC?"Sync conflict detected. Please refresh and try again.":r?.operation?`Failed to ${r.operation.replace(/([A-Z])/g," $1").toLowerCase().trim()}. Please try again.`:"Something went wrong. Please try again."}function fr(s,t={}){const{operation:r="unknown",category:a=jr(s),severity:n=Dt.ERROR,showToast:l,userMessage:i,companyId:d,projectId:h,userId:m,silent:c=!1,rethrow:g=!1}=t;if(bn.error(a,{message:s?.message||"Unknown error",code:s?.code,severity:n,operation:r,company_id:d,project_id:h,user_id:m,extra:{stack:s?.stack,name:s?.name}}),!c&&l){const f=gr(s,a,{operation:r,userMessage:i}),y=n===Dt.WARNING?"warning":"error";l(f,y)}if(g)throw s;return null}async function ne(s,t={}){const{fallback:r=null,context:a={},showToast:n,silent:l=!0}=t;try{return await s()}catch(i){return fr(i,{...a,showToast:n,silent:l}),r}}const Ee={budget:{healthy:.6,warning:.75,critical:.85},schedule:{healthy:.05,warning:.15,critical:.25},corExposure:{healthy:.05,warning:.15,critical:.25},activity:{healthy:1,warning:3,critical:5},safety:{healthy:0,warning:1,critical:2}},vr={budget:.3,schedule:.25,corExposure:.2,activity:.15,safety:.1};function Ie(s,t){if(s<=t.healthy)return 0;if(s>=t.critical)return 100;const r=t.critical-t.healthy;return(s-t.healthy)/r*100}function Ve(s){return s<=25?"healthy":s<=60?"warning":"critical"}function br(s,t,r=Ee.budget){if(!t||t<=0)return{score:0,status:"healthy",ratio:0,label:"No revenue yet"};const a=s/t,n=Ie(a,r),l=Ve(n);let i;return a<r.healthy?i=`Costs at ${(a*100).toFixed(0)}% of revenue`:a<r.warning?i=`Costs at ${(a*100).toFixed(0)}% - monitor closely`:i=`Costs at ${(a*100).toFixed(0)}% - review immediately`,{score:n,status:l,ratio:a,label:i}}function Nr(s,t,r=Ee.schedule){if(!t||t<=0)return{score:0,status:"healthy",variance:0,label:"No schedule baseline"};const a=(t-s)/t,n=Math.max(0,a),l=Ie(n,r),i=Ve(l);let d;return a<=0?d=s>=100?"Complete":"On or ahead of schedule":a<r.warning?d=`${(a*100).toFixed(0)}% behind schedule`:d=`${(a*100).toFixed(0)}% behind - needs attention`,{score:l,status:i,variance:a,label:d}}function yr(s,t,r=Ee.corExposure){if(!t||t<=0)return{score:0,status:"healthy",exposure:0,label:"No contract value"};const a=s/t,n=Ie(a,r),l=Ve(n);let i;return a<r.healthy?i=s>0?`$${Ds(s)} pending`:"No pending CORs":a<r.warning?i=`$${Ds(s)} pending (${(a*100).toFixed(0)}% of contract)`:i=`High exposure: $${Ds(s)} (${(a*100).toFixed(0)}%)`,{score:n,status:l,exposure:a,label:i}}function wr(s,t=Ee.activity){if(!s)return{score:100,status:"critical",daysSince:null,label:"No reports filed"};const r=new Date(s),n=Math.floor((new Date-r)/(1e3*60*60*24)),l=Ie(n,t),i=Ve(l);let d;return n===0?d="Report filed today":n===1?d="Report filed yesterday":n<=t.warning?d=`Last report ${n} days ago`:d=`No report in ${n} days - may be stalled`,{score:l,status:i,daysSince:n,label:d}}function Cr(s,t=Ee.safety){const r=s||0,a=Ie(r,t),n=Ve(a);let l;return r===0?l="No incidents":r===1?l="1 incident in last 30 days":l=`${r} incidents - safety review needed`,{score:a,status:n,count:r,label:l}}function kr(s,t={}){const r={...Ee,...t.thresholds},a={...vr,...t.weights},n=br(s.totalCosts,s.earnedRevenue,r.budget),l=Nr(s.actualProgress,s.expectedProgress,r.schedule),i=yr(s.pendingCORValue,s.contractValue,r.corExposure),d=wr(s.lastReportDate,r.activity),h=Cr(s.recentInjuryCount,r.safety),m=Math.round(n.score*a.budget+l.score*a.schedule+i.score*a.corExposure+d.score*a.activity+h.score*a.safety);let c;m<=25?c="healthy":m<=60?c="warning":c="critical";let g;return c==="healthy"?g="Project is on track":c==="warning"?g="Some factors need attention":g="Immediate review recommended",{score:m,status:c,label:g,factors:{budget:{...n,weight:a.budget},schedule:{...l,weight:a.schedule},corExposure:{...i,weight:a.corExposure},activity:{...d,weight:a.activity},safety:{...h,weight:a.safety}}}}function Sr(s,t){const r=[],{factors:a}=s;a.budget.status==="critical"&&r.push({type:"critical",title:"Budget Alert",description:a.budget.label,action:"Review costs immediately",actionTarget:"financials",projectId:t.id}),a.activity.status==="critical"&&r.push({type:"critical",title:"Activity Alert",description:a.activity.label,action:"Check project status",actionTarget:"overview",projectId:t.id}),a.safety.status==="critical"&&r.push({type:"critical",title:"Safety Alert",description:a.safety.label,action:"Review safety reports",actionTarget:"reports",projectId:t.id}),a.budget.status==="warning"&&r.push({type:"warning",title:"Budget Watch",description:a.budget.label,action:"Monitor costs",actionTarget:"financials",projectId:t.id}),(a.schedule.status==="critical"||a.schedule.status==="warning")&&r.push({type:a.schedule.status==="critical"?"critical":"warning",title:"Schedule Alert",description:a.schedule.label,action:"Review progress",actionTarget:"overview",projectId:t.id}),(a.corExposure.status==="warning"||a.corExposure.status==="critical")&&r.push({type:a.corExposure.status==="critical"?"critical":"warning",title:"COR Exposure",description:a.corExposure.label,action:"Review pending CORs",actionTarget:"cors",projectId:t.id}),a.activity.status==="warning"&&r.push({type:"info",title:"Activity Notice",description:a.activity.label,action:"File daily report",actionTarget:"reports",projectId:t.id});const n={critical:0,warning:1,info:2};return r.sort((l,i)=>n[l.type]-n[i.type]),r}function _r(s){const{actualProgress:t,totalCosts:r,earnedRevenue:a,contractValue:n}=s;if(!t||t<=0)return{estimatedCompletionCost:null,estimatedFinalMargin:null,estimatedCompletionDate:null};const l=r/t,i=Math.round(l*100),d=n>0?(n-i)/n*100:0;let h=null;if(s.startDate&&t>0&&t<100){const m=new Date(s.startDate),c=new Date,g=Math.max(1,(c-m)/(1e3*60*60*24)),f=t/g,w=(100-t)/f;h=new Date(c.getTime()+w*24*60*60*1e3)}return{estimatedCompletionCost:i,estimatedFinalMargin:d,estimatedCompletionDate:h,costPerPercent:l}}function Ds(s){return s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(0)+"K":s.toFixed(0)}const ms=()=>X(()=>import("./pdf-aQqpMATS.js").then(s=>s.j),[]),K=210,E=14,he=K-E*2,_e=s=>s?new Date(s+(s.includes("T")?"":"T12:00:00")).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):"—",pe=(s,t,r=30)=>t+r>s.internal.pageSize.height-20?(s.addPage(),20):t;async function Dr(s,t){const a=(await ms()).default,n=new a;let l=20;n.setFontSize(18),n.setFont(void 0,"bold"),n.text("Daily Reports",K/2,l,{align:"center"}),l+=8,n.setFontSize(11),n.setFont(void 0,"normal"),n.text(`Project: ${t.name}`,K/2,l,{align:"center"}),l+=6,n.text(`${s.length} report${s.length!==1?"s":""}`,K/2,l,{align:"center"}),l+=12,s.forEach((d,h)=>{l=pe(n,l,60),n.setDrawColor(200,200,200),n.setFillColor(245,247,250),n.roundedRect(E,l-2,he,10,2,2,"F"),n.setFontSize(11),n.setFont(void 0,"bold"),n.setTextColor(30,30,30),n.text(`${_e(d.report_date)}`,E+4,l+5);const m=d.status==="submitted"?"Submitted":"Draft";n.setFontSize(9),n.setFont(void 0,"normal"),n.text(m,K-E-4,l+5,{align:"right"}),l+=14,n.setTextColor(0,0,0),n.setFontSize(9);const c=[`Crew: ${d.crew_count||0}`,`Tasks: ${d.tasks_completed||0}/${d.tasks_total||0}`,`T&M Tickets: ${d.tm_tickets_count||0}`,`Photos: ${d.photos_count||0}`];if(n.text(c.join("    |    "),E+4,l),l+=7,d.crew_list?.length>0){n.setFont(void 0,"bold"),n.text("Crew:",E+4,l),n.setFont(void 0,"normal");const g=d.crew_list.map(y=>`${y.name} (${y.role||"Laborer"})`).join(", "),f=n.splitTextToSize(g,he-8);l+=4,n.text(f,E+4,l),l+=f.length*4+2}if(d.field_notes){l=pe(n,l,15),n.setFont(void 0,"bold"),n.text("Field Notes:",E+4,l),n.setFont(void 0,"normal"),l+=4;const g=n.splitTextToSize(d.field_notes,he-8);n.text(g,E+4,l),l+=g.length*4+2}if(d.issues){l=pe(n,l,15),n.setFont(void 0,"bold"),n.text("Issues:",E+4,l),n.setFont(void 0,"normal"),l+=4;const g=n.splitTextToSize(d.issues,he-8);n.text(g,E+4,l),l+=g.length*4+2}l+=8,h<s.length-1&&(n.setDrawColor(220,220,220),n.line(E,l,K-E,l),l+=6)});const i=`${t.name}_Daily_Reports_${new Date().toISOString().split("T")[0]}.pdf`;n.save(i)}async function Rr(s,t){const a=(await ms()).default,n=new a;let l=20;n.setFontSize(18),n.setFont(void 0,"bold"),n.text("Incident / Injury Reports",K/2,l,{align:"center"}),l+=8,n.setFontSize(11),n.setFont(void 0,"normal"),n.text(`Project: ${t.name}`,K/2,l,{align:"center"}),l+=6,n.text(`${s.length} report${s.length!==1?"s":""}`,K/2,l,{align:"center"}),l+=12,s.forEach((d,h)=>{l=pe(n,l,50);const c={minor:[34,197,94],serious:[245,158,11],critical:[239,68,68],near_miss:[59,130,246]}[d.injury_type]||[128,128,128];n.setFillColor(...c),n.roundedRect(E,l-2,3,14,1,1,"F"),n.setFontSize(11),n.setFont(void 0,"bold"),n.setTextColor(30,30,30),n.text(`${_e(d.incident_date)}`,E+8,l+4),n.setFontSize(9);const g=(d.injury_type||"").replace("_"," ").toUpperCase();if(n.text(g,E+8,l+10),n.setFont(void 0,"normal"),n.text(d.status==="open"?"OPEN":"CLOSED",K-E-4,l+4,{align:"right"}),l+=16,n.setTextColor(0,0,0),d.description){n.setFontSize(9),n.setFont(void 0,"bold"),n.text("Description:",E+4,l),n.setFont(void 0,"normal"),l+=4;const f=n.splitTextToSize(d.description,he-8);n.text(f,E+4,l),l+=f.length*4+2}d.location&&(n.setFont(void 0,"bold"),n.text("Location: ",E+4,l),n.setFont(void 0,"normal"),n.text(d.location,E+30,l),l+=6),l+=6,h<s.length-1&&(n.setDrawColor(220,220,220),n.line(E,l,K-E,l),l+=6)});const i=`${t.name}_Incident_Reports_${new Date().toISOString().split("T")[0]}.pdf`;n.save(i)}async function Er(s,t){const a=(await ms()).default,n=new a;let l=20;n.setFontSize(18),n.setFont(void 0,"bold"),n.text("Crew Check-In History",K/2,l,{align:"center"}),l+=8,n.setFontSize(11),n.setFont(void 0,"normal"),n.text(`Project: ${t.name}`,K/2,l,{align:"center"}),l+=6,n.text(`${s.length} check-in${s.length!==1?"s":""}`,K/2,l,{align:"center"}),l+=12,s.forEach((d,h)=>{l=pe(n,l,30);const m=d.workers||[];n.setFillColor(245,247,250),n.roundedRect(E,l-2,he,9,2,2,"F"),n.setFontSize(10),n.setFont(void 0,"bold"),n.setTextColor(30,30,30),n.text(_e(d.check_in_date),E+4,l+4),n.setFont(void 0,"normal"),n.text(`${m.length} workers`,K-E-4,l+4,{align:"right"}),l+=12,n.setTextColor(0,0,0),n.setFontSize(9),m.length>0&&(n.setFont(void 0,"bold"),n.text("Name",E+4,l),n.text("Role",110,l),l+=5,n.setFont(void 0,"normal"),m.forEach(c=>{l=pe(n,l,6),n.text(c.name||"—",E+4,l),n.text(c.role||"Laborer",110,l),l+=4.5})),l+=6,h<s.length-1&&(n.setDrawColor(220,220,220),n.line(E,l,K-E,l),l+=5)});const i=`${t.name}_Crew_Checkins_${new Date().toISOString().split("T")[0]}.pdf`;n.save(i)}async function Tr({dailyReports:s=[],incidentReports:t=[],crewCheckins:r=[],project:a}){const l=(await ms()).default,i=new l;let d=20;i.setFontSize(22),i.setFont(void 0,"bold"),i.text("Field Documents Report",K/2,d,{align:"center"}),d+=10,i.setFontSize(13),i.setFont(void 0,"normal"),i.text(`Project: ${a.name}`,K/2,d,{align:"center"}),d+=8,i.setFontSize(10),i.text(`Generated: ${new Date().toLocaleDateString()}`,K/2,d,{align:"center"}),d+=16,i.setFontSize(11),i.setFont(void 0,"bold"),i.text("Document Summary",E,d),d+=8,i.setFontSize(10),i.setFont(void 0,"normal"),[["Daily Reports",`${s.length}`],["Incident Reports",`${t.length}`],["Crew Check-Ins",`${r.length}`]].forEach(([c,g])=>{i.text(c,E+4,d),i.text(g,100,d),d+=6}),s.length>0&&(i.addPage(),d=20,i.setFontSize(16),i.setFont(void 0,"bold"),i.text("Daily Reports",E,d),d+=10,s.forEach((c,g)=>{if(d=pe(i,d,40),i.setFontSize(10),i.setFont(void 0,"bold"),i.setTextColor(30,30,30),i.text(_e(c.report_date),E+2,d),i.setFont(void 0,"normal"),i.setFontSize(8),i.text(`Crew: ${c.crew_count||0} | Tasks: ${c.tasks_completed||0}/${c.tasks_total||0} | T&M: ${c.tm_tickets_count||0}`,E+60,d),d+=6,i.setTextColor(0,0,0),i.setFontSize(9),c.field_notes){const f=i.splitTextToSize(c.field_notes,he-4);i.text(f,E+2,d),d+=f.length*4+2}if(c.issues){i.setFont(void 0,"bold"),i.text("Issues: ",E+2,d),i.setFont(void 0,"normal");const f=i.splitTextToSize(c.issues,he-20);i.text(f,E+20,d),d+=f.length*4+2}d+=4,g<s.length-1&&(i.setDrawColor(220,220,220),i.line(E,d,K-E,d),d+=4)})),t.length>0&&(i.addPage(),d=20,i.setFontSize(16),i.setFont(void 0,"bold"),i.text("Incident / Injury Reports",E,d),d+=10,t.forEach((c,g)=>{d=pe(i,d,35),i.setFontSize(10),i.setFont(void 0,"bold"),i.setTextColor(30,30,30),i.text(_e(c.incident_date),E+2,d),i.setFontSize(8),i.setFont(void 0,"normal");const f=(c.injury_type||"").replace("_"," ").toUpperCase();if(i.text(`${f} — ${c.status?.toUpperCase()||""}`,E+60,d),d+=6,i.setTextColor(0,0,0),i.setFontSize(9),c.description){const y=i.splitTextToSize(c.description,he-4);i.text(y,E+2,d),d+=y.length*4+2}c.location&&(i.text(`Location: ${c.location}`,E+2,d),d+=5),d+=4,g<t.length-1&&(i.setDrawColor(220,220,220),i.line(E,d,K-E,d),d+=4)})),r.length>0&&(i.addPage(),d=20,i.setFontSize(16),i.setFont(void 0,"bold"),i.text("Crew Check-In History",E,d),d+=10,r.forEach((c,g)=>{d=pe(i,d,20);const f=c.workers||[];if(i.setFontSize(10),i.setFont(void 0,"bold"),i.setTextColor(30,30,30),i.text(_e(c.check_in_date),E+2,d),i.setFont(void 0,"normal"),i.setFontSize(8),i.text(`${f.length} workers`,E+60,d),d+=6,i.setTextColor(0,0,0),i.setFontSize(8),f.length>0){const y=f.map(D=>`${D.name} (${D.role||"Laborer"})`).join(", "),w=i.splitTextToSize(y,he-4);i.text(w,E+2,d),d+=w.length*3.5+3}g<r.length-1&&(i.setDrawColor(230,230,230),i.line(E,d,K-E,d),d+=3)}));const m=`${a.name}_Field_Documents_${new Date().toISOString().split("T")[0]}.pdf`;i.save(m)}function hs(s,t,r="text/csv"){const a=new Blob([s],{type:r}),n=URL.createObjectURL(a),l=document.createElement("a");l.href=n,l.download=t,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n)}function Rt(s){if(s==null)return"";const t=String(s);return t.includes(",")||t.includes('"')||t.includes(`
`)?`"${t.replace(/"/g,'""')}"`:t}function Fs(s,t){const r=s.map(n=>Rt(n.label)).join(","),a=t.map(n=>s.map(l=>Rt(n[l.key])).join(","));return[r,...a].join(`
`)}function Or(s,t){const r=[{key:"category",label:"Category"},{key:"description",label:"Description"},{key:"amount",label:"Amount"},{key:"date",label:"Date"},{key:"type",label:"Type"}],a=[];a.push({category:"Revenue",description:"Original Contract Value",amount:s.contract_value||0,date:s.start_date||"",type:"Contract"}),t?.earnedRevenue&&a.push({category:"Revenue",description:"Earned Revenue (Progress)",amount:t.earnedRevenue,date:new Date().toISOString().split("T")[0],type:"Earned"}),t?.approvedCORs&&t.approvedCORs.forEach(h=>{a.push({category:"Revenue",description:`COR: ${h.cor_number} - ${h.title}`,amount:(h.cor_total||0)/100,date:h.approved_at?.split("T")[0]||"",type:"Change Order"})}),t?.laborByDate&&t.laborByDate.forEach(h=>{a.push({category:"Cost",description:"Labor",amount:h.cost,date:h.date,type:"Labor"})}),t?.haulOffByDate&&t.haulOffByDate.forEach(h=>{a.push({category:"Cost",description:"Disposal/Haul-off",amount:h.cost,date:h.date,type:"Disposal"})}),t?.customCosts&&t.customCosts.forEach(h=>{a.push({category:"Cost",description:h.description||h.category||"Other",amount:parseFloat(h.amount)||0,date:h.cost_date||"",type:h.category||"Other"})});const n=a.filter(h=>h.category==="Revenue").reduce((h,m)=>h+(parseFloat(m.amount)||0),0),l=a.filter(h=>h.category==="Cost").reduce((h,m)=>h+(parseFloat(m.amount)||0),0);a.push({category:"",description:"",amount:"",date:"",type:""}),a.push({category:"Summary",description:"Total Revenue",amount:n,date:"",type:""}),a.push({category:"Summary",description:"Total Costs",amount:l,date:"",type:""}),a.push({category:"Summary",description:"Gross Profit",amount:n-l,date:"",type:""}),a.push({category:"Summary",description:"Margin %",amount:n>0?((n-l)/n*100).toFixed(1)+"%":"N/A",date:"",type:""});const i=Fs(r,a),d=`${s.name.replace(/[^a-zA-Z0-9]/g,"_")}_Financials_${new Date().toISOString().split("T")[0]}.csv`;hs(i,d)}function ii(s,t){const r=[],a=[{key:"section",label:"Section"},{key:"description",label:"Description"},{key:"quantity",label:"Quantity"},{key:"unit",label:"Unit"},{key:"rate",label:"Rate"},{key:"total",label:"Total"}];r.push({section:"COR Info",description:`${s.cor_number} - ${s.title}`,quantity:"",unit:"",rate:"",total:""}),r.push({section:"Status",description:s.status,quantity:"",unit:"",rate:"",total:""}),r.push({section:"Period",description:`${s.period_start||""} to ${s.period_end||""}`,quantity:"",unit:"",rate:"",total:""}),r.push({section:"",description:"",quantity:"",unit:"",rate:"",total:""}),s.change_order_labor?.length>0&&(r.push({section:"LABOR",description:"",quantity:"",unit:"",rate:"",total:""}),s.change_order_labor.forEach(i=>{const d=parseFloat(i.regular_hours)||0,h=parseFloat(i.overtime_hours)||0;r.push({section:"",description:i.description||i.classification,quantity:d+h,unit:"hours",rate:(parseInt(i.regular_rate)||0)/100,total:(parseInt(i.total)||0)/100})})),s.change_order_materials?.length>0&&(r.push({section:"MATERIALS",description:"",quantity:"",unit:"",rate:"",total:""}),s.change_order_materials.forEach(i=>{r.push({section:"",description:i.description,quantity:parseFloat(i.quantity)||0,unit:i.unit||"each",rate:(parseInt(i.unit_cost)||0)/100,total:(parseInt(i.total)||0)/100})})),s.change_order_equipment?.length>0&&(r.push({section:"EQUIPMENT",description:"",quantity:"",unit:"",rate:"",total:""}),s.change_order_equipment.forEach(i=>{r.push({section:"",description:i.description,quantity:parseFloat(i.quantity)||0,unit:i.unit||"day",rate:(parseInt(i.unit_cost)||0)/100,total:(parseInt(i.total)||0)/100})})),s.change_order_subcontractors?.length>0&&(r.push({section:"SUBCONTRACTORS",description:"",quantity:"",unit:"",rate:"",total:""}),s.change_order_subcontractors.forEach(i=>{r.push({section:"",description:i.description,quantity:parseFloat(i.quantity)||0,unit:i.unit||"lump sum",rate:(parseInt(i.unit_cost)||0)/100,total:(parseInt(i.total)||0)/100})}));const n=Fs(a,r),l=`COR_${s.cor_number||s.id}_${new Date().toISOString().split("T")[0]}.csv`;hs(n,l)}function li(s,t){const r=[{key:"date",label:"Date"},{key:"status",label:"Status"},{key:"workers",label:"Worker Count"},{key:"totalHours",label:"Total Hours"},{key:"otHours",label:"OT Hours"},{key:"materialsCost",label:"Materials Cost"},{key:"corNumber",label:"COR #"},{key:"notes",label:"Notes"}],a=s.map(i=>{const d=i.t_and_m_workers||[],h=i.t_and_m_items||[],m=d.reduce((f,y)=>f+(parseFloat(y.hours)||0),0),c=d.reduce((f,y)=>f+(parseFloat(y.overtime_hours)||0),0),g=h.reduce((f,y)=>f+(parseFloat(y.quantity)||0)*(y.materials_equipment?.cost_per_unit||0),0);return{date:i.work_date,status:i.status,workers:d.length,totalHours:(m+c).toFixed(1),otHours:c.toFixed(1),materialsCost:g.toFixed(2),corNumber:i.assigned_cor_id?"Linked":"",notes:i.notes||""}}),n=Fs(r,a),l=`${t.name.replace(/[^a-zA-Z0-9]/g,"_")}_TM_Tickets_${new Date().toISOString().split("T")[0]}.csv`;hs(n,l)}function Pr(s,t){const r=[],a=new Date().toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"});r.push("!TRNS	TRNSTYPE	DATE	ACCNT	NAME	AMOUNT	MEMO"),r.push("!SPL	TRNSTYPE	DATE	ACCNT	NAME	AMOUNT	MEMO"),r.push("!ENDTRNS");const n=s.contract_value||0;r.push(`TRNS	GENERAL JOURNAL	${a}	Accounts Receivable	${s.name}	${n.toFixed(2)}	FieldSync - Contract Revenue`),r.push(`SPL	GENERAL JOURNAL	${a}	Construction Revenue	${s.name}	${(-n).toFixed(2)}	Contract: ${s.name}`),r.push("ENDTRNS");const l=t?.totalLaborCost||0;l>0&&(r.push(`TRNS	GENERAL JOURNAL	${a}	Direct Labor	${s.name}	${l.toFixed(2)}	Labor costs - ${s.name}`),r.push(`SPL	GENERAL JOURNAL	${a}	Accounts Payable	${s.name}	${(-l).toFixed(2)}	Labor costs`),r.push("ENDTRNS"));const i=t?.totalDisposalCost||0;i>0&&(r.push(`TRNS	GENERAL JOURNAL	${a}	Disposal Expense	${s.name}	${i.toFixed(2)}	Disposal costs - ${s.name}`),r.push(`SPL	GENERAL JOURNAL	${a}	Accounts Payable	${s.name}	${(-i).toFixed(2)}	Disposal costs`),r.push("ENDTRNS"));const d=r.join(`
`),h=`${s.name.replace(/[^a-zA-Z0-9]/g,"_")}_QB_${new Date().toISOString().split("T")[0]}.iif`;hs(d,h,"application/x-iif")}function Fr({isOpen:s,onClose:t,companyId:r,onSelectProject:a,onSelectTicket:n,onSelectCOR:l,onShowToast:i}){const[d,h]=o.useState(""),[m,c]=o.useState({projects:[],tickets:[],cors:[],workers:[]}),[g,f]=o.useState(!1),[y,w]=o.useState(0),D=o.useRef(null),q=o.useRef(null),I=o.useRef(null);o.useEffect(()=>()=>{q.current&&clearTimeout(q.current),I.current&&clearTimeout(I.current)},[]),o.useEffect(()=>{s&&(h(""),c({projects:[],tickets:[],cors:[],workers:[]}),w(0),I.current=setTimeout(()=>D.current?.focus(),50))},[s]);const x=o.useCallback(async C=>{if(!C.trim()||C.length<2){c({projects:[],tickets:[],cors:[],workers:[]});return}f(!0);try{const A=await $.universalSearch(r,C.trim());c(A),w(0)}catch(A){console.error("Search error:",A),i?.("Search failed","error")}finally{f(!1)}},[r,i]),P=C=>{const A=C.target.value;h(A),q.current&&clearTimeout(q.current),q.current=setTimeout(()=>{x(A)},200)},G=(()=>{const C=[];return m.projects.forEach(A=>C.push({type:"project",data:A})),m.tickets.forEach(A=>C.push({type:"ticket",data:A})),m.cors.forEach(A=>C.push({type:"cor",data:A})),m.workers.forEach(A=>C.push({type:"worker",data:A})),C})(),ae=G.length>0,ce=C=>{C.key==="Escape"?t():C.key==="ArrowDown"?(C.preventDefault(),w(A=>Math.min(A+1,G.length-1))):C.key==="ArrowUp"?(C.preventDefault(),w(A=>Math.max(A-1,0))):C.key==="Enter"&&ae&&(C.preventDefault(),se(G[y]))},se=C=>{if(C){switch(C.type){case"project":a?.(C.data);break;case"ticket":n?.(C.data);break;case"cor":l?.(C.data);break;case"worker":C.data.lastProject&&a?.(C.data.lastProject);break}t()}};return s?e.jsx("div",{className:"universal-search-overlay",onClick:t,children:e.jsxs("div",{className:"universal-search-modal",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"universal-search-input-wrapper",children:[e.jsx($t,{size:20,className:"universal-search-icon"}),e.jsx("input",{ref:D,type:"text",value:d,onChange:P,onKeyDown:ce,placeholder:"Search projects, tickets, CORs, workers...",className:"universal-search-input",autoComplete:"off",autoCorrect:"off",spellCheck:"false"}),d&&e.jsx("button",{className:"universal-search-clear",onClick:()=>h(""),children:e.jsx(ds,{size:16})}),e.jsx("div",{className:"universal-search-shortcut",children:e.jsx("span",{children:"esc"})})]}),e.jsx("div",{className:"universal-search-results",children:g?e.jsxs("div",{className:"universal-search-loading",children:[e.jsx("div",{className:"spinner-small"}),e.jsx("span",{children:"Searching..."})]}):d.trim()?ae?e.jsxs(e.Fragment,{children:[m.projects.length>0&&e.jsxs("div",{className:"universal-search-section",children:[e.jsxs("div",{className:"universal-search-section-header",children:[e.jsx(Es,{size:14}),e.jsx("span",{children:"Projects"})]}),m.projects.map((C,A)=>{const V=A;return e.jsxs("button",{className:`universal-search-item ${y===V?"selected":""}`,onClick:()=>se({type:"project",data:C}),onMouseEnter:()=>w(V),children:[e.jsx(Es,{size:18}),e.jsxs("div",{className:"universal-search-item-content",children:[e.jsx("span",{className:"universal-search-item-title",children:C.name}),C.job_number&&e.jsxs("span",{className:"universal-search-item-meta",children:["#",C.job_number]})]}),e.jsx(De,{size:16,className:"universal-search-item-arrow"})]},C.id)})]}),m.tickets.length>0&&e.jsxs("div",{className:"universal-search-section",children:[e.jsxs("div",{className:"universal-search-section-header",children:[e.jsx(Ts,{size:14}),e.jsx("span",{children:"T&M Tickets"})]}),m.tickets.map((C,A)=>{const V=m.projects.length+A;return e.jsxs("button",{className:`universal-search-item ${y===V?"selected":""}`,onClick:()=>se({type:"ticket",data:C}),onMouseEnter:()=>w(V),children:[e.jsx(Ts,{size:18}),e.jsxs("div",{className:"universal-search-item-content",children:[e.jsxs("span",{className:"universal-search-item-title",children:[C.description?.substring(0,50)||"T&M Ticket",C.description?.length>50&&"..."]}),e.jsxs("span",{className:"universal-search-item-meta",children:[C.projectName," • ",C.work_date]})]}),e.jsx("span",{className:`universal-search-item-badge ${C.status}`,children:C.status})]},C.id)})]}),m.cors.length>0&&e.jsxs("div",{className:"universal-search-section",children:[e.jsxs("div",{className:"universal-search-section-header",children:[e.jsx(ue,{size:14}),e.jsx("span",{children:"Change Orders"})]}),m.cors.map((C,A)=>{const V=m.projects.length+m.tickets.length+A;return e.jsxs("button",{className:`universal-search-item ${y===V?"selected":""}`,onClick:()=>se({type:"cor",data:C}),onMouseEnter:()=>w(V),children:[e.jsx(ue,{size:18}),e.jsxs("div",{className:"universal-search-item-content",children:[e.jsxs("span",{className:"universal-search-item-title",children:[C.cor_number?`COR #${C.cor_number}: `:"",C.title]}),e.jsx("span",{className:"universal-search-item-meta",children:C.projectName})]}),e.jsx("span",{className:`universal-search-item-badge ${C.status}`,children:C.status})]},C.id)})]}),m.workers.length>0&&e.jsxs("div",{className:"universal-search-section",children:[e.jsxs("div",{className:"universal-search-section-header",children:[e.jsx(ze,{size:14}),e.jsx("span",{children:"Workers"})]}),m.workers.map((C,A)=>{const V=m.projects.length+m.tickets.length+m.cors.length+A;return e.jsxs("button",{className:`universal-search-item ${y===V?"selected":""}`,onClick:()=>se({type:"worker",data:C}),onMouseEnter:()=>w(V),children:[e.jsx(ze,{size:18}),e.jsxs("div",{className:"universal-search-item-content",children:[e.jsx("span",{className:"universal-search-item-title",children:C.name}),e.jsxs("span",{className:"universal-search-item-meta",children:[C.role," • ",C.projectName]})]}),e.jsx(De,{size:16,className:"universal-search-item-arrow"})]},`${C.name}-${A}`)})]})]}):e.jsx("div",{className:"universal-search-no-results",children:e.jsxs("span",{children:['No results for "',d,'"']})}):e.jsxs("div",{className:"universal-search-empty",children:[e.jsxs("div",{className:"universal-search-tip",children:[e.jsx(On,{size:14}),e.jsx("span",{children:"Type to search across all data"})]}),e.jsxs("div",{className:"universal-search-hints",children:[e.jsx("span",{children:"Projects"}),e.jsx("span",{children:"T&M Tickets"}),e.jsx("span",{children:"Change Orders"}),e.jsx("span",{children:"Workers"})]})]})}),e.jsxs("div",{className:"universal-search-footer",children:[e.jsxs("div",{className:"universal-search-footer-hint",children:[e.jsx("span",{className:"key",children:"↑↓"})," navigate"]}),e.jsxs("div",{className:"universal-search-footer-hint",children:[e.jsx("span",{className:"key",children:"↵"})," select"]}),e.jsxs("div",{className:"universal-search-footer-hint",children:[e.jsx("span",{className:"key",children:"esc"})," close"]})]})]})}):null}function $r(){const[s,t]=o.useState(!1);return o.useEffect(()=>{const r=a=>{(a.metaKey||a.ctrlKey)&&a.key==="k"&&(a.preventDefault(),t(n=>!n))};return document.addEventListener("keydown",r),()=>document.removeEventListener("keydown",r)},[]),{isOpen:s,setIsOpen:t,open:()=>t(!0),close:()=>t(!1)}}function Mr({alerts:s=[],onAction:t,onDismiss:r,maxVisible:a=3,className:n=""}){const[l,i]=o.useState(new Set),d=s.filter(m=>!l.has(m.id||`${m.projectId}-${m.type}-${m.title}`)).slice(0,a),h=o.useCallback(m=>{const c=m.id||`${m.projectId}-${m.type}-${m.title}`;i(g=>new Set([...g,c])),r?.(m)},[r]);return d.length===0?null:e.jsxs("div",{className:`smart-alerts ${n}`,role:"region","aria-label":"Project alerts","aria-live":"polite",children:[d.map((m,c)=>e.jsx(Ar,{alert:m,onAction:t,onDismiss:()=>h(m)},m.id||`${m.projectId}-${m.type}-${c}`)),s.length>a&&e.jsx("div",{className:"smart-alerts__overflow",children:e.jsxs("span",{className:"smart-alerts__overflow-text",children:["+",s.length-a," more alerts"]})})]})}function Ar({alert:s,onAction:t,onDismiss:r}){const{type:a="info",title:n,description:l,action:i,actionTarget:d,projectId:h,projectName:m}=s,g={critical:Pn,warning:ls,info:is}[a]||is,f=()=>{t?.({target:d,projectId:h,alert:s})};return e.jsxs("div",{className:`smart-alert smart-alert--${a}`,role:"alert","aria-live":a==="critical"?"assertive":"polite",children:[e.jsx(g,{className:"smart-alert__icon","aria-hidden":"true"}),e.jsxs("div",{className:"smart-alert__content",children:[e.jsxs("div",{className:"smart-alert__title",children:[m&&e.jsxs("span",{className:"smart-alert__project",children:[m,": "]}),n]}),l&&e.jsx("div",{className:"smart-alert__description",children:l}),i&&e.jsx("div",{className:"smart-alert__action",children:e.jsxs("button",{type:"button",className:"smart-alert__action-btn",onClick:f,children:[i,e.jsx(Fn,{size:14,"aria-hidden":"true"})]})})]}),r&&e.jsx("button",{type:"button",className:"smart-alert__dismiss",onClick:r,"aria-label":"Dismiss alert",children:e.jsx(ds,{size:18,"aria-hidden":"true"})})]})}const Lr=o.memo(function({progress:t=0,areasComplete:r=0,totalAreas:a=0,areasWorking:n=0,size:l=110,strokeWidth:i=9}){const[d,h]=o.useState(0),m=o.useRef(null);o.useEffect(()=>{const w=d,D=Math.min(100,Math.max(0,t)),q=800,I=performance.now(),x=P=>{const k=P-I,G=Math.min(k/q,1),ae=1-Math.pow(1-G,3),ce=w+(D-w)*ae;h(ce),G<1&&(m.current=requestAnimationFrame(x))};return m.current=requestAnimationFrame(x),()=>{m.current&&cancelAnimationFrame(m.current)}},[t]);const c=(l-i)/2,g=c*2*Math.PI,f=g-d/100*g,y=()=>d>=80?"var(--accent-green)":d>=50||d>=25?"var(--accent-blue)":"var(--text-muted)";return e.jsxs("div",{className:"overview-progress-gauge",children:[e.jsxs("div",{className:"progress-gauge-circle",style:{width:l,height:l},children:[e.jsxs("svg",{width:l,height:l,viewBox:`0 0 ${l} ${l}`,children:[e.jsx("circle",{className:"gauge-track",cx:l/2,cy:l/2,r:c,fill:"none",strokeWidth:i,stroke:"var(--bg-tertiary)"}),e.jsx("circle",{className:"gauge-fill",cx:l/2,cy:l/2,r:c,fill:"none",stroke:y(),strokeWidth:i,strokeDasharray:g,strokeDashoffset:f,strokeLinecap:"round",transform:`rotate(-90 ${l/2} ${l/2})`,style:{transition:"stroke 0.3s ease"}})]}),e.jsxs("div",{className:"gauge-center",children:[e.jsxs("span",{className:"gauge-value",children:[Math.round(d),"%"]}),e.jsx("span",{className:"gauge-label",children:"Complete"})]})]}),e.jsxs("div",{className:"gauge-areas-status",children:[e.jsxs("span",{className:"areas-count",children:[e.jsx("strong",{children:r}),"/",a," Areas Done"]}),n>0&&e.jsxs("span",{className:"areas-active",children:[n," active"]})]})]})}),W=o.memo(function({width:t,height:r,borderRadius:a="8px",className:n="",variant:l="default"}){const d=(()=>{switch(l){case"text":return{height:"1em",borderRadius:"4px"};case"circular":return{borderRadius:"50%"};case"rectangular":return{borderRadius:"0"};default:return{borderRadius:a}}})();return e.jsx("div",{className:`skeleton ${n}`,style:{width:t||"100%",height:r||d.height||"1rem",borderRadius:d.borderRadius},"aria-hidden":"true"})});o.memo(function({showProgress:t=!1}){return e.jsxs("div",{className:"metric-skeleton",children:[e.jsx(W,{width:"60%",height:"0.75rem",className:"skeleton-label"}),e.jsx(W,{width:"80%",height:"1.75rem",className:"skeleton-value"}),t&&e.jsx(W,{width:"100%",height:"6px",className:"skeleton-progress"})]})});const ci=o.memo(function({lines:t=3,showHeader:r=!0,showAction:a=!1}){return e.jsxs("div",{className:"card-skeleton","aria-busy":"true","aria-label":"Loading content",children:[r&&e.jsxs("div",{className:"card-skeleton-header",children:[e.jsx(W,{width:"40%",height:"1.25rem"}),a&&e.jsx(W,{width:"80px",height:"32px"})]}),e.jsx("div",{className:"card-skeleton-body",children:Array.from({length:t}).map((n,l)=>e.jsx(W,{width:`${100-l*15}%`,height:"1rem",className:"skeleton-line"},l))})]})});o.memo(function({count:t=3,showAvatar:r=!1,showAction:a=!1}){return e.jsx("div",{className:"list-skeleton","aria-busy":"true","aria-label":"Loading list",children:Array.from({length:t}).map((n,l)=>e.jsxs("div",{className:"list-item-skeleton",children:[r&&e.jsx(W,{width:"40px",height:"40px",variant:"circular"}),e.jsxs("div",{className:"list-item-skeleton-content",children:[e.jsx(W,{width:"60%",height:"1rem"}),e.jsx(W,{width:"40%",height:"0.75rem"})]}),a&&e.jsx(W,{width:"60px",height:"28px"})]},l))})});o.memo(function(){return e.jsx("div",{className:"financial-row-skeleton","aria-busy":"true","aria-label":"Loading financial data",children:[1,2,3].map(t=>e.jsxs("div",{className:"financial-card-skeleton",children:[e.jsxs("div",{className:"financial-card-skeleton-header",children:[e.jsx(W,{width:"24px",height:"24px",variant:"circular"}),e.jsx(W,{width:"60%",height:"1rem"})]}),e.jsx(W,{width:"50%",height:"2rem",className:"skeleton-hero-value"}),e.jsxs("div",{className:"financial-card-skeleton-details",children:[e.jsx(W,{width:"100%",height:"0.875rem"}),e.jsx(W,{width:"80%",height:"0.875rem"})]})]},t))})});o.memo(function({height:t="200px"}){return e.jsxs("div",{className:"chart-skeleton",style:{height:t},"aria-busy":"true","aria-label":"Loading chart",children:[e.jsx("div",{className:"chart-skeleton-bars",children:[40,65,45,80,55,70,50,75,60,85].map((r,a)=>e.jsx("div",{className:"chart-skeleton-bar",style:{height:`${r}%`}},a))}),e.jsx(W,{width:"100%",height:"1px",className:"chart-skeleton-axis"})]})});const ye=o.memo(function({count:t=3}){return e.jsx("div",{className:"ticket-skeleton-list","aria-busy":"true","aria-label":"Loading tickets",children:Array.from({length:t}).map((r,a)=>e.jsxs("div",{className:"ticket-skeleton-item",children:[e.jsxs("div",{className:"ticket-skeleton-header",children:[e.jsx(W,{width:"100px",height:"0.875rem"}),e.jsx(W,{width:"80px",height:"24px",borderRadius:"12px"})]}),e.jsx(W,{width:"90%",height:"1rem"}),e.jsxs("div",{className:"ticket-skeleton-footer",children:[e.jsx(W,{width:"60px",height:"0.75rem"}),e.jsx(W,{width:"60px",height:"0.75rem"}),e.jsx(W,{width:"60px",height:"0.75rem"})]})]},a))})}),zr=o.memo(function(){return e.jsx("div",{className:"hero-metrics-skeleton","aria-busy":"true","aria-label":"Loading metrics",children:[1,2,3,4].map(t=>e.jsxs("div",{className:"hero-metric-skeleton",children:[e.jsx(W,{width:"80px",height:"0.75rem",className:"skeleton-label"}),e.jsx(W,{width:"120px",height:"1.75rem",className:"skeleton-value"}),e.jsx(W,{width:"100%",height:"4px",className:"skeleton-bar"})]},t))})}),oi=o.memo(function({title:t="Unable to load data",message:r="Something went wrong. Please try again.",error:a=null,onRetry:n=null,retryLabel:l="Try Again",variant:i="default",icon:d=null}){const m=d||(a?.message?.includes("network")||a?.message?.includes("offline")?$n:ls);return i==="compact"?e.jsxs("div",{className:"error-state error-state-compact",role:"alert",children:[e.jsx(m,{size:16,className:"error-state-icon","aria-hidden":"true"}),e.jsx("span",{className:"error-state-message",children:r}),n&&e.jsx("button",{className:"btn btn-ghost btn-small",onClick:n,"aria-label":l,children:e.jsx(_s,{size:14})})]}):i==="inline"?e.jsxs("div",{className:"error-state error-state-inline",role:"alert",children:[e.jsxs("div",{className:"error-state-content",children:[e.jsx(m,{size:20,className:"error-state-icon","aria-hidden":"true"}),e.jsxs("div",{className:"error-state-text",children:[e.jsx("span",{className:"error-state-title",children:t}),e.jsx("span",{className:"error-state-message",children:r})]})]}),n&&e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:n,children:[e.jsx(_s,{size:14})," ",l]})]}):e.jsxs("div",{className:"error-state",role:"alert","aria-live":"polite",children:[e.jsx("div",{className:"error-state-icon-wrapper",children:e.jsx(m,{size:32,className:"error-state-icon","aria-hidden":"true"})}),e.jsx("h4",{className:"error-state-title",children:t}),e.jsx("p",{className:"error-state-message",children:r}),!1,n&&e.jsxs("button",{className:"btn btn-primary",onClick:n,children:[e.jsx(_s,{size:16})," ",l]})]})}),di=o.memo(function({title:t="No data yet",message:r="Items will appear here once added.",icon:a=null,action:n=null,actionLabel:l="Get Started",onAction:i=null}){return e.jsxs("div",{className:"empty-state",role:"status",children:[a&&e.jsx("div",{className:"empty-state-icon-wrapper",children:e.jsx(a,{size:32,className:"empty-state-icon","aria-hidden":"true"})}),e.jsx("h4",{className:"empty-state-title",children:t}),e.jsx("p",{className:"empty-state-message",children:r}),i&&e.jsx("button",{className:"btn btn-primary btn-small",onClick:i,children:l}),n&&!i&&n]})});o.memo(function({label:t,error:r,required:a=!1,hint:n,children:l,className:i=""}){return e.jsxs("div",{className:`form-field ${r?"has-error":""} ${i}`,children:[t&&e.jsxs("label",{className:"form-field-label",children:[t,a&&e.jsx("span",{className:"form-field-required",children:"*"})]}),e.jsx("div",{className:"form-field-input",children:l}),r&&e.jsxs("div",{className:"form-field-error",role:"alert",children:[e.jsx(us,{size:14,"aria-hidden":"true"}),e.jsx("span",{children:r})]}),n&&!r&&e.jsx("div",{className:"form-field-hint",children:n})]})});o.memo(function({type:t="text",value:r,onChange:a,onBlur:n,error:l,placeholder:i,disabled:d,min:h,max:m,step:c,pattern:g,required:f,autoComplete:y,name:w,id:D,className:q="","aria-label":I,"aria-describedby":x}){const P=D||w,k=l?`${P}-error`:void 0;return e.jsxs(e.Fragment,{children:[e.jsx("input",{type:t,id:P,name:w,value:r,onChange:a,onBlur:n,placeholder:i,disabled:d,min:h,max:m,step:c,pattern:g,required:f,autoComplete:y,className:`validated-input ${l?"has-error":""} ${q}`,"aria-label":I,"aria-invalid":!!l,"aria-describedby":l?k:x}),l&&e.jsxs("div",{id:k,className:"input-error-inline",role:"alert",children:[e.jsx(us,{size:12,"aria-hidden":"true"}),e.jsx("span",{children:l})]})]})});o.memo(function({value:t,onChange:r,onBlur:a,error:n,disabled:l,required:i,name:d,id:h,className:m="",children:c,"aria-label":g}){const f=h||d,y=n?`${f}-error`:void 0;return e.jsxs(e.Fragment,{children:[e.jsx("select",{id:f,name:d,value:t,onChange:r,onBlur:a,disabled:l,required:i,className:`validated-select ${n?"has-error":""} ${m}`,"aria-label":g,"aria-invalid":!!n,"aria-describedby":n?y:void 0,children:c}),n&&e.jsxs("div",{id:y,className:"input-error-inline",role:"alert",children:[e.jsx(us,{size:12,"aria-hidden":"true"}),e.jsx("span",{children:n})]})]})});o.memo(function({value:t,onChange:r,onBlur:a,error:n,placeholder:l,disabled:i,required:d,rows:h=3,maxLength:m,name:c,id:g,className:f="","aria-label":y}){const w=g||c,D=n?`${w}-error`:void 0;return e.jsxs(e.Fragment,{children:[e.jsx("textarea",{id:w,name:c,value:t,onChange:r,onBlur:a,placeholder:l,disabled:i,required:d,rows:h,maxLength:m,className:`validated-textarea ${n?"has-error":""} ${f}`,"aria-label":y,"aria-invalid":!!n,"aria-describedby":n?D:void 0}),m&&e.jsxs("div",{className:"textarea-counter",children:[t?.length||0," / ",m]}),n&&e.jsxs("div",{id:D,className:"input-error-inline",role:"alert",children:[e.jsx(us,{size:12,"aria-hidden":"true"}),e.jsx("span",{children:n})]})]})});const qr=o.memo(function({count:t,label:r,variant:a="default",size:n="medium",pulse:l=!1,icon:i}){const[d,h]=o.useState(t),[m,c]=o.useState(!1);return o.useEffect(()=>{if(t!==d){c(!0);const g=setTimeout(()=>{c(!1),h(t)},400);return()=>clearTimeout(g)}},[t,d]),e.jsxs("span",{className:`count-badge count-badge-${a} count-badge-${n} ${l?"badge-new":""} ${m?"animate-count-up":""}`,title:r,children:[i&&e.jsx(i,{size:n==="small"?12:n==="large"?18:14}),e.jsx("span",{className:"count-badge-value",children:t}),r&&e.jsx("span",{className:"count-badge-label",children:r})]})}),Ir=o.memo(function({value:t,max:r=100,showLabel:a=!1,size:n="medium",variant:l="default",animated:i=!0}){const d=Math.min(100,Math.max(0,t/r*100)),h=n==="small"?"4px":n==="large"?"8px":"6px",m=l==="default"?d>=80?"danger":d>=60?"warning":"success":l;return e.jsxs("div",{className:`mini-progress mini-progress-${n}`,children:[e.jsx("div",{className:"mini-progress-track",style:{height:h},children:e.jsx("div",{className:`mini-progress-fill mini-progress-${m} ${i?"progress-animate":""}`,style:{width:`${d}%`}})}),a&&e.jsxs("span",{className:"mini-progress-label",children:[Math.round(d),"%"]})]})}),Vr=o.memo(function({value:t,previousValue:r,format:a="percent",inverted:n=!1,showValue:l=!0}){const i=t-r,d=r!==0?i/r*100:0;let h=i===0?"neutral":i>0?"up":"down",m="neutral";i!==0&&(n?m=i>0?"negative":"positive":m=i>0?"positive":"negative");const c=h==="up"?Mt:h==="down"?Mn:An,g=()=>{const f=Math.abs(i);switch(a){case"percent":return`${Math.abs(d).toFixed(1)}%`;case"currency":return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(f);default:return f.toLocaleString()}};return e.jsxs("span",{className:`trend-indicator trend-${m}`,children:[e.jsx(c,{size:14}),l&&e.jsx("span",{className:"trend-value",children:g()})]})});o.memo(function({status:t="default",label:r,size:a="medium",pulse:n=!1}){return e.jsxs("span",{className:`status-dot-container status-dot-${a}`,children:[e.jsx("span",{className:`status-dot status-dot-${t} ${n?"status-dot-pulse":""}`}),r&&e.jsx("span",{className:"status-dot-label",children:r})]})});o.memo(function({data:t=[],width:r=80,height:a=24,strokeWidth:n=2,color:l="var(--accent-blue)",showArea:i=!0}){if(!t.length)return null;const d=Math.max(...t),h=Math.min(...t),m=d-h||1,c=t.map((f,y)=>{const w=y/(t.length-1)*r,D=a-(f-h)/m*(a-n*2)-n;return`${w},${D}`}).join(" "),g=`0,${a} ${c} ${r},${a}`;return e.jsxs("svg",{width:r,height:a,className:"sparkline",viewBox:`0 0 ${r} ${a}`,children:[i&&e.jsx("polygon",{points:g,fill:l,fillOpacity:"0.15"}),e.jsx("polyline",{points:c,fill:"none",stroke:l,strokeWidth:n,strokeLinecap:"round",strokeLinejoin:"round"})]})});o.memo(function({items:t=[]}){return e.jsx("div",{className:"quick-stats",children:t.map((r,a)=>e.jsxs("span",{className:"quick-stat-item",children:[r.icon&&e.jsx(r.icon,{size:12}),e.jsx("span",{className:"quick-stat-value",children:r.value}),r.label&&e.jsx("span",{className:"quick-stat-label",children:r.label})]},a))})});o.memo(function({status:t,label:r,size:a="medium"}){const n={success:Ln,warning:ls,danger:ls,info:wt,pending:wt},l=n[t]||n.info;return e.jsxs("span",{className:`status-indicator status-indicator-${t} status-indicator-${a}`,children:[e.jsx(l,{size:a==="small"?12:a==="large"?18:14}),r&&e.jsx("span",{className:"status-indicator-label",children:r})]})});o.memo(function({current:t,previous:r,format:a="number",label:n,inverted:l=!1}){const i=t-r,d=l?i<0:i>0,h=l?i>0:i<0,m=c=>{switch(a){case"currency":return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0}).format(Math.abs(c));case"percent":return`${Math.abs(c).toFixed(1)}%`;default:return Math.abs(c).toLocaleString()}};return e.jsxs("div",{className:`metric-delta ${d?"positive":h?"negative":"neutral"}`,children:[e.jsx("span",{className:"metric-delta-arrow",children:i>0?"↑":i<0?"↓":"→"}),e.jsx("span",{className:"metric-delta-value",children:m(i)}),n&&e.jsx("span",{className:"metric-delta-label",children:n})]})});o.memo(function({value:t,max:r=100,size:a=40,strokeWidth:n=4,showValue:l=!0,color:i="var(--accent-blue)"}){const d=Math.min(100,Math.max(0,t/r*100)),h=(a-n)/2,m=h*2*Math.PI,c=m-d/100*m;return e.jsxs("div",{className:"circular-progress",style:{width:a,height:a},children:[e.jsxs("svg",{width:a,height:a,viewBox:`0 0 ${a} ${a}`,children:[e.jsx("circle",{className:"circular-progress-track",cx:a/2,cy:a/2,r:h,fill:"none",strokeWidth:n}),e.jsx("circle",{className:"circular-progress-fill",cx:a/2,cy:a/2,r:h,fill:"none",stroke:i,strokeWidth:n,strokeDasharray:m,strokeDashoffset:c,strokeLinecap:"round",transform:`rotate(-90 ${a/2} ${a/2})`,style:{transition:"stroke-dashoffset 0.5s ease"}})]}),l&&e.jsxs("span",{className:"circular-progress-value",children:[Math.round(d),"%"]})]})});o.memo(function({isOpen:t,onClose:r,title:a,children:n,size:l="medium",className:i="",showCloseButton:d=!0,closeOnOverlayClick:h=!0,closeOnEscape:m=!0,footer:c,ariaDescribedBy:g}){const f=o.useRef(null),y=o.useRef(null),w=o.useRef(`modal-title-${Math.random().toString(36).substr(2,9)}`);o.useEffect(()=>{if(t){y.current=document.activeElement;const x=setTimeout(()=>{f.current?.focus()},10);return()=>clearTimeout(x)}},[t]),o.useEffect(()=>{!t&&y.current&&y.current.focus()},[t]),o.useEffect(()=>{if(!t||!m)return;const x=P=>{P.key==="Escape"&&(P.preventDefault(),r())};return document.addEventListener("keydown",x),()=>document.removeEventListener("keydown",x)},[t,m,r]),o.useEffect(()=>{if(t){const x=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=x}}},[t]);const D=o.useCallback(x=>{if(x.key!=="Tab")return;const P=f.current?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!P||P.length===0)return;const k=P[0],G=P[P.length-1];x.shiftKey?document.activeElement===k&&(x.preventDefault(),G.focus()):document.activeElement===G&&(x.preventDefault(),k.focus())},[]),q=x=>{h&&x.target===x.currentTarget&&r()};if(!t)return null;const I={small:"modal-small",medium:"modal-medium",large:"modal-large",full:"modal-full"};return e.jsx("div",{className:"modal-overlay",onClick:q,role:"presentation",children:e.jsxs("div",{ref:f,className:`modal-content ${I[l]||""} ${i}`,role:"dialog","aria-modal":"true","aria-labelledby":a?w.current:void 0,"aria-describedby":g,tabIndex:-1,onKeyDown:D,onClick:x=>x.stopPropagation(),children:[a&&e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{id:w.current,children:a}),d&&e.jsx("button",{className:"close-btn",onClick:r,"aria-label":"Close modal",type:"button",children:e.jsx(ds,{size:20})})]}),e.jsx("div",{className:"modal-body",children:n}),c&&e.jsx("div",{className:"modal-footer",children:c})]})})});const Ce={contract:"#3b82f6",costs:"#f59e0b",labor:"#6366f1",disposal:"#14b8a6",equipment:"#f97316",materials:"#a855f7",other:"#6b7280"},Et={contentStyle:{background:"var(--bg-card)",border:"1px solid var(--border-color)",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",padding:"12px 16px"},labelStyle:{color:"var(--text-primary)",fontWeight:600,marginBottom:"8px"}},Br=s=>new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric"});o.memo(function({earnedRevenue:t=0,totalCosts:r=0,laborCost:a=0,disposalCost:n=0,equipmentCost:l=0,materialsCost:i=0,otherCost:d=0,contractValue:h=0}){const m=t-r,c=t>0?m/t*100:0,g=m>=0,f=D=>D>=1e6?`$${(D/1e6).toFixed(1)}M`:D>=1e3?`$${(D/1e3).toFixed(1)}K`:`$${D.toFixed(0)}`,y=[{key:"labor",value:a,color:Ce.labor,label:"Labor"},{key:"disposal",value:n,color:Ce.disposal,label:"Disposal"},{key:"equipment",value:l,color:Ce.equipment,label:"Equipment"},{key:"materials",value:i,color:Ce.materials,label:"Materials"},{key:"other",value:d,color:Ce.other,label:"Other"}].filter(D=>D.value>0),w=y.length>0&&r>0;return e.jsxs("div",{className:"overview-financial-card animate-fade-in-up",children:[e.jsxs("div",{className:"financial-metrics-row",children:[e.jsxs("div",{className:"financial-metric",children:[e.jsx("span",{className:"financial-metric-value green",children:f(t)}),e.jsx("span",{className:"financial-metric-label",children:"Earned"})]}),e.jsxs("div",{className:"financial-metric",children:[e.jsx("span",{className:"financial-metric-value amber",children:f(r)}),e.jsx("span",{className:"financial-metric-label",children:"Costs"})]}),e.jsxs("div",{className:"financial-metric",children:[e.jsxs("span",{className:`financial-metric-value ${g?"green":"red"}`,children:[g?"":"-",f(Math.abs(m))]}),e.jsxs("span",{className:"financial-metric-label",children:["Profit",e.jsxs("span",{className:`margin-badge ${g?"positive":"negative"}`,children:[c>=0?"+":"",c.toFixed(0),"%"]})]})]})]}),w&&e.jsxs("div",{className:"cost-breakdown-section",children:[e.jsx("div",{className:"cost-breakdown-bar",children:y.map((D,q)=>{const I=D.value/r*100;return e.jsx("div",{className:"cost-segment",style:{width:`${I}%`,backgroundColor:D.color,animationDelay:`${q*100}ms`},title:`${D.label}: ${f(D.value)} (${I.toFixed(0)}%)`},D.key)})}),e.jsx("div",{className:"cost-breakdown-legend",children:y.slice(0,4).map(D=>e.jsxs("span",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:D.color}}),e.jsx("span",{className:"legend-label",children:D.label})]},D.key))})]})]})});const Wr=()=>X(()=>import("./pdf-aQqpMATS.js").then(s=>s.j),[]),ns={contract:Ce.contract,tm:Ce.costs},Tt=[{id:"7d",label:"7D",days:7},{id:"14d",label:"14D",days:14},{id:"30d",label:"30D",days:30}];o.memo(function({project:t,onShowToast:r}){const[a,n]=o.useState([]),[l,i]=o.useState([]),[d,h]=o.useState(new Date().toISOString().split("T")[0]),[m,c]=o.useState("14d"),[g,f]=o.useState(!0),[y,w]=o.useState(!1);o.useEffect(()=>{t?.id&&D()},[t?.id]);const D=async()=>{f(!0);try{const[R,L]=await Promise.all([$.getCrewCheckinHistory(t.id,365),$.getTMTickets(t.id)]);n(R||[]),i(L||[])}catch(R){console.error("Error loading crew metrics:",R)}finally{f(!1)}},q=o.useMemo(()=>{const R={};return l.forEach(L=>{const N=L.work_date;N&&(R[N]||(R[N]=new Set),(L.t_and_m_workers||[]).forEach(ee=>{R[N].add(ee.name.toLowerCase().trim())}))}),R},[l]),I=o.useMemo(()=>{const R={};return a.forEach(L=>{R[L.check_in_date]=L.workers||[]}),R},[a]),x=I[d]||[],P=q[d]||new Set,k=o.useMemo(()=>{const R=[],L=[];return x.forEach(N=>{P.has(N.name.toLowerCase().trim())?L.push(N):R.push(N)}),{total:x.length,contract:R,tm:L}},[x,P]),G=o.useMemo(()=>{const R=Tt.find(ee=>ee.id===m)?.days||14,L=[],N=new Date;for(let ee=R-1;ee>=0;ee--){const _=new Date(N);_.setDate(_.getDate()-ee);const me=_.toISOString().split("T")[0],fe=I[me]||[],te=q[me]||new Set;let Be=0,ve=0;fe.forEach(Te=>{te.has(Te.name.toLowerCase().trim())?ve++:Be++}),L.push({date:me,displayDate:Br(me),contract:Be,tm:ve,total:fe.length})}return L},[I,q,m]),ae=o.useCallback(R=>{const L=new Date(d+"T12:00:00");L.setDate(L.getDate()+R),h(L.toISOString().split("T")[0])},[d]),ce=d===new Date().toISOString().split("T")[0],se=R=>new Date(R+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),C=o.useCallback(R=>{R?.date&&h(R.date)},[]),A=({active:R,payload:L,label:N})=>{if(!R||!L?.length)return null;const ee=(L[0]?.value||0)+(L[1]?.value||0);return e.jsxs("div",{style:{...Et.contentStyle,fontSize:"0.8rem"},children:[e.jsx("p",{style:{...Et.labelStyle,fontSize:"0.85rem",marginBottom:6},children:N}),e.jsxs("p",{style:{margin:"3px 0",color:ns.contract},children:["Contract: ",e.jsx("strong",{children:L[0]?.value||0})]}),e.jsxs("p",{style:{margin:"3px 0",color:ns.tm},children:["T&M: ",e.jsx("strong",{children:L[1]?.value||0})]}),e.jsxs("p",{style:{margin:"3px 0",color:"var(--text-primary)",borderTop:"1px solid var(--border-color)",paddingTop:4},children:["Total: ",e.jsx("strong",{children:ee})]})]})},V=o.useCallback(async()=>{w(!0),r?.("Generating crew report PDF...","info");try{const L=(await Wr()).default,N=new L,ee=N.internal.pageSize.width;let _=20;N.setFontSize(18),N.setFont(void 0,"bold"),N.text("Crew On-Site Report",ee/2,_,{align:"center"}),_+=8,N.setFontSize(11),N.setFont(void 0,"normal"),N.text(`Project: ${t.name}`,ee/2,_,{align:"center"}),_+=6,N.text(`Date: ${se(d)}`,ee/2,_,{align:"center"}),_+=12,N.setFontSize(12),N.setFont(void 0,"bold"),N.text("Selected Day Summary",14,_),_+=7,N.setFontSize(10),N.setFont(void 0,"normal"),N.text(`Total Crew On-Site: ${k.total}`,14,_),_+=5,N.text(`Contract Workers: ${k.contract.length}`,14,_),_+=5,N.text(`T&M Workers: ${k.tm.length}`,14,_),_+=10,k.contract.length>0&&(N.setFontSize(12),N.setFont(void 0,"bold"),N.text("Contract Workers",14,_),_+=7,N.setFontSize(9),N.setFont(void 0,"bold"),N.text("Name",14,_),N.text("Role",100,_),_+=5,N.setFont(void 0,"normal"),k.contract.forEach(te=>{_>270&&(N.addPage(),_=20),N.text(te.name,14,_),N.text(te.role||"—",100,_),_+=5}),_+=8),k.tm.length>0&&(_>240&&(N.addPage(),_=20),N.setFontSize(12),N.setFont(void 0,"bold"),N.text("T&M Workers (Extra Work)",14,_),_+=7,N.setFontSize(9),N.setFont(void 0,"bold"),N.text("Name",14,_),N.text("Role",100,_),_+=5,N.setFont(void 0,"normal"),k.tm.forEach(te=>{_>270&&(N.addPage(),_=20),N.text(te.name,14,_),N.text(te.role||"—",100,_),_+=5}),_+=8),_>200&&(N.addPage(),_=20),N.setFontSize(12),N.setFont(void 0,"bold"),N.text("Daily Timeline",14,_),_+=7,N.setFontSize(8),N.setFont(void 0,"bold"),N.text("Date",14,_),N.text("Total",70,_),N.text("Contract",95,_),N.text("T&M",125,_),_+=5,N.setFont(void 0,"normal"),G.forEach(te=>{_>275&&(N.addPage(),_=20),N.text(te.displayDate,14,_),N.text(String(te.total),70,_),N.text(String(te.contract),95,_),N.text(String(te.tm),125,_),_+=4.5});const me=N.internal.pageSize.height-10;N.setFontSize(8),N.setTextColor(128,128,128),N.text(`Generated ${new Date().toLocaleString()} — FieldSync`,ee/2,me,{align:"center"});const fe=`${t.name}_Crew_Report_${d}.pdf`;N.save(fe),r?.("PDF exported!","success")}catch(R){console.error("Error exporting crew PDF:",R),r?.("Error generating PDF","error")}finally{w(!1)}},[t,d,k,G,r]);return g?e.jsxs("div",{className:"crew-metrics-card animate-fade-in-up",children:[e.jsx("div",{className:"crew-metrics-header",children:e.jsxs("h3",{children:[e.jsx(ze,{size:18})," Crew On-Site"]})}),e.jsxs("div",{className:"crew-metrics-loading",children:[e.jsx("div",{className:"skeleton-stat"}),e.jsx("div",{className:"skeleton-stat"}),e.jsx("div",{className:"skeleton-stat"})]})]}):e.jsxs("div",{className:"crew-metrics-card animate-fade-in-up",children:[e.jsxs("div",{className:"crew-metrics-header",children:[e.jsxs("h3",{children:[e.jsx(ze,{size:18})," Crew On-Site"]}),e.jsx("div",{className:"crew-metrics-actions",children:e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:V,disabled:y,title:"Export crew report as PDF",children:[e.jsx(we,{size:14})," ",y?"Exporting...":"PDF"]})})]}),e.jsxs("div",{className:"crew-date-nav",children:[e.jsx("button",{className:"crew-date-btn",onClick:()=>ae(-1),children:e.jsx(At,{size:16})}),e.jsxs("span",{className:"crew-date-label",children:[e.jsx(Lt,{size:14}),ce?"Today":se(d)]}),e.jsx("button",{className:"crew-date-btn",onClick:()=>ae(1),disabled:ce,children:e.jsx(De,{size:16})})]}),e.jsxs("div",{className:"crew-stats-row",children:[e.jsxs("div",{className:"crew-stat total",children:[e.jsx("div",{className:"crew-stat-icon",children:e.jsx(ze,{size:20})}),e.jsxs("div",{className:"crew-stat-content",children:[e.jsx("span",{className:"crew-stat-value",children:k.total}),e.jsx("span",{className:"crew-stat-label",children:"Total On-Site"})]})]}),e.jsxs("div",{className:"crew-stat contract",children:[e.jsx("div",{className:"crew-stat-icon",children:e.jsx(qe,{size:20})}),e.jsxs("div",{className:"crew-stat-content",children:[e.jsx("span",{className:"crew-stat-value",children:k.contract.length}),e.jsx("span",{className:"crew-stat-label",children:"Contract"})]})]}),e.jsxs("div",{className:"crew-stat tm",children:[e.jsx("div",{className:"crew-stat-icon",children:e.jsx(Ct,{size:20})}),e.jsxs("div",{className:"crew-stat-content",children:[e.jsx("span",{className:"crew-stat-value",children:k.tm.length}),e.jsx("span",{className:"crew-stat-label",children:"T&M"})]})]})]}),k.total>0&&e.jsxs("div",{className:"crew-breakdown-bar",children:[e.jsx("div",{className:"crew-bar-segment contract",style:{width:`${k.contract.length/k.total*100}%`},title:`${k.contract.length} Contract`}),e.jsx("div",{className:"crew-bar-segment tm",style:{width:`${k.tm.length/k.total*100}%`},title:`${k.tm.length} T&M`})]}),k.total>0&&e.jsxs("div",{className:"crew-name-lists",children:[k.contract.length>0&&e.jsxs("div",{className:"crew-name-group",children:[e.jsxs("div",{className:"crew-name-group-header contract",children:[e.jsx(qe,{size:13}),e.jsxs("span",{children:["Contract (",k.contract.length,")"]})]}),e.jsx("div",{className:"crew-name-tags",children:k.contract.map((R,L)=>e.jsxs("span",{className:"crew-name-tag contract",children:[R.name,R.role&&R.role!=="Laborer"&&e.jsx("span",{className:"crew-name-role",children:R.role})]},L))})]}),k.tm.length>0&&e.jsxs("div",{className:"crew-name-group",children:[e.jsxs("div",{className:"crew-name-group-header tm",children:[e.jsx(Ct,{size:13}),e.jsxs("span",{children:["T&M (",k.tm.length,")"]})]}),e.jsx("div",{className:"crew-name-tags",children:k.tm.map((R,L)=>e.jsxs("span",{className:"crew-name-tag tm",children:[R.name,R.role&&R.role!=="Laborer"&&e.jsx("span",{className:"crew-name-role",children:R.role})]},L))})]})]}),e.jsxs("div",{className:"crew-timeline-section",children:[e.jsxs("div",{className:"crew-timeline-header",children:[e.jsx("span",{className:"crew-timeline-title",children:"Daily Breakdown"}),e.jsx("div",{className:"crew-time-range-pills",children:Tt.map(R=>e.jsx("button",{className:`crew-range-pill ${m===R.id?"active":""}`,onClick:()=>c(R.id),children:R.label},R.id))})]}),e.jsx("div",{className:"crew-chart-container",children:e.jsx(Nn,{width:"100%",height:140,children:e.jsxs(yn,{data:G,onClick:R=>R?.activePayload?.[0]&&C(R.activePayload[0].payload),style:{cursor:"pointer"},children:[e.jsx(wn,{strokeDasharray:"3 3",stroke:"var(--border-color)",vertical:!1}),e.jsx(Cn,{dataKey:"displayDate",tick:{fontSize:10,fill:"var(--text-muted)"},axisLine:{stroke:"var(--border-color)"},tickLine:!1,interval:m==="30d"?4:m==="14d"?1:0}),e.jsx(kn,{tick:{fontSize:10,fill:"var(--text-muted)"},axisLine:!1,tickLine:!1,allowDecimals:!1,width:30}),e.jsx(Sn,{content:e.jsx(A,{})}),e.jsx(qt,{wrapperStyle:{fontSize:"0.75rem",paddingTop:4},iconType:"circle",iconSize:8}),e.jsx(Nt,{dataKey:"contract",name:"Contract",stackId:"crew",fill:ns.contract,radius:[0,0,0,0]}),e.jsx(Nt,{dataKey:"tm",name:"T&M (Extra Work)",stackId:"crew",fill:ns.tm,radius:[3,3,0,0]})]})})})]}),k.total===0&&e.jsx("div",{className:"crew-empty",children:e.jsx("p",{children:"No crew checked in for this date"})})]})});const Ae=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(s||0),rs=o.memo(function({icon:t,label:r,value:a,formattedValue:n,subLabel:l,progress:i,progressLabel:d,variant:h="default",trend:m,previousValue:c}){const g={default:"var(--accent-blue)",success:"var(--accent-green)",warning:"var(--accent-amber)",danger:"var(--accent-red)"};return e.jsxs("div",{className:"hero-metric-card hover-lift animate-fade-in-up",children:[e.jsxs("div",{className:"hero-metric-header",children:[e.jsx("div",{className:"hero-metric-icon",style:{color:g[h]},children:e.jsx(t,{size:18})}),e.jsx("span",{className:"hero-metric-label",children:r})]}),e.jsxs("div",{className:"hero-metric-value-row",children:[e.jsx("span",{className:`hero-metric-value hero-metric-${h}`,children:n}),m!==void 0&&c!==void 0&&e.jsx(Vr,{value:a,previousValue:c,format:"currency",inverted:r.toLowerCase().includes("cost")})]}),l&&e.jsx("span",{className:"hero-metric-sublabel",children:l}),i!==void 0&&e.jsxs("div",{className:"hero-metric-progress",children:[e.jsx(Ir,{value:i,max:100,size:"small",variant:h,showLabel:!0}),d&&e.jsx("span",{className:"hero-metric-progress-label",children:d})]})]})});o.memo(function({contractValue:t=0,earnedRevenue:r=0,totalCosts:a=0,profit:n=0,progress:l=0,corApprovedValue:i=0,loading:d=!1,previousData:h}){const m=t+i,c=r>0?n/r*100:0,g=r>0?a/r*100:0,f=m>0?r/m*100:0,y=m>0?a/m*100:0,w=o.useMemo(()=>c>=20?"success":c>=10?"warning":c<0?"danger":"default",[c]),D=o.useMemo(()=>g<=60?"success":g<=80?"warning":"danger",[g]);return d?e.jsx(zr,{}):e.jsxs("div",{className:"hero-metrics stagger-children",children:[e.jsx(rs,{icon:Le,label:"Contract Value",value:m,formattedValue:Ae(m),subLabel:i>0?`+${Ae(i)} CORs`:null,variant:"default"}),e.jsx(rs,{icon:Mt,label:"Earned Revenue",value:r,formattedValue:Ae(r),progress:f,progressLabel:`${Math.round(f)}% of contract`,variant:"success",previousValue:h?.earnedRevenue,trend:h?r:void 0}),e.jsx(rs,{icon:zt,label:"Total Costs",value:a,formattedValue:Ae(a),progress:y,progressLabel:`${Math.round(g)}% of revenue`,variant:D,previousValue:h?.totalCosts,trend:h?a:void 0}),e.jsx(rs,{icon:zn,label:"Profit",value:n,formattedValue:Ae(n),subLabel:`${c>=0?"+":""}${c.toFixed(1)}% margin`,variant:w,previousValue:h?.profit,trend:h?n:void 0})]})});const Ot=[{id:"overview",label:"Overview",shortLabel:"Overview",icon:In,description:"Metrics & trends",step:null},{id:"cors",label:"Change Orders",shortLabel:"CORs",icon:Ts,description:"CORs & approvals",step:1},{id:"tickets",label:"T&M Tickets",shortLabel:"Tickets",icon:ue,description:"Field data",step:2},{id:"billing",label:"Billing",shortLabel:"Billing",icon:zt,description:"Invoices & billing",step:3}];o.memo(function({activeSection:t="overview",onSectionChange:r,collapsed:a=!1,onToggleCollapse:n,onMobileClose:l,stats:i={}}){const{corCount:d=0,ticketCount:h=0,corPending:m=0,ticketPending:c=0,billableCount:g=0,invoiceCount:f=0}=i,y=w=>w==="cors"&&d>0?{count:d,variant:m>0?"warning":"default",pending:m}:w==="tickets"&&h>0?{count:h,variant:c>0?"warning":"default",pending:c}:w==="billing"&&g>0?{count:g,variant:"success",pending:g}:null;return e.jsxs("nav",{className:`financials-nav ${a?"collapsed":""}`,"aria-label":"Financials sections",children:[l&&e.jsxs("div",{className:"financials-nav-mobile-header",children:[e.jsx("span",{className:"financials-nav-mobile-title",children:"Financials"}),e.jsx("button",{className:"financials-nav-mobile-close",onClick:l,"aria-label":"Close menu",children:e.jsx(ds,{size:20})})]}),e.jsxs("button",{className:"financials-nav-toggle",onClick:n,"aria-label":a?"Expand sidebar":"Collapse sidebar",title:a?"Expand sidebar":"Collapse sidebar",children:[a?e.jsx(qn,{size:18}):e.jsx(At,{size:18}),!a&&e.jsx("span",{children:"Collapse"})]}),e.jsx("div",{className:"financials-nav-items",children:Ot.map((w,D)=>{const q=t===w.id,I=w.icon,x=y(w.id),P=D<Ot.length-1&&w.step!==null;return e.jsxs("div",{className:"financials-nav-item-wrapper",children:[e.jsxs("button",{className:`financials-nav-item ${q?"active":""}`,onClick:()=>r?.(w.id),"aria-current":q?"page":void 0,title:`${w.label}${x?` (${x.count})`:""}`,children:[w.step&&!a&&e.jsx("span",{className:"financials-nav-step",children:w.step}),e.jsxs("div",{className:"financials-nav-icon",children:[e.jsx(I,{size:a?22:20}),x&&x.pending>0&&e.jsx("span",{className:"financials-nav-dot"})]}),a&&e.jsx("span",{className:"financials-nav-short-label",children:w.shortLabel}),!a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"financials-nav-content",children:[e.jsx("span",{className:"financials-nav-label",children:w.label}),e.jsx("span",{className:"financials-nav-desc",children:w.description})]}),x&&e.jsx(qr,{count:x.count,size:"small",variant:x.variant}),e.jsx(De,{size:16,className:"financials-nav-arrow"})]})]}),P&&!a&&e.jsx("div",{className:"financials-nav-connector",children:e.jsx("div",{className:"connector-line"})})]},w.id)})}),a&&e.jsxs("button",{className:"financials-nav-expand-btn",onClick:n,"aria-label":"Expand sidebar",children:[e.jsx(De,{size:14}),e.jsx("span",{children:"Expand"})]})]})});const Rs=s=>s?new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"";o.memo(function({project:t,onAddEquipment:r,onEditEquipment:a,onShowToast:n}){const[l,i]=o.useState([]),[d,h]=o.useState(!0),[m,c]=o.useState(!0),[g,f]=o.useState(0),y=o.useCallback(async()=>{if(t?.id)try{h(!0);const x=await Se.getProjectEquipment(t.id);i(x||[]);const P=Se.calculateProjectEquipmentCost(x||[]);f(P)}catch(x){console.error("Error loading equipment:",x),n?.("Failed to load equipment","error")}finally{h(!1)}},[t?.id]);o.useEffect(()=>{y()},[y]);const w=o.useCallback(async x=>{try{await Se.markEquipmentReturned(x.id),n?.(`${x.equipment_name} marked as returned`,"success"),y()}catch(P){console.error("Error marking equipment returned:",P),n?.("Failed to update equipment","error")}},[y]),D=o.useCallback(async x=>{if(confirm(`Remove ${x.equipment_name} from this project?`))try{await Se.removeEquipmentFromProject(x.id),n?.("Equipment removed","success"),y()}catch(P){console.error("Error removing equipment:",P),n?.("Failed to remove equipment","error")}},[y]),q=o.useMemo(()=>l.filter(x=>!x.end_date),[l]),I=o.useMemo(()=>l.filter(x=>x.end_date),[l]);return e.jsxs("div",{className:"project-equipment-card",children:[e.jsxs("div",{className:"project-equipment-header",children:[e.jsxs("div",{className:"project-equipment-title",children:[e.jsx(Os,{size:18}),e.jsx("h3",{children:"Equipment on Site"}),l.length>0&&e.jsxs("span",{className:"equipment-count",children:[q.length," active"]})]}),e.jsxs("div",{className:"project-equipment-actions",children:[e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>r?.(),title:"Add equipment",children:[e.jsx(cs,{size:14}),e.jsx("span",{children:"Add"})]}),l.length>0&&e.jsx("button",{className:"btn btn-sm btn-ghost",onClick:()=>c(!m),children:m?e.jsx(Vn,{size:16}):e.jsx(Bn,{size:16})})]})]}),d?e.jsx("div",{className:"equipment-loading",children:e.jsx("div",{className:"loading-spinner small"})}):l.length===0?e.jsxs("div",{className:"equipment-empty",children:[e.jsx("p",{children:"No equipment tracked on this project"}),e.jsxs("button",{className:"btn btn-sm btn-outline",onClick:()=>r?.(),children:[e.jsx(cs,{size:14}),"Track Equipment"]})]}):m?e.jsxs(e.Fragment,{children:[q.length>0&&e.jsx("div",{className:"equipment-list",children:q.map(x=>{const P=Se.calculateDaysOnSite(x.start_date,x.end_date),k=x.daily_rate*P;return e.jsxs("div",{className:"equipment-item active",children:[e.jsxs("div",{className:"equipment-item-main",children:[e.jsxs("div",{className:"equipment-item-info",children:[e.jsx("span",{className:"equipment-name",children:x.equipment_name}),e.jsxs("span",{className:"equipment-meta",children:[e.jsx(Lt,{size:12}),"On-site since ",Rs(x.start_date)]})]}),e.jsxs("div",{className:"equipment-item-cost",children:[e.jsxs("span",{className:"equipment-rate",children:[ie(x.daily_rate),"/day"]}),e.jsxs("span",{className:"equipment-days",children:[P," days"]}),e.jsx("span",{className:"equipment-total",children:ie(k)})]})]}),e.jsxs("div",{className:"equipment-item-actions",children:[e.jsxs("button",{className:"btn btn-xs btn-outline",onClick:()=>w(x),title:"Mark as returned",children:[e.jsx(Wn,{size:12}),"Returned"]}),e.jsx("button",{className:"btn btn-xs btn-ghost",onClick:()=>a?.(x),title:"Edit",children:e.jsx(Un,{size:12})}),e.jsx("button",{className:"btn btn-xs btn-ghost text-danger",onClick:()=>D(x),title:"Remove",children:e.jsx(Hn,{size:12})})]})]},x.id)})}),I.length>0&&e.jsxs("details",{className:"equipment-returned-section",children:[e.jsx("summary",{className:"equipment-returned-toggle",children:e.jsxs("span",{children:["Returned Equipment (",I.length,")"]})}),e.jsx("div",{className:"equipment-list returned",children:I.map(x=>{const P=Se.calculateDaysOnSite(x.start_date,x.end_date),k=x.daily_rate*P;return e.jsx("div",{className:"equipment-item returned",children:e.jsxs("div",{className:"equipment-item-main",children:[e.jsxs("div",{className:"equipment-item-info",children:[e.jsx("span",{className:"equipment-name",children:x.equipment_name}),e.jsxs("span",{className:"equipment-meta",children:[Rs(x.start_date)," - ",Rs(x.end_date)]})]}),e.jsxs("div",{className:"equipment-item-cost",children:[e.jsxs("span",{className:"equipment-days",children:[P," days"]}),e.jsx("span",{className:"equipment-total",children:ie(k)})]})]})},x.id)})})]}),e.jsxs("div",{className:"equipment-total-row",children:[e.jsx("span",{children:"Total Equipment Cost"}),e.jsx("span",{className:"equipment-grand-total",children:ie(g)})]})]}):e.jsxs("div",{className:"equipment-summary-collapsed",children:[e.jsxs("span",{children:[q.length," active, ",I.length," returned"]}),e.jsx("span",{className:"equipment-grand-total",children:ie(g)})]})]})});o.memo(function({project:t,areas:r=[],corStats:a={},onCreateDraw:n,onViewDraw:l,onShowToast:i}){const[d,h]=o.useState([]),[m,c]=o.useState(!0),g=o.useMemo(()=>r.reduce((k,G)=>{const ae=(G.square_footage||0)*(G.price_per_sqft||0);return k+Math.round(ae*100)},0),[r]),f=o.useMemo(()=>a?.approvedTotal||0,[a?.approvedTotal]),y=g+f,w=o.useCallback(async()=>{if(t?.id)try{c(!0);const k=await _n.getProjectDrawRequests(t.id);h(k||[])}catch(k){console.error("Error loading draw requests:",k)}finally{c(!1)}},[t?.id]);o.useEffect(()=>{w()},[w]);const D=o.useMemo(()=>{const k=d.filter(se=>["submitted","approved","paid"].includes(se.status)),G=k.reduce((se,C)=>se+(C.previous_billings||0)+(C.current_billing||0),0),ce=k[0]?.retention_held||0;return{billedToDate:G,retentionHeld:ce}},[d]),q=y>0?Math.round(D.billedToDate/y*100):0,I=d.length>0?Math.max(...d.map(k=>k.draw_number))+1:1,x=k=>k?new Date(k).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",P=k=>{switch(k){case"draft":return e.jsx("span",{className:"badge badge-muted",children:"Draft"});case"submitted":return e.jsx("span",{className:"badge badge-warning",children:"Submitted"});case"approved":return e.jsx("span",{className:"badge badge-success",children:"Approved"});case"paid":return e.jsx("span",{className:"badge badge-info",children:"Paid"});case"rejected":return e.jsx("span",{className:"badge badge-danger",children:"Rejected"});default:return null}};return e.jsxs("div",{className:"progress-billing-card",children:[e.jsxs("div",{className:"progress-billing-header",children:[e.jsxs("div",{className:"progress-billing-title",children:[e.jsx(Kn,{size:18}),e.jsx("h3",{children:"Progress Billing"})]}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:()=>n?.(),disabled:g===0,title:g===0?"Add areas with contract values first":`Create Draw #${I}`,children:[e.jsx(cs,{size:14}),e.jsxs("span",{children:["Draw #",I]})]})]}),e.jsxs("div",{className:"progress-billing-contract",children:[e.jsxs("div",{className:"contract-row",children:[e.jsx("span",{className:"contract-label",children:"Original Contract"}),e.jsx("span",{className:"contract-value",children:ie(g)})]}),f>0&&e.jsxs("div",{className:"contract-row co",children:[e.jsx("span",{className:"contract-label",children:"Approved COs"}),e.jsxs("span",{className:"contract-value positive",children:["+",ie(f)]})]}),e.jsxs("div",{className:"contract-row revised",children:[e.jsx("span",{className:"contract-label",children:"Revised Contract"}),e.jsx("span",{className:"contract-value",children:ie(y)})]})]}),e.jsxs("div",{className:"progress-billing-status",children:[e.jsx("div",{className:"billing-progress-bar",children:e.jsx("div",{className:"billing-progress-fill",style:{width:`${Math.min(q,100)}%`}})}),e.jsxs("div",{className:"billing-stats",children:[e.jsxs("div",{className:"billing-stat",children:[e.jsx("span",{className:"billing-stat-value",children:ie(D.billedToDate)}),e.jsxs("span",{className:"billing-stat-label",children:["Billed to Date (",q,"%)"]})]}),D.retentionHeld>0&&e.jsxs("div",{className:"billing-stat retention",children:[e.jsxs("span",{className:"billing-stat-value",children:["-",ie(D.retentionHeld)]}),e.jsx("span",{className:"billing-stat-label",children:"Retention Held"})]}),e.jsxs("div",{className:"billing-stat remaining",children:[e.jsx("span",{className:"billing-stat-value",children:ie(y-D.billedToDate)}),e.jsx("span",{className:"billing-stat-label",children:"Balance to Finish"})]})]})]}),m?e.jsx("div",{className:"progress-billing-loading",children:e.jsx("div",{className:"loading-spinner small"})}):d.length===0?e.jsxs("div",{className:"progress-billing-empty",children:[e.jsx("p",{children:"No draw requests yet"}),g>0&&e.jsxs("button",{className:"btn btn-sm btn-outline",onClick:()=>n?.(),children:[e.jsx(cs,{size:14}),"Create First Draw Request"]})]}):e.jsxs("div",{className:"progress-billing-draws",children:[e.jsx("div",{className:"draws-header",children:e.jsx("span",{children:"Recent Draws"})}),e.jsx("div",{className:"draws-list",children:d.slice(0,3).map(k=>e.jsxs("button",{className:"draw-item",onClick:()=>l?.(k),children:[e.jsxs("div",{className:"draw-item-info",children:[e.jsxs("span",{className:"draw-number",children:["Draw #",k.draw_number]}),e.jsx("span",{className:"draw-date",children:x(k.period_end||k.created_at)})]}),e.jsx("div",{className:"draw-item-amount",children:ie(k.current_billing||0)}),P(k.status),e.jsx(De,{size:16,className:"draw-item-arrow"})]},k.id))}),d.length>3&&e.jsxs("button",{className:"btn btn-sm btn-ghost view-all-draws",children:["View all ",d.length," draws"]})]})]})});o.lazy(()=>X(()=>import("./TMList-CHvAwVa1.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])));o.lazy(()=>X(()=>import("./CORLogPreview-CQATCuVD.js"),__vite__mapDeps([9,2,3,4,1,5,6,8])));o.lazy(()=>X(()=>import("./CORList-Cl9x5PGB.js"),__vite__mapDeps([10,1,2,3,4,5,6,8,11])));o.lazy(()=>X(()=>import("./BillingCenter-BaOmQ5LT.js"),__vite__mapDeps([12,2,3,4,1,5,6,8])));o.lazy(()=>X(()=>import("./DailyReportsList-C0qx4Xmf.js"),__vite__mapDeps([13,1,2,3,4,5,6,8])));o.lazy(()=>X(()=>import("./InjuryReportsList-MhRrBb7D.js"),__vite__mapDeps([14,1,2,3,4,5,6,8])));const Ur=o.lazy(()=>X(()=>import("./ShareModal-BMuqLNaR.js"),__vite__mapDeps([15,2,3,4,1,5,6]))),Hr=o.lazy(()=>X(()=>import("./NotificationSettings-GYY1yp8x.js"),__vite__mapDeps([16,2,3,4,1,5,6]))),Kr=o.lazy(()=>X(()=>import("./CORForm-DvEstILx.js"),__vite__mapDeps([17,2,3,4,1,5,6,8]))),Gr=o.lazy(()=>X(()=>import("./CORDetail-CAJsxIa4.js"),__vite__mapDeps([18,2,3,4,1,5,6,8,19,7]))),Jr=o.lazy(()=>X(()=>import("./CORLog-DPw3m66-.js").then(s=>s.a),__vite__mapDeps([11,1,2,3,4,5,6,8]))),Yr=o.lazy(()=>X(()=>import("./DrawRequestModal-B7iaMbwC.js"),__vite__mapDeps([20,2,3,4,1,5,6,8]))),Qr=o.lazy(()=>X(()=>import("./EquipmentModal-f295Uqh1.js"),__vite__mapDeps([21,2,3,4,1,5,6]))),Zr=o.lazy(()=>X(()=>import("./AddCostModal-CoxgyMBT.js"),__vite__mapDeps([22,2,3,4,1,5,6]))),Xr=o.lazy(()=>X(()=>import("./DocumentsTab-D5Orqzjo.js"),__vite__mapDeps([23,2,3,4,1,5,6])));function ei({company:s,user:t,isAdmin:r,onShowToast:a,navigateToProjectId:n,onProjectNavigated:l}){const[i,d]=o.useState([]),[h,m]=o.useState([]),[c,g]=o.useState(null),[f,y]=o.useState([]),[w,D]=o.useState(!0),[q,I]=o.useState(!1),[x,P]=o.useState(null),[k,G]=o.useState(!1),[ae,ce]=o.useState(!1),[se,C]=o.useState(!1),[A,V]=o.useState("overview"),[R,L]=o.useState("overview"),[N,ee]=o.useState(!0),[_,me]=o.useState(!1),[fe,te]=o.useState(!1),[Be,ve]=o.useState("list"),[Te,ps]=o.useState("preview"),[$s,It]=o.useState([]),[Vt,Oe]=o.useState(!1),[Bt,Pe]=o.useState(null),[Wt,We]=o.useState(!1),[Ms,Ue]=o.useState(null),[Ut,As]=o.useState(0),[Ht,xs]=o.useState(!1),[Kt,Ls]=o.useState(!1),[Gt,He]=o.useState(!1),[zs,Ke]=o.useState(null),[Jt,Yt]=o.useState(0),[Qt,Ge]=o.useState(!1),[qs,Je]=o.useState(null),[Zt,Xt]=o.useState(0),{isOpen:ea,setIsOpen:sa,close:ta}=$r(),Fe=o.useRef(null),Ye=o.useRef(!1),js=o.useRef(!1),gs=o.useRef(new Map),Is=300*1e3,Z=o.useCallback((u={})=>{const{refreshAreas:b=!1,refreshCOR:v=!1,projectId:S=null}=u;b&&S&&(Ye.current=S),v&&(js.current=!0),Fe.current&&clearTimeout(Fe.current),Fe.current=setTimeout(async()=>{Ye.current&&(await fs(Ye.current),Ye.current=!1),js.current&&(As(F=>F+1),js.current=!1),await $e()},150)},[]);o.useEffect(()=>()=>{Fe.current&&clearTimeout(Fe.current)},[]),o.useEffect(()=>{s?.id&&($e(),ra())},[s?.id]);const aa=o.useRef([]),na=i.map(u=>u.id).sort().join(",");o.useEffect(()=>{if(!s?.id||i.length===0)return;const u=i.map(v=>v.id).sort();aa.current=u;const b=$.subscribeToCompanyActivity?.(s.id,u,{onMessage:()=>Z(),onMaterialRequest:()=>Z(),onTMTicket:()=>Z(),onCrewCheckin:()=>Z(),onAreaUpdate:()=>Z(),onCORChange:()=>Z({refreshCOR:!0}),onInjuryReport:()=>Z(),onProjectChange:()=>Z(),onMaterialsEquipmentChange:()=>Z(),onLaborRateChange:()=>Z()});return()=>{b&&$.unsubscribe?.(b)}},[s?.id,na,Z]),o.useEffect(()=>(_?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[_]);const ra=async()=>{try{const u=await $.getDumpSites(s.id);It(u||[])}catch(u){console.error("Error loading dump sites:",u)}},Vs=o.useRef(null);o.useEffect(()=>{if(n&&n!==Vs.current&&i.length>0){const u=i.find(b=>b.id===n);u&&(Vs.current=n,g(u),l?.())}},[n,i,l]),o.useEffect(()=>{if(c){fs(c.id);const u=[],b=c.id,v=$.subscribeToAreas?.(b,()=>{Z({refreshAreas:!0,projectId:b})});v&&u.push(v);const S=$.subscribeToDailyReports?.(b,()=>{Z()});S&&u.push(S);const F=$.subscribeToCrewCheckins?.(b,()=>{Z()});F&&u.push(F);const z=$.subscribeToHaulOffs?.(b,()=>{Z()});z&&u.push(z);const M=$.subscribeToCORs?.(b,()=>{Z({refreshCOR:!0})});return M&&u.push(M),()=>{u.forEach(U=>$.unsubscribe?.(U))}}},[c,Z]),o.useEffect(()=>{R==="tickets"&&ps("full")},[R]);const ia=async(u,b=!1)=>{const v=u.id,S=gs.current.get(v);if(S&&!b&&Date.now()-S.timestamp<Is)return S.data;try{const[F,z,M,U,H,J,be,Xe,j,O,Y,xe]=await Promise.all([ne(()=>$.getAreas(u.id),{fallback:[],context:{operation:"getAreas",projectId:u.id}}),ne(()=>$.getTMTickets(u.id),{fallback:[],context:{operation:"getTMTickets",projectId:u.id}}),ne(()=>$.getChangeOrderTotals(u.id),{fallback:null,context:{operation:"getChangeOrderTotals",projectId:u.id}}),ne(()=>$.getDailyReports(u.id,100),{fallback:[],context:{operation:"getDailyReports",projectId:u.id}}),ne(()=>$.getInjuryReports(u.id),{fallback:[],context:{operation:"getInjuryReports",projectId:u.id}}),ne(()=>$.calculateManDayCosts(u.id,s?.id,u.work_type||"demolition",u.job_type||"standard"),{fallback:null,context:{operation:"calculateManDayCosts",projectId:u.id}}),ne(()=>$.calculateHaulOffCosts(u.id),{fallback:null,context:{operation:"calculateHaulOffCosts",projectId:u.id}}),ne(()=>$.getProjectCosts(u.id),{fallback:[],context:{operation:"getProjectCosts",projectId:u.id}}),ne(()=>$.getCORStats(u.id),{fallback:null,context:{operation:"getCORStats",projectId:u.id}}),ne(()=>$.getCrewCheckinHistory(u.id,60),{fallback:[],context:{operation:"getCrewCheckinHistory",projectId:u.id}}),ne(()=>$.getMaterialRequests(u.id),{fallback:[],context:{operation:"getMaterialRequests",projectId:u.id}}),ne(()=>$.getWeeklyDisposalSummary(u.id,4),{fallback:[],context:{operation:"getWeeklyDisposalSummary",projectId:u.id}})]),de=yt(F),vs=de.progress,ct=M?.totalApprovedValue||0,ot=u.contract_value+ct,es=de.isValueBased?de.earnedValue:vs/100*ot,za=z.filter(T=>T.status==="pending").length,bs=new Date;bs.setDate(bs.getDate()-7);const qa=U.filter(T=>new Date(T.report_date)>=bs).length,dt=Xe.reduce((T,B)=>{const ke=parseFloat(B.amount);return T+(isNaN(ke)?0:ke)},0);let ss=0;const ts={};z.forEach(T=>{const B=T.work_date||T.ticket_date||T.created_at?.split("T")[0],ke=T.t_and_m_items||T.items||[];let as=0;ke.forEach(Ss=>{const tn=parseFloat(Ss.quantity)||1,an=parseFloat(Ss.unit_cost)||parseFloat(Ss.materials_equipment?.cost_per_unit)||0;as+=tn*an}),as>0&&B&&(ss+=as,ts[B]||(ts[B]={date:B,cost:0}),ts[B].cost+=as)});const ut=Object.values(ts).sort((T,B)=>new Date(B.date)-new Date(T.date)),Ns=J?.totalCost||0,Ia=be?.totalCost||0,mt=Ns+ss+dt,ht=es-mt,Va=es>0?ht/es*100:0,pt=J?.byDate?.length||0,Ba=ut.length,ys=Math.max(pt,Ba),xt=Ns+ss,Wa=ys>0?xt/ys:0,je=Tn({...u,progress:vs},J?.totalManDays||0),Ne={},jt=new Set;(O||[]).forEach(T=>{const B=T.workers||[];Ne[T.check_in_date]=B.length,B.forEach(ke=>jt.add(ke.name?.toLowerCase()))});const ge=Object.keys(Ne).sort(),Ua=ge.length>0?Math.round(ge.reduce((T,B)=>T+Ne[B],0)/ge.length*10)/10:0,Ha=ge.length>0?Math.max(...ge.map(T=>Ne[T])):0,ws=ge.slice(-7),Cs=ge.slice(-14,-7),gt=ws.length>0?ws.reduce((T,B)=>T+Ne[B],0)/ws.length:0,ks=Cs.length>0?Cs.reduce((T,B)=>T+Ne[B],0)/Cs.length:0,Ka=(Y||[]).filter(T=>T.status==="pending").length,Ga=(Y||[]).filter(T=>T.status==="ordered").length,Ja=(Y||[]).filter(T=>T.status==="delivered").length,Ya=(Y||[]).filter(T=>T.priority==="urgent"&&T.status==="pending").length,Qa=U.filter(T=>T.issues&&T.issues.trim().length>0).length,Za=z.reduce((T,B)=>T+(B.photos?.length||0),0),Xa=(xe||[]).reduce((T,B)=>T+(B.concrete||0)+(B.trash||0)+(B.metals||0)+(B.hazardous_waste||0),0),ft=H.length>0?new Date(H[0]?.incident_date||H[0]?.created_at):null,en=ft?Math.floor((new Date-ft)/(1e3*60*60*24)):null,sn=F.filter(T=>T.status==="done"),vt={...u,areas:F,progress:vs,billable:es,changeOrderValue:ct,revisedContractValue:ot,changeOrderPending:M?.pendingCount||0,totalTickets:z.length,pendingTickets:za,approvedTickets:z.filter(T=>T.status==="approved").length,tmTickets:z,dailyReportsCount:U.length,recentDailyReports:qa,injuryReportsCount:H.length,lastDailyReport:U[0]?.report_date||null,isValueBased:de.isValueBased,earnedValue:de.earnedValue,totalSOVValue:de.totalValue,laborCost:Ns,laborDaysWorked:pt,laborManDays:J?.totalManDays||0,laborByDate:J?.byDate||[],dailyBurn:Wa,materialsEquipmentCost:ss,materialsEquipmentByDate:ut,haulOffCost:Ia,haulOffLoads:be?.totalLoads||0,haulOffDays:be?.daysWithHaulOff||0,haulOffByType:be?.byWasteType||{},haulOffByDate:be?.byDate||[],customCosts:Xe,customCostTotal:dt,totalBurn:xt,totalBurnDays:ys,allCostsTotal:mt,currentProfit:ht,profitMargin:Va,corPendingValue:j?.total_pending_value||0,corPendingCount:j?.pending_count||0,corApprovedValue:j?.total_approved_value||0,corBilledValue:j?.total_billed_value||0,corTotalCount:j?.total_cors||0,corStats:j,scheduleStatus:je.scheduleStatus,scheduleVariance:je.scheduleVariance,scheduleLabel:je.scheduleLabel,laborStatus:je.laborStatus,laborVariance:je.laborVariance,laborLabel:je.laborLabel,hasScheduleData:je.hasScheduleData,hasLaborData:je.hasLaborData,actualManDays:J?.totalManDays||0,crewHistory:O||[],crewByDate:Ne,uniqueWorkerCount:jt.size,avgCrewSize:Ua,peakCrewSize:Ha,crewDaysTracked:ge.length,crewTrend:ks>0?(gt-ks)/ks*100:0,recentCrewAvg:gt,materialRequests:Y||[],pendingMaterialRequests:Ka,orderedMaterialRequests:Ga,deliveredMaterialRequests:Ja,urgentMaterialRequests:Ya,totalMaterialRequests:(Y||[]).length,reportsWithIssues:Qa,totalPhotosFromTickets:Za,dailyReports:U,weeklyDisposal:xe||[],disposalTotalLoads:Xa,daysSinceLastInjury:en,injuryReports:H,oshaRecordable:H.filter(T=>T.osha_recordable).length,completedAreasCount:sn.length,hasError:!1,_detailsLoaded:!0};return gs.current.set(v,{data:vt,timestamp:Date.now()}),vt}catch(F){return console.error(`Error loading details for project ${u.id}:`,F),{...u,hasError:!0,_detailsLoaded:!1}}},$e=async()=>{try{const u=await $.getProjectDashboardSummary(s?.id);d(u);const b=u.map(v=>{const S=gs.current.get(v.id);if(S&&Date.now()-S.timestamp<Is)return S.data;const F=v.areaCount||0,z=v.completedAreas||0,M=F>0?Math.round(z/F*100):0;return{...v,progress:M,areas:[],totalTickets:v.ticketCount||0,pendingTickets:v.pendingTicketCount||0,approvedTickets:v.approvedTicketCount||0,dailyReportsCount:v.dailyReportsThisWeek||0,recentDailyReports:v.dailyReportsThisWeek||0,corTotalCount:v.corCount||0,billable:0,changeOrderValue:0,revisedContractValue:v.contract_value||0,changeOrderPending:0,tmTickets:[],injuryReportsCount:0,lastDailyReport:null,isValueBased:!1,earnedValue:0,totalSOVValue:0,laborCost:0,laborDaysWorked:0,laborManDays:0,laborByDate:[],dailyBurn:0,materialsEquipmentCost:0,materialsEquipmentByDate:[],haulOffCost:0,haulOffLoads:0,haulOffDays:0,haulOffByType:{},haulOffByDate:[],customCosts:[],customCostTotal:0,totalBurn:0,totalBurnDays:0,allCostsTotal:0,currentProfit:0,profitMargin:0,corPendingValue:0,corPendingCount:0,corApprovedValue:0,corBilledValue:0,corStats:null,scheduleStatus:"on_track",scheduleVariance:0,scheduleLabel:"On Track",laborStatus:"on_track",laborVariance:0,laborLabel:null,hasScheduleData:!1,hasLaborData:!1,actualManDays:0,hasError:!1,_detailsLoaded:!1}});m(b)}catch(u){console.error("Error loading projects:",u),a("Error loading projects","error")}finally{D(!1)}},fs=async u=>{try{const b=await $.getAreas(u);y(b)}catch(b){console.error("Error loading areas:",b)}},Qe=async u=>{if(g(u),!u._detailsLoaded){const b=await ia(u);m(v=>v.map(S=>S.id===u.id?b:S)),g(b)}},Bs=()=>{g(null),y([]),I(!1),P(null),V("overview"),$e()},Ws=()=>{P({name:c.name,job_number:c.job_number||"",address:c.address||"",general_contractor:c.general_contractor||"",client_contact:c.client_contact||"",client_phone:c.client_phone||"",contract_value:c.contract_value,work_type:c.work_type||"demolition",job_type:c.job_type||"standard",pin:c.pin||"",default_dump_site_id:c.default_dump_site_id||"",areas:f.map(u=>({id:u.id,name:u.name,weight:u.weight,isNew:!1}))}),I(!0)},la=()=>{I(!1),P(null)},oe=(u,b)=>{P(v=>({...v,[u]:b}))},Us=(u,b,v)=>{P(S=>({...S,areas:S.areas.map((F,z)=>z===u?{...F,[b]:v}:F)}))},ca=()=>{P(u=>({...u,areas:[...u.areas,{id:null,name:"",weight:"",isNew:!0}]}))},oa=u=>{x.areas.length>1&&P(b=>({...b,areas:b.areas.filter((v,S)=>S!==u)}))},da=async()=>{if(!x.name.trim()){a("Please enter a project name","error");return}const u=parseFloat(x.contract_value);if(!u||u<=0){a("Please enter a valid contract value","error");return}if(x.pin&&x.pin.length!==4){a("PIN must be 4 digits","error");return}if(x.pin&&x.pin!==c.pin&&!await $.isPinAvailable(x.pin,c.id)){a("This PIN is already in use","error");return}const b=x.areas.filter(S=>S.name.trim()&&parseFloat(S.weight)>0);if(b.length===0){a("Please add at least one area","error");return}if(b.reduce((S,F)=>S+parseFloat(F.weight),0)!==100){a("Area weights must total 100%","error");return}G(!0);try{await $.updateProject(c.id,{name:x.name.trim(),job_number:x.job_number?.trim()||null,address:x.address?.trim()||null,general_contractor:x.general_contractor?.trim()||null,client_contact:x.client_contact?.trim()||null,client_phone:x.client_phone?.trim()||null,contract_value:u,work_type:x.work_type||"demolition",job_type:x.job_type||"standard",pin:x.pin||null,default_dump_site_id:x.default_dump_site_id||null},s?.id);const S=f.map(M=>M.id),F=x.areas.filter(M=>M.id).map(M=>M.id);for(const M of S)F.includes(M)||await $.deleteArea(M);for(let M=0;M<b.length;M++){const U=b[M];U.id?await $.updateArea(U.id,{name:U.name.trim(),weight:parseFloat(U.weight),sort_order:M}):await $.createArea({project_id:c.id,name:U.name.trim(),weight:parseFloat(U.weight),status:"not_started",sort_order:M})}const z=await $.getProject(c.id);g(z),await fs(c.id),I(!1),P(null),a("Project updated!","success")}catch(S){console.error("Error saving project:",S?.message||S),a(S?.message||"Error saving changes","error")}finally{G(!1)}},ua=async()=>{if(confirm("Are you sure you want to delete this project? This cannot be undone."))try{await $.deleteProject(c.id),a("Project deleted","success"),Bs()}catch(u){console.error("Error deleting project:",u),a("Error deleting project","error")}},p=o.useMemo(()=>c?h.find(u=>u.id===c.id):null,[c,h]),ma=o.useMemo(()=>{if(!c)return{progress:0,billable:0,isValueBased:!1,earnedValue:0,totalSOVValue:0,changeOrderValue:0,revisedContractValue:0};const u=yt(f),b=u.progress,v=p?.changeOrderValue||0,S=c.contract_value+v,F=u.isValueBased?u.earnedValue:b/100*S;return{progress:b,billable:F,changeOrderValue:v,revisedContractValue:S,isValueBased:u.isValueBased,earnedValue:u.earnedValue,totalSOVValue:u.totalValue}},[c,f,p]),ha=o.useMemo(()=>{const u=h.reduce((H,J)=>H+(J.contract_value||0),0),b=h.reduce((H,J)=>H+(J.changeOrderValue||0),0),v=u+b,S=h.reduce((H,J)=>H+(J.billable||0),0),F=v-S,z=v>0?Math.round(S/v*100):0,M=h.reduce((H,J)=>H+(J.corPendingValue||0),0),U=h.reduce((H,J)=>H+(J.corPendingCount||0),0);return{totalOriginalContract:u,totalChangeOrders:b,totalPortfolioValue:v,totalEarned:S,totalRemaining:F,weightedCompletion:z,totalPendingCORValue:M,totalPendingCORCount:U}},[h]),pa=o.useMemo(()=>{let u=0,b=0,v=0,S=0,F=0;for(const z of h){const M=z.revisedContractValue||z.contract_value;z.progress>=100&&u++,z.progress<100&&z.billable<=M*(z.progress/100)*1.1&&b++,z.billable>M*.9&&z.progress<90&&v++,z.billable>M&&S++,(z.changeOrderValue||0)>0&&F++}return{projectsComplete:u,projectsOnTrack:b,projectsAtRisk:v,projectsOverBudget:S,projectsWithChangeOrders:F}},[h]),xa=o.useMemo(()=>{let u=0,b=0,v=0,S=0,F=0,z=0;for(const M of h)M.hasScheduleData&&(M.scheduleStatus==="ahead"?u++:M.scheduleStatus==="behind"?v++:b++),M.hasLaborData&&(M.laborStatus==="over"?S++:M.laborStatus==="under"?F++:z++);return{scheduleAhead:u,scheduleOnTrack:b,scheduleBehind:v,laborOver:S,laborUnder:F,laborOnTrack:z,hasAnyScheduleData:u+b+v>0,hasAnyLaborData:S+F+z>0}},[h]),Me=o.useMemo(()=>{const u=h.map(v=>{const S={id:v.id,name:v.name,totalCosts:v.totalCosts||0,earnedRevenue:v.billable||0,actualProgress:v.progress||0,expectedProgress:v.expectedProgress||v.progress,pendingCORValue:v.corPendingValue||0,contractValue:v.revisedContractValue||v.contract_value||0,lastReportDate:v.lastDailyReport,recentInjuryCount:v.recentInjuryCount||0,startDate:v.start_date},F=kr(S),z=Sr(F,{...S,name:v.name}),M=_r(S),U=z.map(H=>({...H,projectName:v.name,projectId:v.id}));return{projectId:v.id,projectName:v.name,riskScore:F.score,riskStatus:F.status,riskLabel:F.label,factors:F.factors,alerts:U,projections:M}}),b=u.flatMap(v=>v.alerts).sort((v,S)=>{const F={critical:0,warning:1,info:2};return F[v.type]-F[S.type]});return{projectRisks:u,allAlerts:b,criticalCount:b.filter(v=>v.type==="critical").length,warningCount:b.filter(v=>v.type==="warning").length}},[h]),ja=o.useCallback(({target:u,projectId:b,alert:v})=>{const S=i.find(F=>F.id===b);S&&(g(S),u==="financials"?V("financials"):u==="reports"?V("reports"):u==="cors"?(V("financials"),L("cors")):V("overview"))},[i]);o.useEffect(()=>{const u=async()=>{for(const b of h)if(Dn(b,30))try{await $.archiveProject(b.id),a(`Project "${b.name}" has been auto-archived after 30 days of completion`,"info")}catch(v){console.error("Failed to auto-archive project:",v)}};h.length>0&&u()},[]);const ga=o.useCallback(()=>{Ke(null),He(!0)},[]),fa=o.useCallback(u=>{Ke(u),He(!0)},[]),va=o.useCallback(()=>{Je(null),Ge(!0)},[]),ba=o.useCallback(u=>{Je(u),Ge(!0)},[]),Na=o.useCallback(()=>{ps("full")},[]),ya=o.useCallback(()=>{ee(u=>!u)},[]),wa=o.useCallback(()=>{me(u=>!u)},[]),Hs=o.useCallback(()=>{me(!1)},[]),Ks=o.useCallback(()=>{te(u=>!u)},[]),Ze=o.useCallback(async(u="all")=>{if(c){a("Gathering field data...","info");try{const[b,v,S]=await Promise.all([$.getDailyReports(c.id,365),$.getInjuryReports(c.id),$.getCrewCheckinHistory(c.id,365)]);u==="daily"?await Dr(b||[],c):u==="incidents"?await Rr(v||[],c):u==="crew"?await Er(S||[],c):await Tr({dailyReports:b||[],incidentReports:v||[],crewCheckins:S||[],project:c}),a("PDF exported!","success")}catch(b){console.error("Error exporting field documents:",b),a("Error generating PDF","error")}}},[c,a]),Ca=o.useCallback(()=>{ps("preview")},[]),ka=o.useCallback(()=>{ve("log")},[]),Gs=o.useCallback(()=>{Pe(null),Oe(!0)},[]),Sa=o.useCallback(u=>{Ue(u),We(!0)},[]),_a=o.useCallback(u=>{Pe(u),Oe(!0)},[]),Da=o.useCallback(()=>{xs(!0)},[]),Ra=o.useCallback(async u=>{try{await $.deleteProjectCost(u),$e(),a?.("Cost deleted","success")}catch{a?.("Error deleting cost","error")}},[]),Ea=o.useMemo(()=>({corCount:p?.corStats?.total||0,ticketCount:p?.totalTickets||0,corPending:p?.corStats?.pending||0,ticketPending:p?.pendingTickets||0}),[p?.corStats?.total,p?.totalTickets,p?.corStats?.pending,p?.pendingTickets]),{totalOriginalContract:Ta,totalChangeOrders:Js,totalPortfolioValue:Oa,totalEarned:Pa,totalRemaining:Fa,weightedCompletion:$a,totalPendingCORValue:Ma,totalPendingCORCount:Ys}=ha,{projectsComplete:Qs,projectsOnTrack:Zs,projectsAtRisk:Xs,projectsOverBudget:et,projectsWithChangeOrders:st}=pa,{scheduleAhead:tt,scheduleOnTrack:at,scheduleBehind:nt,laborOver:rt,laborUnder:it,laborOnTrack:lt,hasAnyScheduleData:Aa,hasAnyLaborData:La}=xa;if(w)return e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),"Loading projects..."]});if(c){const{progress:u,billable:b,changeOrderValue:v,revisedContractValue:S,isValueBased:F,earnedValue:z,totalSOVValue:M}=ma;if(q&&x){const j=x.areas.reduce((O,Y)=>O+(parseFloat(Y.weight)||0),0);return e.jsxs("div",{children:[e.jsx("button",{className:"btn btn-secondary btn-small",onClick:la,style:{marginBottom:"1.5rem"},children:"← Cancel"}),e.jsx("h1",{children:"Edit Project"}),e.jsx("p",{className:"subtitle",children:"Update project details"}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Basic Info"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{children:"Project Name *"}),e.jsx("input",{type:"text",value:x.name,onChange:O=>oe("name",O.target.value),placeholder:"e.g., Downtown Office Demolition"})]}),e.jsxs("div",{className:"form-group",style:{flex:1},children:[e.jsx("label",{children:"Job Number"}),e.jsx("input",{type:"text",value:x.job_number,onChange:O=>oe("job_number",O.target.value),placeholder:"e.g., 2024-001"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Address"}),e.jsx("input",{type:"text",value:x.address,onChange:O=>oe("address",O.target.value),placeholder:"123 Main St, City, State 12345"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Client & Contractor"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"General Contractor"}),e.jsx("input",{type:"text",value:x.general_contractor,onChange:O=>oe("general_contractor",O.target.value),placeholder:"e.g., ABC Construction"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Client Contact"}),e.jsx("input",{type:"text",value:x.client_contact,onChange:O=>oe("client_contact",O.target.value),placeholder:"Contact name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Client Phone"}),e.jsx("input",{type:"tel",value:x.client_phone,onChange:O=>oe("client_phone",O.target.value),placeholder:"(555) 123-4567"})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Financials & Settings"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Contract Value ($) *"}),e.jsx("input",{type:"number",value:x.contract_value,onChange:O=>oe("contract_value",O.target.value),placeholder:"0"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Foreman PIN"}),e.jsx("input",{type:"text",value:x.pin,onChange:O=>oe("pin",O.target.value.replace(/\D/g,"").slice(0,4)),placeholder:"4 digits",maxLength:4}),e.jsx("span",{className:"form-hint",children:"Used for field crew access"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Work Type"}),e.jsxs("select",{value:x.work_type,onChange:O=>oe("work_type",O.target.value),children:[e.jsx("option",{value:"demolition",children:"Demolition"}),e.jsx("option",{value:"environmental",children:"Environmental"})]}),e.jsx("span",{className:"form-hint",children:"Affects labor rate calculations"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Type"}),e.jsxs("select",{value:x.job_type,onChange:O=>oe("job_type",O.target.value),children:[e.jsx("option",{value:"standard",children:"Standard"}),e.jsx("option",{value:"prevailing_wage",children:"Prevailing Wage"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Default Dump Site"}),e.jsxs("select",{value:x.default_dump_site_id,onChange:O=>oe("default_dump_site_id",O.target.value),children:[e.jsx("option",{value:"",children:"-- Select Dump Site --"}),$s.map(O=>e.jsx("option",{value:O.id,children:O.name},O.id))]}),e.jsx("span",{className:"form-hint",children:"Used for haul-off tracking and cost estimates"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Areas"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.9rem",marginBottom:"1rem"},children:"Weights must total 100%."}),x.areas.map((O,Y)=>e.jsxs("div",{className:"area-row",children:[e.jsx("input",{type:"text",placeholder:"Area name",value:O.name,onChange:xe=>Us(Y,"name",xe.target.value)}),e.jsx("input",{type:"number",placeholder:"%",value:O.weight,onChange:xe=>Us(Y,"weight",xe.target.value)}),e.jsx("button",{className:"remove-btn",onClick:()=>oa(Y),children:"×"})]},Y)),e.jsxs("div",{className:"weight-total",children:[e.jsx("span",{className:"weight-total-label",children:"Total Weight:"}),e.jsxs("span",{className:`weight-total-value ${j===100?"valid":"invalid"}`,children:[j,"%"]})]}),e.jsx("button",{className:"btn btn-secondary",onClick:ca,children:"+ Add Area"})]}),e.jsx("div",{style:{display:"flex",gap:"1rem",marginBottom:"1rem"},children:e.jsx("button",{className:"btn btn-primary",onClick:da,disabled:k,style:{flex:1},children:k?"Saving...":"Save Changes"})}),e.jsx("button",{className:"btn btn-danger btn-full",onClick:ua,children:"Delete Project"})]})}const U=f.filter(j=>j.status==="done").length,H=f.filter(j=>j.status==="working").length,J=f.filter(j=>j.status==="not_started").length,be=(p?.pendingTickets||0)+(p?.changeOrderPending||0),Xe=[{id:"overview",label:"Overview",Icon:kt},{id:"financials",label:"Financials",Icon:Le,badge:be},{id:"reports",label:"Reports",Icon:ue},{id:"documents",label:"Documents",Icon:Es},{id:"info",label:"Info",Icon:is}];return e.jsxs("div",{className:"project-view tabbed",children:[e.jsxs("div",{className:"pv-sticky-header",children:[e.jsxs("div",{className:"pv-header-row",children:[e.jsxs("button",{className:"pv-back",onClick:Bs,children:[e.jsx("span",{children:"←"}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"pv-actions",children:[e.jsx("button",{className:"pv-action",onClick:()=>ce(!0),children:"Share"}),e.jsx("button",{className:"pv-action",onClick:()=>C(!0),children:"Alerts"}),e.jsx("button",{className:"pv-action",onClick:Ws,children:"Edit"})]})]}),e.jsxs("div",{className:"pv-header-title",children:[e.jsx("h1",{children:c.name}),(c.job_number||c.work_type)&&e.jsxs("span",{className:"pv-header-meta",children:[c.job_number&&`Job #${c.job_number}`,c.job_number&&c.work_type&&" • ",c.work_type]})]}),e.jsxs("div",{className:"pv-metrics-bar",children:[e.jsxs("div",{className:"pv-metric",children:[e.jsxs("span",{className:"pv-metric-value",children:[u,"%"]}),e.jsx("span",{className:"pv-metric-label",children:"Complete"})]}),e.jsx("div",{className:"pv-metric-divider"}),e.jsxs("div",{className:"pv-metric",children:[e.jsx("span",{className:"pv-metric-value",children:Q(b)}),e.jsx("span",{className:"pv-metric-label",children:"Billed"})]}),e.jsx("div",{className:"pv-metric-divider"}),e.jsxs("div",{className:"pv-metric",children:[e.jsx("span",{className:"pv-metric-value highlight",children:Q(S-b)}),e.jsx("span",{className:"pv-metric-label",children:"Remaining"})]})]}),e.jsx("div",{className:"pv-tabs",children:Xe.map(j=>e.jsxs("button",{className:`pv-tab ${A===j.id?"active":""} ${j.badge>0?"has-badge":""}`,onClick:()=>V(j.id),children:[e.jsx(j.Icon,{size:16,className:"pv-tab-icon"}),e.jsx("span",{className:"pv-tab-label",children:j.label}),j.badge>0&&e.jsx("span",{className:"pv-tab-badge",children:j.badge})]},j.id))})]}),e.jsxs("div",{className:"pv-tab-content",children:[A==="overview"&&e.jsxs("div",{className:"pv-tab-panel overview-tab animate-fade-in",children:[e.jsxs("div",{className:"overview-hero-split",children:[e.jsx(Lr,{progress:u,areasComplete:U,totalAreas:f.length,areasWorking:H}),e.jsx(OverviewFinancialCard,{earnedRevenue:b,totalCosts:p?.allCostsTotal||0,laborCost:p?.laborCost||0,disposalCost:p?.haulOffCost||0,equipmentCost:p?.materialsEquipmentCost||0,materialsCost:0,otherCost:p?.customCostTotal||0,contractValue:S})]}),e.jsxs("div",{className:"overview-two-col",children:[e.jsx(OverviewCrewMetrics,{project:c,onShowToast:a}),e.jsxs("div",{className:"overview-section-card overview-work-areas-card",children:[e.jsxs("div",{className:"section-card-header",children:[e.jsx("h3",{children:"Work Areas"}),e.jsxs("div",{className:"section-card-badges",children:[U>0&&e.jsxs("span",{className:"section-badge done",children:[U," Done"]}),H>0&&e.jsxs("span",{className:"section-badge working",children:[H," Active"]}),J>0&&e.jsxs("span",{className:"section-badge pending",children:[J," Pending"]})]})]}),e.jsx("div",{className:"work-areas-list work-areas-scroll stagger-areas",children:f.map(j=>e.jsxs("div",{className:`work-area-item ${j.status}`,children:[e.jsxs("div",{className:"work-area-status",children:[j.status==="done"&&e.jsx("span",{className:"status-icon done",children:"✓"}),j.status==="working"&&e.jsx("span",{className:"status-icon working",children:"●"}),j.status==="not_started"&&e.jsx("span",{className:"status-icon pending",children:"○"})]}),e.jsxs("div",{className:"work-area-info",children:[e.jsx("span",{className:"work-area-name",children:j.name}),e.jsx("span",{className:"work-area-weight",children:j.scheduled_value?Q(j.scheduled_value):`${j.weight}%`})]}),e.jsx("div",{className:"work-area-bar",children:e.jsx("div",{className:`work-area-fill ${j.status}`,style:{width:j.status==="done"?"100%":j.status==="working"?"50%":"0%"}})})]},j.id))})]})]}),e.jsxs("div",{className:"overview-bottom-strip",children:[(p?.pendingTickets>0||p?.changeOrderPending>0||p?.pendingMaterialRequests>0||p?.urgentMaterialRequests>0)&&e.jsxs("div",{className:"overview-attention-inline",children:[p?.urgentMaterialRequests>0&&e.jsxs("div",{className:"attention-chip warning",onClick:()=>V("reports"),children:[e.jsx(AlertTriangle,{size:14}),e.jsxs("span",{children:[p.urgentMaterialRequests," urgent material request",p.urgentMaterialRequests!==1?"s":""]})]}),p?.pendingMaterialRequests>0&&!p?.urgentMaterialRequests&&e.jsxs("div",{className:"attention-chip info",onClick:()=>V("reports"),children:[e.jsx(Package,{size:14}),e.jsxs("span",{children:[p.pendingMaterialRequests," material request",p.pendingMaterialRequests!==1?"s":""," pending"]})]}),p?.pendingTickets>0&&e.jsxs("div",{className:"attention-chip warning",onClick:()=>V("financials"),children:[e.jsx(ue,{size:14}),e.jsxs("span",{children:[p.pendingTickets," T&M pending"]})]}),p?.changeOrderPending>0&&e.jsxs("div",{className:"attention-chip info",onClick:()=>V("financials"),children:[e.jsx(FileText,{size:14}),e.jsxs("span",{children:[p.changeOrderPending," CO pending"]})]})]}),e.jsxs("div",{className:"overview-quick-actions",children:[e.jsxs("button",{className:"overview-action-btn",onClick:()=>V("reports"),children:[e.jsx(ue,{size:15}),e.jsxs("span",{children:[p?.dailyReportsCount||0," Reports"]})]}),e.jsxs("button",{className:"overview-action-btn",onClick:()=>V("financials"),children:[e.jsx(Le,{size:15}),e.jsxs("span",{children:[p?.totalTickets||0," T&M Tickets"]})]}),e.jsx("span",{className:"overview-action-divider"}),e.jsxs("button",{className:"overview-action-btn export",onClick:()=>Ze("all"),children:[e.jsx(we,{size:15}),e.jsx("span",{children:"Export All Docs"})]}),e.jsxs("button",{className:"overview-action-btn export",onClick:()=>Ze("daily"),children:[e.jsx(we,{size:14}),e.jsx("span",{children:"Daily"})]}),e.jsxs("button",{className:"overview-action-btn export",onClick:()=>Ze("incidents"),children:[e.jsx(we,{size:14}),e.jsx("span",{children:"Incidents"})]}),e.jsxs("button",{className:"overview-action-btn export",onClick:()=>Ze("crew"),children:[e.jsx(we,{size:14}),e.jsx("span",{children:"Crew"})]})]})]})]}),A==="financials"&&e.jsxs("div",{className:"pv-tab-panel financials-tab",children:[e.jsxs("div",{className:"export-actions",style:{display:"flex",gap:"8px",marginLeft:"auto",marginBottom:"12px",justifyContent:"flex-end"},children:[e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Or(c,{earnedRevenue:b,approvedCORs:p?.cors?.filter(j=>j.status==="approved"),laborByDate:p?.laborByDate,haulOffByDate:p?.haulOffByDate,customCosts:p?.customCosts}),children:[e.jsx(we,{size:14})," Export CSV"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Pr(c,{totalLaborCost:p?.totalLaborCost||0,totalDisposalCost:p?.totalDisposalCost||0}),children:[e.jsx(we,{size:14})," QuickBooks"]})]}),e.jsx(HeroMetrics,{contractValue:c?.contract_value||0,earnedRevenue:b,totalCosts:p?.allCostsTotal||0,profit:p?.currentProfit||0,progress:u,corApprovedValue:v,loading:!p}),e.jsxs("div",{className:`financials-layout ${N?"sidebar-collapsed":""}`,children:[e.jsxs("button",{className:"financials-mobile-menu-toggle",onClick:wa,"aria-label":"Open navigation menu",title:"Open navigation menu",children:[e.jsx(Menu,{size:20}),e.jsx("span",{children:"Menu"})]}),_&&e.jsx("div",{className:"financials-sidebar-overlay",onClick:Hs,"aria-hidden":"true"}),e.jsx("div",{className:`financials-sidebar ${N?"collapsed":""} ${_?"mobile-open":""}`,children:e.jsx(FinancialsNav,{activeSection:R,onSectionChange:j=>{L(j),me(!1)},collapsed:N,onToggleCollapse:ya,onMobileClose:Hs,stats:Ea})}),e.jsxs("div",{className:"financials-main",children:[R==="overview"&&e.jsxs("div",{className:"financials-overview animate-fade-in",children:[e.jsx(FinancialTrendChart,{projectData:p,project:c,tmTickets:p?.tmTickets||[],corStats:p?.corStats,areas:f}),e.jsxs("div",{className:"financials-analysis-row stagger-children",children:[e.jsx(BurnRateCard,{dailyBurn:p?.dailyBurn||0,totalBurn:p?.totalBurn||0,daysWorked:p?.totalBurnDays||0,laborCost:p?.laborCost||0,materialsEquipmentCost:p?.materialsEquipmentCost||0,progress:u,contractValue:S,laborByDate:p?.laborByDate||[],materialsEquipmentByDate:p?.materialsEquipmentByDate||[]}),e.jsx(ProfitabilityCard,{revenue:b,totalCosts:p?.allCostsTotal||0,contractValue:S,progress:u})]}),e.jsxs("div",{className:"cost-disposal-row",children:[e.jsx(CostContributorsCard,{laborCost:p?.laborCost||0,haulOffCost:p?.haulOffCost||0,customCosts:p?.customCosts||[],onAddCost:Da,onDeleteCost:Ra}),e.jsx(DisposalSummary,{project:c,period:"week"})]}),e.jsx(ProjectEquipmentCard,{project:c,onAddEquipment:ga,onEditEquipment:fa,onShowToast:a},Jt),e.jsx(ProgressBillingCard,{project:c,areas:f,corStats:p?.corStats,onCreateDraw:va,onViewDraw:ba,onShowToast:a},Zt),e.jsxs("details",{className:"financials-details",children:[e.jsxs("summary",{className:"financials-details-summary",children:[e.jsx(qe,{size:16}),e.jsx("span",{children:"Labor Details"}),e.jsx("span",{className:"financials-details-value",children:Q(p?.laborCost||0)})]}),e.jsx("div",{className:"financials-details-content",children:e.jsx(ManDayCosts,{project:c,company:s,onShowToast:a})})]})]}),R==="cors"&&e.jsxs("div",{className:"financials-cors animate-fade-in",children:[e.jsx("div",{className:"financials-section cor-section-primary",children:e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(CORLogPreview,{project:c,onShowToast:a,onToggleList:Ks,showingList:fe,onViewFullLog:ka,onCreateCOR:Gs})})}),fe&&e.jsx("div",{className:"financials-section cor-section-list animate-fade-in",style:{marginTop:"1rem"},children:e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(CORList,{project:c,company:s,areas:f,refreshKey:Ut,onShowToast:a,previewMode:!1,onViewAll:Ks,onDisplayModeChange:ve,onCreateCOR:Gs,onViewCOR:Sa,onEditCOR:_a})})})]}),R==="tickets"&&e.jsx("div",{className:"financials-tickets animate-fade-in",children:e.jsxs("div",{className:"financials-section tm-section",children:[Te==="full"&&e.jsx("button",{className:"section-back-btn",onClick:Ca,children:"← Back to summary"}),e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(TMList,{project:c,company:s,onShowToast:a,compact:Te==="preview",previewMode:Te==="preview",onViewAll:Na})})]})}),R==="billing"&&e.jsx("div",{className:"financials-billing animate-fade-in",children:e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(BillingCenter,{project:c,company:s,user:t,onShowToast:a})})})]})]})]}),A==="reports"&&e.jsxs("div",{className:"pv-tab-panel reports-tab",children:[e.jsx("div",{className:"reports-hero",children:e.jsxs("div",{className:"reports-hero-grid",children:[e.jsxs("div",{className:"reports-metric primary",children:[e.jsx("div",{className:"reports-metric-icon",children:e.jsx(ue,{size:24})}),e.jsxs("div",{className:"reports-metric-content",children:[e.jsx("div",{className:"reports-metric-value",children:p?.dailyReportsCount||0}),e.jsx("div",{className:"reports-metric-label",children:"Daily Reports"})]})]}),e.jsxs("div",{className:"reports-metric",children:[e.jsx("div",{className:"reports-metric-value",children:p?.recentDailyReports||0}),e.jsx("div",{className:"reports-metric-label",children:"This Week"}),e.jsx("div",{className:"reports-metric-bar",children:e.jsx("div",{className:"reports-metric-fill",style:{width:`${Math.min((p?.recentDailyReports||0)/7*100,100)}%`}})})]}),e.jsxs("div",{className:"reports-metric",children:[e.jsx("div",{className:"reports-metric-value",children:p?.totalTickets||0}),e.jsx("div",{className:"reports-metric-label",children:"T&M Tickets"}),(p?.pendingTickets||0)>0&&e.jsxs("div",{className:"reports-metric-status",style:{background:"#fef3c7",color:"#92400e"},children:[p.pendingTickets," pending"]})]}),e.jsxs("div",{className:"reports-metric",children:[e.jsx("div",{className:"reports-metric-value",children:p?.totalPhotosFromTickets||0}),e.jsx("div",{className:"reports-metric-label",children:"Photos Captured"})]})]})}),e.jsxs("div",{className:"reports-two-col",children:[e.jsxs("div",{className:"reports-insight-card",children:[e.jsx("div",{className:"reports-insight-header",children:e.jsxs("div",{className:"reports-insight-title",children:[e.jsx(Users,{size:18}),e.jsx("h3",{children:"Crew Analytics"})]})}),e.jsxs("div",{className:"reports-insight-body",children:[e.jsxs("div",{className:"reports-stat-grid",children:[e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.uniqueWorkerCount||0}),e.jsx("span",{className:"reports-stat-label",children:"Total Workers"})]}),e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.avgCrewSize||0}),e.jsx("span",{className:"reports-stat-label",children:"Avg Crew / Day"})]}),e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.peakCrewSize||0}),e.jsx("span",{className:"reports-stat-label",children:"Peak Crew Size"})]}),e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.crewDaysTracked||0}),e.jsx("span",{className:"reports-stat-label",children:"Days Tracked"})]})]}),(p?.crewTrend||0)!==0&&e.jsxs("div",{className:`reports-trend-badge ${p.crewTrend>0?"up":"down"}`,children:[p.crewTrend>0?e.jsx(TrendingUp,{size:14}):e.jsx(TrendingDown,{size:14}),e.jsxs("span",{children:[Math.abs(Math.round(p.crewTrend)),"% ",p.crewTrend>0?"increase":"decrease"," vs prior week"]})]}),p?.crewByDate&&Object.keys(p.crewByDate).length>0&&e.jsxs("div",{className:"reports-mini-chart",children:[e.jsx("div",{className:"reports-mini-chart-label",children:"Recent Crew Size"}),e.jsx("div",{className:"reports-mini-bars",children:Object.keys(p.crewByDate).sort().slice(-14).map(j=>{const O=p.crewByDate[j],Y=p.peakCrewSize||1;return e.jsx("div",{className:"reports-mini-bar-wrap",title:`${new Date(j+"T12:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"})}: ${O} workers`,children:e.jsx("div",{className:"reports-mini-bar",style:{height:`${O/Y*100}%`}})},j)})})]})]})]}),e.jsxs("div",{className:"reports-insight-card",children:[e.jsxs("div",{className:"reports-insight-header",children:[e.jsxs("div",{className:"reports-insight-title",children:[e.jsx(Shield,{size:18}),e.jsx("h3",{children:"Safety Dashboard"})]}),e.jsx("span",{className:`reports-section-badge ${(p?.injuryReportsCount||0)>0?"warning":"success"}`,children:(p?.injuryReportsCount||0)>0?`${p.injuryReportsCount} incident${p.injuryReportsCount!==1?"s":""}`:"No incidents"})]}),e.jsxs("div",{className:"reports-insight-body",children:[e.jsx("div",{className:"reports-safety-hero",children:e.jsxs("div",{className:`reports-safety-days ${p?.daysSinceLastInjury===null||p?.daysSinceLastInjury>30?"excellent":p?.daysSinceLastInjury>7?"good":"caution"}`,children:[e.jsx("span",{className:"reports-safety-days-value",children:p?.daysSinceLastInjury!==null?p.daysSinceLastInjury:"--"}),e.jsx("span",{className:"reports-safety-days-label",children:p?.daysSinceLastInjury!==null?"Days Since Last Incident":"No Incidents Recorded"})]})}),e.jsxs("div",{className:"reports-stat-grid",children:[e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.injuryReportsCount||0}),e.jsx("span",{className:"reports-stat-label",children:"Total Incidents"})]}),e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.oshaRecordable||0}),e.jsx("span",{className:"reports-stat-label",children:"OSHA Recordable"})]}),e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.reportsWithIssues||0}),e.jsx("span",{className:"reports-stat-label",children:"Reports w/ Issues"})]}),e.jsxs("div",{className:"reports-stat",children:[e.jsx("span",{className:"reports-stat-value",children:p?.laborManDays||0}),e.jsx("span",{className:"reports-stat-label",children:"Total Man-Days"})]})]})]})]})]}),e.jsxs("div",{className:"reports-two-col",children:[e.jsxs("div",{className:"reports-insight-card",children:[e.jsxs("div",{className:"reports-insight-header",children:[e.jsxs("div",{className:"reports-insight-title",children:[e.jsx(Package,{size:18}),e.jsx("h3",{children:"Material Requests"})]}),e.jsxs("span",{className:"reports-section-count",children:[p?.totalMaterialRequests||0," total"]})]}),e.jsx("div",{className:"reports-insight-body",children:(p?.totalMaterialRequests||0)===0?e.jsxs("div",{className:"reports-empty-state",children:[e.jsx(Package,{size:32}),e.jsx("p",{children:"No material requests yet"}),e.jsx("span",{children:"Requests from the field will appear here"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"reports-material-pipeline",children:[p?.urgentMaterialRequests>0&&e.jsxs("div",{className:"reports-material-status urgent",children:[e.jsx(AlertTriangle,{size:14}),e.jsxs("span",{children:[p.urgentMaterialRequests," Urgent"]})]}),e.jsxs("div",{className:"reports-material-status pending",children:[e.jsx("span",{className:"reports-material-dot"}),e.jsxs("span",{children:[p?.pendingMaterialRequests||0," Pending"]})]}),e.jsxs("div",{className:"reports-material-status ordered",children:[e.jsx("span",{className:"reports-material-dot"}),e.jsxs("span",{children:[p?.orderedMaterialRequests||0," Ordered"]})]}),e.jsxs("div",{className:"reports-material-status delivered",children:[e.jsx(CheckCircle2,{size:14}),e.jsxs("span",{children:[p?.deliveredMaterialRequests||0," Delivered"]})]})]}),e.jsx("div",{className:"reports-recent-list",children:(p?.materialRequests||[]).slice(0,3).map(j=>e.jsxs("div",{className:`reports-recent-item ${j.status}`,children:[e.jsxs("div",{className:"reports-recent-item-main",children:[e.jsx("span",{className:`reports-recent-item-status ${j.status}`,children:j.status}),e.jsx("span",{className:"reports-recent-item-date",children:new Date(j.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),e.jsxs("div",{className:"reports-recent-item-detail",children:[(j.items||[]).slice(0,2).map((O,Y)=>e.jsxs("span",{children:[O.name,O.quantity?` (${O.quantity})`:""]},Y)),(j.items||[]).length>2&&e.jsxs("span",{className:"reports-recent-more",children:["+",(j.items||[]).length-2," more"]})]}),j.priority==="urgent"&&e.jsx("span",{className:"reports-urgent-tag",children:"URGENT"})]},j.id))})]})})]}),e.jsxs("div",{className:"reports-insight-card",children:[e.jsxs("div",{className:"reports-insight-header",children:[e.jsxs("div",{className:"reports-insight-title",children:[e.jsx(Os,{size:18}),e.jsx("h3",{children:"Disposal Trends"})]}),e.jsxs("span",{className:"reports-section-count",children:[p?.disposalTotalLoads||0," loads"]})]}),e.jsx("div",{className:"reports-insight-body",children:(p?.weeklyDisposal||[]).length===0?e.jsxs("div",{className:"reports-empty-state",children:[e.jsx(Os,{size:32}),e.jsx("p",{children:"No disposal data yet"}),e.jsx("span",{children:"Disposal loads from the field will appear here"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"reports-disposal-chart",children:[e.jsx("div",{className:"reports-disposal-bars",children:(p?.weeklyDisposal||[]).map((j,O)=>{const Y=(j.concrete||0)+(j.trash||0)+(j.metals||0)+(j.hazardous_waste||0),xe=Math.max(...(p?.weeklyDisposal||[]).map(de=>(de.concrete||0)+(de.trash||0)+(de.metals||0)+(de.hazardous_waste||0)))||1;return e.jsxs("div",{className:"reports-disposal-bar-col",children:[e.jsxs("div",{className:"reports-disposal-bar-stack",style:{height:`${Y/xe*100}%`},children:[j.concrete>0&&e.jsx("div",{className:"reports-disposal-seg concrete",style:{flex:j.concrete},title:`Concrete: ${j.concrete}`}),j.trash>0&&e.jsx("div",{className:"reports-disposal-seg trash",style:{flex:j.trash},title:`Trash: ${j.trash}`}),j.metals>0&&e.jsx("div",{className:"reports-disposal-seg metals",style:{flex:j.metals},title:`Metals: ${j.metals}`}),j.hazardous_waste>0&&e.jsx("div",{className:"reports-disposal-seg hazardous",style:{flex:j.hazardous_waste},title:`Hazardous: ${j.hazardous_waste}`})]}),e.jsx("span",{className:"reports-disposal-bar-label",children:new Date(j.week+"T12:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"})})]},O)})}),e.jsxs("div",{className:"reports-disposal-legend",children:[e.jsxs("span",{className:"reports-disposal-legend-item",children:[e.jsx("span",{className:"reports-disposal-dot concrete"}),"Concrete"]}),e.jsxs("span",{className:"reports-disposal-legend-item",children:[e.jsx("span",{className:"reports-disposal-dot trash"}),"Trash"]}),e.jsxs("span",{className:"reports-disposal-legend-item",children:[e.jsx("span",{className:"reports-disposal-dot metals"}),"Metals"]}),e.jsxs("span",{className:"reports-disposal-legend-item",children:[e.jsx("span",{className:"reports-disposal-dot hazardous"}),"Hazardous"]})]})]}),(p?.haulOffCost||0)>0&&e.jsxs("div",{className:"reports-disposal-cost",children:[e.jsx("span",{children:"Total Disposal Cost"}),e.jsx("strong",{children:Q(p.haulOffCost)})]})]})})]})]}),e.jsxs("div",{className:"reports-insight-card reports-activity-summary",children:[e.jsxs("div",{className:"reports-insight-header",children:[e.jsxs("div",{className:"reports-insight-title",children:[e.jsx(ue,{size:18}),e.jsx("h3",{children:"Field Activity Summary"})]}),e.jsx("div",{className:"reports-activity-badges",children:p?.lastDailyReport&&e.jsxs("span",{className:"reports-last-filed",children:["Last report: ",new Date(p.lastDailyReport).toLocaleDateString("en-US",{month:"short",day:"numeric"})," ","(",Math.floor((new Date-new Date(p.lastDailyReport))/(1e3*60*60*24)),"d ago)"]})})]}),e.jsx("div",{className:"reports-insight-body",children:e.jsxs("div",{className:"reports-activity-grid",children:[e.jsxs("div",{className:"reports-activity-stat",children:[e.jsx("div",{className:"reports-activity-stat-icon",children:e.jsx(ue,{size:16})}),e.jsxs("div",{className:"reports-activity-stat-info",children:[e.jsx("strong",{children:p?.dailyReportsCount||0}),e.jsx("span",{children:"Daily Reports Filed"})]})]}),e.jsxs("div",{className:"reports-activity-stat",children:[e.jsx("div",{className:"reports-activity-stat-icon",children:e.jsx(FileText,{size:16})}),e.jsxs("div",{className:"reports-activity-stat-info",children:[e.jsx("strong",{children:p?.totalTickets||0}),e.jsx("span",{children:"T&M Tickets Created"})]})]}),e.jsxs("div",{className:"reports-activity-stat",children:[e.jsx("div",{className:"reports-activity-stat-icon",children:e.jsx(Camera,{size:16})}),e.jsxs("div",{className:"reports-activity-stat-info",children:[e.jsx("strong",{children:p?.totalPhotosFromTickets||0}),e.jsx("span",{children:"Photos Documented"})]})]}),e.jsxs("div",{className:"reports-activity-stat",children:[e.jsx("div",{className:"reports-activity-stat-icon",children:e.jsx(qe,{size:16})}),e.jsxs("div",{className:"reports-activity-stat-info",children:[e.jsxs("strong",{children:[p?.completedAreasCount||0,"/",f.length]}),e.jsx("span",{children:"Work Areas Complete"})]})]}),e.jsxs("div",{className:"reports-activity-stat",children:[e.jsx("div",{className:"reports-activity-stat-icon",children:e.jsx(Le,{size:16})}),e.jsxs("div",{className:"reports-activity-stat-info",children:[e.jsx("strong",{children:Q(p?.allCostsTotal||0)}),e.jsx("span",{children:"Total Costs Tracked"})]})]}),e.jsxs("div",{className:"reports-activity-stat",children:[e.jsx("div",{className:"reports-activity-stat-icon",children:e.jsx(Users,{size:16})}),e.jsxs("div",{className:"reports-activity-stat-info",children:[e.jsx("strong",{children:p?.laborManDays||0}),e.jsx("span",{children:"Total Man-Days"})]})]})]})})]}),e.jsxs("div",{className:"reports-section-card",children:[e.jsxs("div",{className:"reports-section-header",children:[e.jsxs("div",{className:"reports-section-title",children:[e.jsx(ue,{size:18}),e.jsx("h3",{children:"Daily Reports"})]}),e.jsxs("span",{className:"reports-section-count",children:[p?.dailyReportsCount||0," total"]})]}),e.jsx("div",{className:"reports-section-content",children:e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(DailyReportsList,{project:c,company:s,onShowToast:a})})})]}),e.jsxs("div",{className:`reports-section-card ${(p?.injuryReportsCount||0)>0?"has-warning":""}`,children:[e.jsxs("div",{className:"reports-section-header",children:[e.jsxs("div",{className:"reports-section-title",children:[e.jsx("span",{className:`reports-section-icon ${(p?.injuryReportsCount||0)>0?"warning":"success"}`,children:(p?.injuryReportsCount||0)>0?"⚠":"✓"}),e.jsx("h3",{children:"Safety & Injury Reports"})]}),e.jsx("span",{className:`reports-section-badge ${(p?.injuryReportsCount||0)>0?"warning":"success"}`,children:(p?.injuryReportsCount||0)>0?`${p.injuryReportsCount} incident${p.injuryReportsCount!==1?"s":""}`:"No incidents"})]}),e.jsx("div",{className:"reports-section-content",children:e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(InjuryReportsList,{project:c,companyId:s?.id||c?.company_id,company:s,user:t,onShowToast:a})})})]})]}),A==="documents"&&e.jsx("div",{className:"pv-tab-panel documents-tab",children:e.jsx(o.Suspense,{fallback:e.jsx(ye,{}),children:e.jsx(Xr,{project:c,companyId:s?.id||c?.company_id,onShowToast:a,userRole:t?.access_level||"office"})})}),A==="info"&&e.jsxs("div",{className:"pv-tab-panel info-tab",children:[e.jsxs("div",{className:"info-hero",children:[e.jsxs("div",{className:"info-hero-content",children:[e.jsxs("div",{className:"info-hero-main",children:[e.jsx("h2",{className:"info-hero-title",children:c.name}),c.job_number&&e.jsxs("span",{className:"info-hero-job",children:["Job #",c.job_number]})]}),e.jsx("button",{className:"btn btn-primary btn-with-icon",onClick:Ws,children:e.jsx("span",{children:"Edit Project"})})]}),c.address&&e.jsxs("div",{className:"info-hero-address",children:[e.jsx(MapPin,{size:14}),e.jsx("span",{children:c.address})]})]}),e.jsxs("div",{className:"info-quick-grid",children:[e.jsxs("div",{className:"info-quick-card",children:[e.jsx("div",{className:"info-quick-icon",children:e.jsx(qe,{size:20})}),e.jsxs("div",{className:"info-quick-content",children:[e.jsx("span",{className:"info-quick-value",children:c.work_type==="environmental"?"Environmental":"Demolition"}),e.jsx("span",{className:"info-quick-label",children:"Work Type"})]})]}),e.jsxs("div",{className:"info-quick-card",children:[e.jsx("div",{className:"info-quick-icon",children:e.jsx(FileText,{size:20})}),e.jsxs("div",{className:"info-quick-content",children:[e.jsx("span",{className:"info-quick-value",children:c.job_type==="prevailing_wage"?"Prevailing Wage":"Standard"}),e.jsx("span",{className:"info-quick-label",children:"Job Type"})]})]}),e.jsxs("div",{className:"info-quick-card highlight",children:[e.jsx("div",{className:"info-quick-icon",children:e.jsx(Le,{size:20})}),e.jsxs("div",{className:"info-quick-content",children:[e.jsx("span",{className:"info-quick-value",children:Q(S)}),e.jsx("span",{className:"info-quick-label",children:v>0?`Incl. +${Q(v)} COs`:"Contract Value"})]})]}),c.pin&&e.jsxs("div",{className:"info-quick-card",children:[e.jsx("div",{className:"info-quick-icon",children:e.jsx("span",{className:"info-pin-icon",children:"#"})}),e.jsxs("div",{className:"info-quick-content",children:[e.jsx("span",{className:"info-quick-value mono",children:c.pin}),e.jsx("span",{className:"info-quick-label",children:"Foreman PIN"})]})]})]}),e.jsxs("div",{className:"info-section-card",children:[e.jsxs("div",{className:"info-section-header",children:[e.jsx(Building2,{size:18}),e.jsx("h3",{children:"Client & Contractor"})]}),e.jsxs("div",{className:"info-section-content",children:[c.general_contractor?e.jsxs("div",{className:"info-detail-row",children:[e.jsx("span",{className:"info-detail-label",children:"General Contractor"}),e.jsx("span",{className:"info-detail-value",children:c.general_contractor})]}):e.jsx("div",{className:"info-detail-row empty",children:e.jsx("span",{className:"info-detail-value",children:"No general contractor specified"})}),c.client_contact&&e.jsxs("div",{className:"info-detail-row",children:[e.jsx("span",{className:"info-detail-label",children:"Client Contact"}),e.jsx("span",{className:"info-detail-value",children:c.client_contact})]}),c.client_phone&&e.jsxs("div",{className:"info-detail-row clickable",children:[e.jsxs("span",{className:"info-detail-label",children:[e.jsx(Phone,{size:14}),"Phone"]}),e.jsx("a",{href:`tel:${c.client_phone}`,className:"info-detail-value link",children:c.client_phone})]})]})]}),e.jsxs("div",{className:"info-section-card",children:[e.jsxs("div",{className:"info-section-header",children:[e.jsx(kt,{size:18}),e.jsx("h3",{children:"Work Areas"}),e.jsxs("div",{className:"info-section-badges",children:[U>0&&e.jsxs("span",{className:"info-badge done",children:[U," Done"]}),H>0&&e.jsxs("span",{className:"info-badge working",children:[H," Active"]}),J>0&&e.jsxs("span",{className:"info-badge pending",children:[J," Pending"]})]})]}),e.jsx("div",{className:"info-areas-list",children:f.map(j=>e.jsxs("div",{className:`info-area-item ${j.status}`,children:[e.jsxs("div",{className:"info-area-status",children:[j.status==="done"&&e.jsx("span",{className:"status-dot done",children:"✓"}),j.status==="working"&&e.jsx("span",{className:"status-dot working",children:"●"}),j.status==="not_started"&&e.jsx("span",{className:"status-dot pending",children:"○"})]}),e.jsxs("div",{className:"info-area-details",children:[e.jsx("span",{className:"info-area-name",children:j.name}),e.jsx("span",{className:`info-area-status-label ${j.status}`,children:j.status==="done"?"Complete":j.status==="working"?"In Progress":"Not Started"})]}),e.jsxs("span",{className:"info-area-weight",children:[j.weight,"%"]})]},j.id))})]}),e.jsx(ProjectTeam,{project:c,company:s,user:t,isAdmin:r,onShowToast:a}),e.jsxs("details",{className:"info-details-section",children:[e.jsxs("summary",{className:"info-details-summary",children:[e.jsx(is,{size:16}),e.jsx("span",{children:"Additional Settings"})]}),e.jsxs("div",{className:"info-details-content",children:[e.jsxs("div",{className:"info-detail-row",children:[e.jsx("span",{className:"info-detail-label",children:"Original Contract"}),e.jsx("span",{className:"info-detail-value",children:Q(c.contract_value)})]}),v>0&&e.jsxs("div",{className:"info-detail-row",children:[e.jsx("span",{className:"info-detail-label",children:"Approved Change Orders"}),e.jsxs("span",{className:"info-detail-value positive",children:["+",Q(v)]})]}),c.default_dump_site_id&&e.jsxs("div",{className:"info-detail-row",children:[e.jsx("span",{className:"info-detail-label",children:"Default Dump Site"}),e.jsx("span",{className:"info-detail-value",children:$s.find(j=>j.id===c.default_dump_site_id)?.name||"Unknown"})]})]})]}),e.jsx("div",{className:"info-section-card",children:e.jsx(MFASetup,{onShowToast:a})})]})]}),ae&&e.jsx(o.Suspense,{fallback:null,children:e.jsx(Ur,{project:c,user:t,onClose:()=>ce(!1),onShareCreated:j=>{a("Share link created successfully!","success")}})}),se&&e.jsx("div",{className:"notification-settings-modal",children:e.jsx(o.Suspense,{fallback:null,children:e.jsx(Hr,{project:c,company:s,onShowToast:a,onClose:()=>C(!1)})})}),Vt&&e.jsx(o.Suspense,{fallback:null,children:e.jsx(Kr,{project:c,company:s,areas:f,existingCOR:Bt,onClose:()=>{Oe(!1),Pe(null)},onSaved:()=>{Oe(!1),Pe(null),As(j=>j+1)},onShowToast:a})}),Wt&&Ms&&e.jsx(o.Suspense,{fallback:null,children:e.jsx(Gr,{cor:Ms,project:c,company:s,areas:f,onClose:()=>{We(!1),Ue(null)},onEdit:j=>{We(!1),Ue(null),Pe(j),Oe(!0)},onShowToast:a,onStatusChange:()=>{}})}),Be==="log"&&c&&e.jsx("div",{className:"cor-log-modal-overlay",onClick:()=>ve("list"),children:e.jsxs("div",{className:"cor-log-modal",onClick:j=>j.stopPropagation(),children:[e.jsxs("div",{className:"cor-log-modal-header",children:[e.jsx("h2",{children:"Change Order Log"}),e.jsx("button",{className:"cor-log-modal-close",onClick:()=>ve("list"),title:"Close",children:"✕"})]}),e.jsx("div",{className:"cor-log-modal-content",children:e.jsx(o.Suspense,{fallback:e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading..."}),children:e.jsx(Jr,{project:c,company:s,onShowToast:a})})})]})}),Ht&&e.jsx(o.Suspense,{fallback:null,children:e.jsx(Zr,{onClose:()=>xs(!1),saving:Kt,onSave:async j=>{try{Ls(!0),await $.addProjectCost(c.id,s.id,j),xs(!1),$e(),a("Cost added successfully","success")}catch(O){console.error("Error adding cost:",O),a("Error adding cost","error")}finally{Ls(!1)}}})}),Gt&&e.jsx(o.Suspense,{fallback:null,children:e.jsx(Qr,{project:c,company:s,user:t,editItem:zs,onSave:()=>{He(!1),Ke(null),Yt(j=>j+1),a(zs?"Equipment updated":"Equipment added","success")},onClose:()=>{He(!1),Ke(null)}})}),Qt&&e.jsx(o.Suspense,{fallback:null,children:e.jsx(Yr,{project:c,company:s,areas:f,corStats:h.find(j=>j.id===c?.id)?.corStats,editDrawRequest:qs,onSave:()=>{Ge(!1),Je(null),Xt(j=>j+1),a(qs?"Draw request updated":"Draw request created","success")},onClose:()=>{Ge(!1),Je(null)}})})]})}return i.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx(ue,{size:48,className:"empty-state-icon"}),e.jsx("h3",{children:"No Projects Yet"}),e.jsx("p",{children:"Create your first project to get started"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"business-overview",children:[e.jsxs("div",{className:"bo-header",children:[e.jsx("h2",{className:"bo-title",children:"Portfolio Overview"}),e.jsxs("button",{className:"search-trigger-btn",onClick:()=>sa(!0),children:[e.jsx($t,{size:16}),e.jsx("span",{children:"Search"}),e.jsx("span",{className:"shortcut",children:"⌘K"})]}),e.jsxs("div",{className:"bo-project-count",children:[i.length," Active Project",i.length!==1?"s":""]})]}),e.jsxs("div",{className:"bo-financial",children:[e.jsx("div",{className:"bo-progress-bar",children:e.jsx("div",{className:"bo-progress-fill",style:{width:`${Math.min($a,100)}%`}})}),e.jsxs("div",{className:"bo-financial-row",children:[e.jsxs("div",{className:"bo-metric primary",children:[e.jsx("span",{className:"bo-metric-value",children:Q(Pa)}),e.jsx("span",{className:"bo-metric-label",children:"Earned Revenue"})]}),e.jsx("div",{className:"bo-metric-separator",children:"of"}),e.jsxs("div",{className:"bo-metric primary",children:[e.jsx("span",{className:"bo-metric-value",children:Q(Oa)}),e.jsx("span",{className:"bo-metric-label",children:"Total Portfolio"})]}),e.jsxs("div",{className:"bo-metric highlight",children:[e.jsx("span",{className:"bo-metric-value",children:Q(Fa)}),e.jsx("span",{className:"bo-metric-label",children:"Remaining to Bill"})]})]}),Js>0&&e.jsxs("div",{className:"bo-change-orders",children:[e.jsxs("div",{className:"bo-co-item",children:[e.jsx("span",{className:"bo-co-label",children:"Original Contracts"}),e.jsx("span",{className:"bo-co-value",children:Q(Ta)})]}),e.jsxs("div",{className:"bo-co-item bo-co-added",children:[e.jsxs("span",{className:"bo-co-label",children:["+ Change Orders (",st," project",st!==1?"s":"",")"]}),e.jsxs("span",{className:"bo-co-value",children:["+",Q(Js)]})]})]}),Ys>0&&e.jsx("div",{className:"bo-pending-cors",children:e.jsxs("div",{className:"bo-pending-cor-item",children:[e.jsx("span",{className:"bo-pending-cor-icon",children:"!"}),e.jsx("span",{className:"bo-pending-cor-label",children:"Pending CORs"}),e.jsx("span",{className:"bo-pending-cor-value",children:Q(Ma)}),e.jsxs("span",{className:"bo-pending-cor-count",children:["(",Ys," pending)"]})]})})]}),e.jsxs("div",{className:"bo-health",children:[e.jsx("div",{className:"bo-health-title",children:"Project Health"}),e.jsxs("div",{className:"bo-health-pills",children:[Qs>0&&e.jsxs("div",{className:"bo-pill complete",children:[e.jsx("span",{className:"bo-pill-count",children:Qs}),e.jsx("span",{className:"bo-pill-label",children:"Complete"})]}),Zs>0&&e.jsxs("div",{className:"bo-pill on-track",children:[e.jsx("span",{className:"bo-pill-count",children:Zs}),e.jsx("span",{className:"bo-pill-label",children:"On Track"})]}),Xs>0&&e.jsxs("div",{className:"bo-pill at-risk",children:[e.jsx("span",{className:"bo-pill-count",children:Xs}),e.jsx("span",{className:"bo-pill-label",children:"At Risk"})]}),et>0&&e.jsxs("div",{className:"bo-pill over-budget",children:[e.jsx("span",{className:"bo-pill-count",children:et}),e.jsx("span",{className:"bo-pill-label",children:"Over Budget"})]})]})]}),Aa&&e.jsxs("div",{className:"bo-schedule",children:[e.jsx("div",{className:"bo-schedule-title",children:"Schedule Performance"}),e.jsxs("div",{className:"bo-schedule-pills",children:[tt>0&&e.jsxs("div",{className:"bo-pill ahead",children:[e.jsx("span",{className:"bo-pill-count",children:tt}),e.jsx("span",{className:"bo-pill-label",children:"Ahead"})]}),at>0&&e.jsxs("div",{className:"bo-pill schedule-on-track",children:[e.jsx("span",{className:"bo-pill-count",children:at}),e.jsx("span",{className:"bo-pill-label",children:"On Track"})]}),nt>0&&e.jsxs("div",{className:"bo-pill behind",children:[e.jsx("span",{className:"bo-pill-count",children:nt}),e.jsx("span",{className:"bo-pill-label",children:"Behind"})]})]}),La&&e.jsxs("div",{className:"bo-labor-summary",children:[e.jsx("span",{className:"bo-labor-label",children:"Man-Days:"}),it>0&&e.jsxs("span",{className:"bo-labor-badge under",children:[it," under"]}),lt>0&&e.jsxs("span",{className:"bo-labor-badge on-track",children:[lt," on track"]}),rt>0&&e.jsxs("span",{className:"bo-labor-badge over",children:[rt," over"]})]})]})]}),Me.allAlerts.length>0&&e.jsxs("div",{className:"smart-alerts-section",style:{marginBottom:"var(--space-lg, 1.5rem)"},children:[e.jsx("div",{className:"smart-alerts-header",style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"var(--space-sm, 0.5rem)"},children:e.jsxs("h3",{style:{fontSize:"var(--font-size-md, 1rem)",fontWeight:"var(--font-weight-semibold, 600)",color:"var(--text-primary)",margin:0},children:["Needs Attention",Me.criticalCount>0&&e.jsxs("span",{style:{marginLeft:"0.5rem",padding:"2px 8px",fontSize:"0.75rem",fontWeight:600,borderRadius:"9999px",background:"var(--status-danger-bg, #7f1d1d)",color:"var(--status-danger, #dc2626)"},children:[Me.criticalCount," critical"]})]})}),e.jsx(Mr,{alerts:Me.allAlerts,onAction:ja,maxVisible:3})]}),e.jsxs("div",{className:"dashboard-header",children:[e.jsx("h2",{children:"Projects"}),e.jsxs("span",{className:"project-count",children:[i.length," active"]})]}),e.jsx("div",{className:"project-list",children:h.map(u=>{const b=Me.projectRisks.find(v=>v.projectId===u.id);return e.jsx(si,{project:u,riskScore:b?.riskScore,riskStatus:b?.riskStatus,onClick:()=>Qe(u)},u.id)})}),e.jsx(Fr,{isOpen:ea,onClose:ta,companyId:s?.id,onSelectProject:u=>{Qe(u)},onSelectTicket:u=>{const b=i.find(v=>v.id===u.project_id);b&&(Qe(b),V("financials"),L("tickets"))},onSelectCOR:u=>{const b=i.find(v=>v.id===u.project_id);b&&(Qe(b),V("financials"),L("cors"),Ue(u),We(!0))},onShowToast:a})]})}function si({project:s,riskScore:t,riskStatus:r,onClick:a}){const n=Rn(s.areas||[]),l=En(s.areas||[]),i=s.contract_value-s.billable,d=s.billable>s.contract_value*.9&&s.progress<90,h={healthy:{bg:"var(--status-success-bg, #064e3b)",color:"var(--status-success, #059669)"},warning:{bg:"var(--status-warning-bg, #78350f)",color:"var(--status-warning, #d97706)"},critical:{bg:"var(--status-danger-bg, #7f1d1d)",color:"var(--status-danger, #dc2626)"}},m=h[r]||h.healthy;return e.jsxs("div",{className:`project-card enhanced ${d?"at-risk":""}`,onClick:a,children:[e.jsxs("div",{className:"project-card-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[typeof t=="number"&&e.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",borderRadius:"50%",fontSize:"0.75rem",fontWeight:700,background:m.bg,color:m.color},title:`Risk Score: ${t}`,"aria-label":`Risk score ${t}, ${r}`,children:t}),e.jsxs("div",{children:[e.jsx("div",{className:"project-card-name",children:s.name}),e.jsx("div",{className:"project-card-value",children:Q(s.contract_value)})]})]}),e.jsx("span",{className:`status-badge ${n}`,children:l})]}),e.jsxs("div",{className:"project-stats-row",children:[e.jsxs("div",{className:"project-stat",children:[e.jsxs("span",{className:"stat-value",children:[s.progress,"%"]}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"project-stat",children:[e.jsx("span",{className:"stat-value",children:Q(s.billable)}),e.jsx("span",{className:"stat-label",children:"Billable"})]}),e.jsxs("div",{className:"project-stat",children:[e.jsx("span",{className:`stat-value ${i<0?"negative":""}`,children:Q(Math.abs(i))}),e.jsx("span",{className:"stat-label",children:i>=0?"Remaining":"Over Budget"})]})]}),e.jsx("div",{className:"mini-progress-bar",children:e.jsx("div",{className:"mini-progress-fill",style:{width:`${s.progress}%`}})}),(s.pendingTickets>0||s.totalTickets>0)&&e.jsxs("div",{className:"project-badges",children:[s.pendingTickets>0&&e.jsxs("span",{className:"badge pending",children:[s.pendingTickets," Pending T&M"]}),s.approvedTickets>0&&e.jsxs("span",{className:"badge approved",children:[s.approvedTickets," Approved T&M"]})]}),s.hasScheduleData&&e.jsxs("div",{className:"project-schedule-badge",children:[e.jsx("span",{className:`schedule-indicator ${s.scheduleStatus}`,children:s.scheduleLabel}),s.hasLaborData&&s.laborLabel&&e.jsx("span",{className:`labor-indicator ${s.laborStatus}`,children:s.laborLabel})]})]})}const ui=Object.freeze(Object.defineProperty({__proto__:null,default:ei},Symbol.toStringTag,{value:"Module"}));export{qr as C,ui as D,oi as E,ye as T,li as a,ci as b,di as c,ii as e};
//# sourceMappingURL=Dashboard-DB2IHQhW.js.map
