import{ar as p,as as e}from"./index-DSK1B-ZX.js";import{r as i,X as Z,j as q,e as b,aT as _,b as $,g as z,aU as O,ab as ee,f as se}from"./icons-DMGr8_f4.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";function ne(){i.useEffect(()=>{const n=window.scrollY;return document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${n}px`,document.body.style.width="100%",()=>{document.body.style.overflow="",document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,n)}},[])}const R=n=>n?new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never",D=[{value:"7",label:"7 days"},{value:"14",label:"14 days"},{value:"30",label:"30 days"},{value:"60",label:"60 days"},{value:"never",label:"No expiration"}];function oe({documentType:n,documentId:g,companyId:G,projectId:I,project:F,documentTitle:c="",onClose:h,onShowToast:r}){const[A,k]=i.useState(!0),[j,v]=i.useState(!1),[y,P]=i.useState([]),[d,T]=i.useState(null),[f,N]=i.useState(!1),[o,U]=i.useState("30"),[u,M]=i.useState(""),[w,B]=i.useState(F?.general_contractor||""),[H,C]=i.useState(!1);ne(),i.useEffect(()=>{x()},[n,g]);const x=async()=>{try{k(!0);const s=await p.getSignatureRequestsForDocument(n,g);P(s||[])}catch(s){console.error("Error loading signature requests:",s)}finally{k(!1)}},Y=async()=>{try{v(!0),C(!1);let s=null;if(o!=="never"){const l=parseInt(o);s=new Date,s.setDate(s.getDate()+l),s=s.toISOString()}const a=await p.createSignatureRequest(n,g,G,I,null,s);if(a){const l=`${window.location.origin}/sign/${a.signature_token}`;T(l),await x();const m=u.trim();if(m){const t=w.trim(),L=n==="cor"?"Change Order":"T&M Ticket",K=`Signature required: ${L} — ${c}`,Q=s?`
This link expires on ${new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}.`:"",V=[t?`Hi ${t},`:"To Whom It May Concern,","",`Please review and sign the ${L} "${c}".`,"","Click the link below to view and sign the document:",l,Q,"","Thank you"].join(`
`);window.location.href=`mailto:${m}?subject=${encodeURIComponent(K)}&body=${encodeURIComponent(V)}`,C(!0),r?.("Outlook opened — review and send the email","success")}else r?.("Signature link created","success")}}catch(s){console.error("Error generating signature link:",s),r?.("Failed to create signature link","error")}finally{v(!1)}},S=async s=>{try{await navigator.clipboard.writeText(s),N(!0),r?.("Link copied to clipboard","success"),setTimeout(()=>N(!1),2e3)}catch(a){console.error("Error copying to clipboard:",a)}},W=async s=>{if(confirm("Are you sure you want to revoke this signature link? It will no longer be usable."))try{await p.revokeSignatureRequest(s),await x(),r?.("Signature link revoked","success")}catch(a){console.error("Error revoking signature request:",a),r?.("Failed to revoke link","error")}},X=s=>{switch(s){case"pending":return{label:"Awaiting Signatures",color:"#f59e0b",bg:"#fef3c7"};case"partially_signed":return{label:"1 of 2 Signed",color:"#3b82f6",bg:"#dbeafe"};case"completed":return{label:"Fully Signed",color:"#10b981",bg:"#d1fae5"};case"revoked":return{label:"Revoked",color:"#ef4444",bg:"#fee2e2"};case"expired":return{label:"Expired",color:"#6b7280",bg:"#f3f4f6"};default:return{label:s,color:"#6b7280",bg:"#f3f4f6"}}},J=D.find(s=>s.value===o)?.label??`${o} days`,E=n==="cor"?"Change Order":"T&M Ticket";return e.jsx("div",{className:"modal-overlay",onClick:h,role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"modal-content signature-link-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Get Signature Link"}),c&&e.jsx("span",{className:"modal-subtitle",children:c})]}),e.jsx("button",{className:"close-btn",onClick:h,"aria-label":"Close",children:e.jsx(Z,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"signature-link-section",children:[e.jsxs("h3",{children:[e.jsx(q,{size:16}),"Create New Signature Link"]}),e.jsxs("p",{className:"section-description",children:["Generate a secure link that allows GC/Client to sign this ",E," without logging in."]}),e.jsx("div",{className:"link-options",children:e.jsxs("div",{className:"link-option-row",children:[e.jsxs("label",{htmlFor:"sig-deadline",className:"link-option-label",children:[e.jsx(b,{size:14}),"Signing deadline"]}),e.jsx("select",{id:"sig-deadline",className:"link-option-select",value:o,onChange:s=>U(s.target.value),children:D.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})}),e.jsxs("div",{className:"signature-email-section",children:[e.jsxs("h4",{children:[e.jsx(_,{size:14}),"Send directly to client (optional)"]}),e.jsxs("div",{className:"email-fields",children:[e.jsx("input",{type:"text",className:"link-input",placeholder:"Client name",value:w,onChange:s=>B(s.target.value),autoComplete:"off"}),e.jsx("input",{type:"email",className:"link-input",placeholder:"client@example.com",value:u,onChange:s=>M(s.target.value),autoComplete:"off"})]}),e.jsx("p",{className:"email-hint",children:"If provided, Outlook will open with the email pre-filled — just hit Send."})]}),e.jsx("div",{className:"link-generate-row",children:e.jsx("button",{className:"btn btn-primary",onClick:Y,disabled:j,children:j?"Generating...":u.trim()?"Generate & Open in Outlook":"Generate Link"})}),d&&e.jsxs("div",{className:"new-link-box",children:[H&&e.jsxs("div",{className:"email-sent-banner",children:[e.jsx(_,{size:14}),"Outlook opened — review and send to ",u]}),e.jsxs("div",{className:"link-display",children:[e.jsx("input",{type:"text",value:d,readOnly:!0,className:"link-input"}),e.jsxs("button",{className:"btn btn-secondary copy-btn",onClick:()=>S(d),children:[f?e.jsx($,{size:16}):e.jsx(z,{size:16}),f?"Copied!":"Copy"]})]}),e.jsxs("div",{className:"new-link-meta",children:[e.jsxs("span",{className:"link-expires-note",children:[e.jsx(b,{size:12}),o==="never"?"No expiration":`Expires in ${J}`]}),e.jsxs("a",{href:d,target:"_blank",rel:"noopener noreferrer",className:"preview-link",children:[e.jsx(O,{size:14}),"Preview link"]})]})]})]}),e.jsxs("div",{className:"signature-link-section",children:[e.jsxs("h3",{children:[e.jsx(b,{size:16}),"Existing Signature Links"]}),A?e.jsx("div",{className:"loading-inline",children:"Loading..."}):y.length===0?e.jsxs("p",{className:"empty-state",children:["No signature links have been created for this ",E,"."]}):e.jsx("div",{className:"existing-links-list",children:y.map(s=>{const a=X(s.status),l=`${window.location.origin}/sign/${s.signature_token}`,m=s.signatures?.length||0;return e.jsxs("div",{className:"existing-link-card",children:[e.jsxs("div",{className:"link-card-header",children:[e.jsx("span",{className:"status-badge",style:{color:a.color,backgroundColor:a.bg},children:a.label}),e.jsxs("span",{className:"link-created",children:["Created ",R(s.created_at)]})]}),e.jsxs("div",{className:"link-card-body",children:[e.jsxs("div",{className:"link-info",children:[e.jsxs("span",{className:"link-token",children:["...",s.signature_token.slice(-8)]}),s.expires_at&&e.jsxs("span",{className:"link-expires",children:["Expires ",R(s.expires_at)]}),e.jsxs("span",{className:"link-views",children:[s.view_count," view",s.view_count!==1?"s":""]})]}),m>0&&e.jsx("div",{className:"signatures-summary",children:s.signatures.map(t=>e.jsxs("div",{className:"sig-item",children:[e.jsx($,{size:12}),e.jsxs("span",{children:["Slot ",t.signature_slot,": ",t.signer_name,t.signer_company&&` (${t.signer_company})`]})]},t.id))})]}),e.jsxs("div",{className:"link-card-actions",children:[s.status!=="revoked"&&s.status!=="expired"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>S(l),children:[e.jsx(z,{size:14})," Copy"]}),e.jsxs("a",{href:l,target:"_blank",rel:"noopener noreferrer",className:"btn btn-ghost btn-small",children:[e.jsx(O,{size:14})," Open"]})]}),s.status!=="completed"&&s.status!=="revoked"&&e.jsxs("button",{className:"btn btn-ghost btn-small btn-danger",onClick:()=>W(s.id),children:[e.jsx(ee,{size:14})," Revoke"]})]})]},s.id)})})]}),e.jsxs("div",{className:"signature-info-box",children:[e.jsx(se,{size:16}),e.jsxs("div",{children:[e.jsx("strong",{children:"How it works:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Share the link with your GC or Client (or enter their email above to open Outlook with the email pre-filled)"}),e.jsx("li",{children:"They can view the document and sign without logging in"}),e.jsx("li",{children:"Supports 2 signatures (GC + Client)"}),e.jsx("li",{children:"Signatures are recorded with name, title, company, date, and IP"})]})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-secondary",onClick:h,children:"Close"})})]})})}export{oe as default};
//# sourceMappingURL=SignatureLinkGenerator-cTRiV0R3.js.map
