import{E as ct,a as B}from"./pdf-aQqpMATS.js";import{c as gt,a as mt,k,f as z,d as Q,b as ot}from"./corCalculations-BdV1IoSP.js";import{aG as dt,aH as lt,aT as ht,as as u}from"./index-BuWOXVN7.js";import{r as q,X as _t,a as xt,ai as ft,R as pt,C as St}from"./icons-Ng3QClhp.js";const rt=a=>{if(!a)return"";const[S,b]=a.split(":"),_=parseInt(S),o=_>=12?"pm":"am";return`${_%12||12}:${b}${o}`},ut=a=>a.time_started&&a.time_ended?`${rt(a.time_started)} - ${rt(a.time_ended)}`:"-";async function Ct(a){if(!a||a.length===0)return{totalPhotos:0,verified:0,failed:0,issues:[],manifest:[]};const S=[];let b=0,_=0;const o=[];for(const g of a)if(!(!g.photos||g.photos.length===0))for(const v of g.photos){const l={ticketId:g.id,workDate:g.work_date,url:v,verified:!1,error:null};try{await lt(v)?(l.verified=!0,b++):(l.error="Failed to load image",_++,o.push({ticketId:g.id,workDate:g.work_date,url:v,error:"Failed to load image"}))}catch(s){l.error=s.message||"Unknown error",_++,o.push({ticketId:g.id,workDate:g.work_date,url:v,error:l.error})}S.push(l)}return{totalPhotos:b+_,verified:b,failed:_,issues:o,manifest:S,allVerified:_===0,verifiedAt:new Date().toISOString()}}function bt(a,S,b,_){const o=JSON.stringify({cor:a,tmTickets:S,photoManifest:b,totals:_});let g=0;for(let l=0;l<o.length;l++){const s=o.charCodeAt(l);g=(g<<5)-g+s,g=g&g}const v=Math.abs(g).toString(16).padStart(16,"0");return{cor_data:{id:a.id,cor_number:a.cor_number,title:a.title,description:a.description,status:a.status,created_at:a.created_at,submitted_at:a.submitted_at,labor_items:a.labor_items,material_items:a.material_items,equipment_items:a.equipment_items,gc_markup_percent:a.gc_markup_percent,profit_markup_percent:a.profit_markup_percent},tickets_data:(S||[]).map(l=>({id:l.id,work_date:l.work_date,ce_pco_number:l.ce_pco_number,notes:l.notes,status:l.status,created_at:l.created_at,workers:l.t_and_m_workers||[],items:l.t_and_m_items||[],photos:l.photos||[],client_signature_name:l.client_signature_name,client_signature_date:l.client_signature_date})),photos_manifest:b,totals_snapshot:_,checksum:v}}async function zt(a,S,b,_={},o=null,g={}){const{verifyPhotos:v=!1,createSnapshot:l=!1}=g;let s=null;v&&o?.length>0&&(s=await Ct(o));const t=new ct,x=t.internal.pageSize.getWidth(),w=t.internal.pageSize.getHeight(),n=20;let e=n;const f=gt(a),i=_.primaryColor?dt(_.primaryColor):[30,58,138],p=[241,245,249];let F=null;if(_.logoUrl)try{F=await lt(_.logoUrl)}catch(c){console.error("Error loading logo:",c)}if(F)try{t.addImage(F,"PNG",n,e,40,15),e+=20}catch{t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(...i),t.text(b?.name||"Company Name",n,e+10),e+=20}else t.setFontSize(16),t.setFont("helvetica","bold"),t.setTextColor(...i),t.text(b?.name||"Company Name",n,e+10),e+=20;t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(0,0,0),t.text("CHANGE ORDER REQUEST",n,e),e+=10,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(100,100,100),t.text(a.cor_number||"COR-XXXX",n,e);const R=a.status?.replace("_"," ").toUpperCase()||"DRAFT";t.setTextColor(...i),t.text(R,x-n-t.getTextWidth(R),e),e+=12,t.setDrawColor(...i),t.setLineWidth(.5),t.line(n,e,x-n,e),e+=10,t.setFontSize(10),t.setTextColor(0,0,0);const E=n,N=x/2;t.setFont("helvetica","bold"),t.text("Project:",E,e),t.setFont("helvetica","normal"),t.text(S?.name||"Project Name",E+25,e),t.setFont("helvetica","bold"),t.text("Job #:",N,e),t.setFont("helvetica","normal"),t.text(S?.job_number||"N/A",N+25,e),e+=6,t.setFont("helvetica","bold"),t.text("Period:",E,e),t.setFont("helvetica","normal"),t.text(mt(a.period_start,a.period_end),E+25,e),t.setFont("helvetica","bold"),t.text("Date:",N,e),t.setFont("helvetica","normal"),t.text(k(a.created_at),N+25,e),e+=10,t.setFont("helvetica","bold"),t.setFontSize(12),t.text(a.title||"Untitled Change Order",n,e),e+=8,t.setFont("helvetica","normal"),t.setFontSize(10),t.setTextColor(80,80,80);const D=t.splitTextToSize(a.scope_of_work||"No scope of work provided.",x-n*2);t.text(D,n,e),e+=D.length*5+10,a.change_order_labor?.length>0&&(t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("LABOR",n,e),e+=6,B(t,{startY:e,head:[["Class","Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:a.change_order_labor.map(c=>[c.labor_class,c.wage_type,c.regular_hours.toString(),`$${ot(c.regular_rate)}/hr`,c.overtime_hours?.toString()||"-",c.overtime_hours?`$${ot(c.overtime_rate)}/hr`:"-",z(c.total)]),foot:[[{content:`Subtotal: ${z(f.labor_subtotal)}`,colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:`+${Q(a.labor_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:z(f.labor_subtotal+f.labor_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:i,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:p,textColor:[0,0,0],fontSize:8},theme:"striped"}),e=t.lastAutoTable.finalY+10),a.change_order_materials?.length>0&&(e>w-80&&(t.addPage(),e=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("MATERIALS",n,e),e+=6,B(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:a.change_order_materials.map(c=>[c.description,c.source_reference||c.source_type,c.quantity.toString(),c.unit,`$${ot(c.unit_cost)}`,z(c.total)]),foot:[[{content:`Subtotal: ${z(f.materials_subtotal)}`,colSpan:4,styles:{halign:"right",fontStyle:"bold"}},{content:`+${Q(a.materials_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:z(f.materials_subtotal+f.materials_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:i,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:p,textColor:[0,0,0],fontSize:8},theme:"striped"}),e=t.lastAutoTable.finalY+10),a.change_order_equipment?.length>0&&(e>w-80&&(t.addPage(),e=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("EQUIPMENT",n,e),e+=6,B(t,{startY:e,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:a.change_order_equipment.map(c=>[c.description,c.source_reference||c.source_type,c.quantity.toString(),c.unit,`$${ot(c.unit_cost)}`,z(c.total)]),foot:[[{content:`Subtotal: ${z(f.equipment_subtotal)}`,colSpan:4,styles:{halign:"right",fontStyle:"bold"}},{content:`+${Q(a.equipment_markup_percent||1500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:z(f.equipment_subtotal+f.equipment_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:i,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:p,textColor:[0,0,0],fontSize:8},theme:"striped"}),e=t.lastAutoTable.finalY+10),a.change_order_subcontractors?.length>0&&(e>w-80&&(t.addPage(),e=n),t.setFont("helvetica","bold"),t.setFontSize(11),t.setTextColor(0,0,0),t.text("SUBCONTRACTORS",n,e),e+=6,B(t,{startY:e,head:[["Company","Description","Source","Amount"]],body:a.change_order_subcontractors.map(c=>[c.company_name,c.description,c.source_reference||c.source_type,z(c.total)]),foot:[[{content:`Subtotal: ${z(f.subcontractors_subtotal)}`,colSpan:2,styles:{halign:"right",fontStyle:"bold"}},{content:`+${Q(a.subcontractors_markup_percent||500)} Markup`,colSpan:1,styles:{halign:"right"}},{content:z(f.subcontractors_subtotal+f.subcontractors_markup_amount),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:i,textColor:[255,255,255],fontStyle:"bold",fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:p,textColor:[0,0,0],fontSize:8},theme:"striped"}),e=t.lastAutoTable.finalY+10),e>w-100&&(t.addPage(),e=n),t.setFillColor(...p),t.roundedRect(n,e,x-n*2,70,3,3,"F"),e+=10,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(0,0,0);const T=n+10,$=x-n-60;t.text("COR Subtotal:",T,e),t.setFont("helvetica","bold"),t.text(z(f.cor_subtotal),$,e,{align:"right"}),e+=8,t.setFont("helvetica","normal"),t.setFontSize(9),t.text(`Liability Insurance (${Q(a.liability_insurance_percent||144)}):`,T,e),t.text(z(f.liability_insurance_amount),$,e,{align:"right"}),e+=6,t.text(`Bond (${Q(a.bond_percent||100)}):`,T,e),t.text(z(f.bond_amount),$,e,{align:"right"}),e+=6,t.text(`City License Fee (${Q(a.license_fee_percent||10)}):`,T,e),t.text(z(f.license_fee_amount),$,e,{align:"right"}),e+=10,t.setFillColor(...i),t.roundedRect(T-5,e-3,x-n*2-10,16,2,2,"F"),t.setTextColor(255,255,255),t.setFontSize(12),t.setFont("helvetica","bold"),t.text("COR TOTAL:",T,e+8),t.text(z(f.cor_total),$,e+8,{align:"right"}),e+=25,e>w-120&&(t.addPage(),e=n),e+=10,t.setTextColor(0,0,0),t.setFontSize(10),t.setFont("helvetica","bold"),t.text("AUTHORIZATION",n,e),e+=15,t.setFont("helvetica","normal"),t.setFontSize(9),t.setDrawColor(0,0,0);const G=(c,j,J,O,L,W,X)=>{t.setFont("helvetica","bold"),t.setFontSize(8),t.text(j,n,c),t.setFont("helvetica","normal"),t.setFontSize(9);const C=c+20;if(t.line(n,C,n+70,C),t.text("Signature",n,C+8),t.line(n+85,C,n+145,C),t.text("Title / Company",n+85,C+8),t.line(x-n-40,C,x-n,C),t.text("Date",x-n-40,C+8),J)try{if(t.addImage(J,"PNG",n,C-18,60,18),O&&(t.setFontSize(8),t.text(O,n,C+15)),L||W){const I=[L,W].filter(Boolean).join(" - ");t.text(I,n+85,C-5)}X&&t.text(k(X),x-n-40,C-5)}catch(I){console.error("Error adding signature:",I)}else t.setFont("helvetica","italic"),t.setFontSize(9),t.setTextColor(150,150,150),t.text("Awaiting Signature",n+5,C-5),t.setTextColor(0,0,0),t.setFont("helvetica","normal");return C+25};if(e=G(e,"GC AUTHORIZATION",a.gc_signature_data||a.gc_signature,a.gc_signature_name||a.gc_signer_name,a.gc_signature_title,a.gc_signature_company,a.gc_signature_date||a.signed_at),e+=10,e=G(e,"CLIENT AUTHORIZATION",a.client_signature_data,a.client_signature_name,a.client_signature_title,a.client_signature_company,a.client_signature_date),o&&o.length>0){const c=o.reduce((d,r)=>d+(r.t_and_m_workers?.reduce((m,y)=>m+(parseFloat(y.hours)||0),0)||0),0),j=o.reduce((d,r)=>d+(r.t_and_m_workers?.reduce((m,y)=>m+(parseFloat(y.overtime_hours)||0),0)||0),0),J=o.reduce((d,r)=>d+(r.photos?.length||0),0),O=o.filter(d=>d.client_signature_data).length,L=o.length>0?{start:o.reduce((d,r)=>!d||r.work_date<d?r.work_date:d,null),end:o.reduce((d,r)=>!d||r.work_date>d?r.work_date:d,null)}:null,W=new Uint8Array(3);crypto.getRandomValues(W);const X=Array.from(W,d=>d.toString(36)).join("").toUpperCase().substring(0,4),C=`FS-${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,"0")}${String(new Date().getDate()).padStart(2,"0")}-${X}`;if(t.addPage(),e=n,F)try{t.addImage(F,"PNG",n,e,50,18)}catch{t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...i),t.text(b?.name||"Company Name",n,e+10)}else t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...i),t.text(b?.name||"Company Name",n,e+10);e+=35,t.setDrawColor(...i),t.setLineWidth(.8),t.line(n,e,x-n,e),t.setLineWidth(.3),t.line(n,e+3,x-n,e+3),e+=15,t.setFontSize(22),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",x/2,e,{align:"center"}),e+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Change Order Request Backup",x/2,e,{align:"center"}),e+=8,t.setDrawColor(...i),t.setLineWidth(.3),t.line(n,e,x-n,e),t.setLineWidth(.8),t.line(n,e+3,x-n,e+3),e+=20,t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("COR Reference:",n,e),t.setFont("helvetica","normal"),t.text(a.cor_number||"N/A",n+35,e),t.setFont("helvetica","bold"),t.text("Project:",x/2,e),t.setFont("helvetica","normal"),t.text(S?.name||"N/A",x/2+20,e),e+=7,t.setFont("helvetica","bold"),t.text("Job #:",n,e),t.setFont("helvetica","normal"),t.text(S?.job_number||"N/A",n+35,e),e+=20,t.setFillColor(248,250,252),t.setDrawColor(203,213,225),t.roundedRect(n,e,x-n*2,65,4,4,"FD"),e+=10,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",n+10,e),t.setDrawColor(203,213,225),t.setLineWidth(.3),t.line(n+10,e+3,n+80,e+3),e+=12,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(71,85,105);const I=n+15,H=n+70;t.text("T&M Tickets:",I,e),t.setFont("helvetica","bold"),t.text(String(o.length),H,e),t.setFont("helvetica","normal"),e+=7,t.text("Total Labor:",I,e),t.setFont("helvetica","bold"),t.text(`${c.toFixed(1)} hrs`,H,e),t.setFont("helvetica","normal"),e+=7,j>0&&(t.text("Total OT:",I,e),t.setFont("helvetica","bold"),t.text(`${j.toFixed(1)} hrs`,H,e),t.setFont("helvetica","normal"),e+=7),t.text("Photo Evidence:",I,e),t.setFont("helvetica","bold"),t.text(`${J} photos`,H,e),t.setFont("helvetica","normal"),e+=7,t.text("Client Verified:",I,e),t.setFont("helvetica","bold"),t.setTextColor(O>0?16:71,O>0?185:85,O>0?129:105),t.text(`${O} of ${o.length} tickets`,H,e),t.setTextColor(71,85,105),t.setFont("helvetica","normal"),e+=7,L?.start&&L?.end&&(t.text("Date Range:",I,e),t.setFont("helvetica","bold"),t.text(`${k(L.start)} - ${k(L.end)}`,H,e)),e+=30,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const tt=new Date;t.text(`Generated: ${tt.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${tt.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,n,e),e+=6,t.text(`Document ID: ${C}`,n,e);for(const d of o){t.addPage(),e=n;const r=!!d.client_signature_data,m=22,y=r?[16,185,129]:d.status==="approved"?[16,185,129]:[245,158,11];if(t.setFillColor(...y),t.rect(n,e,4,m,"F"),t.setFillColor(248,250,252),t.rect(n+4,e,x-n*2-4,m,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`T&M TICKET — ${k(d.work_date)}`,n+10,e+8),d.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${d.ce_pco_number}`,n+10,e+16)),r&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",x-n-35,e+12)),e+=m+8,d.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",n,e),e+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const h=t.splitTextToSize(d.notes,x-n*2);t.text(h,n,e),e+=h.length*4+10}if(d.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",n,e),e+=6,B(t,{startY:e,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:d.t_and_m_workers.map(h=>[h.name,ut(h),h.role||h.labor_class||"Laborer",h.hours?.toString()||"0",h.overtime_hours?.toString()||"-"]),margin:{left:n,right:n},headStyles:{fillColor:i,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),e=t.lastAutoTable.finalY+10),d.t_and_m_items?.length>0&&(e>w-60&&(t.addPage(),e=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",n,e),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: T&M Ticket",n+55,e),e+=6,B(t,{startY:e,head:[["Item","Qty","Unit","Unit Cost","Total"]],body:d.t_and_m_items.map(h=>[h.materials_equipment?.name||h.description||"Item",h.quantity?.toString()||"1",h.materials_equipment?.unit||"ea",h.materials_equipment?.cost_per_unit?`$${h.materials_equipment.cost_per_unit}`:"-",h.materials_equipment?.cost_per_unit&&h.quantity?`$${(h.quantity*h.materials_equipment.cost_per_unit).toFixed(2)}`:"-"]),margin:{left:n,right:n},headStyles:{fillColor:i,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),e=t.lastAutoTable.finalY+10),d.photos?.length>0){e>w-80&&(t.addPage(),e=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",n,e),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${d.photos.length} photo${d.photos.length!==1?"s":""}`,n+50,e),e+=8;let h=n;const A=55,P=45,V=6,nt=3,Y=1,at=await ht(d.photos);for(let M=0;M<d.photos.length;M++){M>0&&M%nt===0&&(h=n,e+=P+V+4),e+P>w-20&&(t.addPage(),e=n,h=n);const Z=at[M];Z?(t.setDrawColor(200,200,200),t.setLineWidth(Y),t.rect(h-Y,e-Y,A+Y*2,P+Y*2,"S"),t.setFillColor(230,230,230),t.rect(h+2,e+2,A,P,"F"),t.addImage(Z,"JPEG",h,e,A,P)):(t.setFillColor(245,245,245),t.rect(h,e,A,P,"F"),t.setDrawColor(200,200,200),t.rect(h,e,A,P,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",h+8,e+P/2)),h+=A+V}e+=P+12}if(d.client_signature_data){e>w-50&&(t.addPage(),e=n);const h=32,A=x-n*2;t.setFillColor(240,253,244),t.roundedRect(n,e,A,h,3,3,"F"),t.setFillColor(16,185,129),t.rect(n,e,4,h,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(n+4,e,n+A,e);const P=n+14,V=e+h/2;t.setFillColor(16,185,129),t.circle(P,V,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",P-2.5,V+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",n+26,e+10);try{t.addImage(d.client_signature_data,"PNG",n+26,e+13,50,16);const at=d.client_signature_name||"Client",M=d.client_signature_title||"",Z=d.client_signature_company||"",it=d.client_signature_date?k(d.client_signature_date):"",st=n+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(at,st,e+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(M||Z)&&t.text(`${M}${M&&Z?", ":""}${Z}`,st,e+18),it&&(t.setTextColor(100,116,139),t.text(`Verified: ${it}`,st,e+24))}catch{const Y=d.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${Y}`,n+26,e+20)}e+=h+8}e+=5,t.setDrawColor(200,200,200),t.setLineWidth(.2),t.line(n,e,x-n,e),e+=10}}const U=t.internal.getNumberOfPages();for(let c=1;c<=U;c++){t.setPage(c);const j=w-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,n,j),t.text(`Page ${c} of ${U}`,x-n,j,{align:"right"})}const K=`${a.cor_number||"COR"}_${S?.job_number||"export"}${o?.length?"_with_backup":""}.pdf`;t.save(K);const et={success:!0,fileName:K,exportedAt:new Date().toISOString(),photoManifest:s};return l&&(et.snapshot=bt(a,o,s,f)),et}async function wt(a,S,b,_={}){const o=new ct("p","mm","letter"),g=o.internal.pageSize.getWidth(),v=o.internal.pageSize.getHeight(),l=20;let s=l;const t=_.primaryColor?dt(_.primaryColor):[30,58,95];if(_.logoUrl)try{const i=await lt(_.logoUrl);i&&o.addImage(i,"PNG",l,s,40,15)}catch{b?.name&&(o.setFontSize(14),o.setFont("helvetica","bold"),o.setTextColor(...t),o.text(b.name,l,s+8))}else b?.name&&(o.setFontSize(14),o.setFont("helvetica","bold"),o.setTextColor(...t),o.text(b.name,l,s+8));if(o.setFontSize(16),o.setFont("helvetica","bold"),o.setTextColor(30,41,59),o.text("T&M TICKET",g-l,s+8,{align:"right"}),s+=25,o.setDrawColor(...t),o.setLineWidth(.5),o.line(l,s,g-l,s),s+=10,!!a.client_signature_data&&(o.setFillColor(240,253,244),o.roundedRect(g-l-45,s-5,45,12,2,2,"F"),o.setFontSize(9),o.setFont("helvetica","bold"),o.setTextColor(16,185,129),o.text("✓ CLIENT VERIFIED",g-l-42,s+3)),o.setFontSize(10),o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("Project:",l,s),o.setFont("helvetica","normal"),o.setTextColor(30,41,59),o.text(S?.name||"N/A",l+20,s),s+=6,S?.job_number&&(o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("Job #:",l,s),o.setFont("helvetica","normal"),o.setTextColor(30,41,59),o.text(S.job_number,l+20,s),s+=6),o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("Work Date:",l,s),o.setFont("helvetica","normal"),o.setTextColor(30,41,59),o.text(k(a.work_date||a.ticket_date),l+26,s),a.ce_pco_number&&(o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("CE/PCO:",l+70,s),o.setFont("helvetica","normal"),o.setTextColor(59,130,246),o.text(a.ce_pco_number,l+88,s)),s+=12,a.notes){o.setFontSize(10),o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("DESCRIPTION",l,s),s+=6,o.setFontSize(9),o.setFont("helvetica","normal"),o.setTextColor(51,65,85);const i=o.splitTextToSize(a.notes,g-l*2);o.text(i,l,s),s+=i.length*4+10}a.t_and_m_workers?.length>0&&(o.setFontSize(10),o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("LABOR",l,s),s+=6,B(o,{startY:s,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:a.t_and_m_workers.map(i=>[i.name,ut(i),i.role||i.labor_class||"Laborer",i.hours?.toString()||"0",i.overtime_hours?.toString()||"-"]),margin:{left:l,right:l},headStyles:{fillColor:t,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=o.lastAutoTable.finalY+10);const w=a.t_and_m_items||a.materials_equipment?.filter(i=>i.type==="material")||[];if(w.length>0&&(s>v-60&&(o.addPage(),s=l),o.setFontSize(10),o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("MATERIALS / EQUIPMENT",l,s),s+=6,B(o,{startY:s,head:[["Item","Qty","Unit"]],body:w.map(i=>[i.materials_equipment?.name||i.description||i.name||"Item",i.quantity?.toString()||"1",i.materials_equipment?.unit||i.unit||"ea"]),margin:{left:l,right:l},headStyles:{fillColor:t,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=o.lastAutoTable.finalY+10),a.photos?.length>0){s>v-80&&(o.addPage(),s=l),o.setFontSize(10),o.setFont("helvetica","bold"),o.setTextColor(71,85,105),o.text("PHOTO DOCUMENTATION",l,s),o.setFontSize(8),o.setFont("helvetica","normal"),o.setTextColor(59,130,246),o.text(`${a.photos.length} photo${a.photos.length!==1?"s":""}`,l+50,s),s+=8;let i=l;const p=55,F=45,R=6,E=3,N=await ht(a.photos);for(let D=0;D<a.photos.length;D++){D>0&&D%E===0&&(i=l,s+=F+R+4),s+F>v-20&&(o.addPage(),s=l,i=l);const T=N[D];T?(o.setDrawColor(200,200,200),o.setLineWidth(1),o.rect(i-1,s-1,p+2,F+2,"S"),o.setFillColor(230,230,230),o.rect(i+2,s+2,p,F,"F"),o.addImage(T,"JPEG",i,s,p,F)):(o.setFillColor(245,245,245),o.rect(i,s,p,F,"F"),o.setDrawColor(200,200,200),o.rect(i,s,p,F,"S"),o.setFontSize(7),o.setTextColor(150,150,150),o.text("Photo unavailable",i+8,s+F/2)),i+=p+R}s+=F+12}if(a.client_signature_data){s>v-50&&(o.addPage(),s=l);const i=32,p=g-l*2;o.setFillColor(240,253,244),o.roundedRect(l,s,p,i,3,3,"F"),o.setFillColor(16,185,129),o.rect(l,s,4,i,"F"),o.setDrawColor(187,247,208),o.setLineWidth(.5),o.line(l+4,s,l+p,s);const F=l+14,R=s+i/2;o.setFillColor(16,185,129),o.circle(F,R,6,"F"),o.setFontSize(9),o.setTextColor(255,255,255),o.text("✓",F-2.5,R+3),o.setFontSize(9),o.setFont("helvetica","bold"),o.setTextColor(16,185,129),o.text("CLIENT VERIFIED",l+26,s+10);try{o.addImage(a.client_signature_data,"PNG",l+26,s+13,50,16);const D=a.client_signature_name||"Client",T=a.client_signature_title||"",$=a.client_signature_company||"",G=a.client_signature_date?k(a.client_signature_date):"",U=l+85;o.setFont("helvetica","bold"),o.setFontSize(9),o.setTextColor(30,41,59),o.text(D,U,s+12),o.setFont("helvetica","normal"),o.setFontSize(8),o.setTextColor(71,85,105),(T||$)&&o.text(`${T}${T&&$?", ":""}${$}`,U,s+18),G&&(o.setTextColor(100,116,139),o.text(`Verified: ${G}`,U,s+24))}catch{const N=a.client_signature_name||"Client";o.setFont("helvetica","normal"),o.setFontSize(9),o.setTextColor(30,41,59),o.text(`Signed by: ${N}`,l+26,s+20)}s+=i+8}const n=o.internal.getNumberOfPages();for(let i=1;i<=n;i++){o.setPage(i);const p=v-10;o.setFontSize(8),o.setTextColor(150,150,150),o.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,l,p),o.text(`Page ${i} of ${n}`,g-l,p,{align:"right"})}const f=`TM_Ticket_${k(a.work_date||a.ticket_date).replace(/\//g,"-")}${a.ce_pco_number?"_"+a.ce_pco_number:""}.pdf`;return o.save(f),{success:!0,fileName:f}}function Pt({onSave:a,onClose:S,title:b="Signature",enhanced:_=!1,slot:o=null,documentType:g=null,documentTitle:v="",signerName:l="",signerTitle:s="",signerCompany:t="",legalText:x=null,requireAcknowledgment:w=!1,canvasWidth:n=500,canvasHeight:e=180,lockBodyScroll:f=!1}){const i=q.useRef(null),[p,F]=q.useState(l),[R,E]=q.useState(s),[N,D]=q.useState(t),[T,$]=q.useState(!1),[G,U]=q.useState(!1),[K,et]=q.useState(!w),c=o?o===1?"GC Authorization":"Client Authorization":b,j=g==="cor"?"Change Order Request":g==="tm_ticket"?"T&M Work Order":"document",J=`I acknowledge that this electronic signature is legally binding and that I have reviewed and approve this ${j}. I understand that my signature, name, and IP address will be recorded for verification purposes.`;q.useEffect(()=>{if(!f)return;const r=document.body.style.overflow,m=document.body.style.position,y=document.body.style.top,h=window.scrollY;return document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${h}px`,document.body.style.width="100%",()=>{document.body.style.overflow=r,document.body.style.position=m,document.body.style.top=y,document.body.style.width="",window.scrollTo(0,h)}},[f]);const O=()=>{const r=i.current;return r?r.getContext("2d"):null},L=r=>{const m=i.current;if(!m)return{x:0,y:0};const y=m.getBoundingClientRect(),h=m.width/y.width,A=m.height/y.height,P=r.touches?.length?r.touches[0].clientX:r.clientX,V=r.touches?.length?r.touches[0].clientY:r.clientY;return{x:(P-y.left)*h,y:(V-y.top)*A}},W=r=>{r.preventDefault();const m=O();if(!m)return;const{x:y,y:h}=L(r);m.beginPath(),m.moveTo(y,h),U(!0),$(!0)},X=r=>{if(!G)return;r.preventDefault();const m=O();if(!m)return;const{x:y,y:h}=L(r);m.lineTo(y,h),m.stroke()},C=()=>{U(!1)},I=()=>{const r=i.current,m=O();!r||!m||(m.clearRect(0,0,r.width,r.height),$(!1))},H=r=>{if(!r)return;i.current=r;const m=r.getContext("2d");m.strokeStyle="#1e293b",m.lineWidth=2,m.lineCap="round",m.lineJoin="round"},tt=T&&p.trim()&&K,d=()=>{if(!tt)return;const r=i.current;if(!r)return;const y={signature:r.toDataURL("image/png"),signerName:p.trim(),signedAt:new Date().toISOString()};_&&(y.signerTitle=R.trim()||null,y.signerCompany=N.trim()||null),a(y)};return u.jsx("div",{className:"modal-overlay",onClick:S,role:"dialog","aria-modal":"true","aria-labelledby":"signature-title",children:u.jsxs("div",{className:`modal-content signature-modal${_?" enhanced":""}`,onClick:r=>r.stopPropagation(),children:[u.jsxs("div",{className:"modal-header",children:[u.jsxs("div",{className:"signature-header-info",children:[u.jsx("h2",{id:"signature-title",children:c}),v&&u.jsx("span",{className:"signature-doc-ref",children:v})]}),u.jsx("button",{className:"close-btn",onClick:S,"aria-label":"Close signature modal",children:u.jsx(_t,{size:20,"aria-hidden":"true"})})]}),u.jsxs("div",{className:"modal-body signature-body",children:[o&&u.jsxs("div",{className:"signature-slot-badge",children:[u.jsx(xt,{size:14}),u.jsxs("span",{children:["Signature ",o," of 2"]})]}),u.jsxs("div",{className:"signature-fields",children:[u.jsxs("div",{className:"form-group required",children:[u.jsx("label",{htmlFor:"sig-name",children:_?"Print Name":"Signer Name *"}),u.jsx("input",{id:"sig-name",type:"text",value:p,onChange:r=>F(r.target.value),placeholder:_?"Enter your full legal name":"Enter full name","aria-required":"true",className:"input-required"})]}),_&&u.jsxs("div",{className:"signature-fields-row",children:[u.jsxs("div",{className:"form-group",children:[u.jsx("label",{htmlFor:"sig-title",children:"Title"}),u.jsx("input",{id:"sig-title",type:"text",value:R,onChange:r=>E(r.target.value),placeholder:"e.g., Project Manager"})]}),u.jsxs("div",{className:"form-group",children:[u.jsx("label",{htmlFor:"sig-company",children:"Company"}),u.jsx("input",{id:"sig-company",type:"text",value:N,onChange:r=>D(r.target.value),placeholder:"e.g., ABC Construction"})]})]})]}),u.jsxs("div",{className:"signature-area",children:[u.jsxs("div",{className:"signature-label",id:"signature-instructions",children:[u.jsx(ft,{size:16,"aria-hidden":"true"}),u.jsx("span",{children:_?"Draw your signature below":"Sign below"})]}),u.jsxs("div",{className:"signature-canvas-container",children:[u.jsx("canvas",{ref:H,width:n,height:e,className:"signature-canvas",onMouseDown:W,onMouseMove:X,onMouseUp:C,onMouseLeave:C,onTouchStart:W,onTouchMove:X,onTouchEnd:C,role:"img","aria-label":"Signature drawing area. Use mouse or touch to draw your signature.","aria-describedby":"signature-instructions",tabIndex:0}),!T&&u.jsx("div",{className:"signature-placeholder",children:"Sign here"})]}),u.jsxs("button",{className:"btn btn-ghost btn-small",onClick:I,disabled:!T,"aria-label":"Clear signature",children:[u.jsx(pt,{size:14,"aria-hidden":"true"})," Clear"]})]}),w?u.jsx("div",{className:"signature-acknowledgment",children:u.jsxs("label",{className:"checkbox-label",children:[u.jsx("input",{type:"checkbox",checked:K,onChange:r=>et(r.target.checked)}),u.jsx("span",{children:x||J})]})}):u.jsx("p",{className:"signature-legal",role:"note",children:x||`By signing above, I acknowledge that I have reviewed and approve this ${j}.`})]}),u.jsxs("div",{className:"modal-footer",children:[u.jsx("button",{className:"btn btn-secondary",onClick:S,"aria-label":"Cancel and close",children:"Cancel"}),u.jsxs("button",{className:"btn btn-primary",onClick:d,disabled:!tt,"aria-label":_?"Submit signature":"Save signature",children:[u.jsx(St,{size:16,"aria-hidden":"true"})," ",_?"Submit Signature":"Save Signature"]})]})]})})}export{Pt as S,wt as a,zt as e};
//# sourceMappingURL=SignatureCanvas-DrLwfeKW.js.map
