const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Dq4629GT.js","assets/icons-BDU0tZd_.js","assets/react-DXGY7bZi.js","assets/pdf-Dbgi5wV4.js","assets/supabase-VuevzHjS.js","assets/index-CQHYvI2m.css"])))=>i.map(i=>d[i]);
import{aq as Q,aK as M,aG as je,aH as fe,aU as ye,ar as L,as as e}from"./index-Dq4629GT.js";import{r as R,b as Ce,X as re,aB as ve,e as Ne,F as ne,a0 as le,_ as ce,ar as Se,p as ke,B as Fe,aI as Te,d as Ee,a as ze,v as Re,C as Oe,$ as Pe,N as we,aJ as oe,aK as De,ag as de,P as Ie,n as $e,k as qe,D as ue}from"./icons-BDU0tZd_.js";import{a as _e,f as c,d as z,b as U,c as Ae,k as Le,e as se}from"./corCalculations-vdJc_BOT.js";import{_ as ee}from"./pdf-Dbgi5wV4.js";import{e as Ue}from"./Dashboard-CGFghLII.js";import{S as Me}from"./SignatureCanvas-jzxcUzqY.js";import Ge from"./SignatureLinkGenerator-h84zE-c6.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const W={PENDING:"pending",GENERATING:"generating",COMPLETED:"completed",FAILED:"failed"},Be={PDF:"pdf"};function He(o,x,b=null){if(b)return`custom_${b}`;const f=Math.floor(Date.now()/6e4);return`cor_${o}_v${x||1}_${f}`}function Ye(o){return`cor_${o}_force_${Date.now()}`}function me(o,x,b={}){const f=new Date().toISOString(),y=[];let k=0;for(const d of x||[]){const _=d.photos||[];k+=_.length;for(const G of _)y.push({ticketId:d.id,workDate:d.work_date,url:G,verified:!1,includedInExport:!0})}const u=(o.change_order_labor||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0),i=(o.change_order_materials||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0),p=(o.change_order_equipment||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0),t=(o.change_order_subcontractors||[]).reduce((d,_)=>d+(parseInt(_.total)||0),0);let a=0,h=0;for(const d of x||[])for(const _ of d.t_and_m_workers||[])a+=parseFloat(_.hours)||0,h+=parseFloat(_.overtime_hours)||0;const n=JSON.stringify({corId:o.id,version:o.version,totals:{laborTotal:u,materialsTotal:i,equipmentTotal:p,subcontractorsTotal:t},ticketCount:x?.length||0,photoCount:k});let s=0;for(let d=0;d<n.length;d++){const _=n.charCodeAt(d);s=(s<<5)-s+_,s=s&s}const C=Math.abs(s).toString(16).padStart(16,"0");return{snapshotId:crypto.randomUUID(),corId:o.id,corVersion:o.version||1,createdAt:f,checksum:C,corData:{id:o.id,cor_number:o.cor_number,title:o.title,description:o.description,scope_of_work:o.scope_of_work,status:o.status,period_start:o.period_start,period_end:o.period_end,change_order_labor:o.change_order_labor||[],change_order_materials:o.change_order_materials||[],change_order_equipment:o.change_order_equipment||[],change_order_subcontractors:o.change_order_subcontractors||[],labor_markup_percent:o.labor_markup_percent,materials_markup_percent:o.materials_markup_percent,equipment_markup_percent:o.equipment_markup_percent,subcontractors_markup_percent:o.subcontractors_markup_percent,liability_insurance_percent:o.liability_insurance_percent,bond_percent:o.bond_percent,license_fee_percent:o.license_fee_percent,labor_subtotal:o.labor_subtotal,materials_subtotal:o.materials_subtotal,equipment_subtotal:o.equipment_subtotal,subcontractors_subtotal:o.subcontractors_subtotal,labor_markup_amount:o.labor_markup_amount,materials_markup_amount:o.materials_markup_amount,equipment_markup_amount:o.equipment_markup_amount,subcontractors_markup_amount:o.subcontractors_markup_amount,liability_insurance_amount:o.liability_insurance_amount,bond_amount:o.bond_amount,license_fee_amount:o.license_fee_amount,cor_subtotal:o.cor_subtotal,additional_fees_total:o.additional_fees_total,cor_total:o.cor_total,gc_signature_data:o.gc_signature_data,gc_signature_name:o.gc_signature_name,gc_signature_date:o.gc_signature_date,created_at:o.created_at,submitted_at:o.submitted_at,approved_at:o.approved_at},ticketsData:(x||[]).map(d=>({id:d.id,work_date:d.work_date,ticket_date:d.ticket_date,ce_pco_number:d.ce_pco_number,notes:d.notes,status:d.status,created_at:d.created_at,t_and_m_workers:(d.t_and_m_workers||[]).map(_=>({id:_.id,name:_.name,role:_.role,labor_class:_.labor_class,hours:_.hours,overtime_hours:_.overtime_hours,time_started:_.time_started,time_ended:_.time_ended})),t_and_m_items:(d.t_and_m_items||[]).map(_=>({id:_.id,description:_.description,quantity:_.quantity,unit:_.unit,materials_equipment:_.materials_equipment})),photos:d.photos||[],client_signature_data:d.client_signature_data,client_signature_name:d.client_signature_name,client_signature_title:d.client_signature_title,client_signature_company:d.client_signature_company,client_signature_date:d.client_signature_date})),photoManifest:y,totals:{laborTotal:u,materialsTotal:i,equipmentTotal:p,subcontractorsTotal:t,totalLaborHours:a,totalOTHours:h,ticketCount:x?.length||0,photoCount:k,verifiedTicketCount:(x||[]).filter(d=>d.client_signature_data).length}}}async function Ve(o,x={}){const{forceNew:b=!1,idempotencyKey:f=null,exportType:y=Be.PDF,includeBackup:k=!0}=x;try{const{data:u,error:i}=await M.from("change_orders").select("id, version, cor_number").eq("id",o).single();if(i||!u)throw new Error(`COR not found: ${o}`);const p=b?Ye(o):f||He(o,u.version),{data:t,error:a}=await M.rpc("request_cor_export",{p_cor_id:o,p_idempotency_key:p,p_options:{exportType:y,includeBackup:k},p_requested_by:(await M.auth.getUser())?.data?.user?.id});if(a)throw a;const h=t?.[0];if(!h)throw new Error("Failed to create export job");return Q.activity("cor_export_requested",{cor_id:o,job_id:h.job_id,is_new:h.is_new,status:h.status}),{jobId:h.job_id,status:h.status,isNew:h.is_new,snapshotId:h.snapshot_id,pdfUrl:h.pdf_url,idempotencyKey:p}}catch(u){throw Q.error("cor_export_request_failed",{cor_id:o,error:u.message}),u}}async function ie(o,x,b={}){const{data:f,error:y}=await M.rpc("update_export_job_status",{p_job_id:o,p_status:x,p_snapshot_id:b.snapshotId||null,p_pdf_url:b.pdfUrl||null,p_error:b.error||null,p_error_details:b.errorDetails||null,p_metrics:b.metrics||null});if(y)throw Q.error("cor_export_job_update_failed",{job_id:o,status:x,error:y.message}),y;return f}async function We(o,x){await M.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",o.corId);const{data:b,error:f}=await M.from("cor_export_snapshots").insert({id:o.snapshotId,cor_id:o.corId,job_id:x,cor_version:o.corVersion,cor_data:o.corData,tickets_data:o.ticketsData,photos_manifest:o.photoManifest,totals_snapshot:o.totals,checksum:o.checksum,is_current:!0,exported_by:(await M.auth.getUser())?.data?.user?.id}).select().single();if(f)throw f;return await M.from("change_orders").update({last_snapshot_version:o.corVersion}).eq("id",o.corId),b}async function Qe(o,{cor:x,tickets:b,project:f,company:y,branding:k,options:u={}}={}){let i=null;try{if(i=await Ve(o,u),i.status===W.COMPLETED&&i.pdfUrl)return Q.activity("cor_export_cache_hit",{cor_id:o,job_id:i.jobId}),{success:!0,jobId:i.jobId,cached:!0,pdfUrl:i.pdfUrl};if(i.status===W.GENERATING)return{success:!0,jobId:i.jobId,status:W.GENERATING,message:"Export already in progress"};if(await ie(i.jobId,W.GENERATING),!x){const{db:n}=await ee(async()=>{const{db:s}=await import("./index-Dq4629GT.js").then(C=>C.aY);return{db:s}},__vite__mapDeps([0,1,2,3,4,5]));x=await n.getCORById(o)}if(!b&&u.includeBackup!==!1){const{db:n}=await ee(async()=>{const{db:s}=await import("./index-Dq4629GT.js").then(C=>C.aY);return{db:s}},__vite__mapDeps([0,1,2,3,4,5]));b=await n.getCORTickets(o)}const p=me(x,b,u),t=await We(p,i.jobId),{generatePDFFromSnapshot:a}=await ee(async()=>{const{generatePDFFromSnapshot:n}=await Promise.resolve().then(()=>Je);return{generatePDFFromSnapshot:n}},void 0),h=await a(p,{project:f,company:y,branding:k});return await ie(i.jobId,W.COMPLETED,{snapshotId:t.id,pdfUrl:h.fileName,metrics:{photo_count:p.totals.photoCount,ticket_count:p.totals.ticketCount,page_count:h.pageCount||1,pdf_size_bytes:h.sizeBytes||0}}),Q.activity("cor_export_completed",{cor_id:o,job_id:i.jobId,photo_count:p.totals.photoCount,ticket_count:p.totals.ticketCount}),{success:!0,jobId:i.jobId,snapshotId:t.id,fileName:h.fileName,snapshot:p.totals}}catch(p){throw i?.jobId&&await ie(i.jobId,W.FAILED,{error:p.message,errorDetails:{stack:p.stack}}).catch(()=>{}),Q.error("cor_export_failed",{cor_id:o,job_id:i?.jobId,error:p.message}),p}}const he=o=>{if(!o)return"";const[x,b]=o.split(":"),f=parseInt(x),y=f>=12?"pm":"am";return`${f%12||12}:${b}${y}`},Ke=o=>o.time_started&&o.time_ended?`${he(o.time_started)} - ${he(o.time_ended)}`:"-";async function pe(o,x={}){const{default:b}=await ee(async()=>{const{default:l}=await import("./pdf-Dbgi5wV4.js").then(T=>T.j);return{default:l}},[]),{default:f}=await ee(async()=>{const{default:l}=await import("./pdf-Dbgi5wV4.js").then(T=>T.b);return{default:l}},[]),{project:y,company:k,branding:u={}}=x,i=o.corData,p=o.ticketsData||[],t=new b,a=t.internal.pageSize.getWidth(),h=t.internal.pageSize.getHeight(),n=20;let s=n;const C=u.primaryColor?je(u.primaryColor):[30,58,95];if(u.logoUrl)try{const l=await fe(u.logoUrl);l&&t.addImage(l,"PNG",n,s,40,15)}catch{k?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...C),t.text(k.name,n,s+8))}else k?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...C),t.text(k.name,n,s+8));if(t.setFontSize(18),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("CHANGE ORDER REQUEST",a-n,s+5,{align:"right"}),t.setFontSize(12),t.setTextColor(...C),t.text(i.cor_number||"COR",a-n,s+12,{align:"right"}),s+=25,t.setDrawColor(...C),t.setLineWidth(.5),t.line(n,s,a-n,s),s+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(i.title||"Untitled Change Order",n,s),s+=8,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),y?.name&&(t.text(`Project: ${y.name}`,n,s),s+=5),y?.job_number&&(t.text(`Job #: ${y.job_number}`,n,s),s+=5),(i.period_start||i.period_end)&&(t.text(`Period: ${_e(i.period_start,i.period_end)}`,n,s),s+=5),s+=5,i.scope_of_work){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("Scope of Work:",n,s),s+=5,t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const l=t.splitTextToSize(i.scope_of_work,a-n*2);t.text(l,n,s),s+=l.length*4+8}i.change_order_labor?.length>0&&(t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Labor",n,s),s+=5,f(t,{startY:s,head:[["Class","Wage Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:i.change_order_labor.map(l=>[l.labor_class,l.wage_type||"Standard",l.regular_hours?.toString()||"0",c(l.regular_rate),l.overtime_hours?.toString()||"0",c(l.overtime_rate),c(l.total)]),foot:[[{content:"Labor Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.labor_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:C,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),s=t.lastAutoTable.finalY+10),i.change_order_materials?.length>0&&(s>h-60&&(t.addPage(),s=n),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Materials",n,s),s+=5,f(t,{startY:s,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_materials.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"ea",c(l.unit_cost),c(l.total)]),foot:[[{content:"Materials Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.materials_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:C,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),s=t.lastAutoTable.finalY+10),i.change_order_equipment?.length>0&&(s>h-60&&(t.addPage(),s=n),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Equipment",n,s),s+=5,f(t,{startY:s,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_equipment.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"day",c(l.unit_cost),c(l.total)]),foot:[[{content:"Equipment Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.equipment_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:C,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),s=t.lastAutoTable.finalY+10),i.change_order_subcontractors?.length>0&&(s>h-60&&(t.addPage(),s=n),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Subcontractors",n,s),s+=5,f(t,{startY:s,head:[["Company Name","Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_subcontractors.map(l=>[l.company_name||"-",l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"lump sum",c(l.unit_cost),c(l.total)]),foot:[[{content:"Subcontractors Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:c(i.subcontractors_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:n,right:n},headStyles:{fillColor:C,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),s=t.lastAutoTable.finalY+10),s>h-100&&(t.addPage(),s=n),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Cost Summary",n,s),s+=5;const d=[["Labor Subtotal",c(i.labor_subtotal)],[`  Markup (${z(i.labor_markup_percent)})`,c(i.labor_markup_amount)],["Materials Subtotal",c(i.materials_subtotal)],[`  Markup (${z(i.materials_markup_percent)})`,c(i.materials_markup_amount)],["Equipment Subtotal",c(i.equipment_subtotal)],[`  Markup (${z(i.equipment_markup_percent)})`,c(i.equipment_markup_amount)],["Subcontractors Subtotal",c(i.subcontractors_subtotal)],[`  Markup (${z(i.subcontractors_markup_percent)})`,c(i.subcontractors_markup_amount)]];f(t,{startY:s,body:d,margin:{left:n,right:n},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),s=t.lastAutoTable.finalY+5,t.setFillColor(248,250,252),t.rect(n,s,a-n*2,8,"F"),t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(30,41,59),t.text("COR Subtotal:",n+5,s+5.5),t.text(c(i.cor_subtotal),a-n-5,s+5.5,{align:"right"}),s+=12;const _=[[`Liability Insurance (${z(i.liability_insurance_percent)})`,c(i.liability_insurance_amount)],[`Bond (${z(i.bond_percent)})`,c(i.bond_amount)],[`License Fee (${z(i.license_fee_percent)})`,c(i.license_fee_amount)]];if(f(t,{startY:s,body:_,margin:{left:n,right:n},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),s=t.lastAutoTable.finalY+5,t.setFillColor(...C),t.rect(n,s,a-n*2,10,"F"),t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(255,255,255),t.text("COR TOTAL:",n+5,s+7),t.text(c(i.cor_total),a-n-5,s+7,{align:"right"}),s+=20,p.length>0){t.addPage(),s=n,k?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...C),t.text(k.name,n,s),s+=15),t.setDrawColor(...C),t.setLineWidth(.8),t.line(n,s,a-n,s),s+=3,t.setLineWidth(.3),t.line(n,s,a-n,s),s+=15,t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",a/2,s,{align:"center"}),s+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("Change Order Request Backup",a/2,s,{align:"center"}),s+=20,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`COR Reference: ${i.cor_number}`,n,s),s+=6,t.setFont("helvetica","normal"),t.setTextColor(71,85,105),y?.name&&(t.text(`Project: ${y.name}`,n,s),s+=5),y?.job_number&&(t.text(`Job #: ${y.job_number}`,n,s),s+=5),s+=15,t.setFillColor(248,250,252),t.setDrawColor(226,232,240),t.roundedRect(n,s,a-n*2,55,3,3,"FD"),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",n+10,s+12),t.setDrawColor(226,232,240),t.line(n+10,s+16,a-n-10,s+16);const l=n+15,T=n+80;let v=s+25;t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("Time & Material Tickets:",l,v),t.setFont("helvetica","bold"),t.text(String(p.length),T,v),t.setFont("helvetica","normal"),v+=7,t.text("Total Labor:",l,v),t.setFont("helvetica","bold"),t.text(`${o.totals.totalLaborHours.toFixed(1)} hrs`,T,v),t.setFont("helvetica","normal"),v+=7,o.totals.totalOTHours>0&&(t.text("Total OT:",l,v),t.setFont("helvetica","bold"),t.text(`${o.totals.totalOTHours.toFixed(1)} hrs`,T,v),t.setFont("helvetica","normal"),v+=7),t.text("Photo Evidence:",l,v),t.setFont("helvetica","bold"),t.text(`${o.totals.photoCount} photos`,T,v),t.setFont("helvetica","normal"),v+=7,t.text("Client Verified:",l,v),t.setFont("helvetica","bold");const Y=o.totals.verifiedTicketCount>0?[16,185,129]:[71,85,105];t.setTextColor(...Y),t.text(`${o.totals.verifiedTicketCount} of ${p.length} tickets`,T,v),s+=70,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const J=new Date(o.createdAt);t.text(`Generated: ${J.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${J.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,n,s),s+=6,t.text(`Document ID: ${o.checksum.substring(0,16).toUpperCase()}`,n,s);for(const g of p){t.addPage(),s=n;const F=!!g.client_signature_data,B=22,ae=F?[16,185,129]:[245,158,11];if(t.setFillColor(...ae),t.rect(n,s,4,B,"F"),t.setFillColor(248,250,252),t.rect(n+4,s,a-n*2-4,B,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`TIME & MATERIAL TICKET — ${U(g.work_date||g.ticket_date)}`,n+10,s+8),g.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${g.ce_pco_number}`,n+10,s+16)),F&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",a-n-35,s+12)),s+=B+8,g.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",n,s),s+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const m=t.splitTextToSize(g.notes,a-n*2);t.text(m,n,s),s+=m.length*4+10}if(g.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",n,s),s+=6,f(t,{startY:s,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:g.t_and_m_workers.map(m=>[m.name,Ke(m),m.role||m.labor_class||"Laborer",m.hours?.toString()||"0",m.overtime_hours?.toString()||"-"]),margin:{left:n,right:n},headStyles:{fillColor:C,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=t.lastAutoTable.finalY+10),g.t_and_m_items?.length>0&&(s>h-60&&(t.addPage(),s=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",n,s),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: Time & Material Ticket",n+55,s),s+=6,f(t,{startY:s,head:[["Item","Qty","Unit"]],body:g.t_and_m_items.map(m=>[m.custom_name||m.materials_equipment?.name||m.description||"Unnamed Item",m.quantity?.toString()||"1",m.materials_equipment?.unit||m.unit||"ea"]),margin:{left:n,right:n},headStyles:{fillColor:C,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=t.lastAutoTable.finalY+10),g.photos?.length>0){s>h-80&&(t.addPage(),s=n),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",n,s),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${g.photos.length} photo${g.photos.length!==1?"s":""}`,n+50,s),s+=8;let m=n;const O=55,E=45,H=6,X=3,V=await ye(g.photos);for(let w=0;w<g.photos.length;w++){w>0&&w%X===0&&(m=n,s+=E+H+4),s+E>h-20&&(t.addPage(),s=n,m=n);const D=V[w];D?(t.setDrawColor(200,200,200),t.setLineWidth(1),t.rect(m-1,s-1,O+2,E+2,"S"),t.setFillColor(230,230,230),t.rect(m+2,s+2,O,E,"F"),t.addImage(D,"JPEG",m,s,O,E)):(t.setFillColor(245,245,245),t.rect(m,s,O,E,"F"),t.setDrawColor(200,200,200),t.rect(m,s,O,E,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",m+8,s+E/2)),m+=O+H}s+=E+12}if(g.client_signature_data){s>h-50&&(t.addPage(),s=n);const m=32,O=a-n*2;t.setFillColor(240,253,244),t.roundedRect(n,s,O,m,3,3,"F"),t.setFillColor(16,185,129),t.rect(n,s,4,m,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(n+4,s,n+O,s);const E=n+14,H=s+m/2;t.setFillColor(16,185,129),t.circle(E,H,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",E-2.5,H+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",n+26,s+10);try{t.addImage(g.client_signature_data,"PNG",n+26,s+13,50,16);const w=g.client_signature_name||"Client",D=g.client_signature_title||"",Z=g.client_signature_company||"",te=g.client_signature_date?U(g.client_signature_date):"",P=n+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(w,P,s+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(D||Z)&&t.text(`${D}${D&&Z?", ":""}${Z}`,P,s+18),te&&(t.setTextColor(100,116,139),t.text(`Verified: ${te}`,P,s+24))}catch{const V=g.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${V}`,n+26,s+20)}}}}const G=t.internal.getNumberOfPages();for(let l=1;l<=G;l++){t.setPage(l);const T=h-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,n,T),t.text(`Page ${l} of ${G}`,a-n,T,{align:"right"})}const K=`${i.cor_number||"COR"}_${y?.job_number||"export"}${p.length?"_with_backup":""}.pdf`;return t.save(K),{success:!0,fileName:K,pageCount:G,sizeBytes:t.output().length}}const Je=Object.freeze(Object.defineProperty({__proto__:null,generatePDFFromSnapshot:pe},Symbol.toStringTag,{value:"Module"}));function it({cor:o,project:x,company:b,areas:f,onClose:y,onEdit:k,onShowToast:u,onStatusChange:i}){const[p,t]=R.useState(!0),[a,h]=R.useState(o),[n,s]=R.useState(!1),[C,d]=R.useState(!1),[_,G]=R.useState(new Set),[K,l]=R.useState(null),[T,v]=R.useState(!1),[Y,J]=R.useState(""),g=R.useCallback(async()=>{try{const r=await L.getCORById(o.id);if(r){if(r.tickets?.length){const j=r.tickets.map(I=>I.photos||[]),S=j.flat();if(S.length){const I=await L.resolvePhotoUrls(S);let $=0;r.tickets=r.tickets.map((q,N)=>{const A=j[N].length,be=I.slice($,$+A);return $+=A,{...q,photos:be}})}}h(r)}}catch(r){console.error("Error fetching COR details:",r),u?.("Error loading COR details","error")}finally{t(!1)}},[o.id]);R.useEffect(()=>{g()},[g]),R.useEffect(()=>{const r=L.subscribeToCorTickets?.(o.id,()=>{g()});return()=>{r&&L.unsubscribe?.(r)}},[o.id,g]);const F=R.useMemo(()=>Ae(a),[a]),B=Le(a.status),ae=a.status==="pending_approval",m=["draft","pending_approval","approved"].includes(a.status),O=r=>f?.find(S=>S.id===r)?.name||null,E=async()=>{if(confirm("Approve this change order request?")){t(!0);try{await L.approveCOR(a.id),h({...a,status:"approved",approved_at:new Date().toISOString()}),u?.("COR approved","success"),i?.()}catch(r){console.error("Error approving COR:",r),u?.("Error approving COR","error")}finally{t(!1)}}},H=async()=>{const r=prompt("Enter rejection reason (optional):");if(r!==null){t(!0);try{await L.rejectCOR(a.id,r),h({...a,status:"rejected",rejection_reason:r}),u?.("COR rejected","success"),i?.()}catch(j){console.error("Error rejecting COR:",j),u?.("Error rejecting COR","error")}finally{t(!1)}}},X=async()=>{if(confirm("Mark this COR as billed?")){t(!0);try{await L.markCORAsBilled(a.id),h({...a,status:"billed"}),u?.("COR marked as billed","success"),i?.()}catch(r){console.error("Error marking COR as billed:",r),u?.("Error updating status","error")}finally{t(!1)}}},V=async r=>{t(!0);try{await L.saveCORSignature?.(a.id,{gc_signature:r.signature,gc_signer_name:r.signerName,signed_at:r.signedAt}),h({...a,gc_signature:r.signature,gc_signer_name:r.signerName,signed_at:r.signedAt}),s(!1),u?.("Signature saved","success"),i?.()}catch(j){console.error("Error saving signature:",j),u?.("Error saving signature","error")}finally{t(!1)}},w=a.status==="approved"&&!a.gc_signature,D=async()=>{if(!Y.trim()){v(!1);return}t(!0);try{await L.updateCOR(a.id,{cor_number:Y.trim()}),h({...a,cor_number:Y.trim()}),v(!1),u?.("COR number updated","success")}catch(r){console.error("Error updating COR number:",r),u?.("Error updating COR number","error")}finally{t(!1)}},Z=()=>{J(a.cor_number||""),v(!0)},te=r=>{G(j=>{const S=new Set(j);return S.has(r)?S.delete(r):S.add(r),S})},P=R.useMemo(()=>a.change_order_ticket_associations?.map(r=>r.t_and_m_tickets).filter(Boolean)||[],[a.change_order_ticket_associations]),ge=r=>{const j=r.t_and_m_workers||[],S=j.reduce(($,q)=>$+(parseFloat(q.hours)||0),0),I=j.reduce(($,q)=>$+(parseFloat(q.overtime_hours)||0),0);return{regular:S,overtime:I,total:S+I}},xe=async()=>{const r={logoUrl:b?.logo_url,primaryColor:b?.branding_color};try{u?.("Generating PDF...","info");const j=await Qe(a.id,{cor:a,tickets:P,project:x,company:b,branding:r,options:{includeBackup:!0}});u?.(j.cached?"PDF downloaded (cached)":"PDF downloaded","success")}catch(j){console.warn("Export pipeline unavailable, using direct generation:",j?.message);try{const S=me(a,P);await pe(S,{project:x,company:b,branding:r}),u?.("PDF downloaded","success")}catch(S){console.error("Error generating PDF:",S),u?.("Error generating PDF","error")}}};return p?e.jsx("div",{className:"modal-overlay",onClick:y,children:e.jsx("div",{className:"modal-content cor-detail-modal",onClick:r=>r.stopPropagation(),children:e.jsx("div",{className:"cor-detail-loading",children:"Loading COR details..."})})}):e.jsxs("div",{className:"modal-overlay",onClick:y,role:"dialog","aria-modal":"true","aria-labelledby":"cor-detail-title",children:[e.jsxs("div",{className:"modal-content cor-detail-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"modal-header cor-detail-header",children:[e.jsxs("div",{className:"cor-detail-title-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"cor-detail-number",children:T?e.jsxs("div",{className:"cor-number-edit",children:[e.jsx("input",{type:"text",value:Y,onChange:r=>J(r.target.value),onKeyDown:r=>{r.key==="Enter"&&D(),r.key==="Escape"&&v(!1)},autoFocus:!0,className:"cor-number-input"}),e.jsx("button",{className:"btn-icon-sm",onClick:D,title:"Save",children:e.jsx(Ce,{size:14})}),e.jsx("button",{className:"btn-icon-sm",onClick:()=>v(!1),title:"Cancel",children:e.jsx(re,{size:14})})]}):e.jsxs("div",{className:"cor-number-display",children:[e.jsx("span",{children:a.cor_number}),m&&e.jsx("button",{className:"btn-icon-sm",onClick:Z,title:"Edit COR number",children:e.jsx(ve,{size:12})})]})}),e.jsx("h2",{id:"cor-detail-title",children:a.title||"Untitled COR"})]}),e.jsx("button",{className:"close-btn",onClick:y,"aria-label":"Close COR details",children:e.jsx(re,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"cor-detail-meta",children:[e.jsx("span",{className:"cor-detail-status",style:{backgroundColor:B.bgColor,color:B.color},children:B.label}),a.group_name&&e.jsx("span",{className:"cor-detail-group",children:a.group_name}),O(a.area_id)&&e.jsx("span",{className:"cor-detail-area",children:O(a.area_id)}),e.jsxs("span",{className:"cor-detail-period",children:[e.jsx(Ne,{size:14})," ",_e(a.period_start,a.period_end)]})]})]}),e.jsxs("div",{className:"modal-body cor-detail-body",children:[e.jsxs("div",{className:"cor-detail-section",children:[e.jsxs("h3",{children:[e.jsx(ne,{size:18})," Scope of Work"]}),e.jsx("p",{className:"cor-scope-text",children:a.scope_of_work||"No scope of work provided."})]}),e.jsxs("div",{className:"cor-detail-section pricing-breakdown",children:[e.jsxs("h3",{children:[e.jsx(le,{size:18})," Pricing Breakdown"]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ce,{size:16}),e.jsx("span",{children:"Labor"})]}),e.jsx("span",{className:"category-subtotal",children:c(F.labor_subtotal)})]}),a.change_order_labor?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"Reg Rate"}),e.jsx("th",{children:"OT Hrs"}),e.jsx("th",{children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_labor.map((r,j)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.labor_class}),e.jsx("td",{children:r.wage_type}),e.jsx("td",{children:r.regular_hours}),e.jsxs("td",{children:["$",se(r.regular_rate),"/hr"]}),e.jsx("td",{children:r.overtime_hours||"-"}),e.jsx("td",{children:r.overtime_hours?`$${se(r.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:c(r.total)})]},j))})]})}):e.jsx("div",{className:"category-empty",children:"No labor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",z(a.labor_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",c(F.labor_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Se,{size:16}),e.jsx("span",{children:"Materials"})]}),e.jsx("span",{className:"category-subtotal",children:c(F.materials_subtotal)})]}),a.change_order_materials?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_materials.map((r,j)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{children:r.quantity}),e.jsx("td",{children:r.unit}),e.jsxs("td",{children:["$",se(r.unit_cost)]}),e.jsx("td",{className:"text-right",children:c(r.total)})]},j))})]})}):e.jsx("div",{className:"category-empty",children:"No material items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",z(a.materials_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",c(F.materials_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ke,{size:16}),e.jsx("span",{children:"Equipment"})]}),e.jsx("span",{className:"category-subtotal",children:c(F.equipment_subtotal)})]}),a.change_order_equipment?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_equipment.map((r,j)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{children:r.quantity}),e.jsx("td",{children:r.unit}),e.jsxs("td",{children:["$",se(r.unit_cost)]}),e.jsx("td",{className:"text-right",children:c(r.total)})]},j))})]})}):e.jsx("div",{className:"category-empty",children:"No equipment items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",z(a.equipment_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",c(F.equipment_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Fe,{size:16}),e.jsx("span",{children:"Subcontractors"})]}),e.jsx("span",{className:"category-subtotal",children:c(F.subcontractors_subtotal)})]}),a.change_order_subcontractors?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:a.change_order_subcontractors.map((r,j)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.company_name}),e.jsx("td",{children:r.description}),e.jsx("td",{children:r.source_reference||r.source_type}),e.jsx("td",{className:"text-right",children:c(r.total)})]},j))})]})}):e.jsx("div",{className:"category-empty",children:"No subcontractor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",z(a.subcontractors_markup_percent||500),")"]}),e.jsxs("span",{children:["+",c(F.subcontractors_markup_amount)]})]})]}),e.jsxs("div",{className:"cor-subtotal-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:c(F.cor_subtotal)})]}),e.jsxs("div",{className:"pricing-category fees-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Te,{size:16}),e.jsx("span",{children:"Additional Fees"})]}),e.jsx("span",{className:"category-subtotal",children:c(F.additional_fees_total)})]}),e.jsxs("div",{className:"fees-list",children:[e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(Ee,{size:14}),e.jsxs("span",{children:["Liability Insurance (",z(a.liability_insurance_percent||144),")"]})]}),e.jsx("span",{className:"fee-amount",children:c(F.liability_insurance_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(ne,{size:14}),e.jsxs("span",{children:["Bond (",z(a.bond_percent||100),")"]})]}),e.jsx("span",{className:"fee-amount",children:c(F.bond_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(ze,{size:14}),e.jsxs("span",{children:["City License Fee (",z(a.license_fee_percent||10),")"]})]}),e.jsx("span",{className:"fee-amount",children:c(F.license_fee_amount)})]})]})]}),e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:c(F.cor_total)})]})]}),P.length>0&&e.jsxs("div",{className:"cor-detail-section backup-section",children:[e.jsxs("h3",{children:[e.jsx(ne,{size:18})," Backup Documentation"]}),e.jsxs("p",{className:"backup-summary",children:[P.length," Time & Material ticket",P.length!==1?"s":""," associated with this COR"]}),e.jsx("div",{className:"backup-tickets-list",children:P.map(r=>{const j=_.has(r.id),S=ge(r),I=r.t_and_m_workers?.length||0,$=r.t_and_m_items?.length||0,q=r.photos?.length||0;return e.jsxs("div",{className:"backup-ticket-card",children:[e.jsxs("div",{className:"backup-ticket-header",onClick:()=>te(r.id),children:[e.jsx("div",{className:"backup-ticket-toggle",children:j?e.jsx(Re,{size:18}):e.jsx(Oe,{size:18})}),e.jsxs("div",{className:"backup-ticket-info",children:[e.jsxs("div",{className:"backup-ticket-date",children:[e.jsx(Pe,{size:14}),e.jsx("span",{children:U(r.work_date)})]}),r.ce_pco_number&&e.jsxs("span",{className:"backup-ticket-pco",children:["CE/PCO: ",r.ce_pco_number]})]}),e.jsxs("div",{className:"backup-ticket-stats",children:[e.jsxs("span",{className:"backup-stat",children:[e.jsx(ce,{size:14})," ",I]}),e.jsxs("span",{className:"backup-stat",children:[S.total.toFixed(1)," hrs"]}),q>0&&e.jsxs("span",{className:"backup-stat",children:[e.jsx(we,{size:14})," ",q]}),r.client_signature_data&&e.jsxs("span",{className:"backup-stat verified",title:`Verified by ${r.client_signature_name}`,children:[e.jsx(oe,{size:14})," Verified"]})]}),e.jsx("span",{className:`backup-ticket-status status-${r.status}`,children:r.status})]}),j&&e.jsxs("div",{className:"backup-ticket-details",children:[r.notes&&e.jsxs("div",{className:"backup-ticket-notes",children:[e.jsx("strong",{children:"Notes:"})," ",r.notes]}),r.t_and_m_workers?.length>0&&e.jsxs("div",{className:"backup-workers",children:[e.jsxs("h4",{children:["Labor (",I," workers)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT Hrs"})]})}),e.jsx("tbody",{children:r.t_and_m_workers.map((N,A)=>e.jsxs("tr",{children:[e.jsx("td",{children:N.name}),e.jsx("td",{children:N.role||"-"}),e.jsx("td",{className:"backup-time-range",children:N.time_started&&N.time_ended?`${N.time_started} - ${N.time_ended}`:"-"}),e.jsx("td",{children:N.hours||0}),e.jsx("td",{children:N.overtime_hours||"-"})]},A))})]})]}),r.t_and_m_items?.length>0&&e.jsxs("div",{className:"backup-items",children:[e.jsxs("h4",{children:["Materials & Equipment (",$," items)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Qty"})]})}),e.jsx("tbody",{children:r.t_and_m_items.map((N,A)=>e.jsxs("tr",{children:[e.jsx("td",{children:N.custom_name||N.materials_equipment?.name||"Unnamed Item"}),e.jsx("td",{children:N.custom_category||N.materials_equipment?.category||"-"}),e.jsx("td",{children:N.quantity})]},A))})]})]}),r.photos?.length>0&&e.jsxs("div",{className:"backup-photos",children:[e.jsxs("h4",{children:["Photos (",q,")"]}),e.jsx("div",{className:"backup-photos-grid",children:r.photos.map((N,A)=>e.jsx("div",{className:"backup-photo-thumb",onClick:()=>l(N),children:e.jsx("img",{src:N,alt:`Photo ${A+1}`})},A))})]}),r.client_signature_data&&e.jsxs("div",{className:"backup-verification",children:[e.jsxs("h4",{children:[e.jsx(oe,{size:14})," Client Verification"]}),e.jsxs("div",{className:"backup-signature-display",children:[e.jsx("img",{src:r.client_signature_data,alt:"Client Signature",className:"backup-signature-image"}),e.jsxs("div",{className:"backup-signature-info",children:[e.jsx("span",{className:"backup-signer-name",children:r.client_signature_name}),r.client_signature_title&&e.jsx("span",{className:"backup-signer-title",children:r.client_signature_title}),r.client_signature_company&&e.jsx("span",{className:"backup-signer-company",children:r.client_signature_company}),e.jsxs("span",{className:"backup-signed-date",children:["Verified: ",U(r.client_signature_date)]})]})]})]})]})]},r.id)})})]}),(a.gc_signature_data||a.gc_signature||a.client_signature_data)&&e.jsxs("div",{className:"cor-detail-section signature-section",children:[e.jsxs("h3",{children:[e.jsx(De,{size:18})," Signatures"]}),e.jsxs("div",{className:"dual-signatures",children:[(a.gc_signature_data||a.gc_signature)&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"GC Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.gc_signature_data||a.gc_signature,alt:"GC Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.gc_signature_name||a.gc_signer_name}),(a.gc_signature_title||a.gc_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.gc_signature_title,a.gc_signature_title&&a.gc_signature_company&&" - ",a.gc_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",U(a.gc_signature_date||a.signed_at)]})]})]})]}),a.client_signature_data&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"Client Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.client_signature_data,alt:"Client Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.client_signature_name}),(a.client_signature_title||a.client_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.client_signature_title,a.client_signature_title&&a.client_signature_company&&" - ",a.client_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",U(a.client_signature_date)]})]})]})]})]})]}),a.status==="rejected"&&a.rejection_reason&&e.jsxs("div",{className:"cor-detail-section rejection-section",children:[e.jsxs("h3",{children:[e.jsx(de,{size:18})," Rejection Reason"]}),e.jsx("p",{className:"rejection-text",children:a.rejection_reason})]})]}),e.jsxs("div",{className:"modal-footer cor-detail-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{children:["Created: ",U(a.created_at)]}),a.approved_at&&e.jsxs("span",{children:["Approved: ",U(a.approved_at)]})]}),e.jsxs("div",{className:"footer-actions",role:"group","aria-label":"COR actions",children:[m&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>k?.(a),disabled:p,"aria-label":"Edit this COR",children:[e.jsx(Ie,{size:16,"aria-hidden":"true"})," Edit"]}),ae&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:H,disabled:p,"aria-label":"Reject this COR",children:[e.jsx(de,{size:16,"aria-hidden":"true"})," Reject"]}),e.jsxs("button",{className:"btn btn-success",onClick:E,disabled:p,"aria-label":"Approve this COR",children:[e.jsx($e,{size:16,"aria-hidden":"true"})," Approve"]})]}),w&&e.jsxs("button",{className:"btn btn-success",onClick:()=>s(!0),disabled:p,"aria-label":"Get GC signature for this COR",children:[e.jsx(oe,{size:16,"aria-hidden":"true"})," Get GC Signature"]}),(a.status==="approved"||a.status==="pending_approval")&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>d(!0),disabled:p,"aria-label":"Get shareable signature link",children:[e.jsx(qe,{size:16,"aria-hidden":"true"})," Get Signature Link"]}),a.status==="approved"&&e.jsxs("button",{className:"btn btn-primary",onClick:X,disabled:p,"aria-label":"Mark this COR as billed",children:[e.jsx(le,{size:16,"aria-hidden":"true"})," Mark Billed"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Ue(a),"aria-label":"Export COR to CSV",children:[e.jsx(ue,{size:16,"aria-hidden":"true"})," Export CSV"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:xe,"aria-label":"Export COR to PDF",children:[e.jsx(ue,{size:16,"aria-hidden":"true"})," Export PDF"]})]})]})]}),n&&e.jsx(Me,{onSave:V,onClose:()=>s(!1),signerName:""}),C&&e.jsx(Ge,{documentType:"cor",documentId:a.id,companyId:b?.id,projectId:x?.id,project:x,documentTitle:`COR ${a.cor_number}: ${a.title||"Untitled"}`,onClose:()=>d(!1),onShowToast:u}),K&&e.jsxs("div",{className:"photo-lightbox",onClick:()=>l(null),children:[e.jsx("button",{className:"lightbox-close",onClick:()=>l(null),children:e.jsx(re,{size:24})}),e.jsx("img",{src:K,alt:"Full size photo",onClick:r=>r.stopPropagation()})]})]})}export{it as default};
//# sourceMappingURL=CORDetail-Bov_nYP9.js.map
