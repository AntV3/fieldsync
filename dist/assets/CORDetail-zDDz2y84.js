const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CCJihOTb.js","assets/icons-B-oSmWeD.js","assets/react-DXGY7bZi.js","assets/pdf-aQqpMATS.js","assets/supabase-VuevzHjS.js","assets/index-BSzkIGa9.css","assets/corPdfGenerator-CNsW6hXO.js","assets/corCalculations-D9qkkIbo.js"])))=>i.map(i=>d[i]);
import{aq as A,aK as S,as as e,ar as O}from"./index-CCJihOTb.js";import{r as f,X as V,a7 as me,R as pe,d as te,aq as ge,c as xe,F as X,Q as ee,N as se,ac as je,l as be,B as Ne,aD as fe,v as ve,ao as ye,q as ke,y as Ce,O as we,I as Re,aE as K,aF as Ee,a5 as ae,P as Oe,j as Se,g as De,D as Ie}from"./icons-B-oSmWeD.js";import{c as ze,g as Pe,a as qe,f as b,e as $,d as I,b as T}from"./corCalculations-D9qkkIbo.js";import{_ as Q}from"./pdf-aQqpMATS.js";import Te from"./SignatureLinkGenerator-D2X-QvME.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const F={PENDING:"pending",GENERATING:"generating",COMPLETED:"completed",FAILED:"failed"},Fe={PDF:"pdf"};function Ae(t,u,_=null){if(_)return`custom_${_}`;const p=Math.floor(Date.now()/6e4);return`cor_${t}_v${u||1}_${p}`}function Me(t){return`cor_${t}_force_${Date.now()}`}function Ue(t,u,_={}){const p=new Date().toISOString(),x=[];let k=0;for(const r of u||[]){const i=r.photos||[];k+=i.length;for(const M of i)x.push({ticketId:r.id,workDate:r.work_date,url:M,verified:!1,includedInExport:!0})}const n=(t.change_order_labor||[]).reduce((r,i)=>r+(parseInt(i.total)||0),0),l=(t.change_order_materials||[]).reduce((r,i)=>r+(parseInt(i.total)||0),0),o=(t.change_order_equipment||[]).reduce((r,i)=>r+(parseInt(i.total)||0),0),m=(t.change_order_subcontractors||[]).reduce((r,i)=>r+(parseInt(i.total)||0),0);let a=0,d=0;for(const r of u||[])for(const i of r.t_and_m_workers||[])a+=parseFloat(i.hours)||0,d+=parseFloat(i.overtime_hours)||0;const y=JSON.stringify({corId:t.id,version:t.version,totals:{laborTotal:n,materialsTotal:l,equipmentTotal:o,subcontractorsTotal:m},ticketCount:u?.length||0,photoCount:k});let j=0;for(let r=0;r<y.length;r++){const i=y.charCodeAt(r);j=(j<<5)-j+i,j=j&j}const C=Math.abs(j).toString(16).padStart(16,"0");return{snapshotId:crypto.randomUUID(),corId:t.id,corVersion:t.version||1,createdAt:p,checksum:C,corData:{id:t.id,cor_number:t.cor_number,title:t.title,description:t.description,scope_of_work:t.scope_of_work,status:t.status,period_start:t.period_start,period_end:t.period_end,change_order_labor:t.change_order_labor||[],change_order_materials:t.change_order_materials||[],change_order_equipment:t.change_order_equipment||[],change_order_subcontractors:t.change_order_subcontractors||[],labor_markup_percent:t.labor_markup_percent,materials_markup_percent:t.materials_markup_percent,equipment_markup_percent:t.equipment_markup_percent,subcontractors_markup_percent:t.subcontractors_markup_percent,liability_insurance_percent:t.liability_insurance_percent,bond_percent:t.bond_percent,license_fee_percent:t.license_fee_percent,labor_subtotal:t.labor_subtotal,materials_subtotal:t.materials_subtotal,equipment_subtotal:t.equipment_subtotal,subcontractors_subtotal:t.subcontractors_subtotal,labor_markup_amount:t.labor_markup_amount,materials_markup_amount:t.materials_markup_amount,equipment_markup_amount:t.equipment_markup_amount,subcontractors_markup_amount:t.subcontractors_markup_amount,liability_insurance_amount:t.liability_insurance_amount,bond_amount:t.bond_amount,license_fee_amount:t.license_fee_amount,cor_subtotal:t.cor_subtotal,additional_fees_total:t.additional_fees_total,cor_total:t.cor_total,gc_signature_data:t.gc_signature_data,gc_signature_name:t.gc_signature_name,gc_signature_date:t.gc_signature_date,created_at:t.created_at,submitted_at:t.submitted_at,approved_at:t.approved_at},ticketsData:(u||[]).map(r=>({id:r.id,work_date:r.work_date,ticket_date:r.ticket_date,ce_pco_number:r.ce_pco_number,notes:r.notes,status:r.status,created_at:r.created_at,t_and_m_workers:(r.t_and_m_workers||[]).map(i=>({id:i.id,name:i.name,role:i.role,labor_class:i.labor_class,hours:i.hours,overtime_hours:i.overtime_hours,time_started:i.time_started,time_ended:i.time_ended})),t_and_m_items:(r.t_and_m_items||[]).map(i=>({id:i.id,description:i.description,quantity:i.quantity,unit:i.unit,materials_equipment:i.materials_equipment})),photos:r.photos||[],client_signature_data:r.client_signature_data,client_signature_name:r.client_signature_name,client_signature_title:r.client_signature_title,client_signature_company:r.client_signature_company,client_signature_date:r.client_signature_date})),photoManifest:x,totals:{laborTotal:n,materialsTotal:l,equipmentTotal:o,subcontractorsTotal:m,totalLaborHours:a,totalOTHours:d,ticketCount:u?.length||0,photoCount:k,verifiedTicketCount:(u||[]).filter(r=>r.client_signature_data).length}}}async function Le(t,u={}){const{forceNew:_=!1,idempotencyKey:p=null,exportType:x=Fe.PDF,includeBackup:k=!0}=u;try{const{data:n,error:l}=await S.from("change_orders").select("id, version, cor_number").eq("id",t).single();if(l||!n)throw new Error(`COR not found: ${t}`);const o=_?Me(t):p||Ae(t,n.version),{data:m,error:a}=await S.rpc("request_cor_export",{p_cor_id:t,p_idempotency_key:o,p_options:{exportType:x,includeBackup:k},p_requested_by:(await S.auth.getUser())?.data?.user?.id});if(a)throw a;const d=m?.[0];if(!d)throw new Error("Failed to create export job");return A.activity("cor_export_requested",{cor_id:t,job_id:d.job_id,is_new:d.is_new,status:d.status}),{jobId:d.job_id,status:d.status,isNew:d.is_new,snapshotId:d.snapshot_id,pdfUrl:d.pdf_url,idempotencyKey:o}}catch(n){throw A.error("cor_export_request_failed",{cor_id:t,error:n.message}),n}}async function Y(t,u,_={}){const{data:p,error:x}=await S.rpc("update_export_job_status",{p_job_id:t,p_status:u,p_snapshot_id:_.snapshotId||null,p_pdf_url:_.pdfUrl||null,p_error:_.error||null,p_error_details:_.errorDetails||null,p_metrics:_.metrics||null});if(x)throw A.error("cor_export_job_update_failed",{job_id:t,status:u,error:x.message}),x;return p}async function Ge(t,u){await S.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",t.corId);const{data:_,error:p}=await S.from("cor_export_snapshots").insert({id:t.snapshotId,cor_id:t.corId,job_id:u,cor_version:t.corVersion,cor_data:t.corData,tickets_data:t.ticketsData,photos_manifest:t.photoManifest,totals_snapshot:t.totals,checksum:t.checksum,is_current:!0,exported_by:(await S.auth.getUser())?.data?.user?.id}).select().single();if(p)throw p;return await S.from("change_orders").update({last_snapshot_version:t.corVersion}).eq("id",t.corId),_}async function Be(t,{cor:u,tickets:_,project:p,company:x,branding:k,options:n={}}={}){let l=null;try{if(l=await Le(t,n),l.status===F.COMPLETED&&l.pdfUrl)return A.activity("cor_export_cache_hit",{cor_id:t,job_id:l.jobId}),{success:!0,jobId:l.jobId,cached:!0,pdfUrl:l.pdfUrl};if(l.status===F.GENERATING)return{success:!0,jobId:l.jobId,status:F.GENERATING,message:"Export already in progress"};if(await Y(l.jobId,F.GENERATING),!u){const{db:y}=await Q(async()=>{const{db:j}=await import("./index-CCJihOTb.js").then(C=>C.aU);return{db:j}},__vite__mapDeps([0,1,2,3,4,5]));u=await y.getCORById(t)}if(!_&&n.includeBackup!==!1){const{db:y}=await Q(async()=>{const{db:j}=await import("./index-CCJihOTb.js").then(C=>C.aU);return{db:j}},__vite__mapDeps([0,1,2,3,4,5]));_=await y.getCORTickets(t)}const o=Ue(u,_,n),m=await Ge(o,l.jobId),{generatePDFFromSnapshot:a}=await Q(async()=>{const{generatePDFFromSnapshot:y}=await import("./corPdfGenerator-CNsW6hXO.js");return{generatePDFFromSnapshot:y}},__vite__mapDeps([6,3,7,0,1,2,4,5])),d=await a(o,{project:p,company:x,branding:k});return await Y(l.jobId,F.COMPLETED,{snapshotId:m.id,pdfUrl:d.fileName,metrics:{photo_count:o.totals.photoCount,ticket_count:o.totals.ticketCount,page_count:d.pageCount||1,pdf_size_bytes:d.sizeBytes||0}}),A.activity("cor_export_completed",{cor_id:t,job_id:l.jobId,photo_count:o.totals.photoCount,ticket_count:o.totals.ticketCount}),{success:!0,jobId:l.jobId,snapshotId:m.id,fileName:d.fileName,snapshot:o.totals}}catch(o){throw l?.jobId&&await Y(l.jobId,F.FAILED,{error:o.message,errorDetails:{stack:o.stack}}).catch(()=>{}),A.error("cor_export_failed",{cor_id:t,job_id:l?.jobId,error:o.message}),o}}function $e({onSave:t,onClose:u,signerName:_=""}){const p=f.useRef(null),[x,k]=f.useState(_),[n,l]=f.useState(!1),[o,m]=f.useState(!1),a=()=>{const c=p.current;return c?c.getContext("2d"):null},d=c=>{const h=p.current;if(!h)return{x:0,y:0};const E=h.getBoundingClientRect(),w=h.width/E.width,z=h.height/E.height,B=c.touches?.length?c.touches[0].clientX:c.clientX,P=c.touches?.length?c.touches[0].clientY:c.clientY;return{x:(B-E.left)*w,y:(P-E.top)*z}},y=c=>{c.preventDefault();const h=a();if(!h)return;const{x:E,y:w}=d(c);h.beginPath(),h.moveTo(E,w),m(!0),l(!0)},j=c=>{if(!o)return;c.preventDefault();const h=a();if(!h)return;const{x:E,y:w}=d(c);h.lineTo(E,w),h.stroke()},C=()=>{m(!1)},r=()=>{const c=p.current,h=a();!c||!h||(h.clearRect(0,0,c.width,c.height),l(!1))},i=c=>{if(!c)return;p.current=c;const h=c.getContext("2d");h.strokeStyle="#1e293b",h.lineWidth=2,h.lineCap="round",h.lineJoin="round"},M=()=>{if(!n||!x.trim())return;const c=p.current;if(!c)return;const h=c.toDataURL("image/png");t({signature:h,signerName:x.trim(),signedAt:new Date().toISOString()})};return e.jsx("div",{className:"modal-overlay",onClick:u,role:"dialog","aria-modal":"true","aria-labelledby":"signature-title",children:e.jsxs("div",{className:"modal-content signature-modal",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{id:"signature-title",children:"GC Signature"}),e.jsx("button",{className:"close-btn",onClick:u,"aria-label":"Close signature modal",children:e.jsx(V,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"modal-body signature-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"signer-name",children:"Signer Name *"}),e.jsx("input",{id:"signer-name",type:"text",value:x,onChange:c=>k(c.target.value),placeholder:"Enter full name","aria-required":"true"})]}),e.jsxs("div",{className:"signature-area",children:[e.jsxs("div",{className:"signature-label",id:"signature-instructions",children:[e.jsx(me,{size:16,"aria-hidden":"true"}),e.jsx("span",{children:"Sign below"})]}),e.jsxs("div",{className:"signature-canvas-container",children:[e.jsx("canvas",{ref:i,width:500,height:200,className:"signature-canvas",onMouseDown:y,onMouseMove:j,onMouseUp:C,onMouseLeave:C,onTouchStart:y,onTouchMove:j,onTouchEnd:C,role:"img","aria-label":"Signature drawing area. Use mouse or touch to draw your signature.","aria-describedby":"signature-instructions",tabIndex:0}),!n&&e.jsx("div",{className:"signature-placeholder",children:"Sign here"})]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:r,disabled:!n,"aria-label":"Clear signature",children:[e.jsx(pe,{size:14,"aria-hidden":"true"})," Clear"]})]}),e.jsx("p",{className:"signature-legal",role:"note",children:"By signing above, I acknowledge that I have reviewed and approve this Change Order Request."})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:u,"aria-label":"Cancel and close",children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:M,disabled:!n||!x.trim(),"aria-label":"Save signature",children:[e.jsx(te,{size:16,"aria-hidden":"true"})," Save Signature"]})]})]})})}function We({cor:t,project:u,company:_,areas:p,onClose:x,onEdit:k,onShowToast:n,onStatusChange:l}){const[o,m]=f.useState(!0),[a,d]=f.useState(t),[y,j]=f.useState(!1),[C,r]=f.useState(!1),[i,M]=f.useState(new Set),[c,h]=f.useState(null),[E,w]=f.useState(!1),[z,B]=f.useState(""),P=f.useCallback(async()=>{try{const s=await O.getCORById(t.id);s&&d(s)}catch(s){console.error("Error fetching COR details:",s),n?.("Error loading COR details","error")}finally{m(!1)}},[t.id]);f.useEffect(()=>{P()},[P]),f.useEffect(()=>{const s=O.subscribeToCorTickets?.(t.id,()=>{P()});return()=>{s&&O.unsubscribe?.(s)}},[t.id,P]);const v=f.useMemo(()=>ze(a),[a]),H=Pe(a.status),re=a.status==="pending_approval",J=["draft","pending_approval","approved"].includes(a.status),W=s=>p?.find(R=>R.id===s)?.name||null,ne=async()=>{if(confirm("Approve this change order request?")){m(!0);try{await O.approveCOR(a.id),d({...a,status:"approved",approved_at:new Date().toISOString()}),n?.("COR approved","success"),l?.()}catch(s){console.error("Error approving COR:",s),n?.("Error approving COR","error")}finally{m(!1)}}},ie=async()=>{const s=prompt("Enter rejection reason (optional):");if(s!==null){m(!0);try{await O.rejectCOR(a.id,s),d({...a,status:"rejected",rejection_reason:s}),n?.("COR rejected","success"),l?.()}catch(g){console.error("Error rejecting COR:",g),n?.("Error rejecting COR","error")}finally{m(!1)}}},ce=async()=>{if(confirm("Mark this COR as billed?")){m(!0);try{await O.markCORAsBilled(a.id),d({...a,status:"billed"}),n?.("COR marked as billed","success"),l?.()}catch(s){console.error("Error marking COR as billed:",s),n?.("Error updating status","error")}finally{m(!1)}}},le=async s=>{m(!0);try{await O.saveCORSignature?.(a.id,{gc_signature:s.signature,gc_signer_name:s.signerName,signed_at:s.signedAt}),d({...a,gc_signature:s.signature,gc_signer_name:s.signerName,signed_at:s.signedAt}),j(!1),n?.("Signature saved","success"),l?.()}catch(g){console.error("Error saving signature:",g),n?.("Error saving signature","error")}finally{m(!1)}},oe=a.status==="approved"&&!a.gc_signature,Z=async()=>{if(!z.trim()){w(!1);return}m(!0);try{await O.updateCOR(a.id,{cor_number:z.trim()}),d({...a,cor_number:z.trim()}),w(!1),n?.("COR number updated","success")}catch(s){console.error("Error updating COR number:",s),n?.("Error updating COR number","error")}finally{m(!1)}},de=()=>{B(a.cor_number||""),w(!0)},ue=s=>{M(g=>{const R=new Set(g);return R.has(s)?R.delete(s):R.add(s),R})},U=f.useMemo(()=>a.change_order_ticket_associations?.map(s=>s.t_and_m_tickets).filter(Boolean)||[],[a.change_order_ticket_associations]),he=s=>{const g=s.t_and_m_workers||[],R=g.reduce((G,D)=>G+(parseFloat(D.hours)||0),0),L=g.reduce((G,D)=>G+(parseFloat(D.overtime_hours)||0),0);return{regular:R,overtime:L,total:R+L}},_e=async()=>{try{n?.("Generating PDF with backup...","info"),(await Be(a.id,{cor:a,tickets:U,project:u,company:_,branding:{logoUrl:_?.logo_url,primaryColor:_?.branding_color},options:{includeBackup:!0}})).cached?n?.("PDF downloaded (cached)","success"):n?.("PDF downloaded","success")}catch(s){console.error("Error exporting PDF:",s),n?.("Error generating PDF","error")}};return o?e.jsx("div",{className:"modal-overlay",onClick:x,children:e.jsx("div",{className:"modal-content cor-detail-modal",onClick:s=>s.stopPropagation(),children:e.jsx("div",{className:"cor-detail-loading",children:"Loading COR details..."})})}):e.jsxs("div",{className:"modal-overlay",onClick:x,role:"dialog","aria-modal":"true","aria-labelledby":"cor-detail-title",children:[e.jsxs("div",{className:"modal-content cor-detail-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header cor-detail-header",children:[e.jsxs("div",{className:"cor-detail-title-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"cor-detail-number",children:E?e.jsxs("div",{className:"cor-number-edit",children:[e.jsx("input",{type:"text",value:z,onChange:s=>B(s.target.value),onKeyDown:s=>{s.key==="Enter"&&Z(),s.key==="Escape"&&w(!1)},autoFocus:!0,className:"cor-number-input"}),e.jsx("button",{className:"btn-icon-sm",onClick:Z,title:"Save",children:e.jsx(te,{size:14})}),e.jsx("button",{className:"btn-icon-sm",onClick:()=>w(!1),title:"Cancel",children:e.jsx(V,{size:14})})]}):e.jsxs("div",{className:"cor-number-display",children:[e.jsx("span",{children:a.cor_number}),J&&e.jsx("button",{className:"btn-icon-sm",onClick:de,title:"Edit COR number",children:e.jsx(ge,{size:12})})]})}),e.jsx("h2",{id:"cor-detail-title",children:a.title||"Untitled COR"})]}),e.jsx("button",{className:"close-btn",onClick:x,"aria-label":"Close COR details",children:e.jsx(V,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"cor-detail-meta",children:[e.jsx("span",{className:"cor-detail-status",style:{backgroundColor:H.bgColor,color:H.color},children:H.label}),a.group_name&&e.jsx("span",{className:"cor-detail-group",children:a.group_name}),W(a.area_id)&&e.jsx("span",{className:"cor-detail-area",children:W(a.area_id)}),e.jsxs("span",{className:"cor-detail-period",children:[e.jsx(xe,{size:14})," ",qe(a.period_start,a.period_end)]})]})]}),e.jsxs("div",{className:"modal-body cor-detail-body",children:[e.jsxs("div",{className:"cor-detail-section",children:[e.jsxs("h3",{children:[e.jsx(X,{size:18})," Scope of Work"]}),e.jsx("p",{className:"cor-scope-text",children:a.scope_of_work||"No scope of work provided."})]}),e.jsxs("div",{className:"cor-detail-section pricing-breakdown",children:[e.jsxs("h3",{children:[e.jsx(ee,{size:18})," Pricing Breakdown"]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(se,{size:16}),e.jsx("span",{children:"Labor"})]}),e.jsx("span",{className:"category-subtotal",children:b(v.labor_subtotal)})]}),a.change_order_labor?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"Reg Rate"}),e.jsx("th",{children:"OT Hrs"}),e.jsx("th",{children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_labor.map((s,g)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.labor_class}),e.jsx("td",{children:s.wage_type}),e.jsx("td",{children:s.regular_hours}),e.jsxs("td",{children:["$",$(s.regular_rate),"/hr"]}),e.jsx("td",{children:s.overtime_hours||"-"}),e.jsx("td",{children:s.overtime_hours?`$${$(s.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:b(s.total)})]},g))})]})}):e.jsx("div",{className:"category-empty",children:"No labor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.labor_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",b(v.labor_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(je,{size:16}),e.jsx("span",{children:"Materials"})]}),e.jsx("span",{className:"category-subtotal",children:b(v.materials_subtotal)})]}),a.change_order_materials?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_materials.map((s,g)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{children:s.quantity}),e.jsx("td",{children:s.unit}),e.jsxs("td",{children:["$",$(s.unit_cost)]}),e.jsx("td",{className:"text-right",children:b(s.total)})]},g))})]})}):e.jsx("div",{className:"category-empty",children:"No material items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.materials_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",b(v.materials_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(be,{size:16}),e.jsx("span",{children:"Equipment"})]}),e.jsx("span",{className:"category-subtotal",children:b(v.equipment_subtotal)})]}),a.change_order_equipment?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_equipment.map((s,g)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{children:s.quantity}),e.jsx("td",{children:s.unit}),e.jsxs("td",{children:["$",$(s.unit_cost)]}),e.jsx("td",{className:"text-right",children:b(s.total)})]},g))})]})}):e.jsx("div",{className:"category-empty",children:"No equipment items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.equipment_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",b(v.equipment_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Ne,{size:16}),e.jsx("span",{children:"Subcontractors"})]}),e.jsx("span",{className:"category-subtotal",children:b(v.subcontractors_subtotal)})]}),a.change_order_subcontractors?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:a.change_order_subcontractors.map((s,g)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.company_name}),e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{className:"text-right",children:b(s.total)})]},g))})]})}):e.jsx("div",{className:"category-empty",children:"No subcontractor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",I(a.subcontractors_markup_percent||500),")"]}),e.jsxs("span",{children:["+",b(v.subcontractors_markup_amount)]})]})]}),e.jsxs("div",{className:"cor-subtotal-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:b(v.cor_subtotal)})]}),e.jsxs("div",{className:"pricing-category fees-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(fe,{size:16}),e.jsx("span",{children:"Additional Fees"})]}),e.jsx("span",{className:"category-subtotal",children:b(v.additional_fees_total)})]}),e.jsxs("div",{className:"fees-list",children:[e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(ve,{size:14}),e.jsxs("span",{children:["Liability Insurance (",I(a.liability_insurance_percent||144),")"]})]}),e.jsx("span",{className:"fee-amount",children:b(v.liability_insurance_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(X,{size:14}),e.jsxs("span",{children:["Bond (",I(a.bond_percent||100),")"]})]}),e.jsx("span",{className:"fee-amount",children:b(v.bond_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(ye,{size:14}),e.jsxs("span",{children:["City License Fee (",I(a.license_fee_percent||10),")"]})]}),e.jsx("span",{className:"fee-amount",children:b(v.license_fee_amount)})]})]})]}),e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:b(v.cor_total)})]})]}),U.length>0&&e.jsxs("div",{className:"cor-detail-section backup-section",children:[e.jsxs("h3",{children:[e.jsx(X,{size:18})," Backup Documentation"]}),e.jsxs("p",{className:"backup-summary",children:[U.length," T&M ticket",U.length!==1?"s":""," associated with this COR"]}),e.jsx("div",{className:"backup-tickets-list",children:U.map(s=>{const g=i.has(s.id),R=he(s),L=s.t_and_m_workers?.length||0,G=s.t_and_m_items?.length||0,D=s.photos?.length||0;return e.jsxs("div",{className:"backup-ticket-card",children:[e.jsxs("div",{className:"backup-ticket-header",onClick:()=>ue(s.id),children:[e.jsx("div",{className:"backup-ticket-toggle",children:g?e.jsx(ke,{size:18}):e.jsx(Ce,{size:18})}),e.jsxs("div",{className:"backup-ticket-info",children:[e.jsxs("div",{className:"backup-ticket-date",children:[e.jsx(we,{size:14}),e.jsx("span",{children:T(s.work_date)})]}),s.ce_pco_number&&e.jsxs("span",{className:"backup-ticket-pco",children:["CE/PCO: ",s.ce_pco_number]})]}),e.jsxs("div",{className:"backup-ticket-stats",children:[e.jsxs("span",{className:"backup-stat",children:[e.jsx(se,{size:14})," ",L]}),e.jsxs("span",{className:"backup-stat",children:[R.total.toFixed(1)," hrs"]}),D>0&&e.jsxs("span",{className:"backup-stat",children:[e.jsx(Re,{size:14})," ",D]}),s.client_signature_data&&e.jsxs("span",{className:"backup-stat verified",title:`Verified by ${s.client_signature_name}`,children:[e.jsx(K,{size:14})," Verified"]})]}),e.jsx("span",{className:`backup-ticket-status status-${s.status}`,children:s.status})]}),g&&e.jsxs("div",{className:"backup-ticket-details",children:[s.notes&&e.jsxs("div",{className:"backup-ticket-notes",children:[e.jsx("strong",{children:"Notes:"})," ",s.notes]}),s.t_and_m_workers?.length>0&&e.jsxs("div",{className:"backup-workers",children:[e.jsxs("h4",{children:["Labor (",L," workers)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT Hrs"})]})}),e.jsx("tbody",{children:s.t_and_m_workers.map((N,q)=>e.jsxs("tr",{children:[e.jsx("td",{children:N.name}),e.jsx("td",{children:N.role||"-"}),e.jsx("td",{className:"backup-time-range",children:N.time_started&&N.time_ended?`${N.time_started} - ${N.time_ended}`:"-"}),e.jsx("td",{children:N.hours||0}),e.jsx("td",{children:N.overtime_hours||"-"})]},q))})]})]}),s.t_and_m_items?.length>0&&e.jsxs("div",{className:"backup-items",children:[e.jsxs("h4",{children:["Materials & Equipment (",G," items)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Qty"})]})}),e.jsx("tbody",{children:s.t_and_m_items.map((N,q)=>e.jsxs("tr",{children:[e.jsx("td",{children:N.custom_name||N.materials_equipment?.name||"Unnamed Item"}),e.jsx("td",{children:N.custom_category||N.materials_equipment?.category||"-"}),e.jsx("td",{children:N.quantity})]},q))})]})]}),s.photos?.length>0&&e.jsxs("div",{className:"backup-photos",children:[e.jsxs("h4",{children:["Photos (",D,")"]}),e.jsx("div",{className:"backup-photos-grid",children:s.photos.map((N,q)=>e.jsx("div",{className:"backup-photo-thumb",onClick:()=>h(N),children:e.jsx("img",{src:N,alt:`Photo ${q+1}`})},q))})]}),s.client_signature_data&&e.jsxs("div",{className:"backup-verification",children:[e.jsxs("h4",{children:[e.jsx(K,{size:14})," Client Verification"]}),e.jsxs("div",{className:"backup-signature-display",children:[e.jsx("img",{src:s.client_signature_data,alt:"Client Signature",className:"backup-signature-image"}),e.jsxs("div",{className:"backup-signature-info",children:[e.jsx("span",{className:"backup-signer-name",children:s.client_signature_name}),s.client_signature_title&&e.jsx("span",{className:"backup-signer-title",children:s.client_signature_title}),s.client_signature_company&&e.jsx("span",{className:"backup-signer-company",children:s.client_signature_company}),e.jsxs("span",{className:"backup-signed-date",children:["Verified: ",T(s.client_signature_date)]})]})]})]})]})]},s.id)})})]}),(a.gc_signature_data||a.gc_signature||a.client_signature_data)&&e.jsxs("div",{className:"cor-detail-section signature-section",children:[e.jsxs("h3",{children:[e.jsx(Ee,{size:18})," Signatures"]}),e.jsxs("div",{className:"dual-signatures",children:[(a.gc_signature_data||a.gc_signature)&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"GC Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.gc_signature_data||a.gc_signature,alt:"GC Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.gc_signature_name||a.gc_signer_name}),(a.gc_signature_title||a.gc_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.gc_signature_title,a.gc_signature_title&&a.gc_signature_company&&" - ",a.gc_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",T(a.gc_signature_date||a.signed_at)]})]})]})]}),a.client_signature_data&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"Client Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.client_signature_data,alt:"Client Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.client_signature_name}),(a.client_signature_title||a.client_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.client_signature_title,a.client_signature_title&&a.client_signature_company&&" - ",a.client_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",T(a.client_signature_date)]})]})]})]})]})]}),a.status==="rejected"&&a.rejection_reason&&e.jsxs("div",{className:"cor-detail-section rejection-section",children:[e.jsxs("h3",{children:[e.jsx(ae,{size:18})," Rejection Reason"]}),e.jsx("p",{className:"rejection-text",children:a.rejection_reason})]})]}),e.jsxs("div",{className:"modal-footer cor-detail-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{children:["Created: ",T(a.created_at)]}),a.approved_at&&e.jsxs("span",{children:["Approved: ",T(a.approved_at)]})]}),e.jsxs("div",{className:"footer-actions",role:"group","aria-label":"COR actions",children:[J&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>k?.(a),disabled:o,"aria-label":"Edit this COR",children:[e.jsx(Oe,{size:16,"aria-hidden":"true"})," Edit"]}),re&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:ie,disabled:o,"aria-label":"Reject this COR",children:[e.jsx(ae,{size:16,"aria-hidden":"true"})," Reject"]}),e.jsxs("button",{className:"btn btn-success",onClick:ne,disabled:o,"aria-label":"Approve this COR",children:[e.jsx(Se,{size:16,"aria-hidden":"true"})," Approve"]})]}),oe&&e.jsxs("button",{className:"btn btn-success",onClick:()=>j(!0),disabled:o,"aria-label":"Get GC signature for this COR",children:[e.jsx(K,{size:16,"aria-hidden":"true"})," Get GC Signature"]}),(a.status==="approved"||a.status==="pending_approval")&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>r(!0),disabled:o,"aria-label":"Get shareable signature link",children:[e.jsx(De,{size:16,"aria-hidden":"true"})," Get Signature Link"]}),a.status==="approved"&&e.jsxs("button",{className:"btn btn-primary",onClick:ce,disabled:o,"aria-label":"Mark this COR as billed",children:[e.jsx(ee,{size:16,"aria-hidden":"true"})," Mark Billed"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:_e,"aria-label":"Export COR to PDF",children:[e.jsx(Ie,{size:16,"aria-hidden":"true"})," Export PDF"]})]})]})]}),y&&e.jsx($e,{onSave:le,onClose:()=>j(!1),signerName:""}),C&&e.jsx(Te,{documentType:"cor",documentId:a.id,companyId:_?.id,projectId:u?.id,documentTitle:`COR ${a.cor_number}: ${a.title||"Untitled"}`,onClose:()=>r(!1),onShowToast:n}),c&&e.jsxs("div",{className:"photo-lightbox",onClick:()=>h(null),children:[e.jsx("button",{className:"lightbox-close",onClick:()=>h(null),children:e.jsx(V,{size:24})}),e.jsx("img",{src:c,alt:"Full size photo",onClick:s=>s.stopPropagation()})]})]})}export{We as default};
//# sourceMappingURL=CORDetail-zDDz2y84.js.map
