import{as as e,ar as H}from"./index-Da6Ug3b9.js";import{r as m}from"./icons-BDU0tZd_.js";import{safeParseExcel as Oe,loadXLSXSafe as Re,safeSheetToJson as Ue}from"./safeXlsx-F6PERwMH.js";import"./react-DXGY7bZi.js";import"./pdf-Dbgi5wV4.js";import"./supabase-VuevzHjS.js";const Y=x=>{if(x==null||x==="")return"";const y=parseFloat(x);return isNaN(y)?"":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(y)},Ne=x=>{if(!x)return null;const y=String(x).replace(/[$,\s]/g,""),V=parseFloat(y);return isNaN(V)?null:V};function He({company:x,user:y,onProjectCreated:V,onShowToast:i}){const[$,K]=m.useState(""),[Q,Z]=m.useState(""),[ee,te]=m.useState(""),[ae,se]=m.useState(""),[ne,re]=m.useState(""),[k,M]=m.useState(""),[T,_]=m.useState("demolition"),[L,O]=m.useState("standard"),[g,j]=m.useState([{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null}]),[le,ie]=m.useState(!1),[ce,R]=m.useState(!1),[ye,A]=m.useState(!1),[f,U]=m.useState([]),[oe,q]=m.useState(!1),[v,de]=m.useState(""),[w,ue]=m.useState(""),[B,me]=m.useState(""),P=m.useRef(null),G=g.reduce((t,n)=>t+(parseFloat(n.weight)||0),0),we=t=>{const n=t.replace(/\D/g,"").slice(0,4);M(n)},Ce=()=>{const t=new Uint32Array(1);crypto.getRandomValues(t);const n=(1e3+t[0]%9e3).toString();M(n)},C=(t,n,a)=>{j(s=>s.map((r,l)=>l===t?{...r,[n]:a}:r))},Se=()=>{j(t=>[...t,{name:"",weight:"",group:"",scheduledValue:null}])},pe=t=>{g.length>1&&j(n=>n.filter((a,s)=>s!==t))},he=(t="value")=>{const n=g.filter(o=>o.name.trim());if(n.length===0){i("Add tasks first","error");return}let a=[...g];const s=g.map((o,c)=>o.name.trim()?c:-1).filter(o=>o>=0);if(t==="value"){const o=n.reduce((c,d)=>c+(parseFloat(d.scheduledValue)||0),0);if(o===0)i("No scheduled values - using equal distribution","info"),t="equal";else{let c=0;s.forEach((d,W)=>{const J=parseFloat(g[d].scheduledValue)||0;let b;W===s.length-1?b=100-c:(b=Math.round(J/o*1e4)/100,c+=b),a[d]={...a[d],weight:b.toFixed(2)}}),j(a),q(!1),i("Weights calculated by value","success");return}}const r=Math.round(100/s.length*100)/100;let l=0;s.forEach((o,c)=>{let d;c===s.length-1?d=100-l:(d=r,l+=d),a[o]={...a[o],weight:d.toFixed(2)}}),j(a),q(!1),i("Weights distributed equally","success")},Ve=()=>{K(""),Z(""),te(""),se(""),re(""),M(""),_("demolition"),O("standard"),de(""),ue(""),me(""),j([{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null}]),A(!1),U([])},ke=()=>{P.current?.click()},Ae=async t=>new Promise((n,a)=>{const s=new FileReader;s.onload=async r=>{try{const l=new Uint8Array(r.target.result),o=await Oe(l),c=o.SheetNames[0],d=o.Sheets[c],W=await Re(),J=Ue(W,d,{header:1}),b=[];let ge="General";const xe=/^\$?\d{1,3}(,\d{3})*(\.\d{2})?$/,F=/^(\d+\.?\d*|[A-Z]\.?\d*)$/i,$e=/^(SF|LF|EA|LS|Days?|MD|Load|CY|SY|GAL|TON)$/i,Me=/^\d{1,3}(,\d{3})*$|^\d+$/,fe=/^(Item|#|No\.?|Description|Scheduled|Value|Amount|Quantity|Unit|Total|Application|Balance|Completed|Stored|Retainage)/i;for(const S of J){if(!S||S.length===0)continue;const u=S.map(h=>h==null?"":String(h).trim()).filter(h=>h.length>0);if(u.length===0)continue;const _e=u.join(" ");if(fe.test(u[0])||u.length>1&&fe.test(u[1])||/^(Total|Subtotal|Grand Total|Base Bid|Contract Sum)/i.test(_e))continue;const z=u.some(h=>xe.test(h.replace(/[$,]/g,"")+(h.includes(".")?"":".00")));if((!z&&u.length<=3&&/^(L\d|Level|Floor|\d+(?:st|nd|rd|th)|Plaza|Street|Basement|Roof|Penthouse|Site|Exterior|Interior|Misc|MEP|ABATEMENT|DEMOLITION|UNIVERSAL|SOFT|TRASH|DEMO|Phase|Division|Section|Area|Building|Wing)/i.test(u[0])||u.length===2&&F.test(u[0])&&!z&&!/^\d+\.\d+$/.test(u[0]))&&!z){ge=(u.find(p=>!F.test(p)&&p.length>1)||u.join(" ")).replace(/\s*\(\d{1,3}(?:,\d{3})*\s*SF\)\s*$/i,"").replace(/\s*[-:]\s*$/,"").trim();continue}let N="",X=!1,ve="",I=null;const be=[];for(let h=0;h<u.length;h++){const p=u[h];if(h===0&&F.test(p)){ve=p;continue}if(!/^ID-\d+$/i.test(p)&&!/^KN\s*\d+$/i.test(p)){if(xe.test(p.replace(/[$,]/g,"")+(p.includes(".")?"":".00"))||/^\$/.test(p)){const Le=p.replace(/[$,]/g,""),E=parseFloat(Le);!isNaN(E)&&E>100&&(I===null||E>I)&&(I=E),X=!0;continue}if(Me.test(p.replace(/,/g,""))){X=!0;continue}$e.test(p)||/^\d+\.?\d*%$/.test(p)||p.length>1&&!F.test(p)&&be.push(p)}}N=be.join(" ").trim(),N=N.replace(/\s+/g," ").replace(/^[-â€¢]\s*/,"").trim(),!(N.length<3)&&(/^(Plan|Page|Total|Base Bid|Payment|Condition|Exclusion|Subtotal)/i.test(N)||X&&N.length>=3&&b.push({name:N,group:ge,itemNumber:ve,scheduledValue:I,selected:!0}))}const je=new Set,Te=b.filter(S=>{const u=`${S.group}:${S.name}`;return je.has(u)?!1:(je.add(u),!0)});n(Te)}catch(l){a(l)}},s.onerror=()=>a(new Error("Failed to read file")),s.readAsArrayBuffer(t)}),Pe=async t=>{const n=t.target.files?.[0];if(!n)return;const a=n.name.split(".").pop().toLowerCase();if(!["xlsx","xls","csv"].includes(a)){i("Please upload an Excel file (.xlsx, .xls, or .csv)","error");return}R(!0);try{const s=await Ae(n);if(s.length===0){i("No tasks found. Check Excel format.","error"),R(!1);return}U(s),A(!0),i(`Found ${s.length} tasks`,"success")}catch(s){console.error("Excel import error:",s),i("Error reading Excel file","error")}finally{R(!1),P.current&&(P.current.value="")}},De=t=>{U(n=>n.map((a,s)=>s===t?{...a,selected:!a.selected}:a))},Fe=()=>{const t=f.filter(r=>r.selected);if(t.length===0){i("Please select at least one task","error");return}const n=t.reduce((r,l)=>r+(l.scheduledValue||0),0),a=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});let s;if(n>0){let r=0;s=t.map((l,o)=>{const c=l.scheduledValue||0;let d;return o===t.length-1?d=100-r:(d=Math.round(c/n*1e4)/100,r+=d),{name:l.name,weight:d.toFixed(2),group:l.group,scheduledValue:l.scheduledValue||null}}),i(`Tasks imported with value-based weights! Total SOV: ${a.format(n)}`,"success")}else{const r=Math.round(100/t.length*100)/100;s=t.map((l,o)=>({name:l.name,weight:o===t.length-1?(100-r*(t.length-1)).toFixed(2):r.toFixed(2),group:l.group,scheduledValue:l.scheduledValue||null})),i("Tasks imported with equal weights","success")}j(s),A(!1)},Ie=async()=>{if(!x?.id){i("No company selected. Please log in again.","error");return}if(!$.trim()){i("Please enter a project name","error");return}const t=parseFloat(ne);if(!t||t<=0){i("Please enter a valid contract value","error");return}if(k.length!==4){i("Please enter a 4-digit PIN","error");return}if(!await H.isPinAvailable(k)){i("This PIN is already in use. Try another.","error");return}const a=g.filter(s=>s.name.trim()&&parseFloat(s.weight)>0);if(a.length===0){i("Please add at least one area","error");return}if(Math.abs(G-100)>.1){i("Area weights must total 100%","error");return}if(!v||!w){i("Start date and end date are required","error");return}if(new Date(w)<new Date(v)){i("End date must be on or after start date","error");return}ie(!0);try{const s=await H.createProject({name:$.trim(),job_number:Q.trim()||null,address:ee.trim()||null,general_contractor:ae.trim()||null,contract_value:t,pin:k,work_type:T,job_type:L,company_id:x?.id,created_by:y?.id,start_date:v,end_date:w,planned_man_days:B?parseInt(B):null});for(let r=0;r<a.length;r++)await H.createArea({project_id:s.id,name:a[r].name.trim(),weight:parseFloat(a[r].weight),scheduled_value:a[r].scheduledValue||null,group_name:a[r].group||null,status:"not_started",sort_order:r});i("Project created!","success"),Ve(),V()}catch(s){console.error("Error creating project:",s),i("Error creating project","error")}finally{ie(!1)}};if(ye){const t=[...new Set(f.map(r=>r.group))],n=f.filter(r=>r.selected).length,a=f.reduce((r,l)=>r+(l.scheduledValue||0),0),s=f.filter(r=>r.selected).reduce((r,l)=>r+(l.scheduledValue||0),0);return e.jsxs("div",{children:[e.jsx("h1",{children:"Review Imported Tasks"}),e.jsx("p",{className:"subtitle",children:"Select the tasks to include in your project"}),e.jsxs("div",{className:"import-summary",children:[e.jsxs("span",{children:[n," of ",f.length," tasks selected"]}),a>0&&e.jsxs("span",{className:"import-sov-total",children:["Â· Total SOV: ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)]})]}),t.map(r=>{const l=f.filter(c=>c.group===r),o=l.filter(c=>c.selected).length;return e.jsxs("div",{className:"card import-group",children:[e.jsxs("div",{className:"import-group-header",children:[e.jsx("h3",{children:r}),e.jsxs("span",{className:"import-group-count",children:[o,"/",l.length]})]}),e.jsx("div",{className:"import-task-list",children:l.map(c=>{const d=f.indexOf(c);return e.jsxs("label",{className:"import-task-item",children:[e.jsx("input",{type:"checkbox",checked:c.selected,onChange:()=>De(d)}),e.jsx("span",{className:"import-task-name",children:c.name}),c.scheduledValue>0&&e.jsx("span",{className:"import-task-value",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(c.scheduledValue)})]},d)})})]},r)}),e.jsxs("div",{className:"import-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>A(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:Fe,children:["Use Selected Tasks (",n,")"]})]})]})}const D=g.reduce((t,n,a)=>{const s=n.group||"General";return t[s]||(t[s]=[]),t[s].push({...n,originalIndex:a}),t},{}),Ee=Object.keys(D).length>1||Object.keys(D).length===1&&!D.General;return e.jsxs("div",{children:[e.jsx("h1",{children:"New Project"}),e.jsx("p",{className:"subtitle",children:"Set up a new project to track"}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Name"}),e.jsx("input",{type:"text",placeholder:"e.g., Sunrise Apartments",value:$,onChange:t=>K(t.target.value)})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Number"}),e.jsx("input",{type:"text",placeholder:"e.g., 4032",value:Q,onChange:t=>Z(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Contract Value ($)"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"e.g., 365000",value:ne,onChange:t=>{const n=t.target.value.replace(/[^0-9.]/g,"");re(n)},className:"currency-input"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Address"}),e.jsx("input",{type:"text",placeholder:"e.g., 123 Main St, Los Angeles, CA 90001",value:ee,onChange:t=>te(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"General Contractor"}),e.jsx("input",{type:"text",placeholder:"e.g., ABC Construction Inc.",value:ae,onChange:t=>se(t.target.value)})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Start Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:v,onChange:t=>de(t.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["End Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:w,onChange:t=>ue(t.target.value),min:v||void 0,required:!0}),v&&w&&new Date(w)<new Date(v)&&e.jsx("span",{className:"error-text",children:"End date must be after start date"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Planned Man-Days ",e.jsx("span",{className:"optional",children:"(optional)"})]}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.85rem",marginBottom:"0.5rem"},children:"Total estimated man-days to complete the project"}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"e.g., 120",value:B,onChange:t=>me(t.target.value.replace(/\D/g,"")),min:"1"})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Work Type"}),e.jsxs("div",{className:"project-type-toggle",children:[e.jsx("button",{type:"button",className:`toggle-btn ${T==="demolition"?"active":""}`,onClick:()=>_("demolition"),children:"Demolition"}),e.jsx("button",{type:"button",className:`toggle-btn ${T==="abatement"?"active":""}`,onClick:()=>_("abatement"),children:"Abatement"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Type"}),e.jsxs("div",{className:"project-type-toggle",children:[e.jsx("button",{type:"button",className:`toggle-btn ${L==="standard"?"active":""}`,onClick:()=>O("standard"),children:"Standard"}),e.jsx("button",{type:"button",className:`toggle-btn ${L==="pla"?"active":""}`,onClick:()=>O("pla"),children:"PLA"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Foreman PIN (4 digits)"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.85rem",marginBottom:"0.5rem"},children:"Foremen will enter this PIN to access this project"}),e.jsxs("div",{className:"pin-input-row",children:[e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"e.g., 2847",value:k,onChange:t=>we(t.target.value),maxLength:4,className:"pin-input"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:Ce,children:"Generate"})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"areas-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Areas / Tasks"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.9rem",marginTop:"0.25rem"},children:"Define the areas for this project. Weights must total 100%."})]}),e.jsxs("div",{className:"import-btn-container",children:[e.jsx("input",{ref:P,type:"file",accept:".xlsx,.xls,.csv",onChange:Pe,style:{display:"none"}}),e.jsx("button",{className:"btn btn-secondary btn-small",onClick:ke,disabled:ce,children:ce?"Reading...":"ðŸ“Š Import Excel"})]})]}),Ee?Object.entries(D).map(([t,n])=>e.jsxs("div",{className:"area-group",children:[e.jsx("div",{className:"area-group-header",children:t}),n.map(a=>e.jsxs("div",{className:"area-row area-row-with-value",children:[e.jsx("input",{type:"text",placeholder:"Task name",value:a.name,onChange:s=>C(a.originalIndex,"name",s.target.value),className:"area-name-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"$0",value:a.scheduledValue?Y(a.scheduledValue):"",onChange:s=>C(a.originalIndex,"scheduledValue",Ne(s.target.value)),className:"currency-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"%",value:a.weight,onChange:s=>C(a.originalIndex,"weight",s.target.value),className:"weight-input"}),e.jsx("button",{className:"remove-btn",onClick:()=>pe(a.originalIndex),children:"Ã—"})]},a.originalIndex))]},t)):g.map((t,n)=>e.jsxs("div",{className:"area-row area-row-with-value",children:[e.jsx("input",{type:"text",placeholder:"Area name (e.g., Level 1)",value:t.name,onChange:a=>C(n,"name",a.target.value),className:"area-name-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"$0",value:t.scheduledValue?Y(t.scheduledValue):"",onChange:a=>C(n,"scheduledValue",Ne(a.target.value)),className:"currency-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"%",value:t.weight,onChange:a=>C(n,"weight",a.target.value),className:"weight-input"}),e.jsx("button",{className:"remove-btn",onClick:()=>pe(n),children:"Ã—"})]},n)),e.jsxs("div",{className:"weight-total-row",children:[e.jsxs("div",{className:"weight-total",children:[e.jsx("span",{className:"weight-total-label",children:"Total Weight:"}),e.jsxs("span",{className:`weight-total-value ${Math.abs(G-100)<.1?"valid":"invalid"}`,children:[G.toFixed(1),"%"]}),g.some(t=>t.scheduledValue>0)&&e.jsxs("span",{className:"sov-total",children:["Â· SOV: ",Y(g.reduce((t,n)=>t+(parseFloat(n.scheduledValue)||0),0))]})]}),e.jsxs("div",{className:"auto-weight-dropdown",children:[e.jsx("button",{type:"button",className:"btn btn-secondary btn-small",onClick:()=>q(!oe),children:"Auto-Calculate â–¼"}),oe&&e.jsxs("div",{className:"weight-dropdown-menu",children:[e.jsxs("button",{onClick:()=>he("value"),children:["By Value ",e.jsx("span",{className:"dropdown-hint",children:"(Recommended)"})]}),e.jsx("button",{onClick:()=>he("equal"),children:"Equal Distribution"})]})]})]}),e.jsx("button",{className:"btn btn-secondary",onClick:Se,children:"+ Add Area"})]}),e.jsx("button",{className:"btn btn-primary btn-full",onClick:Ie,disabled:le,children:le?"Creating...":"Create Project"})]})}export{He as default};
//# sourceMappingURL=Setup-pcZteZow.js.map
