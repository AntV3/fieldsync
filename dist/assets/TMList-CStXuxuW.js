import{_ as Be}from"./pdf-aQqpMATS.js";import{as as e,at as qe,aA as Jt,aB as Xt,aC as Kt,ay as Ve,au as Zt,av as Qt,aw as mt,ax as ht,az as es,ar as z,aF as ts,aG as ut,aH as ss}from"./index-lTFPjtqd.js";import{r as h,w as gt,e as as,Y as rs,$ as ls,f as ns,n as _t,F as Ue,V as os,aS as xt,i as pt,T as is,H as cs,W as ds,k as ms,aJ as hs,ai as us,ao as gs,aN as xs,N as jt,_ as ps,v as js,C as bt,X as bs}from"./icons-DsFyWu_8.js";import vs from"./SignatureLinkGenerator-C4g0PLPe.js";import{A as _s,b as fs,a as ft,T as Ns,c as ys}from"./Dashboard-DWI0h6sx.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";import"./corCalculations-vdJc_BOT.js";function Cs({tickets:u=[],laborRates:n={}}){const l=h.useMemo(()=>{if(!u.length)return{total:0,pending:0,approved:0,billed:0,rejected:0,totalHours:0,regularHours:0,overtimeHours:0,materialsCost:0,uniqueWorkers:0,avgHoursPerTicket:0,approvalRate:0,pendingValue:0,approvedValue:0,billedValue:0,workersByRole:{},topWorkers:[],byMonth:[],byStatus:[]};const p=u.filter(m=>m.status==="pending").length,_=u.filter(m=>m.status==="approved").length,x=u.filter(m=>m.status==="billed").length,S=u.filter(m=>m.status==="rejected").length;let I=0,le=0,W=0;const q={},f={Foreman:0,Superintendent:0,Operator:0,Laborer:0};u.forEach(m=>{m.t_and_m_workers&&m.t_and_m_workers.forEach(b=>{const y=parseFloat(b.hours)||0,M=parseFloat(b.overtime_hours)||0;le+=y,W+=M,I+=y+M;const E=b.name||"Unknown";q[E]||(q[E]={name:E,hours:0,role:b.role||"Laborer"}),q[E].hours+=y+M;const T=b.role||"Laborer";f[T]!==void 0?f[T]+=y+M:f[T]=y+M})});let ne=0;u.forEach(m=>{m.t_and_m_items&&m.t_and_m_items.forEach(b=>{const y=b.materials_equipment?.cost_per_unit||0;ne+=b.quantity*y})});const de=Object.keys(q).length,X=Object.values(q).sort((m,b)=>b.hours-m.hours).slice(0,5),O=_+x+S,K=O>0?Math.round((_+x)/O*100):0,G={...{Foreman:85,Superintendent:95,Operator:75,Laborer:55},...n},V=m=>{let b=0,y=0;return m.t_and_m_workers&&m.t_and_m_workers.forEach(M=>{const E=M.role||"Laborer",T=G[E]||G.Laborer,ee=parseFloat(M.hours)||0,Se=parseFloat(M.overtime_hours)||0;b+=ee*T+Se*T*1.5}),m.t_and_m_items&&m.t_and_m_items.forEach(M=>{const E=M.materials_equipment?.cost_per_unit||0;y+=M.quantity*E}),b+y},Z=u.filter(m=>m.status==="pending").reduce((m,b)=>m+V(b),0),ie=u.filter(m=>m.status==="approved").reduce((m,b)=>m+V(b),0),c=u.filter(m=>m.status==="billed").reduce((m,b)=>m+V(b),0),P={};u.forEach(m=>{const b=new Date(m.work_date),y=`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}`,M=b.toLocaleDateString("en-US",{month:"short",year:"2-digit"});P[y]||(P[y]={month:M,monthKey:y,tickets:0,hours:0,cost:0,value:0}),P[y].tickets+=1,P[y].cost+=V(m)-ne,m.t_and_m_workers&&m.t_and_m_workers.forEach(E=>{const T=parseFloat(E.hours)||0,ee=parseFloat(E.overtime_hours)||0;P[y].hours+=T+ee}),m.t_and_m_items&&m.t_and_m_items.forEach(E=>{const T=E.materials_equipment?.cost_per_unit||0;P[y].value+=E.quantity*T})});const Q=Object.values(P).sort((m,b)=>m.monthKey.localeCompare(b.monthKey)).slice(-6),H=[{name:"Pending",value:p,color:"#f59e0b"},{name:"Approved",value:_,color:"#10b981"},{name:"Billed",value:x,color:"#3b82f6"},{name:"Rejected",value:S,color:"#ef4444"}].filter(m=>m.value>0);return{total:u.length,pending:p,approved:_,billed:x,rejected:S,totalHours:I,regularHours:le,overtimeHours:W,materialsCost:ne,uniqueWorkers:de,avgHoursPerTicket:u.length>0?I/u.length:0,approvalRate:K,pendingValue:Z,approvedValue:ie,billedValue:c,workersByRole:f,topWorkers:X,byMonth:Q,byStatus:H}},[u,n]),N=p=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(p),D=({active:p,payload:_,label:x})=>p&&_&&_.length?e.jsxs("div",{className:"tm-chart-tooltip",children:[e.jsx("p",{className:"tm-tooltip-label",children:x}),_.map((S,I)=>e.jsxs("p",{style:{color:S.color},children:[S.name,": ",S.name.includes("Cost")||S.name.includes("Value")?N(S.value):S.value.toFixed(1)]},I))]}):null;return u.length===0?e.jsxs("div",{className:"tm-dashboard tm-dashboard-empty",children:[e.jsx("div",{className:"tm-empty-icon",children:e.jsx(gt,{size:48})}),e.jsx("p",{children:"No T&M tickets yet"}),e.jsx("p",{className:"tm-empty-hint",children:"Create tickets to see analytics and trends"})]}):e.jsxs("div",{className:"tm-dashboard",children:[e.jsxs("div",{className:"tm-summary-cards",children:[e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon tickets",children:e.jsx(gt,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l.total}),e.jsx("span",{className:"tm-card-label",children:"Total Tickets"})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon hours",children:e.jsx(as,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l.totalHours.toFixed(1)}),e.jsx("span",{className:"tm-card-label",children:"Total Hours"}),l.overtimeHours>0&&e.jsxs("span",{className:"tm-card-detail",children:[l.overtimeHours.toFixed(1)," OT"]})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon workers",children:e.jsx(rs,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l.uniqueWorkers}),e.jsx("span",{className:"tm-card-label",children:"Workers"})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon materials",children:e.jsx(ls,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:N(l.materialsCost)}),e.jsx("span",{className:"tm-card-label",children:"Materials"})]})]})]}),e.jsxs("div",{className:"tm-status-cards",children:[e.jsxs("div",{className:"tm-status-card pending",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(ns,{size:16}),e.jsx("span",{children:"Pending"})]}),e.jsx("div",{className:"tm-status-count",children:l.pending}),e.jsx("div",{className:"tm-status-value",children:N(l.pendingValue)})]}),e.jsxs("div",{className:"tm-status-card approved",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(_t,{size:16}),e.jsx("span",{children:"Approved"})]}),e.jsx("div",{className:"tm-status-count",children:l.approved}),e.jsx("div",{className:"tm-status-value",children:N(l.approvedValue)})]}),e.jsxs("div",{className:"tm-status-card billed",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(Ue,{size:16}),e.jsx("span",{children:"Billed"})]}),e.jsx("div",{className:"tm-status-count",children:l.billed}),e.jsx("div",{className:"tm-status-value",children:N(l.billedValue)})]}),e.jsxs("div",{className:"tm-status-card rate",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(os,{size:16}),e.jsx("span",{children:"Approval Rate"})]}),e.jsxs("div",{className:"tm-status-count",children:[l.approvalRate,"%"]}),e.jsxs("div",{className:"tm-status-value",children:[l.approved+l.billed," / ",l.total-l.pending]})]})]}),e.jsxs("div",{className:"tm-charts-row",children:[l.byStatus.length>0&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Status Distribution"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(qe,{width:"100%",height:200,children:e.jsxs(Jt,{children:[e.jsx(Xt,{data:l.byStatus,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:2,dataKey:"value",label:({name:p,percent:_})=>`${p} ${(_*100).toFixed(0)}%`,labelLine:!1,children:l.byStatus.map((p,_)=>e.jsx(Kt,{fill:p.color},`cell-${_}`))}),e.jsx(Ve,{})]})})}),e.jsx("div",{className:"tm-chart-legend",children:l.byStatus.map((p,_)=>e.jsxs("div",{className:"tm-legend-item",children:[e.jsx("span",{className:"tm-legend-color",style:{background:p.color}}),e.jsx("span",{className:"tm-legend-label",children:p.name}),e.jsx("span",{className:"tm-legend-value",children:p.value})]},_))})]}),l.byMonth.length>0&&e.jsxs("div",{className:"tm-chart-card wide",children:[e.jsx("h4",{className:"tm-chart-title",children:"Hours by Month"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(qe,{width:"100%",height:200,children:e.jsxs(Zt,{data:l.byMonth,children:[e.jsx(Qt,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(mt,{dataKey:"month",tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:{stroke:"var(--border-color)"}}),e.jsx(ht,{tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:{stroke:"var(--border-color)"}}),e.jsx(Ve,{content:e.jsx(D,{})}),e.jsx(es,{dataKey:"hours",name:"Hours",fill:"var(--primary-color)",radius:[4,4,0,0]})]})})})]})]}),e.jsxs("div",{className:"tm-charts-row",children:[e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Hours by Role"}),e.jsx("div",{className:"tm-role-breakdown",children:Object.entries(l.workersByRole).filter(([,p])=>p>0).sort((p,_)=>_[1]-p[1]).map(([p,_])=>{const x=_/l.totalHours*100;return e.jsxs("div",{className:"tm-role-bar",children:[e.jsxs("div",{className:"tm-role-info",children:[e.jsx("span",{className:"tm-role-name",children:p}),e.jsxs("span",{className:"tm-role-hours",children:[_.toFixed(1)," hrs"]})]}),e.jsx("div",{className:"tm-role-track",children:e.jsx("div",{className:"tm-role-fill",style:{width:`${x}%`}})})]},p)})})]}),l.topWorkers.length>0&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Top Workers"}),e.jsx("div",{className:"tm-top-workers",children:l.topWorkers.map((p,_)=>e.jsxs("div",{className:"tm-worker-row",children:[e.jsxs("span",{className:"tm-worker-rank",children:["#",_+1]}),e.jsxs("div",{className:"tm-worker-info",children:[e.jsx("span",{className:"tm-worker-name",children:p.name}),e.jsx("span",{className:"tm-worker-role",children:p.role})]}),e.jsxs("span",{className:"tm-worker-hours",children:[p.hours.toFixed(1)," hrs"]})]},p.name))})]}),l.byMonth.length>1&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Ticket Volume"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(qe,{width:"100%",height:150,children:e.jsxs(_s,{data:l.byMonth,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"ticketGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"var(--primary-color)",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"var(--primary-color)",stopOpacity:0})]})}),e.jsx(mt,{dataKey:"month",tick:{fill:"var(--text-secondary)",fontSize:10},axisLine:!1,tickLine:!1}),e.jsx(ht,{hide:!0}),e.jsx(Ve,{content:e.jsx(D,{})}),e.jsx(fs,{type:"monotone",dataKey:"tickets",name:"Tickets",stroke:"var(--primary-color)",fill:"url(#ticketGradient)",strokeWidth:2})]})})})]})]}),e.jsxs("div",{className:"tm-quick-stats",children:[e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Avg Hours/Ticket"}),e.jsx("span",{className:"tm-quick-value",children:l.avgHoursPerTicket.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Regular Hours"}),e.jsx("span",{className:"tm-quick-value",children:l.regularHours.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Overtime Hours"}),e.jsx("span",{className:"tm-quick-value",children:l.overtimeHours.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Total Est. Value"}),e.jsx("span",{className:"tm-quick-value",children:N(l.pendingValue+l.approvedValue+l.billedValue)})]})]})]})}const Ss=h.memo(function({ticket:n,isExpanded:l,isSelected:N,isLocked:D,lockInfo:p,hasFailedImport:_,isRetrying:x,onToggleExpand:S,onToggleSelect:I,onApprove:le,onUpdateStatus:W,onDelete:q,onOpenCorAssign:f,onRetryImport:ne,onShowSignatureLink:de,formatDate:X,calculateTotalHours:O,calculateTicketTotal:K}){const me=O(n),G=K(n),[V,Z]=h.useState([]);h.useEffect(()=>{if(!n.photos?.length){Z([]);return}let c=!1;return z.resolvePhotoUrls(n.photos).then(P=>{c||Z(P)}),()=>{c=!0}},[n.photos]);const ie=c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),S(n.id))};return e.jsxs("div",{className:`tm-ticket-card hover-lift animate-fade-in-up ${n.status} ${N?"selected":""} ${D?"locked":""}`,role:"article","aria-label":`T&M Ticket for ${X(n.work_date)}, ${me} hours, $${G.toFixed(2)}, status: ${n.status}`,children:[e.jsxs("div",{className:"tm-ticket-header",onClick:()=>S(n.id),onKeyDown:ie,role:"button",tabIndex:0,"aria-expanded":l,"aria-label":`${l?"Collapse":"Expand"} ticket details`,children:[e.jsx("input",{type:"checkbox",checked:N,onChange:c=>I(n.id,c),onClick:c=>c.stopPropagation(),className:"tm-checkbox","aria-label":`Select ticket for ${X(n.work_date)}`}),e.jsxs("div",{className:"tm-ticket-info",children:[e.jsx("span",{className:"tm-ticket-date",children:X(n.work_date)}),n.ce_pco_number&&e.jsx("span",{className:"tm-ce-badge",children:n.ce_pco_number}),n.assigned_cor_id&&p?.lockedBy&&e.jsxs("span",{className:`tm-cor-badge ${D?"locked":""}`,title:p?.reason,children:[D&&e.jsx(xt,{size:10}),p.lockedBy.cor_number]}),n.photos?.length>0&&e.jsx(ft,{count:n.photos.length,icon:pt,size:"small",variant:"default"}),_&&e.jsxs("span",{className:"tm-import-failed-badge",title:"COR data import failed - retry needed",children:[e.jsx(is,{size:12})," Import Failed"]}),n.client_signature_data&&e.jsxs("span",{className:"tm-verified-badge",title:`Verified by ${n.client_signature_name||"client"}${n.client_signature_date?` on ${X(n.client_signature_date)}`:""}`,children:[e.jsx(_t,{size:12})," Verified"]}),e.jsx("span",{className:`tm-ticket-status ${n.status}`,children:n.status})]}),e.jsxs("div",{className:"tm-ticket-summary",children:[e.jsxs("span",{className:"tm-ticket-hours",children:[me," hrs"]}),e.jsxs("span",{className:"tm-ticket-total",children:["$",G.toFixed(2)]}),e.jsx("span",{className:"tm-expand-arrow","aria-hidden":"true",children:l?"▼":"▶"})]})]}),l&&e.jsxs("div",{className:"tm-ticket-details",children:[n.t_and_m_workers?.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(cs,{size:16,className:"inline-icon"})," Workers"]}),e.jsx("div",{className:"tm-detail-list",children:n.t_and_m_workers.map(c=>e.jsxs("div",{className:"tm-detail-row",children:[e.jsxs("span",{children:[c.role&&c.role!=="Laborer"&&e.jsx("span",{className:"tm-role-badge",children:c.role}),c.name]}),e.jsxs("span",{children:[c.hours," hrs",parseFloat(c.overtime_hours)>0&&e.jsxs("span",{className:"tm-ot-badge",children:[" +",c.overtime_hours," OT"]})]})]},c.id))})]}),n.t_and_m_items?.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(ds,{size:16,className:"inline-icon"})," Materials & Equipment"]}),e.jsx("div",{className:"tm-detail-list",children:n.t_and_m_items.map(c=>e.jsxs("div",{className:"tm-detail-row",children:[e.jsx("span",{children:c.custom_name?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tm-custom-badge",children:"Custom"})," ",c.custom_name]}):c.materials_equipment?.name}),e.jsxs("span",{className:"tm-detail-qty",children:[c.quantity," ",c.materials_equipment?.unit||"each",c.materials_equipment?.cost_per_unit>0&&e.jsxs("span",{className:"tm-item-cost",children:["$",(c.quantity*c.materials_equipment.cost_per_unit).toFixed(2)]})]})]},c.id))})]}),n.notes&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(Ue,{size:16,className:"inline-icon"})," Description"]}),e.jsx("p",{className:"tm-notes-text",children:n.notes})]}),n.photos&&n.photos.length>0&&V.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(pt,{size:16,className:"inline-icon"})," Photos (",n.photos.length,")"]}),e.jsx("div",{className:"tm-photos-grid",children:V.filter(Boolean).map((c,P)=>e.jsx("a",{href:c,target:"_blank",rel:"noopener noreferrer",className:"tm-photo-thumb",children:e.jsx("img",{src:c,alt:`Photo ${P+1}`,onError:Q=>{Q.target.onerror=null,Q.target.classList.add("photo-error"),Q.target.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=="}})},P))})]}),n.ce_pco_number&&n.change_order_value>0&&e.jsxs("div",{className:"tm-change-order-value",children:[e.jsx("span",{className:"tm-co-label",children:"Change Order Value:"}),e.jsxs("span",{className:"tm-co-amount",children:["$",n.change_order_value.toLocaleString()]})]}),D&&e.jsxs("div",{className:"tm-lock-notice",children:[e.jsx(xt,{size:14}),e.jsx("span",{children:p?.reason||"This ticket is locked (COR approved)"})]}),e.jsxs("div",{className:"tm-ticket-actions",role:"group","aria-label":"Ticket actions",children:[n.status==="pending"&&!D&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-success btn-small",onClick:c=>{c.stopPropagation(),le(n)},"aria-label":"Approve this ticket",children:"Approve"}),e.jsx("button",{className:"btn btn-warning btn-small",onClick:c=>{c.stopPropagation(),W(n.id,"rejected")},"aria-label":"Reject this ticket",children:"Reject"})]}),n.status==="approved"&&!D&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-primary btn-small",onClick:c=>{c.stopPropagation(),W(n.id,"billed")},"aria-label":"Mark ticket as billed",children:"Mark Billed"}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:c=>{c.stopPropagation(),de(n)},"aria-label":"Get signature link for this ticket",children:[e.jsx(ms,{size:14,"aria-hidden":"true"})," Signature Link"]})]}),n.status==="rejected"&&!D&&e.jsx("button",{className:"btn btn-secondary btn-small",onClick:c=>{c.stopPropagation(),W(n.id,"pending")},"aria-label":"Restore rejected ticket to pending",children:"Restore"}),!D&&e.jsxs("button",{className:`btn btn-small ${n.assigned_cor_id?"btn-ghost":"btn-secondary"}`,onClick:c=>{c.stopPropagation(),f(n)},"aria-label":n.assigned_cor_id?"Change COR link":"Link to Change Order",children:[e.jsx(hs,{size:14,"aria-hidden":"true"})," ",n.assigned_cor_id?"COR":"Link COR"]}),_&&!D&&e.jsxs("button",{className:"btn btn-warning btn-small",onClick:c=>ne(n,c),disabled:x,"aria-label":"Retry syncing data to COR","aria-busy":x,children:[e.jsx(us,{size:14,className:x?"spin":"","aria-hidden":"true"})," ",x?"Syncing...":"Retry Sync"]}),!D&&e.jsx("button",{className:"btn btn-danger btn-small",onClick:c=>{c.stopPropagation(),q(n.id)},"aria-label":"Delete this ticket",children:"Delete"})]})]})]})}),vt=()=>Be(()=>import("./xlsx-BvJTHLik.js"),[]),ks=()=>Promise.all([Be(()=>import("./pdf-aQqpMATS.js").then(u=>u.j),[]),Be(()=>import("./pdf-aQqpMATS.js").then(u=>u.c),[])]);function $s({project:u,company:n,onShowToast:l,compact:N=!1,previewMode:D=!1,onViewAll:p}){const{branding:_}=ts(),[x,S]=h.useState([]),[I,le]=h.useState(!0),[W,q]=h.useState(!1),[f,ne]=h.useState("all"),[de,X]=h.useState(null),[O,K]=h.useState(new Set),[me,G]=h.useState(0),[V,Z]=h.useState(!0),[ie,c]=h.useState(0),P=25,Q=500,[H,m]=h.useState("recent"),[b,y]=h.useState(()=>{const t=localStorage.getItem("fieldsync-tm-default-view");return t==="list"||t==="dashboard"?t:"dashboard"}),[M,E]=h.useState(new Set),[T,ee]=h.useState({start:"",end:""}),[Se,ke]=h.useState(!1),[he,Nt]=h.useState(null),[Te,Ye]=h.useState(""),[yt,Ge]=h.useState(!1),[ue,Je]=h.useState(null),[Ct,ge]=h.useState(!1),[B,Xe]=h.useState(null),[fe,St]=h.useState([]),[xe,Fe]=h.useState(""),[Ke,Ze]=h.useState(!1),[A,kt]=h.useState({}),[Tt,Qe]=h.useState({}),[Ft,et]=h.useState(null),oe=h.useCallback(async(t=0,a=!1)=>{try{a?le(!0):q(!0);const i=await z.getTMTicketsPaginated(u.id,{page:t,limit:P,status:f!=="all"?f:null});S(a?i.tickets:F=>{const s=[...F,...i.tickets];return s.length>Q?s.slice(-Q):s}),G(t),Z(i.hasMore),c(i.totalCount);const j=i.tickets.filter(F=>F.assigned_cor_id);if(j.length>0){const F={},s={};await Promise.all(j.map(async v=>{const U=await z.isTicketEditable(v);U.editable||(F[v.id]=U);try{const r=await z.getTicketImportStatus(v.id,v.assigned_cor_id);r?.import_status==="failed"&&(s[v.id]=r)}catch{}})),kt(v=>a?F:{...v,...F}),Qe(v=>a?s:{...v,...s})}}catch{l("Error loading T&M tickets","error")}finally{le(!1),q(!1)}},[u.id,f,l]);h.useEffect(()=>{S([]),G(0),Z(!0),oe(0,!0);const t=z.subscribeToTMTickets?.(u.id,()=>{oe(0,!0)});return()=>{t&&z.unsubscribe?.(t)}},[u.id,oe]),h.useEffect(()=>{N||localStorage.setItem("fieldsync-tm-default-view",b)},[b,N]),h.useEffect(()=>{if(!N){const t=localStorage.getItem("fieldsync-tm-default-view");y(t==="list"||t==="dashboard"?t:"dashboard")}},[N]);const wt=()=>{!W&&V&&oe(me+1,!1)};h.useEffect(()=>{u?.id&&(S([]),G(0),Z(!0),oe(0,!0))},[f]);const we=h.useCallback(async(t,a)=>{if(A[t]){l(A[t].reason||"This ticket is locked (COR approved)","error");return}try{await z.updateTMTicketStatus(t,a),S(i=>i.map(j=>j.id===t?{...j,status:a}:j)),l(`Ticket ${a}`,"success")}catch(i){console.error("Error updating status:",i),l("Error updating status","error")}},[A]),Dt=h.useCallback(t=>{if(A[t.id]){l(A[t.id].reason||"This ticket is locked (COR approved)","error");return}we(t.id,"approved")},[A,we]),Mt=async()=>{if(he)try{const t=parseFloat(Te)||0;await z.approveTMTicket(he.id,null,null,t),S(x.map(a=>a.id===he.id?{...a,status:"approved",change_order_value:t}:a)),l(`Ticket approved with $${t.toLocaleString()} change order`,"success"),ke(!1),Nt(null),Ye("")}catch(t){console.error("Error approving ticket:",t),l("Error approving ticket","error")}},Rt=h.useCallback(async t=>{if(A[t]){l(A[t].reason||"This ticket is locked (COR approved)","error");return}if(confirm("Delete this T&M ticket?"))try{await z.deleteTMTicket(t),S(a=>a.filter(i=>i.id!==t)),l("Ticket deleted","success")}catch(a){console.error("Error deleting ticket:",a),l("Error deleting ticket","error")}},[A]),Et=h.useCallback(async t=>{Xe(t),Fe(t.assigned_cor_id||""),ge(!0),Ze(!0);try{const a=await z.getAssignableCORs(u.id);St(a||[])}catch(a){console.error("Error loading CORs:",a),l("Error loading change orders","error")}finally{Ze(!1)}},[u.id]),Ot=async()=>{if(B)try{if(xe){await z.assignTicketToCOR(B.id,xe);const t=fe.find(a=>a.id===xe);l(`Ticket linked to ${t?.cor_number||"COR"}`,"success")}else B.assigned_cor_id&&(await z.unassignTicketFromCOR(B.id,B.assigned_cor_id),l("Ticket unlinked from COR","success"));oe(),ge(!1),Xe(null),Fe("")}catch(t){console.error("Error updating COR association:",t),l("Error updating COR link","error")}},Pt=h.useCallback(async(t,a)=>{if(a?.stopPropagation(),!!t.assigned_cor_id){et(t.id);try{await z.importTicketDataToCOR(t.id,t.assigned_cor_id,n.id,u.work_type||"demolition",u.job_type||"standard"),l("COR data import successful!","success"),Qe(i=>{const j={...i};return delete j[t.id],j}),oe()}catch(i){console.error("Error retrying import:",i),l("Import retry failed. Please try again.","error")}finally{et(null)}}},[n.id,u.work_type,u.job_type]),pe=t=>{let a=0;return t.t_and_m_items&&t.t_and_m_items.forEach(i=>{i.materials_equipment?.cost_per_unit&&(a+=i.quantity*i.materials_equipment.cost_per_unit)}),a},je=t=>t.t_and_m_workers?t.t_and_m_workers.reduce((a,i)=>{const j=parseFloat(i.hours)||0,F=parseFloat(i.overtime_hours)||0;return a+j+F},0):0,Ne=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),$t=h.useCallback((t,a)=>{a?.stopPropagation(),K(i=>{const j=new Set(i);return j.has(t)?j.delete(t):j.add(t),j})},[]),zt=h.useCallback(t=>{X(a=>a===t?null:t)},[]),Ht=h.useCallback(t=>{Je(t),Ge(!0)},[]),tt=()=>{const t=f==="all"?x:x.filter(i=>i.status===f),a=t.every(i=>O.has(i.id));K(a?new Set:new Set(t.map(i=>i.id)))},st=()=>{K(new Set)},at=()=>{const t=f==="all"?x:x.filter(a=>a.status===f);return O.size>0?t.filter(a=>O.has(a.id)):t},At=async()=>{const t=at();if(t.length===0){l("No tickets to export","error");return}l("Preparing Excel export...","info");const a=(await vt()).default||await vt(),i=[],j=[],F=[];t.forEach(r=>{const o=Ne(r.work_date),C=r.status;r.t_and_m_workers&&r.t_and_m_workers.forEach(R=>{const te=parseFloat(R.hours)||0,se=parseFloat(R.overtime_hours)||0;i.push({Date:o,Status:C,"Worker Name":R.name,Role:R.role||"Laborer","Regular Hours":te,"OT Hours":se,"Total Hours":te+se})}),r.t_and_m_items&&r.t_and_m_items.forEach(R=>{const te=R.custom_name||R.materials_equipment?.name||"Unknown",se=R.custom_category||R.materials_equipment?.category||"Unknown",Me=R.materials_equipment?.unit||"each",ye=R.materials_equipment?.cost_per_unit||0,Re=R.quantity*ye;j.push({Date:o,Status:C,Category:se,Item:te,Quantity:R.quantity,Unit:Me,"Cost/Unit":ye,Total:Re})}),F.push({Date:o,Status:C,Workers:r.t_and_m_workers?.length||0,"Total Hours":je(r),Items:r.t_and_m_items?.length||0,"Materials Cost":pe(r),Notes:r.notes||""})});const s=a.utils.book_new(),v=a.utils.json_to_sheet(F);if(a.utils.book_append_sheet(s,v,"Summary"),i.length>0){const r=a.utils.json_to_sheet(i);a.utils.book_append_sheet(s,r,"Workers")}if(j.length>0){const r=a.utils.json_to_sheet(j);a.utils.book_append_sheet(s,r,"Materials & Equipment")}const U=`${u.name}_TM_${new Date().toISOString().split("T")[0]}.xlsx`;a.writeFile(s,U),l("Export downloaded!","success")},Lt=async()=>{const t=at();if(t.length===0){l("No tickets to export","error");return}l("Generating PDF...","info");const[a,i]=await ks(),j=a.default,F=i.default,s=new j,v=s.internal.pageSize.getWidth(),U=s.internal.pageSize.getHeight(),r=20;let o=r;const C=ut(_?.primary_color||"#3B82F6"),R=ut(_?.secondary_color||"#1E40AF");s.setFillColor(...C),s.rect(0,0,v,45,"F"),s.setFillColor(...R),s.rect(0,42,v,3,"F");let te=r;if(_?.logo_url)try{const d=await ss(_.logo_url);d&&(s.addImage(d,"PNG",r,7,30,30),te=r+30+10)}catch(d){console.error("Error adding logo:",d)}s.setTextColor(255,255,255),s.setFontSize(22),s.setFont("helvetica","bold"),s.text(n?.name||"Company Name",te,20),s.setFontSize(10),s.setFont("helvetica","normal"),s.text("TIME & MATERIALS REPORT",te,30),s.setFontSize(9),s.text(`Report Date: ${new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}`,v-r,18,{align:"right"}),u.job_number&&s.text(`Job #: ${u.job_number}`,v-r,26,{align:"right"}),s.text(`Status: ${f.charAt(0).toUpperCase()+f.slice(1)}`,v-r,34,{align:"right"}),o=55,s.setFillColor(248,250,252),s.rect(r,o-5,v-r*2,30,"F"),s.setDrawColor(...C),s.setLineWidth(.5),s.rect(r,o-5,v-r*2,30,"S"),s.setTextColor(...C),s.setFontSize(14),s.setFont("helvetica","bold"),s.text(`Project: ${u.name}`,r+5,o+7),s.setFontSize(10),s.setFont("helvetica","normal"),s.setTextColor(51,65,85);const se=t.map(d=>new Date(d.work_date)).sort((d,g)=>d-g),Me=se[0]?.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),ye=se[se.length-1]?.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.text(`Date Range: ${Me} - ${ye}`,r+5,o+17),s.text(`Total Tickets: ${t.length}`,v-r-5,o+7,{align:"right"}),o+=40;const Re=t.reduce((d,g)=>d+je(g),0),nt=t.reduce((d,g)=>d+pe(g),0),Bt=new Set(t.flatMap(d=>d.t_and_m_workers?.map(g=>g.name)||[])).size;s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("SUMMARY",r,o),o+=8;const be=(v-r*2-20)/3,Ut=[{label:"Total Labor Hours",value:Re.toFixed(1)},{label:"Unique Workers",value:Bt.toString()},{label:"Materials Cost",value:`$${nt.toFixed(2)}`}],Yt=C.map(d=>Math.min(255,d+180));Ut.forEach((d,g)=>{const k=r+g*(be+10);s.setFillColor(...Yt),s.rect(k,o,be,25,"F"),s.setDrawColor(...C),s.setLineWidth(.5),s.rect(k,o,be,25,"S"),s.setTextColor(...C),s.setFontSize(16),s.setFont("helvetica","bold"),s.text(d.value,k+be/2,o+12,{align:"center"}),s.setTextColor(100,116,139),s.setFontSize(8),s.setFont("helvetica","normal"),s.text(d.label,k+be/2,o+20,{align:"center"})}),o+=35;const Ee=[],Oe=[],Pe=[];let $e=0,ze=0,He=0,Ae=0,Le=0,Ie=0;t.forEach(d=>{d.t_and_m_workers&&d.t_and_m_workers.forEach(g=>{const k=parseFloat(g.hours)||0,w=parseFloat(g.overtime_hours)||0,re=g.role||"Laborer",J=[Ne(d.work_date),g.name,k.toString(),w>0?w.toString():"-",(k+w).toString()];re==="Foreman"||re==="Superintendent"?(Ee.push(J),$e+=k,ze+=w):re==="Operator"?(Oe.push(J),He+=k,Ae+=w):(Pe.push(J),Le+=k,Ie+=w)})});const We=(d,g,k,w)=>{g.length!==0&&(o>U-80&&(s.addPage(),o=r),s.setTextColor(...C),s.setFontSize(11),s.setFont("helvetica","bold"),s.text(d,r,o),o+=5,F(s,{startY:o,head:[["Date","Name","Reg Hrs","OT Hrs","Total"]],body:g,margin:{left:r,right:r},headStyles:{fillColor:C,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:9,textColor:[51,65,85]},alternateRowStyles:{fillColor:[248,250,252]},columnStyles:{0:{cellWidth:30},2:{halign:"center",cellWidth:22},3:{halign:"center",cellWidth:22},4:{halign:"center",cellWidth:22}},foot:[["","SUBTOTAL:",k.toString(),w>0?w.toString():"-",(k+w).toString()]],footStyles:{fillColor:R,textColor:[255,255,255],fontStyle:"bold",fontSize:9}}),o=s.lastAutoTable.finalY+10)};if(Ee.length>0||Oe.length>0||Pe.length>0){s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("LABOR",r,o),o+=8,We("SUPERVISION",Ee,$e,ze),We("OPERATORS",Oe,He,Ae),We("LABORERS",Pe,Le,Ie);const d=$e+He+Le,g=ze+Ae+Ie;s.setFillColor(...C),s.rect(r,o,v-r*2,12,"F"),s.setTextColor(255,255,255),s.setFontSize(10),s.setFont("helvetica","bold"),s.text("LABOR TOTAL:",r+5,o+8),s.text(`${d} Reg + ${g} OT = ${d+g} Hours`,v-r-5,o+8,{align:"right"}),o+=20}o>U-100&&(s.addPage(),o=r);const ae={},Ce={},ot=["Containment","PPE","Disposal","Equipment","Other"];t.forEach(d=>{d.t_and_m_items&&d.t_and_m_items.forEach(g=>{const k=g.custom_name||g.materials_equipment?.name||"Unknown",w=g.custom_category||g.materials_equipment?.category||"Other",re=g.materials_equipment?.unit||"each",J=g.materials_equipment?.cost_per_unit||0,ve=g.quantity*J;ae[w]||(ae[w]=[],Ce[w]=0),ae[w].push([Ne(d.work_date),k,g.quantity.toString(),re,`$${J.toFixed(2)}`,`$${ve.toFixed(2)}`]),Ce[w]+=ve})});const it=(d,g,k)=>{!g||g.length===0||(o>U-80&&(s.addPage(),o=r),s.setTextColor(...C),s.setFontSize(11),s.setFont("helvetica","bold"),s.text(d.toUpperCase(),r,o),o+=5,F(s,{startY:o,head:[["Date","Item","Qty","Unit","Rate","Total"]],body:g,margin:{left:r,right:r},headStyles:{fillColor:C,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:9,textColor:[51,65,85]},alternateRowStyles:{fillColor:[248,250,252]},columnStyles:{2:{halign:"center",cellWidth:20},3:{halign:"center",cellWidth:25},4:{halign:"right",cellWidth:25},5:{halign:"right",cellWidth:30}},foot:[["","","","","Subtotal:",`$${k.toFixed(2)}`]],footStyles:{fillColor:R,textColor:[255,255,255],fontStyle:"bold",fontSize:9}}),o=s.lastAutoTable.finalY+10)};Object.keys(ae).length>0&&(s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("MATERIALS & EQUIPMENT",r,o),o+=8,ot.forEach(d=>{ae[d]&&it(d,ae[d],Ce[d])}),Object.keys(ae).forEach(d=>{ot.includes(d)||it(d,ae[d],Ce[d])}),s.setFillColor(...C),s.rect(r,o,v-r*2,12,"F"),s.setTextColor(255,255,255),s.setFontSize(10),s.setFont("helvetica","bold"),s.text("MATERIALS TOTAL:",r+5,o+8),s.text(`$${nt.toFixed(2)}`,v-r-5,o+8,{align:"right"}),o+=20),o>U-80&&(s.addPage(),o=r),o+=10,s.setDrawColor(...C),s.setLineWidth(1),s.line(r,o,v-r,o),o+=15,s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("AUTHORIZATION",r,o),o+=10,s.setFontSize(10),s.setFont("helvetica","normal"),s.setTextColor(71,85,105),s.text("I hereby authorize the above time and materials charges as accurate and approved for billing.",r,o),o+=20;const Y=t[0]||{},ct=(d,g,k,w,re,J,ve)=>{s.setFont("helvetica","bold"),s.setFontSize(8),s.setTextColor(...C),s.text(g,r,d),s.setFont("helvetica","normal"),s.setFontSize(9),s.setTextColor(100,116,139);const $=d+18;if(s.setDrawColor(...R),s.setLineWidth(.5),s.line(r,$,r+70,$),s.text("Signature",r,$+8),s.line(r+85,$,r+145,$),s.text("Title / Company",r+85,$+8),s.line(v-r-40,$,v-r,$),s.text("Date",v-r-40,$+8),k)try{if(s.addImage(k,"PNG",r,$-16,60,16),w&&(s.setFontSize(8),s.text(w,r,$+15)),re||J){const _e=[re,J].filter(Boolean).join(" - ");s.text(_e,r+85,$-5)}if(ve){const _e=new Date(ve).toLocaleDateString();s.text(_e,v-r-40,$-5)}}catch(_e){console.error("Error adding signature to PDF:",_e)}return $+25};o=ct(o,"GC AUTHORIZATION",Y.gc_signature_data,Y.gc_signature_name,Y.gc_signature_title,Y.gc_signature_company,Y.gc_signature_date),o+=8,o=ct(o,"CLIENT AUTHORIZATION",Y.client_signature_data,Y.client_signature_name,Y.client_signature_title,Y.client_signature_company,Y.client_signature_date);const dt=s.internal.getNumberOfPages();for(let d=1;d<=dt;d++){s.setPage(d);const g=U-15;s.setFontSize(8),s.setTextColor(148,163,184),s.text(`${n?.name||"Company"} - T&M Report - ${u.name}`,r,g),s.text(`Page ${d} of ${dt}`,v-r,g,{align:"right"})}const Gt=`${u.name}_TM_Report_${new Date().toISOString().split("T")[0]}.pdf`;s.save(Gt),l("PDF exported!","success")},L=h.useMemo(()=>{let t=f==="all"?[...x]:x.filter(a=>a.status===f);if(T.start){const a=new Date(T.start);a.setHours(0,0,0,0),t=t.filter(i=>new Date(i.work_date)>=a)}if(T.end){const a=new Date(T.end);a.setHours(23,59,59,999),t=t.filter(i=>new Date(i.work_date)<=a)}if(D){const a=new Date,i=a.getMonth(),j=a.getFullYear();t=t.filter(F=>{const s=new Date(F.work_date);return s.getMonth()===i&&s.getFullYear()===j})}else if(H==="recent"){const a=new Date;a.setDate(a.getDate()-7),a.setHours(0,0,0,0),t=t.filter(i=>new Date(i.work_date)>=a)}return t},[x,f,H,T,D]),ce=h.useMemo(()=>{if(H!=="all")return null;const t={};return L.forEach(a=>{const i=new Date(a.work_date),j=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`,F=i.toLocaleDateString("en-US",{month:"long",year:"numeric"});t[j]||(t[j]={label:F,tickets:[],hours:0,cost:0}),t[j].tickets.push(a),t[j].hours+=je(a),t[j].cost+=pe(a)}),Object.entries(t).sort((a,i)=>i[0].localeCompare(a[0]))},[L,H]);h.useEffect(()=>{if(ce&&ce.length>0){const t=ce[0][0];E(new Set([t]))}},[ce]);const It=t=>{const a=new Set(M);a.has(t)?a.delete(t):a.add(t),E(a)},Wt=L.reduce((t,a)=>t+je(a),0),qt=L.reduce((t,a)=>t+pe(a),0),rt=f==="all"?x.length:x.filter(t=>t.status===f).length;if(I)return e.jsx("div",{className:`tm-list ${N?"tm-list-compact":""}`,children:e.jsx("div",{className:"tm-loading-skeletons",children:[1,2,3].map(t=>e.jsx(Ns,{},t))})});const Vt=L.length>0&&L.every(t=>O.has(t.id)),De=O.size>0,lt=t=>e.jsx(Ss,{ticket:t,isExpanded:de===t.id,isSelected:O.has(t.id),isLocked:!!A[t.id],lockInfo:A[t.id],hasFailedImport:!!Tt[t.id],isRetrying:Ft===t.id,onToggleExpand:zt,onToggleSelect:$t,onApprove:Dt,onUpdateStatus:we,onDelete:Rt,onOpenCorAssign:Et,onRetryImport:Pt,onShowSignatureLink:Ht,formatDate:Ne,calculateTotalHours:je,calculateTicketTotal:pe},t.id);return e.jsxs("div",{className:`tm-list ${N?"tm-list-compact":""}`,children:[e.jsx("div",{className:"tm-list-header",children:e.jsxs("div",{className:"tm-list-title",children:[e.jsx("h3",{children:"T&M Tickets"}),e.jsxs("div",{className:"tm-header-controls",children:[!N&&e.jsxs("div",{className:"tm-display-toggle",children:[e.jsxs("button",{className:`tm-display-btn ${b==="dashboard"?"active":""}`,onClick:()=>y("dashboard"),title:"Dashboard View",children:[e.jsx(gs,{size:16})," Dashboard"]}),e.jsxs("button",{className:`tm-display-btn ${b==="list"?"active":""}`,onClick:()=>y("list"),title:"List View",children:[e.jsx(xs,{size:16})," List"]})]}),e.jsxs("div",{className:"tm-export-buttons",children:[!N&&De&&e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:st,children:["Clear (",O.size,")"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>ys(x,u),disabled:x.length===0,children:[e.jsx(jt,{size:14})," CSV"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:At,disabled:x.length===0,children:[e.jsx(jt,{size:14})," Excel ",!N&&De?`(${O.size})`:""]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:Lt,disabled:x.length===0,children:[e.jsx(Ue,{size:14})," PDF ",!N&&De?`(${O.size})`:""]})]})]})]})}),!N&&e.jsxs("div",{className:"tm-list-filters",children:[e.jsx("div",{className:"tm-filter-tabs",children:["all","pending","approved","billed","rejected"].map(t=>e.jsxs("button",{className:`tm-filter-tab ${f===t?"active":""}`,onClick:()=>{ne(t),st()},children:[t.charAt(0).toUpperCase()+t.slice(1),e.jsx("span",{className:"tm-filter-count",children:t==="all"?x.length:x.filter(a=>a.status===t).length})]},t))}),e.jsxs("div",{className:"view-mode-bar",children:[e.jsxs("div",{className:"view-mode-tabs",children:[e.jsx("button",{className:`view-mode-tab ${H==="recent"?"active":""}`,onClick:()=>{m("recent"),ee({start:"",end:""})},children:"Recent (7 days)"}),e.jsxs("button",{className:`view-mode-tab ${H==="all"?"active":""}`,onClick:()=>m("all"),children:["All (",rt,")"]})]}),H==="all"&&e.jsxs("div",{className:"date-filter",children:[e.jsx(ps,{size:16}),e.jsx("input",{type:"date",value:T.start,onChange:t=>ee(a=>({...a,start:t.target.value})),placeholder:"Start date"}),e.jsx("span",{children:"to"}),e.jsx("input",{type:"date",value:T.end,onChange:t=>ee(a=>({...a,end:t.target.value})),placeholder:"End date"}),(T.start||T.end)&&e.jsx("button",{className:"btn btn-ghost btn-small",onClick:()=>ee({start:"",end:""}),children:"Clear"})]})]})]}),!N&&b==="dashboard"&&e.jsx(Cs,{tickets:x}),b==="list"&&e.jsxs(e.Fragment,{children:[!N&&L.length>0&&e.jsxs("div",{className:"tm-summary-bar",children:[e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Tickets"}),e.jsx("span",{className:"tm-summary-value",children:L.length})]}),e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Total Hours"}),e.jsx("span",{className:"tm-summary-value",children:Wt.toFixed(1)})]}),e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Materials Cost"}),e.jsxs("span",{className:"tm-summary-value",children:["$",qt.toFixed(2)]})]})]}),L.length===0?e.jsxs("div",{className:"tm-empty-state",children:[e.jsxs("p",{children:["No ",f==="all"?"":f," T&M tickets",H==="recent"?" in the last 7 days":""]}),H==="recent"&&rt>0&&e.jsx("button",{className:"btn btn-secondary btn-small",onClick:()=>m("all"),children:"View All Tickets"})]}):e.jsxs("div",{className:"tm-tickets stagger-children",children:[e.jsx("div",{className:"tm-select-all-row",children:e.jsxs("label",{className:"tm-checkbox-label",onClick:tt,children:[e.jsx("input",{type:"checkbox",checked:Vt,onChange:tt,className:"tm-checkbox"}),e.jsxs("span",{children:["Select All (",L.length,")"]})]})}),H==="all"&&ce?ce.map(([t,a])=>e.jsxs("div",{className:"month-group animate-fade-in",children:[e.jsxs("div",{className:"month-header",onClick:()=>It(t),children:[e.jsxs("div",{className:"month-header-left",children:[M.has(t)?e.jsx(js,{size:18}):e.jsx(bt,{size:18}),e.jsx("span",{className:"month-label",children:a.label}),e.jsx(ft,{count:a.tickets.length,label:"tickets",size:"small"})]}),e.jsxs("div",{className:"month-header-right",children:[e.jsxs("span",{className:"month-stat",children:[a.hours.toFixed(1)," hrs"]}),e.jsxs("span",{className:"month-stat",children:["$",a.cost.toFixed(2)]})]})]}),M.has(t)&&e.jsx("div",{className:"month-tickets stagger-children",children:a.tickets.map(i=>lt(i))})]},t)):L.map(t=>lt(t))]}),!D&&V&&!I&&x.length>0&&e.jsx("div",{className:"tm-load-more",children:e.jsx("button",{className:"btn btn-secondary",onClick:wt,disabled:W,children:W?"Loading...":`Load More (${x.length} of ${ie})`})}),D&&x.length>0&&e.jsxs("button",{className:"tm-see-all-btn",onClick:p,children:["See all ",ie||x.length," T&M tickets",e.jsx(bt,{size:16})]})]}),Se&&he&&e.jsx("div",{className:"modal-overlay",onClick:()=>ke(!1),children:e.jsxs("div",{className:"modal change-order-modal",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:"Approve Change Order Work"}),e.jsxs("p",{className:"modal-subtitle",children:["This T&M ticket is associated with ",e.jsx("strong",{children:he.ce_pco_number})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Change Order Value ($)"}),e.jsx("input",{type:"number",value:Te,onChange:t=>Ye(t.target.value),placeholder:"Enter the change order amount",autoFocus:!0}),e.jsx("p",{className:"form-help",children:"This amount will be added to the project's total contract value."})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>ke(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-success",onClick:Mt,children:["Approve with $",parseFloat(Te||0).toLocaleString()]})]})]})}),yt&&ue&&e.jsx(vs,{documentType:"tm_ticket",documentId:ue.id,companyId:n?.id,projectId:u?.id,project:u,documentTitle:`T&M Ticket - ${new Date(ue.work_date).toLocaleDateString()}${ue.ce_pco_number?` (${ue.ce_pco_number})`:""}`,onClose:()=>{Ge(!1),Je(null)},onShowToast:l}),Ct&&B&&e.jsx("div",{className:"modal-overlay",onClick:()=>ge(!1),children:e.jsxs("div",{className:"modal cor-assign-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Link Ticket to Change Order"}),e.jsx("button",{className:"close-btn",onClick:()=>ge(!1),children:e.jsx(bs,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{className:"modal-subtitle",children:["Ticket: ",e.jsx("strong",{children:new Date(B.work_date).toLocaleDateString()}),B.ce_pco_number&&` (${B.ce_pco_number})`]}),Ke?e.jsx("div",{className:"loading",children:"Loading change orders..."}):fe.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No change orders found for this project."}),e.jsx("p",{className:"text-muted",children:"Create a COR first, then link tickets to it."})]}):e.jsxs("div",{className:"cor-select-wrapper",children:[e.jsx("label",{children:"Select Change Order:"}),e.jsxs("select",{value:xe,onChange:t=>Fe(t.target.value),className:"cor-select",children:[e.jsx("option",{value:"",children:"-- No COR (unlink) --"}),fe.map(t=>e.jsxs("option",{value:t.id,children:[t.cor_number," - ",t.title||"Untitled"," (",t.status,")"]},t.id))]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>ge(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Ot,disabled:Ke||fe.length===0,children:B.assigned_cor_id&&!xe?"Unlink from COR":"Link to COR"})]})]})})]})}export{$s as default};
//# sourceMappingURL=TMList-CStXuxuW.js.map
