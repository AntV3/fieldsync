const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-6q4sZMdk.js","assets/icons-CRvlVhdL.js","assets/supabase-CgbGISss.js","assets/react-CVG0RKXH.js","assets/pdf-Dbfz8bwd.js","assets/index-B5BFg1nP.css"])))=>i.map(i=>d[i]);
import{aq as K,aL as Y,aH as me,aI as Ne,aV as pe,ar as H,as as e}from"./index-6q4sZMdk.js";import{a as O,c as Fe,X as ae,aE as ke,f as Te,F as re,a0 as ce,_ as de,au as ze,q as Ee,B as Pe,aJ as Re,e as Oe,b as De,w as we,C as Ie,$ as $e,N as qe,aK as oe,aL as Le,ag as ue,P as Ae,o as Ue,l as Me,D as he}from"./icons-CRvlVhdL.js";import{a as ge,f as u,d as E,b as $,c as Ge,k as He,e as se}from"./corCalculations-vdJc_BOT.js";import{_ as ne,E as xe,a as q}from"./pdf-Dbfz8bwd.js";import{e as Be}from"./Dashboard-Q9HM0WBN.js";import{S as We}from"./SignatureCanvas-0sBkqzWv.js";import Ye from"./SignatureLinkGenerator-BorMNDtA.js";import"./supabase-CgbGISss.js";import"./react-CVG0RKXH.js";const J={PENDING:"pending",GENERATING:"generating",COMPLETED:"completed",FAILED:"failed"},Ve={PDF:"pdf"};function Qe(n,b,p=null){if(p)return`custom_${p}`;const j=Math.floor(Date.now()/6e4);return`cor_${n}_v${b||1}_${j}`}function Je(n){return`cor_${n}_force_${Date.now()}`}function be(n,b,p={}){const j=new Date().toISOString(),S=[];let i=0;for(const h of b||[]){const g=h.photos||[];i+=g.length;for(const l of g)S.push({ticketId:h.id,workDate:h.work_date,url:l,verified:!1,includedInExport:!0})}const r=(n.change_order_labor||[]).reduce((h,g)=>h+(parseInt(g.total)||0),0),t=(n.change_order_materials||[]).reduce((h,g)=>h+(parseInt(g.total)||0),0),d=(n.change_order_equipment||[]).reduce((h,g)=>h+(parseInt(g.total)||0),0),c=(n.change_order_subcontractors||[]).reduce((h,g)=>h+(parseInt(g.total)||0),0);let s=0,a=0;for(const h of b||[])for(const g of h.t_and_m_workers||[])s+=parseFloat(g.hours)||0,a+=parseFloat(g.overtime_hours)||0;const y=JSON.stringify({corId:n.id,version:n.version,totals:{laborTotal:r,materialsTotal:t,equipmentTotal:d,subcontractorsTotal:c},ticketCount:b?.length||0,photoCount:i});let v=0;for(let h=0;h<y.length;h++){const g=y.charCodeAt(h);v=(v<<5)-v+g,v=v&v}const P=Math.abs(v).toString(16).padStart(16,"0");return{snapshotId:crypto.randomUUID(),corId:n.id,corVersion:n.version||1,createdAt:j,checksum:P,corData:{id:n.id,cor_number:n.cor_number,title:n.title,description:n.description,scope_of_work:n.scope_of_work,status:n.status,period_start:n.period_start,period_end:n.period_end,change_order_labor:n.change_order_labor||[],change_order_materials:n.change_order_materials||[],change_order_equipment:n.change_order_equipment||[],change_order_subcontractors:n.change_order_subcontractors||[],labor_markup_percent:n.labor_markup_percent,materials_markup_percent:n.materials_markup_percent,equipment_markup_percent:n.equipment_markup_percent,subcontractors_markup_percent:n.subcontractors_markup_percent,liability_insurance_percent:n.liability_insurance_percent,bond_percent:n.bond_percent,license_fee_percent:n.license_fee_percent,labor_subtotal:n.labor_subtotal,materials_subtotal:n.materials_subtotal,equipment_subtotal:n.equipment_subtotal,subcontractors_subtotal:n.subcontractors_subtotal,labor_markup_amount:n.labor_markup_amount,materials_markup_amount:n.materials_markup_amount,equipment_markup_amount:n.equipment_markup_amount,subcontractors_markup_amount:n.subcontractors_markup_amount,liability_insurance_amount:n.liability_insurance_amount,bond_amount:n.bond_amount,license_fee_amount:n.license_fee_amount,cor_subtotal:n.cor_subtotal,additional_fees_total:n.additional_fees_total,cor_total:n.cor_total,gc_signature_data:n.gc_signature_data,gc_signature_name:n.gc_signature_name,gc_signature_date:n.gc_signature_date,created_at:n.created_at,submitted_at:n.submitted_at,approved_at:n.approved_at},ticketsData:(b||[]).map(h=>({id:h.id,work_date:h.work_date,ticket_date:h.ticket_date,ce_pco_number:h.ce_pco_number,notes:h.notes,status:h.status,created_at:h.created_at,t_and_m_workers:(h.t_and_m_workers||[]).map(g=>({id:g.id,name:g.name,role:g.role,labor_class:g.labor_class,hours:g.hours,overtime_hours:g.overtime_hours,time_started:g.time_started,time_ended:g.time_ended})),t_and_m_items:(h.t_and_m_items||[]).map(g=>({id:g.id,description:g.description,quantity:g.quantity,unit:g.unit,materials_equipment:g.materials_equipment})),photos:h.photos||[],client_signature_data:h.client_signature_data,client_signature_name:h.client_signature_name,client_signature_title:h.client_signature_title,client_signature_company:h.client_signature_company,client_signature_date:h.client_signature_date})),photoManifest:S,totals:{laborTotal:r,materialsTotal:t,equipmentTotal:d,subcontractorsTotal:c,totalLaborHours:s,totalOTHours:a,ticketCount:b?.length||0,photoCount:i,verifiedTicketCount:(b||[]).filter(h=>h.client_signature_data).length}}}async function Ke(n,b={}){const{forceNew:p=!1,idempotencyKey:j=null,exportType:S=Ve.PDF,includeBackup:i=!0}=b;try{const{data:r,error:t}=await Y.from("change_orders").select("id, version, cor_number").eq("id",n).single();if(t||!r)throw new Error(`COR not found: ${n}`);const d=p?Je(n):j||Qe(n,r.version),{data:c,error:s}=await Y.rpc("request_cor_export",{p_cor_id:n,p_idempotency_key:d,p_options:{exportType:S,includeBackup:i},p_requested_by:(await Y.auth.getUser())?.data?.user?.id});if(s)throw s;const a=c?.[0];if(!a)throw new Error("Failed to create export job");return K.activity("cor_export_requested",{cor_id:n,job_id:a.job_id,is_new:a.is_new,status:a.status}),{jobId:a.job_id,status:a.status,isNew:a.is_new,snapshotId:a.snapshot_id,pdfUrl:a.pdf_url,idempotencyKey:d}}catch(r){throw K.error("cor_export_request_failed",{cor_id:n,error:r.message}),r}}async function ie(n,b,p={}){const{data:j,error:S}=await Y.rpc("update_export_job_status",{p_job_id:n,p_status:b,p_snapshot_id:p.snapshotId||null,p_pdf_url:p.pdfUrl||null,p_error:p.error||null,p_error_details:p.errorDetails||null,p_metrics:p.metrics||null});if(S)throw K.error("cor_export_job_update_failed",{job_id:n,status:b,error:S.message}),S;return j}async function Xe(n,b){await Y.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",n.corId);const{data:p,error:j}=await Y.from("cor_export_snapshots").insert({id:n.snapshotId,cor_id:n.corId,job_id:b,cor_version:n.corVersion,cor_data:n.corData,tickets_data:n.ticketsData,photos_manifest:n.photoManifest,totals_snapshot:n.totals,checksum:n.checksum,is_current:!0,exported_by:(await Y.auth.getUser())?.data?.user?.id}).select().single();if(j)throw j;return await Y.from("change_orders").update({last_snapshot_version:n.corVersion}).eq("id",n.corId),p}async function Ze(n,{cor:b,tickets:p,project:j,company:S,branding:i,options:r={}}={}){let t=null;try{if(t=await Ke(n,r),t.status===J.COMPLETED&&t.pdfUrl)return K.activity("cor_export_cache_hit",{cor_id:n,job_id:t.jobId}),{success:!0,jobId:t.jobId,cached:!0,pdfUrl:t.pdfUrl};if(t.status===J.GENERATING)return{success:!0,jobId:t.jobId,status:J.GENERATING,message:"Export already in progress"};if(await ie(t.jobId,J.GENERATING),!b){const{db:y}=await ne(async()=>{const{db:v}=await import("./index-6q4sZMdk.js").then(P=>P.a$);return{db:v}},__vite__mapDeps([0,1,2,3,4,5]));b=await y.getCORById(n)}if(!p&&r.includeBackup!==!1){const{db:y}=await ne(async()=>{const{db:v}=await import("./index-6q4sZMdk.js").then(P=>P.a$);return{db:v}},__vite__mapDeps([0,1,2,3,4,5]));p=await y.getCORTickets(n)}const d=be(b,p,r),c=await Xe(d,t.jobId),{generatePDFFromSnapshot:s}=await ne(async()=>{const{generatePDFFromSnapshot:y}=await Promise.resolve().then(()=>tt);return{generatePDFFromSnapshot:y}},void 0),a=await s(d,{project:j,company:S,branding:i});return await ie(t.jobId,J.COMPLETED,{snapshotId:c.id,pdfUrl:a.fileName,metrics:{photo_count:d.totals.photoCount,ticket_count:d.totals.ticketCount,page_count:a.pageCount||1,pdf_size_bytes:a.sizeBytes||0}}),K.activity("cor_export_completed",{cor_id:n,job_id:t.jobId,photo_count:d.totals.photoCount,ticket_count:d.totals.ticketCount}),{success:!0,jobId:t.jobId,snapshotId:c.id,fileName:a.fileName,snapshot:d.totals}}catch(d){throw t?.jobId&&await ie(t.jobId,J.FAILED,{error:d.message,errorDetails:{stack:d.stack}}).catch(()=>{}),K.error("cor_export_failed",{cor_id:n,job_id:t?.jobId,error:d.message}),d}}const _e=n=>{if(!n)return"";const[b,p]=n.split(":"),j=parseInt(b),S=j>=12?"pm":"am";return`${j%12||12}:${p}${S}`},fe=n=>n.time_started&&n.time_ended?`${_e(n.time_started)} - ${_e(n.time_ended)}`:"-";async function le(n,b={}){const{project:p,company:j,branding:S={}}=b,i=n.corData,r=n.ticketsData||[],t=new xe,d=t.internal.pageSize.getWidth(),c=t.internal.pageSize.getHeight(),s=20;let a=s;const y=S.primaryColor?me(S.primaryColor):[30,58,95];if(S.logoUrl)try{const l=await Ne(S.logoUrl);l&&t.addImage(l,"PNG",s,a,40,15)}catch{j?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...y),t.text(j.name,s,a+8))}else j?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...y),t.text(j.name,s,a+8));if(t.setFontSize(18),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("CHANGE ORDER REQUEST",d-s,a+5,{align:"right"}),t.setFontSize(12),t.setTextColor(...y),t.text(i.cor_number||"COR",d-s,a+12,{align:"right"}),a+=25,t.setDrawColor(...y),t.setLineWidth(.5),t.line(s,a,d-s,a),a+=10,t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(i.title||"Untitled Change Order",s,a),a+=8,t.setFontSize(10),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),p?.name&&(t.text(`Project: ${p.name}`,s,a),a+=5),p?.job_number&&(t.text(`Job #: ${p.job_number}`,s,a),a+=5),(i.period_start||i.period_end)&&(t.text(`Period: ${ge(i.period_start,i.period_end)}`,s,a),a+=5),a+=5,i.scope_of_work){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("Scope of Work:",s,a),a+=5,t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const l=t.splitTextToSize(i.scope_of_work,d-s*2);t.text(l,s,a),a+=l.length*4+8}i.change_order_labor?.length>0&&(t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Labor",s,a),a+=5,q(t,{startY:a,head:[["Class","Wage Type","Reg Hrs","Reg Rate","OT Hrs","OT Rate","Total"]],body:i.change_order_labor.map(l=>[l.labor_class,l.wage_type||"Standard",l.regular_hours?.toString()||"0",u(l.regular_rate),l.overtime_hours?.toString()||"0",u(l.overtime_rate),u(l.total)]),foot:[[{content:"Labor Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:u(i.labor_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:y,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),i.change_order_materials?.length>0&&(a>c-60&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Materials",s,a),a+=5,q(t,{startY:a,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_materials.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"ea",u(l.unit_cost),u(l.total)]),foot:[[{content:"Materials Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:u(i.materials_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:y,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),i.change_order_equipment?.length>0&&(a>c-60&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Equipment",s,a),a+=5,q(t,{startY:a,head:[["Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_equipment.map(l=>[l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"day",u(l.unit_cost),u(l.total)]),foot:[[{content:"Equipment Subtotal",colSpan:5,styles:{halign:"right",fontStyle:"bold"}},{content:u(i.equipment_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:y,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),i.change_order_subcontractors?.length>0&&(a>c-60&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Subcontractors",s,a),a+=5,q(t,{startY:a,head:[["Company Name","Description","Source","Qty","Unit","Unit Cost","Total"]],body:i.change_order_subcontractors.map(l=>[l.company_name||"-",l.description,l.source_reference||l.source_type||"-",l.quantity?.toString()||"1",l.unit||"lump sum",u(l.unit_cost),u(l.total)]),foot:[[{content:"Subcontractors Subtotal",colSpan:6,styles:{halign:"right",fontStyle:"bold"}},{content:u(i.subcontractors_subtotal),styles:{fontStyle:"bold"}}]],margin:{left:s,right:s},headStyles:{fillColor:y,textColor:[255,255,255],fontSize:8},bodyStyles:{fontSize:8},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8},theme:"grid"}),a=t.lastAutoTable.finalY+10),a>c-100&&(t.addPage(),a=s),t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("Cost Summary",s,a),a+=5;const v=[["Labor Subtotal",u(i.labor_subtotal)],[`  Markup (${E(i.labor_markup_percent)})`,u(i.labor_markup_amount)],["Materials Subtotal",u(i.materials_subtotal)],[`  Markup (${E(i.materials_markup_percent)})`,u(i.materials_markup_amount)],["Equipment Subtotal",u(i.equipment_subtotal)],[`  Markup (${E(i.equipment_markup_percent)})`,u(i.equipment_markup_amount)],["Subcontractors Subtotal",u(i.subcontractors_subtotal)],[`  Markup (${E(i.subcontractors_markup_percent)})`,u(i.subcontractors_markup_amount)]];q(t,{startY:a,body:v,margin:{left:s,right:s},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),a=t.lastAutoTable.finalY+5,t.setFillColor(248,250,252),t.rect(s,a,d-s*2,8,"F"),t.setFont("helvetica","bold"),t.setFontSize(10),t.setTextColor(30,41,59),t.text("COR Subtotal:",s+5,a+5.5),t.text(u(i.cor_subtotal),d-s-5,a+5.5,{align:"right"}),a+=12;const P=[[`Liability Insurance (${E(i.liability_insurance_percent)})`,u(i.liability_insurance_amount)],[`Bond (${E(i.bond_percent)})`,u(i.bond_amount)],[`License Fee (${E(i.license_fee_percent)})`,u(i.license_fee_amount)]];if(q(t,{startY:a,body:P,margin:{left:s,right:s},columnStyles:{0:{cellWidth:120},1:{cellWidth:50,halign:"right"}},bodyStyles:{fontSize:9},theme:"plain"}),a=t.lastAutoTable.finalY+5,t.setFillColor(...y),t.rect(s,a,d-s*2,10,"F"),t.setFont("helvetica","bold"),t.setFontSize(12),t.setTextColor(255,255,255),t.text("COR TOTAL:",s+5,a+7),t.text(u(i.cor_total),d-s-5,a+7,{align:"right"}),a+=20,r.length>0){t.addPage(),a=s,j?.name&&(t.setFontSize(14),t.setFont("helvetica","bold"),t.setTextColor(...y),t.text(j.name,s,a),a+=15),t.setDrawColor(...y),t.setLineWidth(.8),t.line(s,a,d-s,a),a+=3,t.setLineWidth(.3),t.line(s,a,d-s,a),a+=15,t.setFontSize(20),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("SUPPORTING DOCUMENTATION",d/2,a,{align:"center"}),a+=8,t.setFontSize(12),t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("Change Order Request Backup",d/2,a,{align:"center"}),a+=20,t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`COR Reference: ${i.cor_number}`,s,a),a+=6,t.setFont("helvetica","normal"),t.setTextColor(71,85,105),p?.name&&(t.text(`Project: ${p.name}`,s,a),a+=5),p?.job_number&&(t.text(`Job #: ${p.job_number}`,s,a),a+=5),a+=15,t.setFillColor(248,250,252),t.setDrawColor(226,232,240),t.roundedRect(s,a,d-s*2,55,3,3,"FD"),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text("DOCUMENTATION SUMMARY",s+10,a+12),t.setDrawColor(226,232,240),t.line(s+10,a+16,d-s-10,a+16);const l=s+15,f=s+80;let _=a+25;t.setFont("helvetica","normal"),t.setTextColor(71,85,105),t.text("T&M Tickets:",l,_),t.setFont("helvetica","bold"),t.text(String(r.length),f,_),t.setFont("helvetica","normal"),_+=7,t.text("Total Labor:",l,_),t.setFont("helvetica","bold"),t.text(`${n.totals.totalLaborHours.toFixed(1)} hrs`,f,_),t.setFont("helvetica","normal"),_+=7,n.totals.totalOTHours>0&&(t.text("Total OT:",l,_),t.setFont("helvetica","bold"),t.text(`${n.totals.totalOTHours.toFixed(1)} hrs`,f,_),t.setFont("helvetica","normal"),_+=7),t.text("Photo Evidence:",l,_),t.setFont("helvetica","bold"),t.text(`${n.totals.photoCount} photos`,f,_),t.setFont("helvetica","normal"),_+=7,t.text("Client Verified:",l,_),t.setFont("helvetica","bold");const R=n.totals.verifiedTicketCount>0?[16,185,129]:[71,85,105];t.setTextColor(...R),t.text(`${n.totals.verifiedTicketCount} of ${r.length} tickets`,f,_),a+=70,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(100,116,139);const T=new Date(n.createdAt);t.text(`Generated: ${T.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} at ${T.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}`,s,a),a+=6,t.text(`Document ID: ${n.checksum.substring(0,16).toUpperCase()}`,s,a);for(const m of r){t.addPage(),a=s;const D=!!m.client_signature_data,w=22,k=D?[16,185,129]:[245,158,11];if(t.setFillColor(...k),t.rect(s,a,4,w,"F"),t.setFillColor(248,250,252),t.rect(s+4,a,d-s*2-4,w,"F"),t.setFontSize(12),t.setFont("helvetica","bold"),t.setTextColor(30,41,59),t.text(`T&M TICKET — ${$(m.work_date||m.ticket_date)}`,s+10,a+8),m.ce_pco_number&&(t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`CE/PCO: ${m.ce_pco_number}`,s+10,a+16)),D&&(t.setFontSize(8),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("✓ CLIENT VERIFIED",d-s-35,a+12)),a+=w+8,m.notes){t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("DESCRIPTION",s,a),a+=6,t.setFontSize(9),t.setFont("helvetica","normal"),t.setTextColor(51,65,85);const x=t.splitTextToSize(m.notes,d-s*2);t.text(x,s,a),a+=x.length*4+10}if(m.t_and_m_workers?.length>0&&(t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("LABOR",s,a),a+=6,q(t,{startY:a,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:m.t_and_m_workers.map(x=>[x.name,fe(x),x.role||x.labor_class||"Laborer",x.hours?.toString()||"0",x.overtime_hours?.toString()||"-"]),margin:{left:s,right:s},headStyles:{fillColor:y,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),a=t.lastAutoTable.finalY+10),m.t_and_m_items?.length>0&&(a>c-60&&(t.addPage(),a=s),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("MATERIALS / EQUIPMENT",s,a),t.setFontSize(7),t.setFont("helvetica","normal"),t.setTextColor(100,116,139),t.text("Source: T&M Ticket",s+55,a),a+=6,q(t,{startY:a,head:[["Item","Qty","Unit"]],body:m.t_and_m_items.map(x=>[x.custom_name||x.materials_equipment?.name||x.description||"Unnamed Item",x.quantity?.toString()||"1",x.materials_equipment?.unit||x.unit||"ea"]),margin:{left:s,right:s},headStyles:{fillColor:y,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),a=t.lastAutoTable.finalY+10),m.photos?.length>0){a>c-80&&(t.addPage(),a=s),t.setFontSize(10),t.setFont("helvetica","bold"),t.setTextColor(71,85,105),t.text("PHOTO DOCUMENTATION",s,a),t.setFontSize(8),t.setFont("helvetica","normal"),t.setTextColor(59,130,246),t.text(`${m.photos.length} photo${m.photos.length!==1?"s":""}`,s+50,a),a+=8;let x=s;const I=55,z=45,B=6,X=3,V=await pe(m.photos);for(let L=0;L<m.photos.length;L++){L>0&&L%X===0&&(x=s,a+=z+B+4),a+z>c-20&&(t.addPage(),a=s,x=s);const W=V[L];W?(t.setDrawColor(200,200,200),t.setLineWidth(1),t.rect(x-1,a-1,I+2,z+2,"S"),t.setFillColor(230,230,230),t.rect(x+2,a+2,I,z,"F"),t.addImage(W,"JPEG",x,a,I,z)):(t.setFillColor(245,245,245),t.rect(x,a,I,z,"F"),t.setDrawColor(200,200,200),t.rect(x,a,I,z,"S"),t.setFontSize(7),t.setTextColor(150,150,150),t.text("Photo unavailable",x+8,a+z/2)),x+=I+B}a+=z+12}if(m.client_signature_data){a>c-50&&(t.addPage(),a=s);const x=32,I=d-s*2;t.setFillColor(240,253,244),t.roundedRect(s,a,I,x,3,3,"F"),t.setFillColor(16,185,129),t.rect(s,a,4,x,"F"),t.setDrawColor(187,247,208),t.setLineWidth(.5),t.line(s+4,a,s+I,a);const z=s+14,B=a+x/2;t.setFillColor(16,185,129),t.circle(z,B,6,"F"),t.setFontSize(9),t.setTextColor(255,255,255),t.text("✓",z-2.5,B+3),t.setFontSize(9),t.setFont("helvetica","bold"),t.setTextColor(16,185,129),t.text("CLIENT VERIFIED",s+26,a+10);try{t.addImage(m.client_signature_data,"PNG",s+26,a+13,50,16);const L=m.client_signature_name||"Client",W=m.client_signature_title||"",Z=m.client_signature_company||"",ee=m.client_signature_date?$(m.client_signature_date):"",te=s+85;t.setFont("helvetica","bold"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(L,te,a+12),t.setFont("helvetica","normal"),t.setFontSize(8),t.setTextColor(71,85,105),(W||Z)&&t.text(`${W}${W&&Z?", ":""}${Z}`,te,a+18),ee&&(t.setTextColor(100,116,139),t.text(`Verified: ${ee}`,te,a+24))}catch{const V=m.client_signature_name||"Client";t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(30,41,59),t.text(`Signed by: ${V}`,s+26,a+20)}}}}const h=t.internal.getNumberOfPages();for(let l=1;l<=h;l++){t.setPage(l);const f=c-10;t.setFontSize(8),t.setTextColor(150,150,150),t.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,s,f),t.text(`Page ${l} of ${h}`,d-s,f,{align:"right"})}const g=`${i.cor_number||"COR"}_${p?.job_number||"export"}${r.length?"_with_backup":""}.pdf`;return t.save(g),{success:!0,fileName:g,pageCount:h,sizeBytes:t.output().length}}async function je(n,b={}){const{project:p,company:j,branding:S={}}=b,i=n,r=new xe("p","mm","letter"),t=r.internal.pageSize.getWidth(),d=r.internal.pageSize.getHeight(),c=20;let s=c;const a=S.primaryColor?me(S.primaryColor):[30,58,95];j?.name&&(r.setFontSize(14),r.setFont("helvetica","bold"),r.setTextColor(...a),r.text(j.name,c,s+8)),r.setFontSize(16),r.setFont("helvetica","bold"),r.setTextColor(30,41,59),r.text("T&M TICKET",t-c,s+8,{align:"right"}),s+=25,r.setDrawColor(...a),r.setLineWidth(.5),r.line(c,s,t-c,s),s+=10,!!i.client_signature_data?(r.setFillColor(240,253,244),r.roundedRect(t-c-48,s-5,48,12,2,2,"F"),r.setFontSize(9),r.setFont("helvetica","bold"),r.setTextColor(16,185,129),r.text("✓ CLIENT VERIFIED",t-c-45,s+3)):(r.setFillColor(255,251,235),r.roundedRect(t-c-30,s-5,30,12,2,2,"F"),r.setFontSize(9),r.setFont("helvetica","bold"),r.setTextColor(217,119,6),r.text("PENDING",t-c-27,s+3));const v=[["Project:",p?.name||"N/A"],["Job #:",p?.job_number||"N/A"],["Work Date:",$(i.work_date||i.ticket_date)]];if(i.ce_pco_number&&v.push(["CE/PCO:",i.ce_pco_number]),v.forEach(([l,f])=>{r.setFontSize(10),r.setFont("helvetica","bold"),r.setTextColor(71,85,105),r.text(l,c,s),r.setFont("helvetica","normal"),r.setTextColor(30,41,59),r.text(f,c+28,s),s+=6}),s+=6,i.notes){r.setFontSize(10),r.setFont("helvetica","bold"),r.setTextColor(71,85,105),r.text("DESCRIPTION",c,s),s+=5,r.setFontSize(9),r.setFont("helvetica","normal"),r.setTextColor(51,65,85);const l=r.splitTextToSize(i.notes,t-c*2);r.text(l,c,s),s+=l.length*4+10}if(i.t_and_m_workers?.length>0){s>d-60&&(r.addPage(),s=c),r.setFontSize(10),r.setFont("helvetica","bold"),r.setTextColor(71,85,105),r.text("LABOR",c,s),s+=5;const l=i.t_and_m_workers.reduce((_,R)=>_+(parseFloat(R.hours)||0),0),f=i.t_and_m_workers.reduce((_,R)=>_+(parseFloat(R.overtime_hours)||0),0);q(r,{startY:s,head:[["Worker","Time Period","Class","Reg Hrs","OT Hrs"]],body:i.t_and_m_workers.map(_=>[_.name,fe(_),_.role||_.labor_class||"Laborer",_.hours?.toString()||"0",_.overtime_hours?.toString()||"-"]),foot:[[{content:"TOTAL HOURS",colSpan:3,styles:{halign:"right",fontStyle:"bold"}},{content:l.toFixed(1),styles:{fontStyle:"bold"}},{content:f>0?f.toFixed(1):"-",styles:{fontStyle:"bold"}}]],margin:{left:c,right:c},headStyles:{fillColor:a,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},footStyles:{fillColor:[248,250,252],textColor:[30,41,59],fontSize:8,fontStyle:"bold"},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=r.lastAutoTable.finalY+10}if(i.t_and_m_items?.length>0&&(s>d-60&&(r.addPage(),s=c),r.setFontSize(10),r.setFont("helvetica","bold"),r.setTextColor(71,85,105),r.text("MATERIALS / EQUIPMENT",c,s),s+=5,q(r,{startY:s,head:[["Item","Category","Qty","Unit"]],body:i.t_and_m_items.map(l=>[l.custom_name||l.materials_equipment?.name||l.description||"Unnamed Item",l.custom_category||l.materials_equipment?.category||"-",l.quantity?.toString()||"1",l.materials_equipment?.unit||l.unit||"ea"]),margin:{left:c,right:c},headStyles:{fillColor:a,textColor:[255,255,255],fontSize:8,cellPadding:3,fontStyle:"bold"},bodyStyles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[248,250,252]},theme:"grid"}),s=r.lastAutoTable.finalY+10),i.photos?.length>0){s>d-80&&(r.addPage(),s=c),r.setFontSize(10),r.setFont("helvetica","bold"),r.setTextColor(71,85,105),r.text("PHOTO DOCUMENTATION",c,s),r.setFontSize(8),r.setFont("helvetica","normal"),r.setTextColor(59,130,246),r.text(`${i.photos.length} photo${i.photos.length!==1?"s":""}`,c+55,s),s+=8;const l=await pe(i.photos),f=55,_=45,R=6,T=3;let m=c;for(let D=0;D<i.photos.length;D++){D>0&&D%T===0&&(m=c,s+=_+R+4),s+_>d-20&&(r.addPage(),s=c,m=c);const w=l[D];w?(r.setDrawColor(200,200,200),r.setLineWidth(.5),r.rect(m-1,s-1,f+2,_+2,"S"),r.addImage(w,"JPEG",m,s,f,_)):(r.setFillColor(245,245,245),r.rect(m,s,f,_,"F"),r.setDrawColor(200,200,200),r.rect(m,s,f,_,"S"),r.setFontSize(7),r.setTextColor(150,150,150),r.text("Photo unavailable",m+8,s+_/2)),m+=f+R}s+=_+12}if(i.client_signature_data){s>d-50&&(r.addPage(),s=c);const l=34,f=t-c*2;r.setFillColor(240,253,244),r.roundedRect(c,s,f,l,3,3,"F"),r.setFillColor(16,185,129),r.rect(c,s,4,l,"F"),r.setDrawColor(187,247,208),r.setLineWidth(.5),r.line(c+4,s,c+f,s);const _=c+14,R=s+l/2;r.setFillColor(16,185,129),r.circle(_,R,6,"F"),r.setFontSize(9),r.setTextColor(255,255,255),r.text("✓",_-2.5,R+3),r.setFontSize(9),r.setFont("helvetica","bold"),r.setTextColor(16,185,129),r.text("CLIENT VERIFIED",c+26,s+10);try{r.addImage(i.client_signature_data,"PNG",c+26,s+13,50,16);const T=c+85;r.setFont("helvetica","bold"),r.setFontSize(9),r.setTextColor(30,41,59),r.text(i.client_signature_name||"Client",T,s+12),r.setFont("helvetica","normal"),r.setFontSize(8),r.setTextColor(71,85,105);const m=[i.client_signature_title,i.client_signature_company].filter(Boolean).join(", ");m&&r.text(m,T,s+18),i.client_signature_date&&(r.setTextColor(100,116,139),r.text(`Verified: ${$(i.client_signature_date)}`,T,s+25))}catch{r.setFont("helvetica","normal"),r.setFontSize(9),r.setTextColor(30,41,59),r.text(`Signed by: ${i.client_signature_name||"Client"}`,c+26,s+20)}}const P=r.internal.getNumberOfPages();for(let l=1;l<=P;l++){r.setPage(l);const f=d-10;r.setFontSize(8),r.setTextColor(150,150,150),r.text(`Generated on ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,c,f),r.text(`Page ${l} of ${P}`,t-c,f,{align:"right"})}const g=`TM_Ticket_${$(i.work_date||i.ticket_date).replace(/\//g,"-")}${i.ce_pco_number?"_"+i.ce_pco_number:""}.pdf`;return r.save(g),{success:!0,fileName:g,pageCount:P}}const et={generatePDFFromSnapshot:le,generateTicketPDFFromData:je},tt=Object.freeze(Object.defineProperty({__proto__:null,default:et,generatePDFFromSnapshot:le,generateTicketPDFFromData:je},Symbol.toStringTag,{value:"Module"}));function ut({cor:n,project:b,company:p,areas:j,onClose:S,onEdit:i,onShowToast:r,onStatusChange:t}){const[d,c]=O.useState(!0),[s,a]=O.useState(n),[y,v]=O.useState(!1),[P,h]=O.useState(!1),[g,l]=O.useState(new Set),[f,_]=O.useState(null),[R,T]=O.useState(!1),[m,D]=O.useState(""),w=O.useCallback(async()=>{try{const o=await H.getCORById(n.id);if(o){if(o.tickets?.length){const C=o.tickets.map(A=>A.photos||[]),F=C.flat();if(F.length){const A=await H.resolvePhotoUrls(F);let U=0;o.tickets=o.tickets.map((M,N)=>{const G=C[N].length,ve=A.slice(U,U+G);return U+=G,{...M,photos:ve}})}}a(o)}}catch(o){console.error("Error fetching COR details:",o),r?.("Error loading COR details","error")}finally{c(!1)}},[n.id]);O.useEffect(()=>{w()},[w]),O.useEffect(()=>{const o=H.subscribeToCorTickets?.(n.id,()=>{w()});return()=>{o&&H.unsubscribe?.(o)}},[n.id,w]);const k=O.useMemo(()=>Ge(s),[s]),x=He(s.status),I=s.status==="pending_approval",z=["draft","pending_approval","approved"].includes(s.status),B=o=>j?.find(F=>F.id===o)?.name||null,X=async()=>{if(confirm("Approve this change order request?")){c(!0);try{await H.approveCOR(s.id),a({...s,status:"approved",approved_at:new Date().toISOString()}),r?.("COR approved","success"),t?.()}catch(o){console.error("Error approving COR:",o),r?.("Error approving COR","error")}finally{c(!1)}}},V=async()=>{const o=prompt("Enter rejection reason (optional):");if(o!==null){c(!0);try{await H.rejectCOR(s.id,o),a({...s,status:"rejected",rejection_reason:o}),r?.("COR rejected","success"),t?.()}catch(C){console.error("Error rejecting COR:",C),r?.("Error rejecting COR","error")}finally{c(!1)}}},L=async()=>{if(confirm("Mark this COR as billed?")){c(!0);try{await H.markCORAsBilled(s.id),a({...s,status:"billed"}),r?.("COR marked as billed","success"),t?.()}catch(o){console.error("Error marking COR as billed:",o),r?.("Error updating status","error")}finally{c(!1)}}},W=async o=>{c(!0);try{await H.saveCORSignature?.(s.id,{gc_signature:o.signature,gc_signer_name:o.signerName,signed_at:o.signedAt}),a({...s,gc_signature:o.signature,gc_signer_name:o.signerName,signed_at:o.signedAt}),v(!1),r?.("Signature saved","success"),t?.()}catch(C){console.error("Error saving signature:",C),r?.("Error saving signature","error")}finally{c(!1)}},Z=s.status==="approved"&&!s.gc_signature,ee=async()=>{if(!m.trim()){T(!1);return}c(!0);try{await H.updateCOR(s.id,{cor_number:m.trim()}),a({...s,cor_number:m.trim()}),T(!1),r?.("COR number updated","success")}catch(o){console.error("Error updating COR number:",o),r?.("Error updating COR number","error")}finally{c(!1)}},te=()=>{D(s.cor_number||""),T(!0)},Ce=o=>{l(C=>{const F=new Set(C);return F.has(o)?F.delete(o):F.add(o),F})},Q=O.useMemo(()=>s.change_order_ticket_associations?.map(o=>o.t_and_m_tickets).filter(Boolean)||[],[s.change_order_ticket_associations]),ye=o=>{const C=o.t_and_m_workers||[],F=C.reduce((U,M)=>U+(parseFloat(M.hours)||0),0),A=C.reduce((U,M)=>U+(parseFloat(M.overtime_hours)||0),0);return{regular:F,overtime:A,total:F+A}},Se=async()=>{const o={logoUrl:p?.logo_url,primaryColor:p?.branding_color};try{r?.("Generating PDF...","info");const C=await Ze(s.id,{cor:s,tickets:Q,project:b,company:p,branding:o,options:{includeBackup:!0}});r?.(C.cached?"PDF downloaded (cached)":"PDF downloaded","success")}catch(C){console.warn("Export pipeline unavailable, using direct generation:",C?.message);try{const F=be(s,Q);await le(F,{project:b,company:p,branding:o}),r?.("PDF downloaded","success")}catch(F){console.error("Error generating PDF:",F),r?.("Error generating PDF","error")}}};return d?e.jsx("div",{className:"modal-overlay",onClick:S,children:e.jsx("div",{className:"modal-content cor-detail-modal",onClick:o=>o.stopPropagation(),children:e.jsx("div",{className:"cor-detail-loading",children:"Loading COR details..."})})}):e.jsxs("div",{className:"modal-overlay",onClick:S,role:"dialog","aria-modal":"true","aria-labelledby":"cor-detail-title",children:[e.jsxs("div",{className:"modal-content cor-detail-modal",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"modal-header cor-detail-header",children:[e.jsxs("div",{className:"cor-detail-title-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"cor-detail-number",children:R?e.jsxs("div",{className:"cor-number-edit",children:[e.jsx("input",{type:"text",value:m,onChange:o=>D(o.target.value),onKeyDown:o=>{o.key==="Enter"&&ee(),o.key==="Escape"&&T(!1)},autoFocus:!0,className:"cor-number-input"}),e.jsx("button",{className:"btn-icon-sm",onClick:ee,title:"Save",children:e.jsx(Fe,{size:14})}),e.jsx("button",{className:"btn-icon-sm",onClick:()=>T(!1),title:"Cancel",children:e.jsx(ae,{size:14})})]}):e.jsxs("div",{className:"cor-number-display",children:[e.jsx("span",{children:s.cor_number}),z&&e.jsx("button",{className:"btn-icon-sm",onClick:te,title:"Edit COR number",children:e.jsx(ke,{size:12})})]})}),e.jsx("h2",{id:"cor-detail-title",children:s.title||"Untitled COR"})]}),e.jsx("button",{className:"close-btn",onClick:S,"aria-label":"Close COR details",children:e.jsx(ae,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"cor-detail-meta",children:[e.jsx("span",{className:"cor-detail-status",style:{backgroundColor:x.bgColor,color:x.color},children:x.label}),s.group_name&&e.jsx("span",{className:"cor-detail-group",children:s.group_name}),B(s.area_id)&&e.jsx("span",{className:"cor-detail-area",children:B(s.area_id)}),e.jsxs("span",{className:"cor-detail-period",children:[e.jsx(Te,{size:14})," ",ge(s.period_start,s.period_end)]})]})]}),e.jsxs("div",{className:"modal-body cor-detail-body",children:[e.jsxs("div",{className:"cor-detail-section",children:[e.jsxs("h3",{children:[e.jsx(re,{size:18})," Scope of Work"]}),e.jsx("p",{className:"cor-scope-text",children:s.scope_of_work||"No scope of work provided."})]}),e.jsxs("div",{className:"cor-detail-section pricing-breakdown",children:[e.jsxs("h3",{children:[e.jsx(ce,{size:18})," Pricing Breakdown"]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(de,{size:16}),e.jsx("span",{children:"Labor"})]}),e.jsx("span",{className:"category-subtotal",children:u(k.labor_subtotal)})]}),s.change_order_labor?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"Reg Rate"}),e.jsx("th",{children:"OT Hrs"}),e.jsx("th",{children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:s.change_order_labor.map((o,C)=>e.jsxs("tr",{children:[e.jsx("td",{children:o.labor_class}),e.jsx("td",{children:o.wage_type}),e.jsx("td",{children:o.regular_hours}),e.jsxs("td",{children:["$",se(o.regular_rate),"/hr"]}),e.jsx("td",{children:o.overtime_hours||"-"}),e.jsx("td",{children:o.overtime_hours?`$${se(o.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:u(o.total)})]},C))})]})}):e.jsx("div",{className:"category-empty",children:"No labor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",E(s.labor_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",u(k.labor_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ze,{size:16}),e.jsx("span",{children:"Materials"})]}),e.jsx("span",{className:"category-subtotal",children:u(k.materials_subtotal)})]}),s.change_order_materials?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:s.change_order_materials.map((o,C)=>e.jsxs("tr",{children:[e.jsx("td",{children:o.description}),e.jsx("td",{children:o.source_reference||o.source_type}),e.jsx("td",{children:o.quantity}),e.jsx("td",{children:o.unit}),e.jsxs("td",{children:["$",se(o.unit_cost)]}),e.jsx("td",{className:"text-right",children:u(o.total)})]},C))})]})}):e.jsx("div",{className:"category-empty",children:"No material items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",E(s.materials_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",u(k.materials_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Ee,{size:16}),e.jsx("span",{children:"Equipment"})]}),e.jsx("span",{className:"category-subtotal",children:u(k.equipment_subtotal)})]}),s.change_order_equipment?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:s.change_order_equipment.map((o,C)=>e.jsxs("tr",{children:[e.jsx("td",{children:o.description}),e.jsx("td",{children:o.source_reference||o.source_type}),e.jsx("td",{children:o.quantity}),e.jsx("td",{children:o.unit}),e.jsxs("td",{children:["$",se(o.unit_cost)]}),e.jsx("td",{className:"text-right",children:u(o.total)})]},C))})]})}):e.jsx("div",{className:"category-empty",children:"No equipment items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",E(s.equipment_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",u(k.equipment_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Pe,{size:16}),e.jsx("span",{children:"Subcontractors"})]}),e.jsx("span",{className:"category-subtotal",children:u(k.subcontractors_subtotal)})]}),s.change_order_subcontractors?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:s.change_order_subcontractors.map((o,C)=>e.jsxs("tr",{children:[e.jsx("td",{children:o.company_name}),e.jsx("td",{children:o.description}),e.jsx("td",{children:o.source_reference||o.source_type}),e.jsx("td",{className:"text-right",children:u(o.total)})]},C))})]})}):e.jsx("div",{className:"category-empty",children:"No subcontractor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",E(s.subcontractors_markup_percent||500),")"]}),e.jsxs("span",{children:["+",u(k.subcontractors_markup_amount)]})]})]}),e.jsxs("div",{className:"cor-subtotal-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:u(k.cor_subtotal)})]}),e.jsxs("div",{className:"pricing-category fees-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Re,{size:16}),e.jsx("span",{children:"Additional Fees"})]}),e.jsx("span",{className:"category-subtotal",children:u(k.additional_fees_total)})]}),e.jsxs("div",{className:"fees-list",children:[e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(Oe,{size:14}),e.jsxs("span",{children:["Liability Insurance (",E(s.liability_insurance_percent||144),")"]})]}),e.jsx("span",{className:"fee-amount",children:u(k.liability_insurance_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(re,{size:14}),e.jsxs("span",{children:["Bond (",E(s.bond_percent||100),")"]})]}),e.jsx("span",{className:"fee-amount",children:u(k.bond_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(De,{size:14}),e.jsxs("span",{children:["City License Fee (",E(s.license_fee_percent||10),")"]})]}),e.jsx("span",{className:"fee-amount",children:u(k.license_fee_amount)})]})]})]}),e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:u(k.cor_total)})]})]}),Q.length>0&&e.jsxs("div",{className:"cor-detail-section backup-section",children:[e.jsxs("h3",{children:[e.jsx(re,{size:18})," Backup Documentation"]}),e.jsxs("p",{className:"backup-summary",children:[Q.length," T&M ticket",Q.length!==1?"s":""," associated with this COR"]}),e.jsx("div",{className:"backup-tickets-list",children:Q.map(o=>{const C=g.has(o.id),F=ye(o),A=o.t_and_m_workers?.length||0,U=o.t_and_m_items?.length||0,M=o.photos?.length||0;return e.jsxs("div",{className:"backup-ticket-card",children:[e.jsxs("div",{className:"backup-ticket-header",onClick:()=>Ce(o.id),children:[e.jsx("div",{className:"backup-ticket-toggle",children:C?e.jsx(we,{size:18}):e.jsx(Ie,{size:18})}),e.jsxs("div",{className:"backup-ticket-info",children:[e.jsxs("div",{className:"backup-ticket-date",children:[e.jsx($e,{size:14}),e.jsx("span",{children:$(o.work_date)})]}),o.ce_pco_number&&e.jsxs("span",{className:"backup-ticket-pco",children:["CE/PCO: ",o.ce_pco_number]})]}),e.jsxs("div",{className:"backup-ticket-stats",children:[e.jsxs("span",{className:"backup-stat",children:[e.jsx(de,{size:14})," ",A]}),e.jsxs("span",{className:"backup-stat",children:[F.total.toFixed(1)," hrs"]}),M>0&&e.jsxs("span",{className:"backup-stat",children:[e.jsx(qe,{size:14})," ",M]}),o.client_signature_data&&e.jsxs("span",{className:"backup-stat verified",title:`Verified by ${o.client_signature_name}`,children:[e.jsx(oe,{size:14})," Verified"]})]}),e.jsx("span",{className:`backup-ticket-status status-${o.status}`,children:o.status})]}),C&&e.jsxs("div",{className:"backup-ticket-details",children:[o.notes&&e.jsxs("div",{className:"backup-ticket-notes",children:[e.jsx("strong",{children:"Notes:"})," ",o.notes]}),o.t_and_m_workers?.length>0&&e.jsxs("div",{className:"backup-workers",children:[e.jsxs("h4",{children:["Labor (",A," workers)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT Hrs"})]})}),e.jsx("tbody",{children:o.t_and_m_workers.map((N,G)=>e.jsxs("tr",{children:[e.jsx("td",{children:N.name}),e.jsx("td",{children:N.role||"-"}),e.jsx("td",{className:"backup-time-range",children:N.time_started&&N.time_ended?`${N.time_started} - ${N.time_ended}`:"-"}),e.jsx("td",{children:N.hours||0}),e.jsx("td",{children:N.overtime_hours||"-"})]},G))})]})]}),o.t_and_m_items?.length>0&&e.jsxs("div",{className:"backup-items",children:[e.jsxs("h4",{children:["Materials & Equipment (",U," items)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Qty"})]})}),e.jsx("tbody",{children:o.t_and_m_items.map((N,G)=>e.jsxs("tr",{children:[e.jsx("td",{children:N.custom_name||N.materials_equipment?.name||"Unnamed Item"}),e.jsx("td",{children:N.custom_category||N.materials_equipment?.category||"-"}),e.jsx("td",{children:N.quantity})]},G))})]})]}),o.photos?.length>0&&e.jsxs("div",{className:"backup-photos",children:[e.jsxs("h4",{children:["Photos (",M,")"]}),e.jsx("div",{className:"backup-photos-grid",children:o.photos.map((N,G)=>e.jsx("div",{className:"backup-photo-thumb",onClick:()=>_(N),children:e.jsx("img",{src:N,alt:`Photo ${G+1}`})},G))})]}),o.client_signature_data&&e.jsxs("div",{className:"backup-verification",children:[e.jsxs("h4",{children:[e.jsx(oe,{size:14})," Client Verification"]}),e.jsxs("div",{className:"backup-signature-display",children:[e.jsx("img",{src:o.client_signature_data,alt:"Client Signature",className:"backup-signature-image"}),e.jsxs("div",{className:"backup-signature-info",children:[e.jsx("span",{className:"backup-signer-name",children:o.client_signature_name}),o.client_signature_title&&e.jsx("span",{className:"backup-signer-title",children:o.client_signature_title}),o.client_signature_company&&e.jsx("span",{className:"backup-signer-company",children:o.client_signature_company}),e.jsxs("span",{className:"backup-signed-date",children:["Verified: ",$(o.client_signature_date)]})]})]})]})]})]},o.id)})})]}),(s.gc_signature_data||s.gc_signature||s.client_signature_data)&&e.jsxs("div",{className:"cor-detail-section signature-section",children:[e.jsxs("h3",{children:[e.jsx(Le,{size:18})," Signatures"]}),e.jsxs("div",{className:"dual-signatures",children:[(s.gc_signature_data||s.gc_signature)&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"GC Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:s.gc_signature_data||s.gc_signature,alt:"GC Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:s.gc_signature_name||s.gc_signer_name}),(s.gc_signature_title||s.gc_signature_company)&&e.jsxs("span",{className:"signer-org",children:[s.gc_signature_title,s.gc_signature_title&&s.gc_signature_company&&" - ",s.gc_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",$(s.gc_signature_date||s.signed_at)]})]})]})]}),s.client_signature_data&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"Client Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:s.client_signature_data,alt:"Client Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:s.client_signature_name}),(s.client_signature_title||s.client_signature_company)&&e.jsxs("span",{className:"signer-org",children:[s.client_signature_title,s.client_signature_title&&s.client_signature_company&&" - ",s.client_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",$(s.client_signature_date)]})]})]})]})]})]}),s.status==="rejected"&&s.rejection_reason&&e.jsxs("div",{className:"cor-detail-section rejection-section",children:[e.jsxs("h3",{children:[e.jsx(ue,{size:18})," Rejection Reason"]}),e.jsx("p",{className:"rejection-text",children:s.rejection_reason})]})]}),e.jsxs("div",{className:"modal-footer cor-detail-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{children:["Created: ",$(s.created_at)]}),s.approved_at&&e.jsxs("span",{children:["Approved: ",$(s.approved_at)]})]}),e.jsxs("div",{className:"footer-actions",role:"group","aria-label":"COR actions",children:[z&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>i?.(s),disabled:d,"aria-label":"Edit this COR",children:[e.jsx(Ae,{size:16,"aria-hidden":"true"})," Edit"]}),I&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:V,disabled:d,"aria-label":"Reject this COR",children:[e.jsx(ue,{size:16,"aria-hidden":"true"})," Reject"]}),e.jsxs("button",{className:"btn btn-success",onClick:X,disabled:d,"aria-label":"Approve this COR",children:[e.jsx(Ue,{size:16,"aria-hidden":"true"})," Approve"]})]}),Z&&e.jsxs("button",{className:"btn btn-success",onClick:()=>v(!0),disabled:d,"aria-label":"Get GC signature for this COR",children:[e.jsx(oe,{size:16,"aria-hidden":"true"})," Get GC Signature"]}),(s.status==="approved"||s.status==="pending_approval")&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>h(!0),disabled:d,"aria-label":"Get shareable signature link",children:[e.jsx(Me,{size:16,"aria-hidden":"true"})," Get Signature Link"]}),s.status==="approved"&&e.jsxs("button",{className:"btn btn-primary",onClick:L,disabled:d,"aria-label":"Mark this COR as billed",children:[e.jsx(ce,{size:16,"aria-hidden":"true"})," Mark Billed"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Be(s),"aria-label":"Export COR to CSV",children:[e.jsx(he,{size:16,"aria-hidden":"true"})," Export CSV"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:Se,"aria-label":"Export COR to PDF",children:[e.jsx(he,{size:16,"aria-hidden":"true"})," Export PDF"]})]})]})]}),y&&e.jsx(We,{onSave:W,onClose:()=>v(!1),signerName:""}),P&&e.jsx(Ye,{documentType:"cor",documentId:s.id,companyId:p?.id,projectId:b?.id,project:b,documentTitle:`COR ${s.cor_number}: ${s.title||"Untitled"}`,onClose:()=>h(!1),onShowToast:r}),f&&e.jsxs("div",{className:"photo-lightbox",onClick:()=>_(null),children:[e.jsx("button",{className:"lightbox-close",onClick:()=>_(null),children:e.jsx(ae,{size:24})}),e.jsx("img",{src:f,alt:"Full size photo",onClick:o=>o.stopPropagation()})]})]})}export{ut as default};
//# sourceMappingURL=CORDetail-B5-ru0FP.js.map
