import{_ as Ve}from"./pdf-aQqpMATS.js";import{as as e,av as qe,aA as Gt,aB as Jt,aC as Kt,az as Be,aP as Xt,aw as Zt,ax as mt,ay as ht,aQ as Qt,aJ as es,ar as $,aM as ut,aN as ts}from"./index-BN4vUci9.js";import{r as h,s as pt,c as ss,N as as,Q as rs,a as ls,j as vt,F as Ue,K as ns,ar as gt,f as xt,T as os,H as is,W as cs,g as ds,as as ms,ab as hs,ah as us,at as ps,z as gs,O as xs,q as js,y as jt,X as bs}from"./icons-Dl48tZuS.js";import vs from"./SignatureLinkGenerator-CKoVc6KB.js";import{A as _s,a as fs,C as _t,T as Ns}from"./Dashboard-JR1G19hZ.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";import"./corCalculations-D9qkkIbo.js";function ys({tickets:u=[],laborRates:o={}}){const l=h.useMemo(()=>{if(!u.length)return{total:0,pending:0,approved:0,billed:0,rejected:0,totalHours:0,regularHours:0,overtimeHours:0,materialsCost:0,uniqueWorkers:0,avgHoursPerTicket:0,approvalRate:0,pendingValue:0,approvedValue:0,billedValue:0,workersByRole:{},topWorkers:[],byMonth:[],byStatus:[]};const g=u.filter(m=>m.status==="pending").length,_=u.filter(m=>m.status==="approved").length,x=u.filter(m=>m.status==="billed").length,S=u.filter(m=>m.status==="rejected").length;let L=0,ae=0,I=0;const W={},f={Foreman:0,Superintendent:0,Operator:0,Laborer:0};u.forEach(m=>{m.t_and_m_workers&&m.t_and_m_workers.forEach(b=>{const y=parseFloat(b.hours)||0,M=parseFloat(b.overtime_hours)||0;ae+=y,I+=M,L+=y+M;const O=b.name||"Unknown";W[O]||(W[O]={name:O,hours:0,role:b.role||"Laborer"}),W[O].hours+=y+M;const T=b.role||"Laborer";f[T]!==void 0?f[T]+=y+M:f[T]=y+M})});let re=0;u.forEach(m=>{m.t_and_m_items&&m.t_and_m_items.forEach(b=>{const y=b.materials_equipment?.cost_per_unit||0;re+=b.quantity*y})});const ce=Object.keys(W).length,K=Object.values(W).sort((m,b)=>b.hours-m.hours).slice(0,5),E=_+x+S,X=E>0?Math.round((_+x)/E*100):0,U={...{Foreman:85,Superintendent:95,Operator:75,Laborer:55},...o},Y=m=>{let b=0,y=0;return m.t_and_m_workers&&m.t_and_m_workers.forEach(M=>{const O=M.role||"Laborer",T=U[O]||U.Laborer,Z=parseFloat(M.hours)||0,Se=parseFloat(M.overtime_hours)||0;b+=Z*T+Se*T*1.5}),m.t_and_m_items&&m.t_and_m_items.forEach(M=>{const O=M.materials_equipment?.cost_per_unit||0;y+=M.quantity*O}),b+y},d=u.filter(m=>m.status==="pending").reduce((m,b)=>m+Y(b),0),le=u.filter(m=>m.status==="approved").reduce((m,b)=>m+Y(b),0),ne=u.filter(m=>m.status==="billed").reduce((m,b)=>m+Y(b),0),G={};u.forEach(m=>{const b=new Date(m.work_date),y=`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}`,M=b.toLocaleDateString("en-US",{month:"short",year:"2-digit"});G[y]||(G[y]={month:M,monthKey:y,tickets:0,hours:0,cost:0,value:0}),G[y].tickets+=1,G[y].cost+=Y(m)-re,m.t_and_m_workers&&m.t_and_m_workers.forEach(O=>{const T=parseFloat(O.hours)||0,Z=parseFloat(O.overtime_hours)||0;G[y].hours+=T+Z}),m.t_and_m_items&&m.t_and_m_items.forEach(O=>{const T=O.materials_equipment?.cost_per_unit||0;G[y].value+=O.quantity*T})});const _e=Object.values(G).sort((m,b)=>m.monthKey.localeCompare(b.monthKey)).slice(-6),P=[{name:"Pending",value:g,color:"#f59e0b"},{name:"Approved",value:_,color:"#10b981"},{name:"Billed",value:x,color:"#3b82f6"},{name:"Rejected",value:S,color:"#ef4444"}].filter(m=>m.value>0);return{total:u.length,pending:g,approved:_,billed:x,rejected:S,totalHours:L,regularHours:ae,overtimeHours:I,materialsCost:re,uniqueWorkers:ce,avgHoursPerTicket:u.length>0?L/u.length:0,approvalRate:X,pendingValue:d,approvedValue:le,billedValue:ne,workersByRole:f,topWorkers:K,byMonth:_e,byStatus:P}},[u,o]),N=g=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(g),D=({active:g,payload:_,label:x})=>g&&_&&_.length?e.jsxs("div",{className:"tm-chart-tooltip",children:[e.jsx("p",{className:"tm-tooltip-label",children:x}),_.map((S,L)=>e.jsxs("p",{style:{color:S.color},children:[S.name,": ",S.name.includes("Cost")||S.name.includes("Value")?N(S.value):S.value.toFixed(1)]},L))]}):null;return u.length===0?e.jsxs("div",{className:"tm-dashboard tm-dashboard-empty",children:[e.jsx("div",{className:"tm-empty-icon",children:e.jsx(pt,{size:48})}),e.jsx("p",{children:"No T&M tickets yet"}),e.jsx("p",{className:"tm-empty-hint",children:"Create tickets to see analytics and trends"})]}):e.jsxs("div",{className:"tm-dashboard",children:[e.jsxs("div",{className:"tm-summary-cards",children:[e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon tickets",children:e.jsx(pt,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l.total}),e.jsx("span",{className:"tm-card-label",children:"Total Tickets"})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon hours",children:e.jsx(ss,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l.totalHours.toFixed(1)}),e.jsx("span",{className:"tm-card-label",children:"Total Hours"}),l.overtimeHours>0&&e.jsxs("span",{className:"tm-card-detail",children:[l.overtimeHours.toFixed(1)," OT"]})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon workers",children:e.jsx(as,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:l.uniqueWorkers}),e.jsx("span",{className:"tm-card-label",children:"Workers"})]})]}),e.jsxs("div",{className:"tm-summary-card",children:[e.jsx("div",{className:"tm-card-icon materials",children:e.jsx(rs,{size:20})}),e.jsxs("div",{className:"tm-card-content",children:[e.jsx("span",{className:"tm-card-value",children:N(l.materialsCost)}),e.jsx("span",{className:"tm-card-label",children:"Materials"})]})]})]}),e.jsxs("div",{className:"tm-status-cards",children:[e.jsxs("div",{className:"tm-status-card pending",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(ls,{size:16}),e.jsx("span",{children:"Pending"})]}),e.jsx("div",{className:"tm-status-count",children:l.pending}),e.jsx("div",{className:"tm-status-value",children:N(l.pendingValue)})]}),e.jsxs("div",{className:"tm-status-card approved",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(vt,{size:16}),e.jsx("span",{children:"Approved"})]}),e.jsx("div",{className:"tm-status-count",children:l.approved}),e.jsx("div",{className:"tm-status-value",children:N(l.approvedValue)})]}),e.jsxs("div",{className:"tm-status-card billed",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(Ue,{size:16}),e.jsx("span",{children:"Billed"})]}),e.jsx("div",{className:"tm-status-count",children:l.billed}),e.jsx("div",{className:"tm-status-value",children:N(l.billedValue)})]}),e.jsxs("div",{className:"tm-status-card rate",children:[e.jsxs("div",{className:"tm-status-header",children:[e.jsx(ns,{size:16}),e.jsx("span",{children:"Approval Rate"})]}),e.jsxs("div",{className:"tm-status-count",children:[l.approvalRate,"%"]}),e.jsxs("div",{className:"tm-status-value",children:[l.approved+l.billed," / ",l.total-l.pending]})]})]}),e.jsxs("div",{className:"tm-charts-row",children:[l.byStatus.length>0&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Status Distribution"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(qe,{width:"100%",height:200,children:e.jsxs(Gt,{children:[e.jsx(Jt,{data:l.byStatus,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:2,dataKey:"value",label:({name:g,percent:_})=>`${g} ${(_*100).toFixed(0)}%`,labelLine:!1,children:l.byStatus.map((g,_)=>e.jsx(Kt,{fill:g.color},`cell-${_}`))}),e.jsx(Be,{})]})})}),e.jsx("div",{className:"tm-chart-legend",children:l.byStatus.map((g,_)=>e.jsxs("div",{className:"tm-legend-item",children:[e.jsx("span",{className:"tm-legend-color",style:{background:g.color}}),e.jsx("span",{className:"tm-legend-label",children:g.name}),e.jsx("span",{className:"tm-legend-value",children:g.value})]},_))})]}),l.byMonth.length>0&&e.jsxs("div",{className:"tm-chart-card wide",children:[e.jsx("h4",{className:"tm-chart-title",children:"Hours by Month"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(qe,{width:"100%",height:200,children:e.jsxs(Xt,{data:l.byMonth,children:[e.jsx(Zt,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(mt,{dataKey:"month",tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:{stroke:"var(--border-color)"}}),e.jsx(ht,{tick:{fill:"var(--text-secondary)",fontSize:12},axisLine:{stroke:"var(--border-color)"}}),e.jsx(Be,{content:e.jsx(D,{})}),e.jsx(Qt,{dataKey:"hours",name:"Hours",fill:"var(--primary-color)",radius:[4,4,0,0]})]})})})]})]}),e.jsxs("div",{className:"tm-charts-row",children:[e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Hours by Role"}),e.jsx("div",{className:"tm-role-breakdown",children:Object.entries(l.workersByRole).filter(([,g])=>g>0).sort((g,_)=>_[1]-g[1]).map(([g,_])=>{const x=_/l.totalHours*100;return e.jsxs("div",{className:"tm-role-bar",children:[e.jsxs("div",{className:"tm-role-info",children:[e.jsx("span",{className:"tm-role-name",children:g}),e.jsxs("span",{className:"tm-role-hours",children:[_.toFixed(1)," hrs"]})]}),e.jsx("div",{className:"tm-role-track",children:e.jsx("div",{className:"tm-role-fill",style:{width:`${x}%`}})})]},g)})})]}),l.topWorkers.length>0&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Top Workers"}),e.jsx("div",{className:"tm-top-workers",children:l.topWorkers.map((g,_)=>e.jsxs("div",{className:"tm-worker-row",children:[e.jsxs("span",{className:"tm-worker-rank",children:["#",_+1]}),e.jsxs("div",{className:"tm-worker-info",children:[e.jsx("span",{className:"tm-worker-name",children:g.name}),e.jsx("span",{className:"tm-worker-role",children:g.role})]}),e.jsxs("span",{className:"tm-worker-hours",children:[g.hours.toFixed(1)," hrs"]})]},g.name))})]}),l.byMonth.length>1&&e.jsxs("div",{className:"tm-chart-card",children:[e.jsx("h4",{className:"tm-chart-title",children:"Ticket Volume"}),e.jsx("div",{className:"tm-chart-container",children:e.jsx(qe,{width:"100%",height:150,children:e.jsxs(_s,{data:l.byMonth,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"ticketGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"var(--primary-color)",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"var(--primary-color)",stopOpacity:0})]})}),e.jsx(mt,{dataKey:"month",tick:{fill:"var(--text-secondary)",fontSize:10},axisLine:!1,tickLine:!1}),e.jsx(ht,{hide:!0}),e.jsx(Be,{content:e.jsx(D,{})}),e.jsx(fs,{type:"monotone",dataKey:"tickets",name:"Tickets",stroke:"var(--primary-color)",fill:"url(#ticketGradient)",strokeWidth:2})]})})})]})]}),e.jsxs("div",{className:"tm-quick-stats",children:[e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Avg Hours/Ticket"}),e.jsx("span",{className:"tm-quick-value",children:l.avgHoursPerTicket.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Regular Hours"}),e.jsx("span",{className:"tm-quick-value",children:l.regularHours.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Overtime Hours"}),e.jsx("span",{className:"tm-quick-value",children:l.overtimeHours.toFixed(1)})]}),e.jsxs("div",{className:"tm-quick-stat",children:[e.jsx("span",{className:"tm-quick-label",children:"Total Est. Value"}),e.jsx("span",{className:"tm-quick-value",children:N(l.pendingValue+l.approvedValue+l.billedValue)})]})]})]})}const Cs=h.memo(function({ticket:o,isExpanded:l,isSelected:N,isLocked:D,lockInfo:g,hasFailedImport:_,isRetrying:x,onToggleExpand:S,onToggleSelect:L,onApprove:ae,onUpdateStatus:I,onDelete:W,onOpenCorAssign:f,onRetryImport:re,onShowSignatureLink:ce,formatDate:K,calculateTotalHours:E,calculateTicketTotal:X}){const de=E(o),U=X(o),Y=d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),S(o.id))};return e.jsxs("div",{className:`tm-ticket-card hover-lift animate-fade-in-up ${o.status} ${N?"selected":""} ${D?"locked":""}`,role:"article","aria-label":`T&M Ticket for ${K(o.work_date)}, ${de} hours, $${U.toFixed(2)}, status: ${o.status}`,children:[e.jsxs("div",{className:"tm-ticket-header",onClick:()=>S(o.id),onKeyDown:Y,role:"button",tabIndex:0,"aria-expanded":l,"aria-label":`${l?"Collapse":"Expand"} ticket details`,children:[e.jsx("input",{type:"checkbox",checked:N,onChange:d=>L(o.id,d),onClick:d=>d.stopPropagation(),className:"tm-checkbox","aria-label":`Select ticket for ${K(o.work_date)}`}),e.jsxs("div",{className:"tm-ticket-info",children:[e.jsx("span",{className:"tm-ticket-date",children:K(o.work_date)}),o.ce_pco_number&&e.jsx("span",{className:"tm-ce-badge",children:o.ce_pco_number}),o.assigned_cor_id&&g?.lockedBy&&e.jsxs("span",{className:`tm-cor-badge ${D?"locked":""}`,title:g?.reason,children:[D&&e.jsx(gt,{size:10}),g.lockedBy.cor_number]}),o.photos?.length>0&&e.jsx(_t,{count:o.photos.length,icon:xt,size:"small",variant:"default"}),_&&e.jsxs("span",{className:"tm-import-failed-badge",title:"COR data import failed - retry needed",children:[e.jsx(os,{size:12})," Import Failed"]}),o.client_signature_data&&e.jsxs("span",{className:"tm-verified-badge",title:`Verified by ${o.client_signature_name||"client"}${o.client_signature_date?` on ${K(o.client_signature_date)}`:""}`,children:[e.jsx(vt,{size:12})," Verified"]}),e.jsx("span",{className:`tm-ticket-status ${o.status}`,children:o.status})]}),e.jsxs("div",{className:"tm-ticket-summary",children:[e.jsxs("span",{className:"tm-ticket-hours",children:[de," hrs"]}),e.jsxs("span",{className:"tm-ticket-total",children:["$",U.toFixed(2)]}),e.jsx("span",{className:"tm-expand-arrow","aria-hidden":"true",children:l?"▼":"▶"})]})]}),l&&e.jsxs("div",{className:"tm-ticket-details",children:[o.t_and_m_workers?.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(is,{size:16,className:"inline-icon"})," Workers"]}),e.jsx("div",{className:"tm-detail-list",children:o.t_and_m_workers.map(d=>e.jsxs("div",{className:"tm-detail-row",children:[e.jsxs("span",{children:[d.role&&d.role!=="Laborer"&&e.jsx("span",{className:"tm-role-badge",children:d.role}),d.name]}),e.jsxs("span",{children:[d.hours," hrs",parseFloat(d.overtime_hours)>0&&e.jsxs("span",{className:"tm-ot-badge",children:[" +",d.overtime_hours," OT"]})]})]},d.id))})]}),o.t_and_m_items?.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(cs,{size:16,className:"inline-icon"})," Materials & Equipment"]}),e.jsx("div",{className:"tm-detail-list",children:o.t_and_m_items.map(d=>e.jsxs("div",{className:"tm-detail-row",children:[e.jsx("span",{children:d.custom_name?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tm-custom-badge",children:"Custom"})," ",d.custom_name]}):d.materials_equipment?.name}),e.jsxs("span",{className:"tm-detail-qty",children:[d.quantity," ",d.materials_equipment?.unit||"each",d.materials_equipment?.cost_per_unit>0&&e.jsxs("span",{className:"tm-item-cost",children:["$",(d.quantity*d.materials_equipment.cost_per_unit).toFixed(2)]})]})]},d.id))})]}),o.notes&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(Ue,{size:16,className:"inline-icon"})," Description"]}),e.jsx("p",{className:"tm-notes-text",children:o.notes})]}),o.photos&&o.photos.length>0&&e.jsxs("div",{className:"tm-detail-section",children:[e.jsxs("h4",{children:[e.jsx(xt,{size:16,className:"inline-icon"})," Photos (",o.photos.length,")"]}),e.jsx("div",{className:"tm-photos-grid",children:o.photos.map((d,le)=>e.jsx("a",{href:d,target:"_blank",rel:"noopener noreferrer",className:"tm-photo-thumb",children:e.jsx("img",{src:d,alt:`Photo ${le+1}`,onError:ne=>{ne.target.onerror=null,ne.target.classList.add("photo-error"),ne.target.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=="}})},le))})]}),o.ce_pco_number&&o.change_order_value>0&&e.jsxs("div",{className:"tm-change-order-value",children:[e.jsx("span",{className:"tm-co-label",children:"Change Order Value:"}),e.jsxs("span",{className:"tm-co-amount",children:["$",o.change_order_value.toLocaleString()]})]}),D&&e.jsxs("div",{className:"tm-lock-notice",children:[e.jsx(gt,{size:14}),e.jsx("span",{children:g?.reason||"This ticket is locked (COR approved)"})]}),e.jsxs("div",{className:"tm-ticket-actions",role:"group","aria-label":"Ticket actions",children:[o.status==="pending"&&!D&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-success btn-small",onClick:d=>{d.stopPropagation(),ae(o)},"aria-label":"Approve this ticket",children:"Approve"}),e.jsx("button",{className:"btn btn-warning btn-small",onClick:d=>{d.stopPropagation(),I(o.id,"rejected")},"aria-label":"Reject this ticket",children:"Reject"})]}),o.status==="approved"&&!D&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-primary btn-small",onClick:d=>{d.stopPropagation(),I(o.id,"billed")},"aria-label":"Mark ticket as billed",children:"Mark Billed"}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:d=>{d.stopPropagation(),ce(o)},"aria-label":"Get signature link for this ticket",children:[e.jsx(ds,{size:14,"aria-hidden":"true"})," Signature Link"]})]}),o.status==="rejected"&&!D&&e.jsx("button",{className:"btn btn-secondary btn-small",onClick:d=>{d.stopPropagation(),I(o.id,"pending")},"aria-label":"Restore rejected ticket to pending",children:"Restore"}),!D&&e.jsxs("button",{className:`btn btn-small ${o.assigned_cor_id?"btn-ghost":"btn-secondary"}`,onClick:d=>{d.stopPropagation(),f(o)},"aria-label":o.assigned_cor_id?"Change COR link":"Link to Change Order",children:[e.jsx(ms,{size:14,"aria-hidden":"true"})," ",o.assigned_cor_id?"COR":"Link COR"]}),_&&!D&&e.jsxs("button",{className:"btn btn-warning btn-small",onClick:d=>re(o,d),disabled:x,"aria-label":"Retry syncing data to COR","aria-busy":x,children:[e.jsx(hs,{size:14,className:x?"spin":"","aria-hidden":"true"})," ",x?"Syncing...":"Retry Sync"]}),!D&&e.jsx("button",{className:"btn btn-danger btn-small",onClick:d=>{d.stopPropagation(),W(o.id)},"aria-label":"Delete this ticket",children:"Delete"})]})]})]})}),bt=()=>Ve(()=>import("./xlsx-BvJTHLik.js"),[]),Ss=()=>Promise.all([Ve(()=>import("./pdf-aQqpMATS.js").then(u=>u.j),[]),Ve(()=>import("./pdf-aQqpMATS.js").then(u=>u.c),[])]);function zs({project:u,company:o,onShowToast:l,compact:N=!1,previewMode:D=!1,onViewAll:g}){const{branding:_}=es(),[x,S]=h.useState([]),[L,ae]=h.useState(!0),[I,W]=h.useState(!1),[f,re]=h.useState("all"),[ce,K]=h.useState(null),[E,X]=h.useState(new Set),[de,U]=h.useState(0),[Y,d]=h.useState(!0),[le,ne]=h.useState(0),G=25,_e=500,[P,m]=h.useState("recent"),[b,y]=h.useState(()=>{const t=localStorage.getItem("fieldsync-tm-default-view");return t==="list"||t==="dashboard"?t:"dashboard"}),[M,O]=h.useState(new Set),[T,Z]=h.useState({start:"",end:""}),[Se,ke]=h.useState(!1),[me,ft]=h.useState(null),[Te,Ye]=h.useState(""),[Nt,Ge]=h.useState(!1),[he,Je]=h.useState(null),[yt,ue]=h.useState(!1),[q,Ke]=h.useState(null),[fe,Ct]=h.useState([]),[pe,Fe]=h.useState(""),[Xe,Ze]=h.useState(!1),[H,St]=h.useState({}),[kt,Qe]=h.useState({}),[Tt,et]=h.useState(null);h.useEffect(()=>{S([]),U(0),d(!0),oe(0,!0);const t=$.subscribeToTMTickets?.(u.id,()=>{oe(0,!0)});return()=>{t&&$.unsubscribe?.(t)}},[u.id]),h.useEffect(()=>{N||localStorage.setItem("fieldsync-tm-default-view",b)},[b,N]),h.useEffect(()=>{if(!N){const t=localStorage.getItem("fieldsync-tm-default-view");y(t==="list"||t==="dashboard"?t:"dashboard")}},[N]);const oe=async(t=0,a=!1)=>{try{a?ae(!0):W(!0);const i=await $.getTMTicketsPaginated(u.id,{page:t,limit:G,status:f!=="all"?f:null});S(a?i.tickets:F=>{const s=[...F,...i.tickets];return s.length>_e?s.slice(-_e):s}),U(t),d(i.hasMore),ne(i.totalCount);const j=i.tickets.filter(F=>F.assigned_cor_id);if(j.length>0){const F={},s={};await Promise.all(j.map(async v=>{const B=await $.isTicketEditable(v);B.editable||(F[v.id]=B);try{const r=await $.getTicketImportStatus(v.id,v.assigned_cor_id);r?.import_status==="failed"&&(s[v.id]=r)}catch{}})),St(v=>a?F:{...v,...F}),Qe(v=>a?s:{...v,...s})}}catch{l("Error loading T&M tickets","error")}finally{ae(!1),W(!1)}},Ft=()=>{!I&&Y&&oe(de+1,!1)};h.useEffect(()=>{u?.id&&(S([]),U(0),d(!0),oe(0,!0))},[f]);const we=h.useCallback(async(t,a)=>{if(H[t]){l(H[t].reason||"This ticket is locked (COR approved)","error");return}try{await $.updateTMTicketStatus(t,a),S(i=>i.map(j=>j.id===t?{...j,status:a}:j)),l(`Ticket ${a}`,"success")}catch(i){console.error("Error updating status:",i),l("Error updating status","error")}},[H]),wt=h.useCallback(t=>{if(H[t.id]){l(H[t.id].reason||"This ticket is locked (COR approved)","error");return}we(t.id,"approved")},[H,we]),Dt=async()=>{if(me)try{const t=parseFloat(Te)||0;await $.approveTMTicket(me.id,null,null,t),S(x.map(a=>a.id===me.id?{...a,status:"approved",change_order_value:t}:a)),l(`Ticket approved with $${t.toLocaleString()} change order`,"success"),ke(!1),ft(null),Ye("")}catch(t){console.error("Error approving ticket:",t),l("Error approving ticket","error")}},Mt=h.useCallback(async t=>{if(H[t]){l(H[t].reason||"This ticket is locked (COR approved)","error");return}if(confirm("Delete this T&M ticket?"))try{await $.deleteTMTicket(t),S(a=>a.filter(i=>i.id!==t)),l("Ticket deleted","success")}catch(a){console.error("Error deleting ticket:",a),l("Error deleting ticket","error")}},[H]),Rt=h.useCallback(async t=>{Ke(t),Fe(t.assigned_cor_id||""),ue(!0),Ze(!0);try{const a=await $.getAssignableCORs(u.id);Ct(a||[])}catch(a){console.error("Error loading CORs:",a),l("Error loading change orders","error")}finally{Ze(!1)}},[u.id]),Ot=async()=>{if(q)try{if(pe){await $.assignTicketToCOR(q.id,pe);const t=fe.find(a=>a.id===pe);l(`Ticket linked to ${t?.cor_number||"COR"}`,"success")}else q.assigned_cor_id&&(await $.unassignTicketFromCOR(q.id,q.assigned_cor_id),l("Ticket unlinked from COR","success"));oe(),ue(!1),Ke(null),Fe("")}catch(t){console.error("Error updating COR association:",t),l("Error updating COR link","error")}},Et=h.useCallback(async(t,a)=>{if(a?.stopPropagation(),!!t.assigned_cor_id){et(t.id);try{await $.importTicketDataToCOR(t.id,t.assigned_cor_id,o.id,u.work_type||"demolition",u.job_type||"standard"),l("COR data import successful!","success"),Qe(i=>{const j={...i};return delete j[t.id],j}),oe()}catch(i){console.error("Error retrying import:",i),l("Import retry failed. Please try again.","error")}finally{et(null)}}},[o.id,u.work_type,u.job_type]),ge=t=>{let a=0;return t.t_and_m_items&&t.t_and_m_items.forEach(i=>{i.materials_equipment?.cost_per_unit&&(a+=i.quantity*i.materials_equipment.cost_per_unit)}),a},xe=t=>t.t_and_m_workers?t.t_and_m_workers.reduce((a,i)=>{const j=parseFloat(i.hours)||0,F=parseFloat(i.overtime_hours)||0;return a+j+F},0):0,Ne=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),zt=h.useCallback((t,a)=>{a?.stopPropagation(),X(i=>{const j=new Set(i);return j.has(t)?j.delete(t):j.add(t),j})},[]),Pt=h.useCallback(t=>{K(a=>a===t?null:t)},[]),$t=h.useCallback(t=>{Je(t),Ge(!0)},[]),tt=()=>{const t=f==="all"?x:x.filter(i=>i.status===f),a=t.every(i=>E.has(i.id));X(a?new Set:new Set(t.map(i=>i.id)))},st=()=>{X(new Set)},at=()=>{const t=f==="all"?x:x.filter(a=>a.status===f);return E.size>0?t.filter(a=>E.has(a.id)):t},Ht=async()=>{const t=at();if(t.length===0){l("No tickets to export","error");return}l("Preparing Excel export...","info");const a=(await bt()).default||await bt(),i=[],j=[],F=[];t.forEach(r=>{const n=Ne(r.work_date),C=r.status;r.t_and_m_workers&&r.t_and_m_workers.forEach(R=>{const Q=parseFloat(R.hours)||0,ee=parseFloat(R.overtime_hours)||0;i.push({Date:n,Status:C,"Worker Name":R.name,Role:R.role||"Laborer","Regular Hours":Q,"OT Hours":ee,"Total Hours":Q+ee})}),r.t_and_m_items&&r.t_and_m_items.forEach(R=>{const Q=R.custom_name||R.materials_equipment?.name||"Unknown",ee=R.custom_category||R.materials_equipment?.category||"Unknown",Me=R.materials_equipment?.unit||"each",ye=R.materials_equipment?.cost_per_unit||0,Re=R.quantity*ye;j.push({Date:n,Status:C,Category:ee,Item:Q,Quantity:R.quantity,Unit:Me,"Cost/Unit":ye,Total:Re})}),F.push({Date:n,Status:C,Workers:r.t_and_m_workers?.length||0,"Total Hours":xe(r),Items:r.t_and_m_items?.length||0,"Materials Cost":ge(r),Notes:r.notes||""})});const s=a.utils.book_new(),v=a.utils.json_to_sheet(F);if(a.utils.book_append_sheet(s,v,"Summary"),i.length>0){const r=a.utils.json_to_sheet(i);a.utils.book_append_sheet(s,r,"Workers")}if(j.length>0){const r=a.utils.json_to_sheet(j);a.utils.book_append_sheet(s,r,"Materials & Equipment")}const B=`${u.name}_TM_${new Date().toISOString().split("T")[0]}.xlsx`;a.writeFile(s,B),l("Export downloaded!","success")},At=async()=>{const t=at();if(t.length===0){l("No tickets to export","error");return}l("Generating PDF...","info");const[a,i]=await Ss(),j=a.default,F=i.default,s=new j,v=s.internal.pageSize.getWidth(),B=s.internal.pageSize.getHeight(),r=20;let n=r;const C=ut(_?.primary_color||"#3B82F6"),R=ut(_?.secondary_color||"#1E40AF");s.setFillColor(...C),s.rect(0,0,v,45,"F"),s.setFillColor(...R),s.rect(0,42,v,3,"F");let Q=r;if(_?.logo_url)try{const c=await ts(_.logo_url);c&&(s.addImage(c,"PNG",r,7,30,30),Q=r+30+10)}catch(c){console.error("Error adding logo:",c)}s.setTextColor(255,255,255),s.setFontSize(22),s.setFont("helvetica","bold"),s.text(o?.name||"Company Name",Q,20),s.setFontSize(10),s.setFont("helvetica","normal"),s.text("TIME & MATERIALS REPORT",Q,30),s.setFontSize(9),s.text(`Report Date: ${new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}`,v-r,18,{align:"right"}),u.job_number&&s.text(`Job #: ${u.job_number}`,v-r,26,{align:"right"}),s.text(`Status: ${f.charAt(0).toUpperCase()+f.slice(1)}`,v-r,34,{align:"right"}),n=55,s.setFillColor(248,250,252),s.rect(r,n-5,v-r*2,30,"F"),s.setDrawColor(...C),s.setLineWidth(.5),s.rect(r,n-5,v-r*2,30,"S"),s.setTextColor(...C),s.setFontSize(14),s.setFont("helvetica","bold"),s.text(`Project: ${u.name}`,r+5,n+7),s.setFontSize(10),s.setFont("helvetica","normal"),s.setTextColor(51,65,85);const ee=t.map(c=>new Date(c.work_date)).sort((c,p)=>c-p),Me=ee[0]?.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),ye=ee[ee.length-1]?.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.text(`Date Range: ${Me} - ${ye}`,r+5,n+17),s.text(`Total Tickets: ${t.length}`,v-r-5,n+7,{align:"right"}),n+=40;const Re=t.reduce((c,p)=>c+xe(p),0),nt=t.reduce((c,p)=>c+ge(p),0),Bt=new Set(t.flatMap(c=>c.t_and_m_workers?.map(p=>p.name)||[])).size;s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("SUMMARY",r,n),n+=8;const je=(v-r*2-20)/3,Vt=[{label:"Total Labor Hours",value:Re.toFixed(1)},{label:"Unique Workers",value:Bt.toString()},{label:"Materials Cost",value:`$${nt.toFixed(2)}`}],Ut=C.map(c=>Math.min(255,c+180));Vt.forEach((c,p)=>{const k=r+p*(je+10);s.setFillColor(...Ut),s.rect(k,n,je,25,"F"),s.setDrawColor(...C),s.setLineWidth(.5),s.rect(k,n,je,25,"S"),s.setTextColor(...C),s.setFontSize(16),s.setFont("helvetica","bold"),s.text(c.value,k+je/2,n+12,{align:"center"}),s.setTextColor(100,116,139),s.setFontSize(8),s.setFont("helvetica","normal"),s.text(c.label,k+je/2,n+20,{align:"center"})}),n+=35;const Oe=[],Ee=[],ze=[];let Pe=0,$e=0,He=0,Ae=0,Le=0,Ie=0;t.forEach(c=>{c.t_and_m_workers&&c.t_and_m_workers.forEach(p=>{const k=parseFloat(p.hours)||0,w=parseFloat(p.overtime_hours)||0,se=p.role||"Laborer",J=[Ne(c.work_date),p.name,k.toString(),w>0?w.toString():"-",(k+w).toString()];se==="Foreman"||se==="Superintendent"?(Oe.push(J),Pe+=k,$e+=w):se==="Operator"?(Ee.push(J),He+=k,Ae+=w):(ze.push(J),Le+=k,Ie+=w)})});const We=(c,p,k,w)=>{p.length!==0&&(n>B-80&&(s.addPage(),n=r),s.setTextColor(...C),s.setFontSize(11),s.setFont("helvetica","bold"),s.text(c,r,n),n+=5,F(s,{startY:n,head:[["Date","Name","Reg Hrs","OT Hrs","Total"]],body:p,margin:{left:r,right:r},headStyles:{fillColor:C,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:9,textColor:[51,65,85]},alternateRowStyles:{fillColor:[248,250,252]},columnStyles:{0:{cellWidth:30},2:{halign:"center",cellWidth:22},3:{halign:"center",cellWidth:22},4:{halign:"center",cellWidth:22}},foot:[["","SUBTOTAL:",k.toString(),w>0?w.toString():"-",(k+w).toString()]],footStyles:{fillColor:R,textColor:[255,255,255],fontStyle:"bold",fontSize:9}}),n=s.lastAutoTable.finalY+10)};if(Oe.length>0||Ee.length>0||ze.length>0){s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("LABOR",r,n),n+=8,We("SUPERVISION",Oe,Pe,$e),We("OPERATORS",Ee,He,Ae),We("LABORERS",ze,Le,Ie);const c=Pe+He+Le,p=$e+Ae+Ie;s.setFillColor(...C),s.rect(r,n,v-r*2,12,"F"),s.setTextColor(255,255,255),s.setFontSize(10),s.setFont("helvetica","bold"),s.text("LABOR TOTAL:",r+5,n+8),s.text(`${c} Reg + ${p} OT = ${c+p} Hours`,v-r-5,n+8,{align:"right"}),n+=20}n>B-100&&(s.addPage(),n=r);const te={},Ce={},ot=["Containment","PPE","Disposal","Equipment","Other"];t.forEach(c=>{c.t_and_m_items&&c.t_and_m_items.forEach(p=>{const k=p.custom_name||p.materials_equipment?.name||"Unknown",w=p.custom_category||p.materials_equipment?.category||"Other",se=p.materials_equipment?.unit||"each",J=p.materials_equipment?.cost_per_unit||0,be=p.quantity*J;te[w]||(te[w]=[],Ce[w]=0),te[w].push([Ne(c.work_date),k,p.quantity.toString(),se,`$${J.toFixed(2)}`,`$${be.toFixed(2)}`]),Ce[w]+=be})});const it=(c,p,k)=>{!p||p.length===0||(n>B-80&&(s.addPage(),n=r),s.setTextColor(...C),s.setFontSize(11),s.setFont("helvetica","bold"),s.text(c.toUpperCase(),r,n),n+=5,F(s,{startY:n,head:[["Date","Item","Qty","Unit","Rate","Total"]],body:p,margin:{left:r,right:r},headStyles:{fillColor:C,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:9,textColor:[51,65,85]},alternateRowStyles:{fillColor:[248,250,252]},columnStyles:{2:{halign:"center",cellWidth:20},3:{halign:"center",cellWidth:25},4:{halign:"right",cellWidth:25},5:{halign:"right",cellWidth:30}},foot:[["","","","","Subtotal:",`$${k.toFixed(2)}`]],footStyles:{fillColor:R,textColor:[255,255,255],fontStyle:"bold",fontSize:9}}),n=s.lastAutoTable.finalY+10)};Object.keys(te).length>0&&(s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("MATERIALS & EQUIPMENT",r,n),n+=8,ot.forEach(c=>{te[c]&&it(c,te[c],Ce[c])}),Object.keys(te).forEach(c=>{ot.includes(c)||it(c,te[c],Ce[c])}),s.setFillColor(...C),s.rect(r,n,v-r*2,12,"F"),s.setTextColor(255,255,255),s.setFontSize(10),s.setFont("helvetica","bold"),s.text("MATERIALS TOTAL:",r+5,n+8),s.text(`$${nt.toFixed(2)}`,v-r-5,n+8,{align:"right"}),n+=20),n>B-80&&(s.addPage(),n=r),n+=10,s.setDrawColor(...C),s.setLineWidth(1),s.line(r,n,v-r,n),n+=15,s.setTextColor(...C),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("AUTHORIZATION",r,n),n+=10,s.setFontSize(10),s.setFont("helvetica","normal"),s.setTextColor(71,85,105),s.text("I hereby authorize the above time and materials charges as accurate and approved for billing.",r,n),n+=20;const V=t[0]||{},ct=(c,p,k,w,se,J,be)=>{s.setFont("helvetica","bold"),s.setFontSize(8),s.setTextColor(...C),s.text(p,r,c),s.setFont("helvetica","normal"),s.setFontSize(9),s.setTextColor(100,116,139);const z=c+18;if(s.setDrawColor(...R),s.setLineWidth(.5),s.line(r,z,r+70,z),s.text("Signature",r,z+8),s.line(r+85,z,r+145,z),s.text("Title / Company",r+85,z+8),s.line(v-r-40,z,v-r,z),s.text("Date",v-r-40,z+8),k)try{if(s.addImage(k,"PNG",r,z-16,60,16),w&&(s.setFontSize(8),s.text(w,r,z+15)),se||J){const ve=[se,J].filter(Boolean).join(" - ");s.text(ve,r+85,z-5)}if(be){const ve=new Date(be).toLocaleDateString();s.text(ve,v-r-40,z-5)}}catch(ve){console.error("Error adding signature to PDF:",ve)}return z+25};n=ct(n,"GC AUTHORIZATION",V.gc_signature_data,V.gc_signature_name,V.gc_signature_title,V.gc_signature_company,V.gc_signature_date),n+=8,n=ct(n,"CLIENT AUTHORIZATION",V.client_signature_data,V.client_signature_name,V.client_signature_title,V.client_signature_company,V.client_signature_date);const dt=s.internal.getNumberOfPages();for(let c=1;c<=dt;c++){s.setPage(c);const p=B-15;s.setFontSize(8),s.setTextColor(148,163,184),s.text(`${o?.name||"Company"} - T&M Report - ${u.name}`,r,p),s.text(`Page ${c} of ${dt}`,v-r,p,{align:"right"})}const Yt=`${u.name}_TM_Report_${new Date().toISOString().split("T")[0]}.pdf`;s.save(Yt),l("PDF exported!","success")},A=h.useMemo(()=>{let t=f==="all"?[...x]:x.filter(a=>a.status===f);if(T.start){const a=new Date(T.start);a.setHours(0,0,0,0),t=t.filter(i=>new Date(i.work_date)>=a)}if(T.end){const a=new Date(T.end);a.setHours(23,59,59,999),t=t.filter(i=>new Date(i.work_date)<=a)}if(D){const a=new Date,i=a.getMonth(),j=a.getFullYear();t=t.filter(F=>{const s=new Date(F.work_date);return s.getMonth()===i&&s.getFullYear()===j})}else if(P==="recent"){const a=new Date;a.setDate(a.getDate()-7),a.setHours(0,0,0,0),t=t.filter(i=>new Date(i.work_date)>=a)}return t},[x,f,P,T,D]),ie=h.useMemo(()=>{if(P!=="all")return null;const t={};return A.forEach(a=>{const i=new Date(a.work_date),j=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`,F=i.toLocaleDateString("en-US",{month:"long",year:"numeric"});t[j]||(t[j]={label:F,tickets:[],hours:0,cost:0}),t[j].tickets.push(a),t[j].hours+=xe(a),t[j].cost+=ge(a)}),Object.entries(t).sort((a,i)=>i[0].localeCompare(a[0]))},[A,P]);h.useEffect(()=>{if(ie&&ie.length>0){const t=ie[0][0];O(new Set([t]))}},[ie]);const Lt=t=>{const a=new Set(M);a.has(t)?a.delete(t):a.add(t),O(a)},It=A.reduce((t,a)=>t+xe(a),0),Wt=A.reduce((t,a)=>t+ge(a),0),rt=f==="all"?x.length:x.filter(t=>t.status===f).length;if(L)return e.jsx("div",{className:`tm-list ${N?"tm-list-compact":""}`,children:e.jsx("div",{className:"tm-loading-skeletons",children:[1,2,3].map(t=>e.jsx(Ns,{},t))})});const qt=A.length>0&&A.every(t=>E.has(t.id)),De=E.size>0,lt=t=>e.jsx(Cs,{ticket:t,isExpanded:ce===t.id,isSelected:E.has(t.id),isLocked:!!H[t.id],lockInfo:H[t.id],hasFailedImport:!!kt[t.id],isRetrying:Tt===t.id,onToggleExpand:Pt,onToggleSelect:zt,onApprove:wt,onUpdateStatus:we,onDelete:Mt,onOpenCorAssign:Rt,onRetryImport:Et,onShowSignatureLink:$t,formatDate:Ne,calculateTotalHours:xe,calculateTicketTotal:ge},t.id);return e.jsxs("div",{className:`tm-list ${N?"tm-list-compact":""}`,children:[e.jsx("div",{className:"tm-list-header",children:e.jsxs("div",{className:"tm-list-title",children:[e.jsx("h3",{children:"T&M Tickets"}),e.jsxs("div",{className:"tm-header-controls",children:[!N&&e.jsxs("div",{className:"tm-display-toggle",children:[e.jsxs("button",{className:`tm-display-btn ${b==="dashboard"?"active":""}`,onClick:()=>y("dashboard"),title:"Dashboard View",children:[e.jsx(us,{size:16})," Dashboard"]}),e.jsxs("button",{className:`tm-display-btn ${b==="list"?"active":""}`,onClick:()=>y("list"),title:"List View",children:[e.jsx(ps,{size:16})," List"]})]}),e.jsxs("div",{className:"tm-export-buttons",children:[!N&&De&&e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:st,children:["Clear (",E.size,")"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:Ht,disabled:x.length===0,children:[e.jsx(gs,{size:14})," Excel ",!N&&De?`(${E.size})`:""]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:At,disabled:x.length===0,children:[e.jsx(Ue,{size:14})," PDF ",!N&&De?`(${E.size})`:""]})]})]})]})}),!N&&e.jsxs("div",{className:"tm-list-filters",children:[e.jsx("div",{className:"tm-filter-tabs",children:["all","pending","approved","billed","rejected"].map(t=>e.jsxs("button",{className:`tm-filter-tab ${f===t?"active":""}`,onClick:()=>{re(t),st()},children:[t.charAt(0).toUpperCase()+t.slice(1),e.jsx("span",{className:"tm-filter-count",children:t==="all"?x.length:x.filter(a=>a.status===t).length})]},t))}),e.jsxs("div",{className:"view-mode-bar",children:[e.jsxs("div",{className:"view-mode-tabs",children:[e.jsx("button",{className:`view-mode-tab ${P==="recent"?"active":""}`,onClick:()=>{m("recent"),Z({start:"",end:""})},children:"Recent (7 days)"}),e.jsxs("button",{className:`view-mode-tab ${P==="all"?"active":""}`,onClick:()=>m("all"),children:["All (",rt,")"]})]}),P==="all"&&e.jsxs("div",{className:"date-filter",children:[e.jsx(xs,{size:16}),e.jsx("input",{type:"date",value:T.start,onChange:t=>Z(a=>({...a,start:t.target.value})),placeholder:"Start date"}),e.jsx("span",{children:"to"}),e.jsx("input",{type:"date",value:T.end,onChange:t=>Z(a=>({...a,end:t.target.value})),placeholder:"End date"}),(T.start||T.end)&&e.jsx("button",{className:"btn btn-ghost btn-small",onClick:()=>Z({start:"",end:""}),children:"Clear"})]})]})]}),!N&&b==="dashboard"&&e.jsx(ys,{tickets:x}),b==="list"&&e.jsxs(e.Fragment,{children:[!N&&A.length>0&&e.jsxs("div",{className:"tm-summary-bar",children:[e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Tickets"}),e.jsx("span",{className:"tm-summary-value",children:A.length})]}),e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Total Hours"}),e.jsx("span",{className:"tm-summary-value",children:It.toFixed(1)})]}),e.jsxs("div",{className:"tm-summary-stat",children:[e.jsx("span",{className:"tm-summary-label",children:"Materials Cost"}),e.jsxs("span",{className:"tm-summary-value",children:["$",Wt.toFixed(2)]})]})]}),A.length===0?e.jsxs("div",{className:"tm-empty-state",children:[e.jsxs("p",{children:["No ",f==="all"?"":f," T&M tickets",P==="recent"?" in the last 7 days":""]}),P==="recent"&&rt>0&&e.jsx("button",{className:"btn btn-secondary btn-small",onClick:()=>m("all"),children:"View All Tickets"})]}):e.jsxs("div",{className:"tm-tickets stagger-children",children:[e.jsx("div",{className:"tm-select-all-row",children:e.jsxs("label",{className:"tm-checkbox-label",onClick:tt,children:[e.jsx("input",{type:"checkbox",checked:qt,onChange:tt,className:"tm-checkbox"}),e.jsxs("span",{children:["Select All (",A.length,")"]})]})}),P==="all"&&ie?ie.map(([t,a])=>e.jsxs("div",{className:"month-group animate-fade-in",children:[e.jsxs("div",{className:"month-header",onClick:()=>Lt(t),children:[e.jsxs("div",{className:"month-header-left",children:[M.has(t)?e.jsx(js,{size:18}):e.jsx(jt,{size:18}),e.jsx("span",{className:"month-label",children:a.label}),e.jsx(_t,{count:a.tickets.length,label:"tickets",size:"small"})]}),e.jsxs("div",{className:"month-header-right",children:[e.jsxs("span",{className:"month-stat",children:[a.hours.toFixed(1)," hrs"]}),e.jsxs("span",{className:"month-stat",children:["$",a.cost.toFixed(2)]})]})]}),M.has(t)&&e.jsx("div",{className:"month-tickets stagger-children",children:a.tickets.map(i=>lt(i))})]},t)):A.map(t=>lt(t))]}),!D&&Y&&!L&&x.length>0&&e.jsx("div",{className:"tm-load-more",children:e.jsx("button",{className:"btn btn-secondary",onClick:Ft,disabled:I,children:I?"Loading...":`Load More (${x.length} of ${le})`})}),D&&x.length>0&&e.jsxs("button",{className:"tm-see-all-btn",onClick:g,children:["See all ",le||x.length," T&M tickets",e.jsx(jt,{size:16})]})]}),Se&&me&&e.jsx("div",{className:"modal-overlay",onClick:()=>ke(!1),children:e.jsxs("div",{className:"modal change-order-modal",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:"Approve Change Order Work"}),e.jsxs("p",{className:"modal-subtitle",children:["This T&M ticket is associated with ",e.jsx("strong",{children:me.ce_pco_number})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Change Order Value ($)"}),e.jsx("input",{type:"number",value:Te,onChange:t=>Ye(t.target.value),placeholder:"Enter the change order amount",autoFocus:!0}),e.jsx("p",{className:"form-help",children:"This amount will be added to the project's total contract value."})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>ke(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-success",onClick:Dt,children:["Approve with $",parseFloat(Te||0).toLocaleString()]})]})]})}),Nt&&he&&e.jsx(vs,{documentType:"tm_ticket",documentId:he.id,companyId:o?.id,projectId:u?.id,documentTitle:`T&M Ticket - ${new Date(he.work_date).toLocaleDateString()}${he.ce_pco_number?` (${he.ce_pco_number})`:""}`,onClose:()=>{Ge(!1),Je(null)},onShowToast:l}),yt&&q&&e.jsx("div",{className:"modal-overlay",onClick:()=>ue(!1),children:e.jsxs("div",{className:"modal cor-assign-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Link Ticket to Change Order"}),e.jsx("button",{className:"close-btn",onClick:()=>ue(!1),children:e.jsx(bs,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{className:"modal-subtitle",children:["Ticket: ",e.jsx("strong",{children:new Date(q.work_date).toLocaleDateString()}),q.ce_pco_number&&` (${q.ce_pco_number})`]}),Xe?e.jsx("div",{className:"loading",children:"Loading change orders..."}):fe.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No change orders found for this project."}),e.jsx("p",{className:"text-muted",children:"Create a COR first, then link tickets to it."})]}):e.jsxs("div",{className:"cor-select-wrapper",children:[e.jsx("label",{children:"Select Change Order:"}),e.jsxs("select",{value:pe,onChange:t=>Fe(t.target.value),className:"cor-select",children:[e.jsx("option",{value:"",children:"-- No COR (unlink) --"}),fe.map(t=>e.jsxs("option",{value:t.id,children:[t.cor_number," - ",t.title||"Untitled"," (",t.status,")"]},t.id))]})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>ue(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Ot,disabled:Xe||fe.length===0,children:q.assigned_cor_id&&!pe?"Unlink from COR":"Link to COR"})]})]})})]})}export{zs as default};
//# sourceMappingURL=TMList-DkacVIIX.js.map
