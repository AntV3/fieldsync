import{c as Ce,r as c,j as e,B as aa,d as E,H as ue,T as ws,i as ta,a as ra}from"./index-D19J-nbr.js";import{L as _e,R as ia,C as na,S as la,P as Je,a as oa,b as ca,M as Ns,c as da,I as ma,d as ua,e as ha,f as pa,g as fs}from"./InjuryReportForm-CwC2MDVm.js";import{R as ts,F as Pe,C as Ze,a as Ke,c as bs,b as xa,T as rs}from"./imageUtils-CuvFRWJw.js";import{X as ks,P as ja,C as ie,a as ys}from"./x-OJ_-mWYW.js";import{U as ga,a as va}from"./user-liTQESNF.js";import{W as Na,P as es}from"./wrench-B1QUlq5k.js";import{C as fa}from"./chevron-down-BXYV_1hh.js";import"./react-DXGY7bZi.js";import"./pdf-ChZ1zkDw.js";import"./supabase-VuevzHjS.js";const ba=[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]],ya=Ce("building",ba);const Ca=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ss=Ce("circle-check",Ca);const wa=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],ka=Ce("globe",wa);const Sa=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],Ea=Ce("history",Sa);const Ha=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],_a=Ce("upload",Ha);const La=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],is=Ce("zap",La);function Fa({ticketId:m,ticketSummary:y,lang:f="en",onSave:F,onClose:R,onShowToast:g}){const j=c.useRef(null),[H,_]=c.useState(""),[G,z]=c.useState(""),[k,q]=c.useState(""),[P,X]=c.useState(!1),[T,D]=c.useState(!1),[C,$]=c.useState(!1),Y={en:{title:"Client Signature",subtitle:"Sign to verify the work performed",signerName:"Your Name",signerNamePlaceholder:"Full name",signerTitle:"Title",signerTitlePlaceholder:"e.g. Project Manager",signerCompany:"Company",signerCompanyPlaceholder:"Company name",signBelow:"Sign below",signHere:"Sign here",clear:"Clear",cancel:"Cancel",saveSignature:"Submit Signature",saving:"Saving...",workDate:"Work Date",workers:"Workers",hours:"Total Hours",certification:"By signing, I acknowledge that the work described in this T&M ticket was performed as documented.",nameRequired:"Please enter your name",signatureRequired:"Please sign above",signatureSaved:"Signature saved successfully",signatureError:"Error saving signature"},es:{title:"Firma del Cliente",subtitle:"Firme para verificar el trabajo realizado",signerName:"Su Nombre",signerNamePlaceholder:"Nombre completo",signerTitle:"Titulo",signerTitlePlaceholder:"ej. Gerente de Proyecto",signerCompany:"Empresa",signerCompanyPlaceholder:"Nombre de la empresa",signBelow:"Firme abajo",signHere:"Firme aqui",clear:"Borrar",cancel:"Cancelar",saveSignature:"Enviar Firma",saving:"Guardando...",workDate:"Fecha",workers:"Trabajadores",hours:"Horas Total",certification:"Al firmar, reconozco que el trabajo descrito en este ticket T&M fue realizado como se documenta.",nameRequired:"Por favor ingrese su nombre",signatureRequired:"Por favor firme arriba",signatureSaved:"Firma guardada exitosamente",signatureError:"Error al guardar la firma"}},S=Y[f]||Y.en,Z=()=>{const l=j.current;return l?l.getContext("2d"):null},I=l=>{const u=j.current;if(!u)return{x:0,y:0};const b=u.getBoundingClientRect(),v=u.width/b.width,W=u.height/b.height,O=l.touches?l.touches[0].clientX:l.clientX,ae=l.touches?l.touches[0].clientY:l.clientY;return{x:(O-b.left)*v,y:(ae-b.top)*W}},ne=l=>{l.preventDefault();const u=Z();if(!u)return;const{x:b,y:v}=I(l);u.beginPath(),u.moveTo(b,v),D(!0),X(!0)},Q=l=>{if(!T)return;l.preventDefault();const u=Z();if(!u)return;const{x:b,y:v}=I(l);u.lineTo(b,v),u.stroke()},K=()=>{D(!1)},re=()=>{const l=j.current,u=Z();!l||!u||(u.clearRect(0,0,l.width,l.height),X(!1))},B=l=>{if(!l)return;j.current=l;const u=l.getContext("2d");u.strokeStyle="#1e293b",u.lineWidth=2,u.lineCap="round",u.lineJoin="round"},n=async()=>{if(!H.trim()){g?.(S.nameRequired,"error");return}if(!P){g?.(S.signatureRequired,"error");return}const l=j.current;if(l){$(!0);try{const u=l.toDataURL("image/png");await E.saveTMClientSignature(m,{signature:u,signerName:H.trim(),signerTitle:G.trim()||null,signerCompany:k.trim()||null,signedAt:new Date().toISOString()}),g?.(S.signatureSaved,"success"),F?.({signerName:H.trim(),signerTitle:G.trim(),signerCompany:k.trim()})}catch(u){console.error("Error saving signature:",u),g?.(S.signatureError,"error")}finally{$(!1)}}};return e.jsx("div",{className:"tm-modal-overlay",onClick:R,children:e.jsxs("div",{className:"tm-client-signature-modal",onClick:l=>l.stopPropagation(),children:[e.jsxs("div",{className:"tm-sig-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:S.title}),e.jsx("p",{className:"tm-sig-subtitle",children:S.subtitle})]}),e.jsx("button",{className:"tm-sig-close",onClick:R,children:e.jsx(ks,{size:20})})]}),e.jsxs("div",{className:"tm-sig-body",children:[y&&e.jsxs("div",{className:"tm-sig-summary",children:[e.jsxs("div",{className:"tm-sig-summary-item",children:[e.jsx("span",{className:"tm-sig-summary-label",children:S.workDate}),e.jsx("span",{className:"tm-sig-summary-value",children:new Date(y.workDate).toLocaleDateString()})]}),e.jsxs("div",{className:"tm-sig-summary-item",children:[e.jsx("span",{className:"tm-sig-summary-label",children:S.workers}),e.jsx("span",{className:"tm-sig-summary-value",children:y.workerCount})]}),e.jsxs("div",{className:"tm-sig-summary-item",children:[e.jsx("span",{className:"tm-sig-summary-label",children:S.hours}),e.jsx("span",{className:"tm-sig-summary-value",children:y.totalHours})]})]}),e.jsxs("div",{className:"tm-sig-fields",children:[e.jsxs("div",{className:"tm-sig-field",children:[e.jsxs("label",{children:[e.jsx(ga,{size:14}),S.signerName," *"]}),e.jsx("input",{type:"text",value:H,onChange:l=>_(l.target.value),placeholder:S.signerNamePlaceholder})]}),e.jsxs("div",{className:"tm-sig-field-row",children:[e.jsxs("div",{className:"tm-sig-field",children:[e.jsxs("label",{children:[e.jsx(aa,{size:14}),S.signerTitle]}),e.jsx("input",{type:"text",value:G,onChange:l=>z(l.target.value),placeholder:S.signerTitlePlaceholder})]}),e.jsxs("div",{className:"tm-sig-field",children:[e.jsxs("label",{children:[e.jsx(ya,{size:14}),S.signerCompany]}),e.jsx("input",{type:"text",value:k,onChange:l=>q(l.target.value),placeholder:S.signerCompanyPlaceholder})]})]})]}),e.jsxs("div",{className:"tm-sig-area",children:[e.jsxs("div",{className:"tm-sig-label",children:[e.jsx(ja,{size:14}),e.jsx("span",{children:S.signBelow})]}),e.jsxs("div",{className:"tm-sig-canvas-container",children:[e.jsx("canvas",{ref:B,width:500,height:180,className:"tm-sig-canvas",onMouseDown:ne,onMouseMove:Q,onMouseUp:K,onMouseLeave:K,onTouchStart:ne,onTouchMove:Q,onTouchEnd:K}),!P&&e.jsx("div",{className:"tm-sig-placeholder",children:S.signHere})]}),e.jsxs("button",{className:"tm-sig-clear",onClick:re,disabled:!P,children:[e.jsx(ts,{size:14})," ",S.clear]})]}),e.jsx("p",{className:"tm-sig-certification",children:S.certification})]}),e.jsxs("div",{className:"tm-sig-footer",children:[e.jsx("button",{className:"tm-sig-btn secondary",onClick:R,disabled:C,children:S.cancel}),e.jsx("button",{className:"tm-sig-btn primary",onClick:n,disabled:!P||!H.trim()||C,children:C?S.saving:e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:16})," ",S.saveSignature]})})]})]})})}const Cs=()=>{const m=new Uint8Array(6);return crypto.getRandomValues(m),Array.from(m,y=>y.toString(36)).join("")},as=["Containment","PPE","Disposal","Equipment"],Da={en:{workInfo:"Work Info",crewHours:"Crew & Hours",materialsEquipment:"Materials",review:"Review",quickActions:"Quick Actions",sameAsYesterday:"Same as Yesterday",setCrewHours:"Set Crew Hours",loading:"Loading...",supervision:"Supervision",operators:"Operators",laborers:"Laborers",addSupervision:"+ Add Supervision",addOperator:"+ Add Operator",addLaborer:"+ Add Laborer",foreman:"Foreman",superintendent:"Superintendent",firstLastName:"First & Last Name",start:"Start",end:"End",regHrs:"Reg Hrs",otHrs:"OT Hrs",selectCategory:"Select a category:",addCustomItem:"+ Add Custom Item",customItem:"Custom Item",itemName:"Item Name",category:"Category",quantity:"Quantity",addItem:"Add Item",cancel:"Cancel",noItemsCategory:"No items in this category yet",workDate:"Work Date",ceNumber:"CE/PCO #",optional:"optional",linkedCOR:"Link to Change Order",selectCOR:"Select COR (optional)",noCORs:"No pending CORs",laborSummary:"Labor Summary",worker:"worker",workers_plural:"workers",totalHours:"Total Hours",regular:"Regular",overtime:"Overtime",materials:"Materials",item:"item",items_plural:"items",noMaterials:"No materials added",notes:"Notes",addNotes:"Add notes about the work performed...",photos:"Photos",addPhotos:"Add Photos",maxPhotos:"max",noPhotos:"No photos added",certification:"Certification",certifyStatement:"I certify that this T&M ticket accurately reflects the work performed.",foremanSignature:"Foreman's Name (Signature)",yourName:"Your name",describeWork:"Describe the work performed",descriptionRequired:"Description is required",whatWorkPerformed:"What work was performed today?",searchMaterials:"Search materials & equipment...",noSearchResults:"No items found",orBrowse:"Or browse by category:",back:"Back",next:"Next",nextCrew:"Next: Crew",nextMaterials:"Next: Materials",reviewItems:"Review",skipNoMaterials:"Skip (no materials)",submitTM:"Submit T&M",submitting:"Submitting...",applySameHours:"Apply Same Hours",batchDescription:"Set start/end time and hours for all workers with names entered.",timeStarted:"Time Started",timeEnded:"Time Ended",regularHours:"Regular Hours",overtimeHours:"Overtime Hours",willApplyTo:"Will apply to",applyToAll:"Apply to All",preset8hr:"8hr Day",preset10hr:"10hr Day",preset4hr:"4hr Day",loadedWorkers:"Loaded {count} workers from {date}",noPreviousCrew:"No previous crew found for this project",appliedHours:"Applied hours to {count} worker(s)",assignedToCOR:"Assigned to COR"},es:{workInfo:"Info del Trabajo",crewHours:"Cuadrilla y Horas",materialsEquipment:"Materiales",review:"Revisar",quickActions:"Acciones Rapidas",sameAsYesterday:"Igual que Ayer",setCrewHours:"Poner Horas",loading:"Cargando...",supervision:"Supervision",operators:"Operadores",laborers:"Trabajadores",addSupervision:"+ Agregar Supervision",addOperator:"+ Agregar Operador",addLaborer:"+ Agregar Trabajador",foreman:"Capataz",superintendent:"Superintendente",firstLastName:"Nombre y Apellido",start:"Inicio",end:"Fin",regHrs:"Hrs Reg",otHrs:"Hrs Extra",selectCategory:"Seleccione una categoria:",addCustomItem:"+ Agregar Articulo",customItem:"Articulo Personalizado",itemName:"Nombre del Articulo",category:"Categoria",quantity:"Cantidad",addItem:"Agregar",cancel:"Cancelar",noItemsCategory:"No hay articulos en esta categoria",workDate:"Fecha de Trabajo",ceNumber:"CE/PCO #",optional:"opcional",linkedCOR:"Vincular a Orden de Cambio",selectCOR:"Seleccionar COR (opcional)",noCORs:"No hay CORs pendientes",laborSummary:"Resumen de Mano de Obra",worker:"trabajador",workers_plural:"trabajadores",totalHours:"Horas Totales",regular:"Regular",overtime:"Extra",materials:"Materiales",item:"articulo",items_plural:"articulos",noMaterials:"No se agregaron materiales",notes:"Notas",addNotes:"Agregar notas sobre el trabajo realizado...",photos:"Fotos",addPhotos:"Agregar Fotos",maxPhotos:"max",noPhotos:"No se agregaron fotos",certification:"Certificacion",certifyStatement:"Certifico que este ticket T&M refleja con precision el trabajo realizado.",foremanSignature:"Nombre del Capataz (Firma)",yourName:"Su nombre",describeWork:"Describir el trabajo realizado",descriptionRequired:"Descripcion es requerida",whatWorkPerformed:"Que trabajo se realizo hoy?",searchMaterials:"Buscar materiales y equipo...",noSearchResults:"No se encontraron articulos",orBrowse:"O navegar por categoria:",back:"Atras",next:"Siguiente",nextCrew:"Siguiente: Cuadrilla",nextMaterials:"Siguiente: Materiales",reviewItems:"Revisar",skipNoMaterials:"Saltar (sin materiales)",submitTM:"Enviar T&M",submitting:"Enviando...",applySameHours:"Aplicar Mismas Horas",batchDescription:"Establezca hora de inicio/fin y horas para todos los trabajadores.",timeStarted:"Hora de Inicio",timeEnded:"Hora de Fin",regularHours:"Horas Regulares",overtimeHours:"Horas Extra",willApplyTo:"Se aplicara a",applyToAll:"Aplicar a Todos",preset8hr:"Dia 8hr",preset10hr:"Dia 10hr",preset4hr:"Dia 4hr",loadedWorkers:"Se cargaron {count} trabajadores del {date}",noPreviousCrew:"No se encontro equipo anterior para este proyecto",appliedHours:"Horas aplicadas a {count} trabajador(es)",assignedToCOR:"Asignado a COR"}};function za({project:m,companyId:y,maxPhotos:f=10,onSubmit:F,onCancel:R,onShowToast:g}){const[j,H]=c.useState(1),[_,G]=c.useState(new Date().toISOString().split("T")[0]),[z,k]=c.useState(null),[q,P]=c.useState(!1),[X,T]=c.useState(!1),[D,C]=c.useState(!1),[$,Y]=c.useState(""),[S,Z]=c.useState(""),[I,ne]=c.useState(""),[Q,K]=c.useState([]),[re,B]=c.useState(!1),[n,l]=c.useState(!1),[u,b]=c.useState({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),[v,W]=c.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}]),[O,ae]=c.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[h,M]=c.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[x,ee]=c.useState([]),[te,we]=c.useState(""),[A,Te]=c.useState([]),[$e,ns]=c.useState(!1),[Ss,oe]=c.useState(""),[qe,Es]=c.useState([]),[Ie,Hs]=c.useState(!1),[he,Le]=c.useState(null),[_s,Ls]=c.useState([]),[Fs,ls]=c.useState(!1),[Fe,We]=c.useState(""),[Ue,De]=c.useState([]),[os,Ds]=c.useState([]),[ke,ze]=c.useState(!1),[V,Ae]=c.useState({name:"",category:"",quantity:""}),[cs,ds]=c.useState(!1),[w,zs]=c.useState("en"),d=s=>Da[w][s]||s,[As,Rs]=c.useState([]),[Re,Ms]=c.useState([]),[ce,xe]=c.useState({}),[Be,ms]=c.useState(!0),se=Re.length>0,je=(s,a)=>{if(!s||!a)return null;const[t,r]=s.split(":").map(Number),[i,o]=a.split(":").map(Number);let p=i*60+o-(t*60+r);p<0&&(p+=1440);const N=p/60,U=Math.min(N,8),L=Math.max(0,N-8);return{hours:U.toFixed(1),overtimeHours:L>0?L.toFixed(1):""}},Se=s=>{const a=s.name.trim()!=="",t=parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0;return a?t?"complete":"incomplete":"empty"},Ge=s=>{let a,t,r,i;switch(s){case"full":a="07:00",t="15:30",r="8",i="";break;case"10hr":a="06:00",t="16:30",r="8",i="2";break;case"half":a="07:00",t="11:00",r="4",i="";break;default:return}b({timeStarted:a,timeEnded:t,hours:r,overtimeHours:i})};c.useEffect(()=>{Ps(),us()},[m.id]),c.useEffect(()=>{(async()=>{if(!y){ms(!1);return}try{const a=await E.getLaborClassesForField(y);if(Rs(a.categories||[]),Ms(a.classes||[]),a.classes&&a.classes.length>0){const t={};a.classes.forEach(r=>{t[r.id]=[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}),xe(t)}}catch(a){console.error("Error loading labor classes:",a)}finally{ms(!1)}})()},[y]);const us=async()=>{B(!0);try{const s=await E.getAssignableCORs(m.id);K(s||[])}catch(s){console.error("Error loading assignable CORs:",s)}finally{B(!1)}},Os=()=>{const{timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}=u;W(v.map(o=>o.name.trim()?{...o,timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}:o)),ae(O.map(o=>o.name.trim()?{...o,timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}:o)),M(h.map(o=>o.name.trim()?{...o,timeStarted:s,timeEnded:a,hours:t,overtimeHours:r}:o));const i=[...v.filter(o=>o.name.trim()),...O.filter(o=>o.name.trim()),...h.filter(o=>o.name.trim())].length;l(!1),b({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),g(`Applied hours to ${i} worker${i!==1?"s":""}`,"success")},Ye=s=>{let a,t,r,i;switch(s){case"8hr":a="07:00",t="15:30",r="8",i="";break;case"10hr":a="06:00",t="16:30",r="8",i="2";break;case"4hr":a="07:00",t="11:00",r="4",i="";break;default:return}W(p=>p.map(N=>N.name.trim()?{...N,timeStarted:a,timeEnded:t,hours:r,overtimeHours:i}:N)),ae(p=>p.map(N=>N.name.trim()?{...N,timeStarted:a,timeEnded:t,hours:r,overtimeHours:i}:N)),M(p=>p.map(N=>N.name.trim()?{...N,timeStarted:a,timeEnded:t,hours:r,overtimeHours:i}:N));const o=[...v.filter(p=>p.name.trim()),...O.filter(p=>p.name.trim()),...h.filter(p=>p.name.trim())].length;o>0?g(d("appliedHours").replace("{count}",o),"success"):g(w==="en"?"Add workers first":"Agregue trabajadores primero","info")},Ps=async()=>{try{const s=await E.getCrewCheckin(m.id);s?.workers&&Es(s.workers)}catch(s){console.error("Error loading crew:",s)}};c.useEffect(()=>{he&&y&&Ts(he)},[he,y]);const Ts=async s=>{ls(!0);try{const a=await E.getMaterialsEquipmentByCategory(y,s);Ls(a)}catch(a){console.error("Error loading items:",a),g("Error loading items","error")}finally{ls(!1)}},$s=async()=>{if(!(os.length>0))try{const s=[];for(const a of as){const t=await E.getMaterialsEquipmentByCategory(y,a);s.push(...t.map(r=>({...r,category:a})))}Ds(s)}catch(s){console.error("Error loading all materials:",s)}},qs=s=>{if(We(s),!s.trim()){De([]);return}const a=s.toLowerCase(),t=os.filter(r=>r.name.toLowerCase().includes(a)||r.category.toLowerCase().includes(a));De(t.slice(0,10))},Is=async()=>{ds(!0);try{const s=await E.getPreviousTicketCrew(m.id,_);if(!s||s.totalWorkers===0){g("No previous crew found for this project","info");return}s.supervision&&W(s.supervision),s.operators&&ae(s.operators),s.laborers&&M(s.laborers);const a=new Date(s.workDate).toLocaleDateString();g(`Loaded ${s.totalWorkers} workers from ${a}`,"success")}catch(s){console.error("Error loading previous crew:",s),g("Error loading previous crew","error")}finally{ds(!1)}},Ws=()=>{W([...v,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},de=(s,a,t)=>{W(v.map((r,i)=>{if(i!==s)return r;const o={...r,[a]:t};if(a==="timeStarted"||a==="timeEnded"){const p=a==="timeStarted"?t:r.timeStarted,N=a==="timeEnded"?t:r.timeEnded,U=je(p,N);U&&(o.hours=U.hours,o.overtimeHours=U.overtimeHours)}return o}))},Us=s=>{v.length>1?W(v.filter((a,t)=>t!==s)):W([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},Bs=()=>{M([...h,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},ge=(s,a,t)=>{M(h.map((r,i)=>{if(i!==s)return r;const o={...r,[a]:t};if(a==="timeStarted"||a==="timeEnded"){const p=a==="timeStarted"?t:r.timeStarted,N=a==="timeEnded"?t:r.timeEnded,U=je(p,N);U&&(o.hours=U.hours,o.overtimeHours=U.overtimeHours)}return o}))},Gs=s=>{h.length>1?M(h.filter((a,t)=>t!==s)):M([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Ys=()=>{ae([...O,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},ve=(s,a,t)=>{ae(O.map((r,i)=>{if(i!==s)return r;const o={...r,[a]:t};if(a==="timeStarted"||a==="timeEnded"){const p=a==="timeStarted"?t:r.timeStarted,N=a==="timeEnded"?t:r.timeEnded,U=je(p,N);U&&(o.hours=U.hours,o.overtimeHours=U.overtimeHours)}return o}))},Qs=s=>{O.length>1?ae(O.filter((a,t)=>t!==s)):ae([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},hs=s=>{xe(a=>({...a,[s]:[...a[s]||[],{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))},le=(s,a,t,r)=>{xe(i=>({...i,[s]:(i[s]||[]).map((o,p)=>{if(p!==a)return o;const N={...o,[t]:r};if(t==="timeStarted"||t==="timeEnded"){const U=t==="timeStarted"?r:o.timeStarted,L=t==="timeEnded"?r:o.timeEnded,J=je(U,L);J&&(N.hours=J.hours,N.overtimeHours=J.overtimeHours)}return N})}))},ps=(s,a)=>{xe(t=>{const r=t[s]||[];return r.length>1?{...t,[s]:r.filter((i,o)=>o!==a)}:{...t,[s]:[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}})},Qe=()=>{const s=[];return Object.entries(ce).forEach(([a,t])=>{const r=Re.find(i=>i.id===a);t.forEach(i=>{i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)&&s.push({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:r?.name||"Worker",labor_class_id:a})})}),s},Xs=s=>{const a=x.findIndex(t=>t.material_equipment_id===s.id);a>=0?ee(x.map((t,r)=>r===a?{...t,quantity:t.quantity+1}:t)):ee([...x,{material_equipment_id:s.id,name:s.name,unit:s.unit,category:s.category,quantity:1,isCustom:!1}]),g(`Added ${s.name}`,"success")},Vs=()=>{if(!V.name||!V.category||!V.quantity){g("Fill in all fields","error");return}ee([...x,{material_equipment_id:null,custom_name:V.name,custom_category:V.category,name:V.name,category:V.category,quantity:parseFloat(V.quantity),unit:"each",isCustom:!0}]),Ae({name:"",category:"",quantity:""}),ze(!1),Le(null),g("Custom item added","success")},Xe=(s,a)=>{const t=parseFloat(a)||0;t<=0?Js(s):ee(x.map((r,i)=>i===s?{...r,quantity:t}:r))},Js=s=>{ee(x.filter((a,t)=>t!==s))},Zs=s=>{const a=Array.from(s.target.files);if(a.length===0)return;const t=f===-1?1/0:f-A.length;if(t<=0){g(`Photo limit reached (${f} max)`,"error"),s.target.value="";return}const r=a.slice(0,t);r.length<a.length&&g(`Only ${r.length} photo(s) added (${f} max)`,"error");const i=10*1024*1024;r.forEach(o=>{if(!o.type.startsWith("image/")){g("Please select an image file","error");return}if(o.size>i){g(`Photo too large: ${o.name} (max 10MB)`,"error");return}const p=URL.createObjectURL(o),N=`photo-${Date.now()}-${Cs()}`;Te(U=>[...U,{id:`${Date.now()}-${Cs()}`,tempId:N,file:o,previewUrl:p,name:o.name,status:"pending",attempts:0,error:null,uploadedUrl:null}])}),s.target.value=""},me=(s,a)=>{Te(t=>t.map(r=>r.id===s?{...r,...a}:r))},xs=async(s,a)=>{const t=A.find(r=>r.id===s);if(!(!t||t.status!=="failed")){me(s,{status:"compressing",error:null});try{let r=t.file;try{r=await bs(t.file)}catch(o){console.warn("Compression failed, using original:",o)}me(s,{status:"uploading"});const i=await E.uploadPhoto(y,m.id,a,r);me(s,{status:"confirmed",uploadedUrl:i,attempts:t.attempts+1}),await E.updateTMTicketPhotos(a,[...A.filter(o=>o.uploadedUrl).map(o=>o.uploadedUrl),i]),g("Photo uploaded successfully","success")}catch(r){console.error("Retry failed:",r),me(s,{status:"failed",error:r.message||"Upload failed",attempts:t.attempts+1}),g("Photo retry failed","error")}}},Ks=s=>{const a=A.find(t=>t.id===s);a?.previewUrl&&URL.revokeObjectURL(a.previewUrl),Te(A.filter(t=>t.id!==s))},js=()=>{if(j===1)return te.trim().length>0;if(j===2){if(se)return Qe().length>0;{const s=v.some(r=>r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)),a=O.some(r=>r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)),t=h.some(r=>r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0));return s||a||t}}return!0},Me=()=>{j<4&&H(j+1)},gs=()=>{he?(Le(null),ze(!1)):ke?ze(!1):j>1?H(j-1):R()},ea=async()=>{if(!S.trim()){g("Enter your name to submit","error");return}let s=[];if(se){if(s=Qe(),s.length===0){g("Add at least one worker","error");return}}else{const a=v.filter(i=>i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)),t=O.filter(i=>i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)),r=h.filter(i=>i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0));if(a.length===0&&t.length===0&&r.length===0){g("Add at least one worker","error");return}s=[...a.map(i=>({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:i.role})),...t.map(i=>({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:"Operator"})),...r.map(i=>({name:i.name.trim(),hours:parseFloat(i.hours)||0,overtime_hours:parseFloat(i.overtimeHours)||0,time_started:i.timeStarted||null,time_ended:i.timeEnded||null,role:"Laborer"}))]}ns(!0),oe("Creating ticket...");try{const a=await E.createTMTicket({project_id:m.id,work_date:_,ce_pco_number:$.trim()||null,assigned_cor_id:I||null,notes:te.trim()||null,photos:[],created_by_name:S.trim()});let t=[];const r=A.filter(i=>i.status==="pending");if(r.length>0){oe(`Compressing ${r.length} photo${r.length>1?"s":""}...`),r.forEach(L=>me(L.id,{status:"compressing"}));const i=await Promise.all(r.map(async L=>{try{const J=await bs(L.file);return{...L,file:J}}catch(J){return console.warn(`Failed to compress photo ${L.name}, using original:`,J),L}}));oe(`Uploading ${r.length} photo${r.length>1?"s":""}...`),r.forEach(L=>me(L.id,{status:"uploading"}));let o=0,p=0;const N=i.map(async L=>{try{const J=await E.uploadPhoto(y,m.id,a.id,L.file);return o++,oe(`Uploading ${o}/${r.length} photos...`),me(L.id,{status:"confirmed",uploadedUrl:J,attempts:(L.attempts||0)+1}),{id:L.id,url:J}}catch(J){return console.error(`Photo ${L.name} upload failed:`,J),p++,me(L.id,{status:"failed",error:J.message||"Upload failed",attempts:(L.attempts||0)+1}),{id:L.id,url:null,error:J.message}}});t=(await Promise.all(N)).filter(L=>L.url!==null).map(L=>L.url),p>0&&t.length>0?g(`${t.length}/${r.length} photos uploaded. ${p} failed - can retry later.`,"warning"):p>0&&t.length===0&&g(`All ${p} photos failed to upload - can retry after submission.`,"error")}if(t.length>0&&(oe("Saving photos..."),await E.updateTMTicketPhotos(a.id,t)),oe("Saving workers..."),await E.addTMWorkers(a.id,s),x.length>0&&(oe("Saving materials..."),await E.addTMItems(a.id,x.map(i=>({material_equipment_id:i.material_equipment_id,custom_name:i.custom_name||null,custom_category:i.custom_category||null,quantity:i.quantity})))),I){oe("Importing to COR...");try{await E.importTicketDataToCOR(a.id,I,y,m.work_type||"demolition",m.job_type||"standard")}catch(i){console.error("Error importing to COR:",i);try{await E.markImportFailed(a.id,I,i?.message||"Import failed")}catch(o){console.error("Error marking import failed:",o)}g("T&M saved. COR data sync failed - retry from ticket list.","warning")}}A.forEach(i=>{i.previewUrl&&URL.revokeObjectURL(i.previewUrl)}),k(a),g("T&M submitted!","success"),H(5)}catch(a){console.error("Error submitting T&M:",a),g("Error submitting T&M","error")}finally{ns(!1),oe("")}},Ne=v.filter(s=>s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),fe=O.filter(s=>s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),be=h.filter(s=>s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),Ee=Qe(),ye=se?Ee.length:Ne.length+fe.length+be.length,He=se?Ee.reduce((s,a)=>s+(a.hours||0),0):[...Ne,...fe,...be].reduce((s,a)=>s+parseFloat(a.hours||0),0),pe=se?Ee.reduce((s,a)=>s+(a.overtime_hours||0),0):[...Ne,...fe,...be].reduce((s,a)=>s+parseFloat(a.overtimeHours||0),0);x.reduce((s,a)=>s+a.quantity,0);const Ve=se?Object.values(ce).flat().filter(s=>s.name.trim()):[...v.filter(s=>s.name.trim()),...O.filter(s=>s.name.trim()),...h.filter(s=>s.name.trim())],sa=ye,vs=Ve.length-sa;return j===3&&(he||ke)?e.jsxs("div",{className:"tm-wizard",children:[e.jsxs("div",{className:"tm-wizard-header",children:[e.jsx("button",{className:"tm-back-btn",onClick:gs,children:"‚Üê"}),e.jsx("h2",{children:ke?"Add Custom Item":he}),e.jsxs("div",{className:"tm-item-count",children:[x.length," items"]})]}),ke?e.jsxs("div",{className:"tm-custom-form",children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Item Name"}),e.jsx("input",{type:"text",placeholder:"What did you use?",value:V.name,onChange:s=>Ae({...V,name:s.target.value}),autoFocus:!0})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Category"}),e.jsx("div",{className:"tm-category-select",children:as.map(s=>e.jsx("button",{className:`tm-cat-chip ${V.category===s?"active":""}`,onClick:()=>Ae({...V,category:s}),children:s},s))})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Quantity"}),e.jsx("input",{type:"number",placeholder:"How many?",value:V.quantity,onChange:s=>Ae({...V,quantity:s.target.value})})]}),e.jsx("button",{className:"tm-big-btn primary",onClick:Vs,children:"Add Custom Item"})]}):e.jsx("div",{className:"tm-item-grid",children:Fs?e.jsx("div",{className:"tm-loading",children:"Loading..."}):e.jsxs(e.Fragment,{children:[_s.map(s=>{const a=x.find(t=>t.material_equipment_id===s.id);return e.jsxs("button",{className:`tm-item-card ${a?"added":""}`,onClick:()=>Xs(s),children:[e.jsx("span",{className:"tm-item-name",children:s.name}),e.jsx("span",{className:"tm-item-unit",children:s.unit}),a&&e.jsx("span",{className:"tm-item-badge",children:a.quantity})]},s.id)}),e.jsxs("button",{className:"tm-item-card custom",onClick:()=>ze(!0),children:[e.jsx("span",{className:"tm-item-name",children:"+ Add Other"}),e.jsx("span",{className:"tm-item-unit",children:"Not on list"})]})]})}),!ke&&x.length>0&&e.jsx("div",{className:"tm-wizard-footer",children:e.jsxs("button",{className:"tm-big-btn primary",onClick:()=>Le(null),children:["Done Adding (",x.length," items)"]})})]}):e.jsxs("div",{className:"tm-wizard",children:[e.jsxs("div",{className:"tm-wizard-header",children:[j<5?e.jsx("button",{className:"tm-back-btn",onClick:gs,children:"‚Üê"}):e.jsx("div",{className:"tm-success-check",children:e.jsx(ss,{size:24})}),e.jsxs("h2",{children:[j===1&&d("workInfo"),j===2&&d("crewHours"),j===3&&d("materialsEquipment"),j===4&&d("review"),j===5&&(w==="en"?"Submitted":"Enviado")]}),e.jsxs("div",{className:"tm-header-right",children:[j<5&&e.jsxs("button",{className:"tm-lang-toggle",onClick:()=>zs(w==="en"?"es":"en"),title:w==="en"?"Cambiar a Espa√±ol":"Switch to English",children:[e.jsx(ka,{size:16}),w==="en"?"ES":"EN"]}),j<5&&e.jsxs("div",{className:"tm-step-dots",children:[e.jsx("span",{className:`tm-dot ${j>=1?"active":""}`}),e.jsx("span",{className:`tm-dot ${j>=2?"active":""}`}),e.jsx("span",{className:`tm-dot ${j>=3?"active":""}`}),e.jsx("span",{className:`tm-dot ${j>=4?"active":""}`})]})]})]}),j===1&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-project-info",children:[m.job_number&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Job #"}),e.jsx("span",{className:"tm-project-value",children:m.job_number})]}),e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Project"}),e.jsx("span",{className:"tm-project-value",children:m.name})]}),m.address&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Address"}),e.jsx("span",{className:"tm-project-value",children:m.address})]}),m.general_contractor&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"GC"}),e.jsx("span",{className:"tm-project-value",children:m.general_contractor})]})]}),e.jsxs("div",{className:"tm-field-row",children:[e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:_,onChange:s=>G(s.target.value),className:"tm-date"})]}),e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"CE / PCO #"}),e.jsx("input",{type:"text",placeholder:"Change Event / PCO",value:$,onChange:s=>Y(s.target.value),className:"tm-input"})]})]}),e.jsxs("div",{className:"tm-field tm-description-field",children:[e.jsxs("label",{children:[e.jsx(Pe,{size:16,className:"inline-icon"}),d("describeWork")," ",e.jsx("span",{className:"tm-required",children:"*"})]}),e.jsx("textarea",{placeholder:d("whatWorkPerformed"),value:te,onChange:s=>we(s.target.value),rows:4,className:`tm-description ${te.trim()?"":"tm-field-required"}`})]}),e.jsxs("div",{className:"tm-field",children:[e.jsxs("label",{children:[e.jsx(Ze,{size:16,className:"inline-icon"})," ",d("photos"),f!==-1&&e.jsxs("span",{className:"tm-photo-count",children:["(",A.length,"/",f,")"]})]}),A.length>0&&e.jsx("div",{className:"tm-photo-grid",children:A.map(s=>e.jsxs("div",{className:`tm-photo-item ${s.status?`photo-${s.status}`:""}`,children:[e.jsx("img",{src:s.previewUrl,alt:s.name}),s.status==="compressing"&&e.jsxs("div",{className:"tm-photo-status compressing",children:[e.jsx(_e,{size:20,className:"tm-spinner"}),e.jsx("span",{children:w==="en"?"Compressing":"Comprimiendo"})]}),s.status==="uploading"&&e.jsxs("div",{className:"tm-photo-status uploading",children:[e.jsx(_e,{size:20,className:"tm-spinner"}),e.jsx("span",{children:w==="en"?"Uploading":"Subiendo"})]}),s.status==="confirmed"&&e.jsx("div",{className:"tm-photo-status confirmed",children:e.jsx(ie,{size:20})}),s.status==="failed"&&e.jsxs("div",{className:"tm-photo-status failed",title:s.error||"Upload failed",children:[e.jsx(ys,{size:20}),e.jsx("span",{children:w==="en"?"Failed":"Error"})]}),(!s.status||s.status==="pending"||s.status==="failed")&&e.jsx("button",{className:"tm-photo-remove",onClick:()=>Ks(s.id),children:"√ó"})]},s.id))}),(f===-1||A.length<f)&&e.jsxs("label",{className:"tm-photo-btn",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:Zs,style:{display:"none"}}),e.jsx(Ze,{size:16,className:"inline-icon"})," ",A.length>0?w==="en"?"Add More Photos":"M√°s Fotos":d("addPhotos")]})]}),e.jsxs("div",{className:"tm-field",children:[e.jsxs("label",{children:["Link to Change Order Request (",d("optional"),")"]}),e.jsxs("div",{className:"tm-cor-row",children:[e.jsxs("select",{value:I,onChange:s=>ne(s.target.value),className:"tm-input tm-select",children:[e.jsx("option",{value:"",children:"-- No COR --"}),Q.map(s=>e.jsxs("option",{value:s.id,children:[s.cor_number,": ",s.title||"Untitled"," (",s.status,")"]},s.id))]}),e.jsx("button",{type:"button",className:"tm-refresh-btn",onClick:us,disabled:re,title:"Refresh COR list",children:e.jsx(ia,{size:16,className:re?"spinning":""})})]})]})]}),j===2&&e.jsxs("div",{className:"tm-step-content",children:[qe.length>0&&e.jsxs("div",{className:"tm-crew-picker",children:[e.jsxs("button",{className:"tm-crew-picker-btn",onClick:()=>Hs(!Ie),children:[e.jsx(ue,{size:16})," ",Ie?"Hide":"Select from"," Today's Crew (",qe.length,")"]}),Ie&&e.jsx("div",{className:"tm-crew-list",children:qe.map((s,a)=>{const t=v.some(o=>o.name.toLowerCase()===s.name.toLowerCase())||O.some(o=>o.name.toLowerCase()===s.name.toLowerCase())||h.some(o=>o.name.toLowerCase()===s.name.toLowerCase()),r=Object.values(ce).some(o=>o.some(p=>p.name.toLowerCase()===s.name.toLowerCase())),i=t||r;return e.jsxs("button",{className:`tm-crew-item ${i?"added":""}`,onClick:()=>{if(!i){if(s.labor_class_id&&se&&ce[s.labor_class_id]){const o=ce[s.labor_class_id]||[],p=o.findIndex(N=>!N.name.trim());if(p>=0){const N=[...o];N[p]={...N[p],name:s.name},xe({...ce,[s.labor_class_id]:N})}else xe({...ce,[s.labor_class_id]:[...o,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]})}else{const o=(s.role||"").toLowerCase();if(o.includes("foreman")||o.includes("supervisor")||o.includes("superintendent")){const p=v.findIndex(N=>!N.name.trim());p>=0?(de(p,"name",s.name),de(p,"role",o.includes("superintendent")?"Superintendent":"Foreman")):W([...v,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:o.includes("superintendent")?"Superintendent":"Foreman"}])}else if(o.includes("operator")){const p=O.findIndex(N=>!N.name.trim());p>=0?ve(p,"name",s.name):ae([...O,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}else{const p=h.findIndex(N=>!N.name.trim());p>=0?ge(p,"name",s.name):M([...h,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}}g(`Added ${s.name}`,"success")}},disabled:i,children:[e.jsx("span",{className:"tm-crew-item-name",children:s.name}),e.jsx("span",{className:`tm-crew-item-role ${(s.role||"laborer").toLowerCase()}`,children:s.role||"Laborer"}),i&&e.jsx("span",{className:"tm-crew-item-check",children:"‚úì"})]},a)})})]}),e.jsxs("div",{className:"tm-quick-actions-panel",children:[e.jsxs("div",{className:"tm-batch-hours-header",children:[e.jsx(is,{size:18}),e.jsx("span",{children:d("quickActions")})]}),e.jsxs("div",{className:"tm-quick-actions-buttons",children:[e.jsxs("button",{type:"button",className:"tm-quick-action-btn primary",onClick:Is,disabled:cs,children:[e.jsx(na,{size:16}),d(cs?"loading":"sameAsYesterday")]}),e.jsxs("button",{type:"button",className:"tm-quick-action-btn",onClick:()=>l(!0),children:[e.jsx(Ke,{size:16}),d("setCrewHours")]})]})]}),e.jsxs("div",{className:"tm-inline-presets",children:[e.jsx("span",{className:"tm-inline-presets-label",children:w==="en"?"Apply to all:":"Aplicar a todos:"}),e.jsxs("div",{className:"tm-inline-presets-buttons",children:[e.jsx("button",{type:"button",className:"tm-preset-chip",onClick:()=>Ye("8hr"),children:d("preset8hr")}),e.jsx("button",{type:"button",className:"tm-preset-chip",onClick:()=>Ye("10hr"),children:d("preset10hr")}),e.jsx("button",{type:"button",className:"tm-preset-chip",onClick:()=>Ye("4hr"),children:d("preset4hr")})]})]}),e.jsxs("div",{className:`tm-running-total ${ye>0?"has-data":""}`,children:[e.jsxs("div",{className:"tm-running-total-workers",children:[e.jsx(ue,{size:18}),e.jsx("span",{className:"tm-running-total-count",children:Ve.length}),e.jsx("span",{className:"tm-running-total-label",children:Ve.length===1?d("worker"):d("workers_plural")}),vs>0&&e.jsxs("span",{className:"tm-running-total-warning",children:["(",vs," ",w==="en"?"need hours":"sin horas",")"]})]}),e.jsxs("div",{className:"tm-running-total-hours",children:[e.jsx(Ke,{size:18}),e.jsx("span",{className:"tm-running-total-count",children:He+pe}),e.jsx("span",{className:"tm-running-total-label",children:w==="en"?"total hrs":"hrs total"}),pe>0&&e.jsxs("span",{className:"tm-running-total-ot",children:["(",pe," OT)"]})]})]}),se&&!Be&&e.jsxs(e.Fragment,{children:[As.map(s=>{const a=Re.filter(t=>t.category_id===s.id);return a.length===0?null:e.jsxs("div",{className:"tm-labor-category-section",children:[e.jsx("div",{className:"tm-category-header",children:s.name}),a.map(t=>e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:t.name}),e.jsx("div",{className:"tm-workers-list",children:(ce[t.id]||[]).map((r,i)=>{const o=Se(r);return e.jsxs("div",{className:`tm-worker-card-expanded ${o!=="empty"?`worker-${o}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[o==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:d("firstLastName"),value:r.name,onChange:p=>le(t.id,i,"name",p.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>ps(t.id,i),children:"√ó"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("start")}),e.jsx("input",{type:"time",value:r.timeStarted,onChange:p=>le(t.id,i,"timeStarted",p.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("end")}),e.jsx("input",{type:"time",value:r.timeEnded,onChange:p=>le(t.id,i,"timeEnded",p.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:r.hours,onChange:p=>le(t.id,i,"hours",p.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:r.overtimeHours,onChange:p=>le(t.id,i,"overtimeHours",p.target.value)})]})]})]},i)})}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>hs(t.id),children:["+ ",w==="en"?"Add":"Agregar"," ",t.name]})]},t.id))]},s.id)}),Re.filter(s=>!s.category_id).map(s=>e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:s.name}),e.jsx("div",{className:"tm-workers-list",children:(ce[s.id]||[]).map((a,t)=>{const r=Se(a);return e.jsxs("div",{className:`tm-worker-card-expanded ${r!=="empty"?`worker-${r}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[r==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:d("firstLastName"),value:a.name,onChange:i=>le(s.id,t,"name",i.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>ps(s.id,t),children:"√ó"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("start")}),e.jsx("input",{type:"time",value:a.timeStarted,onChange:i=>le(s.id,t,"timeStarted",i.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("end")}),e.jsx("input",{type:"time",value:a.timeEnded,onChange:i=>le(s.id,t,"timeEnded",i.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:a.hours,onChange:i=>le(s.id,t,"hours",i.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:a.overtimeHours,onChange:i=>le(s.id,t,"overtimeHours",i.target.value)})]})]})]},t)})}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>hs(s.id),children:["+ ",w==="en"?"Add":"Agregar"," ",s.name]})]},s.id))]}),Be&&e.jsxs("div",{className:"tm-loading-labor-classes",children:[e.jsx(_e,{size:20,className:"tm-spinner"}),e.jsx("span",{children:w==="en"?"Loading labor classes...":"Cargando clases de trabajo..."})]}),!se&&!Be&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:d("supervision")}),e.jsx("div",{className:"tm-workers-list",children:v.map((s,a)=>{const t=Se(s);return e.jsxs("div",{className:`tm-worker-card-expanded ${t!=="empty"?`worker-${t}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[t==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("div",{className:"tm-role-select",children:e.jsxs("select",{value:s.role,onChange:r=>de(a,"role",r.target.value),children:[e.jsx("option",{value:"Foreman",children:d("foreman")}),e.jsx("option",{value:"Superintendent",children:d("superintendent")})]})}),e.jsx("input",{type:"text",placeholder:d("firstLastName"),value:s.name,onChange:r=>de(a,"name",r.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>Us(a),children:"√ó"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("start")}),e.jsx("input",{type:"time",value:s.timeStarted,onChange:r=>de(a,"timeStarted",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("end")}),e.jsx("input",{type:"time",value:s.timeEnded,onChange:r=>de(a,"timeEnded",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.hours,onChange:r=>de(a,"hours",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.overtimeHours,onChange:r=>de(a,"overtimeHours",r.target.value)})]})]})]},a)})}),e.jsx("button",{className:"tm-add-btn",onClick:Ws,children:d("addSupervision")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:d("operators")}),e.jsx("div",{className:"tm-workers-list",children:O.map((s,a)=>{const t=Se(s);return e.jsxs("div",{className:`tm-worker-card-expanded ${t!=="empty"?`worker-${t}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[t==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:d("firstLastName"),value:s.name,onChange:r=>ve(a,"name",r.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>Qs(a),children:"√ó"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("start")}),e.jsx("input",{type:"time",value:s.timeStarted,onChange:r=>ve(a,"timeStarted",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("end")}),e.jsx("input",{type:"time",value:s.timeEnded,onChange:r=>ve(a,"timeEnded",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.hours,onChange:r=>ve(a,"hours",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.overtimeHours,onChange:r=>ve(a,"overtimeHours",r.target.value)})]})]})]},a)})}),e.jsx("button",{className:"tm-add-btn",onClick:Ys,children:d("addOperator")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:d("laborers")}),e.jsx("div",{className:"tm-workers-list",children:h.map((s,a)=>{const t=Se(s);return e.jsxs("div",{className:`tm-worker-card-expanded ${t!=="empty"?`worker-${t}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[t==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(ie,{size:14})}),e.jsx("input",{type:"text",placeholder:d("firstLastName"),value:s.name,onChange:r=>ge(a,"name",r.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>Gs(a),children:"√ó"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("start")}),e.jsx("input",{type:"time",value:s.timeStarted,onChange:r=>ge(a,"timeStarted",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("end")}),e.jsx("input",{type:"time",value:s.timeEnded,onChange:r=>ge(a,"timeEnded",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.hours,onChange:r=>ge(a,"hours",r.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:d("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:s.overtimeHours,onChange:r=>ge(a,"overtimeHours",r.target.value)})]})]})]},a)})}),e.jsx("button",{className:"tm-add-btn",onClick:Bs,children:d("addLaborer")})]})]})]}),j===3&&!he&&e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-field tm-search-field",children:[e.jsxs("div",{className:"tm-search-input-wrapper",children:[e.jsx(la,{size:18,className:"tm-search-icon"}),e.jsx("input",{type:"text",placeholder:d("searchMaterials"),value:Fe,onChange:s=>qs(s.target.value),onFocus:()=>$s(),className:"tm-search-input"}),Fe&&e.jsx("button",{className:"tm-search-clear",onClick:()=>{We(""),De([])},children:"√ó"})]}),Fe&&Ue.length>0&&e.jsx("div",{className:"tm-search-results",children:Ue.map((s,a)=>{const t=x.find(r=>r.id===s.id);return e.jsxs("button",{className:`tm-search-result-item ${t?"added":""}`,onClick:()=>{t?Xe(x.indexOf(t),t.quantity+1):ee([...x,{...s,quantity:1,isCustom:!1}]),We(""),De([])},children:[e.jsx("span",{className:"tm-search-result-name",children:s.name}),e.jsx("span",{className:"tm-search-result-category",children:s.category}),t&&e.jsxs("span",{className:"tm-search-result-qty",children:["√ó",t.quantity]})]},a)})}),Fe&&Ue.length===0&&e.jsx("div",{className:"tm-search-no-results",children:d("noSearchResults")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:d("orBrowse")}),e.jsx("div",{className:"tm-category-grid",children:as.map(s=>{const a=x.filter(t=>t.category===s);return e.jsxs("button",{className:"tm-category-card",onClick:()=>Le(s),children:[e.jsx("span",{className:"tm-cat-name",children:s}),a.length>0&&e.jsx("span",{className:"tm-cat-count",children:a.length})]},s)})})]}),x.length>0&&e.jsxs("div",{className:"tm-field",children:[e.jsxs("label",{children:["Added Items (",x.length,")"]}),e.jsx("div",{className:"tm-added-list",children:x.map((s,a)=>e.jsxs("div",{className:"tm-added-item",children:[e.jsxs("div",{className:"tm-added-info",children:[s.isCustom&&e.jsx("span",{className:"tm-custom-badge",children:"Custom"}),e.jsx("span",{className:"tm-added-name",children:s.name})]}),e.jsxs("div",{className:"tm-added-qty",children:[e.jsx("button",{onClick:()=>Xe(a,s.quantity-1),children:"‚àí"}),e.jsx("span",{children:s.quantity}),e.jsx("button",{onClick:()=>Xe(a,s.quantity+1),children:"+"})]})]},a))})]})]}),j===4&&e.jsxs("div",{className:"tm-step-content",children:[e.jsx("div",{className:"tm-review-section",children:e.jsxs("div",{className:"tm-review-header",children:[e.jsx("span",{children:"üìÖ Date"}),e.jsx("span",{children:new Date(_).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})})]})}),te&&e.jsxs("div",{className:"tm-review-section",children:[e.jsx("div",{className:"tm-review-header",children:e.jsxs("span",{children:[e.jsx(Pe,{size:16,className:"inline-icon"})," ",d("notes")]})}),e.jsx("div",{className:"tm-review-notes",children:te})]}),A.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-header",children:[e.jsxs("span",{children:[e.jsx(Ze,{size:16,className:"inline-icon"})," ",d("photos")]}),e.jsx("span",{children:A.length})]}),e.jsx("div",{className:"tm-review-photos",children:A.map(s=>e.jsx("img",{src:s.previewUrl,alt:s.name},s.id))})]}),I&&e.jsxs("div",{className:"tm-review-section",children:[e.jsx("div",{className:"tm-review-header",children:e.jsxs("span",{children:["üîó ",d("linkedCOR")]})}),e.jsxs("div",{className:"tm-review-cor",children:[Q.find(s=>s.id===I)?.cor_number,": ",Q.find(s=>s.id===I)?.title||"Untitled"]})]}),se&&Ee.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-header",children:[e.jsxs("span",{children:[e.jsx(ue,{size:16,className:"inline-icon"})," ",w==="en"?"Workers":"Trabajadores"]}),e.jsxs("span",{children:[He+pe," hrs"]})]}),e.jsx("div",{className:"tm-review-list",children:Ee.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:s.role})," ",s.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.time_started&&s.time_ended&&e.jsxs("span",{className:"tm-review-time",children:[s.time_started," - ",s.time_ended]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",s.overtime_hours>0?` + ${s.overtime_hours} OT`:""]})]})]},a))})]}),!se&&Ne.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-header",children:[e.jsxs("span",{children:[e.jsx(va,{size:16,className:"inline-icon"})," Supervision"]}),e.jsxs("span",{children:[Ne.reduce((s,a)=>s+parseFloat(a.hours||0)+parseFloat(a.overtimeHours||0),0)," hrs"]})]}),e.jsx("div",{className:"tm-review-list",children:Ne.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:s.role})," ",s.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.timeStarted&&s.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[s.timeStarted," - ",s.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",parseFloat(s.overtimeHours)>0?` + ${s.overtimeHours} OT`:""]})]})]},a))})]}),!se&&fe.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-header",children:[e.jsx("span",{children:"üöú Operators"}),e.jsxs("span",{children:[fe.reduce((s,a)=>s+parseFloat(a.hours||0)+parseFloat(a.overtimeHours||0),0)," hrs"]})]}),e.jsx("div",{className:"tm-review-list",children:fe.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:s.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.timeStarted&&s.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[s.timeStarted," - ",s.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",parseFloat(s.overtimeHours)>0?` + ${s.overtimeHours} OT`:""]})]})]},a))})]}),!se&&be.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-header",children:[e.jsxs("span",{children:[e.jsx(ue,{size:16,className:"inline-icon"})," Laborers"]}),e.jsxs("span",{children:[be.reduce((s,a)=>s+parseFloat(a.hours||0)+parseFloat(a.overtimeHours||0),0)," hrs"]})]}),e.jsx("div",{className:"tm-review-list",children:be.map((s,a)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:s.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[s.timeStarted&&s.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[s.timeStarted," - ",s.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[s.hours||0," reg",parseFloat(s.overtimeHours)>0?` + ${s.overtimeHours} OT`:""]})]})]},a))})]}),x.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-header",children:[e.jsxs("span",{children:[e.jsx(Na,{size:16,className:"inline-icon"})," Materials & Equipment"]}),e.jsxs("span",{children:[x.length," items"]})]}),e.jsx("div",{className:"tm-review-list",children:x.map((s,a)=>e.jsxs("div",{className:"tm-review-row",children:[e.jsxs("span",{children:[s.isCustom&&e.jsxs(e.Fragment,{children:[e.jsx(is,{size:14,className:"inline-icon"})," "]}),s.name]}),e.jsxs("span",{children:[s.quantity," ",s.unit]})]},a))})]}),e.jsxs("div",{className:"tm-review-section tm-certification",children:[e.jsx("div",{className:"tm-review-header",children:e.jsxs("span",{children:[e.jsx(Je,{size:16,className:"inline-icon"})," Submitted By"]})}),e.jsx("input",{type:"text",className:"tm-certification-input",placeholder:"Enter your name",value:S,onChange:s=>Z(s.target.value)}),e.jsx("p",{className:"tm-certification-note",children:"By submitting, you certify this T&M is accurate."})]})]}),j===5&&z&&e.jsxs("div",{className:"tm-step-content tm-success-step",children:[e.jsxs("div",{className:"tm-success-header",children:[e.jsx("div",{className:"tm-success-icon",children:e.jsx(ss,{size:48})}),e.jsx("h2",{children:w==="en"?"T&M Ticket Submitted!":"¬°Ticket T&M Enviado!"}),e.jsx("p",{className:"tm-success-subtitle",children:w==="en"?"Your ticket has been saved and is ready for client signature.":"Su ticket ha sido guardado y est√° listo para la firma del cliente."})]}),e.jsxs("div",{className:"tm-success-summary",children:[e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:ye}),e.jsx("span",{className:"tm-success-stat-label",children:w==="en"?"Workers":"Trabajadores"})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:He+pe}),e.jsx("span",{className:"tm-success-stat-label",children:w==="en"?"Total Hours":"Horas Total"})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:new Date(_).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),e.jsx("span",{className:"tm-success-stat-label",children:w==="en"?"Work Date":"Fecha"})]})]}),A.some(s=>s.status==="failed")&&e.jsxs("div",{className:"tm-failed-photos-section",children:[e.jsxs("div",{className:"tm-failed-photos-header",children:[e.jsx(ys,{size:18}),e.jsx("span",{children:w==="en"?`${A.filter(s=>s.status==="failed").length} photo(s) failed to upload`:`${A.filter(s=>s.status==="failed").length} foto(s) no se subieron`})]}),e.jsx("div",{className:"tm-failed-photos-grid",children:A.filter(s=>s.status==="failed").map(s=>e.jsxs("div",{className:"tm-failed-photo-item",children:[e.jsx("img",{src:s.previewUrl,alt:s.name}),e.jsx("div",{className:"tm-failed-photo-overlay",children:e.jsx("button",{className:"tm-retry-photo-btn",onClick:()=>xs(s.id,z.id),disabled:s.status==="uploading"||s.status==="compressing",children:s.status==="uploading"||s.status==="compressing"?e.jsx(_e,{size:16,className:"tm-spinner"}):e.jsxs(e.Fragment,{children:[e.jsx(ts,{size:16}),e.jsx("span",{children:w==="en"?"Retry":"Reintentar"})]})})}),s.error&&e.jsxs("div",{className:"tm-failed-photo-error",title:s.error,children:[s.error.substring(0,20),s.error.length>20?"...":""]})]},s.id))}),e.jsxs("button",{className:"tm-retry-all-btn",onClick:async()=>{const s=A.filter(a=>a.status==="failed");for(const a of s)await xs(a.id,z.id)},children:[e.jsx(ts,{size:16}),w==="en"?"Retry All Failed Photos":"Reintentar Todas las Fotos"]})]}),A.length>0&&A.every(s=>s.status==="confirmed")&&e.jsxs("div",{className:"tm-photos-success",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:w==="en"?`All ${A.length} photo(s) uploaded successfully`:`${A.length} foto(s) subidas exitosamente`})]}),e.jsxs("div",{className:"tm-signature-options",children:[e.jsx("h3",{children:w==="en"?"Get Client Signature":"Obtener Firma del Cliente"}),e.jsx("p",{className:"tm-signature-description",children:w==="en"?"Have the client sign this T&M ticket to verify the work performed.":"Haga que el cliente firme este ticket T&M para verificar el trabajo realizado."}),D?e.jsxs("div",{className:"tm-signed-confirmation",children:[e.jsx(ss,{size:32,className:"tm-signed-icon"}),e.jsx("span",{children:w==="en"?"Client signature collected!":"¬°Firma del cliente recopilada!"})]}):e.jsxs("div",{className:"tm-signature-buttons",children:[e.jsxs("button",{className:"tm-signature-option-btn primary",onClick:()=>T(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(Je,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:w==="en"?"Sign Now (On-Site)":"Firmar Ahora"}),e.jsx("span",{className:"tm-signature-option-desc",children:w==="en"?"Client signs on this device":"Cliente firma en este dispositivo"})]})]}),e.jsxs("button",{className:"tm-signature-option-btn",onClick:()=>P(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(oa,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:w==="en"?"Send Signature Link":"Enviar Enlace"}),e.jsx("span",{className:"tm-signature-option-desc",children:w==="en"?"Client signs later via link":"Cliente firma despu√©s v√≠a enlace"})]})]})]})]})]}),q&&z&&e.jsx(ca,{documentType:"tm_ticket",documentId:z.id,companyId:y,projectId:m.id,documentTitle:`T&M - ${new Date(_).toLocaleDateString()}`,onClose:()=>P(!1),onShowToast:g}),X&&z&&e.jsx(Fa,{ticketId:z.id,ticketSummary:{workDate:_,workerCount:ye,totalHours:He+pe},lang:w,onSave:()=>{T(!1),C(!0)},onClose:()=>T(!1),onShowToast:g}),j<5&&e.jsxs("div",{className:"tm-wizard-footer",children:[j===1&&e.jsx("button",{className:"tm-big-btn primary",onClick:Me,disabled:!js(),children:d("nextCrew")}),j===2&&e.jsx(e.Fragment,{children:e.jsxs("button",{className:"tm-big-btn primary",onClick:Me,disabled:!js(),children:[d("nextMaterials")," (",ye," ",d(ye===1?"worker":"workers_plural"),", ",He+pe," hrs)"]})}),j===3&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:Me,children:[d("reviewItems")," (",x.length," ",x.length===1?d("item"):d("items_plural"),")"]}),e.jsx("button",{className:"tm-skip-btn",onClick:Me,children:d("skipNoMaterials")})]}),j===4&&e.jsx("button",{className:`tm-big-btn submit ${$e?"submitting":""} ${S.trim()?"ready":"needs-name"}`,onClick:ea,disabled:$e||!S.trim(),children:$e?e.jsxs(e.Fragment,{children:[e.jsx(_e,{size:20,className:"tm-spinner"}),e.jsx("span",{className:"tm-submit-text",children:Ss||d("submitting")})]}):S.trim()?e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:20}),e.jsx("span",{children:d("submitTM")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Je,{size:18}),e.jsx("span",{children:w==="en"?"Enter name to submit":"Ingrese nombre"})]})})]}),j===5&&e.jsxs("div",{className:"tm-wizard-footer",children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:F,children:[e.jsx(ie,{size:20}),e.jsx("span",{children:w==="en"?"Done":"Listo"})]}),e.jsx("button",{className:"tm-skip-btn",onClick:F,children:w==="en"?"Skip signature for now":"Saltar firma por ahora"})]}),n&&e.jsx("div",{className:"tm-modal-overlay",onClick:()=>l(!1),children:e.jsxs("div",{className:"tm-batch-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("h3",{children:[e.jsx(Ke,{size:18})," ",d("applySameHours")]}),e.jsx("p",{className:"tm-batch-description",children:d("batchDescription")}),e.jsxs("div",{className:"tm-time-presets",children:[e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>Ge("full"),children:d("preset8hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>Ge("10hr"),children:d("preset10hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>Ge("half"),children:d("preset4hr")})]}),e.jsxs("div",{className:"tm-batch-form",children:[e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:d("timeStarted")}),e.jsx("input",{type:"time",value:u.timeStarted,onChange:s=>{const a=s.target.value,t=je(a,u.timeEnded);b({...u,timeStarted:a,...t||{}})}})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:d("timeEnded")}),e.jsx("input",{type:"time",value:u.timeEnded,onChange:s=>{const a=s.target.value,t=je(u.timeStarted,a);b({...u,timeEnded:a,...t||{}})}})]})]}),e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:d("regularHours")}),e.jsx("input",{type:"number",placeholder:"8",value:u.hours,onChange:s=>b({...u,hours:s.target.value})})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:d("overtimeHours")}),e.jsx("input",{type:"number",placeholder:"0",value:u.overtimeHours,onChange:s=>b({...u,overtimeHours:s.target.value})})]})]})]}),e.jsxs("div",{className:"tm-batch-preview",children:[e.jsxs("strong",{children:[d("willApplyTo"),":"]}),e.jsxs("span",{children:[[...v.filter(s=>s.name.trim()),...O.filter(s=>s.name.trim()),...h.filter(s=>s.name.trim())].length," ",d("workers_plural")]})]}),e.jsxs("div",{className:"tm-batch-actions",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!1),children:d("cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:Os,disabled:!u.hours&&!u.overtimeHours,children:d("applyToAll")})]})]})})]})}function Aa({project:m,companyId:y,onShowToast:f}){const[F,R]=c.useState([]),[g,j]=c.useState(!0),[H,_]=c.useState(!1),[G,z]=c.useState(!1),[k,q]=c.useState({name:"",role:"",labor_class_id:null}),[P,X]=c.useState([]),[T,D]=c.useState([]),[C,$]=c.useState(!0),Y=["Foreman","Laborer","Supervisor","Operator"];c.useEffect(()=>{Z(),y?S():$(!1)},[m.id,y]);const S=async()=>{try{const n=await E.getLaborClassesForField(y);X(n.categories||[]),D(n.classes||[]),n.classes&&n.classes.length>0&&q(l=>({...l,role:n.classes[0].name,labor_class_id:n.classes[0].id}))}catch(n){console.error("Error loading labor classes:",n)}finally{$(!1)}},Z=async()=>{try{const n=await E.getCrewCheckin(m.id);n?.workers&&R(n.workers)}catch(n){console.error("Error loading crew:",n)}finally{j(!1)}},I=n=>{const l=T.find(u=>u.id===n);q(l?{...k,role:l.name,labor_class_id:l.id}:{...k,role:n,labor_class_id:null})},ne=async()=>{if(!k.name.trim()){f("Enter worker name","error");return}if(!k.role){f("Select a role","error");return}if(F.find(n=>n.name.toLowerCase()===k.name.trim().toLowerCase())){f("Worker already added","error");return}_(!0);try{const n=[...F,{name:k.name.trim(),role:k.role,labor_class_id:k.labor_class_id}];await E.saveCrewCheckin(m.id,n),R(n),q({...k,name:""}),z(!1),f("Crew member added","success")}catch(n){console.error("Error adding worker:",n),f("Error adding crew member","error")}finally{_(!1)}},Q=async n=>{_(!0);try{const l=F.filter(u=>u.name.toLowerCase()!==n.toLowerCase());await E.saveCrewCheckin(m.id,l),R(l),f("Crew member removed","success")}catch(l){console.error("Error removing worker:",l),f("Error removing crew member","error")}finally{_(!1)}},K=new Date().toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"}),re=()=>{const n={};P.forEach(u=>{n[u.id]={name:u.name,classes:T.filter(b=>b.category_id===u.id)}});const l=T.filter(u=>!u.category_id);return l.length>0&&(n.uncategorized={name:"Other",classes:l}),n},B=T.length>0;return g||C?e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(ue,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:K})]}),e.jsx("div",{className:"crew-loading",children:"Loading..."})]}):e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(ue,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:K})]}),F.length===0?e.jsxs("div",{className:"crew-empty",children:[e.jsx("p",{children:"No crew checked in yet"}),e.jsx("p",{className:"crew-empty-hint",children:"Add your crew for the day"})]}):e.jsx("div",{className:"crew-list",children:F.map(n=>e.jsxs("div",{className:"crew-member",children:[e.jsxs("div",{className:"crew-member-info",children:[e.jsx("span",{className:"crew-member-name",children:n.name}),e.jsx("span",{className:`crew-member-role ${(n.role||"laborer").toLowerCase().replace(/\s+/g,"-")}`,children:n.role})]}),e.jsx("button",{className:"crew-remove-btn",onClick:()=>Q(n.name),disabled:H,children:"√ó"})]},n.name))}),G?e.jsxs("div",{className:"crew-add-form",children:[e.jsx("input",{type:"text",value:k.name,onChange:n=>q({...k,name:n.target.value}),placeholder:"Name",autoFocus:!0}),e.jsx("select",{value:k.labor_class_id||k.role,onChange:n=>I(n.target.value),children:B?Object.entries(re()).map(([n,l])=>e.jsx("optgroup",{label:l.name,children:l.classes.map(u=>e.jsx("option",{value:u.id,children:u.name},u.id))},n)):Y.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsxs("div",{className:"crew-add-buttons",children:[e.jsx("button",{className:"crew-add-confirm",onClick:ne,disabled:H,children:H?"...":"Add"}),e.jsx("button",{className:"crew-add-cancel",onClick:()=>{z(!1),q({name:"",role:T[0]?.name||"Laborer",labor_class_id:T[0]?.id||null})},children:"Cancel"})]})]}):e.jsx("button",{className:"crew-add-btn",onClick:()=>z(!0),children:"+ Add Crew Member"}),e.jsxs("div",{className:"crew-count",children:[F.length," ",F.length===1?"person":"people"," on site"]})]})}function Ra({project:m,onShowToast:y,onClose:f}){const[F,R]=c.useState(!0),[g,j]=c.useState(!1),[H,_]=c.useState(null),[G,z]=c.useState(""),[k,q]=c.useState("");c.useEffect(()=>{P()},[m.id]);const P=async()=>{try{const C=await E.getDailyReport(m.id);if(C)_(C),z(C.field_notes||""),q(C.issues||"");else{const $=await E.compileDailyReport(m.id);_({...$,status:"draft"})}}catch(C){console.error("Error loading report:",C),y("Error loading report","error")}finally{R(!1)}},X=async()=>{if(!ta){y("Demo Mode: Report saved locally only - won't reach office","info"),f();return}j(!0);try{await E.saveDailyReport(m.id,{field_notes:G,issues:k}),await E.submitDailyReport(m.id,"Field")?(y("Daily report submitted!","success"),f()):y("Report not sent - check connection","error")}catch(C){console.error("Error submitting report:",C),y("Error submitting report","error")}finally{j(!1)}},T=new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"});if(F)return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:f,children:"‚Üê"}),e.jsx("h2",{children:"Daily Report"})]}),e.jsx("div",{className:"daily-report-loading",children:"Compiling report..."})]});const D=H?.status==="submitted";return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:f,children:"‚Üê"}),e.jsxs("div",{children:[e.jsx("h2",{children:"Daily Report"}),e.jsx("p",{className:"daily-report-date",children:T})]})]}),D&&e.jsxs("div",{className:"daily-report-submitted-banner",children:["‚úì Submitted ",new Date(H.submitted_at).toLocaleTimeString()]}),e.jsxs("div",{className:"daily-report-content",children:[e.jsxs("div",{className:"daily-report-summary",children:[e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:H.crew_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Crew on Site"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:H.tasks_completed||0}),e.jsx("div",{className:"daily-report-card-label",children:"Tasks Done"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:H.tm_tickets_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"T&M Tickets"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:H.photos_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Photos"})]})]}),H.crew_list?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(ue,{size:18,className:"inline-icon"})," Crew"]}),e.jsx("div",{className:"daily-report-crew",children:H.crew_list.map((C,$)=>e.jsxs("div",{className:"daily-report-crew-item",children:[e.jsx("span",{children:C.name}),e.jsx("span",{className:"daily-report-crew-role",children:C.role})]},$))})]}),H.completed_tasks?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(xa,{size:18,className:"inline-icon"})," Completed Today"]}),e.jsx("ul",{className:"daily-report-tasks",children:H.completed_tasks.map((C,$)=>e.jsxs("li",{children:[C.name,C.group&&e.jsx("span",{className:"daily-report-task-group",children:C.group})]},$))})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(Pe,{size:18,className:"inline-icon"})," Notes"]}),e.jsx("textarea",{value:G,onChange:C=>z(C.target.value),placeholder:"Any notes about today's work...",rows:3,disabled:D})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(ws,{size:18,className:"inline-icon"})," Issues / Concerns"]}),e.jsx("textarea",{value:k,onChange:C=>q(C.target.value),placeholder:"Any problems, delays, or concerns...",rows:3,disabled:D})]})]}),!D&&e.jsxs("div",{className:"daily-report-footer",children:[e.jsx("button",{className:"btn btn-primary daily-report-submit",onClick:X,disabled:g,children:g?"Submitting...":e.jsxs(e.Fragment,{children:[e.jsx(_a,{size:16,className:"inline-icon"})," Submit Report"]})}),e.jsx("p",{className:"daily-report-hint",children:"This will be sent to the office"})]})]})}const Oe=[{value:"concrete",label:"Concrete",icon:"üß±"},{value:"trash",label:"Trash",icon:"üóëÔ∏è"},{value:"metals",label:"Metals",icon:"üî©"},{value:"hazardous_waste",label:"Hazardous",icon:"‚ò£Ô∏è"}],Ma=m=>Oe.find(y=>y.value===m)||{label:m,icon:"üì¶"};function Oa({project:m,user:y=null,date:f,onShowToast:F}){const[R,g]=c.useState([]),[j,H]=c.useState([]),[_,G]=c.useState(!0),[z,k]=c.useState(!1),[q,P]=c.useState(!1),[X,T]=c.useState(!1),[D,C]=c.useState({type:"concrete",count:1}),$=new Date(f).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});c.useEffect(()=>{Y(),S()},[m.id,f]);const Y=async()=>{try{G(!0);const n=await E.getDisposalLoads(m.id,f);g(n||[])}catch(n){console.error("Error loading disposal loads:",n)}finally{G(!1)}},S=async()=>{try{const l=(await E.getDisposalLoadsHistory(m.id,14)||[]).filter(b=>b.load_date!==f).reduce((b,v)=>(b[v.load_date]||(b[v.load_date]=[]),b[v.load_date].push(v),b),{}),u=Object.entries(l).map(([b,v])=>({date:b,loads:v,totalLoads:v.reduce((W,O)=>W+O.load_count,0)})).sort((b,v)=>new Date(v.date)-new Date(b.date));H(u)}catch(n){console.error("Error loading disposal history:",n)}},Z=async()=>{if(!(D.count<1)){k(!0);try{await E.addDisposalLoad(m.id,y?.id||null,f,D.type,D.count),await Y(),C({type:"concrete",count:1}),P(!1),F?.("Disposal load added","success")}catch(n){console.error("Error adding disposal load:",n),F?.("Error adding load","error")}finally{k(!1)}}},I=async n=>{k(!0);try{await E.deleteDisposalLoad(n),await Y(),F?.("Load removed","success")}catch(l){console.error("Error deleting disposal load:",l),F?.("Error removing load","error")}finally{k(!1)}},ne=async n=>{k(!0);try{await E.addDisposalLoad(m.id,y?.id||null,f,n,1),await Y(),F?.("Load added","success")}catch(l){console.error("Error adding disposal load:",l),F?.("Error adding load","error")}finally{k(!1)}},Q=async n=>{k(!0);try{await E.updateDisposalLoad(n.id,n.load_type,n.load_count+1),await Y()}catch(l){console.error("Error updating load:",l),F?.("Error updating load","error")}finally{k(!1)}},K=async n=>{if(n.load_count<=1){await I(n.id);return}k(!0);try{await E.updateDisposalLoad(n.id,n.load_type,n.load_count-1),await Y()}catch(l){console.error("Error updating load:",l),F?.("Error updating load","error")}finally{k(!1)}},re=R.reduce((n,l)=>(n[l.load_type]||(n[l.load_type]={items:[],total:0}),n[l.load_type].items.push(l),n[l.load_type].total+=l.load_count,n),{}),B=R.reduce((n,l)=>n+l.load_count,0);return _?e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsx(rs,{size:20}),e.jsx("span",{children:"Disposal Loads"})]}),e.jsx("div",{className:"disposal-loading",children:"Loading..."})]}):e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsxs("div",{className:"disposal-title",children:[e.jsx(rs,{size:20}),e.jsx("span",{children:"Disposal Loads"}),B>0&&e.jsx("span",{className:"disposal-badge",children:B})]}),e.jsx("span",{className:"disposal-date",children:$})]}),e.jsx("div",{className:"disposal-quick-add",children:Oe.map(n=>e.jsxs("button",{className:"quick-add-btn",onClick:()=>ne(n.value),disabled:z,children:[e.jsx("span",{className:"quick-add-icon",children:n.icon}),e.jsxs("span",{className:"quick-add-label",children:["+ ",n.label]})]},n.value))}),Object.keys(re).length>0?e.jsx("div",{className:"disposal-loads-list",children:Oe.map(n=>{const l=re[n.value];return l?e.jsxs("div",{className:"disposal-load-row",children:[e.jsxs("div",{className:"load-info",children:[e.jsx("span",{className:"load-icon",children:n.icon}),e.jsx("span",{className:"load-label",children:n.label})]}),e.jsxs("div",{className:"load-controls",children:[e.jsx("button",{className:"load-btn decrement",onClick:()=>K(l.items[0]),disabled:z,children:e.jsx(Ns,{size:16})}),e.jsx("span",{className:"load-count",children:l.total}),e.jsx("button",{className:"load-btn increment",onClick:()=>Q(l.items[0]),disabled:z,children:e.jsx(es,{size:16})})]})]},n.value):null})}):e.jsxs("div",{className:"disposal-empty",children:[e.jsxs("p",{children:["No disposal loads recorded for ",$]}),e.jsx("p",{className:"disposal-hint",children:"Tap a button above to add loads"})]}),q&&e.jsxs("div",{className:"disposal-add-form",children:[e.jsxs("div",{className:"add-form-row",children:[e.jsx("select",{value:D.type,onChange:n=>C({...D,type:n.target.value}),className:"load-type-select",children:Oe.map(n=>e.jsxs("option",{value:n.value,children:[n.icon," ",n.label]},n.value))}),e.jsxs("div",{className:"count-input-group",children:[e.jsx("button",{className:"count-btn",onClick:()=>C({...D,count:Math.max(1,D.count-1)}),children:e.jsx(Ns,{size:16})}),e.jsx("input",{type:"number",min:"1",value:D.count,onChange:n=>C({...D,count:parseInt(n.target.value)||1}),className:"count-input"}),e.jsx("button",{className:"count-btn",onClick:()=>C({...D,count:D.count+1}),children:e.jsx(es,{size:16})})]})]}),e.jsxs("div",{className:"add-form-actions",children:[e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:()=>P(!1),children:[e.jsx(ks,{size:16})," Cancel"]}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:Z,disabled:z,children:[e.jsx(ie,{size:16})," Add"]})]})]}),!q&&e.jsxs("button",{className:"disposal-add-custom",onClick:()=>P(!0),children:[e.jsx(es,{size:16}),"Add multiple loads"]}),B>0&&e.jsxs("div",{className:"disposal-summary",children:[e.jsx("strong",{children:B})," total load",B!==1?"s":""," today"]}),j.length>0&&e.jsxs("div",{className:"disposal-history-section",children:[e.jsxs("button",{className:"disposal-history-toggle",onClick:()=>T(!X),children:[e.jsx(Ea,{size:16}),e.jsxs("span",{children:["View History (",j.length," days)"]}),X?e.jsx(da,{size:16}):e.jsx(fa,{size:16})]}),X&&e.jsx("div",{className:"disposal-history-list",children:j.map(n=>{const l=new Date(n.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),u=n.loads.reduce((b,v)=>(b[v.load_type]||(b[v.load_type]=0),b[v.load_type]+=v.load_count,b),{});return e.jsxs("div",{className:"disposal-history-day",children:[e.jsxs("div",{className:"disposal-history-header",children:[e.jsx("span",{className:"disposal-history-date",children:l}),e.jsxs("span",{className:"disposal-history-total",children:[n.totalLoads," load",n.totalLoads!==1?"s":""]})]}),e.jsx("div",{className:"disposal-history-types",children:Object.entries(u).map(([b,v])=>{const W=Ma(b);return e.jsxs("span",{className:"disposal-history-type",children:[W.icon," ",v," ",W.label]},b)})})]},n.date)})})]})]})}function Qa({project:m,companyId:y,onShowToast:f,onExit:F}){const[R,g]=c.useState([]),[j,H]=c.useState(!0),[_,G]=c.useState(null),[z,k]=c.useState({}),[q,P]=c.useState(!1),[X,T]=c.useState(!1),[D,C]=c.useState(!1),[$,Y]=c.useState(!1),[S,Z]=c.useState(!1),[I,ne]=c.useState(!1),[Q,K]=c.useState("actions");c.useEffect(()=>{re()},[m.id]);const re=async()=>{try{const h=await E.getAreas(m.id);g(h);const M=[...new Set(h.map(ee=>ee.group_name||"General"))],x={};M.forEach(ee=>x[ee]=!1),k(x)}catch(h){console.error("Error loading areas:",h),f("Error loading areas","error")}finally{H(!1)}},B=async(h,M)=>{const x=R.find(te=>te.id===h);if(!x)return;const ee=x.status===M?"not_started":M;G(h);try{await E.updateAreaStatus(h,ee),g(te=>te.map(we=>we.id===h?{...we,status:ee}:we)),f("Updated","success")}catch(te){console.error("Error updating status:",te),f("Error updating","error")}finally{G(null)}},n=h=>{k(M=>({...M,[h]:!M[h]}))};if(j)return e.jsx("div",{className:"foreman-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),"Loading..."]})});if(q)return e.jsx("div",{className:"foreman-container",children:e.jsx(za,{project:m,companyId:y,onSubmit:()=>P(!1),onCancel:()=>P(!1),onShowToast:f})});if($)return e.jsx(Ra,{project:m,onShowToast:f,onClose:()=>Y(!1)});if(S)return e.jsx("div",{className:"foreman-container",children:e.jsx(ma,{project:m,companyId:y,onClose:()=>Z(!1),onReportCreated:()=>{Z(!1),f("Injury report submitted","success")}})});if(X)return e.jsxs("div",{className:"foreman-container",children:[e.jsxs("div",{className:"foreman-view-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:()=>T(!1),children:"‚Üê"}),e.jsx("h2",{children:"Crew Check-in"})]}),e.jsx(Aa,{project:m,companyId:y,onShowToast:f})]});if(D)return e.jsxs("div",{className:"foreman-container",children:[e.jsxs("div",{className:"foreman-view-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:()=>C(!1),children:"‚Üê"}),e.jsx("h2",{children:"Disposal Loads"})]}),e.jsx(Oa,{project:m,date:new Date().toISOString().split("T")[0],onShowToast:f})]});const l=ua(R),u=R.reduce((h,M)=>{const x=M.group_name||"General";return h[x]||(h[x]=[]),h[x].push(M),h},{}),b=Object.keys(u).length>1||Object.keys(u).length===1&&!u.General,v=h=>`${h.filter(x=>x.status==="done").length}/${h.length}`,W=R.filter(h=>h.status==="done").length,O=R.filter(h=>h.status==="working").length,ae=R.length-W;return e.jsxs("div",{className:"foreman-container",children:[e.jsxs("div",{className:"foreman-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:F,children:"‚Üê"}),e.jsxs("div",{className:"foreman-header-info",children:[e.jsx("div",{className:"foreman-project-name",children:m.name}),e.jsxs("div",{className:"foreman-progress",children:[l,"% Complete"]})]}),e.jsxs("div",{className:"foreman-header-actions",children:[e.jsx(ra,{compact:!0}),e.jsx("button",{className:"foreman-info-btn",onClick:()=>ne(!I),children:e.jsx(ha,{size:20})})]})]}),I&&e.jsxs("div",{className:"foreman-project-info",children:[m.job_number&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Job #"}),e.jsx("span",{className:"foreman-info-value",children:m.job_number})]}),m.address&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Address"}),e.jsx("span",{className:"foreman-info-value",children:m.address})]}),m.general_contractor&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"GC / Client"}),e.jsx("span",{className:"foreman-info-value",children:m.general_contractor})]}),m.client_contact&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Contact"}),e.jsx("span",{className:"foreman-info-value",children:m.client_contact})]}),m.client_phone&&e.jsxs("div",{className:"foreman-info-row",children:[e.jsx("span",{className:"foreman-info-label",children:"Phone"}),e.jsx("a",{href:`tel:${m.client_phone}`,className:"foreman-info-value foreman-info-link",children:m.client_phone})]})]}),e.jsxs("div",{className:"foreman-stats",children:[e.jsxs("div",{className:"foreman-stat",children:[e.jsx("div",{className:"foreman-stat-value working",children:O}),e.jsx("div",{className:"foreman-stat-label",children:"Working"})]}),e.jsxs("div",{className:"foreman-stat",children:[e.jsx("div",{className:"foreman-stat-value done",children:W}),e.jsx("div",{className:"foreman-stat-label",children:"Done"})]}),e.jsxs("div",{className:"foreman-stat",children:[e.jsx("div",{className:"foreman-stat-value remaining",children:ae}),e.jsx("div",{className:"foreman-stat-label",children:"Remaining"})]})]}),e.jsxs("div",{className:"foreman-tabs",children:[e.jsxs("button",{className:`foreman-tab ${Q==="actions"?"active":""}`,onClick:()=>K("actions"),children:[e.jsx(is,{size:18}),"Actions"]}),e.jsxs("button",{className:`foreman-tab ${Q==="progress"?"active":""}`,onClick:()=>K("progress"),children:[e.jsx(pa,{size:18}),"Progress"]})]}),Q==="actions"&&e.jsxs("div",{className:"field-actions",children:[e.jsxs("button",{className:"field-action-btn",onClick:()=>T(!0),children:[e.jsx(ue,{size:22}),"Crew Check-in"]}),e.jsxs("button",{className:"field-action-btn",onClick:()=>P(!0),children:[e.jsx(Pe,{size:22}),"T&M Ticket"]}),e.jsxs("button",{className:"field-action-btn",onClick:()=>C(!0),children:[e.jsx(rs,{size:22}),"Disposal Loads"]}),e.jsxs("button",{className:"field-action-btn",onClick:()=>Y(!0),children:[e.jsx(fs,{size:22}),"Daily Report"]}),e.jsxs("button",{className:"field-action-btn danger",onClick:()=>Z(!0),children:[e.jsx(ws,{size:22}),"Report Injury"]})]}),Q==="progress"&&e.jsxs("div",{className:"foreman-areas",children:[b?Object.entries(u).map(([h,M])=>e.jsxs("div",{className:"foreman-group",children:[e.jsxs("div",{className:"foreman-group-header",onClick:()=>n(h),children:[e.jsxs("div",{className:"foreman-group-title",children:[e.jsx("span",{className:"foreman-group-arrow",children:z[h]?"‚ñº":"‚ñ∂"}),e.jsx("span",{className:"foreman-group-name",children:h})]}),e.jsx("span",{className:"foreman-group-progress",children:v(M)})]}),z[h]&&e.jsx("div",{className:"foreman-group-tasks",children:M.map(x=>e.jsxs("div",{className:`foreman-area-card ${x.status}`,children:[e.jsx("div",{className:"foreman-area-name",children:x.name}),e.jsxs("div",{className:"foreman-area-buttons",children:[e.jsx("button",{className:`foreman-btn working ${x.status==="working"?"active":""}`,onClick:()=>B(x.id,"working"),disabled:_===x.id,children:_===x.id?"...":"Working"}),e.jsx("button",{className:`foreman-btn done ${x.status==="done"?"active":""}`,onClick:()=>B(x.id,"done"),disabled:_===x.id,children:_===x.id?"...":"Done"})]})]},x.id))})]},h)):R.map(h=>e.jsxs("div",{className:`foreman-area-card ${h.status}`,children:[e.jsx("div",{className:"foreman-area-name",children:h.name}),e.jsxs("div",{className:"foreman-area-buttons",children:[e.jsx("button",{className:`foreman-btn working ${h.status==="working"?"active":""}`,onClick:()=>B(h.id,"working"),disabled:_===h.id,children:_===h.id?"...":"Working"}),e.jsx("button",{className:`foreman-btn done ${h.status==="done"?"active":""}`,onClick:()=>B(h.id,"done"),disabled:_===h.id,children:_===h.id?"...":"Done"})]})]},h.id)),R.length===0&&e.jsxs("div",{className:"foreman-empty",children:[e.jsx(fs,{size:48,className:"foreman-empty-icon"}),e.jsx("div",{className:"foreman-empty-text",children:"No areas yet"}),e.jsx("div",{className:"foreman-empty-subtext",children:"Office needs to add areas to this project"})]})]})]})}export{Qa as default};
