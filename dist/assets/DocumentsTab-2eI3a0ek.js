import{q as e,p as f,M as Se}from"./index-CusUzOqT.js";import{r as l,X as Y,E as ge,av as _e,c as me,L,k as ne,A as Ne,D as Z,aw as ye,b as we,j as Ce,a5 as se,F as te,x as T,O as Ee,al as Pe,ax as ie,ay as Ie,w as Re,a as Ae,v as Me,u as Le,t as Oe,f as Ue,s as $e,T as Be,n as re,az as Ve,af as Ge,ag as Te,e as ue,aA as We,Y as He,I as Qe,z as Ye}from"./icons-CosbTI8G.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";const ze=[{id:"plans",label:"Plans & Drawings",icon:"Map"},{id:"specs",label:"Specifications",icon:"FileText"},{id:"permits",label:"Permits & Approvals",icon:"Shield"},{id:"contracts",label:"Contracts",icon:"FileSignature"},{id:"submittals",label:"Submittals",icon:"Send"},{id:"rfis",label:"RFIs",icon:"HelpCircle"},{id:"photos",label:"Site Photos",icon:"Camera"},{id:"reports",label:"Reports",icon:"ClipboardList"},{id:"safety",label:"Safety Documents",icon:"AlertTriangle"},{id:"general",label:"General",icon:"Folder"}],he={"application/pdf":{ext:"pdf",maxSize:25*1024*1024,label:"PDF"},"application/msword":{ext:"doc",maxSize:15*1024*1024,label:"Word"},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{ext:"docx",maxSize:15*1024*1024,label:"Word"},"application/vnd.ms-excel":{ext:"xls",maxSize:15*1024*1024,label:"Excel"},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{ext:"xlsx",maxSize:15*1024*1024,label:"Excel"},"image/jpeg":{ext:"jpg",maxSize:10*1024*1024,label:"Image"},"image/png":{ext:"png",maxSize:10*1024*1024,label:"Image"}},Fe={all:{label:"Everyone",description:"Visible to all team members including field users"},office_only:{label:"Office Only",description:"Only visible to office staff and admins"},admin_only:{label:"Admins Only",description:"Only visible to company administrators"}},Ke=["contracts"],qe=25,xe=t=>{if(!t)return"0 B";const h=["B","KB","MB","GB"];let c=t,o=0;for(;c>=1024&&o<h.length-1;)c/=1024,o++;return`${c.toFixed(c<10?1:0)} ${h[o]}`};function pe({projectId:t,companyId:h,folderId:c,folderName:o,onClose:S,onUploadComplete:i,onShowToast:V}){const[x,d]=l.useState(null),[R,_]=l.useState(!1),[N,D]=l.useState(!1),[k,y]=l.useState(""),[C,p]=l.useState(null),[g,w]=l.useState(""),[E,z]=l.useState(""),[b,j]=l.useState("general"),[v,O]=l.useState("all"),A=l.useRef(null),U=s=>{if(!s)return"Please select a file";const P=he[s.type];return P?s.size>P.maxSize?`File too large. Maximum size for ${P.label}: ${xe(P.maxSize)}`:null:"File type not supported. Allowed: PDF, Word, Excel, Images"},r=l.useCallback(s=>{const P=U(s);if(P){p(P);return}if(p(null),d(s),!g){const K=s.name.replace(/\.[^/.]+$/,"");w(K)}},[g]),$=s=>{s.preventDefault(),s.stopPropagation(),s.type==="dragenter"||s.type==="dragover"?_(!0):s.type==="dragleave"&&_(!1)},a=s=>{s.preventDefault(),s.stopPropagation(),_(!1),s.dataTransfer.files&&s.dataTransfer.files[0]&&r(s.dataTransfer.files[0])},F=s=>{s.target.files&&s.target.files[0]&&r(s.target.files[0])},M=async()=>{if(!x){p("Please select a file");return}if(!g.trim()){p("Please enter a document name");return}D(!0),p(null),y("Uploading document...");try{const s=await f.uploadDocument(h,t,x,{name:g.trim(),description:E.trim()||null,category:b,visibility:v,folderId:c||null});y("Upload complete!"),i(s)}catch(s){console.error("Upload error:",s),p(s.message||"Failed to upload document"),D(!1)}},I=Ke.includes(b);return e.jsx("div",{className:"modal-overlay",onClick:S,children:e.jsxs("div",{className:"document-upload-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Upload Document"}),o&&e.jsxs("span",{className:"modal-subtitle",children:["to ",o]})]}),e.jsx("button",{className:"modal-close",onClick:S,children:e.jsx(Y,{size:20})})]}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:`document-dropzone ${R?"drag-active":""} ${x?"has-file":""}`,onDragEnter:$,onDragLeave:$,onDragOver:$,onDrop:a,onClick:()=>!x&&A.current?.click(),children:[e.jsx("input",{ref:A,type:"file",accept:Object.keys(he).join(","),onChange:F,style:{display:"none"}}),x?e.jsxs("div",{className:"dropzone-file",children:[e.jsx(ge,{size:32}),e.jsxs("div",{className:"dropzone-file-info",children:[e.jsx("span",{className:"dropzone-file-name",children:x.name}),e.jsx("span",{className:"dropzone-file-size",children:xe(x.size)})]}),e.jsx("button",{className:"dropzone-file-remove",onClick:s=>{s.stopPropagation(),d(null),p(null)},children:e.jsx(Y,{size:16})})]}):e.jsxs(e.Fragment,{children:[e.jsx(_e,{size:48}),e.jsxs("p",{className:"dropzone-text",children:["Drag & drop files here",e.jsx("br",{}),"or click to browse"]}),e.jsx("p",{className:"dropzone-hint",children:"PDF, Word, Excel, Images • Max 25MB"})]})]}),C&&e.jsxs("div",{className:"document-upload-error",children:[e.jsx(me,{size:16}),C]}),e.jsxs("div",{className:"document-upload-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-name",children:"Document Name *"}),e.jsx("input",{id:"doc-name",type:"text",value:g,onChange:s=>w(s.target.value),placeholder:"Enter document name",disabled:N})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-category",children:"Category"}),e.jsx("select",{id:"doc-category",value:b,onChange:s=>j(s.target.value),disabled:N,children:ze.map(s=>e.jsx("option",{value:s.id,children:s.label},s.id))}),I&&e.jsxs("p",{className:"form-hint warning",children:[e.jsx(me,{size:14}),"Documents in this category require admin approval before becoming visible."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"doc-description",children:"Description"}),e.jsx("textarea",{id:"doc-description",value:E,onChange:s=>z(s.target.value),placeholder:"Optional description...",rows:3,disabled:N})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Visibility"}),e.jsx("div",{className:"visibility-options",children:Object.entries(Fe).map(([s,{label:P,description:K}])=>e.jsxs("label",{className:`visibility-option ${v===s?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"visibility",value:s,checked:v===s,onChange:W=>O(W.target.value),disabled:N}),e.jsxs("div",{className:"visibility-content",children:[e.jsx("span",{className:"visibility-label",children:P}),e.jsx("span",{className:"visibility-desc",children:K})]})]},s))})]})]})]}),e.jsx("div",{className:"modal-footer",children:N?e.jsxs("div",{className:"upload-progress",children:[e.jsx(L,{size:20,className:"spinner"}),e.jsx("span",{children:k})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:S,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:M,disabled:!x||!g.trim(),children:[e.jsx(ne,{size:18}),"Upload Document"]})]})})]})})}const Xe=t=>{if(!t)return"0 B";const h=["B","KB","MB","GB"];let c=t,o=0;for(;c>=1024&&o<h.length-1;)c/=1024,o++;return`${c.toFixed(c<10?1:0)} ${h[o]}`},je=t=>t?new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"";function Je({document:t,onBack:h,onUpdate:c,onShowToast:o,isOfficeOrAdmin:S}){const[i,V]=l.useState(t),[x,d]=l.useState([]),[R,_]=l.useState(!0),[N,D]=l.useState(!1),[k,y]=l.useState(""),[C,p]=l.useState(!1),g=ze.find(r=>r.id===i.category),w=Fe[i.visibility],E=i.approval_status==="pending",z=i.approval_status==="rejected",b=S;l.useEffect(()=>{j()},[i.id]);const j=async()=>{_(!0);try{const r=await f.getDocumentVersions(i.id);d(r)}catch(r){console.error("Error loading versions:",r)}finally{_(!1)}},v=async()=>{await f.logDocumentAccess(i.id,"downloaded");const r=`undefined/storage/v1/object/public/project-documents/${i.storage_path}`;window.open(r,"_blank")},O=async()=>{p(!0);try{await f.approveDocument(i.id),V(r=>({...r,approval_status:"approved"})),o?.("Document approved","success"),c?.()}catch(r){console.error("Error approving document:",r),o?.("Failed to approve document","error")}finally{p(!1)}},A=async()=>{if(!k.trim()){o?.("Please provide a reason for rejection","error");return}p(!0);try{await f.rejectDocument(i.id,k.trim()),V(r=>({...r,approval_status:"rejected",rejection_reason:k.trim()})),D(!1),y(""),o?.("Document rejected","success"),c?.()}catch(r){console.error("Error rejecting document:",r),o?.("Failed to reject document","error")}finally{p(!1)}},U=async()=>{if(confirm("Are you sure you want to archive this document?")){p(!0);try{await f.archiveDocument(i.id),o?.("Document archived","success"),h(),c?.()}catch(r){console.error("Error archiving document:",r),o?.("Failed to archive document","error")}finally{p(!1)}}};return e.jsxs("div",{className:"document-detail",children:[e.jsxs("div",{className:"document-detail-header",children:[e.jsxs("button",{className:"back-btn",onClick:h,children:[e.jsx(Ne,{size:20}),"Back"]}),e.jsxs("div",{className:"document-detail-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:v,children:[e.jsx(Z,{size:18}),"Download"]}),S&&e.jsxs("button",{className:"btn btn-secondary btn-danger",onClick:U,disabled:C,children:[e.jsx(ye,{size:18}),"Archive"]})]})]}),e.jsxs("div",{className:"document-detail-content",children:[e.jsxs("div",{className:"document-detail-main",children:[e.jsxs("div",{className:"document-detail-title",children:[e.jsx("h2",{children:i.name}),i.version>1&&e.jsxs("span",{className:"version-badge",children:["v",i.version]})]}),(E||z)&&e.jsxs("div",{className:"document-detail-status",children:[E&&e.jsxs("div",{className:"status-banner pending",children:[e.jsx(we,{size:18}),e.jsx("span",{children:"Pending Approval"}),b&&e.jsxs("div",{className:"status-actions",children:[e.jsxs("button",{className:"btn btn-sm btn-success",onClick:O,disabled:C,children:[e.jsx(Ce,{size:16}),"Approve"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:()=>D(!0),disabled:C,children:[e.jsx(se,{size:16}),"Reject"]})]})]}),z&&e.jsxs("div",{className:"status-banner rejected",children:[e.jsx(se,{size:18}),e.jsxs("div",{className:"rejected-info",children:[e.jsx("span",{children:"Rejected"}),i.rejection_reason&&e.jsx("p",{className:"rejection-reason",children:i.rejection_reason})]})]})]}),e.jsxs("div",{className:"document-detail-meta",children:[e.jsxs("div",{className:"meta-item",children:[e.jsx(te,{size:16}),e.jsx("span",{children:i.file_name})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(T,{size:16}),e.jsx("span",{children:g?.label||i.category})]}),e.jsx("div",{className:"meta-item",children:e.jsx("span",{className:"meta-size",children:Xe(i.file_size_bytes)})}),e.jsxs("div",{className:"meta-item",children:[e.jsx(Ee,{size:16}),e.jsx("span",{children:je(i.uploaded_at)})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(Pe,{size:16}),e.jsx("span",{children:i.uploaded_by_user?.email||"Unknown"})]}),e.jsxs("div",{className:"meta-item",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:w?.label||i.visibility})]})]}),i.description&&e.jsxs("div",{className:"document-detail-description",children:[e.jsx("h3",{children:"Description"}),e.jsx("p",{children:i.description})]}),i.resource_type&&i.resource_id&&e.jsxs("div",{className:"document-detail-linked",children:[e.jsxs("h3",{children:[e.jsx(Ie,{size:16}),"Linked To"]}),e.jsxs("p",{children:[i.resource_type==="cor"&&"Change Order Request",i.resource_type==="tm_ticket"&&"T&M Ticket",i.resource_type==="daily_report"&&"Daily Report"]})]})]}),e.jsxs("div",{className:"document-detail-sidebar",children:[e.jsx("h3",{children:"Version History"}),R?e.jsxs("div",{className:"versions-loading",children:[e.jsx(L,{size:20,className:"spinner"}),"Loading versions..."]}):x.length===0?e.jsx("p",{className:"versions-empty",children:"No version history"}):e.jsx("div",{className:"versions-list",children:x.map(r=>e.jsxs("div",{className:`version-item ${r.id===i.id?"current":""}`,children:[e.jsxs("div",{className:"version-info",children:[e.jsxs("span",{className:"version-number",children:["v",r.version,r.is_current&&e.jsx("span",{className:"current-badge",children:"Current"})]}),e.jsx("span",{className:"version-date",children:je(r.uploaded_at)}),e.jsx("span",{className:"version-user",children:r.uploaded_by_user?.email})]}),e.jsx("button",{className:"version-download",onClick:async()=>{await f.logDocumentAccess(r.id,"downloaded"),window.open(`undefined/storage/v1/object/public/project-documents/${r.storage_path}`,"_blank")},title:"Download this version",children:e.jsx(Z,{size:16})})]},r.id))}),S&&e.jsx("div",{className:"upload-version",children:e.jsx("p",{className:"upload-version-hint",children:'To upload a new version, use the main upload button and select "Replace existing document"'})})]})]}),N&&e.jsx("div",{className:"modal-overlay",onClick:()=>D(!1),children:e.jsxs("div",{className:"reject-modal",onClick:r=>r.stopPropagation(),children:[e.jsx("h3",{children:"Reject Document"}),e.jsx("p",{children:"Please provide a reason for rejection:"}),e.jsx("textarea",{value:k,onChange:r=>y(r.target.value),placeholder:"Enter reason...",rows:4}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-danger",onClick:A,disabled:!k.trim()||C,children:[C?e.jsx(L,{size:16,className:"spinner"}):e.jsx(se,{size:16}),"Reject Document"]})]})]})})]})}const ae=[{id:"folder",label:"Folder",icon:T},{id:"plans",label:"Plans",icon:Re},{id:"specs",label:"Specs",icon:te},{id:"permits",label:"Permits",icon:Ae},{id:"contracts",label:"Contracts",icon:Me},{id:"submittals",label:"Submittals",icon:Le},{id:"rfis",label:"RFIs",icon:Oe},{id:"photos",label:"Photos",icon:Ue},{id:"reports",label:"Reports",icon:$e},{id:"safety",label:"Safety",icon:Be}],le=[{id:"blue",label:"Blue",hex:"#3b82f6"},{id:"green",label:"Green",hex:"#10b981"},{id:"yellow",label:"Yellow",hex:"#f59e0b"},{id:"red",label:"Red",hex:"#ef4444"},{id:"purple",label:"Purple",hex:"#8b5cf6"},{id:"pink",label:"Pink",hex:"#ec4899"},{id:"orange",label:"Orange",hex:"#f97316"},{id:"gray",label:"Gray",hex:"#6b7280"}];function Ze({projectId:t,companyId:h,folders:c,onFoldersChange:o,onClose:S,onShowToast:i}){const[V,x]=l.useState(!1),[d,R]=l.useState(null),[_,N]=l.useState(null),[D,k]=l.useState(!1),[y,C]=l.useState(""),[p,g]=l.useState("folder"),[w,E]=l.useState("blue"),[z,b]=l.useState(""),j=()=>{C(""),g("folder"),E("blue"),b(""),R(null)},v=()=>{j(),x(!0)},O=a=>{C(a.name),g(a.icon||"folder"),E(a.color||"blue"),b(a.description||""),R(a),x(!0)},A=async a=>{if(a.preventDefault(),!y.trim()){i?.("Please enter a folder name","error");return}k(!0);try{if(d)await f.updateFolder(d.id,{name:y.trim(),icon:p,color:w,description:z.trim()||null}),i?.("Folder updated","success");else{const F=Math.max(0,...c.map(M=>M.sort_order||0));await f.createFolder(h,t,{name:y.trim(),icon:p,color:w,description:z.trim()||null,sort_order:F+1}),i?.("Folder created","success")}x(!1),j(),o?.()}catch(F){console.error("Error saving folder:",F),F.message?.includes("duplicate key")||F.code==="23505"?i?.("A folder with this name already exists","error"):i?.("Failed to save folder","error")}finally{k(!1)}},U=async a=>{if(confirm(`Delete "${a.name}"? Documents in this folder will be moved to Unfiled.`)){N(a.id);try{await f.deleteFolder(a.id),i?.("Folder deleted","success"),o?.()}catch(F){console.error("Error deleting folder:",F),i?.("Failed to delete folder","error")}finally{N(null)}}},r=ae.find(a=>a.id===p),$=le.find(a=>a.id===w);return e.jsxs("div",{className:"folder-manager",children:[e.jsxs("div",{className:"folder-manager-header",children:[e.jsx("h3",{children:"Manage Folders"}),e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:v,children:[e.jsx(re,{size:16}),"New Folder"]})]}),e.jsx("div",{className:"folder-manager-list",children:c.length===0?e.jsxs("div",{className:"folder-manager-empty",children:[e.jsx(T,{size:40}),e.jsx("p",{children:"No folders created yet"}),e.jsx("button",{className:"btn btn-secondary",onClick:v,children:"Create First Folder"})]}):c.map(a=>{const F=ae.find(I=>I.id===a.icon)?.icon||T,M=le.find(I=>I.id===a.color)?.hex||"#3b82f6";return e.jsxs("div",{className:"folder-manager-item",children:[e.jsx("div",{className:"folder-manager-item-drag",children:e.jsx(Ve,{size:16})}),e.jsx("div",{className:"folder-manager-item-icon",style:{backgroundColor:`${M}15`},children:e.jsx(F,{size:20,style:{color:M}})}),e.jsxs("div",{className:"folder-manager-item-info",children:[e.jsx("span",{className:"folder-manager-item-name",children:a.name}),e.jsxs("span",{className:"folder-manager-item-count",children:[a.document_count||0," documents"]})]}),e.jsxs("div",{className:"folder-manager-item-actions",children:[e.jsx("button",{className:"folder-action-btn",onClick:()=>O(a),title:"Edit folder",children:e.jsx(Ge,{size:16})}),e.jsx("button",{className:"folder-action-btn danger",onClick:()=>U(a),disabled:_===a.id,title:"Delete folder",children:_===a.id?e.jsx(L,{size:16,className:"spinner"}):e.jsx(Te,{size:16})})]})]},a.id)})}),V&&e.jsx("div",{className:"modal-overlay",onClick:()=>x(!1),children:e.jsxs("div",{className:"folder-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"folder-modal-header",children:[e.jsx("h3",{children:d?"Edit Folder":"Create Folder"}),e.jsx("button",{className:"modal-close",onClick:()=>x(!1),children:e.jsx(Y,{size:20})})]}),e.jsxs("form",{onSubmit:A,children:[e.jsxs("div",{className:"folder-modal-content",children:[e.jsxs("div",{className:"folder-preview",children:[e.jsx("div",{className:"folder-preview-icon",style:{backgroundColor:`${$?.hex}15`},children:r&&e.jsx(r.icon,{size:40,style:{color:$?.hex}})}),e.jsx("span",{className:"folder-preview-name",children:y||"Folder Name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-name",children:"Folder Name *"}),e.jsx("input",{id:"folder-name",type:"text",value:y,onChange:a=>C(a.target.value),placeholder:"e.g., Site Plans, Safety Documents",autoFocus:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Icon"}),e.jsx("div",{className:"folder-icon-grid",children:ae.map(a=>e.jsx("button",{type:"button",className:`folder-icon-option ${p===a.id?"selected":""}`,onClick:()=>g(a.id),title:a.label,children:e.jsx(a.icon,{size:20})},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Color"}),e.jsx("div",{className:"folder-color-grid",children:le.map(a=>e.jsx("button",{type:"button",className:`folder-color-option ${w===a.id?"selected":""}`,onClick:()=>E(a.id),style:{backgroundColor:a.hex},title:a.label},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"folder-desc",children:"Description (optional)"}),e.jsx("input",{id:"folder-desc",type:"text",value:z,onChange:a=>b(a.target.value),placeholder:"Brief description of folder contents"})]})]}),e.jsxs("div",{className:"folder-modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>x(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!y.trim()||D,children:D?e.jsxs(e.Fragment,{children:[e.jsx(L,{size:16,className:"spinner"}),"Saving..."]}):d?"Save Changes":"Create Folder"})]})]})]})})]})}const fe=t=>t?.startsWith("image/")?Qe:t?.includes("spreadsheet")||t?.includes("excel")?Ye:t?.includes("pdf")?te:ge,be=t=>{if(!t)return"0 B";const h=["B","KB","MB","GB"];let c=t,o=0;for(;c>=1024&&o<h.length-1;)c/=1024,o++;return`${c.toFixed(c<10?1:0)} ${h[o]}`},ve=t=>t?new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",J={blue:"#3b82f6",green:"#10b981",yellow:"#f59e0b",red:"#ef4444",purple:"#8b5cf6",pink:"#ec4899",gray:"#6b7280",orange:"#f97316"};function is({project:t,companyId:h,onShowToast:c,userRole:o}){const[S,i]=l.useState([]),[V,x]=l.useState(!0),[d,R]=l.useState(null),[_,N]=l.useState([]),[D,k]=l.useState(!1),[y,C]=l.useState(!1),[p,g]=l.useState(0),[w,E]=l.useState(0),[z,b]=l.useState(""),[j,v]=l.useState(null),[O,A]=l.useState(!1),[U,r]=l.useState(!1),[$,a]=l.useState(!1),[F,M]=l.useState(null),[I,s]=l.useState(null),P=o==="office"||o==="administrator",K=o==="foreman",W=l.useRef(null),B=l.useCallback(async()=>{x(!0);try{const n=await f.getProjectFolders(t.id);i(n)}catch(n){console.error("Error loading folders:",n),c?.("Failed to load folders","error")}finally{x(!1)}},[t.id,c]);l.useEffect(()=>{B();const n=f.subscribeToDocumentFolders?.(t.id,()=>{B()}),m=f.subscribeToDocuments?.(t.id,()=>{B(),W.current&&G(W.current,!0)});return()=>{n?.unsubscribe?.(),m?.unsubscribe?.()}},[B,t.id]);const G=async(n,m=!1)=>{m&&(g(0),k(!0));try{const u=m?0:p,Q=await f.getFolderDocuments(n.id,{page:u,limit:qe});N(m?Q.documents:X=>[...X,...Q.documents]),E(Q.totalCount),C(Q.hasMore)}catch(u){console.error("Error loading documents:",u),c?.("Failed to load documents","error")}finally{k(!1)}},De=n=>{R(n),W.current=n,b(""),v(null),G(n,!0)},ke=()=>{R(null),W.current=null,N([]),v(null),b("")},ce=l.useCallback(async n=>{if(!n.trim()){v(null);return}A(!0);try{const m=await f.searchDocuments(t.id,n.trim());v(m)}catch(m){console.error("Error searching documents:",m)}finally{A(!1)}},[t.id]),q=l.useRef(null),oe=l.useCallback(n=>{b(n),q.current&&clearTimeout(q.current),q.current=setTimeout(()=>{ce(n)},300)},[ce]);l.useEffect(()=>()=>{q.current&&clearTimeout(q.current)},[]);const de=()=>{r(!1),s(null),B(),d&&G(d,!0),c?.("Document uploaded successfully","success")},H=async(n,m)=>{try{switch(n){case"view":M(m);break;case"download":await f.logDocumentAccess(m.id,"downloaded"),window.open(m.url||`undefined/storage/v1/object/public/project-documents/${m.storage_path}`,"_blank");break;case"archive":await f.archiveDocument(m.id),d&&G(d,!0),B(),c?.("Document archived","success");break;case"approve":await f.approveDocument(m.id),d&&G(d,!0),c?.("Document approved","success");break;default:break}}catch(u){console.error("Error performing action:",u),c?.("Action failed","error")}},ee=n=>{s(n),r(!0)};if(K)return e.jsx(Se,{projectId:t.id,onShowToast:c});if(F)return e.jsx(Je,{document:F,onBack:()=>M(null),onUpdate:()=>{d&&G(d,!0),B()},onShowToast:c,isOfficeOrAdmin:P});if(V)return e.jsx("div",{className:"docs-container",children:e.jsxs("div",{className:"docs-loading",children:[e.jsx(L,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading documents..."})]})});if(d){const n=J[d.color]||J.blue,m=j!==null?j:_;return e.jsxs("div",{className:"docs-container",children:[e.jsxs("div",{className:"docs-folder-header",children:[e.jsxs("button",{className:"docs-back-btn",onClick:ke,children:[e.jsx(Ne,{size:18}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"docs-folder-info",children:[e.jsx("div",{className:"docs-folder-icon",style:{backgroundColor:`${n}15`},children:e.jsx(T,{size:20,style:{color:n}})}),e.jsxs("div",{children:[e.jsx("h2",{className:"docs-folder-name",children:d.name}),e.jsxs("span",{className:"docs-folder-count",children:[w," files"]})]})]}),e.jsxs("button",{className:"docs-upload-btn",onClick:()=>ee(d),children:[e.jsx(ne,{size:18}),e.jsx("span",{children:"Upload"})]})]}),e.jsx("div",{className:"docs-search-wrapper",children:e.jsxs("div",{className:"docs-search",children:[e.jsx(ue,{size:16}),e.jsx("input",{type:"text",placeholder:"Search in folder...",value:z,onChange:u=>oe(u.target.value)}),z&&e.jsx("button",{onClick:()=>{b(""),v(null)},children:e.jsx(Y,{size:16})}),O&&e.jsx(L,{size:16,className:"spinner"})]})}),j!==null&&e.jsxs("div",{className:"docs-search-info",children:[e.jsxs("span",{children:[j.length," result",j.length!==1?"s":"",' for "',z,'"']}),e.jsx("button",{onClick:()=>{b(""),v(null)},children:"Clear"})]}),e.jsx("div",{className:"docs-list",children:D?e.jsxs("div",{className:"docs-loading",children:[e.jsx(L,{size:24,className:"spinner"}),e.jsx("span",{children:"Loading..."})]}):m.length===0?e.jsxs("div",{className:"docs-empty",children:[e.jsx(T,{size:48,style:{color:n,opacity:.3}}),e.jsx("h3",{children:j!==null?"No results":"Empty folder"}),e.jsx("p",{children:j!==null?"Try a different search term.":"Upload your first document."}),j===null&&e.jsxs("button",{className:"docs-empty-btn",onClick:()=>ee(d),children:[e.jsx(ne,{size:16}),"Upload Document"]})]}):e.jsxs(e.Fragment,{children:[m.map(u=>{const Q=fe(u.mime_type),X=u.approval_status==="pending";return e.jsxs("div",{className:`docs-item ${X?"pending":""}`,children:[e.jsx("div",{className:"docs-item-icon",children:e.jsx(Q,{size:20})}),e.jsxs("div",{className:"docs-item-info",children:[e.jsxs("span",{className:"docs-item-name",children:[u.name,u.version>1&&e.jsxs("span",{className:"docs-item-version",children:["v",u.version]})]}),e.jsxs("span",{className:"docs-item-meta",children:[be(u.file_size_bytes)," · ",ve(u.uploaded_at)]})]}),X&&e.jsx("span",{className:"docs-badge pending",children:"Pending"}),e.jsxs("div",{className:"docs-item-actions",children:[e.jsx("button",{onClick:()=>H("view",u),title:"View",children:e.jsx(ie,{size:16})}),e.jsx("button",{onClick:()=>H("download",u),title:"Download",children:e.jsx(Z,{size:16})}),X&&e.jsx("button",{className:"approve",onClick:()=>H("approve",u),title:"Approve",children:e.jsx(Ce,{size:16})}),e.jsx("button",{className:"danger",onClick:()=>H("archive",u),title:"Archive",children:e.jsx(ye,{size:16})})]})]},u.id)}),y&&j===null&&e.jsxs("button",{className:"docs-load-more",onClick:()=>{g(u=>u+1),G(d,!1)},disabled:D,children:["Load More (",_.length," of ",w,")"]})]})}),U&&e.jsx(pe,{projectId:t.id,companyId:h,folderId:I?.id,folderName:I?.name,onClose:()=>{r(!1),s(null)},onUploadComplete:de,onShowToast:c})]})}return e.jsxs("div",{className:"docs-container",children:[e.jsxs("div",{className:"docs-header",children:[e.jsxs("div",{className:"docs-search",children:[e.jsx(ue,{size:16}),e.jsx("input",{type:"text",placeholder:"Search documents...",value:z,onChange:n=>oe(n.target.value)}),z&&e.jsx("button",{onClick:()=>{b(""),v(null)},children:e.jsx(Y,{size:16})}),O&&e.jsx(L,{size:16,className:"spinner"})]}),e.jsxs("button",{className:"docs-manage-btn",onClick:()=>a(!0),children:[e.jsx(We,{size:18}),e.jsx("span",{children:"Manage"})]})]}),j!==null?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"docs-search-info",children:[e.jsxs("span",{children:[j.length," result",j.length!==1?"s":""]}),e.jsx("button",{onClick:()=>{b(""),v(null)},children:"Clear"})]}),e.jsx("div",{className:"docs-list",children:j.map(n=>{const m=fe(n.mime_type);return e.jsxs("div",{className:"docs-item",children:[e.jsx("div",{className:"docs-item-icon",children:e.jsx(m,{size:20})}),e.jsxs("div",{className:"docs-item-info",children:[e.jsx("span",{className:"docs-item-name",children:n.name}),e.jsxs("span",{className:"docs-item-meta",children:[be(n.file_size_bytes)," · ",ve(n.uploaded_at)]})]}),e.jsxs("div",{className:"docs-item-actions",children:[e.jsx("button",{onClick:()=>H("view",n),children:e.jsx(ie,{size:16})}),e.jsx("button",{onClick:()=>H("download",n),children:e.jsx(Z,{size:16})})]})]},n.id)})})]}):e.jsx("div",{className:"docs-grid",children:S.length===0?e.jsxs("div",{className:"docs-empty-state",children:[e.jsx(He,{size:56}),e.jsx("h3",{children:"No folders yet"}),e.jsx("p",{children:"Create folders to organize your documents"}),e.jsxs("button",{onClick:()=>a(!0),children:[e.jsx(re,{size:18}),"Create Folder"]})]}):S.map(n=>{const m=J[n.color]||J.blue;return e.jsxs("div",{className:"docs-folder-card",onClick:()=>De(n),children:[e.jsx("div",{className:"docs-folder-card-icon",style:{backgroundColor:`${m}12`},children:e.jsx(T,{size:28,style:{color:m}})}),e.jsxs("div",{className:"docs-folder-card-content",children:[e.jsx("span",{className:"docs-folder-card-name",children:n.name}),e.jsxs("span",{className:"docs-folder-card-count",children:[n.document_count||0," ",n.document_count===1?"file":"files"]})]}),e.jsx("button",{className:"docs-folder-card-upload",onClick:u=>{u.stopPropagation(),ee(n)},title:"Upload",children:e.jsx(re,{size:18})})]},n.id)})}),$&&e.jsx("div",{className:"modal-overlay",onClick:()=>a(!1),children:e.jsxs("div",{className:"docs-manager-modal",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"docs-manager-header",children:[e.jsx("h2",{children:"Manage Folders"}),e.jsx("button",{onClick:()=>a(!1),children:e.jsx(Y,{size:20})})]}),e.jsx(Ze,{projectId:t.id,companyId:h,folders:S,onFoldersChange:B,onClose:()=>a(!1),onShowToast:c})]})}),U&&e.jsx(pe,{projectId:t.id,companyId:h,folderId:I?.id,folderName:I?.name,onClose:()=>{r(!1),s(null)},onUploadComplete:de,onShowToast:c})]})}export{is as default};
//# sourceMappingURL=DocumentsTab-2eI3a0ek.js.map
