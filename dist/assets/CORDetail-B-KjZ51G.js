const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BuWOXVN7.js","assets/icons-Ng3QClhp.js","assets/react-DXGY7bZi.js","assets/pdf-aQqpMATS.js","assets/supabase-VuevzHjS.js","assets/index-Ct9GPi7W.css","assets/corPdfGenerator-C0C2MHF7.js","assets/corCalculations-BdV1IoSP.js"])))=>i.map(i=>d[i]);
import{aq as P,aK as E,aF as me,ar as C,as as e}from"./index-BuWOXVN7.js";import{r as f,C as xe,X as $,as as ge,b as je,F as B,Q as Z,N as ee,ag as be,l as Ne,B as fe,ay as ye,a as ve,aq as ke,q as Ce,y as Ee,O as Re,I as we,az as V,aA as Oe,a5 as se,P as De,j as Ie,g as Se,D as ae}from"./icons-Ng3QClhp.js";import{c as Pe,j as ze,a as qe,f as h,b as L,d as w,k as I}from"./corCalculations-BdV1IoSP.js";import{_ as H}from"./pdf-aQqpMATS.js";import{S as Fe,e as Te}from"./SignatureCanvas-DrLwfeKW.js";import{e as Ae}from"./Dashboard-dLi9EpOJ.js";import Le from"./SignatureLinkGenerator-BvBvM_oI.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";const S={PENDING:"pending",GENERATING:"generating",COMPLETED:"completed",FAILED:"failed"},Me={PDF:"pdf"};function Ue(t,l,d=null){if(d)return`custom_${d}`;const g=Math.floor(Date.now()/6e4);return`cor_${t}_v${l||1}_${g}`}function Ge(t){return`cor_${t}_force_${Date.now()}`}function $e(t,l,d={}){const g=new Date().toISOString(),j=[];let v=0;for(const r of l||[]){const n=r.photos||[];v+=n.length;for(const M of n)j.push({ticketId:r.id,workDate:r.work_date,url:M,verified:!1,includedInExport:!0})}const i=(t.change_order_labor||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0),c=(t.change_order_materials||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0),u=(t.change_order_equipment||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0),m=(t.change_order_subcontractors||[]).reduce((r,n)=>r+(parseInt(n.total)||0),0);let _=0,a=0;for(const r of l||[])for(const n of r.t_and_m_workers||[])_+=parseFloat(n.hours)||0,a+=parseFloat(n.overtime_hours)||0;const x=JSON.stringify({corId:t.id,version:t.version,totals:{laborTotal:i,materialsTotal:c,equipmentTotal:u,subcontractorsTotal:m},ticketCount:l?.length||0,photoCount:v});let N=0;for(let r=0;r<x.length;r++){const n=x.charCodeAt(r);N=(N<<5)-N+n,N=N&N}const k=Math.abs(N).toString(16).padStart(16,"0");return{snapshotId:crypto.randomUUID(),corId:t.id,corVersion:t.version||1,createdAt:g,checksum:k,corData:{id:t.id,cor_number:t.cor_number,title:t.title,description:t.description,scope_of_work:t.scope_of_work,status:t.status,period_start:t.period_start,period_end:t.period_end,change_order_labor:t.change_order_labor||[],change_order_materials:t.change_order_materials||[],change_order_equipment:t.change_order_equipment||[],change_order_subcontractors:t.change_order_subcontractors||[],labor_markup_percent:t.labor_markup_percent,materials_markup_percent:t.materials_markup_percent,equipment_markup_percent:t.equipment_markup_percent,subcontractors_markup_percent:t.subcontractors_markup_percent,liability_insurance_percent:t.liability_insurance_percent,bond_percent:t.bond_percent,license_fee_percent:t.license_fee_percent,labor_subtotal:t.labor_subtotal,materials_subtotal:t.materials_subtotal,equipment_subtotal:t.equipment_subtotal,subcontractors_subtotal:t.subcontractors_subtotal,labor_markup_amount:t.labor_markup_amount,materials_markup_amount:t.materials_markup_amount,equipment_markup_amount:t.equipment_markup_amount,subcontractors_markup_amount:t.subcontractors_markup_amount,liability_insurance_amount:t.liability_insurance_amount,bond_amount:t.bond_amount,license_fee_amount:t.license_fee_amount,cor_subtotal:t.cor_subtotal,additional_fees_total:t.additional_fees_total,cor_total:t.cor_total,gc_signature_data:t.gc_signature_data,gc_signature_name:t.gc_signature_name,gc_signature_date:t.gc_signature_date,created_at:t.created_at,submitted_at:t.submitted_at,approved_at:t.approved_at},ticketsData:(l||[]).map(r=>({id:r.id,work_date:r.work_date,ticket_date:r.ticket_date,ce_pco_number:r.ce_pco_number,notes:r.notes,status:r.status,created_at:r.created_at,t_and_m_workers:(r.t_and_m_workers||[]).map(n=>({id:n.id,name:n.name,role:n.role,labor_class:n.labor_class,hours:n.hours,overtime_hours:n.overtime_hours,time_started:n.time_started,time_ended:n.time_ended})),t_and_m_items:(r.t_and_m_items||[]).map(n=>({id:n.id,description:n.description,quantity:n.quantity,unit:n.unit,materials_equipment:n.materials_equipment})),photos:r.photos||[],client_signature_data:r.client_signature_data,client_signature_name:r.client_signature_name,client_signature_title:r.client_signature_title,client_signature_company:r.client_signature_company,client_signature_date:r.client_signature_date})),photoManifest:j,totals:{laborTotal:i,materialsTotal:c,equipmentTotal:u,subcontractorsTotal:m,totalLaborHours:_,totalOTHours:a,ticketCount:l?.length||0,photoCount:v,verifiedTicketCount:(l||[]).filter(r=>r.client_signature_data).length}}}async function Be(t,l={}){const{forceNew:d=!1,idempotencyKey:g=null,exportType:j=Me.PDF,includeBackup:v=!0}=l;try{const{data:i,error:c}=await E.from("change_orders").select("id, version, cor_number").eq("id",t).single();if(c||!i)throw new Error(`COR not found: ${t}`);const u=d?Ge(t):g||Ue(t,i.version),{data:m,error:_}=await E.rpc("request_cor_export",{p_cor_id:t,p_idempotency_key:u,p_options:{exportType:j,includeBackup:v},p_requested_by:(await E.auth.getUser())?.data?.user?.id});if(_)throw _;const a=m?.[0];if(!a)throw new Error("Failed to create export job");return P.activity("cor_export_requested",{cor_id:t,job_id:a.job_id,is_new:a.is_new,status:a.status}),{jobId:a.job_id,status:a.status,isNew:a.is_new,snapshotId:a.snapshot_id,pdfUrl:a.pdf_url,idempotencyKey:u}}catch(i){throw P.error("cor_export_request_failed",{cor_id:t,error:i.message}),i}}async function K(t,l,d={}){const{data:g,error:j}=await E.rpc("update_export_job_status",{p_job_id:t,p_status:l,p_snapshot_id:d.snapshotId||null,p_pdf_url:d.pdfUrl||null,p_error:d.error||null,p_error_details:d.errorDetails||null,p_metrics:d.metrics||null});if(j)throw P.error("cor_export_job_update_failed",{job_id:t,status:l,error:j.message}),j;return g}async function Ve(t,l){await E.from("cor_export_snapshots").update({is_current:!1}).eq("cor_id",t.corId);const{data:d,error:g}=await E.from("cor_export_snapshots").insert({id:t.snapshotId,cor_id:t.corId,job_id:l,cor_version:t.corVersion,cor_data:t.corData,tickets_data:t.ticketsData,photos_manifest:t.photoManifest,totals_snapshot:t.totals,checksum:t.checksum,is_current:!0,exported_by:(await E.auth.getUser())?.data?.user?.id}).select().single();if(g)throw g;return await E.from("change_orders").update({last_snapshot_version:t.corVersion}).eq("id",t.corId),d}async function He(t,{cor:l,tickets:d,project:g,company:j,branding:v,options:i={}}={}){let c=null;try{if(c=await Be(t,i),c.status===S.COMPLETED&&c.pdfUrl)return P.activity("cor_export_cache_hit",{cor_id:t,job_id:c.jobId}),{success:!0,jobId:c.jobId,cached:!0,pdfUrl:c.pdfUrl};if(c.status===S.GENERATING)return{success:!0,jobId:c.jobId,status:S.GENERATING,message:"Export already in progress"};if(await K(c.jobId,S.GENERATING),!l){const{db:x}=await H(async()=>{const{db:N}=await import("./index-BuWOXVN7.js").then(k=>k.aV);return{db:N}},__vite__mapDeps([0,1,2,3,4,5]));l=await x.getCORById(t)}if(!d&&i.includeBackup!==!1){const{db:x}=await H(async()=>{const{db:N}=await import("./index-BuWOXVN7.js").then(k=>k.aV);return{db:N}},__vite__mapDeps([0,1,2,3,4,5]));d=await x.getCORTickets(t)}const u=$e(l,d,i),m=await Ve(u,c.jobId),{generatePDFFromSnapshot:_}=await H(async()=>{const{generatePDFFromSnapshot:x}=await import("./corPdfGenerator-C0C2MHF7.js");return{generatePDFFromSnapshot:x}},__vite__mapDeps([6,3,7,0,1,2,4,5])),a=await _(u,{project:g,company:j,branding:v});return await K(c.jobId,S.COMPLETED,{snapshotId:m.id,pdfUrl:a.fileName,metrics:{photo_count:u.totals.photoCount,ticket_count:u.totals.ticketCount,page_count:a.pageCount||1,pdf_size_bytes:a.sizeBytes||0}}),P.activity("cor_export_completed",{cor_id:t,job_id:c.jobId,photo_count:u.totals.photoCount,ticket_count:u.totals.ticketCount}),{success:!0,jobId:c.jobId,snapshotId:m.id,fileName:a.fileName,snapshot:u.totals}}catch(u){throw c?.jobId&&await K(c.jobId,S.FAILED,{error:u.message,errorDetails:{stack:u.stack}}).catch(()=>{}),P.error("cor_export_failed",{cor_id:t,job_id:c?.jobId,error:u.message}),u}}function as({cor:t,project:l,company:d,areas:g,onClose:j,onEdit:v,onShowToast:i,onStatusChange:c}){const{branding:u}=me(),[m,_]=f.useState(!0),[a,x]=f.useState(t),[N,k]=f.useState(!1),[r,n]=f.useState(!1),[M,te]=f.useState(new Set),[Q,U]=f.useState(null),[re,z]=f.useState(!1),[T,J]=f.useState(""),A=f.useCallback(async()=>{try{const s=await C.getCORById(t.id);s&&x(s)}catch(s){console.error("Error fetching COR details:",s),i?.("Error loading COR details","error")}finally{_(!1)}},[t.id]);f.useEffect(()=>{A()},[A]),f.useEffect(()=>{const s=C.subscribeToCorTickets?.(t.id,()=>{A()});return()=>{s&&C.unsubscribe?.(s)}},[t.id,A]);const b=f.useMemo(()=>Pe(a),[a]),G=ze(a.status),ne=a.status==="pending_approval",X=["draft","pending_approval","approved"].includes(a.status),W=s=>g?.find(y=>y.id===s)?.name||null,ie=async()=>{if(confirm("Approve this change order request?")){_(!0);try{await C.approveCOR(a.id),x({...a,status:"approved",approved_at:new Date().toISOString()}),i?.("COR approved","success"),c?.()}catch(s){console.error("Error approving COR:",s),i?.("Error approving COR","error")}finally{_(!1)}}},ce=async()=>{const s=prompt("Enter rejection reason (optional):");if(s!==null){_(!0);try{await C.rejectCOR(a.id,s),x({...a,status:"rejected",rejection_reason:s}),i?.("COR rejected","success"),c?.()}catch(o){console.error("Error rejecting COR:",o),i?.("Error rejecting COR","error")}finally{_(!1)}}},le=async()=>{if(confirm("Mark this COR as billed?")){_(!0);try{await C.markCORAsBilled(a.id),x({...a,status:"billed"}),i?.("COR marked as billed","success"),c?.()}catch(s){console.error("Error marking COR as billed:",s),i?.("Error updating status","error")}finally{_(!1)}}},oe=async s=>{_(!0);try{await C.saveCORSignature?.(a.id,{gc_signature:s.signature,gc_signer_name:s.signerName,signed_at:s.signedAt}),x({...a,gc_signature:s.signature,gc_signer_name:s.signerName,signed_at:s.signedAt}),k(!1),i?.("Signature saved","success"),c?.()}catch(o){console.error("Error saving signature:",o),i?.("Error saving signature","error")}finally{_(!1)}},de=a.status==="approved"&&!a.gc_signature,Y=async()=>{if(!T.trim()){z(!1);return}_(!0);try{await C.updateCOR(a.id,{cor_number:T.trim()}),x({...a,cor_number:T.trim()}),z(!1),i?.("COR number updated","success")}catch(s){console.error("Error updating COR number:",s),i?.("Error updating COR number","error")}finally{_(!1)}},ue=()=>{J(a.cor_number||""),z(!0)},_e=s=>{te(o=>{const y=new Set(o);return y.has(s)?y.delete(s):y.add(s),y})},O=f.useMemo(()=>a.change_order_ticket_associations?.map(s=>s.t_and_m_tickets).filter(Boolean)||[],[a.change_order_ticket_associations]),he=s=>{const o=s.t_and_m_workers||[],y=o.reduce((F,R)=>F+(parseFloat(R.hours)||0),0),q=o.reduce((F,R)=>F+(parseFloat(R.overtime_hours)||0),0);return{regular:y,overtime:q,total:y+q}},pe=async()=>{try{i?.("Generating PDF with backup...","info");const s={logoUrl:u?.logo_url||d?.logo_url,primaryColor:u?.primary_color};try{(await He(a.id,{cor:a,tickets:O,project:l,company:d,branding:s,options:{includeBackup:!0}})).cached?i?.("PDF downloaded (cached)","success"):i?.("PDF downloaded","success")}catch(o){console.warn("Export pipeline failed, falling back to direct PDF export:",o),await Te(a,l,d,s,O),i?.("PDF downloaded","success")}}catch(s){console.error("Error exporting PDF:",s),i?.("Error generating PDF","error")}};return m?e.jsx("div",{className:"modal-overlay",onClick:j,children:e.jsx("div",{className:"modal-content cor-detail-modal",onClick:s=>s.stopPropagation(),children:e.jsx("div",{className:"cor-detail-loading",children:"Loading COR details..."})})}):e.jsxs("div",{className:"modal-overlay",onClick:j,role:"dialog","aria-modal":"true","aria-labelledby":"cor-detail-title",children:[e.jsxs("div",{className:"modal-content cor-detail-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header cor-detail-header",children:[e.jsxs("div",{className:"cor-detail-title-row",children:[e.jsxs("div",{children:[e.jsx("div",{className:"cor-detail-number",children:re?e.jsxs("div",{className:"cor-number-edit",children:[e.jsx("input",{type:"text",value:T,onChange:s=>J(s.target.value),onKeyDown:s=>{s.key==="Enter"&&Y(),s.key==="Escape"&&z(!1)},autoFocus:!0,className:"cor-number-input"}),e.jsx("button",{className:"btn-icon-sm",onClick:Y,title:"Save",children:e.jsx(xe,{size:14})}),e.jsx("button",{className:"btn-icon-sm",onClick:()=>z(!1),title:"Cancel",children:e.jsx($,{size:14})})]}):e.jsxs("div",{className:"cor-number-display",children:[e.jsx("span",{children:a.cor_number}),X&&e.jsx("button",{className:"btn-icon-sm",onClick:ue,title:"Edit COR number",children:e.jsx(ge,{size:12})})]})}),e.jsx("h2",{id:"cor-detail-title",children:a.title||"Untitled COR"})]}),e.jsx("button",{className:"close-btn",onClick:j,"aria-label":"Close COR details",children:e.jsx($,{size:20,"aria-hidden":"true"})})]}),e.jsxs("div",{className:"cor-detail-meta",children:[e.jsx("span",{className:"cor-detail-status",style:{backgroundColor:G.bgColor,color:G.color},children:G.label}),a.group_name&&e.jsx("span",{className:"cor-detail-group",children:a.group_name}),W(a.area_id)&&e.jsx("span",{className:"cor-detail-area",children:W(a.area_id)}),e.jsxs("span",{className:"cor-detail-period",children:[e.jsx(je,{size:14})," ",qe(a.period_start,a.period_end)]})]})]}),e.jsxs("div",{className:"modal-body cor-detail-body",children:[e.jsxs("div",{className:"cor-detail-section",children:[e.jsxs("h3",{children:[e.jsx(B,{size:18})," Scope of Work"]}),e.jsx("p",{className:"cor-scope-text",children:a.scope_of_work||"No scope of work provided."})]}),e.jsxs("div",{className:"cor-detail-section pricing-breakdown",children:[e.jsxs("h3",{children:[e.jsx(Z,{size:18})," Pricing Breakdown"]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ee,{size:16}),e.jsx("span",{children:"Labor"})]}),e.jsx("span",{className:"category-subtotal",children:h(b.labor_subtotal)})]}),a.change_order_labor?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Class"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"Reg Rate"}),e.jsx("th",{children:"OT Hrs"}),e.jsx("th",{children:"OT Rate"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_labor.map((s,o)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.labor_class}),e.jsx("td",{children:s.wage_type}),e.jsx("td",{children:s.regular_hours}),e.jsxs("td",{children:["$",L(s.regular_rate),"/hr"]}),e.jsx("td",{children:s.overtime_hours||"-"}),e.jsx("td",{children:s.overtime_hours?`$${L(s.overtime_rate)}/hr`:"-"}),e.jsx("td",{className:"text-right",children:h(s.total)})]},o))})]})}):e.jsx("div",{className:"category-empty",children:"No labor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",w(a.labor_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",h(b.labor_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(be,{size:16}),e.jsx("span",{children:"Materials"})]}),e.jsx("span",{className:"category-subtotal",children:h(b.materials_subtotal)})]}),a.change_order_materials?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_materials.map((s,o)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{children:s.quantity}),e.jsx("td",{children:s.unit}),e.jsxs("td",{children:["$",L(s.unit_cost)]}),e.jsx("td",{className:"text-right",children:h(s.total)})]},o))})]})}):e.jsx("div",{className:"category-empty",children:"No material items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",w(a.materials_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",h(b.materials_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(Ne,{size:16}),e.jsx("span",{children:"Equipment"})]}),e.jsx("span",{className:"category-subtotal",children:h(b.equipment_subtotal)})]}),a.change_order_equipment?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Unit Cost"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:a.change_order_equipment.map((s,o)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{children:s.quantity}),e.jsx("td",{children:s.unit}),e.jsxs("td",{children:["$",L(s.unit_cost)]}),e.jsx("td",{className:"text-right",children:h(s.total)})]},o))})]})}):e.jsx("div",{className:"category-empty",children:"No equipment items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",w(a.equipment_markup_percent||1500),")"]}),e.jsxs("span",{children:["+",h(b.equipment_markup_amount)]})]})]}),e.jsxs("div",{className:"pricing-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(fe,{size:16}),e.jsx("span",{children:"Subcontractors"})]}),e.jsx("span",{className:"category-subtotal",children:h(b.subcontractors_subtotal)})]}),a.change_order_subcontractors?.length>0?e.jsx("div",{className:"category-items",children:e.jsxs("table",{className:"pricing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Company"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Source"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:a.change_order_subcontractors.map((s,o)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.company_name}),e.jsx("td",{children:s.description}),e.jsx("td",{children:s.source_reference||s.source_type}),e.jsx("td",{className:"text-right",children:h(s.total)})]},o))})]})}):e.jsx("div",{className:"category-empty",children:"No subcontractor items"}),e.jsxs("div",{className:"category-markup",children:[e.jsxs("span",{children:["Markup (",w(a.subcontractors_markup_percent||500),")"]}),e.jsxs("span",{children:["+",h(b.subcontractors_markup_amount)]})]})]}),e.jsxs("div",{className:"cor-subtotal-row",children:[e.jsx("span",{children:"COR Subtotal"}),e.jsx("span",{children:h(b.cor_subtotal)})]}),e.jsxs("div",{className:"pricing-category fees-category",children:[e.jsxs("div",{className:"category-header",children:[e.jsxs("div",{className:"category-title",children:[e.jsx(ye,{size:16}),e.jsx("span",{children:"Additional Fees"})]}),e.jsx("span",{className:"category-subtotal",children:h(b.additional_fees_total)})]}),e.jsxs("div",{className:"fees-list",children:[e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(ve,{size:14}),e.jsxs("span",{children:["Liability Insurance (",w(a.liability_insurance_percent||144),")"]})]}),e.jsx("span",{className:"fee-amount",children:h(b.liability_insurance_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(B,{size:14}),e.jsxs("span",{children:["Bond (",w(a.bond_percent||100),")"]})]}),e.jsx("span",{className:"fee-amount",children:h(b.bond_amount)})]}),e.jsxs("div",{className:"fee-row",children:[e.jsxs("div",{className:"fee-label",children:[e.jsx(ke,{size:14}),e.jsxs("span",{children:["City License Fee (",w(a.license_fee_percent||10),")"]})]}),e.jsx("span",{className:"fee-amount",children:h(b.license_fee_amount)})]})]})]}),e.jsxs("div",{className:"cor-total-row",children:[e.jsx("span",{children:"COR TOTAL"}),e.jsx("span",{children:h(b.cor_total)})]})]}),O.length>0&&e.jsxs("div",{className:"cor-detail-section backup-section",children:[e.jsxs("h3",{children:[e.jsx(B,{size:18})," Backup Documentation"]}),e.jsxs("p",{className:"backup-summary",children:[O.length," T&M ticket",O.length!==1?"s":""," associated with this COR"]}),e.jsx("div",{className:"backup-tickets-list",children:O.map(s=>{const o=M.has(s.id),y=he(s),q=s.t_and_m_workers?.length||0,F=s.t_and_m_items?.length||0,R=s.photos?.length||0;return e.jsxs("div",{className:"backup-ticket-card",children:[e.jsxs("div",{className:"backup-ticket-header",onClick:()=>_e(s.id),children:[e.jsx("div",{className:"backup-ticket-toggle",children:o?e.jsx(Ce,{size:18}):e.jsx(Ee,{size:18})}),e.jsxs("div",{className:"backup-ticket-info",children:[e.jsxs("div",{className:"backup-ticket-date",children:[e.jsx(Re,{size:14}),e.jsx("span",{children:I(s.work_date)})]}),s.ce_pco_number&&e.jsxs("span",{className:"backup-ticket-pco",children:["CE/PCO: ",s.ce_pco_number]})]}),e.jsxs("div",{className:"backup-ticket-stats",children:[e.jsxs("span",{className:"backup-stat",children:[e.jsx(ee,{size:14})," ",q]}),e.jsxs("span",{className:"backup-stat",children:[y.total.toFixed(1)," hrs"]}),R>0&&e.jsxs("span",{className:"backup-stat",children:[e.jsx(we,{size:14})," ",R]}),s.client_signature_data&&e.jsxs("span",{className:"backup-stat verified",title:`Verified by ${s.client_signature_name}`,children:[e.jsx(V,{size:14})," Verified"]})]}),e.jsx("span",{className:`backup-ticket-status status-${s.status}`,children:s.status})]}),o&&e.jsxs("div",{className:"backup-ticket-details",children:[s.notes&&e.jsxs("div",{className:"backup-ticket-notes",children:[e.jsx("strong",{children:"Notes:"})," ",s.notes]}),s.t_and_m_workers?.length>0&&e.jsxs("div",{className:"backup-workers",children:[e.jsxs("h4",{children:["Labor (",q," workers)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Time"}),e.jsx("th",{children:"Reg Hrs"}),e.jsx("th",{children:"OT Hrs"})]})}),e.jsx("tbody",{children:s.t_and_m_workers.map((p,D)=>e.jsxs("tr",{children:[e.jsx("td",{children:p.name}),e.jsx("td",{children:p.role||"-"}),e.jsx("td",{className:"backup-time-range",children:p.time_started&&p.time_ended?`${p.time_started} - ${p.time_ended}`:"-"}),e.jsx("td",{children:p.hours||0}),e.jsx("td",{children:p.overtime_hours||"-"})]},D))})]})]}),s.t_and_m_items?.length>0&&e.jsxs("div",{className:"backup-items",children:[e.jsxs("h4",{children:["Materials & Equipment (",F," items)"]}),e.jsxs("table",{className:"backup-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Qty"})]})}),e.jsx("tbody",{children:s.t_and_m_items.map((p,D)=>e.jsxs("tr",{children:[e.jsx("td",{children:p.custom_name||p.materials_equipment?.name||"Unnamed Item"}),e.jsx("td",{children:p.custom_category||p.materials_equipment?.category||"-"}),e.jsx("td",{children:p.quantity})]},D))})]})]}),s.photos?.length>0&&e.jsxs("div",{className:"backup-photos",children:[e.jsxs("h4",{children:["Photos (",R,")"]}),e.jsx("div",{className:"backup-photos-grid",children:s.photos.map((p,D)=>e.jsx("div",{className:"backup-photo-thumb",onClick:()=>U(p),children:e.jsx("img",{src:p,alt:`Photo ${D+1}`})},D))})]}),s.client_signature_data&&e.jsxs("div",{className:"backup-verification",children:[e.jsxs("h4",{children:[e.jsx(V,{size:14})," Client Verification"]}),e.jsxs("div",{className:"backup-signature-display",children:[e.jsx("img",{src:s.client_signature_data,alt:"Client Signature",className:"backup-signature-image"}),e.jsxs("div",{className:"backup-signature-info",children:[e.jsx("span",{className:"backup-signer-name",children:s.client_signature_name}),s.client_signature_title&&e.jsx("span",{className:"backup-signer-title",children:s.client_signature_title}),s.client_signature_company&&e.jsx("span",{className:"backup-signer-company",children:s.client_signature_company}),e.jsxs("span",{className:"backup-signed-date",children:["Verified: ",I(s.client_signature_date)]})]})]})]})]})]},s.id)})})]}),(a.gc_signature_data||a.gc_signature||a.client_signature_data)&&e.jsxs("div",{className:"cor-detail-section signature-section",children:[e.jsxs("h3",{children:[e.jsx(Oe,{size:18})," Signatures"]}),e.jsxs("div",{className:"dual-signatures",children:[(a.gc_signature_data||a.gc_signature)&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"GC Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.gc_signature_data||a.gc_signature,alt:"GC Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.gc_signature_name||a.gc_signer_name}),(a.gc_signature_title||a.gc_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.gc_signature_title,a.gc_signature_title&&a.gc_signature_company&&" - ",a.gc_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",I(a.gc_signature_date||a.signed_at)]})]})]})]}),a.client_signature_data&&e.jsxs("div",{className:"signature-block",children:[e.jsx("span",{className:"signature-label",children:"Client Authorization"}),e.jsxs("div",{className:"signature-display",children:[e.jsx("img",{src:a.client_signature_data,alt:"Client Signature",className:"signature-image"}),e.jsxs("div",{className:"signature-info",children:[e.jsx("span",{className:"signer-name",children:a.client_signature_name}),(a.client_signature_title||a.client_signature_company)&&e.jsxs("span",{className:"signer-org",children:[a.client_signature_title,a.client_signature_title&&a.client_signature_company&&" - ",a.client_signature_company]}),e.jsxs("span",{className:"signed-date",children:["Signed: ",I(a.client_signature_date)]})]})]})]})]})]}),a.status==="rejected"&&a.rejection_reason&&e.jsxs("div",{className:"cor-detail-section rejection-section",children:[e.jsxs("h3",{children:[e.jsx(se,{size:18})," Rejection Reason"]}),e.jsx("p",{className:"rejection-text",children:a.rejection_reason})]})]}),e.jsxs("div",{className:"modal-footer cor-detail-footer",children:[e.jsxs("div",{className:"footer-info",children:[e.jsxs("span",{children:["Created: ",I(a.created_at)]}),a.approved_at&&e.jsxs("span",{children:["Approved: ",I(a.approved_at)]})]}),e.jsxs("div",{className:"footer-actions",role:"group","aria-label":"COR actions",children:[X&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>v?.(a),disabled:m,"aria-label":"Edit this COR",children:[e.jsx(De,{size:16,"aria-hidden":"true"})," Edit"]}),ne&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:ce,disabled:m,"aria-label":"Reject this COR",children:[e.jsx(se,{size:16,"aria-hidden":"true"})," Reject"]}),e.jsxs("button",{className:"btn btn-success",onClick:ie,disabled:m,"aria-label":"Approve this COR",children:[e.jsx(Ie,{size:16,"aria-hidden":"true"})," Approve"]})]}),de&&e.jsxs("button",{className:"btn btn-success",onClick:()=>k(!0),disabled:m,"aria-label":"Get GC signature for this COR",children:[e.jsx(V,{size:16,"aria-hidden":"true"})," Get GC Signature"]}),(a.status==="approved"||a.status==="pending_approval")&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>n(!0),disabled:m,"aria-label":"Get shareable signature link",children:[e.jsx(Se,{size:16,"aria-hidden":"true"})," Get Signature Link"]}),a.status==="approved"&&e.jsxs("button",{className:"btn btn-primary",onClick:le,disabled:m,"aria-label":"Mark this COR as billed",children:[e.jsx(Z,{size:16,"aria-hidden":"true"})," Mark Billed"]}),e.jsxs("button",{className:"btn btn-ghost btn-small",onClick:()=>Ae(a),"aria-label":"Export COR to CSV",children:[e.jsx(ae,{size:16,"aria-hidden":"true"})," Export CSV"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:pe,"aria-label":"Export COR to PDF",children:[e.jsx(ae,{size:16,"aria-hidden":"true"})," Export PDF"]})]})]})]}),N&&e.jsx(Fe,{onSave:oe,onClose:()=>k(!1),signerName:""}),r&&e.jsx(Le,{documentType:"cor",documentId:a.id,companyId:d?.id,projectId:l?.id,documentTitle:`COR ${a.cor_number}: ${a.title||"Untitled"}`,onClose:()=>n(!1),onShowToast:i}),Q&&e.jsxs("div",{className:"photo-lightbox",onClick:()=>U(null),children:[e.jsx("button",{className:"lightbox-close",onClick:()=>U(null),children:e.jsx($,{size:24})}),e.jsx("img",{src:Q,alt:"Full size photo",onClick:s=>s.stopPropagation()})]})]})}export{as as default};
//# sourceMappingURL=CORDetail-B-KjZ51G.js.map
