const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/billingPackageGenerator-1R5w43DK.js","assets/pdf-aQqpMATS.js","assets/corCalculations-vdJc_BOT.js","assets/index-B5AOITmC.js","assets/icons-D1pGYcxw.js","assets/react-DXGY7bZi.js","assets/supabase-VuevzHjS.js","assets/index-BS9HnfBg.css"])))=>i.map(i=>d[i]);
import{_ as oe}from"./pdf-aQqpMATS.js";import{as as e,ar as E}from"./index-B5AOITmC.js";import{r as u,L as ue,ab as K,X as ee,n as ce,F as V,ah as Ne,Q as xe,T as fe,a6 as ye,O as _e,D as Q,ag as ke,N as Ce,j as de,s as we,c as me,u as pe,aE as he,aQ as De}from"./icons-D1pGYcxw.js";import{f as C,g as Se}from"./corCalculations-vdJc_BOT.js";import{t as se}from"./Dashboard-Cdkqn2Kg.js";import"./react-DXGY7bZi.js";import"./supabase-VuevzHjS.js";async function Fe(l,o,d){const{default:n}=await oe(async()=>{const{default:v}=await import("./pdf-aQqpMATS.js").then(D=>D.j);return{default:v}},[]),{default:a}=await oe(async()=>{const{default:v}=await import("./pdf-aQqpMATS.js").then(D=>D.c);return{default:v}},[]),s=new n("portrait"),b=s.internal.pageSize.width,j=s.internal.pageSize.height,i=20,h=[33,33,33],N=[59,130,246],f=[156,163,175],S=[229,231,235];let m=i;s.setFontSize(18),s.setFont(void 0,"bold"),s.setTextColor(...h),s.text(d?.name||"Company Name",i,m),s.setFontSize(9),s.setFont(void 0,"normal"),s.setTextColor(...f);const g=[];d?.phone&&g.push(d.phone),d?.email&&g.push(d.email),d?.address&&g.push(d.address);let T=m;g.forEach(v=>{s.text(v,b-i,T,{align:"right"}),T+=4}),m+=15,s.setFontSize(28),s.setFont(void 0,"bold"),s.setTextColor(...N),s.text("INVOICE",i,m),m+=15,s.setFontSize(10),s.setFont(void 0,"normal"),s.setTextColor(...h);const w=[["Invoice #:",l.invoice_number],["Invoice Date:",be(l.invoice_date)],["Due Date:",l.due_date?be(l.due_date):"Upon Receipt"],["Terms:",l.terms||"Net 30"]];let _=m;w.forEach(([v,D])=>{s.setFont(void 0,"bold"),s.text(v,i,_),s.setFont(void 0,"normal"),s.text(D,i+30,_),_+=5});const x=b/2;s.setFont(void 0,"bold"),s.setTextColor(...f),s.text("BILL TO",x,m),s.setFont(void 0,"normal"),s.setTextColor(...h);let P=m+5;l.bill_to_name&&(s.text(l.bill_to_name,x,P),P+=4),l.bill_to_address&&s.splitTextToSize(l.bill_to_address,80).forEach(D=>{s.text(D,x,P),P+=4}),l.bill_to_contact&&s.text(l.bill_to_contact,x,P),m=Math.max(_,P)+10,s.setFontSize(9),s.setTextColor(...f),s.text(`Project: ${o.name}${o.job_number?` (Job #${o.job_number})`:""}`,i,m),m+=10;const U=(l.invoice_items||[]).map((v,D)=>[D+1,v.reference_number||"-",v.description,C(v.amount)]);a(s,{startY:m,head:[["#","Ref","Description","Amount"]],body:U,theme:"plain",styles:{fontSize:9,cellPadding:4,textColor:h,lineColor:S,lineWidth:.1},headStyles:{fillColor:[249,250,251],textColor:h,fontStyle:"bold",lineWidth:{bottom:.5},lineColor:S},columnStyles:{0:{cellWidth:12,halign:"center"},1:{cellWidth:25},2:{cellWidth:"auto"},3:{cellWidth:30,halign:"right"}},alternateRowStyles:{fillColor:[255,255,255]},margin:{left:i,right:i}}),m=s.lastAutoTable.finalY+10;const O=b-i-80,z=b-i;if(s.setFontSize(10),s.setFont(void 0,"normal"),s.setTextColor(...h),s.text("Subtotal",O,m),s.text(C(l.subtotal),z,m,{align:"right"}),m+=6,l.retention_percent>0){const v=l.retention_percent/100;s.text(`Retention (${v}%)`,O,m),s.setTextColor(220,38,38),s.text(`-${C(l.retention_amount)}`,z,m,{align:"right"}),s.setTextColor(...h),m+=6}s.setDrawColor(...S),s.setLineWidth(.5),s.line(O-5,m,z,m),m+=6,s.setFontSize(12),s.setFont(void 0,"bold"),s.text("Total Due",O,m),s.setTextColor(...N),s.text(C(l.total),z,m,{align:"right"}),m+=15,l.notes&&(s.setFontSize(9),s.setFont(void 0,"bold"),s.setTextColor(...f),s.text("Notes:",i,m),m+=5,s.setFont(void 0,"normal"),s.setTextColor(...h),s.splitTextToSize(l.notes,b-i*2).forEach(D=>{s.text(D,i,m),m+=4}));const I=j-15;return s.setFontSize(8),s.setTextColor(...f),s.text(`Invoice ${l.invoice_number} | Generated ${new Date().toLocaleDateString()}`,i,I),s.setTextColor(180,180,180),s.text("Generated with FieldSync",b/2,I,{align:"center"}),s.setTextColor(...f),s.text("Page 1 of 1",b-i,I,{align:"right"}),s}async function Pe(l,o,d){const n=await Fe(l,o,d),a=`Invoice_${l.invoice_number}_${o.job_number||o.name.replace(/\s+/g,"_")}.pdf`;return n.save(a),a}function be(l){return l?new Date(l).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}):""}function Ee({project:l,company:o,user:d,selectedItems:n={cors:[],tickets:[]},onClose:a,onSuccess:s}){const[b,j]=u.useState(!0),[i,h]=u.useState(!1),[N,f]=u.useState(""),[S,m]=u.useState(new Date().toISOString().split("T")[0]),[g,T]=u.useState(""),[w,_]=u.useState(0),[x,P]=u.useState(""),[U,O]=u.useState("Net 30"),[z,I]=u.useState([]),[v,D]=u.useState({});u.useEffect(()=>{(async()=>{try{const c=new Date;c.setDate(c.getDate()+30),T(c.toISOString().split("T")[0]);const k=await E.getNextInvoiceNumber(o.id);f(k)}catch(c){console.error("Error initializing invoice:",c)}finally{j(!1)}})()},[o.id]);const $=u.useMemo(()=>{const r=[];return n.cors.forEach(c=>{r.push({id:c.id,item_type:"cor",reference_id:c.id,reference_number:c.cor_number,description:`COR ${c.cor_number}: ${c.title||"Change Order"}`,amount:c.cor_total||0})}),n.tickets.forEach(c=>{r.push({id:c.id,item_type:"tm_ticket",reference_id:c.id,reference_number:c.ce_pco_number||null,description:`T&M Ticket - ${new Date(c.work_date).toLocaleDateString()}`,amount:(parseFloat(c.change_order_value)||0)*100})}),z.forEach((c,k)=>{r.push({id:`manual-${k}`,item_type:"manual",reference_id:null,reference_number:null,description:c.description,amount:Se(parseFloat(c.amount)||0)})}),r},[n,z]),W=u.useMemo(()=>{const r=$.reduce((A,L)=>A+L.amount,0),c=Math.round(r*w/100),k=r-c;return{subtotal:r,retentionAmount:c,total:k}},[$,w]),le=()=>{I(r=>[...r,{description:"",amount:""}])},B=(r,c,k)=>{I(A=>{const L=[...A];return L[r]={...L[r],[c]:k},L})},G=r=>{I(c=>c.filter((k,A)=>A!==r))},ne=()=>{const r={};return N.trim()||(r.invoiceNumber="Invoice number is required"),S||(r.invoiceDate="Invoice date is required"),$.length===0&&(r.items="At least one line item is required"),z.forEach((c,k)=>{c.description.trim()||(r[`manual-${k}-desc`]="Description required"),(!c.amount||parseFloat(c.amount)<=0)&&(r[`manual-${k}-amount`]="Valid amount required")}),D(r),Object.keys(r).length===0},re=async()=>{if(ne()){h(!0);try{const r={project_id:l.id,company_id:o.id,invoice_number:N,invoice_date:S,due_date:g||null,status:"draft",retention_percent:w*100,bill_to_name:l.general_contractor||"",bill_to_address:l.address||"",notes:x||null,terms:U||"Net 30",created_by:d?.id},c=$.map(H=>({item_type:H.item_type,reference_id:H.item_type!=="manual"?H.reference_id:null,reference_number:H.reference_number,description:H.description,amount:H.amount})),k=await E.createInvoice(r,c),A=n.cors.map(H=>H.id),L=n.tickets.map(H=>H.id);await E.markItemsBilled(A,L),s?.(k)}catch(r){console.error("Error creating invoice:",r),D({submit:"Failed to create invoice. Please try again."})}finally{h(!1)}}};return b?e.jsx("div",{className:"modal-overlay",children:e.jsx("div",{className:"modal-content invoice-modal",children:e.jsxs("div",{className:"invoice-loading",children:[e.jsx(ue,{size:24,className:"spinning"}),e.jsx("span",{children:"Loading..."})]})})}):e.jsx("div",{className:"modal-overlay",onClick:a,children:e.jsxs("div",{className:"modal-content invoice-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:[e.jsx(K,{size:20}),"Create Invoice"]}),e.jsx("button",{className:"close-btn",onClick:a,"aria-label":"Close",children:e.jsx(ee,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"invoice-header-fields",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"invoice-number",children:"Invoice Number *"}),e.jsx("input",{id:"invoice-number",type:"text",value:N,onChange:r=>f(r.target.value),className:v.invoiceNumber?"error":""}),v.invoiceNumber&&e.jsx("span",{className:"form-error",children:v.invoiceNumber})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"invoice-date",children:"Invoice Date *"}),e.jsx("input",{id:"invoice-date",type:"date",value:S,onChange:r=>m(r.target.value),className:v.invoiceDate?"error":""})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"due-date",children:"Due Date"}),e.jsx("input",{id:"due-date",type:"date",value:g,onChange:r=>T(r.target.value)})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"bill-to",children:"Bill To"}),e.jsx("input",{id:"bill-to",type:"text",value:l.general_contractor||"",disabled:!0,className:"disabled"})]}),e.jsxs("div",{className:"form-group retention-group",children:[e.jsx("label",{htmlFor:"retention",children:"Retention %"}),e.jsxs("div",{className:"input-with-suffix",children:[e.jsx("input",{id:"retention",type:"number",min:"0",max:"100",step:"0.5",value:w,onChange:r=>_(parseFloat(r.target.value)||0)}),e.jsx("span",{className:"input-suffix",children:"%"})]})]})]})]}),e.jsxs("div",{className:"invoice-line-items",children:[e.jsxs("div",{className:"line-items-header",children:[e.jsx("h4",{children:"Line Items"}),e.jsxs("button",{type:"button",className:"btn btn-text btn-sm",onClick:le,children:[e.jsx(ce,{size:14}),"Add Item"]})]}),v.items&&e.jsx("div",{className:"form-error",children:v.items}),e.jsxs("div",{className:"line-items-table",children:[e.jsxs("div",{className:"line-items-table-header",children:[e.jsx("span",{className:"col-type",children:"Type"}),e.jsx("span",{className:"col-desc",children:"Description"}),e.jsx("span",{className:"col-amount",children:"Amount"}),e.jsx("span",{className:"col-action"})]}),$.map((r,c)=>e.jsxs("div",{className:"line-item-row",children:[e.jsxs("span",{className:"col-type",children:[r.item_type==="cor"&&e.jsx(V,{size:14}),r.item_type==="tm_ticket"&&e.jsx(V,{size:14}),r.item_type==="manual"&&e.jsx(ce,{size:14}),r.item_type==="cor"?"COR":r.item_type==="tm_ticket"?"T&M":"Manual"]}),r.item_type==="manual"?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",className:`col-desc ${v[`manual-${c-n.cors.length-n.tickets.length}-desc`]?"error":""}`,value:z[c-n.cors.length-n.tickets.length]?.description||"",onChange:k=>B(c-n.cors.length-n.tickets.length,"description",k.target.value),placeholder:"Description"}),e.jsxs("div",{className:"col-amount",children:[e.jsx("span",{className:"currency-prefix",children:"$"}),e.jsx("input",{type:"number",step:"0.01",min:"0",className:v[`manual-${c-n.cors.length-n.tickets.length}-amount`]?"error":"",value:z[c-n.cors.length-n.tickets.length]?.amount||"",onChange:k=>B(c-n.cors.length-n.tickets.length,"amount",k.target.value),placeholder:"0.00"})]}),e.jsx("button",{type:"button",className:"btn btn-icon btn-ghost col-action",onClick:()=>G(c-n.cors.length-n.tickets.length),children:e.jsx(Ne,{size:14})})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"col-desc",children:r.description}),e.jsx("span",{className:"col-amount",children:C(r.amount)}),e.jsx("span",{className:"col-action"})]})]},r.id))]}),e.jsxs("div",{className:"invoice-totals",children:[e.jsxs("div",{className:"total-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:C(W.subtotal)})]}),w>0&&e.jsxs("div",{className:"total-row retention",children:[e.jsxs("span",{children:["Retention (",w,"%)"]}),e.jsxs("span",{children:["-",C(W.retentionAmount)]})]}),e.jsxs("div",{className:"total-row grand-total",children:[e.jsx("span",{children:"Total Due"}),e.jsx("span",{children:C(W.total)})]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group flex-2",children:[e.jsx("label",{htmlFor:"notes",children:"Notes"}),e.jsx("textarea",{id:"notes",value:x,onChange:r=>P(r.target.value),rows:2,placeholder:"Additional notes for the client..."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"terms",children:"Payment Terms"}),e.jsxs("select",{id:"terms",value:U,onChange:r=>O(r.target.value),children:[e.jsx("option",{value:"Due on Receipt",children:"Due on Receipt"}),e.jsx("option",{value:"Net 15",children:"Net 15"}),e.jsx("option",{value:"Net 30",children:"Net 30"}),e.jsx("option",{value:"Net 45",children:"Net 45"}),e.jsx("option",{value:"Net 60",children:"Net 60"})]})]})]}),v.submit&&e.jsx("div",{className:"form-error submit-error",children:v.submit})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:a,disabled:i,children:"Cancel"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:re,disabled:i||$.length===0,children:i?e.jsxs(e.Fragment,{children:[e.jsx(ue,{size:16,className:"spinning"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{size:16}),"Create Invoice"]})})]})]})})}function He({companyId:l,projectId:o,onNavigate:d,onDismiss:n}){const[a,s]=u.useState(null),[b,j]=u.useState(!0),[i,h]=u.useState(!1);u.useEffect(()=>{N()},[l,o]);const N=async()=>{try{j(!0);const m=o?await E.getProjectUnbilledWork(o):await E.getUnbilledWork(l);s(m)}catch(m){console.error("Error loading unbilled work:",m)}finally{j(!1)}},f=()=>{h(!0),n?.()};if(b||i||!a||a.totalUnbilled===0)return null;const S=(a.cors?.length||0)+(a.tickets?.length||0);return e.jsxs("div",{className:"unbilled-work-alert",children:[e.jsx("div",{className:"unbilled-work-alert__icon",children:e.jsx(xe,{size:20})}),e.jsxs("div",{className:"unbilled-work-alert__content",children:[e.jsxs("div",{className:"unbilled-work-alert__title",children:[e.jsx(fe,{size:14}),"Unbilled Approved Work"]}),e.jsxs("div",{className:"unbilled-work-alert__description",children:["You have ",e.jsx("strong",{children:C(a.totalUnbilled)})," in approved work that hasn't been invoiced (",S," item",S!==1?"s":"",": ",a.cors?.length||0," COR",(a.cors?.length||0)!==1?"s":"",", ",a.tickets?.length||0," T&M ticket",(a.tickets?.length||0)!==1?"s":"",")"]}),d&&e.jsxs("button",{className:"unbilled-work-alert__action",onClick:()=>d("billing"),children:["Create Invoice",e.jsx(ye,{size:14})]})]}),n&&e.jsx("button",{className:"unbilled-work-alert__dismiss",onClick:f,"aria-label":"Dismiss alert",children:e.jsx(ee,{size:16})})]})}function te(l,o,d="text/csv"){const n=new Blob([l],{type:d}),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=o,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}function ae(l){const o=new Map;for(const d of l){const n=d.projects?.name||"Unknown Project",a=d.projects?.job_number||"",s=d.work_date;for(const b of d.t_and_m_workers||[]){const j=`${b.name}|${s}|${n}|${b.labor_class||b.role||"Laborer"}`;if(o.has(j)){const i=o.get(j);i.regularHours+=parseFloat(b.hours)||0,i.overtimeHours+=parseFloat(b.overtime_hours)||0}else o.set(j,{employeeName:b.name,date:s,projectName:n,jobNumber:a,laborClass:b.labor_class||b.role||"Laborer",regularHours:parseFloat(b.hours)||0,overtimeHours:parseFloat(b.overtime_hours)||0,timeStarted:b.time_started||"",timeEnded:b.time_ended||""})}}return Array.from(o.values()).sort((d,n)=>{const a=d.employeeName.localeCompare(n.employeeName);return a!==0?a:d.date.localeCompare(n.date)})}function Te(l,o,d){const n=ae(l),a=[{key:"employeeName",label:"Employee Name"},{key:"date",label:"Work Date"},{key:"earningsCode",label:"Earnings Code"},{key:"regularHours",label:"Hours"},{key:"overtimeHours",label:"OT Hours"},{key:"totalHours",label:"Total Hours"},{key:"laborClass",label:"Department"},{key:"jobNumber",label:"Job Code"},{key:"projectName",label:"Project"}],s=n.map(i=>({...i,earningsCode:"REG",totalHours:(i.regularHours+i.overtimeHours).toFixed(2),regularHours:i.regularHours.toFixed(2),overtimeHours:i.overtimeHours.toFixed(2)})),b=se(a,s),j=`${o.replace(/[^a-zA-Z0-9]/g,"_")}_Payroll_ADP_${d.start}_to_${d.end}.csv`;return te(b,j),j}function ze(l,o,d){const n=ae(l),a=[{key:"employeeName",label:"Employee Name"},{key:"date",label:"Check Date"},{key:"regularHours",label:"Regular Hours"},{key:"overtimeHours",label:"Overtime Hours"},{key:"totalHours",label:"Total Hours"},{key:"laborClass",label:"Pay Code"},{key:"jobNumber",label:"Job Number"},{key:"projectName",label:"Location"}],s=n.map(i=>({...i,totalHours:(i.regularHours+i.overtimeHours).toFixed(2),regularHours:i.regularHours.toFixed(2),overtimeHours:i.overtimeHours.toFixed(2)})),b=se(a,s),j=`${o.replace(/[^a-zA-Z0-9]/g,"_")}_Payroll_Paychex_${d.start}_to_${d.end}.csv`;return te(b,j),j}function Ie(l,o,d){const n=ae(l),a=[{key:"employeeName",label:"Employee"},{key:"date",label:"Date"},{key:"regularHours",label:"Regular Hours"},{key:"overtimeHours",label:"Overtime Hours"},{key:"laborClass",label:"Classification"},{key:"jobNumber",label:"Job"},{key:"projectName",label:"Project"}],s=n.map(i=>({...i,regularHours:i.regularHours.toFixed(2),overtimeHours:i.overtimeHours.toFixed(2)})),b=se(a,s),j=`${o.replace(/[^a-zA-Z0-9]/g,"_")}_Payroll_Gusto_${d.start}_to_${d.end}.csv`;return te(b,j),j}function $e(l,o,d){const n=ae(l),a=new Map;for(const h of n){const N=`${h.employeeName}|${h.laborClass}`;if(a.has(N)){const f=a.get(N);f.regularHours+=h.regularHours,f.overtimeHours+=h.overtimeHours,f.daysWorked+=1,f.projects.includes(h.projectName)||f.projects.push(h.projectName)}else a.set(N,{employeeName:h.employeeName,laborClass:h.laborClass,regularHours:h.regularHours,overtimeHours:h.overtimeHours,daysWorked:1,projects:[h.projectName]})}const s=[{key:"employeeName",label:"Employee"},{key:"laborClass",label:"Classification"},{key:"regularHours",label:"Regular Hours"},{key:"overtimeHours",label:"Overtime Hours"},{key:"totalHours",label:"Total Hours"},{key:"daysWorked",label:"Days Worked"},{key:"projects",label:"Projects"}],b=Array.from(a.values()).map(h=>({...h,totalHours:(h.regularHours+h.overtimeHours).toFixed(2),regularHours:h.regularHours.toFixed(2),overtimeHours:h.overtimeHours.toFixed(2),projects:h.projects.join("; ")})),j=se(s,b),i=`${o.replace(/[^a-zA-Z0-9]/g,"_")}_Payroll_Summary_${d.start}_to_${d.end}.csv`;return te(j,i),i}const Re=[{id:"adp",label:"ADP",description:"ADP Run / Workforce Now CSV"},{id:"paychex",label:"Paychex",description:"Paychex Flex CSV"},{id:"gusto",label:"Gusto",description:"Gusto time import CSV"},{id:"summary",label:"Summary",description:"Generic payroll summary"}];function Oe({company:l,onClose:o,onShowToast:d}){const n=new Date().toISOString().split("T")[0],a=new Date(Date.now()-10080*60*1e3).toISOString().split("T")[0],[s,b]=u.useState(a),[j,i]=u.useState(n),[h,N]=u.useState("summary"),[f,S]=u.useState(!1),m=u.useCallback(async()=>{if(!s||!j){d?.("Please select a date range","error");return}try{S(!0);const g=await E.getPayrollTMData(l.id,s,j);if(!g||g.length===0){d?.("No T&M data found for this date range","error");return}const T={start:s,end:j},w=l.name||"Company";let _;switch(h){case"adp":_=Te(g,w,T);break;case"paychex":_=ze(g,w,T);break;case"gusto":_=Ie(g,w,T);break;case"summary":default:_=$e(g,w,T);break}d?.(`Exported ${_}`,"success"),o()}catch(g){console.error("Error exporting payroll:",g),d?.("Error exporting payroll data","error")}finally{S(!1)}},[s,j,h,l,o,d]);return e.jsx("div",{className:"modal-overlay",onClick:o,children:e.jsxs("div",{className:"modal payroll-export-modal",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:[e.jsx(V,{size:20}),"Payroll Export"]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:o,children:e.jsx(ee,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{className:"payroll-export-description",children:"Export crew hours from T&M tickets in a format compatible with your payroll provider. Hours are aggregated by worker, date, project, and labor classification."}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:[e.jsx(_e,{size:14}),"Pay Period"]}),e.jsxs("div",{className:"date-range-inputs",children:[e.jsx("input",{type:"date",value:s,onChange:g=>b(g.target.value),className:"form-input"}),e.jsx("span",{className:"date-range-separator",children:"to"}),e.jsx("input",{type:"date",value:j,onChange:g=>i(g.target.value),className:"form-input"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Export Format"}),e.jsx("div",{className:"format-options",children:Re.map(g=>e.jsxs("label",{className:`format-option ${h===g.id?"selected":""}`,children:[e.jsx("input",{type:"radio",name:"payrollFormat",value:g.id,checked:h===g.id,onChange:()=>N(g.id)}),e.jsxs("div",{className:"format-option-content",children:[e.jsx("span",{className:"format-option-label",children:g.label}),e.jsx("span",{className:"format-option-desc",children:g.description})]})]},g.id))})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:o,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:m,disabled:f||!s||!j,children:[e.jsx(Q,{size:16}),f?"Exporting...":"Export CSV"]})]})]})})}const X={draft:{label:"Draft",icon:V,className:"status-draft"},sent:{label:"Sent",icon:pe,className:"status-sent"},partial:{label:"Partial",icon:me,className:"status-partial"},paid:{label:"Paid",icon:de,className:"status-paid"},void:{label:"Void",icon:me,className:"status-void"}};function Ge({project:l,company:o,user:d,onShowToast:n}){const[a,s]=u.useState({cors:[],tickets:[]}),[b,j]=u.useState([]),[i,h]=u.useState(!0),[N,f]=u.useState({cors:new Set,tickets:new Set}),[S,m]=u.useState(!1),[g,T]=u.useState(null),[w,_]=u.useState(null),[x,P]=u.useState(null),[U,O]=u.useState(!1),[z,I]=u.useState(!1),[v,D]=u.useState(!1),$=u.useRef(null);u.useEffect(()=>{W()},[l.id]);const W=async()=>{try{h(!0);const[t,p]=await Promise.all([E.getBillableItems(l.id),E.getProjectInvoices(l.id)]);s(t),j(p)}catch(t){console.error("Error loading billing data:",t),n?.("Error loading billing data","error")}finally{h(!1)}};u.useEffect(()=>{const t=p=>{$.current&&!$.current.contains(p.target)&&_(null)};if(w)return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[w]);const le=u.useCallback((t,p)=>{p.stopPropagation(),_(y=>y===t?null:t)},[]),B=u.useCallback(async t=>{_(null);try{const p=await E.getInvoice(t.id);P(p)}catch(p){console.error("Error fetching invoice:",p),n?.("Error loading invoice details","error")}},[]),G=u.useCallback(async t=>{_(null),O(!0);try{const p=await E.getInvoice(t.id),y=await Pe(p,l,o);n?.(`Downloaded ${y}`,"success")}catch(p){console.error("Error generating PDF:",p),n?.("Error generating PDF","error")}finally{O(!1)}},[l,o]),ne=u.useCallback(async t=>{if(_(null),t.status!=="draft"){n?.("Only draft invoices can be marked as sent","error");return}try{await E.markInvoiceSent(t.id),await W(),n?.(`Invoice ${t.invoice_number} marked as sent`,"success")}catch(p){console.error("Error updating invoice:",p),n?.("Error updating invoice","error")}},[]),re=u.useCallback(async t=>{if(_(null),t.status==="paid"){n?.("Invoice is already marked as paid","error");return}try{await E.updateInvoice(t.id,{status:"paid",paid_at:new Date().toISOString(),amount_paid:t.total}),await W(),n?.(`Invoice ${t.invoice_number} marked as paid`,"success")}catch(p){console.error("Error updating invoice:",p),n?.("Error updating invoice","error")}},[]),r=u.useCallback(async()=>{D(!0);try{const{generateBillingPackage:t}=await oe(async()=>{const{generateBillingPackage:M}=await import("./billingPackageGenerator-1R5w43DK.js");return{generateBillingPackage:M}},__vite__mapDeps([0,1,2,3,4,5,6,7])),p=a.cors.map(M=>M.id),y=[];for(const M of p){const J=await E.getChangeOrderDetail(M);J&&y.push(J)}const q=a.tickets.map(M=>M.id),F=[];for(const M of q){const J=await E.getTMTicketDetail?.(M);J&&F.push(J)}const R=await t({cors:y,tickets:F.length>0?F:a.tickets,project:l,company:o,branding:o});R.success&&n?.(`Billing package generated: ${R.fileName}`,"success")}catch(t){console.error("Error generating billing package:",t),n?.("Error generating billing package","error")}finally{D(!1)}},[a,l,o]),c=u.useMemo(()=>{const t=a.cors.filter(F=>N.cors.has(F.id)).reduce((F,R)=>F+(R.cor_total||0),0),p=a.tickets.filter(F=>N.tickets.has(F.id)).reduce((F,R)=>F+(parseFloat(R.change_order_value)||0)*100,0),y=a.cors.reduce((F,R)=>F+(R.cor_total||0),0),q=a.tickets.reduce((F,R)=>F+(parseFloat(R.change_order_value)||0)*100,0);return{selected:t+p,total:y+q,selectedCount:N.cors.size+N.tickets.size}},[a,N]),k=t=>{f(p=>{const y=new Set(p.cors);return y.has(t)?y.delete(t):y.add(t),{...p,cors:y}})},A=t=>{f(p=>{const y=new Set(p.tickets);return y.has(t)?y.delete(t):y.add(t),{...p,tickets:y}})},L=()=>{f({cors:new Set(a.cors.map(t=>t.id)),tickets:new Set(a.tickets.map(t=>t.id))})},H=()=>{f({cors:new Set,tickets:new Set})},ge=()=>{T(null),m(!0)},je=async t=>{m(!1),H(),await W(),n?.(`Invoice ${t.invoice_number} created`,"success")},ve=()=>{const t=a.cors.filter(y=>N.cors.has(y.id)),p=a.tickets.filter(y=>N.tickets.has(y.id));return{cors:t,tickets:p}},Y=t=>t?new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"2-digit"}):"-",Z=a.cors.length>0||a.tickets.length>0,ie=c.selectedCount>0;return i?e.jsx("div",{className:"billing-center loading",children:e.jsxs("div",{className:"billing-loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("span",{children:"Loading billing data..."})]})}):e.jsxs("div",{className:"billing-center",children:[e.jsx(He,{companyId:o?.id,projectId:l?.id}),e.jsxs("div",{className:"billing-quick-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:r,disabled:v||!Z,title:"Generate a complete billing package with COR details, T&M backup, and photos",children:[e.jsx(ke,{size:16}),v?"Generating...":"Billing Package"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>I(!0),title:"Export crew hours for payroll",children:[e.jsx(Ce,{size:16}),"Payroll Export"]})]}),e.jsxs("div",{className:"billing-section",children:[e.jsxs("div",{className:"billing-section-header",children:[e.jsxs("div",{className:"billing-section-title",children:[e.jsx(K,{size:20}),e.jsx("h3",{children:"Ready to Bill"}),Z&&e.jsxs("span",{className:"billing-count",children:[a.cors.length+a.tickets.length," items"]})]}),Z&&e.jsx("div",{className:"billing-section-actions",children:e.jsx("button",{className:"btn btn-text btn-sm",onClick:ie?H:L,children:ie?"Clear Selection":"Select All"})})]}),Z?e.jsxs(e.Fragment,{children:[a.cors.length>0&&e.jsxs("div",{className:"billable-group",children:[e.jsxs("div",{className:"billable-group-header",children:[e.jsx(V,{size:16}),e.jsxs("span",{children:["Change Orders (",a.cors.length,")"]})]}),e.jsx("div",{className:"billable-items",children:a.cors.map(t=>e.jsxs("label",{className:`billable-item ${N.cors.has(t.id)?"selected":""}`,children:[e.jsx("input",{type:"checkbox",checked:N.cors.has(t.id),onChange:()=>k(t.id)}),e.jsxs("div",{className:"billable-item-content",children:[e.jsx("span",{className:"billable-item-number",children:t.cor_number}),e.jsx("span",{className:"billable-item-title",children:t.title||"Untitled COR"})]}),e.jsx("span",{className:"billable-item-amount",children:C(t.cor_total||0)})]},t.id))})]}),a.tickets.length>0&&e.jsxs("div",{className:"billable-group",children:[e.jsxs("div",{className:"billable-group-header",children:[e.jsx(we,{size:16}),e.jsxs("span",{children:["T&M Tickets (",a.tickets.length,")"]})]}),e.jsx("div",{className:"billable-items",children:a.tickets.map(t=>e.jsxs("label",{className:`billable-item ${N.tickets.has(t.id)?"selected":""}`,children:[e.jsx("input",{type:"checkbox",checked:N.tickets.has(t.id),onChange:()=>A(t.id)}),e.jsxs("div",{className:"billable-item-content",children:[e.jsx("span",{className:"billable-item-number",children:t.ce_pco_number||Y(t.work_date)}),e.jsxs("span",{className:"billable-item-title",children:["T&M Ticket - ",Y(t.work_date)]})]}),e.jsx("span",{className:"billable-item-amount",children:C((parseFloat(t.change_order_value)||0)*100)})]},t.id))})]}),e.jsxs("div",{className:"billing-action-bar",children:[e.jsxs("div",{className:"billing-action-summary",children:[e.jsxs("span",{className:"selected-count",children:[c.selectedCount," of ",a.cors.length+a.tickets.length," selected"]}),e.jsx("span",{className:"selected-total",children:C(c.selected)})]}),e.jsxs("button",{className:"btn btn-primary",disabled:!ie,onClick:ge,children:[e.jsx(ce,{size:16}),"Create Invoice"]})]})]}):e.jsxs("div",{className:"billing-empty-state",children:[e.jsx(de,{size:32,className:"text-success"}),e.jsx("p",{children:"No items ready to bill"}),e.jsx("span",{children:"Approved CORs and signed T&M tickets will appear here"})]})]}),e.jsxs("div",{className:"billing-section",children:[e.jsx("div",{className:"billing-section-header",children:e.jsxs("div",{className:"billing-section-title",children:[e.jsx(xe,{size:20}),e.jsx("h3",{children:"Invoices"}),b.length>0&&e.jsx("span",{className:"billing-count",children:b.length})]})}),b.length===0?e.jsxs("div",{className:"billing-empty-state",children:[e.jsx(K,{size:32}),e.jsx("p",{children:"No invoices yet"}),e.jsx("span",{children:"Create an invoice from the items above"})]}):e.jsx("div",{className:"invoice-list",children:b.map(t=>{const p=X[t.status]?.icon||V,y=w===t.id;return e.jsxs("div",{className:"invoice-row",children:[e.jsxs("div",{className:"invoice-info",children:[e.jsx("span",{className:"invoice-number",children:t.invoice_number}),e.jsx("span",{className:"invoice-date",children:Y(t.invoice_date)})]}),e.jsx("span",{className:"invoice-amount",children:C(t.total||0)}),e.jsxs("span",{className:`invoice-status ${X[t.status]?.className||""}`,children:[e.jsx(p,{size:14}),X[t.status]?.label||t.status]}),e.jsxs("div",{className:"invoice-actions",children:[e.jsxs("button",{className:"btn btn-sm btn-secondary",title:"View invoice details",onClick:()=>B(t),disabled:U,children:[e.jsx(he,{size:14}),"View"]}),e.jsxs("button",{className:"btn btn-sm btn-primary",title:"Download PDF",onClick:()=>G(t),disabled:U,children:[e.jsx(Q,{size:14}),"PDF"]})]}),e.jsxs("div",{className:"invoice-actions-container",ref:y?$:null,children:[e.jsx("button",{className:"btn btn-icon btn-ghost",title:"More options",onClick:q=>le(t.id,q),disabled:U,children:e.jsx(De,{size:16})}),y&&e.jsxs("div",{className:"invoice-dropdown",children:[e.jsxs("button",{className:"dropdown-item",onClick:()=>B(t),children:[e.jsx(he,{size:14}),"View Details"]}),e.jsxs("button",{className:"dropdown-item",onClick:()=>G(t),children:[e.jsx(Q,{size:14}),"Download PDF"]}),t.status==="draft"&&e.jsxs("button",{className:"dropdown-item",onClick:()=>ne(t),children:[e.jsx(pe,{size:14}),"Mark as Sent"]}),t.status!=="paid"&&t.status!=="void"&&e.jsxs("button",{className:"dropdown-item success",onClick:()=>re(t),children:[e.jsx(de,{size:14}),"Mark as Paid"]})]})]})]},t.id)})})]}),S&&e.jsx(Ee,{project:l,company:o,user:d,selectedItems:ve(),onClose:()=>m(!1),onSuccess:je}),z&&e.jsx(Oe,{company:o,onClose:()=>I(!1),onShowToast:n}),x&&e.jsx("div",{className:"modal-overlay",onClick:()=>P(null),children:e.jsxs("div",{className:"modal invoice-detail-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Invoice ",x.invoice_number]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>P(null),children:e.jsx(ee,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"invoice-detail-header",children:[e.jsxs("div",{className:"invoice-detail-info",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Date:"}),e.jsx("span",{className:"detail-value",children:Y(x.invoice_date)})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Due:"}),e.jsx("span",{className:"detail-value",children:x.due_date?Y(x.due_date):"Upon Receipt"})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"detail-label",children:"Status:"}),e.jsx("span",{className:`invoice-status ${X[x.status]?.className||""}`,children:X[x.status]?.label||x.status})]})]}),e.jsxs("div",{className:"invoice-detail-billto",children:[e.jsx("span",{className:"detail-label",children:"Bill To:"}),e.jsxs("div",{className:"billto-content",children:[x.bill_to_name&&e.jsx("p",{children:x.bill_to_name}),x.bill_to_address&&e.jsx("p",{children:x.bill_to_address}),x.bill_to_contact&&e.jsx("p",{children:x.bill_to_contact})]})]})]}),e.jsxs("div",{className:"invoice-detail-items",children:[e.jsx("h3",{children:"Line Items"}),e.jsxs("table",{className:"invoice-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Reference"}),e.jsx("th",{children:"Description"}),e.jsx("th",{className:"text-right",children:"Amount"})]})}),e.jsx("tbody",{children:(x.invoice_items||[]).map((t,p)=>e.jsxs("tr",{children:[e.jsx("td",{children:t.reference_number||"-"}),e.jsx("td",{children:t.description}),e.jsx("td",{className:"text-right",children:C(t.amount)})]},t.id||p))})]})]}),e.jsxs("div",{className:"invoice-detail-totals",children:[e.jsxs("div",{className:"total-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:C(x.subtotal)})]}),x.retention_percent>0&&e.jsxs("div",{className:"total-row retention",children:[e.jsxs("span",{children:["Retention (",x.retention_percent/100,"%)"]}),e.jsxs("span",{children:["-",C(x.retention_amount)]})]}),e.jsxs("div",{className:"total-row grand-total",children:[e.jsx("span",{children:"Total Due"}),e.jsx("span",{children:C(x.total)})]}),x.amount_paid>0&&e.jsxs("div",{className:"total-row paid",children:[e.jsx("span",{children:"Amount Paid"}),e.jsx("span",{children:C(x.amount_paid)})]})]}),x.notes&&e.jsxs("div",{className:"invoice-detail-notes",children:[e.jsx("span",{className:"detail-label",children:"Notes:"}),e.jsx("p",{children:x.notes})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>P(null),children:"Close"}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{G(x),P(null)},children:[e.jsx(Q,{size:16}),"Download PDF"]})]})]})})]})}export{Ge as default};
//# sourceMappingURL=BillingCenter-JHBvbvHp.js.map
