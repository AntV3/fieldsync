import{ar as D,aS as bs,aK as vs,as as s}from"./index-BuWOXVN7.js";import{r as x,c as as,aq as ns,j as g,D as G,F as ts,H as rs,ag as W,f as is,N as fs,l as ys,B as Ss,q as ls,y as cs,O as ks,b as Y}from"./icons-Ng3QClhp.js";import{c as ws,a as Cs,b as E,f as d,d as S}from"./corCalculations-BdV1IoSP.js";import{S as ds,e as Ts,a as zs}from"./SignatureCanvas-DrLwfeKW.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";const k=u=>u?new Date(u).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"",$=u=>{if(!u)return"";const[o,N]=u.split(":"),f=parseInt(o),j=f>=12?"pm":"am";return`${f%12||12}:${N}${j}`},Fs=({status:u})=>{const o={draft:{label:"Draft",color:"#6b7280",bg:"#f3f4f6"},pending_approval:{label:"Pending Approval",color:"#d97706",bg:"#fef3c7"},approved:{label:"Approved",color:"#059669",bg:"#d1fae5"},rejected:{label:"Rejected",color:"#dc2626",bg:"#fee2e2"},billed:{label:"Billed",color:"#2563eb",bg:"#dbeafe"},closed:{label:"Closed",color:"#4b5563",bg:"#e5e7eb"}},N=o[u]||o.draft;return s.jsx("span",{className:"cor-status-badge",style:{color:N.color,backgroundColor:N.bg},children:N.label})};function Bs({signatureToken:u}){const[o,N]=x.useState(!0),[f,j]=x.useState(null),[p,os]=x.useState(null),[a,hs]=x.useState(null),[J,q]=x.useState(!1),[w,R]=x.useState(null),[C,V]=x.useState(!1),[Z,M]=x.useState(null),[T,O]=x.useState(!1),[y,ms]=x.useState([]),[A,xs]=x.useState(!1),[Q,us]=x.useState(new Set),[B,js]=x.useState(null);x.useEffect(()=>{K()},[u]);const K=async()=>{try{N(!0),j(null);const e=await D.getSignatureRequestByToken(u);if(!e){j("This signature link is invalid or has expired.");return}if(e.status==="completed"){j("This document has already been fully signed.");return}if(e.status==="revoked"){j("This signature link has been revoked.");return}if(e.status==="expired"){j("This signature link has expired.");return}os(e);const r=await D.getDocumentForSigning(e.document_type,e.document_id);if(!r){j("The document associated with this link could not be found.");return}if(hs(r),e.document_type==="cor"&&r?.id)try{const i=await D.getCORTickets(r.id);ms(i||[])}catch(i){console.warn("Failed to load backup tickets:",i)}const t=r?.projects?.companies?.id;if(t&&bs)try{const{data:i}=await vs.from("company_branding").select("primary_color, logo_url").eq("company_id",t).single();i&&js(i)}catch(i){console.warn("Failed to load company branding:",i)}}catch(e){console.error("Error loading signature data:",e),j("Unable to load signature request. Please try again.")}finally{N(!1)}},c=x.useMemo(()=>!a||p?.document_type!=="cor"?null:ws(a),[a,p]),ps=()=>{if(!p)return{slot1:null,slot2:null,availableSlots:[]};const e=p.signatures||[],r=e.find(n=>n.signature_slot===1),t=e.find(n=>n.signature_slot===2),i=[];return r||i.push(1),t||i.push(2),{slot1:r,slot2:t,availableSlots:i}},gs=async()=>{try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch{return null}},X=async e=>{if(!(!p||!w))try{V(!0);const r=await gs(),t=await D.addSignature(p.id,w,{...e,ipAddress:r,userAgent:navigator.userAgent});await D.syncSignatureToDocument(t,p),await K(),q(!1),R(null),M("signed")}catch(r){console.error("Error submitting signature:",r),j("Failed to submit signature. Please try again.")}finally{V(!1)}},z=e=>{R(e),q(!0)},ss=async()=>{if(!a||!p)return;const e=a?.projects?.companies,r=a?.projects;try{O(!0);let t=null;if(p?.document_type==="cor")try{t=await D.getCORTickets(a.id)}catch(n){console.warn("Failed to fetch T&M tickets for backup:",n)}const i={logoUrl:B?.logo_url||e?.logo_url,primaryColor:B?.primary_color};await Ts(a,r,e,i,t),M("PDF downloaded successfully!"),setTimeout(()=>M(null),3e3)}catch(t){console.error("Download failed:",t),j("Failed to generate PDF. Please try again.")}finally{O(!1)}},Ns=async()=>{if(!a||!p)return;const e=a?.projects?.companies,r=a?.projects;try{O(!0);const t={logoUrl:B?.logo_url||e?.logo_url,primaryColor:B?.primary_color};await zs(a,r,e,t),M("PDF downloaded successfully!"),setTimeout(()=>M(null),3e3)}catch(t){console.error("Download failed:",t),j("Failed to generate PDF. Please try again.")}finally{O(!1)}};if(o)return s.jsx("div",{className:"signature-page",children:s.jsxs("div",{className:"signature-page-loading",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Loading document..."})]})});if(f)return s.jsx("div",{className:"signature-page",children:s.jsxs("div",{className:"signature-page-error",children:[s.jsx(as,{size:48}),s.jsx("h2",{children:"Unable to Load Document"}),s.jsx("p",{children:f})]})});const{slot1:h,slot2:m,availableSlots:Ps}=ps(),I=h||m,_s=p?.document_type==="cor",v=a?.projects?.companies,H=a?.projects;if(!_s){const e=a.t_and_m_workers?.length||0,r=a.t_and_m_workers?.reduce((t,i)=>t+(i.hours||0),0)||0;return s.jsxs("div",{className:"signature-page",children:[s.jsxs("header",{className:"signature-page-header",children:[v?.logo_url?s.jsx("img",{src:v.logo_url,alt:v.name,className:"company-logo"}):s.jsx("div",{className:"company-logo-placeholder",children:s.jsx(ns,{size:24})}),s.jsxs("div",{className:"company-info",children:[s.jsx("h1",{children:v?.name||"FieldSync"}),s.jsx("span",{className:"doc-type-label",children:"T&M Ticket Signature"})]})]}),Z==="signed"&&s.jsx("div",{className:"signature-signed-overlay",children:s.jsxs("div",{className:"signature-signed-content",children:[s.jsx(g,{size:48}),s.jsx("h2",{children:"Document Signed Successfully"}),s.jsx("p",{children:"This document has been signed and submitted."}),s.jsx("button",{className:"btn btn-primary download-copy-btn",onClick:Ns,disabled:T,children:T?s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"btn-spinner"}),"Generating PDF..."]}):s.jsxs(s.Fragment,{children:[s.jsx(G,{size:18}),"Save a Copy for Your Records"]})}),s.jsx("p",{className:"close-prompt",children:"You may close this page when done."})]})}),s.jsxs("main",{className:"signature-page-content",children:[s.jsxs("div",{className:"signature-document-card",children:[s.jsxs("div",{className:"document-card-header",children:[s.jsx(ts,{size:20}),s.jsxs("div",{className:"document-card-title",children:[s.jsx("h2",{children:"T&M Ticket"}),s.jsx("span",{className:"document-subtitle",children:a.ce_pco_number?`CE/PCO: ${a.ce_pco_number}`:"Time & Materials"})]})]}),s.jsxs("div",{className:"document-card-details",children:[s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Project"}),s.jsx("span",{className:"detail-value",children:H?.name})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Work Date"}),s.jsx("span",{className:"detail-value",children:k(a.work_date)})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Workers"}),s.jsxs("span",{className:"detail-value",children:[e," (",r," hrs)"]})]}),a.notes&&s.jsxs("div",{className:"detail-row full-width",children:[s.jsx("span",{className:"detail-label",children:"Description"}),s.jsx("span",{className:"detail-value",children:a.notes})]})]}),a.t_and_m_workers?.length>0&&s.jsxs("div",{className:"signature-detail-section",children:[s.jsxs("h4",{children:[s.jsx(rs,{size:16})," Workers"]}),s.jsxs("table",{className:"signature-detail-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Name"}),s.jsx("th",{children:"Role"}),s.jsx("th",{children:"Time"}),s.jsx("th",{children:"Reg Hrs"}),s.jsx("th",{children:"OT"})]})}),s.jsx("tbody",{children:a.t_and_m_workers.map((t,i)=>s.jsxs("tr",{children:[s.jsx("td",{children:t.name}),s.jsx("td",{children:t.role||"Laborer"}),s.jsx("td",{children:t.time_started&&t.time_ended?`${$(t.time_started)} - ${$(t.time_ended)}`:"-"}),s.jsx("td",{children:t.hours||0}),s.jsx("td",{children:t.overtime_hours||"-"})]},i))})]})]}),a.t_and_m_items?.length>0&&s.jsxs("div",{className:"signature-detail-section",children:[s.jsxs("h4",{children:[s.jsx(W,{size:16})," Materials & Equipment"]}),s.jsxs("table",{className:"signature-detail-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Item"}),s.jsx("th",{children:"Qty"}),s.jsx("th",{children:"Unit"})]})}),s.jsx("tbody",{children:a.t_and_m_items.map((t,i)=>s.jsxs("tr",{children:[s.jsx("td",{children:t.custom_name||t.materials_equipment?.name||"Item"}),s.jsx("td",{children:t.quantity}),s.jsx("td",{children:t.materials_equipment?.unit||"each"})]},i))})]})]}),a.photos?.length>0&&s.jsxs("div",{className:"signature-detail-section",children:[s.jsxs("h4",{children:[s.jsx(is,{size:16})," Photos (",a.photos.length,")"]}),s.jsx("div",{className:"signature-photo-grid",children:a.photos.map((t,i)=>s.jsx("div",{className:"signature-photo-thumb",children:s.jsx("img",{src:typeof t=="string"?t:t.url,alt:`Photo ${i+1}`,onError:n=>{n.target.style.display="none"}})},i))})]})]}),s.jsxs("div",{className:"signature-status-section",children:[s.jsx("h3",{children:"Signature"}),I?s.jsxs(s.Fragment,{children:[h&&L(1,h,"GC Authorization",z,C),m&&L(2,m,"Client Authorization",z,C)]}):s.jsxs(s.Fragment,{children:[L(1,h,"GC Authorization",z,C),!h&&s.jsx("p",{className:"or-divider",children:"— or —"}),L(2,m,"Client Authorization",z,C)]}),I&&s.jsxs("div",{className:"fully-signed-message",children:[s.jsx(g,{size:24}),s.jsx("p",{children:"This document has been signed."})]})]})]}),s.jsx("footer",{className:"signature-page-footer",children:s.jsx("p",{children:"Powered by FieldSync"})}),J&&w&&s.jsx(ds,{enhanced:!0,requireAcknowledgment:!0,lockBodyScroll:!0,slot:w,documentType:"tm_ticket",documentTitle:"T&M Ticket",onSave:X,onClose:()=>{q(!1),R(null)}})]})}return s.jsxs("div",{className:"signature-page",children:[s.jsxs("header",{className:"signature-page-header",children:[v?.logo_url?s.jsx("img",{src:v.logo_url,alt:v.name,className:"company-logo"}):s.jsx("div",{className:"company-logo-placeholder",children:s.jsx(ns,{size:24})}),s.jsxs("div",{className:"company-info",children:[s.jsx("h1",{children:v?.name||"FieldSync"}),s.jsx("span",{className:"doc-type-label",children:"Change Order Request"})]})]}),Z==="signed"&&s.jsx("div",{className:"signature-signed-overlay",children:s.jsxs("div",{className:"signature-signed-content",children:[s.jsx(g,{size:48}),s.jsx("h2",{children:"Document Signed Successfully"}),s.jsx("p",{children:"This document has been signed and submitted."}),s.jsx("button",{className:"btn btn-primary download-copy-btn",onClick:ss,disabled:T,children:T?s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"btn-spinner"}),"Generating PDF..."]}):s.jsxs(s.Fragment,{children:[s.jsx(G,{size:18}),"Save a Copy for Your Records"]})}),s.jsx("p",{className:"close-prompt",children:"You may close this page when done."})]})}),s.jsxs("main",{className:"signature-page-content cor-full-document",children:[s.jsxs("div",{className:"cor-header-card",children:[s.jsxs("div",{className:"cor-header-top",children:[s.jsxs("div",{className:"cor-title-section",children:[s.jsx("h2",{className:"cor-number",children:a.cor_number}),s.jsx(Fs,{status:a.status})]}),s.jsxs("div",{className:"cor-date",children:["Created ",k(a.created_at)]})]}),s.jsx("h3",{className:"cor-title",children:a.title||"Untitled Change Order"}),s.jsxs("div",{className:"cor-info-grid",children:[s.jsxs("div",{className:"cor-info-item",children:[s.jsx("span",{className:"cor-info-label",children:"Project"}),s.jsx("span",{className:"cor-info-value",children:H?.name})]}),H?.job_number&&s.jsxs("div",{className:"cor-info-item",children:[s.jsx("span",{className:"cor-info-label",children:"Job #"}),s.jsx("span",{className:"cor-info-value",children:H.job_number})]}),s.jsxs("div",{className:"cor-info-item",children:[s.jsx("span",{className:"cor-info-label",children:"Period"}),s.jsx("span",{className:"cor-info-value",children:Cs(a.period_start,a.period_end)})]})]}),a.scope_of_work&&s.jsxs("div",{className:"cor-scope",children:[s.jsx("h4",{children:"Scope of Work"}),s.jsx("p",{children:a.scope_of_work})]})]}),a.change_order_labor?.length>0&&s.jsxs("div",{className:"cor-section",children:[s.jsxs("div",{className:"cor-section-header",children:[s.jsx(fs,{size:18}),s.jsx("h4",{children:"Labor"})]}),s.jsx("div",{className:"cor-table-wrapper",children:s.jsxs("table",{className:"cor-line-items-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Class"}),s.jsx("th",{children:"Type"}),s.jsx("th",{className:"text-right",children:"Reg Hrs"}),s.jsx("th",{className:"text-right",children:"Reg Rate"}),s.jsx("th",{className:"text-right",children:"OT Hrs"}),s.jsx("th",{className:"text-right",children:"OT Rate"}),s.jsx("th",{className:"text-right",children:"Total"})]})}),s.jsx("tbody",{children:a.change_order_labor.map((e,r)=>s.jsxs("tr",{children:[s.jsx("td",{children:e.labor_class}),s.jsx("td",{children:e.wage_type}),s.jsx("td",{className:"text-right",children:e.regular_hours}),s.jsxs("td",{className:"text-right",children:["$",E(e.regular_rate),"/hr"]}),s.jsx("td",{className:"text-right",children:e.overtime_hours||"-"}),s.jsx("td",{className:"text-right",children:e.overtime_hours?`$${E(e.overtime_rate)}/hr`:"-"}),s.jsx("td",{className:"text-right",children:d(e.total)})]},r))}),s.jsxs("tfoot",{children:[s.jsxs("tr",{children:[s.jsx("td",{colSpan:"5",className:"text-right",children:"Subtotal:"}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.labor_subtotal)})]}),s.jsxs("tr",{className:"markup-row",children:[s.jsxs("td",{colSpan:"5",className:"text-right",children:["+ ",S(a.labor_markup_percent||1500)," Markup:"]}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.labor_markup_amount)})]}),s.jsxs("tr",{className:"section-total-row",children:[s.jsx("td",{colSpan:"5",className:"text-right",children:s.jsx("strong",{children:"Labor Total:"})}),s.jsx("td",{className:"text-right",colSpan:"2",children:s.jsx("strong",{children:d(c.labor_subtotal+c.labor_markup_amount)})})]})]})]})})]}),a.change_order_materials?.length>0&&s.jsxs("div",{className:"cor-section",children:[s.jsxs("div",{className:"cor-section-header",children:[s.jsx(W,{size:18}),s.jsx("h4",{children:"Materials"})]}),s.jsx("div",{className:"cor-table-wrapper",children:s.jsxs("table",{className:"cor-line-items-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Description"}),s.jsx("th",{children:"Source"}),s.jsx("th",{className:"text-right",children:"Qty"}),s.jsx("th",{children:"Unit"}),s.jsx("th",{className:"text-right",children:"Unit Cost"}),s.jsx("th",{className:"text-right",children:"Total"})]})}),s.jsx("tbody",{children:a.change_order_materials.map((e,r)=>s.jsxs("tr",{children:[s.jsx("td",{children:e.description}),s.jsx("td",{children:e.source_reference||e.source_type}),s.jsx("td",{className:"text-right",children:e.quantity}),s.jsx("td",{children:e.unit}),s.jsxs("td",{className:"text-right",children:["$",E(e.unit_cost)]}),s.jsx("td",{className:"text-right",children:d(e.total)})]},r))}),s.jsxs("tfoot",{children:[s.jsxs("tr",{children:[s.jsx("td",{colSpan:"4",className:"text-right",children:"Subtotal:"}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.materials_subtotal)})]}),s.jsxs("tr",{className:"markup-row",children:[s.jsxs("td",{colSpan:"4",className:"text-right",children:["+ ",S(a.materials_markup_percent||1500)," Markup:"]}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.materials_markup_amount)})]}),s.jsxs("tr",{className:"section-total-row",children:[s.jsx("td",{colSpan:"4",className:"text-right",children:s.jsx("strong",{children:"Materials Total:"})}),s.jsx("td",{className:"text-right",colSpan:"2",children:s.jsx("strong",{children:d(c.materials_subtotal+c.materials_markup_amount)})})]})]})]})})]}),a.change_order_equipment?.length>0&&s.jsxs("div",{className:"cor-section",children:[s.jsxs("div",{className:"cor-section-header",children:[s.jsx(ys,{size:18}),s.jsx("h4",{children:"Equipment"})]}),s.jsx("div",{className:"cor-table-wrapper",children:s.jsxs("table",{className:"cor-line-items-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Description"}),s.jsx("th",{children:"Source"}),s.jsx("th",{className:"text-right",children:"Qty"}),s.jsx("th",{children:"Unit"}),s.jsx("th",{className:"text-right",children:"Unit Cost"}),s.jsx("th",{className:"text-right",children:"Total"})]})}),s.jsx("tbody",{children:a.change_order_equipment.map((e,r)=>s.jsxs("tr",{children:[s.jsx("td",{children:e.description}),s.jsx("td",{children:e.source_reference||e.source_type}),s.jsx("td",{className:"text-right",children:e.quantity}),s.jsx("td",{children:e.unit}),s.jsxs("td",{className:"text-right",children:["$",E(e.unit_cost)]}),s.jsx("td",{className:"text-right",children:d(e.total)})]},r))}),s.jsxs("tfoot",{children:[s.jsxs("tr",{children:[s.jsx("td",{colSpan:"4",className:"text-right",children:"Subtotal:"}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.equipment_subtotal)})]}),s.jsxs("tr",{className:"markup-row",children:[s.jsxs("td",{colSpan:"4",className:"text-right",children:["+ ",S(a.equipment_markup_percent||1500)," Markup:"]}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.equipment_markup_amount)})]}),s.jsxs("tr",{className:"section-total-row",children:[s.jsx("td",{colSpan:"4",className:"text-right",children:s.jsx("strong",{children:"Equipment Total:"})}),s.jsx("td",{className:"text-right",colSpan:"2",children:s.jsx("strong",{children:d(c.equipment_subtotal+c.equipment_markup_amount)})})]})]})]})})]}),a.change_order_subcontractors?.length>0&&s.jsxs("div",{className:"cor-section",children:[s.jsxs("div",{className:"cor-section-header",children:[s.jsx(Ss,{size:18}),s.jsx("h4",{children:"Subcontractors"})]}),s.jsx("div",{className:"cor-table-wrapper",children:s.jsxs("table",{className:"cor-line-items-table",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Company"}),s.jsx("th",{children:"Description"}),s.jsx("th",{children:"Source"}),s.jsx("th",{className:"text-right",children:"Amount"})]})}),s.jsx("tbody",{children:a.change_order_subcontractors.map((e,r)=>s.jsxs("tr",{children:[s.jsx("td",{children:e.company_name}),s.jsx("td",{children:e.description}),s.jsx("td",{children:e.source_reference||e.source_type}),s.jsx("td",{className:"text-right",children:d(e.total)})]},r))}),s.jsxs("tfoot",{children:[s.jsxs("tr",{children:[s.jsx("td",{colSpan:"2",className:"text-right",children:"Subtotal:"}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.subcontractors_subtotal)})]}),s.jsxs("tr",{className:"markup-row",children:[s.jsxs("td",{colSpan:"2",className:"text-right",children:["+ ",S(a.subcontractors_markup_percent||500)," Markup:"]}),s.jsx("td",{className:"text-right",colSpan:"2",children:d(c.subcontractors_markup_amount)})]}),s.jsxs("tr",{className:"section-total-row",children:[s.jsx("td",{colSpan:"2",className:"text-right",children:s.jsx("strong",{children:"Subcontractors Total:"})}),s.jsx("td",{className:"text-right",colSpan:"2",children:s.jsx("strong",{children:d(c.subcontractors_subtotal+c.subcontractors_markup_amount)})})]})]})]})})]}),y.length>0&&(()=>{const e=y.reduce((n,b)=>n+(b.t_and_m_workers?.reduce((F,P)=>F+(parseFloat(P.hours)||0),0)||0),0),r=y.reduce((n,b)=>n+(b.t_and_m_workers?.reduce((F,P)=>F+(parseFloat(P.overtime_hours)||0),0)||0),0),t=y.reduce((n,b)=>n+(b.photos?.length||0),0),i=y.filter(n=>n.client_signature_data).length;return s.jsxs("div",{className:"cor-section cor-backup-section",children:[s.jsxs("div",{className:"backup-official-header",children:[s.jsxs("div",{className:"backup-official-badge",children:[s.jsx(ts,{size:16}),s.jsx("span",{children:"Supporting Documentation"})]}),s.jsxs("div",{className:"backup-summary-bar",children:[s.jsxs("div",{className:"backup-stat",children:[s.jsx("span",{className:"backup-stat-value",children:y.length}),s.jsx("span",{className:"backup-stat-label",children:"Tickets"})]}),s.jsxs("div",{className:"backup-stat",children:[s.jsx("span",{className:"backup-stat-value",children:e.toFixed(1)}),s.jsx("span",{className:"backup-stat-label",children:"Labor Hrs"})]}),r>0&&s.jsxs("div",{className:"backup-stat",children:[s.jsx("span",{className:"backup-stat-value",children:r.toFixed(1)}),s.jsx("span",{className:"backup-stat-label",children:"OT Hrs"})]}),s.jsxs("div",{className:"backup-stat",children:[s.jsx("span",{className:"backup-stat-value",children:t}),s.jsx("span",{className:"backup-stat-label",children:"Photos"})]}),i>0&&s.jsxs("div",{className:"backup-stat verified",children:[s.jsx("span",{className:"backup-stat-value",children:i}),s.jsx("span",{className:"backup-stat-label",children:"Verified"})]})]})]}),s.jsxs("div",{className:"cor-section-header cor-backup-header",onClick:()=>xs(!A),style:{cursor:"pointer",marginBottom:A?"1rem":0},children:[s.jsx("div",{className:"backup-header-left",children:s.jsx("span",{children:"View All T&M Tickets"})}),s.jsx("div",{className:"backup-header-toggle",children:A?s.jsx(ls,{size:20}):s.jsx(cs,{size:20})})]}),A&&s.jsx("div",{className:"backup-tickets-list",style:{padding:"0 0.5rem"},children:y.map(n=>{const b=Q.has(n.id),F=n.t_and_m_workers?.reduce((l,_)=>l+(parseFloat(_.hours)||0),0)||0,P=n.t_and_m_workers?.reduce((l,_)=>l+(parseFloat(_.overtime_hours)||0),0)||0,U=!!n.client_signature_data;return s.jsxs("div",{className:"backup-ticket-pro","data-verified":U,"data-status":n.status||"pending",children:[s.jsxs("div",{className:"ticket-pro-header",onClick:()=>{const l=new Set(Q);b?l.delete(n.id):l.add(n.id),us(l)},style:{cursor:"pointer"},children:[s.jsxs("div",{className:"ticket-date-badge",children:[s.jsx(ks,{size:14}),s.jsx("span",{children:k(n.work_date)})]}),n.ce_pco_number&&s.jsx("span",{className:"ticket-pco-badge",children:n.ce_pco_number}),U&&s.jsxs("span",{className:"ticket-verified-seal",children:[s.jsx(g,{size:12})," Verified"]}),s.jsxs("div",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:"0.5rem"},children:[s.jsxs("span",{style:{fontSize:"0.85rem",color:"var(--text-muted)"},children:[n.t_and_m_workers?.length||0," workers • ",F+P," hrs"]}),b?s.jsx(ls,{size:16}):s.jsx(cs,{size:16})]})]}),b&&s.jsxs("div",{className:"ticket-pro-body",children:[n.notes&&s.jsx("div",{className:"ticket-description-box",children:s.jsx("p",{children:n.notes})}),n.t_and_m_workers?.length>0&&s.jsxs("div",{className:"ticket-section-pro",children:[s.jsxs("div",{className:"ticket-section-header",children:[s.jsx(rs,{size:14}),s.jsx("span",{children:"Labor"}),s.jsxs("span",{className:"section-count",children:[F+P," hrs total"]})]}),s.jsx("div",{className:"worker-pro-grid",children:n.t_and_m_workers.map((l,_)=>s.jsxs("div",{className:"worker-pro-row",children:[s.jsxs("div",{children:[s.jsx("span",{className:"worker-name",children:l.name}),l.role&&s.jsxs("span",{className:"worker-role",children:[" • ",l.role]})]}),s.jsx("span",{className:"worker-time",children:l.time_started&&l.time_ended?`${$(l.time_started)} - ${$(l.time_ended)}`:"-"}),s.jsxs("span",{className:"worker-hours",children:[l.hours||0," hrs"]}),s.jsx("span",{className:"worker-ot",children:parseFloat(l.overtime_hours)>0?`+${l.overtime_hours} OT`:"-"})]},_))})]}),n.t_and_m_items?.length>0&&s.jsxs("div",{className:"ticket-section-pro",children:[s.jsxs("div",{className:"ticket-section-header",children:[s.jsx(W,{size:14}),s.jsx("span",{children:"Materials / Equipment"}),s.jsxs("span",{className:"section-count",children:[n.t_and_m_items.length," items"]})]}),s.jsx("div",{className:"materials-pro-list",children:n.t_and_m_items.map((l,_)=>s.jsxs("div",{className:"material-pro-row",children:[s.jsx("span",{className:"material-name",children:l.materials_equipment?.name||l.description||"Item"}),s.jsxs("span",{className:"material-qty",children:[l.quantity||1," ",l.materials_equipment?.unit||"ea"]}),s.jsx("span",{className:"material-source",children:"T&M Ticket"})]},_))})]}),n.photos?.length>0&&s.jsxs("div",{className:"ticket-section-pro",children:[s.jsxs("div",{className:"ticket-section-header",children:[s.jsx(is,{size:14}),s.jsx("span",{children:"Photo Evidence"}),s.jsx("span",{className:"section-count",children:n.photos.length})]}),s.jsx("div",{className:"photo-evidence-grid",children:n.photos.map((l,_)=>s.jsx("a",{href:l,target:"_blank",rel:"noopener noreferrer",className:"photo-evidence-item",children:s.jsx("img",{src:l,alt:`Evidence ${_+1}`,onError:es=>{es.target.onerror=null,es.target.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=="}})},_))})]}),U&&s.jsxs("div",{className:"ticket-verification-footer",children:[s.jsx("div",{className:"verification-seal-icon",children:s.jsx(g,{size:22})}),n.client_signature_data&&s.jsx("img",{src:n.client_signature_data,alt:"Client Signature",className:"verification-signature-img"}),s.jsxs("div",{className:"verification-info",children:[s.jsx("span",{className:"signer-name",children:n.client_signature_name||"Client"}),(n.client_signature_title||n.client_signature_company)&&s.jsx("span",{className:"signer-title",children:[n.client_signature_title,n.client_signature_company].filter(Boolean).join(", ")}),n.client_signature_date&&s.jsxs("span",{className:"verify-date",children:["Verified ",k(n.client_signature_date)]})]})]})]})]},n.id)})}),s.jsxs("div",{className:"backup-note",children:[s.jsx(as,{size:14}),s.jsx("span",{children:"This documentation supports the work described in this Change Order Request."})]})]})})(),s.jsxs("div",{className:"cor-totals-card",children:[s.jsx("h4",{children:"COR Summary"}),s.jsxs("div",{className:"cor-totals-grid",children:[s.jsxs("div",{className:"cor-total-row",children:[s.jsx("span",{children:"COR Subtotal"}),s.jsx("span",{children:d(c.cor_subtotal)})]}),s.jsxs("div",{className:"cor-fees-section",children:[s.jsxs("div",{className:"cor-fee-row",children:[s.jsxs("span",{children:["Liability Insurance (",S(a.liability_insurance_percent||144),")"]}),s.jsx("span",{children:d(c.liability_insurance_amount)})]}),s.jsxs("div",{className:"cor-fee-row",children:[s.jsxs("span",{children:["Bond (",S(a.bond_percent||100),")"]}),s.jsx("span",{children:d(c.bond_amount)})]}),s.jsxs("div",{className:"cor-fee-row",children:[s.jsxs("span",{children:["City License Fee (",S(a.license_fee_percent||10),")"]}),s.jsx("span",{children:d(c.license_fee_amount)})]})]}),s.jsxs("div",{className:"cor-grand-total",children:[s.jsx("span",{children:"COR TOTAL"}),s.jsx("span",{children:d(c.cor_total)})]})]})]}),s.jsxs("div",{className:"cor-signature-section",children:[s.jsx("h4",{children:"Authorization"}),s.jsx("p",{className:"signature-instruction",children:"By signing below, you authorize the above change order request and agree to the terms and costs outlined."}),s.jsx("div",{className:"signature-slots-grid",children:I?s.jsxs(s.Fragment,{children:[h&&s.jsxs("div",{className:"signature-slot-card signed",children:[s.jsxs("div",{className:"slot-header",children:[s.jsx(g,{size:20,className:"status-icon signed"}),s.jsx("span",{className:"slot-label",children:"GC Authorization"})]}),s.jsxs("div",{className:"slot-signed-info",children:[h.signature_data&&s.jsx("img",{src:h.signature_data,alt:"Signature",className:"signature-image"}),s.jsxs("div",{className:"signer-details",children:[s.jsx("span",{className:"signer-name",children:h.signer_name}),(h.signer_title||h.signer_company)&&s.jsxs("span",{className:"signer-org",children:[h.signer_title,h.signer_title&&h.signer_company&&" — ",h.signer_company]})]}),s.jsxs("span",{className:"signed-date",children:["Signed ",k(h.signed_at)]})]})]}),m&&s.jsxs("div",{className:"signature-slot-card signed",children:[s.jsxs("div",{className:"slot-header",children:[s.jsx(g,{size:20,className:"status-icon signed"}),s.jsx("span",{className:"slot-label",children:"Client Authorization"})]}),s.jsxs("div",{className:"slot-signed-info",children:[m.signature_data&&s.jsx("img",{src:m.signature_data,alt:"Signature",className:"signature-image"}),s.jsxs("div",{className:"signer-details",children:[s.jsx("span",{className:"signer-name",children:m.signer_name}),(m.signer_title||m.signer_company)&&s.jsxs("span",{className:"signer-org",children:[m.signer_title,m.signer_title&&m.signer_company&&" — ",m.signer_company]})]}),s.jsxs("span",{className:"signed-date",children:["Signed ",k(m.signed_at)]})]})]})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:`signature-slot-card ${h?"signed":"unsigned"}`,children:[s.jsxs("div",{className:"slot-header",children:[h?s.jsx(g,{size:20,className:"status-icon signed"}):s.jsx(Y,{size:20,className:"status-icon pending"}),s.jsx("span",{className:"slot-label",children:"GC Authorization"})]}),s.jsx("button",{className:"btn btn-primary sign-btn",onClick:()=>z(1),disabled:C,children:"Sign as GC"})]}),s.jsx("p",{className:"or-divider",children:"— or —"}),s.jsxs("div",{className:`signature-slot-card ${m?"signed":"unsigned"}`,children:[s.jsxs("div",{className:"slot-header",children:[m?s.jsx(g,{size:20,className:"status-icon signed"}):s.jsx(Y,{size:20,className:"status-icon pending"}),s.jsx("span",{className:"slot-label",children:"Client Authorization"})]}),s.jsx("button",{className:"btn btn-primary sign-btn",onClick:()=>z(2),disabled:C,children:"Sign as Client"})]})]})}),I&&s.jsxs("div",{className:"fully-signed-message",children:[s.jsx(g,{size:24}),s.jsx("p",{children:"This change order request has been signed."})]}),s.jsxs("div",{className:"cor-download-section",children:[s.jsx("h4",{children:"Download Your Copy"}),s.jsx("p",{className:"download-description",children:I?"Download a PDF copy of this fully signed COR including all T&M backup documentation.":"Download a PDF copy of this COR for your records. Signature status will be included."}),s.jsx("button",{className:"btn btn-primary download-btn",onClick:ss,disabled:T,children:T?s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"download-spinner"}),"Generating PDF..."]}):s.jsxs(s.Fragment,{children:[s.jsx(G,{size:18}),"Download COR + Backup"]})})]})]})]}),s.jsx("footer",{className:"signature-page-footer",children:s.jsx("p",{children:"Powered by FieldSync"})}),J&&w&&s.jsx(ds,{enhanced:!0,requireAcknowledgment:!0,lockBodyScroll:!0,slot:w,documentType:p.document_type,documentTitle:`${a.cor_number} - ${a.title}`,onSave:X,onClose:()=>{q(!1),R(null)}})]})}function L(u,o,N,f,j){return s.jsxs("div",{className:`signature-slot-card ${o?"signed":"unsigned"}`,children:[s.jsxs("div",{className:"slot-header",children:[o?s.jsx(g,{size:20,className:"status-icon signed"}):s.jsx(Y,{size:20,className:"status-icon pending"}),s.jsxs("span",{className:"slot-label",children:["Signature ",u," — ",N]})]}),o?s.jsxs("div",{className:"slot-signed-info",children:[s.jsxs("div",{className:"signer-details",children:[s.jsx("span",{className:"signer-name",children:o.signer_name}),(o.signer_title||o.signer_company)&&s.jsxs("span",{className:"signer-org",children:[o.signer_title,o.signer_title&&o.signer_company&&" — ",o.signer_company]})]}),s.jsxs("span",{className:"signed-date",children:["Signed ",k(o.signed_at)]})]}):s.jsxs("button",{className:"btn btn-primary sign-btn",onClick:()=>f(u),disabled:j,children:["Sign as ",u===1?"GC":"Client"]})]})}export{Bs as default};
//# sourceMappingURL=SignaturePage-TJC7nAv1.js.map
