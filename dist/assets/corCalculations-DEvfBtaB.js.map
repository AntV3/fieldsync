{"version":3,"file":"corCalculations-DEvfBtaB.js","sources":["../../src/lib/corCalculations.js"],"sourcesContent":["// ============================================\n// COR (Change Order Request) Calculations\n// ============================================\n// Utility functions for client-side calculations\n// All monetary values are stored in cents to avoid floating point issues\n\n// Helper to convert cents to dollars with formatting\nexport const centsToDollars = (cents) => {\n  const dollars = (cents || 0) / 100\n  return dollars.toFixed(2)\n}\n\n// Helper to format cents as currency\nexport const formatCurrency = (cents) => {\n  const dollars = (cents || 0) / 100\n  return new Intl.NumberFormat('en-US', {\n    style: 'currency',\n    currency: 'USD',\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2\n  }).format(dollars)\n}\n\n// Helper to convert dollars to cents\nexport const dollarsToCents = (dollars) => {\n  return Math.round((parseFloat(dollars) || 0) * 100)\n}\n\n// Helper to convert basis points to percentage (1500 -> 15.00)\nexport const basisPointsToPercent = (bp) => {\n  return ((bp || 0) / 100).toFixed(2)\n}\n\n// Helper to format basis points as percentage string (1500 -> \"15.00%\")\nexport const formatPercent = (bp) => {\n  return `${basisPointsToPercent(bp)}%`\n}\n\n// Helper to convert percentage to basis points (15.00 -> 1500)\nexport const percentToBasisPoints = (pct) => {\n  return Math.round((parseFloat(pct) || 0) * 100)\n}\n\n// Calculate labor item totals\nexport const calculateLaborItemTotal = (regularHours, overtimeHours, regularRate, overtimeRate) => {\n  const regHrs = parseFloat(regularHours) || 0\n  const otHrs = parseFloat(overtimeHours) || 0\n  const regRate = parseInt(regularRate) || 0\n  const otRate = parseInt(overtimeRate) || 0\n\n  const regularTotal = Math.round(regHrs * regRate)\n  const overtimeTotal = Math.round(otHrs * otRate)\n  const total = regularTotal + overtimeTotal\n\n  return {\n    regularTotal,\n    overtimeTotal,\n    total\n  }\n}\n\n// Calculate line item total (for materials, equipment, subcontractors)\nexport const calculateLineItemTotal = (quantity, unitCost) => {\n  const qty = parseFloat(quantity) || 0\n  const cost = parseInt(unitCost) || 0\n  return Math.round(qty * cost)\n}\n\n// Calculate markup amount from subtotal and basis points\nexport const calculateMarkup = (subtotal, markupBasisPoints) => {\n  const sub = parseInt(subtotal) || 0\n  const bp = parseInt(markupBasisPoints) || 0\n  return Math.round((sub * bp) / 10000)\n}\n\n// Calculate fee amount from subtotal and basis points\nexport const calculateFee = (subtotal, feeBasisPoints) => {\n  const sub = parseInt(subtotal) || 0\n  const bp = parseInt(feeBasisPoints) || 0\n  return Math.round((sub * bp) / 10000)\n}\n\n// Calculate complete COR totals from line items and percentages\nexport const calculateCORTotals = (cor) => {\n  // Sum up subtotals from line items\n  const laborSubtotal = (cor.change_order_labor || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const materialsSubtotal = (cor.change_order_materials || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const equipmentSubtotal = (cor.change_order_equipment || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n  const subcontractorsSubtotal = (cor.change_order_subcontractors || []).reduce(\n    (sum, item) => sum + (parseInt(item.total) || 0), 0\n  )\n\n  // Calculate markups (use ?? to allow 0% markup)\n  const laborMarkupAmount = calculateMarkup(laborSubtotal, cor.labor_markup_percent ?? 1500)\n  const materialsMarkupAmount = calculateMarkup(materialsSubtotal, cor.materials_markup_percent ?? 1500)\n  const equipmentMarkupAmount = calculateMarkup(equipmentSubtotal, cor.equipment_markup_percent ?? 1500)\n  const subcontractorsMarkupAmount = calculateMarkup(subcontractorsSubtotal, cor.subcontractors_markup_percent ?? 500)\n\n  // COR subtotal (all costs + all markups)\n  const corSubtotal = laborSubtotal + materialsSubtotal + equipmentSubtotal + subcontractorsSubtotal +\n                      laborMarkupAmount + materialsMarkupAmount + equipmentMarkupAmount + subcontractorsMarkupAmount\n\n  // Calculate additional fees (use ?? to allow 0% fees)\n  const liabilityInsuranceAmount = calculateFee(corSubtotal, cor.liability_insurance_percent ?? 144)\n  const bondAmount = calculateFee(corSubtotal, cor.bond_percent ?? 100)\n  const licenseFeeAmount = calculateFee(corSubtotal, cor.license_fee_percent ?? 10)\n\n  const additionalFeesTotal = liabilityInsuranceAmount + bondAmount + licenseFeeAmount\n\n  // Final COR total\n  const corTotal = corSubtotal + additionalFeesTotal\n\n  return {\n    // Subtotals\n    labor_subtotal: laborSubtotal,\n    materials_subtotal: materialsSubtotal,\n    equipment_subtotal: equipmentSubtotal,\n    subcontractors_subtotal: subcontractorsSubtotal,\n\n    // Markup amounts\n    labor_markup_amount: laborMarkupAmount,\n    materials_markup_amount: materialsMarkupAmount,\n    equipment_markup_amount: equipmentMarkupAmount,\n    subcontractors_markup_amount: subcontractorsMarkupAmount,\n\n    // Fees\n    liability_insurance_amount: liabilityInsuranceAmount,\n    bond_amount: bondAmount,\n    license_fee_amount: licenseFeeAmount,\n    additional_fees_total: additionalFeesTotal,\n\n    // Totals\n    cor_subtotal: corSubtotal,\n    cor_total: corTotal\n  }\n}\n\n// Validate COR before submission\nexport const validateCOR = (cor) => {\n  const errors = []\n\n  // Required fields: title and description only\n  if (!cor.title?.trim()) {\n    errors.push('Title is required')\n  }\n  if (!cor.scope_of_work?.trim()) {\n    errors.push('Description is required')\n  }\n\n  // Date validation (only if both dates provided)\n  if (cor.period_start && cor.period_end) {\n    const start = new Date(cor.period_start)\n    const end = new Date(cor.period_end)\n    if (end < start) {\n      errors.push('End date must be after start date')\n    }\n  }\n\n  // Markup percentage validation (should be reasonable)\n  const maxMarkup = 5000 // 50%\n  if (cor.labor_markup_percent > maxMarkup) {\n    errors.push('Labor markup percentage seems too high (>50%)')\n  }\n  if (cor.materials_markup_percent > maxMarkup) {\n    errors.push('Materials markup percentage seems too high (>50%)')\n  }\n  if (cor.equipment_markup_percent > maxMarkup) {\n    errors.push('Equipment markup percentage seems too high (>50%)')\n  }\n  if (cor.subcontractors_markup_percent > maxMarkup) {\n    errors.push('Subcontractors markup percentage seems too high (>50%)')\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors\n  }\n}\n\n// Get status display info\nexport const getStatusInfo = (status) => {\n  const statusMap = {\n    draft: {\n      label: 'Draft',\n      color: '#6b7280', // gray\n      bgColor: '#f3f4f6'\n    },\n    pending_approval: {\n      label: 'Pending Approval',\n      color: '#d97706', // amber\n      bgColor: '#fef3c7'\n    },\n    approved: {\n      label: 'Approved',\n      color: '#059669', // green\n      bgColor: '#d1fae5'\n    },\n    rejected: {\n      label: 'Rejected',\n      color: '#dc2626', // red\n      bgColor: '#fee2e2'\n    },\n    billed: {\n      label: 'Billed',\n      color: '#2563eb', // blue\n      bgColor: '#dbeafe'\n    },\n    closed: {\n      label: 'Closed',\n      color: '#4b5563', // gray-dark\n      bgColor: '#e5e7eb'\n    }\n  }\n\n  return statusMap[status] || statusMap.draft\n}\n\n// Format date for display\nexport const formatDate = (dateStr) => {\n  if (!dateStr) return ''\n  const date = new Date(dateStr)\n  return date.toLocaleDateString('en-US', {\n    month: 'short',\n    day: 'numeric',\n    year: 'numeric'\n  })\n}\n\n// Format date range\nexport const formatDateRange = (startStr, endStr) => {\n  const start = formatDate(startStr)\n  const end = formatDate(endStr)\n  if (start && end) {\n    return `${start} - ${end}`\n  }\n  return start || end || ''\n}\n\n// Default markup and fee percentages (in basis points)\nexport const DEFAULT_PERCENTAGES = {\n  labor_markup: 1500, // 15.00%\n  materials_markup: 1500, // 15.00%\n  equipment_markup: 1500, // 15.00%\n  subcontractors_markup: 500, // 5.00%\n  liability_insurance: 144, // 1.44%\n  bond: 100, // 1.00%\n  license_fee: 10 // 0.10% (approximation of 0.101%)\n}\n\n// Labor classes for dropdown\nexport const LABOR_CLASSES = [\n  'Foreman',\n  'Superintendent',\n  'Operator',\n  'Laborer'\n]\n\n// Wage types for dropdown\nexport const WAGE_TYPES = [\n  { value: 'standard', label: 'Standard' },\n  { value: 'pla', label: 'PLA (Project Labor Agreement)' },\n  { value: 'prevailing', label: 'Prevailing Wage' }\n]\n\n// Source types for line items\nexport const SOURCE_TYPES = {\n  materials: [\n    { value: 'backup_sheet', label: 'Backup Sheet' },\n    { value: 'invoice', label: 'Invoice' },\n    { value: 'mobilization', label: 'Mobilization' },\n    { value: 'custom', label: 'Custom Entry' }\n  ],\n  equipment: [\n    { value: 'backup_sheet', label: 'Backup Sheet' },\n    { value: 'invoice', label: 'Invoice' },\n    { value: 'custom', label: 'Custom Entry' }\n  ],\n  subcontractors: [\n    { value: 'invoice', label: 'Invoice' },\n    { value: 'quote', label: 'Quote' },\n    { value: 'custom', label: 'Custom Entry' }\n  ]\n}\n\n// Common units for line items\nexport const COMMON_UNITS = [\n  'each',\n  'day',\n  'week',\n  'month',\n  'hour',\n  'sqft',\n  'lf',\n  'gallon',\n  'pound',\n  'ton',\n  'cy',\n  'lump sum'\n]\n"],"names":["centsToDollars","cents","formatCurrency","dollars","dollarsToCents","basisPointsToPercent","bp","formatPercent","percentToBasisPoints","pct","calculateLaborItemTotal","regularHours","overtimeHours","regularRate","overtimeRate","regHrs","otHrs","regRate","otRate","regularTotal","overtimeTotal","total","calculateLineItemTotal","quantity","unitCost","qty","cost","calculateMarkup","subtotal","markupBasisPoints","sub","calculateFee","feeBasisPoints","calculateCORTotals","cor","laborSubtotal","sum","item","materialsSubtotal","equipmentSubtotal","subcontractorsSubtotal","laborMarkupAmount","materialsMarkupAmount","equipmentMarkupAmount","subcontractorsMarkupAmount","corSubtotal","liabilityInsuranceAmount","bondAmount","licenseFeeAmount","additionalFeesTotal","corTotal","validateCOR","errors","start","maxMarkup","getStatusInfo","status","statusMap","formatDate","dateStr","formatDateRange","startStr","endStr","end","DEFAULT_PERCENTAGES","LABOR_CLASSES","WAGE_TYPES","COMMON_UNITS"],"mappings":"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"}