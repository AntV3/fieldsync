import{r as m,j as e,d as Y}from"./index-G650D6qg.js";import{read as Oe,utils as Re}from"./xlsx-BvJTHLik.js";import"./react-DXGY7bZi.js";import"./pdf-ChZ1zkDw.js";import"./supabase-VuevzHjS.js";const K=x=>{if(x==null||x==="")return"";const y=parseFloat(x);return isNaN(y)?"":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(y)},be=x=>{if(!x)return null;const y=String(x).replace(/[$,\s]/g,""),V=parseFloat(y);return isNaN(V)?null:V};function ze({company:x,user:y,onProjectCreated:V,onShowToast:i}){const[M,Q]=m.useState(""),[Z,X]=m.useState(""),[ee,te]=m.useState(""),[ae,se]=m.useState(""),[ne,re]=m.useState(""),[k,T]=m.useState(""),[_,O]=m.useState("demolition"),[R,U]=m.useState("standard"),[g,f]=m.useState([{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null}]),[le,ie]=m.useState(!1),[ce,q]=m.useState(!1),[Ne,A]=m.useState(!1),[j,B]=m.useState([]),[oe,G]=m.useState(!1),[v,de]=m.useState(""),[w,ue]=m.useState(""),[L,me]=m.useState(""),D=m.useRef(null),W=g.reduce((t,n)=>t+(parseFloat(n.weight)||0),0),ye=t=>{const n=t.replace(/\D/g,"").slice(0,4);T(n)},we=()=>{const t=new Uint32Array(1);crypto.getRandomValues(t);const n=(1e3+t[0]%9e3).toString();T(n)},C=(t,n,a)=>{f(s=>s.map((r,l)=>l===t?{...r,[n]:a}:r))},Ce=()=>{f(t=>[...t,{name:"",weight:"",group:"",scheduledValue:null}])},he=t=>{g.length>1&&f(n=>n.filter((a,s)=>s!==t))},pe=(t="value")=>{const n=g.filter(o=>o.name.trim());if(n.length===0){i("Add tasks first","error");return}let a=[...g];const s=g.map((o,c)=>o.name.trim()?c:-1).filter(o=>o>=0);if(t==="value"){const o=n.reduce((c,d)=>c+(parseFloat(d.scheduledValue)||0),0);if(o===0)i("No scheduled values - using equal distribution","info"),t="equal";else{let c=0;s.forEach((d,z)=>{const F=parseFloat(g[d].scheduledValue)||0;let b;z===s.length-1?b=100-c:(b=Math.round(F/o*1e4)/100,c+=b),a[d]={...a[d],weight:b.toFixed(2)}}),f(a),G(!1),i("Weights calculated by value","success");return}}const r=Math.round(100/s.length*100)/100;let l=0;s.forEach((o,c)=>{let d;c===s.length-1?d=100-l:(d=r,l+=d),a[o]={...a[o],weight:d.toFixed(2)}}),f(a),G(!1),i("Weights distributed equally","success")},Se=()=>{Q(""),X(""),te(""),se(""),re(""),T(""),O("demolition"),U("standard"),de(""),ue(""),me(""),f([{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null},{name:"",weight:"",group:"",scheduledValue:null}]),A(!1),B([])},Ve=()=>{D.current?.click()},ke=t=>new Promise((n,a)=>{const s=new FileReader;s.onload=r=>{try{const l=new Uint8Array(r.target.result),o=Oe(l,{type:"array"}),c=o.SheetNames[0],d=o.Sheets[c],z=Re.sheet_to_json(d,{header:1}),F=[];let b="General";const ge=/^\$?\d{1,3}(,\d{3})*(\.\d{2})?$/,I=/^(\d+\.?\d*|[A-Z]\.?\d*)$/i,$e=/^(SF|LF|EA|LS|Days?|MD|Load|CY|SY|GAL|TON)$/i,Ee=/^\d{1,3}(,\d{3})*$|^\d+$/,xe=/^(Item|#|No\.?|Description|Scheduled|Value|Amount|Quantity|Unit|Total|Application|Balance|Completed|Stored|Retainage)/i;for(const S of z){if(!S||S.length===0)continue;const u=S.map(p=>p==null?"":String(p).trim()).filter(p=>p.length>0);if(u.length===0)continue;const Te=u.join(" ");if(xe.test(u[0])||u.length>1&&xe.test(u[1])||/^(Total|Subtotal|Grand Total|Base Bid|Contract Sum)/i.test(Te))continue;const J=u.some(p=>ge.test(p.replace(/[$,]/g,"")+(p.includes(".")?"":".00")));if((!J&&u.length<=3&&/^(L\d|Level|Floor|\d+(?:st|nd|rd|th)|Plaza|Street|Basement|Roof|Penthouse|Site|Exterior|Interior|Misc|MEP|ABATEMENT|DEMOLITION|UNIVERSAL|SOFT|TRASH|DEMO|Phase|Division|Section|Area|Building|Wing)/i.test(u[0])||u.length===2&&I.test(u[0])&&!J&&!/^\d+\.\d+$/.test(u[0]))&&!J){b=(u.find(h=>!I.test(h)&&h.length>1)||u.join(" ")).replace(/\s*\(\d{1,3}(?:,\d{3})*\s*SF\)\s*$/i,"").replace(/\s*[-:]\s*$/,"").trim();continue}let N="",H=!1,fe="",$=null;const ve=[];for(let p=0;p<u.length;p++){const h=u[p];if(p===0&&I.test(h)){fe=h;continue}if(!/^ID-\d+$/i.test(h)&&!/^KN\s*\d+$/i.test(h)){if(ge.test(h.replace(/[$,]/g,"")+(h.includes(".")?"":".00"))||/^\$/.test(h)){const _e=h.replace(/[$,]/g,""),E=parseFloat(_e);!isNaN(E)&&E>100&&($===null||E>$)&&($=E),H=!0;continue}if(Ee.test(h.replace(/,/g,""))){H=!0;continue}$e.test(h)||/^\d+\.?\d*%$/.test(h)||h.length>1&&!I.test(h)&&ve.push(h)}}N=ve.join(" ").trim(),N=N.replace(/\s+/g," ").replace(/^[-â€¢]\s*/,"").trim(),!(N.length<3)&&(/^(Plan|Page|Total|Base Bid|Payment|Condition|Exclusion|Subtotal)/i.test(N)||H&&N.length>=3&&F.push({name:N,group:b,itemNumber:fe,scheduledValue:$,selected:!0}))}const je=new Set,Me=F.filter(S=>{const u=`${S.group}:${S.name}`;return je.has(u)?!1:(je.add(u),!0)});n(Me)}catch(l){a(l)}},s.onerror=()=>a(new Error("Failed to read file")),s.readAsArrayBuffer(t)}),Ae=async t=>{const n=t.target.files?.[0];if(!n)return;const a=n.name.split(".").pop().toLowerCase();if(!["xlsx","xls","csv"].includes(a)){i("Please upload an Excel file (.xlsx, .xls, or .csv)","error");return}q(!0);try{const s=await ke(n);if(s.length===0){i("No tasks found. Check Excel format.","error"),q(!1);return}B(s),A(!0),i(`Found ${s.length} tasks`,"success")}catch(s){console.error("Excel import error:",s),i("Error reading Excel file","error")}finally{q(!1),D.current&&(D.current.value="")}},De=t=>{B(n=>n.map((a,s)=>s===t?{...a,selected:!a.selected}:a))},Pe=()=>{const t=j.filter(r=>r.selected);if(t.length===0){i("Please select at least one task","error");return}const n=t.reduce((r,l)=>r+(l.scheduledValue||0),0),a=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});let s;if(n>0){let r=0;s=t.map((l,o)=>{const c=l.scheduledValue||0;let d;return o===t.length-1?d=100-r:(d=Math.round(c/n*1e4)/100,r+=d),{name:l.name,weight:d.toFixed(2),group:l.group,scheduledValue:l.scheduledValue||null}}),i(`Tasks imported with value-based weights! Total SOV: ${a.format(n)}`,"success")}else{const r=Math.round(100/t.length*100)/100;s=t.map((l,o)=>({name:l.name,weight:o===t.length-1?(100-r*(t.length-1)).toFixed(2):r.toFixed(2),group:l.group,scheduledValue:l.scheduledValue||null})),i("Tasks imported with equal weights","success")}f(s),A(!1)},Fe=async()=>{if(!x?.id){i("No company selected. Please log in again.","error");return}if(!M.trim()){i("Please enter a project name","error");return}const t=parseFloat(ne);if(!t||t<=0){i("Please enter a valid contract value","error");return}if(k.length!==4){i("Please enter a 4-digit PIN","error");return}if(!await Y.isPinAvailable(k)){i("This PIN is already in use. Try another.","error");return}const a=g.filter(s=>s.name.trim()&&parseFloat(s.weight)>0);if(a.length===0){i("Please add at least one area","error");return}if(Math.abs(W-100)>.1){i("Area weights must total 100%","error");return}if(!v||!w){i("Start date and end date are required","error");return}if(new Date(w)<new Date(v)){i("End date must be on or after start date","error");return}ie(!0);try{const s=await Y.createProject({name:M.trim(),job_number:Z.trim()||null,address:ee.trim()||null,general_contractor:ae.trim()||null,contract_value:t,pin:k,work_type:_,job_type:R,company_id:x?.id,created_by:y?.id,start_date:v,end_date:w,planned_man_days:L?parseInt(L):null});for(let r=0;r<a.length;r++)await Y.createArea({project_id:s.id,name:a[r].name.trim(),weight:parseFloat(a[r].weight),scheduled_value:a[r].scheduledValue||null,group_name:a[r].group||null,status:"not_started",sort_order:r});i("Project created!","success"),Se(),V()}catch(s){console.error("Error creating project:",s),i("Error creating project","error")}finally{ie(!1)}};if(Ne){const t=[...new Set(j.map(r=>r.group))],n=j.filter(r=>r.selected).length,a=j.reduce((r,l)=>r+(l.scheduledValue||0),0),s=j.filter(r=>r.selected).reduce((r,l)=>r+(l.scheduledValue||0),0);return e.jsxs("div",{children:[e.jsx("h1",{children:"Review Imported Tasks"}),e.jsx("p",{className:"subtitle",children:"Select the tasks to include in your project"}),e.jsxs("div",{className:"import-summary",children:[e.jsxs("span",{children:[n," of ",j.length," tasks selected"]}),a>0&&e.jsxs("span",{className:"import-sov-total",children:["Â· Total SOV: ",new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)]})]}),t.map(r=>{const l=j.filter(c=>c.group===r),o=l.filter(c=>c.selected).length;return e.jsxs("div",{className:"card import-group",children:[e.jsxs("div",{className:"import-group-header",children:[e.jsx("h3",{children:r}),e.jsxs("span",{className:"import-group-count",children:[o,"/",l.length]})]}),e.jsx("div",{className:"import-task-list",children:l.map(c=>{const d=j.indexOf(c);return e.jsxs("label",{className:"import-task-item",children:[e.jsx("input",{type:"checkbox",checked:c.selected,onChange:()=>De(d)}),e.jsx("span",{className:"import-task-name",children:c.name}),c.scheduledValue>0&&e.jsx("span",{className:"import-task-value",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(c.scheduledValue)})]},d)})})]},r)}),e.jsxs("div",{className:"import-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>A(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:Pe,children:["Use Selected Tasks (",n,")"]})]})]})}const P=g.reduce((t,n,a)=>{const s=n.group||"General";return t[s]||(t[s]=[]),t[s].push({...n,originalIndex:a}),t},{}),Ie=Object.keys(P).length>1||Object.keys(P).length===1&&!P.General;return e.jsxs("div",{children:[e.jsx("h1",{children:"New Project"}),e.jsx("p",{className:"subtitle",children:"Set up a new project to track"}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Name"}),e.jsx("input",{type:"text",placeholder:"e.g., Sunrise Apartments",value:M,onChange:t=>Q(t.target.value)})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Number"}),e.jsx("input",{type:"text",placeholder:"e.g., 4032",value:Z,onChange:t=>X(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Contract Value ($)"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"e.g., 365000",value:ne,onChange:t=>{const n=t.target.value.replace(/[^0-9.]/g,"");re(n)},className:"currency-input"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Project Address"}),e.jsx("input",{type:"text",placeholder:"e.g., 123 Main St, Los Angeles, CA 90001",value:ee,onChange:t=>te(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"General Contractor"}),e.jsx("input",{type:"text",placeholder:"e.g., ABC Construction Inc.",value:ae,onChange:t=>se(t.target.value)})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Start Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:v,onChange:t=>de(t.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["End Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:w,onChange:t=>ue(t.target.value),min:v||void 0,required:!0}),v&&w&&new Date(w)<new Date(v)&&e.jsx("span",{className:"error-text",children:"End date must be after start date"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Planned Man-Days ",e.jsx("span",{className:"optional",children:"(optional)"})]}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.85rem",marginBottom:"0.5rem"},children:"Total estimated man-days to complete the project"}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"e.g., 120",value:L,onChange:t=>me(t.target.value.replace(/\D/g,"")),min:"1"})]}),e.jsxs("div",{className:"form-row-2",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Work Type"}),e.jsxs("div",{className:"project-type-toggle",children:[e.jsx("button",{type:"button",className:`toggle-btn ${_==="demolition"?"active":""}`,onClick:()=>O("demolition"),children:"Demolition"}),e.jsx("button",{type:"button",className:`toggle-btn ${_==="abatement"?"active":""}`,onClick:()=>O("abatement"),children:"Abatement"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Job Type"}),e.jsxs("div",{className:"project-type-toggle",children:[e.jsx("button",{type:"button",className:`toggle-btn ${R==="standard"?"active":""}`,onClick:()=>U("standard"),children:"Standard"}),e.jsx("button",{type:"button",className:`toggle-btn ${R==="pla"?"active":""}`,onClick:()=>U("pla"),children:"PLA"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Foreman PIN (4 digits)"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.85rem",marginBottom:"0.5rem"},children:"Foremen will enter this PIN to access this project"}),e.jsxs("div",{className:"pin-input-row",children:[e.jsx("input",{type:"text",placeholder:"e.g., 2847",value:k,onChange:t=>ye(t.target.value),maxLength:4,className:"pin-input"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:we,children:"Generate"})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"areas-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Areas / Tasks"}),e.jsx("p",{style:{color:"var(--text-secondary)",fontSize:"0.9rem",marginTop:"0.25rem"},children:"Define the areas for this project. Weights must total 100%."})]}),e.jsxs("div",{className:"import-btn-container",children:[e.jsx("input",{ref:D,type:"file",accept:".xlsx,.xls,.csv",onChange:Ae,style:{display:"none"}}),e.jsx("button",{className:"btn btn-secondary btn-small",onClick:Ve,disabled:ce,children:ce?"Reading...":"ðŸ“Š Import Excel"})]})]}),Ie?Object.entries(P).map(([t,n])=>e.jsxs("div",{className:"area-group",children:[e.jsx("div",{className:"area-group-header",children:t}),n.map(a=>e.jsxs("div",{className:"area-row area-row-with-value",children:[e.jsx("input",{type:"text",placeholder:"Task name",value:a.name,onChange:s=>C(a.originalIndex,"name",s.target.value),className:"area-name-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"$0",value:a.scheduledValue?K(a.scheduledValue):"",onChange:s=>C(a.originalIndex,"scheduledValue",be(s.target.value)),className:"currency-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"%",value:a.weight,onChange:s=>C(a.originalIndex,"weight",s.target.value),className:"weight-input"}),e.jsx("button",{className:"remove-btn",onClick:()=>he(a.originalIndex),children:"Ã—"})]},a.originalIndex))]},t)):g.map((t,n)=>e.jsxs("div",{className:"area-row area-row-with-value",children:[e.jsx("input",{type:"text",placeholder:"Area name (e.g., Level 1)",value:t.name,onChange:a=>C(n,"name",a.target.value),className:"area-name-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"$0",value:t.scheduledValue?K(t.scheduledValue):"",onChange:a=>C(n,"scheduledValue",be(a.target.value)),className:"currency-input"}),e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"%",value:t.weight,onChange:a=>C(n,"weight",a.target.value),className:"weight-input"}),e.jsx("button",{className:"remove-btn",onClick:()=>he(n),children:"Ã—"})]},n)),e.jsxs("div",{className:"weight-total-row",children:[e.jsxs("div",{className:"weight-total",children:[e.jsx("span",{className:"weight-total-label",children:"Total Weight:"}),e.jsxs("span",{className:`weight-total-value ${Math.abs(W-100)<.1?"valid":"invalid"}`,children:[W.toFixed(1),"%"]}),g.some(t=>t.scheduledValue>0)&&e.jsxs("span",{className:"sov-total",children:["Â· SOV: ",K(g.reduce((t,n)=>t+(parseFloat(n.scheduledValue)||0),0))]})]}),e.jsxs("div",{className:"auto-weight-dropdown",children:[e.jsx("button",{type:"button",className:"btn btn-secondary btn-small",onClick:()=>G(!oe),children:"Auto-Calculate â–¼"}),oe&&e.jsxs("div",{className:"weight-dropdown-menu",children:[e.jsxs("button",{onClick:()=>pe("value"),children:["By Value ",e.jsx("span",{className:"dropdown-hint",children:"(Recommended)"})]}),e.jsx("button",{onClick:()=>pe("equal"),children:"Equal Distribution"})]})]})]}),e.jsx("button",{className:"btn btn-secondary",onClick:Ce,children:"+ Add Area"})]}),e.jsx("button",{className:"btn btn-primary btn-full",onClick:Fe,disabled:le,children:le?"Creating...":"Create Project"})]})}export{ze as default};
