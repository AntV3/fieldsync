const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SignatureLinkGenerator-CXS_5_K-.js","assets/index-BQ9XEaVB.js","assets/router-D4FaBdHo.js","assets/pdf-CZoZYm0R.js","assets/supabase-TBgbXMHz.js","assets/icons-C1b61Abg.js","assets/index-DgNh7iNg.css","assets/TMClientSignature-NxvBxiIi.js"])))=>i.map(i=>d[i]);
import{j as e,d as w,i as fs,g as Xs}from"./index-BQ9XEaVB.js";import{r as l}from"./router-D4FaBdHo.js";import{R as Be,P as Zs,a as ea,C as sa,T as Ve,B as aa,b as ns,X as os,Y as ls,c as ta,L as ra,d as ia,e as na,I as oa}from"./PieChart-AkH_Lga0.js";import{g as la,c as cs}from"./imageUtils-D6AoaJeg.js";import{F as Ee,b as Se,e as Ne,f as Ke,g as ca,H as ke,L as Je,h as da,i as ds,j as ma,k as ua,l as ve,R as ms,P as He,m as ha,W as pa,Z as ga,G as xa,U as fa,n as ba,T as bs,o as va,p as Fe,q as us,r as Ge,X as ja,s as ya,t as vs,u as Me,A as be,v as js,w as ys,x as Na,y as ka,z as wa,I as Ca,J as Sa,K as Ns,N as Ea,O as La,Q as _a,V as Aa,C as Ra,Y as Da,S as za,M as Ta}from"./icons-C1b61Abg.js";import{_ as ks}from"./pdf-CZoZYm0R.js";import{F as Ha}from"./FolderGrid-DP53jGYL.js";import Oa from"./PunchList-B0N64K7e.js";import"./supabase-TBgbXMHz.js";const Ye=["Containment","PPE","Disposal","Equipment"],ws={en:{workInfo:"Work Details",crewHours:"Crew & Hours",materialsEquipment:"Materials",evidence:"Evidence",review:"Review",quickActions:"Quick Actions",sameAsYesterday:"Same as Yesterday",setCrewHours:"Set Crew Hours",loading:"Loading...",supervision:"Supervision",operators:"Operators",laborers:"Laborers",addSupervision:"+ Add Supervision",addOperator:"+ Add Operator",addLaborer:"+ Add Laborer",foreman:"Foreman",superintendent:"Superintendent",firstLastName:"First & Last Name",start:"Start",end:"End",regHrs:"Reg Hrs",otHrs:"OT Hrs",selectCategory:"Select a category:",addCustomItem:"+ Add Custom Item",customItem:"Custom Item",itemName:"Item Name",category:"Category",quantity:"Quantity",addItem:"Add Item",cancel:"Cancel",noItemsCategory:"No items in this category yet",workDate:"Work Date",ceNumber:"CE/PCO #",optional:"optional",linkedCOR:"Link to Change Order",selectCOR:"Select COR (optional)",noCORs:"No pending CORs",laborSummary:"Labor Summary",worker:"worker",workers_plural:"workers",totalHours:"Total Hours",regular:"Regular",overtime:"Overtime",materials:"Materials",item:"item",items_plural:"items",noMaterials:"No materials added",notes:"Notes",addNotes:"Add notes about the work performed...",photos:"Photos",addPhotos:"Add Photos",maxPhotos:"max",noPhotos:"No photos added",certification:"Certification",certifyStatement:"I certify that this T&M ticket accurately reflects the work performed.",foremanSignature:"Foreman's Name (Signature)",yourName:"Your name",describeWork:"Describe the work performed",descriptionRequired:"Description is required",whatWorkPerformed:"What work was performed today?",searchMaterials:"Search materials & equipment...",noSearchResults:"No items found",orBrowse:"Or browse by category:",back:"Back",next:"Next",nextCrew:"Next: Crew",nextMaterials:"Next: Materials",reviewItems:"Review",skipNoMaterials:"Skip (no materials)",submitTM:"Submit T&M",submitting:"Submitting...",applySameHours:"Apply Same Hours",batchDescription:"Set start/end time and hours for all workers with names entered.",timeStarted:"Time Started",timeEnded:"Time Ended",regularHours:"Regular Hours",overtimeHours:"Overtime Hours",willApplyTo:"Will apply to",applyToAll:"Apply to All",preset8hr:"8hr Day",preset10hr:"10hr Day",preset4hr:"4hr Day",loadedWorkers:"Loaded {count} workers from {date}",noPreviousCrew:"No previous crew found for this project",appliedHours:"Applied hours to {count} worker(s)",assignedToCOR:"Assigned to COR",photoEvidence:"Photo Evidence",photosAdded:"photo(s) added",recommendedForBilling:"Recommended for billing",addMorePhotos:"Add More Photos",linkToChangeOrder:"Link to Change Order",linkedTo:"Linked to",optionalLinkCOR:"Optional - Link this T&M to a COR",selectCOROptional:"-- Select a COR (optional) --",noActiveCORs:"No active CORs available for this project",addWorkersFirst:"Add workers first",errorLoadingCrew:"Error loading previous crew",descriptionRecommended:"Description recommended",workersNoHours:"worker(s) have no hours entered",nameRequired:"Name required to submit",submitted:"Submitted",switchToSpanish:"Cambiar a Espanol",switchToEnglish:"Switch to English",reviewAndSubmit:"Review & Submit",enterNameToSubmit:"Enter name to submit",done:"Done",skipSignature:"Skip signature for now",total:"total",needHours:"need hours",customHours:"Custom hours",selectTMWorkers:"Select T&M Workers",tapToAdd:"Tap to add",removeClass:"Remove this labor class",add:"Add",addLaborClass:"Add Labor Class...",other:"Other",noCustomClasses:"No custom labor classes set up for this company. Using default categories.",loadingLaborClasses:"Loading labor classes...",noLaborClassesYet:"No labor classes added yet. Select from crew check-in above or add manually:",tmSubmitted:"T&M Ticket Submitted!",ticketSavedReady:"Your ticket has been saved and is ready for client signature.",workersLabel:"Workers",retry:"Retry",retryAllPhotos:"Retry All Failed Photos",getClientSignature:"Get Client Signature",signatureDescription:"Have the client sign this T&M ticket to verify the work performed.",clientSignatureCollected:"Client signature collected!",signNowOnSite:"Sign Now (On-Site)",clientSignsDevice:"Client signs on this device",sendSignatureLink:"Send Signature Link",clientSignsLater:"Client signs later via link",ticketSummary:"Ticket Summary",edit:"Edit",submittedBy:"Submitted By",enterYourName:"Enter your name",certifyAccurate:"By submitting, you certify this T&M is accurate."},es:{workInfo:"Info del Trabajo",crewHours:"Cuadrilla y Horas",materialsEquipment:"Materiales",evidence:"Evidencia",review:"Revisar",quickActions:"Acciones Rapidas",sameAsYesterday:"Igual que Ayer",setCrewHours:"Poner Horas",loading:"Cargando...",supervision:"Supervision",operators:"Operadores",laborers:"Trabajadores",addSupervision:"+ Agregar Supervision",addOperator:"+ Agregar Operador",addLaborer:"+ Agregar Trabajador",foreman:"Capataz",superintendent:"Superintendente",firstLastName:"Nombre y Apellido",start:"Inicio",end:"Fin",regHrs:"Hrs Reg",otHrs:"Hrs Extra",selectCategory:"Seleccione una categoria:",addCustomItem:"+ Agregar Articulo",customItem:"Articulo Personalizado",itemName:"Nombre del Articulo",category:"Categoria",quantity:"Cantidad",addItem:"Agregar",cancel:"Cancelar",noItemsCategory:"No hay articulos en esta categoria",workDate:"Fecha de Trabajo",ceNumber:"CE/PCO #",optional:"opcional",linkedCOR:"Vincular a Orden de Cambio",selectCOR:"Seleccionar COR (opcional)",noCORs:"No hay CORs pendientes",laborSummary:"Resumen de Mano de Obra",worker:"trabajador",workers_plural:"trabajadores",totalHours:"Horas Totales",regular:"Regular",overtime:"Extra",materials:"Materiales",item:"articulo",items_plural:"articulos",noMaterials:"No se agregaron materiales",notes:"Notas",addNotes:"Agregar notas sobre el trabajo realizado...",photos:"Fotos",addPhotos:"Agregar Fotos",maxPhotos:"max",noPhotos:"No se agregaron fotos",certification:"Certificacion",certifyStatement:"Certifico que este ticket T&M refleja con precision el trabajo realizado.",foremanSignature:"Nombre del Capataz (Firma)",yourName:"Su nombre",describeWork:"Describir el trabajo realizado",descriptionRequired:"Descripcion es requerida",whatWorkPerformed:"Que trabajo se realizo hoy?",searchMaterials:"Buscar materiales y equipo...",noSearchResults:"No se encontraron articulos",orBrowse:"O navegar por categoria:",back:"Atras",next:"Siguiente",nextCrew:"Siguiente: Cuadrilla",nextMaterials:"Siguiente: Materiales",reviewItems:"Revisar",skipNoMaterials:"Saltar (sin materiales)",submitTM:"Enviar T&M",submitting:"Enviando...",applySameHours:"Aplicar Mismas Horas",batchDescription:"Establezca hora de inicio/fin y horas para todos los trabajadores.",timeStarted:"Hora de Inicio",timeEnded:"Hora de Fin",regularHours:"Horas Regulares",overtimeHours:"Horas Extra",willApplyTo:"Se aplicara a",applyToAll:"Aplicar a Todos",preset8hr:"Dia 8hr",preset10hr:"Dia 10hr",preset4hr:"Dia 4hr",loadedWorkers:"Se cargaron {count} trabajadores del {date}",noPreviousCrew:"No se encontro equipo anterior para este proyecto",appliedHours:"Horas aplicadas a {count} trabajador(es)",assignedToCOR:"Asignado a COR",photoEvidence:"Evidencia FotogrÃ¡fica",photosAdded:"foto(s) agregada(s)",recommendedForBilling:"Recomendado para facturaciÃ³n",addMorePhotos:"Agregar MÃ¡s Fotos",linkToChangeOrder:"Vincular a Orden de Cambio",linkedTo:"Vinculado a",optionalLinkCOR:"Opcional - Vincular este T&M a un COR",selectCOROptional:"-- Seleccionar COR (opcional) --",noActiveCORs:"No hay CORs activos para este proyecto",addWorkersFirst:"Agregue trabajadores primero",errorLoadingCrew:"Error cargando equipo anterior",descriptionRecommended:"Descripcion recomendada",workersNoHours:"trabajador(es) sin horas",nameRequired:"Nombre requerido",submitted:"Enviado",switchToSpanish:"Cambiar a Espanol",switchToEnglish:"Switch to English",reviewAndSubmit:"Revisar y Enviar",enterNameToSubmit:"Ingrese nombre",done:"Listo",skipSignature:"Saltar firma por ahora",total:"total",needHours:"sin horas",customHours:"Horas personalizadas",selectTMWorkers:"Seleccionar Trabajadores T&M",tapToAdd:"Toca para agregar",removeClass:"Eliminar esta clase",add:"Agregar",addLaborClass:"Agregar Clase de Trabajo...",other:"Otros",noCustomClasses:"No hay clases de trabajo personalizadas. Usando categorias predeterminadas.",loadingLaborClasses:"Cargando clases de trabajo...",noLaborClassesYet:"No hay clases de trabajo agregadas. Seleccione del check-in o agregue manualmente:",tmSubmitted:"Â¡Ticket T&M Enviado!",ticketSavedReady:"Su ticket ha sido guardado y estÃ¡ listo para la firma del cliente.",workersLabel:"Trabajadores",retry:"Reintentar",retryAllPhotos:"Reintentar Todas las Fotos",getClientSignature:"Obtener Firma del Cliente",signatureDescription:"Haga que el cliente firme este ticket T&M para verificar el trabajo realizado.",clientSignatureCollected:"Â¡Firma del cliente recopilada!",signNowOnSite:"Firmar Ahora",clientSignsDevice:"Cliente firma en este dispositivo",sendSignatureLink:"Enviar Enlace",clientSignsLater:"Cliente firma despuÃ©s vÃ­a enlace",ticketSummary:"Resumen del Ticket",edit:"Editar",submittedBy:"Enviado Por",enterYourName:"Ingrese su nombre",certifyAccurate:"Al enviar, certifica que este T&M es preciso."}},Fa=a=>o=>ws[a]?.[o]||o;function Ma({project:a,workDate:o,setWorkDate:f,cePcoNumber:C,setCePcoNumber:T,notes:u,setNotes:h,t:g,lang:E}){return e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-project-info",children:[a.job_number&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Job #"}),e.jsx("span",{className:"tm-project-value",children:a.job_number})]}),e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Project"}),e.jsx("span",{className:"tm-project-value",children:a.name})]}),a.address&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"Address"}),e.jsx("span",{className:"tm-project-value",children:a.address})]}),a.general_contractor&&e.jsxs("div",{className:"tm-project-detail",children:[e.jsx("span",{className:"tm-project-label",children:"GC"}),e.jsx("span",{className:"tm-project-value",children:a.general_contractor})]})]}),e.jsxs("div",{className:"tm-field-row",children:[e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:o,onChange:v=>f(v.target.value),className:"tm-date"})]}),e.jsxs("div",{className:"tm-field tm-field-half",children:[e.jsx("label",{children:"CE / PCO #"}),e.jsx("input",{type:"text",placeholder:"Change Event / PCO",value:C,onChange:v=>T(v.target.value),className:"tm-input"})]})]}),e.jsxs("div",{className:"tm-field tm-description-field",children:[e.jsxs("label",{children:[e.jsx(Ee,{size:16,className:"inline-icon"}),g("describeWork")," ",e.jsx("span",{className:"tm-required",children:"*"})]}),e.jsx("textarea",{placeholder:g("whatWorkPerformed"),value:u,onChange:v=>h(v.target.value),rows:4,className:`tm-description ${u.trim()?"":"tm-field-required"}`})]})]})}const Pa=a=>{if(!a)return"empty";const o=a.name&&a.name.trim()!=="",f=parseFloat(a.hours)>0||parseFloat(a.overtimeHours)>0;return o?f?"complete":"incomplete":"empty"},hs=(a,o)=>{if(!a||!o)return null;const[f,C]=a.split(":").map(Number),[T,u]=o.split(":").map(Number);let h=T*60+u-(f*60+C);h<0&&(h+=1440);const g=h/60,E=Math.min(g,8),v=Math.max(0,g-8);return{hours:E.toFixed(1),overtimeHours:v>0?v.toFixed(1):""}};function Ce({worker:a,index:o,onUpdate:f,onRemove:C,t:T,roleSelect:u}){const h=Pa(a);return e.jsxs("div",{className:`tm-worker-card-expanded ${h!=="empty"?`worker-${h}`:""}`,children:[e.jsxs("div",{className:"tm-worker-row-top",children:[h==="complete"&&e.jsx("span",{className:"tm-worker-check",children:e.jsx(Se,{size:14})}),u,e.jsx("input",{type:"text",placeholder:T("firstLastName"),value:a.name,onChange:g=>f(o,"name",g.target.value),className:"tm-worker-input"}),e.jsx("button",{className:"tm-remove",onClick:()=>C(o),children:"Ã—"})]}),e.jsxs("div",{className:"tm-worker-row-bottom",children:[e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:T("start")}),e.jsx("input",{type:"time",value:a.timeStarted,onChange:g=>f(o,"timeStarted",g.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:T("end")}),e.jsx("input",{type:"time",value:a.timeEnded,onChange:g=>f(o,"timeEnded",g.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:T("regHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:a.hours,onChange:g=>f(o,"hours",g.target.value)})]}),e.jsxs("div",{className:"tm-time-group",children:[e.jsx("label",{children:T("otHrs")}),e.jsx("input",{type:"number",placeholder:"0",value:a.overtimeHours,onChange:g=>f(o,"overtimeHours",g.target.value)})]})]})]})}function $a({batchHours:a,setBatchHours:o,namedWorkerCount:f,onApply:C,onClose:T,t:u}){const h=g=>{let E,v,W,y;switch(g){case"full":E="07:00",v="15:30",W="8",y="";break;case"10hr":E="06:00",v="16:30",W="8",y="2";break;case"half":E="07:00",v="11:00",W="4",y="";break;default:return}o({timeStarted:E,timeEnded:v,hours:W,overtimeHours:y})};return e.jsx("div",{className:"tm-modal-overlay",onClick:T,children:e.jsxs("div",{className:"tm-batch-modal",onClick:g=>g.stopPropagation(),children:[e.jsxs("h3",{children:[e.jsx(Ne,{size:18})," ",u("applySameHours")]}),e.jsx("p",{className:"tm-batch-description",children:u("batchDescription")}),e.jsxs("div",{className:"tm-time-presets",children:[e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>h("full"),children:u("preset8hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>h("10hr"),children:u("preset10hr")}),e.jsx("button",{type:"button",className:"tm-preset-btn",onClick:()=>h("half"),children:u("preset4hr")})]}),e.jsxs("div",{className:"tm-batch-form",children:[e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:u("timeStarted")}),e.jsx("input",{type:"time",value:a.timeStarted,onChange:g=>{const E=g.target.value,v=hs(E,a.timeEnded);o({...a,timeStarted:E,...v||{}})}})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:u("timeEnded")}),e.jsx("input",{type:"time",value:a.timeEnded,onChange:g=>{const E=g.target.value,v=hs(a.timeStarted,E);o({...a,timeEnded:E,...v||{}})}})]})]}),e.jsxs("div",{className:"tm-batch-row",children:[e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:u("regularHours")}),e.jsx("input",{type:"number",placeholder:"8",value:a.hours,onChange:g=>o({...a,hours:g.target.value})})]}),e.jsxs("div",{className:"tm-batch-field",children:[e.jsx("label",{children:u("overtimeHours")}),e.jsx("input",{type:"number",placeholder:"0",value:a.overtimeHours,onChange:g=>o({...a,overtimeHours:g.target.value})})]})]})]}),e.jsxs("div",{className:"tm-batch-preview",children:[e.jsxs("strong",{children:[u("willApplyTo"),":"]}),e.jsxs("span",{children:[f," ",u("workers_plural")]})]}),e.jsxs("div",{className:"tm-batch-actions",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:T,children:u("cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:C,disabled:!a.hours&&!a.overtimeHours,children:u("applyToAll")})]})]})})}function qa({supervision:a,operators:o,laborers:f,dynamicWorkers:C,activeLaborClassIds:T,setActiveLaborClassIds:u,laborCategories:h,laborClasses:g,hasCustomLaborClasses:E,loadingLaborClasses:v,todaysCrew:W,showBatchHoursModal:y,setShowBatchHoursModal:_,batchHours:U,setBatchHours:R,loadingPreviousCrew:X,namedWorkers:P,workersNeedingHours:H,totalRegHours:N,totalOTHours:L,onLoadPreviousCrew:b,onApplyBatchHours:D,onApplyInlinePreset:M,onAddCrewWorker:$,onActivateLaborClass:te,onDeactivateLaborClass:se,addSupervision:K,updateSupervision:ee,removeSupervision:x,addOperator:O,updateOperator:oe,removeOperator:p,addLaborer:j,updateLaborer:z,removeLaborer:q,addDynamicWorker:n,updateDynamicWorker:A,removeDynamicWorker:G,getInactiveLaborClasses:m,t,lang:Q,onShowToast:J}){const ie=P.length;return e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-crew-summary-bar",children:[e.jsxs("div",{className:"tm-summary-left",children:[e.jsx("span",{className:"tm-summary-count",children:P.length}),e.jsx("span",{className:"tm-summary-label",children:P.length===1?t("worker"):t("workers_plural")})]}),e.jsxs("div",{className:"tm-summary-middle",children:[e.jsxs("span",{className:"tm-summary-hours",children:[N+L,"h"]}),e.jsx("span",{className:"tm-summary-label",children:t("total")})]}),H>0&&e.jsxs("div",{className:"tm-summary-warning",children:[e.jsx(Ke,{size:14}),e.jsxs("span",{children:[H," ",t("needHours")]})]})]}),e.jsxs("div",{className:"tm-quick-actions-row",children:[e.jsxs("button",{className:"tm-quick-action",onClick:b,disabled:X,children:[e.jsx(ca,{size:16}),e.jsx("span",{children:t(X?"loading":"sameAsYesterday")})]}),P.length>0&&e.jsxs("div",{className:"tm-time-presets-inline",children:[e.jsx("button",{className:"tm-preset-chip",onClick:()=>M("8hr"),children:"8h"}),e.jsx("button",{className:"tm-preset-chip",onClick:()=>M("10hr"),children:"10h"}),e.jsx("button",{className:"tm-preset-chip",onClick:()=>M("4hr"),children:"4h"}),e.jsx("button",{className:"tm-preset-chip more",onClick:()=>_(!0),title:t("customHours"),children:e.jsx(Ne,{size:14})})]})]}),W.length>0&&e.jsxs("div",{className:"tm-crew-select-section",children:[e.jsxs("div",{className:"tm-section-header",children:[e.jsxs("h4",{children:[e.jsx(ke,{size:16})," ",t("selectTMWorkers")]}),e.jsx("span",{className:"tm-section-hint",children:t("tapToAdd")})]}),e.jsx("div",{className:"tm-crew-grid",children:W.map((S,V)=>{const Y=a.some(ne=>ne.name.toLowerCase()===S.name.toLowerCase())||o.some(ne=>ne.name.toLowerCase()===S.name.toLowerCase())||f.some(ne=>ne.name.toLowerCase()===S.name.toLowerCase()),le=Object.values(C).some(ne=>ne.some(he=>he.name.toLowerCase()===S.name.toLowerCase())),re=Y||le;return e.jsxs("button",{className:`tm-crew-item ${re?"added":""}`,onClick:()=>{re||$(S)},disabled:re,children:[e.jsx("span",{className:"tm-crew-item-name",children:S.name}),e.jsx("span",{className:`tm-crew-item-role ${(S.role||"laborer").toLowerCase()}`,children:S.role||"Laborer"}),re&&e.jsx("span",{className:"tm-crew-item-check",children:"âœ“"})]},V)})})]}),E&&!v&&e.jsxs(e.Fragment,{children:[h.map(S=>{const V=g.filter(Y=>Y.category_id===S.id&&T.has(Y.id));return V.length===0?null:e.jsxs("div",{className:"tm-labor-category-section",children:[e.jsx("div",{className:"tm-category-header",children:S.name}),V.map(Y=>e.jsxs("div",{className:"tm-field",children:[e.jsxs("div",{className:"tm-field-header",children:[e.jsx("label",{children:Y.name}),e.jsx("button",{type:"button",className:"tm-remove-class-btn",onClick:()=>se(Y.id),title:t("removeClass"),children:"Ã—"})]}),e.jsx("div",{className:"tm-workers-list",children:(C[Y.id]||[]).map((le,re)=>e.jsx(Ce,{worker:le,index:re,onUpdate:(ne,he,je)=>A(Y.id,ne,he,je),onRemove:ne=>G(Y.id,ne),t},re))}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>n(Y.id),children:["+ ",t("add")," ",Y.name]})]},Y.id))]},S.id)}),g.filter(S=>!S.category_id&&T.has(S.id)).map(S=>e.jsxs("div",{className:"tm-field",children:[e.jsxs("div",{className:"tm-field-header",children:[e.jsx("label",{children:S.name}),e.jsx("button",{type:"button",className:"tm-remove-class-btn",onClick:()=>se(S.id),title:t("removeClass"),children:"Ã—"})]}),e.jsx("div",{className:"tm-workers-list",children:(C[S.id]||[]).map((V,Y)=>e.jsx(Ce,{worker:V,index:Y,onUpdate:(le,re,ne)=>A(S.id,le,re,ne),onRemove:le=>G(S.id,le),t},Y))}),e.jsxs("button",{className:"tm-add-btn",onClick:()=>n(S.id),children:["+ ",t("add")," ",S.name]})]},S.id)),m().length>0&&e.jsx("div",{className:"tm-add-labor-class-section",children:e.jsxs("select",{className:"tm-add-labor-class-select",value:"",onChange:S=>{S.target.value&&te(S.target.value)},children:[e.jsxs("option",{value:"",children:["+ ",t("addLaborClass")]}),h.map(S=>{const V=m().filter(Y=>Y.category_id===S.id);return V.length===0?null:e.jsx("optgroup",{label:S.name,children:V.map(Y=>e.jsx("option",{value:Y.id,children:Y.name},Y.id))},S.id)}),m().filter(S=>!S.category_id).length>0&&e.jsx("optgroup",{label:t("other"),children:m().filter(S=>!S.category_id).map(S=>e.jsx("option",{value:S.id,children:S.name},S.id))})]})}),T.size===0&&e.jsx("div",{className:"tm-no-labor-classes",children:e.jsx("p",{children:t("noLaborClassesYet")})})]}),v&&e.jsxs("div",{className:"tm-loading-labor-classes",children:[e.jsx(Je,{size:20,className:"tm-spinner"}),e.jsx("span",{children:t("loadingLaborClasses")})]}),!E&&!v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:t("supervision")}),e.jsx("div",{className:"tm-workers-list",children:a.map((S,V)=>e.jsx(Ce,{worker:S,index:V,onUpdate:ee,onRemove:x,t,roleSelect:e.jsx("div",{className:"tm-role-select",children:e.jsxs("select",{value:S.role,onChange:Y=>ee(V,"role",Y.target.value),children:[e.jsx("option",{value:"Foreman",children:t("foreman")}),e.jsx("option",{value:"Superintendent",children:t("superintendent")})]})})},V))}),e.jsx("button",{className:"tm-add-btn",onClick:K,children:t("addSupervision")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:t("operators")}),e.jsx("div",{className:"tm-workers-list",children:o.map((S,V)=>e.jsx(Ce,{worker:S,index:V,onUpdate:oe,onRemove:p,t},V))}),e.jsx("button",{className:"tm-add-btn",onClick:O,children:t("addOperator")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:t("laborers")}),e.jsx("div",{className:"tm-workers-list",children:f.map((S,V)=>e.jsx(Ce,{worker:S,index:V,onUpdate:z,onRemove:q,t},V))}),e.jsx("button",{className:"tm-add-btn",onClick:j,children:t("addLaborer")})]})]}),y&&e.jsx($a,{batchHours:U,setBatchHours:R,namedWorkerCount:ie,onApply:D,onClose:()=>_(!1),t})]})}function Ia({companyId:a,items:o,setItems:f,t:C,lang:T,onShowToast:u}){const[h,g]=l.useState(null),[E,v]=l.useState([]),[W,y]=l.useState(!1),[_,U]=l.useState(""),[R,X]=l.useState([]),[P,H]=l.useState([]),[N,L]=l.useState(!1),[b,D]=l.useState({name:"",category:"",quantity:""}),M=l.useRef(null),$=l.useRef(null);l.useEffect(()=>{h&&a&&te(h)},[h,a]),l.useEffect(()=>(!h&&M.current&&($.current=setTimeout(()=>{M.current?.focus()},100)),()=>{$.current&&clearTimeout($.current)}),[h]);const te=async p=>{y(!0);try{const j=await w.getMaterialsEquipmentByCategory(a,p);v(j)}catch(j){console.error("Error loading items:",j),u("Error loading items","error")}finally{y(!1)}},se=async()=>{if(!(P.length>0))try{const p=[];for(const j of Ye){const z=await w.getMaterialsEquipmentByCategory(a,j);p.push(...z.map(q=>({...q,category:j})))}H(p)}catch(p){console.error("Error loading all materials:",p)}},K=p=>{if(U(p),!p.trim()){X([]);return}const j=p.toLowerCase(),z=P.filter(q=>q.name.toLowerCase().includes(j)||q.category.toLowerCase().includes(j));X(z.slice(0,10))},ee=p=>{const j=o.findIndex(z=>z.material_equipment_id===p.id);j>=0?f(o.map((z,q)=>q===j?{...z,quantity:z.quantity+1}:z)):f([...o,{material_equipment_id:p.id,name:p.name,unit:p.unit,category:p.category,quantity:1,isCustom:!1}]),u(`Added ${p.name}`,"success")},x=()=>{if(!b.name||!b.category||!b.quantity){u("Fill in all fields","error");return}f([...o,{material_equipment_id:null,custom_name:b.name,custom_category:b.category,name:b.name,category:b.category,quantity:parseFloat(b.quantity),unit:"each",isCustom:!0}]),D({name:"",category:"",quantity:""}),L(!1),g(null),u("Custom item added","success")},O=(p,j)=>{const z=parseFloat(j)||0;z<=0?f(o.filter((q,n)=>n!==p)):f(o.map((q,n)=>n===p?{...q,quantity:z}:q))},oe=()=>{N?L(!1):h&&(g(null),L(!1))};return h||N?e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-wizard-header",style:{margin:"-1rem -1rem 1rem -1rem",padding:"0.75rem 1rem"},children:[e.jsx("button",{className:"tm-back-btn",onClick:oe,children:"â†"}),e.jsx("h2",{children:N?"Add Custom Item":h}),e.jsxs("div",{className:"tm-item-count",children:[o.length," items"]})]}),N?e.jsxs("div",{className:"tm-custom-form",children:[e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Item Name"}),e.jsx("input",{type:"text",placeholder:"What did you use?",value:b.name,onChange:p=>D({...b,name:p.target.value}),autoFocus:!0})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Category"}),e.jsx("div",{className:"tm-category-select",children:Ye.map(p=>e.jsx("button",{className:`tm-cat-chip ${b.category===p?"active":""}`,onClick:()=>D({...b,category:p}),children:p},p))})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:"Quantity"}),e.jsx("input",{type:"number",placeholder:"How many?",value:b.quantity,onChange:p=>D({...b,quantity:p.target.value})})]}),e.jsx("button",{className:"tm-big-btn primary",onClick:x,children:"Add Custom Item"})]}):e.jsx("div",{className:"tm-item-grid",children:W?e.jsx("div",{className:"tm-loading",children:"Loading..."}):e.jsxs(e.Fragment,{children:[E.map(p=>{const j=o.find(z=>z.material_equipment_id===p.id);return e.jsxs("button",{className:`tm-item-card ${j?"added":""}`,onClick:()=>ee(p),children:[e.jsx("span",{className:"tm-item-name",children:p.name}),e.jsx("span",{className:"tm-item-unit",children:p.unit}),j&&e.jsx("span",{className:"tm-item-badge",children:j.quantity})]},p.id)}),e.jsxs("button",{className:"tm-item-card custom",onClick:()=>L(!0),children:[e.jsx("span",{className:"tm-item-name",children:"+ Add Other"}),e.jsx("span",{className:"tm-item-unit",children:"Not on list"})]})]})}),!N&&o.length>0&&e.jsx("div",{className:"tm-wizard-footer",children:e.jsxs("button",{className:"tm-big-btn primary",onClick:()=>g(null),children:["Done Adding (",o.length," items)"]})})]}):e.jsxs("div",{className:"tm-step-content",children:[e.jsxs("div",{className:"tm-field tm-search-field",children:[e.jsxs("div",{className:"tm-search-input-wrapper",children:[e.jsx(da,{size:18,className:"tm-search-icon"}),e.jsx("input",{ref:M,type:"text",placeholder:C("searchMaterials"),value:_,onChange:p=>K(p.target.value),onFocus:()=>se(),className:"tm-search-input"}),_&&e.jsx("button",{className:"tm-search-clear",onClick:()=>{U(""),X([])},children:"Ã—"})]}),_&&R.length>0&&e.jsx("div",{className:"tm-search-results",children:R.map((p,j)=>{const z=o.find(q=>q.id===p.id);return e.jsxs("button",{className:`tm-search-result-item ${z?"added":""}`,onClick:()=>{z?O(o.indexOf(z),z.quantity+1):f([...o,{...p,quantity:1,isCustom:!1}]),U(""),X([])},children:[e.jsx("span",{className:"tm-search-result-name",children:p.name}),e.jsx("span",{className:"tm-search-result-category",children:p.category}),z&&e.jsxs("span",{className:"tm-search-result-qty",children:["Ã—",z.quantity]})]},j)})}),_&&R.length===0&&e.jsx("div",{className:"tm-search-no-results",children:C("noSearchResults")})]}),e.jsxs("div",{className:"tm-field",children:[e.jsx("label",{children:C("orBrowse")}),e.jsx("div",{className:"tm-category-grid",children:Ye.map(p=>{const j=o.filter(z=>z.category===p);return e.jsxs("button",{className:"tm-category-card",onClick:()=>g(p),children:[e.jsx("span",{className:"tm-cat-name",children:p}),j.length>0&&e.jsx("span",{className:"tm-cat-count",children:j.length})]},p)})})]}),o.length>0&&e.jsxs("div",{className:"tm-field",children:[e.jsxs("label",{children:["Added Items (",o.length,")"]}),e.jsx("div",{className:"tm-added-list",children:o.map((p,j)=>e.jsxs("div",{className:"tm-added-item",children:[e.jsxs("div",{className:"tm-added-info",children:[p.isCustom&&e.jsx("span",{className:"tm-custom-badge",children:"Custom"}),e.jsx("span",{className:"tm-added-name",children:p.name})]}),e.jsxs("div",{className:"tm-added-qty",children:[e.jsx("button",{onClick:()=>O(j,p.quantity-1),children:"âˆ’"}),e.jsx("span",{children:p.quantity}),e.jsx("button",{onClick:()=>O(j,p.quantity+1),children:"+"})]})]},j))})]})]})}function Wa({photos:a,onPhotoAdd:o,onRemovePhoto:f,maxPhotos:C,selectedCorId:T,setSelectedCorId:u,assignableCORs:h,lang:g}){const E=Fa(g);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`tm-action-card-prominent ${a.length>0?"has-content":"needs-action"}`,children:[e.jsxs("div",{className:"tm-action-card-header",children:[e.jsx("div",{className:"tm-action-card-icon",children:e.jsx(ds,{size:24})}),e.jsxs("div",{className:"tm-action-card-title",children:[e.jsx("h4",{children:E("photoEvidence")}),e.jsx("span",{className:"tm-action-card-status",children:a.length>0?`${a.length} ${E("photosAdded")}`:E("recommendedForBilling")})]})]}),a.length>0&&e.jsx("div",{className:"tm-photo-preview-row",children:a.map(v=>e.jsxs("div",{className:"tm-photo-preview-thumb",children:[e.jsx("img",{src:v.previewUrl,alt:v.name}),v.latitude&&e.jsx("span",{className:"tm-photo-gps-badge",title:`${v.latitude.toFixed(4)}, ${v.longitude.toFixed(4)}`,children:e.jsx(ma,{size:10})}),e.jsx("button",{className:"tm-photo-remove-x",onClick:()=>f(v.id),children:"Ã—"})]},v.id))}),e.jsxs("label",{className:`tm-action-card-btn ${a.length===0?"primary":""}`,children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:o,style:{display:"none"}}),e.jsx(ds,{size:18}),e.jsx("span",{children:a.length>0?E("addMorePhotos"):E("addPhotos")})]})]}),e.jsxs("div",{className:`tm-action-card-prominent ${T?"has-content":""}`,children:[e.jsxs("div",{className:"tm-action-card-header",children:[e.jsx("div",{className:"tm-action-card-icon cor",children:e.jsx(ua,{size:24})}),e.jsxs("div",{className:"tm-action-card-title",children:[e.jsx("h4",{children:E("linkToChangeOrder")}),e.jsx("span",{className:"tm-action-card-status",children:T?`${E("linkedTo")}: ${h.find(v=>v.id===T)?.cor_number||""}`:E("optionalLinkCOR")})]})]}),e.jsxs("select",{value:T,onChange:v=>u(v.target.value),className:"tm-cor-select-prominent",children:[e.jsx("option",{value:"",children:E("selectCOROptional")}),h.map(v=>e.jsxs("option",{value:v.id,children:[v.cor_number,": ",v.title||"Untitled"," (",v.status,")"]},v.id))]}),h.length===0&&e.jsx("p",{className:"tm-cor-hint",children:E("noActiveCORs")})]})]})}const Ua=l.lazy(()=>ks(()=>import("./SignatureLinkGenerator-CXS_5_K-.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),Ba=l.lazy(()=>ks(()=>import("./TMClientSignature-NxvBxiIi.js"),__vite__mapDeps([7,1,2,3,4,5,6])));function Va({step:a,setStep:o,project:f,companyId:C,workDate:T,cePcoNumber:u,notes:h,photos:g,onPhotoAdd:E,onRemovePhoto:v,maxPhotos:W,selectedCorId:y,setSelectedCorId:_,assignableCORs:U,items:R,hasCustomLaborClasses:X,validDynamicWorkersList:P,validSupervision:H,validOperators:N,validLaborers:L,totalWorkers:b,totalRegHours:D,totalOTHours:M,submittedByName:$,setSubmittedByName:te,submittedTicket:se,submitting:K,submitProgress:ee,clientSigned:x,setClientSigned:O,showSignatureLinkModal:oe,setShowSignatureLinkModal:p,showOnSiteSignature:j,setShowOnSiteSignature:z,onRetryPhotoUpload:q,t:n,lang:A,onShowToast:G}){return a===5&&se?e.jsxs("div",{className:"tm-step-content tm-success-step",children:[e.jsxs("div",{className:"tm-success-header",children:[e.jsx("div",{className:"tm-success-icon",children:e.jsx(ve,{size:48})}),e.jsx("h2",{children:n("tmSubmitted")}),e.jsx("p",{className:"tm-success-subtitle",children:n("ticketSavedReady")})]}),e.jsxs("div",{className:"tm-success-summary",children:[e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:b}),e.jsx("span",{className:"tm-success-stat-label",children:n("workersLabel")})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:D+M}),e.jsx("span",{className:"tm-success-stat-label",children:n("totalHours")})]}),e.jsxs("div",{className:"tm-success-stat",children:[e.jsx("span",{className:"tm-success-stat-value",children:new Date(T).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),e.jsx("span",{className:"tm-success-stat-label",children:n("workDate")})]})]}),g.some(m=>m.status==="failed")&&e.jsxs("div",{className:"tm-failed-photos-section",children:[e.jsxs("div",{className:"tm-failed-photos-header",children:[e.jsx(Ke,{size:18}),e.jsx("span",{children:A==="en"?`${g.filter(m=>m.status==="failed").length} photo(s) failed to upload`:`${g.filter(m=>m.status==="failed").length} foto(s) no se subieron`})]}),e.jsx("div",{className:"tm-failed-photos-grid",children:g.filter(m=>m.status==="failed").map(m=>e.jsxs("div",{className:"tm-failed-photo-item",children:[e.jsx("img",{src:m.previewUrl,alt:m.name}),e.jsx("div",{className:"tm-failed-photo-overlay",children:e.jsx("button",{className:"tm-retry-photo-btn",onClick:()=>q(m.id,se.id),disabled:m.status==="uploading"||m.status==="compressing",children:m.status==="uploading"||m.status==="compressing"?e.jsx(Je,{size:16,className:"tm-spinner"}):e.jsxs(e.Fragment,{children:[e.jsx(ms,{size:16}),e.jsx("span",{children:n("retry")})]})})}),m.error&&e.jsxs("div",{className:"tm-failed-photo-error",title:m.error,children:[m.error.substring(0,20),m.error.length>20?"...":""]})]},m.id))}),e.jsxs("button",{className:"tm-retry-all-btn",onClick:async()=>{const m=g.filter(t=>t.status==="failed");for(const t of m)await q(t.id,se.id)},children:[e.jsx(ms,{size:16}),n("retryAllPhotos")]})]}),g.length>0&&g.every(m=>m.status==="confirmed")&&e.jsxs("div",{className:"tm-photos-success",children:[e.jsx(Se,{size:16}),e.jsx("span",{children:A==="en"?`All ${g.length} photo(s) uploaded successfully`:`${g.length} foto(s) subidas exitosamente`})]}),e.jsxs("div",{className:"tm-signature-options",children:[e.jsx("h3",{children:n("getClientSignature")}),e.jsx("p",{className:"tm-signature-description",children:n("signatureDescription")}),x?e.jsxs("div",{className:"tm-signed-confirmation",children:[e.jsx(ve,{size:32,className:"tm-signed-icon"}),e.jsx("span",{children:n("clientSignatureCollected")})]}):e.jsxs("div",{className:"tm-signature-buttons",children:[e.jsxs("button",{className:"tm-signature-option-btn primary",onClick:()=>z(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(He,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:n("signNowOnSite")}),e.jsx("span",{className:"tm-signature-option-desc",children:n("clientSignsDevice")})]})]}),e.jsxs("button",{className:"tm-signature-option-btn",onClick:()=>p(!0),children:[e.jsx("div",{className:"tm-signature-option-icon",children:e.jsx(He,{size:24})}),e.jsxs("div",{className:"tm-signature-option-text",children:[e.jsx("span",{className:"tm-signature-option-title",children:n("sendSignatureLink")}),e.jsx("span",{className:"tm-signature-option-desc",children:n("clientSignsLater")})]})]})]})]}),oe&&e.jsx(l.Suspense,{fallback:e.jsx("div",{className:"loading",children:"Loading..."}),children:e.jsx(Ua,{documentType:"tm_ticket",documentId:se.id,companyId:C,projectId:f.id,project:f,documentTitle:`T&M - ${new Date(T).toLocaleDateString()}`,onClose:()=>p(!1),onShowToast:G})}),j&&e.jsx(l.Suspense,{fallback:e.jsx("div",{className:"loading",children:"Loading..."}),children:e.jsx(Ba,{ticketId:se.id,ticketSummary:{workDate:T,workerCount:b,totalHours:D+M},lang:A,onSave:()=>{z(!1),O(!0)},onClose:()=>z(!1),onShowToast:G})})]}):e.jsxs("div",{className:"tm-step-content",children:[e.jsx(Wa,{photos:g,onPhotoAdd:E,onRemovePhoto:v,maxPhotos:W,selectedCorId:y,setSelectedCorId:_,assignableCORs:U,lang:A}),e.jsx("div",{className:"tm-review-divider",children:e.jsx("span",{children:n("ticketSummary")})}),e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:["ğŸ“…"," ",n("workDate")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(1),children:n("edit")})]}),e.jsxs("div",{className:"tm-review-row",children:[e.jsx("span",{children:new Date(T).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}),u&&e.jsxs("span",{children:["CE/PCO: ",u]})]})]}),h&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(Ee,{size:16,className:"inline-icon"})," ",n("notes")]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(1),children:n("edit")})]}),e.jsx("div",{className:"tm-review-notes",children:h})]}),X&&P.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ke,{size:16,className:"inline-icon"})," ",n("workersLabel")," (",D+M," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(2),children:n("edit")})]}),e.jsx("div",{className:"tm-review-list",children:P.map((m,t)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:m.role})," ",m.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[m.time_started&&m.time_ended&&e.jsxs("span",{className:"tm-review-time",children:[m.time_started," - ",m.time_ended]}),e.jsxs("span",{className:"tm-review-hours",children:[m.hours||0," reg",m.overtime_hours>0?` + ${m.overtime_hours} OT`:""]})]})]},t))})]}),!X&&H.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ha,{size:16,className:"inline-icon"})," Supervision (",H.reduce((m,t)=>m+parseFloat(t.hours||0)+parseFloat(t.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(2),children:n("edit")})]}),e.jsx("div",{className:"tm-review-list",children:H.map((m,t)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsxs("div",{className:"tm-review-worker-name",children:[e.jsx("span",{className:"tm-role-badge",children:m.role})," ",m.name]}),e.jsxs("div",{className:"tm-review-worker-details",children:[m.timeStarted&&m.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[m.timeStarted," - ",m.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[m.hours||0," reg",parseFloat(m.overtimeHours)>0?` + ${m.overtimeHours} OT`:""]})]})]},t))})]}),!X&&N.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:["ğŸšœ"," Operators (",N.reduce((m,t)=>m+parseFloat(t.hours||0)+parseFloat(t.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(2),children:n("edit")})]}),e.jsx("div",{className:"tm-review-list",children:N.map((m,t)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:m.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[m.timeStarted&&m.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[m.timeStarted," - ",m.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[m.hours||0," reg",parseFloat(m.overtimeHours)>0?` + ${m.overtimeHours} OT`:""]})]})]},t))})]}),!X&&L.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(ke,{size:16,className:"inline-icon"})," Laborers (",L.reduce((m,t)=>m+parseFloat(t.hours||0)+parseFloat(t.overtimeHours||0),0)," hrs)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(2),children:n("edit")})]}),e.jsx("div",{className:"tm-review-list",children:L.map((m,t)=>e.jsxs("div",{className:"tm-review-row-detailed",children:[e.jsx("div",{className:"tm-review-worker-name",children:m.name}),e.jsxs("div",{className:"tm-review-worker-details",children:[m.timeStarted&&m.timeEnded&&e.jsxs("span",{className:"tm-review-time",children:[m.timeStarted," - ",m.timeEnded]}),e.jsxs("span",{className:"tm-review-hours",children:[m.hours||0," reg",parseFloat(m.overtimeHours)>0?` + ${m.overtimeHours} OT`:""]})]})]},t))})]}),R.length>0&&e.jsxs("div",{className:"tm-review-section",children:[e.jsxs("div",{className:"tm-review-section-header",children:[e.jsxs("h4",{children:[e.jsx(pa,{size:16,className:"inline-icon"})," Materials & Equipment (",R.length," items)"]}),e.jsx("button",{className:"tm-edit-link",onClick:()=>o(3),children:n("edit")})]}),e.jsx("div",{className:"tm-review-list",children:R.map((m,t)=>e.jsxs("div",{className:"tm-review-row",children:[e.jsxs("span",{children:[m.isCustom&&e.jsxs(e.Fragment,{children:[e.jsx(ga,{size:14,className:"inline-icon"})," "]}),m.name]}),e.jsxs("span",{children:[m.quantity," ",m.unit]})]},t))})]}),e.jsxs("div",{className:"tm-review-section tm-certification",children:[e.jsx("div",{className:"tm-review-header",children:e.jsxs("span",{children:[e.jsx(He,{size:16,className:"inline-icon"})," ",n("submittedBy")]})}),e.jsx("input",{type:"text",className:"tm-certification-input",placeholder:n("enterYourName"),value:$,onChange:m=>te(m.target.value)}),e.jsx("p",{className:"tm-certification-note",children:n("certifyAccurate")})]})]})}const ps=()=>{const a=new Uint8Array(6);return crypto.getRandomValues(a),Array.from(a,o=>o.toString(36)).join("")},Te=(a,o)=>{if(!a||!o)return null;const[f,C]=a.split(":").map(Number),[T,u]=o.split(":").map(Number);let h=T*60+u-(f*60+C);h<0&&(h+=1440);const g=h/60,E=Math.min(g,8),v=Math.max(0,g-8);return{hours:E.toFixed(1),overtimeHours:v>0?v.toFixed(1):""}};function Ga({project:a,companyId:o,maxPhotos:f=10,onSubmit:C,onCancel:T,onShowToast:u}){const[h,g]=l.useState(1),[E,v]=l.useState(new Date().toISOString().split("T")[0]),[W,y]=l.useState(null),[_,U]=l.useState(!1),[R,X]=l.useState(!1),[P,H]=l.useState(!1),[N,L]=l.useState(""),[b,D]=l.useState(""),[M,$]=l.useState(""),[te,se]=l.useState([]),[K,ee]=l.useState(!1),[x,O]=l.useState(!1),[oe,p]=l.useState({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),[j,z]=l.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}]),[q,n]=l.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[A,G]=l.useState([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]),[m,t]=l.useState([]),[Q,J]=l.useState(""),[ie,S]=l.useState([]),[V,Y]=l.useState(!1),[le,re]=l.useState(""),[ne,he]=l.useState([]),[je,Xe]=l.useState(!1),[xe,Cs]=l.useState("en"),B=s=>ws[xe][s]||s,[Ss,Es]=l.useState([]),[pe,Ls]=l.useState([]),[ge,de]=l.useState({}),[Pe,Ze]=l.useState(!0),[we,ye]=l.useState(new Set),me=pe.length>0;l.useEffect(()=>{Rs(),es();const s=w.subscribeToCORs?.(a.id,()=>{es()});return()=>{s?.unsubscribe?.()}},[a.id]),l.useEffect(()=>{(async()=>{if(!o){Ze(!1);return}try{const c=await w.getLaborClassesForField(o);Es(c.categories||[]),Ls(c.classes||[])}catch(c){console.error("Error loading labor classes:",c)}finally{Ze(!1)}})()},[o]),l.useEffect(()=>{if(Pe||pe.length===0)return;const s=new Set;ne.forEach(i=>{i.labor_class_id&&s.add(i.labor_class_id)});const c={},d=new Set;s.forEach(i=>{pe.some(r=>r.id===i)&&(c[i]=[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}],d.add(i))}),de(i=>Object.keys(i).length===0?c:i),ye(i=>i.size===0?d:i)},[pe,ne,Pe]);const es=async()=>{ee(!0);try{const s=await w.getAssignableCORs(a.id);se(s||[])}catch(s){console.error("Error loading assignable CORs:",s)}finally{ee(!1)}},_s=()=>{const{timeStarted:s,timeEnded:c,hours:d,overtimeHours:i}=oe;let r=0;if(me){const k={};Object.entries(ge).forEach(([F,I])=>{k[F]=I.map(ae=>ae&&ae.name&&ae.name.trim()?(r++,{...ae,timeStarted:s,timeEnded:c,hours:d,overtimeHours:i}):ae)}),de(k)}else z(j.map(k=>k&&k.name&&k.name.trim()?(r++,{...k,timeStarted:s,timeEnded:c,hours:d,overtimeHours:i}):k)),n(q.map(k=>k&&k.name&&k.name.trim()?(r++,{...k,timeStarted:s,timeEnded:c,hours:d,overtimeHours:i}):k)),G(A.map(k=>k&&k.name&&k.name.trim()?(r++,{...k,timeStarted:s,timeEnded:c,hours:d,overtimeHours:i}):k));O(!1),p({timeStarted:"",timeEnded:"",hours:"",overtimeHours:""}),r>0?u(B("appliedHours").replace("{count}",r),"success"):u(B("addWorkersFirst"),"info")},As=s=>{let c,d,i,r;switch(s){case"8hr":c="07:00",d="15:30",i="8",r="";break;case"10hr":c="06:00",d="16:30",i="8",r="2";break;case"4hr":c="07:00",d="11:00",i="4",r="";break;default:return}let k=0;if(me){const F={};Object.entries(ge).forEach(([I,ae])=>{F[I]=ae.map(ue=>ue&&ue.name&&ue.name.trim()?(k++,{...ue,timeStarted:c,timeEnded:d,hours:i,overtimeHours:r}):ue)}),de(F)}else z(F=>F.map(I=>I&&I.name&&I.name.trim()?(k++,{...I,timeStarted:c,timeEnded:d,hours:i,overtimeHours:r}):I)),n(F=>F.map(I=>I&&I.name&&I.name.trim()?(k++,{...I,timeStarted:c,timeEnded:d,hours:i,overtimeHours:r}):I)),G(F=>F.map(I=>I&&I.name&&I.name.trim()?(k++,{...I,timeStarted:c,timeEnded:d,hours:i,overtimeHours:r}):I));k>0?u(B("appliedHours").replace("{count}",k),"success"):u(B("addWorkersFirst"),"info")},Rs=async()=>{try{const s=await w.getCrewCheckin(a.id);s?.workers&&he(s.workers)}catch(s){console.error("Error loading crew:",s)}},Ds=async()=>{Xe(!0);try{const s=await w.getPreviousTicketCrew(a.id,E);if(!s||s.totalWorkers===0){u(B("noPreviousCrew"),"info");return}me&&s.dynamicWorkers?de(s.dynamicWorkers):(s.supervision&&z(s.supervision),s.operators&&n(s.operators),s.laborers&&G(s.laborers));const c=new Date(s.workDate).toLocaleDateString();u(B("loadedWorkers").replace("{count}",s.totalWorkers).replace("{date}",c),"success")}catch(s){console.error("Error loading previous crew:",s),u(B("errorLoadingCrew"),"error")}finally{Xe(!1)}},zs=()=>{z([...j,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},$e=(s,c,d)=>{z(j.map((i,r)=>{if(r!==s)return i;const k={...i,[c]:d};if(c==="timeStarted"||c==="timeEnded"){const F=c==="timeStarted"?d:i.timeStarted,I=c==="timeEnded"?d:i.timeEnded,ae=Te(F,I);ae&&(k.hours=ae.hours,k.overtimeHours=ae.overtimeHours)}return k}))},Ts=s=>{j.length>1?z(j.filter((c,d)=>d!==s)):z([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:"Foreman"}])},Hs=()=>{G([...A,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},ss=(s,c,d)=>{G(A.map((i,r)=>{if(r!==s)return i;const k={...i,[c]:d};if(c==="timeStarted"||c==="timeEnded"){const F=c==="timeStarted"?d:i.timeStarted,I=c==="timeEnded"?d:i.timeEnded,ae=Te(F,I);ae&&(k.hours=ae.hours,k.overtimeHours=ae.overtimeHours)}return k}))},Os=s=>{A.length>1?G(A.filter((c,d)=>d!==s)):G([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Fs=()=>{n([...q,{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},as=(s,c,d)=>{n(q.map((i,r)=>{if(r!==s)return i;const k={...i,[c]:d};if(c==="timeStarted"||c==="timeEnded"){const F=c==="timeStarted"?d:i.timeStarted,I=c==="timeEnded"?d:i.timeEnded,ae=Te(F,I);ae&&(k.hours=ae.hours,k.overtimeHours=ae.overtimeHours)}return k}))},Ms=s=>{q.length>1?n(q.filter((c,d)=>d!==s)):n([{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])},Ps=s=>{de(c=>({...c,[s]:[...c[s]||[],{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))},$s=(s,c,d,i)=>{de(r=>({...r,[s]:(r[s]||[]).map((k,F)=>{if(F!==c)return k;const I={...k,[d]:i};if(d==="timeStarted"||d==="timeEnded"){const ae=d==="timeStarted"?i:k.timeStarted,ue=d==="timeEnded"?i:k.timeEnded,Z=Te(ae,ue);Z&&(I.hours=Z.hours,I.overtimeHours=Z.overtimeHours)}return I})}))},qs=(s,c)=>{de(d=>{const i=d[s]||[];return i.length>1?{...d,[s]:i.filter((r,k)=>k!==c)}:{...d,[s]:[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}})},Is=s=>{s&&(ye(c=>new Set([...c,s])),de(c=>!c[s]||c[s].length===0?{...c,[s]:[{name:"",hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}:c))},Ws=s=>{ye(c=>{const d=new Set(c);return d.delete(s),d}),de(c=>{const d={...c};return delete d[s],d})},Us=()=>pe.filter(s=>!we.has(s.id)),qe=()=>{if(!ge||typeof ge!="object")return[];const s=[];return Object.entries(ge).forEach(([c,d])=>{if(!Array.isArray(d))return;const i=pe.find(r=>r.id===c);d.forEach(r=>{r&&r.name&&r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)&&s.push({name:r.name.trim(),hours:parseFloat(r.hours)||0,overtime_hours:parseFloat(r.overtimeHours)||0,time_started:r.timeStarted||null,time_ended:r.timeEnded||null,role:i?.name||"Worker",labor_class_id:c})})}),s},Bs=s=>{if(s.labor_class_id&&me&&pe.some(d=>d.id===s.labor_class_id)){we.has(s.labor_class_id)||ye(r=>new Set([...r,s.labor_class_id]));const d=ge[s.labor_class_id]||[],i=d.findIndex(r=>!r||!r.name||!r.name.trim());if(i>=0){const r=[...d];r[i]={...r[i],name:s.name},de(k=>({...k,[s.labor_class_id]:r}))}else de(r=>({...r,[s.labor_class_id]:[...r[s.labor_class_id]||[],{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))}else if(me){const i=[...we][0]||pe[0]?.id;if(i){we.has(i)||ye(F=>new Set([...F,i]));const r=ge[i]||[],k=r.findIndex(F=>!F||!F.name||!F.name.trim());if(k>=0){const F=[...r];F[k]={...F[k],name:s.name},de(I=>({...I,[i]:F}))}else de(F=>({...F,[i]:[...F[i]||[],{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}]}))}}else{const d=(s.role||"").toLowerCase();if(d.includes("foreman")||d.includes("supervisor")||d.includes("superintendent")){const i=j.findIndex(r=>!r||!r.name||!r.name.trim());i>=0?($e(i,"name",s.name),$e(i,"role",d.includes("superintendent")?"Superintendent":"Foreman")):z([...j,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:"",role:d.includes("superintendent")?"Superintendent":"Foreman"}])}else if(d.includes("operator")){const i=q.findIndex(r=>!r||!r.name||!r.name.trim());i>=0?as(i,"name",s.name):n([...q,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}else{const i=A.findIndex(r=>!r||!r.name||!r.name.trim());i>=0?ss(i,"name",s.name):G([...A,{name:s.name,hours:"",overtimeHours:"",timeStarted:"",timeEnded:""}])}}u(`Added ${s.name}`,"success")},Vs=async s=>{const c=Array.from(s.target.files);if(c.length===0)return;const d=f===-1?1/0:f-ie.length;if(d<=0){u(`Photo limit reached (${f} max)`,"error"),s.target.value="";return}const i=c.slice(0,d);i.length<c.length&&u(`Only ${i.length} photo(s) added (${f} max)`,"error");const r=await la(),k=10*1024*1024;i.forEach(F=>{if(!F.type.startsWith("image/")){u("Please select an image file","error");return}if(F.size>k){u(`Photo too large: ${F.name} (max 10MB)`,"error");return}const I=URL.createObjectURL(F),ae=`photo-${Date.now()}-${ps()}`;S(ue=>[...ue,{id:`${Date.now()}-${ps()}`,tempId:ae,file:F,previewUrl:I,name:F.name,status:"pending",attempts:0,error:null,uploadedUrl:null,latitude:r?.latitude||null,longitude:r?.longitude||null,gpsAccuracy:r?.accuracy||null}])}),s.target.value=""},fe=(s,c)=>{S(d=>d.map(i=>i.id===s?{...i,...c}:i))},Gs=async(s,c)=>{const d=ie.find(i=>i.id===s);if(!(!d||d.status!=="failed")){fe(s,{status:"compressing",error:null});try{let i=d.file;try{i=await cs(d.file)}catch(k){console.warn("Compression failed, using original:",k)}fe(s,{status:"uploading"});const r=await w.uploadPhoto(o,a.id,c,i);fe(s,{status:"confirmed",uploadedUrl:r,attempts:d.attempts+1}),await w.updateTMTicketPhotos(c,[...ie.filter(k=>k.uploadedUrl).map(k=>k.uploadedUrl),r]),u("Photo uploaded successfully","success")}catch(i){console.error("Retry failed:",i),fe(s,{status:"failed",error:i.message||"Upload failed",attempts:d.attempts+1}),u("Photo retry failed","error")}}},Ys=s=>{const c=ie.find(d=>d.id===s);c?.previewUrl&&URL.revokeObjectURL(c.previewUrl),S(ie.filter(d=>d.id!==s))},Le=j.filter(s=>s&&s.name&&s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),_e=q.filter(s=>s&&s.name&&s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),Ae=A.filter(s=>s&&s.name&&s.name.trim()&&(parseFloat(s.hours)>0||parseFloat(s.overtimeHours)>0)),Re=qe(),De=me?Re.length:Le.length+_e.length+Ae.length,Ie=me?Re.reduce((s,c)=>s+(c.hours||0),0):[...Le,..._e,...Ae].reduce((s,c)=>s+parseFloat(c.hours||0),0),We=me?Re.reduce((s,c)=>s+(c.overtime_hours||0),0):[...Le,..._e,...Ae].reduce((s,c)=>s+parseFloat(c.overtimeHours||0),0),ts=me?Object.values(ge||{}).flat().filter(s=>s&&s.name&&s.name.trim()):[...j.filter(s=>s&&s.name&&s.name.trim()),...q.filter(s=>s&&s.name&&s.name.trim()),...A.filter(s=>s&&s.name&&s.name.trim())],Ue=ts.length-De,rs=()=>{if(h===1)return Q.trim().length>0;if(h===2){if(me)return qe().length>0;const s=j.some(i=>i&&i.name&&i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)),c=q.some(i=>i&&i.name&&i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0)),d=A.some(i=>i&&i.name&&i.name.trim()&&(parseFloat(i.hours)>0||parseFloat(i.overtimeHours)>0));return s||c||d}return!0},is=(()=>{const s=[];return h===1&&!Q.trim()&&s.push(B("descriptionRecommended")),h===2&&Ue>0&&s.push(`${Ue} ${B("workersNoHours")}`),h===4&&!b.trim()&&s.push(B("nameRequired")),s})(),ze=()=>{h<4&&g(h+1)},Qs=()=>{h>1?g(h-1):T()},Ks=async()=>{if(!b.trim()){u("Enter your name to submit","error");return}let s=[];if(me){if(s=qe(),s.length===0){u("Add at least one worker","error");return}}else{const c=j.filter(r=>r&&r.name&&r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)),d=q.filter(r=>r&&r.name&&r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0)),i=A.filter(r=>r&&r.name&&r.name.trim()&&(parseFloat(r.hours)>0||parseFloat(r.overtimeHours)>0));if(c.length===0&&d.length===0&&i.length===0){u("Add at least one worker","error");return}s=[...c.map(r=>({name:r.name.trim(),hours:parseFloat(r.hours)||0,overtime_hours:parseFloat(r.overtimeHours)||0,time_started:r.timeStarted||null,time_ended:r.timeEnded||null,role:r.role})),...d.map(r=>({name:r.name.trim(),hours:parseFloat(r.hours)||0,overtime_hours:parseFloat(r.overtimeHours)||0,time_started:r.timeStarted||null,time_ended:r.timeEnded||null,role:"Operator"})),...i.map(r=>({name:r.name.trim(),hours:parseFloat(r.hours)||0,overtime_hours:parseFloat(r.overtimeHours)||0,time_started:r.timeStarted||null,time_ended:r.timeEnded||null,role:"Laborer"}))]}Y(!0),re("Creating ticket...");try{const c=await w.createTMTicket({project_id:a.id,work_date:E,ce_pco_number:N.trim()||null,assigned_cor_id:M||null,notes:Q.trim()||null,photos:[],created_by_name:b.trim()});if(!c||!c.id)throw new Error("Failed to create ticket - no ticket ID returned");let d=[];const i=ie.filter(r=>r.status==="pending");if(i.length>0){re(`Compressing ${i.length} photo${i.length>1?"s":""}...`),i.forEach(Z=>fe(Z.id,{status:"compressing"}));const r=await Promise.all(i.map(async Z=>{try{const ce=await cs(Z.file);return{...Z,file:ce}}catch(ce){return console.warn(`Failed to compress photo ${Z.name}, using original:`,ce),Z}}));re(`Uploading ${i.length} photo${i.length>1?"s":""}...`),i.forEach(Z=>fe(Z.id,{status:"uploading"}));let k=0,F=0;const I=r.map(async Z=>{try{const ce=await w.uploadPhoto(o,a.id,c.id,Z.file);return k++,re(`Uploading ${k}/${i.length} photos...`),fe(Z.id,{status:"confirmed",uploadedUrl:ce,attempts:(Z.attempts||0)+1}),{id:Z.id,url:ce}}catch(ce){return console.error(`Photo ${Z.name} upload failed:`,ce),F++,fe(Z.id,{status:"failed",error:ce.message||"Upload failed",attempts:(Z.attempts||0)+1}),{id:Z.id,url:null,error:ce.message}}}),ae=await Promise.all(I);d=ae.filter(Z=>Z.url!==null).map(Z=>Z.url);const ue={};for(const Z of ae)if(Z.url){const ce=i.find(Js=>Js.id===Z.id);ce?.latitude&&ce?.longitude&&(ue[Z.url]={lat:ce.latitude,lng:ce.longitude,accuracy:ce.gpsAccuracy})}F>0&&d.length>0?u(`${d.length}/${i.length} photos uploaded. ${F} failed - can retry later.`,"warning"):F>0&&d.length===0&&u(`All ${F} photos failed to upload - can retry after submission.`,"error"),d.length>0&&(re("Saving photos..."),await w.updateTMTicketPhotos(c.id,d,Object.keys(ue).length>0?ue:null))}else d.length>0&&(re("Saving photos..."),await w.updateTMTicketPhotos(c.id,d));if(re("Saving workers..."),await w.addTMWorkers(c.id,s),m.length>0&&(re("Saving materials..."),await w.addTMItems(c.id,m.map(r=>({material_equipment_id:r.material_equipment_id,custom_name:r.custom_name||null,custom_category:r.custom_category||null,quantity:r.quantity})))),M){re("Importing to COR...");try{await w.importTicketDataToCOR(c.id,M,o,a.work_type||"demolition",a.job_type||"standard")}catch(r){console.error("Error importing to COR:",r);try{await w.markImportFailed(c.id,M,r?.message||"Import failed")}catch(k){console.error("Error marking import failed:",k)}u("T&M saved. COR data sync failed - retry from ticket list.","warning")}}ie.forEach(r=>{r.previewUrl&&URL.revokeObjectURL(r.previewUrl)}),y(c),u("T&M submitted!","success"),g(5)}catch(c){console.error("Error submitting T&M:",c),u("Error submitting T&M","error")}finally{Y(!1),re("")}};return e.jsxs("div",{className:"tm-wizard",children:[e.jsxs("div",{className:"tm-wizard-header",children:[h<5?e.jsx("button",{className:"tm-back-btn",onClick:Qs,children:"â†"}):e.jsx("div",{className:"tm-success-check",children:e.jsx(ve,{size:24})}),e.jsxs("h2",{children:[h===1&&B("workInfo"),h===2&&B("crewHours"),h===3&&B("materialsEquipment"),h===4&&B("review"),h===5&&B("submitted")]}),e.jsxs("div",{className:"tm-header-right",children:[h<4&&e.jsxs("button",{className:"tm-lang-toggle",onClick:()=>Cs(xe==="en"?"es":"en"),title:B(xe==="en"?"switchToSpanish":"switchToEnglish"),children:[e.jsx(xa,{size:16}),xe==="en"?"ES":"EN"]}),h<5&&e.jsxs("div",{className:"tm-step-dots",children:[e.jsx("span",{className:`tm-dot ${h>=1?"active":""}`}),e.jsx("span",{className:`tm-dot ${h>=2?"active":""}`}),e.jsx("span",{className:`tm-dot ${h>=3?"active":""}`}),e.jsx("span",{className:`tm-dot ${h>=4?"active":""}`})]})]})]}),h===1&&e.jsx(Ma,{project:a,workDate:E,setWorkDate:v,cePcoNumber:N,setCePcoNumber:L,notes:Q,setNotes:J,t:B,lang:xe}),h===2&&e.jsx(qa,{supervision:j,operators:q,laborers:A,dynamicWorkers:ge,activeLaborClassIds:we,setActiveLaborClassIds:ye,laborCategories:Ss,laborClasses:pe,hasCustomLaborClasses:me,loadingLaborClasses:Pe,todaysCrew:ne,showBatchHoursModal:x,setShowBatchHoursModal:O,batchHours:oe,setBatchHours:p,loadingPreviousCrew:je,namedWorkers:ts,workersNeedingHours:Ue,totalRegHours:Ie,totalOTHours:We,onLoadPreviousCrew:Ds,onApplyBatchHours:_s,onApplyInlinePreset:As,onAddCrewWorker:Bs,onActivateLaborClass:Is,onDeactivateLaborClass:Ws,addSupervision:zs,updateSupervision:$e,removeSupervision:Ts,addOperator:Fs,updateOperator:as,removeOperator:Ms,addLaborer:Hs,updateLaborer:ss,removeLaborer:Os,addDynamicWorker:Ps,updateDynamicWorker:$s,removeDynamicWorker:qs,getInactiveLaborClasses:Us,t:B,lang:xe,onShowToast:u}),h===3&&e.jsx(Ia,{companyId:o,items:m,setItems:t,t:B,lang:xe,onShowToast:u}),(h===4||h===5)&&e.jsx(Va,{step:h,setStep:g,project:a,companyId:o,workDate:E,cePcoNumber:N,notes:Q,photos:ie,onPhotoAdd:Vs,onRemovePhoto:Ys,maxPhotos:f,selectedCorId:M,setSelectedCorId:$,assignableCORs:te,items:m,hasCustomLaborClasses:me,validDynamicWorkersList:Re,validSupervision:Le,validOperators:_e,validLaborers:Ae,totalWorkers:De,totalRegHours:Ie,totalOTHours:We,submittedByName:b,setSubmittedByName:D,submittedTicket:W,submitting:V,submitProgress:le,clientSigned:P,setClientSigned:H,showSignatureLinkModal:_,setShowSignatureLinkModal:U,showOnSiteSignature:R,setShowOnSiteSignature:X,onRetryPhotoUpload:Gs,t:B,lang:xe,onShowToast:u}),h<5&&e.jsxs("div",{className:"tm-wizard-footer",children:[is.length>0&&e.jsxs("div",{className:"tm-validation-summary",children:[e.jsx(Ke,{size:16}),e.jsx("span",{children:is[0]})]}),h===1&&e.jsx("button",{className:"tm-big-btn primary",onClick:ze,disabled:!rs(),children:B("nextCrew")}),h===2&&e.jsxs("button",{className:"tm-big-btn primary",onClick:ze,disabled:!rs(),children:[B("nextMaterials")," (",De," ",B(De===1?"worker":"workers_plural"),", ",Ie+We," hrs)"]}),h===3&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:ze,children:[B("reviewAndSubmit")," (",m.length," ",m.length===1?B("item"):B("items_plural"),")"]}),e.jsx("button",{className:"tm-skip-btn",onClick:ze,children:B("skipNoMaterials")})]}),h===4&&e.jsx("button",{className:`tm-big-btn submit ${V?"submitting":""} ${b.trim()?"ready":"needs-name"}`,onClick:Ks,disabled:V||!b.trim(),children:V?e.jsxs(e.Fragment,{children:[e.jsx(Je,{size:20,className:"tm-spinner"}),e.jsx("span",{className:"tm-submit-text",children:le||B("submitting")})]}):b.trim()?e.jsxs(e.Fragment,{children:[e.jsx(Se,{size:20}),e.jsx("span",{children:B("submitTM")})]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{size:18}),e.jsx("span",{children:B("enterNameToSubmit")})]})})]}),h===5&&e.jsxs("div",{className:"tm-wizard-footer",children:[e.jsxs("button",{className:"tm-big-btn primary",onClick:C,children:[e.jsx(Se,{size:20}),e.jsx("span",{children:B("done")})]}),e.jsx("button",{className:"tm-skip-btn",onClick:C,children:B("skipSignature")})]})]})}function Ya({project:a,companyId:o,onShowToast:f}){const[C,T]=l.useState([]),[u,h]=l.useState(!0),[g,E]=l.useState(!1),[v,W]=l.useState(!1),[y,_]=l.useState({name:"",role:"",labor_class_id:null}),[U,R]=l.useState([]),[X,P]=l.useState(!0),[H,N]=l.useState([]),[L,b]=l.useState([]),[D,M]=l.useState(!0),$=["Foreman","Laborer","Supervisor","Operator"],te=l.useCallback(async()=>{try{const n=await w.getCrewCheckin(a.id);n?.workers&&T(n.workers)}catch(n){console.error("Error loading crew:",n),f?.("Error loading today's crew","error")}finally{h(!1)}},[a?.id,f]),se=l.useCallback(async()=>{try{const n=await w.getRecentWorkers(a.id,30);R(n)}catch(n){console.error("Error loading recent workers:",n)}finally{P(!1)}},[a?.id]),K=l.useCallback(async()=>{try{const n=await w.getLaborClassesForField(o);N(n.categories||[]),b(n.classes||[]),n.classes&&n.classes.length>0&&_(A=>({...A,role:n.classes[0].name,labor_class_id:n.classes[0].id}))}catch(n){console.error("Error loading labor classes:",n),f?.("Using default roles - custom labor classes unavailable","info")}finally{M(!1)}},[o,f]);l.useEffect(()=>{a?.id&&(te(),se(),o?K():M(!1))},[a?.id,o,te,se,K]);const ee=n=>{const A=L.find(G=>G.id===n);_(A?{...y,role:A.name,labor_class_id:A.id}:{...y,role:n,labor_class_id:null})},x=async()=>{if(!y.name.trim()){f("Enter worker name","error");return}if(!y.role){f("Select a role","error");return}if(C.find(n=>n.name.toLowerCase()===y.name.trim().toLowerCase())){f("Worker already added","error");return}E(!0);try{const n=[...C,{name:y.name.trim(),role:y.role,labor_class_id:y.labor_class_id}];await w.saveCrewCheckin(a.id,n),T(n),_({...y,name:""}),W(!1),f("Crew member added","success")}catch(n){console.error("Error adding worker:",n),f("Error adding crew member","error")}finally{E(!1)}},O=async n=>{E(!0);try{const A=C.filter(G=>G.name.toLowerCase()!==n.toLowerCase());await w.saveCrewCheckin(a.id,A),T(A),f("Crew member removed","success")}catch(A){console.error("Error removing worker:",A),f("Error removing crew member","error")}finally{E(!1)}},oe=async n=>{if(C.find(A=>A.name.toLowerCase()===n.name.toLowerCase())){f("Already checked in","info");return}E(!0);try{const A=[...C,{name:n.name,role:n.role,labor_class_id:n.labor_class_id}];await w.saveCrewCheckin(a.id,A),T(A),f(`${n.name} checked in`,"success")}catch(A){console.error("Error adding worker:",A),f("Error adding crew member","error")}finally{E(!1)}},p=U.filter(n=>!C.find(A=>A.name.toLowerCase()===n.name.toLowerCase())),j=new Date().toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"}),z=()=>{const n={};H.forEach(G=>{n[G.id]={name:G.name,classes:L.filter(m=>m.category_id===G.id)}});const A=L.filter(G=>!G.category_id);return A.length>0&&(n.uncategorized={name:"Other",classes:A}),n},q=L.length>0;return u||D?e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(ke,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:j})]}),e.jsx("div",{className:"crew-loading",children:"Loading..."})]}):e.jsxs("div",{className:"crew-checkin",children:[e.jsxs("div",{className:"crew-header",children:[e.jsxs("h3",{children:[e.jsx(ke,{size:18,className:"inline-icon"})," Today's Crew"]}),e.jsx("span",{className:"crew-date",children:j})]}),C.length===0?e.jsxs("div",{className:"crew-empty",children:[e.jsx("p",{children:"No crew checked in yet"}),e.jsx("p",{className:"crew-empty-hint",children:"Add your crew for the day"})]}):e.jsx("div",{className:"crew-list",children:C.map(n=>e.jsxs("div",{className:"crew-member",children:[e.jsxs("div",{className:"crew-member-info",children:[e.jsx("span",{className:"crew-member-name",children:n.name}),e.jsx("span",{className:`crew-member-role ${(n.role||"laborer").toLowerCase().replace(/\s+/g,"-")}`,children:n.role})]}),e.jsx("button",{className:"crew-remove-btn",onClick:()=>O(n.name),disabled:g,children:"Ã—"})]},n.name))}),!X&&p.length>0&&e.jsxs("div",{className:"crew-quick-add",children:[e.jsx("div",{className:"crew-quick-add-header",children:e.jsx("span",{children:"Tap to add"})}),e.jsx("div",{className:"crew-quick-add-grid",children:p.map(n=>e.jsxs("button",{className:"crew-quick-add-btn",onClick:()=>oe(n),disabled:g,children:[e.jsx("span",{className:"crew-quick-add-name",children:n.name}),e.jsx("span",{className:"crew-quick-add-role",children:n.role})]},n.name))})]}),v?e.jsxs("div",{className:"crew-add-form",children:[e.jsx("input",{type:"text",value:y.name,onChange:n=>_({...y,name:n.target.value}),placeholder:"Name",autoFocus:!0}),e.jsx("select",{value:y.labor_class_id||y.role,onChange:n=>ee(n.target.value),children:q?Object.entries(z()).map(([n,A])=>e.jsx("optgroup",{label:A.name,children:A.classes.map(G=>e.jsx("option",{value:G.id,children:G.name},G.id))},n)):$.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsxs("div",{className:"crew-add-buttons",children:[e.jsx("button",{className:"crew-add-confirm",onClick:x,disabled:g,children:g?"...":"Add"}),e.jsx("button",{className:"crew-add-cancel",onClick:()=>{W(!1),_({name:"",role:L[0]?.name||"Laborer",labor_class_id:L[0]?.id||null})},children:"Cancel"})]})]}):e.jsxs("button",{className:"crew-add-btn",onClick:()=>W(!0),children:[e.jsx(fa,{size:18}),e.jsx("span",{children:"Add New Person"})]}),e.jsxs("div",{className:"crew-count",children:[C.length," ",C.length===1?"person":"people"," on site"]})]})}function Qa({project:a,onShowToast:o,onClose:f}){const[C,T]=l.useState(!0),[u,h]=l.useState(!1),[g,E]=l.useState(null),[v,W]=l.useState(""),[y,_]=l.useState("");l.useEffect(()=>{a?.id&&U()},[a?.id]);const U=async()=>{try{const H=await w.getDailyReport(a.id);if(H)E(H),W(H.field_notes||""),_(H.issues||"");else{const N=await w.compileDailyReport(a.id);E({...N,status:"draft"})}}catch(H){console.error("Error loading report:",H),o("Error loading report","error")}finally{T(!1)}},R=async()=>{if(!fs){o("Demo Mode: Report saved locally only - won't reach office","info"),f();return}h(!0);try{await w.saveDailyReport(a.id,{field_notes:v,issues:y}),await w.submitDailyReport(a.id,"Field")?(o("Daily report submitted!","success"),f()):o("Report not sent - check connection","error")}catch(H){console.error("Error submitting report:",H),o("Error submitting report","error")}finally{h(!1)}},X=new Date().toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"});if(C)return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:f,children:"â†"}),e.jsx("h2",{children:"Daily Report"})]}),e.jsx("div",{className:"daily-report-loading",children:"Compiling report..."})]});if(!g)return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:f,children:"â†"}),e.jsx("h2",{children:"Daily Report"})]}),e.jsxs("div",{className:"daily-report-error",children:[e.jsx("p",{children:"Unable to load report data."}),e.jsx("button",{className:"btn btn-secondary",onClick:U,children:"Retry"})]})]});const P=g.status==="submitted";return e.jsxs("div",{className:"daily-report",children:[e.jsxs("div",{className:"daily-report-header",children:[e.jsx("button",{className:"back-btn-simple",onClick:f,children:"â†"}),e.jsxs("div",{children:[e.jsx("h2",{children:"Daily Report"}),e.jsx("p",{className:"daily-report-date",children:X})]})]}),P&&e.jsxs("div",{className:"daily-report-submitted-banner",children:["âœ“ Submitted ",new Date(g.submitted_at).toLocaleTimeString()]}),e.jsxs("div",{className:"daily-report-content",children:[e.jsxs("div",{className:"daily-report-summary",children:[e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:g.crew_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Crew on Site"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:g.tasks_completed||0}),e.jsx("div",{className:"daily-report-card-label",children:"Tasks Done"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:g.tm_tickets_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"T&M Tickets"})]}),e.jsxs("div",{className:"daily-report-card",children:[e.jsx("div",{className:"daily-report-card-value",children:g.photos_count||0}),e.jsx("div",{className:"daily-report-card-label",children:"Photos"})]})]}),g.crew_list?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(ke,{size:18,className:"inline-icon"})," Crew"]}),e.jsx("div",{className:"daily-report-crew",children:g.crew_list.map((H,N)=>e.jsxs("div",{className:"daily-report-crew-item",children:[e.jsx("span",{children:H.name}),e.jsx("span",{className:"daily-report-crew-role",children:H.role})]},N))})]}),g.completed_tasks?.length>0&&e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(ba,{size:18,className:"inline-icon"})," Completed Today"]}),e.jsx("ul",{className:"daily-report-tasks",children:g.completed_tasks.map((H,N)=>e.jsxs("li",{children:[H.name,H.group&&e.jsx("span",{className:"daily-report-task-group",children:H.group})]},N))})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(Ee,{size:18,className:"inline-icon"})," Notes"]}),e.jsx("textarea",{value:v,onChange:H=>W(H.target.value),placeholder:"Any notes about today's work...",rows:3,disabled:P})]}),e.jsxs("div",{className:"daily-report-section",children:[e.jsxs("h3",{children:[e.jsx(bs,{size:18,className:"inline-icon"})," Issues / Concerns"]}),e.jsx("textarea",{value:y,onChange:H=>_(H.target.value),placeholder:"Any problems, delays, or concerns...",rows:3,disabled:P})]})]}),!P&&e.jsxs("div",{className:"daily-report-footer",children:[e.jsx("button",{className:"btn btn-primary daily-report-submit",onClick:R,disabled:u,children:u?"Submitting...":e.jsxs(e.Fragment,{children:[e.jsx(va,{size:16,className:"inline-icon"})," Submit Report"]})}),e.jsx("p",{className:"daily-report-hint",children:"This will be sent to the office"})]})]})}const Oe=[{value:"concrete",label:"Concrete",icon:"ğŸ§±"},{value:"trash",label:"Trash",icon:"ğŸ—‘ï¸"},{value:"metals",label:"Metals",icon:"ğŸ”©"},{value:"hazardous_waste",label:"Hazardous",icon:"â˜£ï¸"}],Ka=a=>Oe.find(o=>o.value===a)||{label:a,icon:"ğŸ“¦"};function Ja({project:a,user:o=null,date:f,onShowToast:C}){const[T,u]=l.useState([]),[h,g]=l.useState([]),[E,v]=l.useState(!0),[W,y]=l.useState(!1),[_,U]=l.useState(!1),[R,X]=l.useState(!1),[P,H]=l.useState({type:"concrete",count:1}),N=new Date(f).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});l.useEffect(()=>{L(),b()},[a.id,f]);const L=async()=>{try{v(!0);const x=await w.getDisposalLoads(a.id,f);u(x||[])}catch(x){console.error("Error loading disposal loads:",x)}finally{v(!1)}},b=async()=>{try{const O=(await w.getDisposalLoadsHistory(a.id,14)||[]).filter(p=>p.load_date!==f).reduce((p,j)=>(p[j.load_date]||(p[j.load_date]=[]),p[j.load_date].push(j),p),{}),oe=Object.entries(O).map(([p,j])=>({date:p,loads:j,totalLoads:j.reduce((z,q)=>z+q.load_count,0)})).sort((p,j)=>new Date(j.date)-new Date(p.date));g(oe)}catch(x){console.error("Error loading disposal history:",x)}},D=async()=>{if(!(P.count<1)){y(!0);try{await w.addDisposalLoad(a.id,o?.id||null,f,P.type,P.count),await L(),H({type:"concrete",count:1}),U(!1),C?.("Disposal load added","success")}catch(x){console.error("Error adding disposal load:",x),C?.("Error adding load","error")}finally{y(!1)}}},M=async x=>{y(!0);try{await w.deleteDisposalLoad(x),await L(),C?.("Load removed","success")}catch(O){console.error("Error deleting disposal load:",O),C?.("Error removing load","error")}finally{y(!1)}},$=async x=>{y(!0);try{await w.addDisposalLoad(a.id,o?.id||null,f,x,1),await L(),C?.("Load added","success")}catch(O){console.error("Error adding disposal load:",O),C?.("Error adding load","error")}finally{y(!1)}},te=async x=>{y(!0);try{await w.updateDisposalLoad(x.id,x.load_type,x.load_count+1),await L()}catch(O){console.error("Error updating load:",O),C?.("Error updating load","error")}finally{y(!1)}},se=async x=>{if(x.load_count<=1){await M(x.id);return}y(!0);try{await w.updateDisposalLoad(x.id,x.load_type,x.load_count-1),await L()}catch(O){console.error("Error updating load:",O),C?.("Error updating load","error")}finally{y(!1)}},K=T.reduce((x,O)=>(x[O.load_type]||(x[O.load_type]={items:[],total:0}),x[O.load_type].items.push(O),x[O.load_type].total+=O.load_count,x),{}),ee=T.reduce((x,O)=>x+O.load_count,0);return E?e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsx(Fe,{size:20}),e.jsx("span",{children:"Disposal Loads"})]}),e.jsx("div",{className:"disposal-loading",children:"Loading..."})]}):e.jsxs("div",{className:"disposal-load-input",children:[e.jsxs("div",{className:"disposal-header",children:[e.jsxs("div",{className:"disposal-title",children:[e.jsx(Fe,{size:20}),e.jsx("span",{children:"Disposal Loads"}),ee>0&&e.jsx("span",{className:"disposal-badge",children:ee})]}),e.jsx("span",{className:"disposal-date",children:N})]}),e.jsx("div",{className:"disposal-quick-add",children:Oe.map(x=>e.jsxs("button",{className:"quick-add-btn",onClick:()=>$(x.value),disabled:W,children:[e.jsx("span",{className:"quick-add-icon",children:x.icon}),e.jsxs("span",{className:"quick-add-label",children:["+ ",x.label]})]},x.value))}),Object.keys(K).length>0?e.jsx("div",{className:"disposal-loads-list",children:Oe.map(x=>{const O=K[x.value];return O?e.jsxs("div",{className:"disposal-load-row",children:[e.jsxs("div",{className:"load-info",children:[e.jsx("span",{className:"load-icon",children:x.icon}),e.jsx("span",{className:"load-label",children:x.label})]}),e.jsxs("div",{className:"load-controls",children:[e.jsx("button",{className:"load-btn decrement",onClick:()=>se(O.items[0]),disabled:W,children:e.jsx(us,{size:16})}),e.jsx("span",{className:"load-count",children:O.total}),e.jsx("button",{className:"load-btn increment",onClick:()=>te(O.items[0]),disabled:W,children:e.jsx(Ge,{size:16})})]})]},x.value):null})}):e.jsxs("div",{className:"disposal-empty",children:[e.jsxs("p",{children:["No disposal loads recorded for ",N]}),e.jsx("p",{className:"disposal-hint",children:"Tap a button above to add loads"})]}),_&&e.jsxs("div",{className:"disposal-add-form",children:[e.jsxs("div",{className:"add-form-row",children:[e.jsx("select",{value:P.type,onChange:x=>H({...P,type:x.target.value}),className:"load-type-select",children:Oe.map(x=>e.jsxs("option",{value:x.value,children:[x.icon," ",x.label]},x.value))}),e.jsxs("div",{className:"count-input-group",children:[e.jsx("button",{className:"count-btn",onClick:()=>H({...P,count:Math.max(1,P.count-1)}),children:e.jsx(us,{size:16})}),e.jsx("input",{type:"number",min:"1",value:P.count,onChange:x=>H({...P,count:parseInt(x.target.value)||1}),className:"count-input"}),e.jsx("button",{className:"count-btn",onClick:()=>H({...P,count:P.count+1}),children:e.jsx(Ge,{size:16})})]})]}),e.jsxs("div",{className:"add-form-actions",children:[e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:()=>U(!1),children:[e.jsx(ja,{size:16})," Cancel"]}),e.jsxs("button",{className:"btn btn-primary btn-small",onClick:D,disabled:W,children:[e.jsx(Se,{size:16})," Add"]})]})]}),!_&&e.jsxs("button",{className:"disposal-add-custom",onClick:()=>U(!0),children:[e.jsx(Ge,{size:16}),"Add multiple loads"]}),ee>0&&e.jsxs("div",{className:"disposal-summary",children:[e.jsx("strong",{children:ee})," total load",ee!==1?"s":""," today"]}),h.length>0&&e.jsxs("div",{className:"disposal-history-section",children:[e.jsxs("button",{className:"disposal-history-toggle",onClick:()=>X(!R),children:[e.jsx(ya,{size:16}),e.jsxs("span",{children:["View History (",h.length," days)"]}),R?e.jsx(vs,{size:16}):e.jsx(Me,{size:16})]}),R&&e.jsx("div",{className:"disposal-history-list",children:h.map(x=>{const O=new Date(x.date).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),oe=x.loads.reduce((p,j)=>(p[j.load_type]||(p[j.load_type]=0),p[j.load_type]+=j.load_count,p),{});return e.jsxs("div",{className:"disposal-history-day",children:[e.jsxs("div",{className:"disposal-history-header",children:[e.jsx("span",{className:"disposal-history-date",children:O}),e.jsxs("span",{className:"disposal-history-total",children:[x.totalLoads," load",x.totalLoads!==1?"s":""]})]}),e.jsx("div",{className:"disposal-history-types",children:Object.entries(oe).map(([p,j])=>{const z=Ka(p);return e.jsxs("span",{className:"disposal-history-type",children:[z.icon," ",j," ",z.label]},p)})})]},x.date)})})]})]})}function Xa({project:a,companyId:o,onBack:f}){const[C,T]=l.useState(!0),[u,h]=l.useState("week"),[g,E]=l.useState({areas:[],tickets:[],crewHistory:[],disposalLoads:[],dailyReports:[]});l.useEffect(()=>{a?.id&&v()},[a?.id,u]);const v=async()=>{T(!0);try{const N=new Date,L=new Date;u==="week"?L.setDate(N.getDate()-7):L.setDate(N.getDate()-30);const b=L.toISOString().split("T")[0],D=u==="week"?7:30,[M,$,te,se]=await Promise.all([w.getAreas(a.id),w.getTMTickets?.(a.id)||[],w.getDisposalLoadsHistory?.(a.id,D)||[],w.getDailyReports?.(a.id)||[]]),K=[],ee=new Date(L);for(;ee<=N;){const x=ee.toISOString().split("T")[0];try{const O=await w.getCrewCheckin(a.id,x);K.push({date:x,count:O?.workers?.length||0,dayName:ee.toLocaleDateString("en-US",{weekday:"short"})})}catch{K.push({date:x,count:0,dayName:ee.toLocaleDateString("en-US",{weekday:"short"})})}ee.setDate(ee.getDate()+1)}E({areas:M,tickets:$.filter(x=>x.work_date>=b),crewHistory:K,disposalLoads:te,dailyReports:se.filter(x=>x.report_date>=b)})}catch(N){console.error("Error loading metrics:",N)}finally{T(!1)}},W=l.useRef(null),y=l.useCallback(()=>{W.current&&clearTimeout(W.current),W.current=setTimeout(()=>{v()},300)},[a?.id,u]);l.useEffect(()=>{if(!a?.id)return;const N=[],L=w.subscribeToAreas?.(a.id,y);L&&N.push(L);const b=w.subscribeToCrewCheckins?.(a.id,y);b&&N.push(b);const D=w.subscribeToTMTickets?.(a.id,y);D&&N.push(D);const M=w.subscribeToHaulOffs?.(a.id,y);M&&N.push(M);const $=w.subscribeToDailyReports?.(a.id,y);return $&&N.push($),()=>{W.current&&clearTimeout(W.current),N.forEach(te=>w.unsubscribe?.(te))}},[a?.id,y]);const _=l.useMemo(()=>{const{areas:N,tickets:L,crewHistory:b,disposalLoads:D,dailyReports:M}=g,$=N.length,te=N.filter(t=>t.status==="done").length,se=N.filter(t=>t.status==="working").length,K=N.filter(t=>t.status==="not_started").length,ee=$>0?Math.round(te/$*100):0,x=b.reduce((t,Q)=>t+Q.count,0),O=b.length>0&&Math.round(x/b.filter(t=>t.count>0).length*10)/10||0,oe=b.filter(t=>t.count>0).length,p=L.filter(t=>t.status==="pending"||t.status==="draft").length,j=L.filter(t=>t.status==="signed"||t.status==="approved").length,z=L.reduce((t,Q)=>t+(Q.total_amount||0),0),q=D.reduce((t,Q)=>t+(Q.load_count||0),0),n=0,A=M.filter(t=>t.submitted).length,G=u==="week"?7:30,m=U(M);return{progress:{totalAreas:$,completedAreas:te,inProgressAreas:se,notStartedAreas:K,progressPercent:ee},crew:{totalManDays:x,avgCrewSize:O,daysWithCrew:oe,history:b},tickets:{total:L.length,pending:p,signed:j,totalValue:z},disposal:{totalLoads:q,totalTonnage:n},reports:{submitted:A,due:G,streak:m}}},[g,u]);function U(N){if(!N.length)return 0;const L=[...new Set(N.filter($=>$.submitted).map($=>$.report_date))].sort().reverse();let b=0;const D=new Date().toISOString().split("T")[0],M=new Date(D);for(let $=0;$<30;$++){const te=M.toISOString().split("T")[0];if(L.includes(te))b++,M.setDate(M.getDate()-1);else break}return b}const R={primary:"#3b82f6",success:"#22c55e",warning:"#f59e0b",muted:"#6b7280",purple:"#8b5cf6"},X=[R.success,R.primary,R.muted],P=[{name:"Completed",value:_.progress.completedAreas},{name:"In Progress",value:_.progress.inProgressAreas},{name:"Not Started",value:_.progress.notStartedAreas}].filter(N=>N.value>0),H=l.useMemo(()=>{const N={};return g.tickets.forEach(L=>{const b=L.work_date;N[b]=(N[b]||0)+1}),_.crew.history.map(L=>({...L,tickets:N[L.date]||0}))},[g.tickets,_.crew.history]);return C?e.jsxs("div",{className:"foreman-metrics loading",children:[e.jsxs("div",{className:"metrics-header",children:[e.jsxs("button",{className:"back-btn",onClick:f,children:[e.jsx(be,{size:20}),"Back"]}),e.jsx("h2",{children:"Project Metrics"})]}),e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading metrics..."})]})]}):e.jsxs("div",{className:"foreman-metrics",children:[e.jsxs("div",{className:"metrics-header",children:[e.jsxs("button",{className:"back-btn",onClick:f,children:[e.jsx(be,{size:20}),"Back"]}),e.jsx("h2",{children:"Project Metrics"}),e.jsxs("div",{className:"time-toggle",children:[e.jsx("button",{className:u==="week"?"active":"",onClick:()=>h("week"),children:"7 Days"}),e.jsx("button",{className:u==="month"?"active":"",onClick:()=>h("month"),children:"30 Days"})]})]}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card progress-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(js,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsxs("span",{className:"card-value",children:[_.progress.progressPercent,"%"]}),e.jsx("span",{className:"card-label",children:"Complete"})]}),e.jsxs("div",{className:"card-detail",children:[_.progress.completedAreas,"/",_.progress.totalAreas," areas"]})]}),e.jsxs("div",{className:"summary-card crew-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(ys,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsx("span",{className:"card-value",children:_.crew.totalManDays}),e.jsx("span",{className:"card-label",children:"Man-Days"})]}),e.jsxs("div",{className:"card-detail",children:["Avg ",_.crew.avgCrewSize," workers/day"]})]}),e.jsxs("div",{className:"summary-card tickets-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(Ee,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsx("span",{className:"card-value",children:_.tickets.total}),e.jsx("span",{className:"card-label",children:"T&M Tickets"})]}),e.jsxs("div",{className:"card-detail",children:[_.tickets.signed," signed, ",_.tickets.pending," pending"]})]}),e.jsxs("div",{className:"summary-card disposal-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(Fe,{size:24})}),e.jsxs("div",{className:"card-content",children:[e.jsx("span",{className:"card-value",children:_.disposal.totalLoads}),e.jsx("span",{className:"card-label",children:"Disposal Loads"})]}),e.jsxs("div",{className:"card-detail",children:[_.disposal.totalTonnage.toFixed(1)," tons"]})]})]}),e.jsxs("div",{className:"charts-grid",children:[e.jsxs("div",{className:"chart-card",children:[e.jsx("h3",{children:"Area Progress"}),P.length>0?e.jsx(Be,{width:"100%",height:200,children:e.jsxs(Zs,{children:[e.jsx(ea,{data:P,cx:"50%",cy:"50%",innerRadius:50,outerRadius:80,paddingAngle:2,dataKey:"value",label:({name:N,value:L})=>`${N}: ${L}`,labelLine:!1,children:P.map((N,L)=>e.jsx(sa,{fill:X[L%X.length]},`cell-${L}`))}),e.jsx(Ve,{})]})}):e.jsx("div",{className:"no-data",children:"No area data"})]}),e.jsxs("div",{className:"chart-card",children:[e.jsx("h3",{children:"Daily Crew Size"}),e.jsx(Be,{width:"100%",height:200,children:e.jsxs(aa,{data:_.crew.history,children:[e.jsx(ns,{strokeDasharray:"3 3",opacity:.3}),e.jsx(os,{dataKey:"dayName",tick:{fontSize:12}}),e.jsx(ls,{tick:{fontSize:12}}),e.jsx(Ve,{formatter:N=>[N,"Workers"],labelFormatter:N=>`Day: ${N}`}),e.jsx(ta,{dataKey:"count",fill:R.primary,radius:[4,4,0,0]})]})})]}),e.jsxs("div",{className:"chart-card",children:[e.jsx("h3",{children:"T&M Tickets by Day"}),e.jsx(Be,{width:"100%",height:200,children:e.jsxs(ra,{data:H,children:[e.jsx(ns,{strokeDasharray:"3 3",opacity:.3}),e.jsx(os,{dataKey:"dayName",tick:{fontSize:12}}),e.jsx(ls,{tick:{fontSize:12}}),e.jsx(Ve,{formatter:N=>[N,"Tickets"]}),e.jsx(ia,{type:"monotone",dataKey:"tickets",stroke:R.success,strokeWidth:2,dot:{fill:R.success,strokeWidth:2}})]})})]}),e.jsxs("div",{className:"chart-card activity-card",children:[e.jsx("h3",{children:"Activity Summary"}),e.jsxs("div",{className:"activity-list",children:[e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${R.success}20`,color:R.success},children:e.jsx(ve,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"Days with Crew"}),e.jsxs("span",{className:"activity-value",children:[_.crew.daysWithCrew," of ",u==="week"?7:30]})]})]}),e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${R.primary}20`,color:R.primary},children:e.jsx(Na,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"Reports Submitted"}),e.jsx("span",{className:"activity-value",children:_.reports.submitted})]})]}),e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${R.warning}20`,color:R.warning},children:e.jsx(Ne,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"Report Streak"}),e.jsxs("span",{className:"activity-value",children:[_.reports.streak," days"]})]})]}),_.tickets.totalValue>0&&e.jsxs("div",{className:"activity-item",children:[e.jsx("div",{className:"activity-icon",style:{backgroundColor:`${R.purple}20`,color:R.purple},children:e.jsx(ka,{size:20})}),e.jsxs("div",{className:"activity-info",children:[e.jsx("span",{className:"activity-label",children:"T&M Value"}),e.jsxs("span",{className:"activity-value",children:["$",_.tickets.totalValue.toLocaleString()]})]})]})]})]})]}),e.jsx("style",{children:`
        .foreman-metrics {
          padding: 1rem;
          max-width: 100%;
          overflow-x: hidden;
        }

        .foreman-metrics.loading {
          min-height: 400px;
        }

        .loading-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 3rem;
          color: var(--text-secondary);
        }

        .metrics-header {
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-bottom: 1.5rem;
          flex-wrap: wrap;
        }

        .metrics-header h2 {
          flex: 1;
          margin: 0;
          font-size: 1.25rem;
          color: var(--text-primary);
        }

        .back-btn {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 1rem;
          background: var(--bg-elevated);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          color: var(--text-primary);
          cursor: pointer;
          font-size: 0.875rem;
        }

        .back-btn:hover {
          background: var(--bg-tertiary);
        }

        .time-toggle {
          display: flex;
          background: var(--bg-elevated);
          border-radius: 8px;
          padding: 4px;
          gap: 4px;
        }

        .time-toggle button {
          padding: 0.5rem 1rem;
          border: none;
          background: transparent;
          border-radius: 6px;
          color: var(--text-secondary);
          cursor: pointer;
          font-size: 0.875rem;
          transition: all 0.2s;
        }

        .time-toggle button.active {
          background: var(--primary-color, #3b82f6);
          color: white;
        }

        .summary-cards {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
          margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
          .summary-cards {
            grid-template-columns: repeat(4, 1fr);
          }
        }

        .summary-card {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 1rem;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .card-icon {
          width: 40px;
          height: 40px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .progress-card .card-icon {
          background: #dbeafe;
          color: #3b82f6;
        }

        .crew-card .card-icon {
          background: #dcfce7;
          color: #22c55e;
        }

        .tickets-card .card-icon {
          background: #fef3c7;
          color: #f59e0b;
        }

        .disposal-card .card-icon {
          background: #f3e8ff;
          color: #8b5cf6;
        }

        [data-theme="dark"] .progress-card .card-icon {
          background: #1e3a5f;
        }

        [data-theme="dark"] .crew-card .card-icon {
          background: #14532d;
        }

        [data-theme="dark"] .tickets-card .card-icon {
          background: #451a03;
        }

        [data-theme="dark"] .disposal-card .card-icon {
          background: #3b0764;
        }

        .card-content {
          display: flex;
          flex-direction: column;
        }

        .card-value {
          font-size: 1.5rem;
          font-weight: 700;
          color: var(--text-primary);
          line-height: 1.2;
        }

        .card-label {
          font-size: 0.75rem;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .card-detail {
          font-size: 0.75rem;
          color: var(--text-secondary);
          margin-top: auto;
        }

        .charts-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        @media (min-width: 640px) {
          .charts-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }

        .chart-card {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 1rem;
        }

        .chart-card h3 {
          margin: 0 0 1rem 0;
          font-size: 0.875rem;
          font-weight: 600;
          color: var(--text-primary);
        }

        .no-data {
          height: 200px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--text-secondary);
          font-size: 0.875rem;
        }

        .activity-card {
          grid-column: 1 / -1;
        }

        @media (min-width: 640px) {
          .activity-card {
            grid-column: auto;
          }
        }

        .activity-list {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
        }

        .activity-item {
          display: flex;
          align-items: center;
          gap: 0.75rem;
        }

        .activity-icon {
          width: 40px;
          height: 40px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }

        .activity-info {
          display: flex;
          flex-direction: column;
          flex: 1;
        }

        .activity-label {
          font-size: 0.75rem;
          color: var(--text-secondary);
        }

        .activity-value {
          font-size: 1rem;
          font-weight: 600;
          color: var(--text-primary);
        }

        /* Recharts customization */
        .recharts-cartesian-grid-horizontal line,
        .recharts-cartesian-grid-vertical line {
          stroke: var(--border-color);
        }

        .recharts-text {
          fill: var(--text-secondary);
        }

        .recharts-tooltip-wrapper {
          outline: none;
        }

        .recharts-default-tooltip {
          background: var(--bg-card) !important;
          border: 1px solid var(--border-color) !important;
          border-radius: 8px !important;
        }

        .recharts-tooltip-label {
          color: var(--text-primary) !important;
        }

        .recharts-tooltip-item {
          color: var(--text-secondary) !important;
        }
      `})]})}const Qe={crew:{id:"crew",label:"Crew Check-in",icon:ys,description:"Log who's on site today"},tm:{id:"tm",label:"T&M Ticket",icon:Ee,description:"Create time & materials ticket"},report:{id:"report",label:"Daily Report",icon:Ea,description:"Submit end-of-day report"},progress:{id:"progress",label:"Update Progress",icon:Ns,description:"Mark tasks complete"},disposal:{id:"disposal",label:"Disposal Loads",icon:Fe,description:"Log haul-off loads"},docs:{id:"docs",label:"Documents",icon:Sa,description:"View project files"},metrics:{id:"metrics",label:"Project Metrics",icon:Ca,description:"View charts & trends"},punchlist:{id:"punchlist",label:"Punch List",icon:wa,description:"View & resolve punch items"},injury:{id:"injury",label:"Report Injury",icon:bs,description:"Log safety incident",isDanger:!0}},gs=["crew","tm","report","progress"],xs=a=>`fm_pinned_${a}`;function Za({project:a,todayStatus:o,progress:f,areasWorking:C,areasDone:T,areasRemaining:u,punchListOpenCount:h,onNavigate:g,onShowToast:E}){const[v,W]=l.useState(()=>{try{const b=localStorage.getItem(xs(a?.id));return b?JSON.parse(b):gs}catch{return gs}}),[y,_]=l.useState(!1),[U,R]=l.useState(!0);l.useEffect(()=>{if(a?.id)try{localStorage.setItem(xs(a.id),JSON.stringify(v))}catch{}},[v,a?.id]);const X=l.useCallback(b=>{W(D=>D.includes(b)?D.length<=1?(E?.("Keep at least one pinned action","info"),D):D.filter(M=>M!==b):D.length>=5?(E?.("Maximum 5 pinned actions","info"),D):[...D,b])},[E]),P=l.useMemo(()=>Object.keys(Qe).filter(b=>!v.includes(b)),[v]),H=l.useCallback(b=>{switch(b){case"crew":return{done:o.crewCheckedIn,badge:o.crewCheckedIn?`${o.crewCount} on site`:null,status:o.crewCheckedIn?"Done today":"Not started"};case"tm":return{done:!1,badge:o.tmTicketsToday>0?`${o.tmTicketsToday} today`:null,status:o.tmTicketsToday>0?`${o.tmTicketsToday} created`:"Create new"};case"report":return{done:o.dailyReportDone,badge:null,status:o.dailyReportDone?"Submitted":"Not submitted"};case"progress":return{done:u===0,badge:u>0?`${u} left`:null,status:`${f}% complete`};case"disposal":return{done:!1,badge:o.disposalLoadsToday>0?`${o.disposalLoadsToday} today`:null,status:o.disposalLoadsToday>0?`${o.disposalLoadsToday} logged`:"Log loads"};case"punchlist":return{done:h===0&&h!==void 0,badge:h>0?`${h} open`:null,status:h>0?`${h} items open`:"All clear"};default:return{done:!1,badge:null,status:null}}},[o,f,u]),N=b=>{const D=Qe[b];if(!D)return null;const M=D.icon,$=H(b);return e.jsxs("div",{className:"fm-pinned-card-wrapper",children:[e.jsxs("button",{className:`fm-pinned-card ${$.done?"completed":""} ${D.isDanger?"danger":""}`,onClick:()=>!y&&g(b),disabled:y,children:[e.jsx("div",{className:"fm-pinned-icon",children:e.jsx(M,{size:28})}),e.jsx("span",{className:"fm-pinned-label",children:D.label}),$.badge&&!y&&e.jsx("span",{className:"fm-pinned-badge",children:$.badge}),$.done&&!y&&e.jsx("div",{className:"fm-pinned-check",children:e.jsx(ve,{size:18})})]}),y&&e.jsx("button",{className:"fm-pin-toggle pinned",onClick:()=>X(b),"aria-label":`Unpin ${D.label}`,children:e.jsx(_a,{size:16})})]},b)},L=b=>{const D=Qe[b];if(!D)return null;const M=D.icon,$=H(b);return e.jsxs("div",{className:"fm-action-row-wrapper",children:[e.jsxs("button",{className:`fm-action-row ${D.isDanger?"danger":""}`,onClick:()=>!y&&g(b),disabled:y,children:[e.jsx(M,{size:20}),e.jsx("span",{className:"fm-action-label",children:D.label}),$.badge&&!y&&e.jsx("span",{className:"fm-action-badge",children:$.badge})]}),y&&e.jsx("button",{className:"fm-pin-toggle",onClick:()=>X(b),"aria-label":`Pin ${D.label}`,children:e.jsx(Aa,{size:16})})]},b)};return e.jsxs("div",{className:"fm-landing",children:[e.jsxs("button",{className:"fm-metrics-snapshot",onClick:()=>g("metrics"),"aria-label":"View full project metrics",children:[e.jsxs("div",{className:"fm-snapshot-header",children:[e.jsx(js,{size:18}),e.jsx("span",{children:"Project Overview"}),e.jsx(Me,{size:16,className:"fm-snapshot-arrow"})]}),e.jsxs("div",{className:"fm-snapshot-stats",children:[e.jsxs("div",{className:"fm-snapshot-stat main",children:[e.jsxs("span",{className:"fm-snapshot-value",children:[f,"%"]}),e.jsx("span",{className:"fm-snapshot-label",children:"Complete"})]}),e.jsx("div",{className:"fm-snapshot-divider"}),e.jsxs("div",{className:"fm-snapshot-stat",children:[e.jsx("span",{className:"fm-snapshot-value",children:C}),e.jsx("span",{className:"fm-snapshot-label",children:"In Progress"})]}),e.jsxs("div",{className:"fm-snapshot-stat",children:[e.jsx("span",{className:"fm-snapshot-value",children:T}),e.jsx("span",{className:"fm-snapshot-label",children:"Done"})]}),e.jsxs("div",{className:"fm-snapshot-stat",children:[e.jsx("span",{className:"fm-snapshot-value",children:u}),e.jsx("span",{className:"fm-snapshot-label",children:"Remaining"})]})]}),o.crewCheckedIn&&e.jsxs("div",{className:"fm-snapshot-today",children:[e.jsx(Ne,{size:14}),e.jsxs("span",{children:[o.crewCount," crew on site today"]})]})]}),e.jsxs("div",{className:"fm-section-header",children:[e.jsx("h2",{children:"Quick Actions"}),e.jsx("button",{className:`fm-edit-btn ${y?"active":""}`,onClick:()=>_(!y),"aria-label":y?"Done editing":"Customize actions",children:y?"Done":e.jsx(La,{size:18})})]}),y&&e.jsx("p",{className:"fm-edit-hint",children:"Tap icons to pin/unpin actions"}),e.jsx("div",{className:"fm-pinned-grid",children:v.map(N)}),P.length>0&&e.jsxs("div",{className:"fm-more-section",children:[e.jsxs("button",{className:"fm-more-header",onClick:()=>R(!U),"aria-expanded":!U,children:[e.jsx("span",{children:"More Actions"}),U?e.jsx(Me,{size:20}):e.jsx(vs,{size:20})]}),!U&&e.jsx("div",{className:"fm-more-content",children:P.map(L)})]}),e.jsx("style",{children:`
        .fm-landing {
          padding: 0 1rem 2rem;
        }

        /* Metrics Snapshot - Premium Hero Card */
        .fm-metrics-snapshot {
          width: 100%;
          background: var(--gradient-blue, linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8));
          border: none;
          border-radius: 16px;
          padding: 1.25rem;
          color: white;
          text-align: left;
          cursor: pointer;
          margin-bottom: 1.5rem;
          transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s ease;
          box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25), 0 2px 8px rgba(0,0,0,0.15);
          position: relative;
          overflow: hidden;
        }

        .fm-metrics-snapshot::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 50%;
          background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
          pointer-events: none;
          border-radius: 16px 16px 0 0;
        }

        .fm-metrics-snapshot::after {
          content: '';
          position: absolute;
          bottom: -40px;
          right: -40px;
          width: 160px;
          height: 160px;
          background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
          pointer-events: none;
        }

        .fm-metrics-snapshot:active {
          transform: scale(0.98);
        }

        .fm-snapshot-header {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.875rem;
          opacity: 0.9;
          margin-bottom: 0.875rem;
          font-weight: 500;
          position: relative;
          z-index: 1;
        }

        .fm-snapshot-arrow {
          margin-left: auto;
          opacity: 0.7;
        }

        .fm-snapshot-stats {
          display: flex;
          align-items: center;
          gap: 0.875rem;
          position: relative;
          z-index: 1;
        }

        .fm-snapshot-stat {
          display: flex;
          flex-direction: column;
          align-items: center;
          flex: 1;
        }

        .fm-snapshot-stat.main {
          flex: 1.5;
          align-items: flex-start;
        }

        .fm-snapshot-value {
          font-size: 1.625rem;
          font-weight: 700;
          line-height: 1.2;
          font-variant-numeric: tabular-nums;
          letter-spacing: -0.02em;
        }

        .fm-snapshot-stat.main .fm-snapshot-value {
          font-size: 2.25rem;
        }

        .fm-snapshot-label {
          font-size: 0.68rem;
          opacity: 0.85;
          text-transform: uppercase;
          letter-spacing: 0.06em;
          font-weight: 600;
          margin-top: 0.1rem;
        }

        .fm-snapshot-divider {
          width: 1px;
          height: 44px;
          background: rgba(255,255,255,0.25);
        }

        .fm-snapshot-today {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-top: 0.875rem;
          padding-top: 0.875rem;
          border-top: 1px solid rgba(255,255,255,0.15);
          font-size: 0.8rem;
          opacity: 0.9;
          font-weight: 500;
          position: relative;
          z-index: 1;
        }

        /* Section Header */
        .fm-section-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 0.875rem;
        }

        .fm-section-header h2 {
          font-size: 1.05rem;
          font-weight: 700;
          color: var(--text-primary);
          margin: 0;
          letter-spacing: -0.01em;
        }

        .fm-edit-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0.5rem;
          background: var(--gradient-card-dark, var(--bg-elevated));
          border: 1px solid var(--border-color);
          border-radius: 10px;
          color: var(--text-secondary);
          cursor: pointer;
          font-size: 0.8rem;
          min-width: 36px;
          min-height: 36px;
          transition: all 0.2s ease;
          box-shadow: var(--shadow-sm, 0 1px 2px rgba(0,0,0,0.1));
        }

        .fm-edit-btn:hover {
          border-color: var(--accent-blue, #3b82f6);
        }

        .fm-edit-btn.active {
          background: var(--gradient-blue, var(--primary-color, #3b82f6));
          border-color: transparent;
          color: white;
          padding: 0.5rem 1rem;
          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .fm-edit-hint {
          font-size: 0.8rem;
          color: var(--text-secondary);
          margin: 0 0 0.75rem;
          text-align: center;
          font-weight: 500;
        }

        /* Pinned Actions Grid */
        .fm-pinned-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 0.875rem;
          margin-bottom: 1.5rem;
        }

        .fm-pinned-card-wrapper {
          position: relative;
        }

        .fm-pinned-card {
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 1.375rem 1rem;
          background: var(--gradient-card-dark, var(--bg-card));
          border: 1px solid var(--border-color);
          border-radius: 14px;
          cursor: pointer;
          transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
          min-height: 114px;
          position: relative;
          box-shadow: var(--shadow-card, 0 1px 3px rgba(0,0,0,0.1));
          overflow: hidden;
        }

        .fm-pinned-card::before {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 2px;
          background: var(--gradient-blue, linear-gradient(90deg, #3b82f6, #2563eb));
          opacity: 0;
          transition: opacity 0.2s ease;
        }

        .fm-pinned-card:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: var(--shadow-card-hover, 0 8px 25px rgba(0,0,0,0.15));
          border-color: rgba(59, 130, 246, 0.3);
        }

        .fm-pinned-card:hover:not(:disabled)::before {
          opacity: 1;
        }

        .fm-pinned-card:active:not(:disabled) {
          transform: scale(0.97);
        }

        .fm-pinned-card:disabled {
          opacity: 0.7;
          cursor: default;
        }

        .fm-pinned-card.completed {
          border-color: rgba(34, 197, 94, 0.4);
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.03) 100%);
        }

        .fm-pinned-card.completed::before {
          background: linear-gradient(90deg, #22c55e, #16a34a);
          opacity: 1;
        }

        .fm-pinned-card.danger {
          border-color: rgba(245, 158, 11, 0.4);
        }

        .fm-pinned-card.danger::before {
          background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .fm-pinned-card.danger .fm-pinned-icon {
          color: #f59e0b;
        }

        .fm-pinned-icon {
          color: var(--primary-color, #3b82f6);
          margin-bottom: 0.625rem;
          transition: transform 0.2s ease;
        }

        .fm-pinned-card:hover:not(:disabled) .fm-pinned-icon {
          transform: scale(1.08);
        }

        .fm-pinned-label {
          font-size: 0.875rem;
          font-weight: 600;
          color: var(--text-primary);
          text-align: center;
          letter-spacing: -0.01em;
        }

        .fm-pinned-badge {
          position: absolute;
          top: 8px;
          right: 8px;
          background: var(--gradient-blue, var(--primary-color, #3b82f6));
          color: white;
          font-size: 0.68rem;
          font-weight: 700;
          padding: 0.2rem 0.55rem;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
        }

        .fm-pinned-check {
          position: absolute;
          top: 8px;
          right: 8px;
          color: #22c55e;
          filter: drop-shadow(0 1px 3px rgba(34, 197, 94, 0.3));
        }

        .fm-pin-toggle {
          position: absolute;
          top: -8px;
          right: -8px;
          width: 28px;
          height: 28px;
          border-radius: 50%;
          background: var(--bg-card);
          border: 2px solid var(--border-color);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: var(--text-secondary);
          transition: all 0.2s ease;
          z-index: 10;
          box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .fm-pin-toggle:hover {
          background: var(--bg-elevated);
          transform: scale(1.1);
        }

        .fm-pin-toggle.pinned {
          background: #ef4444;
          border-color: #ef4444;
          color: white;
          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* More Actions Section */
        .fm-more-section {
          background: var(--gradient-card-dark, var(--bg-card));
          border: 1px solid var(--border-color);
          border-radius: 14px;
          overflow: hidden;
          box-shadow: var(--shadow-card, 0 1px 3px rgba(0,0,0,0.1));
        }

        .fm-more-header {
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1rem 1.125rem;
          background: transparent;
          border: none;
          cursor: pointer;
          font-size: 0.9rem;
          font-weight: 600;
          color: var(--text-primary);
          transition: background 0.15s ease;
        }

        .fm-more-header:hover {
          background: var(--bg-secondary, rgba(255,255,255,0.02));
        }

        .fm-more-header:active {
          background: var(--bg-elevated);
        }

        .fm-more-content {
          border-top: 1px solid var(--border-color);
        }

        .fm-action-row-wrapper {
          position: relative;
          display: flex;
          align-items: center;
        }

        .fm-action-row-wrapper .fm-pin-toggle {
          position: static;
          margin-right: 0.75rem;
          flex-shrink: 0;
        }

        .fm-action-row {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 0.875rem;
          padding: 1.125rem;
          background: transparent;
          border: none;
          border-bottom: 1px solid var(--border-color);
          cursor: pointer;
          text-align: left;
          color: var(--text-primary);
          transition: all 0.2s ease;
        }

        .fm-action-row:last-child {
          border-bottom: none;
        }

        .fm-action-row:hover:not(:disabled) {
          background: var(--bg-secondary, rgba(255,255,255,0.02));
          padding-left: 1.25rem;
        }

        .fm-action-row:active:not(:disabled) {
          background: var(--bg-elevated);
        }

        .fm-action-row:disabled {
          opacity: 0.7;
          cursor: default;
        }

        .fm-action-row.danger {
          color: #f59e0b;
        }

        .fm-action-row svg {
          transition: color 0.15s ease;
        }

        .fm-action-row:hover:not(:disabled) svg {
          color: var(--accent-blue, #3b82f6);
        }

        .fm-action-row.danger:hover:not(:disabled) svg {
          color: #f59e0b;
        }

        .fm-action-label {
          flex: 1;
          font-size: 0.9rem;
          font-weight: 500;
        }

        .fm-action-badge {
          font-size: 0.72rem;
          color: var(--text-secondary);
          background: var(--bg-elevated);
          padding: 0.25rem 0.625rem;
          border-radius: 20px;
          font-weight: 600;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .fm-metrics-snapshot {
          background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 60%, #172554 100%);
          box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3), 0 2px 8px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .fm-pinned-card.completed {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.12) 0%, rgba(34, 197, 94, 0.04) 100%);
        }
      `})]})}function dt({project:a,companyId:o,foremanName:f,onShowToast:C,onExit:T}){const[u,h]=l.useState([]),[g,E]=l.useState(!0),[v,W]=l.useState(null),[y,_]=l.useState({}),[U,R]=l.useState("home"),[X,P]=l.useState(!1),[H,N]=l.useState(0),[L,b]=l.useState({crewCheckedIn:!1,crewCount:0,tmTicketsToday:0,dailyReportDone:!1,disposalLoadsToday:0}),[D,M]=l.useState(()=>typeof window<"u"?document.documentElement.getAttribute("data-theme")==="dark":!1);new Date().getHours(),l.useEffect(()=>{a?.id&&(ee(),$(),te())},[a?.id]);const $=async()=>{try{const t=new Date().toISOString().split("T")[0],J=(await w.getCrewCheckin(a.id,t))?.workers||[],ie=J.length>0,V=(await w.getTMTickets?.(a.id)||[]).filter(le=>le.work_date===t),Y=await w.getDisposalLoads?.(a.id,t)||[];b({crewCheckedIn:ie,crewCount:J.length,tmTicketsToday:V.length,dailyReportDone:!1,disposalLoadsToday:Y.reduce((le,re)=>le+(re.load_count||1),0)})}catch(t){console.error("Error loading today status:",t)}},te=async()=>{if(!(!a?.id||!fs))try{const{count:t}=await Xs().from("punch_list_items").select("*",{count:"exact",head:!0}).eq("project_id",a.id).eq("status","open");N(t||0)}catch{}},se=l.useRef(null),K=l.useCallback(()=>{se.current&&clearTimeout(se.current),se.current=setTimeout(()=>{ee(),$()},300)},[a?.id]);l.useEffect(()=>{if(!a?.id)return;const t=[],Q=w.subscribeToAreas?.(a.id,K);Q&&t.push(Q);const J=w.subscribeToCrewCheckins?.(a.id,K);J&&t.push(J);const ie=w.subscribeToTMTickets?.(a.id,K);ie&&t.push(ie);const S=w.subscribeToHaulOffs?.(a.id,K);S&&t.push(S);const V=w.subscribeToDailyReports?.(a.id,K);V&&t.push(V);const Y=w.subscribeToCORs?.(a.id,K);Y&&t.push(Y);const le=w.subscribeToMaterialRequests?.(a.id,K);le&&t.push(le);const re=w.subscribeToProject?.(a.id,K);re&&t.push(re);const ne=w.subscribeToPunchList?.(a.id,()=>{te(),K()});if(ne&&t.push(ne),o){const he=w.subscribeToMaterialsEquipment?.(o,K);he&&t.push(he);const je=w.subscribeToLaborRates?.(o,K);je&&t.push(je)}return()=>{se.current&&clearTimeout(se.current),t.forEach(he=>w.unsubscribe?.(he))}},[a?.id,K]);const ee=async()=>{try{const t=await w.getAreas(a.id);h(t);const Q=[...new Set(t.map(ie=>ie.group_name||"General"))],J={};Q.forEach(ie=>J[ie]=!1),_(J)}catch(t){console.error("Error loading areas:",t),C?.("Error loading areas","error")}finally{E(!1)}},x=async(t,Q)=>{const J=u.find(S=>S.id===t);if(!J)return;const ie=J.status===Q?"not_started":Q;W(t);try{await w.updateAreaStatus(t,ie),h(S=>S.map(V=>V.id===t?{...V,status:ie}:V))}catch(S){console.error("Error updating status:",S),C?.("Error updating","error")}finally{W(null)}},O=t=>{_(Q=>({...Q,[t]:!Q[t]}))},oe=()=>{const t=D?"light":"dark";document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t),M(!D)},p=na(u),j=u.filter(t=>t.status==="done").length,z=u.filter(t=>t.status==="working").length,q=u.length-j,n=u.reduce((t,Q)=>{const J=Q.group_name||"General";return t[J]||(t[J]=[]),t[J].push(Q),t},{}),A=Object.keys(n).length>1||Object.keys(n).length===1&&!n.General,G=t=>`${t.filter(J=>J.status==="done").length}/${t.length}`,m=l.useCallback(t=>{R(t)},[]);return U==="tm"?e.jsx("div",{className:"fm-view",children:e.jsx(Ga,{project:a,companyId:o,onSubmit:()=>R("home"),onCancel:()=>R("home"),onShowToast:C})}):U==="report"?e.jsx(Qa,{project:a,onShowToast:C,onClose:()=>R("home")}):U==="injury"?e.jsx("div",{className:"fm-view",children:e.jsx(oa,{project:a,companyId:o,onClose:()=>R("home"),onReportCreated:()=>{R("home"),C?.("Injury report submitted","success")}})}):U==="crew"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>R("home"),children:e.jsx(be,{size:20})}),e.jsx("h2",{children:"Crew Check-in"})]}),e.jsx(Ya,{project:a,companyId:o,onShowToast:C})]}):U==="disposal"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>R("home"),children:e.jsx(be,{size:20})}),e.jsx("h2",{children:"Disposal Loads"})]}),e.jsx(Ja,{project:a,date:new Date().toISOString().split("T")[0],onShowToast:C})]}):U==="docs"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>R("home"),children:e.jsx(be,{size:20})}),e.jsx("h2",{children:"Documents"})]}),e.jsx(Ha,{projectId:a.id,onShowToast:C})]}):U==="metrics"?e.jsx(Xa,{project:a,companyId:o,onBack:()=>R("home")}):U==="punchlist"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>{R("home"),te()},children:e.jsx(be,{size:20})}),e.jsx("h2",{children:"Punch List"})]}),e.jsx(Oa,{projectId:a.id,areas:u,companyId:o,onShowToast:C})]}):U==="progress"?e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-subheader",children:[e.jsx("button",{className:"fm-back",onClick:()=>R("home"),children:e.jsx(be,{size:20})}),e.jsx("h2",{children:"Progress"}),e.jsxs("span",{className:"fm-subheader-badge",children:[p,"%"]})]}),e.jsx("div",{className:"fm-progress-content",children:g?e.jsxs("div",{className:"fm-loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("span",{children:"Loading..."})]}):u.length===0?e.jsxs("div",{className:"fm-empty",children:[e.jsx(Ns,{size:48}),e.jsx("h3",{children:"No tasks yet"}),e.jsx("p",{children:"Office will add tasks to this project"})]}):A?Object.entries(n).map(([t,Q])=>e.jsxs("div",{className:"fm-group",children:[e.jsxs("button",{className:"fm-group-header",onClick:()=>O(t),children:[e.jsxs("div",{className:"fm-group-left",children:[y[t]?e.jsx(Me,{size:18}):e.jsx(Ra,{size:18}),e.jsx("span",{children:t})]}),e.jsx("span",{className:"fm-group-count",children:G(Q)})]}),y[t]&&e.jsx("div",{className:"fm-group-items",children:Q.map(J=>e.jsxs("div",{className:`fm-task ${J.status}`,children:[e.jsx("span",{className:"fm-task-name",children:J.name}),e.jsxs("div",{className:"fm-task-btns",children:[e.jsx("button",{className:`fm-status-btn working ${J.status==="working"?"active":""}`,onClick:()=>x(J.id,"working"),disabled:v===J.id,children:e.jsx(Ne,{size:14})}),e.jsx("button",{className:`fm-status-btn done ${J.status==="done"?"active":""}`,onClick:()=>x(J.id,"done"),disabled:v===J.id,children:e.jsx(ve,{size:14})})]})]},J.id))})]},t)):e.jsx("div",{className:"fm-task-list",children:u.map(t=>e.jsxs("div",{className:`fm-task ${t.status}`,children:[e.jsx("span",{className:"fm-task-name",children:t.name}),e.jsxs("div",{className:"fm-task-btns",children:[e.jsx("button",{className:`fm-status-btn working ${t.status==="working"?"active":""}`,onClick:()=>x(t.id,"working"),disabled:v===t.id,children:e.jsx(Ne,{size:14})}),e.jsx("button",{className:`fm-status-btn done ${t.status==="done"?"active":""}`,onClick:()=>x(t.id,"done"),disabled:v===t.id,children:e.jsx(ve,{size:14})})]})]},t.id))})})]}):e.jsxs("div",{className:"fm-view",children:[e.jsxs("div",{className:"fm-header",children:[e.jsx("button",{className:"fm-exit",onClick:T,children:e.jsx(be,{size:20})}),e.jsxs("div",{className:"fm-header-center",children:[e.jsx("h1",{className:"fm-project-name",children:a.name}),f&&e.jsx("span",{className:"fm-foreman-name",children:f}),e.jsx("button",{className:"fm-info-toggle",onClick:()=>P(!X),children:e.jsx(Da,{size:16})})]}),e.jsx("button",{className:"fm-theme",onClick:oe,children:D?e.jsx(za,{size:20}):e.jsx(Ta,{size:20})})]}),X&&e.jsxs("div",{className:"fm-project-info",children:[a.job_number&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"Job #"}),e.jsx("span",{children:a.job_number})]}),a.address&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"Address"}),e.jsx("span",{children:a.address})]}),a.general_contractor&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"GC"}),e.jsx("span",{children:a.general_contractor})]}),a.client_phone&&e.jsxs("div",{className:"fm-info-item",children:[e.jsx("span",{children:"Phone"}),e.jsx("a",{href:`tel:${a.client_phone}`,children:a.client_phone})]})]}),e.jsx(Za,{project:a,todayStatus:L,progress:p,areasWorking:z,areasDone:j,areasRemaining:q,punchListOpenCount:H,onNavigate:m,onShowToast:C})]})}export{dt as default};
