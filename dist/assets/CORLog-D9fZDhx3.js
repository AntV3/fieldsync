const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/safeXlsx-F6PERwMH.js","assets/pdf-Dbgi5wV4.js"])))=>i.map(i=>d[i]);
import{_ as U}from"./pdf-Dbgi5wV4.js";import{as as e,ar as A}from"./index-Da6Ug3b9.js";import{r as l,aU as se,ai as ae,C as te,aV as le,v as ne,L as G,b as oe,X as H,P as ce,O as M,aj as re,F as ie,h as de,e as Y,n as B,ag as K}from"./icons-BDU0tZd_.js";import{f as O}from"./corCalculations-vdJc_BOT.js";function me(s={}){const{itemsPerPage:j=50,initialPage:m=1,totalItems:i=0}=s,[t,N]=l.useState({page:m,totalItems:i,itemsPerPage:j}),b=l.useMemo(()=>Math.ceil(t.totalItems/t.itemsPerPage)||1,[t.totalItems,t.itemsPerPage]),r=l.useMemo(()=>t.page<b,[t.page,b]),v=l.useMemo(()=>t.page>1,[t.page]),g=l.useMemo(()=>(t.page-1)*t.itemsPerPage,[t.page,t.itemsPerPage]),T=l.useMemo(()=>{const u=g,D=g+t.itemsPerPage-1;return{start:u,end:D}},[g,t.itemsPerPage]),P=l.useCallback(u=>{N(D=>({...D,page:Math.max(1,Math.min(u,b||u))}))},[b]),R=l.useCallback(()=>{r&&N(u=>({...u,page:u.page+1}))},[r]),_=l.useCallback(()=>{v&&N(u=>({...u,page:u.page-1}))},[v]),L=l.useCallback(()=>{N(u=>({...u,page:1}))},[]),k=l.useCallback(()=>{N(u=>({...u,page:b}))},[b]),c=l.useCallback(u=>{N(D=>({...D,totalItems:u}))},[]),f=l.useCallback(u=>{N(D=>({...D,itemsPerPage:u,page:1}))},[]),F=l.useCallback(()=>{N({page:m,totalItems:0,itemsPerPage:j})},[m,j]),I=l.useCallback(u=>Array.isArray(u)?u.slice(g,g+t.itemsPerPage):[],[g,t.itemsPerPage]),y=l.useCallback(()=>({from:g,to:g+t.itemsPerPage-1}),[g,t.itemsPerPage]);return{page:t.page,totalItems:t.totalItems,itemsPerPage:t.itemsPerPage,totalPages:b,offset:g,range:T,hasNextPage:r,hasPrevPage:v,isFirstPage:t.page===1,isLastPage:t.page===b,goToPage:P,nextPage:R,prevPage:_,firstPage:L,lastPage:k,setTotalItems:c,setItemsPerPage:f,reset:F,paginate:I,getSupabaseRange:y}}function ge(s=[],j={}){const{pageSize:m=25,searchFields:i=[]}=j,[t,N]=l.useState(""),b=l.useMemo(()=>{if(!t.trim()||i.length===0)return s;const P=t.toLowerCase();return s.filter(R=>i.some(_=>{const L=R?.[_];return L==null?!1:String(L).toLowerCase().includes(P)}))},[s,t,i]),r=me({itemsPerPage:m,totalItems:b.length});l.useMemo(()=>{r.setTotalItems(b.length)},[b.length]);const v=l.useMemo(()=>r.paginate(b),[b,r.paginate]),g=l.useCallback(P=>{N(P),r.goToPage(1)},[r.goToPage]),T=l.useCallback(P=>{r.setItemsPerPage(P)},[r.setItemsPerPage]);return{paginatedItems:v,searchTerm:t,setSearchTerm:g,currentPage:r.page,totalPages:r.totalPages,goToPage:r.goToPage,nextPage:r.nextPage,prevPage:r.prevPage,pageSize:r.itemsPerPage,setPageSize:T,totalItems:b.length}}function ue({currentPage:s,totalPages:j,onPageChange:m,pageSize:i,onPageSizeChange:t,totalItems:N,pageSizeOptions:b=[10,25,50,100]}){const r=N===0?0:(s-1)*i+1,v=Math.min(s*i,N);return e.jsxs("div",{className:"pagination",children:[e.jsxs("div",{className:"pagination-info",children:["Showing ",r,"â€“",v," of ",N," items"]}),e.jsxs("div",{className:"pagination-controls",children:[t&&e.jsx("select",{className:"pagination-size-select",value:i,onChange:g=>t(Number(g.target.value)),children:b.map(g=>e.jsxs("option",{value:g,children:[g," / page"]},g))}),e.jsx("button",{className:"pagination-btn",onClick:()=>m(1),disabled:s<=1,title:"First page",children:e.jsx(se,{size:16})}),e.jsx("button",{className:"pagination-btn",onClick:()=>m(s-1),disabled:s<=1,title:"Previous page",children:e.jsx(ae,{size:16})}),e.jsxs("span",{className:"pagination-page-info",children:["Page ",s," of ",j]}),e.jsx("button",{className:"pagination-btn",onClick:()=>m(s+1),disabled:s>=j,title:"Next page",children:e.jsx(te,{size:16})}),e.jsx("button",{className:"pagination-btn",onClick:()=>m(j),disabled:s>=j,title:"Last page",children:e.jsx(le,{size:16})})]})]})}const he=[{value:"draft",label:"Draft"},{value:"pending_approval",label:"Pending Approval"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"billed",label:"Billed"},{value:"closed",label:"Closed"}];function pe({entry:s,isEditing:j,isSaving:m,onEdit:i,onSave:t,onCancel:N,statusDisplay:b}){const[r,v]=l.useState({dateSentToClient:s.dateSentToClient||"",ceNumber:s.ceNumber||"",comments:s.comments||"",status:s.changeOrder?.status||"draft"}),g=l.useRef(null);l.useEffect(()=>{j&&g.current&&g.current.focus()},[j]),l.useEffect(()=>{v({dateSentToClient:s.dateSentToClient||"",ceNumber:s.ceNumber||"",comments:s.comments||"",status:s.changeOrder?.status||"draft"})},[s]);const T=c=>{c.key==="Enter"&&!c.shiftKey?(c.preventDefault(),P()):c.key==="Escape"&&R()},P=()=>{t(r)},R=()=>{v({dateSentToClient:s.dateSentToClient||"",ceNumber:s.ceNumber||"",comments:s.comments||"",status:s.changeOrder?.status||"draft"}),N()},_=b[s.changeOrder.status]||{label:s.changeOrder.status,className:""},L=c=>{if(!c)return"-";try{return new Date(c).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch{return c}},k=c=>{if(!c)return"";try{return new Date(c).toISOString().split("T")[0]}catch{return c}};return j?e.jsxs("tr",{className:"cor-log-row editing",children:[e.jsx("td",{className:"col-log-num",children:s.logNumber}),e.jsx("td",{className:"col-date-sent",children:e.jsx("input",{ref:g,type:"date",value:k(r.dateSentToClient),onChange:c=>v(f=>({...f,dateSentToClient:c.target.value})),onKeyDown:T,disabled:m,className:"cor-log-input"})}),e.jsx("td",{className:"col-ce-num",children:e.jsx("input",{type:"text",value:r.ceNumber,onChange:c=>v(f=>({...f,ceNumber:c.target.value})),onKeyDown:T,disabled:m,placeholder:"CE-XXX",className:"cor-log-input",maxLength:50})}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:s.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:s.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:O(s.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status",children:e.jsxs("div",{className:"cor-log-status-select",children:[e.jsx("select",{value:r.status,onChange:c=>v(f=>({...f,status:c.target.value})),disabled:m,className:"cor-log-select",children:he.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))}),e.jsx(ne,{size:14,className:"select-icon"})]})}),e.jsx("td",{className:"col-comments",children:e.jsx("textarea",{value:r.comments,onChange:c=>v(f=>({...f,comments:c.target.value})),onKeyDown:T,disabled:m,placeholder:"Add comments...",className:"cor-log-textarea",rows:2})}),e.jsx("td",{className:"col-actions",children:m?e.jsx(G,{size:16,className:"spin"}):e.jsxs("div",{className:"cor-log-edit-actions",children:[e.jsx("button",{className:"btn btn-icon btn-success",onClick:P,title:"Save",children:e.jsx(oe,{size:14})}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:R,title:"Cancel",children:e.jsx(H,{size:14})})]})})]}):e.jsxs("tr",{className:"cor-log-row",children:[e.jsx("td",{className:"col-log-num",children:s.logNumber}),e.jsx("td",{className:"col-date-sent editable",onClick:i,children:L(s.dateSentToClient)}),e.jsx("td",{className:"col-ce-num editable",onClick:i,children:s.ceNumber||"-"}),e.jsxs("td",{className:"col-description",children:[e.jsx("span",{className:"cor-log-title",children:s.changeOrder.title||"Untitled"}),e.jsx("span",{className:"cor-log-number",children:s.changeOrder.corNumber})]}),e.jsx("td",{className:"col-amount",children:O(s.changeOrder.corTotal||0)}),e.jsx("td",{className:"col-status editable",onClick:i,children:e.jsx("span",{className:`cor-log-status ${_.className}`,children:_.label})}),e.jsx("td",{className:"col-comments editable",onClick:i,children:s.comments||e.jsx("span",{className:"placeholder",children:"Click to add..."})}),e.jsx("td",{className:"col-actions",children:e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:i,title:"Edit",children:e.jsx(ce,{size:14})})})]})}const W={draft:{label:"Draft",className:"draft"},pending_approval:{label:"Pending",className:"pending"},approved:{label:"Approved",className:"approved"},rejected:{label:"Rejected",className:"rejected"},billed:{label:"Billed",className:"billed"},closed:{label:"Closed",className:"closed"}},V={pending:["draft","pending_approval"],approved:["approved","billed"],void:["rejected","closed"]};function xe({project:s,company:j,onShowToast:m}){const[i,t]=l.useState([]),[N,b]=l.useState(!0),[r,v]=l.useState(null),[g,T]=l.useState(null),[P,R]=l.useState(!1);l.useEffect(()=>{_();const n=A.subscribeToCORLog?.(s.id,()=>{_()});return()=>{n&&A.unsubscribe?.(n)}},[s.id]);const _=async()=>{try{const n=await A.getCORLog(s.id);t(n||[])}catch(n){console.error("Error loading COR log:",n),m?.("Error loading COR log","error")}finally{b(!1),R(!1)}},L=()=>{R(!0),_()},k=async(n,p,a)=>{T(n);try{await A.updateCORLogEntry(n,p),p.status&&await A.updateChangeOrderStatus(a,p.status),t(o=>o.map(C=>C.id===n?{...C,dateSentToClient:p.dateSentToClient,ceNumber:p.ceNumber,comments:p.comments,changeOrder:{...C.changeOrder,status:p.status||C.changeOrder.status}}:C)),v(null),m?.("Log entry updated","success")}catch(o){console.error("Error updating log entry:",o),m?.("Error updating log entry","error")}finally{T(null)}},c=l.useMemo(()=>i.map(n=>({...n,_title:n.changeOrder?.title||"",_cor_number:n.changeOrder?.corNumber||"",_status:n.changeOrder?.status||"",_scope:n.changeOrder?.scopeOfWork||""})),[i]),{paginatedItems:f,searchTerm:F,setSearchTerm:I,currentPage:y,totalPages:u,goToPage:D,pageSize:J,setPageSize:q,totalItems:Q}=ge(c,{pageSize:25,searchFields:["_title","_cor_number","_status","_scope","ceNumber","comments"]}),S=l.useMemo(()=>{const n=f.filter(o=>V.pending.includes(o.changeOrder.status)),p=f.filter(o=>V.approved.includes(o.changeOrder.status)),a=f.filter(o=>V.void.includes(o.changeOrder.status));return{pending:n,approved:p,voided:a}},[f]),h=l.useMemo(()=>{const{pending:n,approved:p,voided:a}=S;return{totalCORs:i.length,approvedCount:p.length,pendingCount:n.length,voidCount:a.length,approvedTotal:p.reduce((o,C)=>o+(C.changeOrder.corTotal||0),0),pendingTotal:n.reduce((o,C)=>o+(C.changeOrder.corTotal||0),0),voidTotal:a.reduce((o,C)=>o+(C.changeOrder.corTotal||0),0),grandTotal:i.reduce((o,C)=>o+(C.changeOrder.corTotal||0),0)}},[i,S]),Z=async()=>{try{const{default:n}=await U(async()=>{const{default:d}=await import("./pdf-Dbgi5wV4.js").then(w=>w.j);return{default:d}},[]),{default:p}=await U(async()=>{const{default:d}=await import("./pdf-Dbgi5wV4.js").then(w=>w.b);return{default:d}},[]),a=new n("landscape"),o=a.internal.pageSize.width;a.setFontSize(18),a.setFont(void 0,"bold"),a.text("CHANGE ORDER LOG",o/2,20,{align:"center"}),a.setFontSize(12),a.setFont(void 0,"normal"),a.text(`Project: ${s.name}`,o/2,28,{align:"center"}),s.job_number&&a.text(`Job #${s.job_number}`,o/2,35,{align:"center"}),a.setFontSize(10),a.text(`Generated: ${new Date().toLocaleDateString()}`,o/2,42,{align:"center"}),j?.name&&(a.setFontSize(11),a.setFont(void 0,"bold"),a.text(j.name,14,20),a.setFont(void 0,"normal"),j.phone&&(a.setFontSize(9),a.text(j.phone,14,25)));const C=i.map(d=>[d.logNumber,d.changeOrder.corNumber||"-",d.dateSentToClient?new Date(d.dateSentToClient).toLocaleDateString():"-",d.ceNumber||"-",d.changeOrder.title||"Untitled",O(d.changeOrder.corTotal||0),W[d.changeOrder.status]?.label||d.changeOrder.status,d.comments||"-"]);p(a,{startY:50,head:[["Log #","COR #","Date Sent","CE #","Description","Amount","Status","Comments"]],body:C,styles:{fontSize:8,cellPadding:3,overflow:"linebreak",valign:"top"},headStyles:{fillColor:[51,51,51],textColor:255,fontStyle:"bold",fontSize:8},columnStyles:{0:{cellWidth:12,halign:"center"},1:{cellWidth:18},2:{cellWidth:22},3:{cellWidth:18},4:{cellWidth:55},5:{cellWidth:22,halign:"right"},6:{cellWidth:18,halign:"center"},7:{cellWidth:"auto",minCellWidth:50}},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:d=>{if(d.column.index===6&&d.section==="body"){const w=d.cell.raw?.toLowerCase();w==="approved"||w==="billed"?d.cell.styles.textColor=[5,150,105]:w==="pending"||w==="pending approval"?d.cell.styles.textColor=[217,119,6]:(w==="rejected"||w==="void")&&(d.cell.styles.textColor=[220,38,38])}}});const z=(a.lastAutoTable?.finalY||100)+10;a.setFontSize(10),a.setFont(void 0,"bold"),a.text("SUMMARY",14,z),a.setFont(void 0,"normal"),a.setFontSize(9);const E=14,$=100;a.text(`Total CORs: ${h.totalCORs}`,E,z+7),a.text(`Approved: ${h.approvedCount} (${O(h.approvedTotal)})`,E,z+14),a.text(`Pending: ${h.pendingCount} (${O(h.pendingTotal)})`,$,z+7),a.text(`Void: ${h.voidCount} (${O(h.voidTotal)})`,$,z+14),a.setFont(void 0,"bold"),a.setFontSize(10),a.text(`Total Value: ${O(h.grandTotal)}`,E,z+24);const x=`COR_Log_${s.job_number||s.name.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`;a.save(x),m?.("PDF exported successfully","success")}catch(n){console.error("Error exporting PDF:",n),m?.("Error exporting PDF","error")}},ee=async()=>{try{const{loadXLSXSafe:n}=await U(async()=>{const{loadXLSXSafe:x}=await import("./safeXlsx-F6PERwMH.js");return{loadXLSXSafe:x}},__vite__mapDeps([0,1])),p=await n(),a=i.map(x=>({"Log #":x.logNumber,"COR Number":x.changeOrder.corNumber,"Date Sent to Client":x.dateSentToClient||"","CE Number":x.ceNumber||"",Description:x.changeOrder.title||"Untitled",Amount:x.changeOrder.corTotal||0,Status:W[x.changeOrder.status]?.label||x.changeOrder.status,"Created Date":x.changeOrder.createdAt?new Date(x.changeOrder.createdAt).toLocaleDateString():"","Approved Date":x.changeOrder.approvedAt?new Date(x.changeOrder.approvedAt).toLocaleDateString():"","Approved By":x.changeOrder.approvedBy||"",Comments:x.comments||""}));a.push({}),a.push({"Log #":"SUMMARY",Description:`Total CORs: ${h.totalCORs}`,Amount:h.grandTotal,Status:`Approved: ${h.approvedCount}, Pending: ${h.pendingCount}`});const o=p.utils.json_to_sheet(a),C=p.utils.book_new();p.utils.book_append_sheet(C,o,"COR Log");const z=5,E=p.utils.decode_range(o["!ref"]);for(let x=E.s.r+1;x<=E.e.r;x++){const d=p.utils.encode_cell({r:x,c:z});o[d]&&typeof o[d].v=="number"&&(o[d].z="$#,##0.00")}o["!cols"]=[{wch:8},{wch:12},{wch:15},{wch:12},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:20},{wch:30}];const $=`COR_Log_${s.job_number||s.name}_${new Date().toISOString().split("T")[0]}.xlsx`;p.writeFile(C,$),m?.("Excel exported successfully","success")}catch(n){console.error("Error exporting Excel:",n),m?.("Error exporting Excel","error")}};if(N)return e.jsxs("div",{className:"cor-log cor-log-loading",children:[e.jsx(G,{size:24,className:"spin"}),e.jsx("span",{children:"Loading COR Log..."})]});const X=(n,p=!0)=>e.jsxs("table",{className:"cor-log-table",children:[p&&e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-log-num",children:"Log #"}),e.jsx("th",{className:"col-date-sent",children:"Date Sent"}),e.jsx("th",{className:"col-ce-num",children:"CE #"}),e.jsx("th",{className:"col-description",children:"Description"}),e.jsx("th",{className:"col-amount",children:"Amount"}),e.jsx("th",{className:"col-status",children:"Status"}),e.jsx("th",{className:"col-comments",children:"Comments"}),e.jsx("th",{className:"col-actions",children:"Actions"})]})}),e.jsx("tbody",{children:n.map(a=>e.jsx(pe,{entry:a,isEditing:r===a.id,isSaving:g===a.id,onEdit:()=>v(a.id),onSave:o=>k(a.id,o,a.changeOrder.id),onCancel:()=>v(null),statusDisplay:W},a.id))})]});return e.jsxs("div",{className:"cor-log cor-log-expanded",children:[e.jsxs("div",{className:"cor-log-header",children:[e.jsxs("div",{className:"cor-log-title",children:[e.jsx(M,{size:20}),e.jsx("h3",{children:"Change Order Log"}),e.jsxs("span",{className:"cor-log-count",children:[i.length," entries"]})]}),e.jsxs("div",{className:"cor-log-actions",children:[e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:L,disabled:P,title:"Refresh",children:e.jsx(re,{size:16,className:P?"spin":""})}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:ee,children:[e.jsx(M,{size:14})," Excel"]}),e.jsxs("button",{className:"btn btn-secondary btn-small",onClick:Z,children:[e.jsx(ie,{size:14})," PDF"]})]})]}),e.jsxs("div",{className:"cor-search",style:{margin:"0 0 12px 0"},children:[e.jsx(de,{size:14,className:"cor-search-icon"}),e.jsx("input",{type:"text",className:"cor-search-input",placeholder:"Search log entries by title, COR #, status, or comments...",value:F,onChange:n=>I(n.target.value)}),F&&e.jsx("button",{className:"cor-search-clear",onClick:()=>I(""),children:e.jsx(H,{size:14})})]}),e.jsxs("div",{className:"cor-log-summary-cards",children:[e.jsxs("div",{className:"summary-card pending",children:[e.jsx(Y,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Pending"}),e.jsxs("span",{className:"summary-card-count",children:[h.pendingCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(h.pendingTotal)})]})]}),e.jsxs("div",{className:"summary-card approved",children:[e.jsx(B,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Approved"}),e.jsxs("span",{className:"summary-card-count",children:[h.approvedCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(h.approvedTotal)})]})]}),e.jsxs("div",{className:"summary-card void",children:[e.jsx(K,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Void"}),e.jsxs("span",{className:"summary-card-count",children:[h.voidCount," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(h.voidTotal)})]})]}),e.jsxs("div",{className:"summary-card total",children:[e.jsx(M,{size:18}),e.jsxs("div",{className:"summary-card-content",children:[e.jsx("span",{className:"summary-card-label",children:"Total"}),e.jsxs("span",{className:"summary-card-count",children:[h.totalCORs," CORs"]}),e.jsx("span",{className:"summary-card-amount",children:O(h.grandTotal)})]})]})]}),i.length===0?e.jsxs("div",{className:"cor-log-empty",children:[e.jsx(M,{size:32}),e.jsx("p",{children:"No change orders in log"}),e.jsx("span",{children:"CORs will appear here as they are created"})]}):e.jsxs("div",{className:"cor-log-sections",children:[S.pending.length>0&&e.jsxs("div",{className:"cor-log-section pending",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(Y,{size:16}),e.jsx("h4",{children:"Pending Change Orders"}),e.jsx("span",{className:"section-count",children:S.pending.length}),e.jsx("span",{className:"section-total",children:O(h.pendingTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:X(S.pending)})]}),S.approved.length>0&&e.jsxs("div",{className:"cor-log-section approved",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(B,{size:16}),e.jsx("h4",{children:"Approved Change Orders"}),e.jsx("span",{className:"section-count",children:S.approved.length}),e.jsx("span",{className:"section-total",children:O(h.approvedTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:X(S.approved)})]}),S.voided.length>0&&e.jsxs("div",{className:"cor-log-section void",children:[e.jsxs("div",{className:"cor-log-section-header",children:[e.jsx(K,{size:16}),e.jsx("h4",{children:"Void Change Orders"}),e.jsx("span",{className:"section-count",children:S.voided.length}),e.jsx("span",{className:"section-total",children:O(h.voidTotal)})]}),e.jsx("div",{className:"cor-log-table-wrapper",children:X(S.voided)})]})]}),u>1&&e.jsx(ue,{currentPage:y,totalPages:u,onPageChange:D,pageSize:J,onPageSizeChange:q,totalItems:Q})]})}const Ce=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"}));export{xe as C,ue as P,Ce as a,ge as u};
//# sourceMappingURL=CORLog-D9fZDhx3.js.map
