import{aX as M,aK as w,ar as T,as as e}from"./index-ChZkBqHL.js";import{r as i,i as f,a7 as R,_ as $,u as q,v as X,aZ as Z,j as z,X as B,ah as F,C as K}from"./icons-CwUiT5nc.js";import"./react-DXGY7bZi.js";import"./pdf-aQqpMATS.js";import"./supabase-VuevzHjS.js";function Y({projectId:h,areas:u=[],onShowToast:O}){const[g,S]=i.useState([]),[A,v]=i.useState(!0),[p,D]=i.useState("all"),[r,j]=i.useState(null),[x,N]=i.useState(0),[b,y]=i.useState(new Set),C=i.useCallback(async()=>{if(!h||!M){v(!1);return}try{const[s,o]=await Promise.all([w.from("t_and_m_tickets").select("id, work_date, notes, photos, area_id").eq("project_id",h).order("work_date",{ascending:!1}),w.from("daily_reports").select("id, report_date, field_notes, photos").eq("project_id",h).order("report_date",{ascending:!1})]),t=[];if(s.data)for(const a of s.data){const c=Array.isArray(a.photos)?a.photos:[];for(const d of c)d&&t.push({id:`tm-${a.id}-${t.length}`,url:d,date:a.work_date,source:"T&M Ticket",description:a.notes,areaId:a.area_id})}if(o.data)for(const a of o.data){const c=Array.isArray(a.photos)?a.photos:[];for(const d of c)d&&t.push({id:`dr-${a.id}-${t.length}`,url:d,date:a.report_date,source:"Daily Report",description:a.field_notes,areaId:null})}const E=t.map(a=>a.url);(await T.resolvePhotoUrls(E)).forEach((a,c)=>{t[c].url=a}),S(t.filter(a=>a.url)),t.length>0&&y(new Set([t[0].date]))}catch(s){console.error("Error loading photos:",s)}finally{v(!1)}},[h]);i.useEffect(()=>{C()},[C]);const l=i.useMemo(()=>p==="all"?g:g.filter(s=>s.areaId===p),[g,p]),L=i.useMemo(()=>{const s={};for(const o of l)s[o.date]||(s[o.date]=[]),s[o.date].push(o);return Object.entries(s).sort(([o],[t])=>t.localeCompare(o))},[l]),n=i.useMemo(()=>l,[l]),I=s=>{y(o=>{const t=new Set(o);return t.has(s)?t.delete(s):t.add(s),t})},U=s=>{const o=n.findIndex(t=>t.id===s.id);N(o>=0?o:0),j(s)},P=()=>j(null),_=s=>{const o=x+s;o>=0&&o<n.length&&(N(o),j(n[o]))},k=s=>new Date(s+"T00:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),m=s=>s&&u.find(t=>t.id===s)?.name||null;return A?e.jsxs("div",{className:"photo-timeline-card",children:[e.jsxs("div",{className:"photo-timeline-header",children:[e.jsx(f,{size:18}),e.jsx("h3",{children:"Progress Photos"})]}),e.jsx("div",{className:"photo-timeline-loading",children:"Loading photos..."})]}):e.jsxs("div",{className:"photo-timeline-card",children:[e.jsxs("div",{className:"photo-timeline-header",children:[e.jsxs("div",{className:"photo-timeline-title",children:[e.jsx(f,{size:18}),e.jsx("h3",{children:"Progress Photos"}),e.jsx("span",{className:"photo-count-badge",children:l.length})]}),u.length>0&&e.jsxs("div",{className:"photo-area-filter",children:[e.jsx(R,{size:14}),e.jsxs("select",{value:p,onChange:s=>D(s.target.value),className:"photo-area-select",children:[e.jsx("option",{value:"all",children:"All Areas"}),u.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})]}),l.length===0?e.jsxs("div",{className:"photo-timeline-empty",children:[e.jsx(f,{size:32,style:{opacity:.3}}),e.jsx("p",{children:"No photos yet"}),e.jsx("span",{children:"Photos from T&M tickets and daily reports will appear here"})]}):e.jsx("div",{className:"photo-timeline-dates",children:L.map(([s,o])=>e.jsxs("div",{className:"photo-date-group",children:[e.jsxs("button",{className:"photo-date-header",onClick:()=>I(s),children:[e.jsxs("div",{className:"photo-date-info",children:[e.jsx($,{size:14}),e.jsx("span",{className:"photo-date-label",children:k(s)}),e.jsxs("span",{className:"photo-date-count",children:[o.length," photo",o.length!==1?"s":""]})]}),b.has(s)?e.jsx(q,{size:16}):e.jsx(X,{size:16})]}),b.has(s)&&e.jsx("div",{className:"photo-grid",children:o.map(t=>e.jsxs("div",{className:"photo-grid-item",onClick:()=>U(t),children:[e.jsx("img",{src:t.url,alt:t.description||"Project photo",loading:"lazy"}),e.jsx("div",{className:"photo-grid-overlay",children:e.jsx(Z,{size:16})}),e.jsxs("div",{className:"photo-grid-meta",children:[e.jsx("span",{className:"photo-source-badge",children:t.source}),m(t.areaId)&&e.jsxs("span",{className:"photo-area-badge",children:[e.jsx(z,{size:10}),m(t.areaId)]})]})]},t.id))})]},s))}),r&&e.jsx("div",{className:"photo-lightbox",onClick:P,children:e.jsxs("div",{className:"photo-lightbox-content",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{className:"photo-lightbox-close",onClick:P,children:e.jsx(B,{size:24})}),x>0&&e.jsx("button",{className:"photo-lightbox-nav prev",onClick:()=>_(-1),children:e.jsx(F,{size:24})}),e.jsx("img",{src:r.url,alt:r.description||"Project photo"}),x<n.length-1&&e.jsx("button",{className:"photo-lightbox-nav next",onClick:()=>_(1),children:e.jsx(K,{size:24})}),e.jsxs("div",{className:"photo-lightbox-info",children:[e.jsx("div",{className:"photo-lightbox-date",children:k(r.date)}),e.jsx("div",{className:"photo-lightbox-source",children:r.source}),m(r.areaId)&&e.jsxs("div",{className:"photo-lightbox-area",children:[e.jsx(z,{size:12}),m(r.areaId)]}),r.description&&e.jsx("div",{className:"photo-lightbox-desc",children:r.description}),e.jsxs("div",{className:"photo-lightbox-counter",children:[x+1," / ",n.length]})]})]})})]})}export{Y as default};
//# sourceMappingURL=PhotoTimeline-0Y3oNsix.js.map
